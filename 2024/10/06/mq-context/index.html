<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MQ - Context | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="MQ 消息队列 - 具有缓冲作用、具备发布和订阅能力的存储引擎 消息队列的最基本功能 - 生产 + 消费 标准消息队列 - 功能齐全 在发布订阅的基础上，高阶能力 - 死信队列、顺序消息、延时消息等 实现高吞吐、低延时、高可靠的特征">
<meta property="og:type" content="article">
<meta property="og:title" content="MQ - Context">
<meta property="og:url" content="https://blog.zhongmingmao.top/2024/10/06/mq-context/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="MQ 消息队列 - 具有缓冲作用、具备发布和订阅能力的存储引擎 消息队列的最基本功能 - 生产 + 消费 标准消息队列 - 功能齐全 在发布订阅的基础上，高阶能力 - 死信队列、顺序消息、延时消息等 实现高吞吐、低延时、高可靠的特征">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://mq-1253868755.cos.ap-guangzhou.myqcloud.com/0ccbe5e6-1c1d-4316-b8c0-96abf58ed229_1446x680.jpg">
<meta property="article:published_time" content="2024-10-05T16:06:25.000Z">
<meta property="article:modified_time" content="2024-11-29T14:38:26.435Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="MQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mq-1253868755.cos.ap-guangzhou.myqcloud.com/0ccbe5e6-1c1d-4316-b8c0-96abf58ed229_1446x680.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MQ - Context",
  "url": "https://blog.zhongmingmao.top/2024/10/06/mq-context/",
  "image": "https://mq-1253868755.cos.ap-guangzhou.myqcloud.com/0ccbe5e6-1c1d-4316-b8c0-96abf58ed229_1446x680.jpg",
  "datePublished": "2024-10-05T16:06:25.000Z",
  "dateModified": "2024-11-29T14:38:26.435Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2024/10/06/mq-context/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MQ - Context',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mq-1253868755.cos.ap-guangzhou.myqcloud.com/0ccbe5e6-1c1d-4316-b8c0-96abf58ed229_1446x680.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">MQ - Context</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">MQ - Context</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2024-10-05T16:06:25.000Z" title="Created 2024-10-06 00:06:25">2024-10-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mq/">MQ</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">1.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>4mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2024-11-29 22:38:26&quot;}" hidden></div><h1 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h1><ol>
<li>消息队列 - 具有<strong>缓冲</strong>作用、具备<strong>发布</strong>和<strong>订阅</strong>能力的<strong>存储引擎</strong></li>
<li>消息队列的<strong>最基本</strong>功能 - <strong>生产</strong> + <strong>消费</strong></li>
<li>标准消息队列 - <strong>功能齐全</strong><ul>
<li>在发布订阅的基础上，高阶能力 - <strong>死信队列</strong>、<strong>顺序消息</strong>、<strong>延时消息</strong>等</li>
<li>实现<strong>高吞吐</strong>、<strong>低延时</strong>、<strong>高可靠</strong>的特征</li>
</ul>
</li>
</ol>
<span id="more"></span>

<h1 id="社区"><a href="#社区" class="headerlink" title="社区"></a>社区</h1><table>
<thead>
<tr>
<th>Year</th>
<th>MQ</th>
</tr>
</thead>
<tbody><tr>
<td>&lt; 2000</td>
<td>史前消息队列</td>
</tr>
<tr>
<td>2001</td>
<td>JMS - ActiveMQ</td>
</tr>
<tr>
<td>2006</td>
<td>AMQP</td>
</tr>
<tr>
<td>2007</td>
<td>RabbitMQ</td>
</tr>
<tr>
<td>2011</td>
<td>Kafka</td>
</tr>
<tr>
<td>2013</td>
<td>RocketMQ</td>
</tr>
<tr>
<td>2017</td>
<td><strong>Pulsar</strong></td>
</tr>
</tbody></table>
<h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><ol>
<li>Kafka 于 <strong>2011</strong> 年贡献给 <strong>ASF</strong>，主要满足<strong>大数据</strong>领域中的<strong>高吞吐量</strong>、<strong>低延迟</strong>的场景</li>
<li>核心功能简单，只提供<strong>生产</strong>和<strong>消费</strong>，后来加入了<strong>幂等</strong>和<strong>事务</strong></li>
</ol>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><ol>
<li>RabbitMQ 于 <strong>2007</strong> 年开源，使用 Erlang，主要满足业务中<strong>消息总线</strong>的场景</li>
<li>特点为功能丰富（支持<strong>延时消息</strong>、<strong>死信队列</strong>、<strong>优先级队列</strong>、<strong>事务消息</strong>等），在<strong>低流量</strong>下<strong>稳定性较高</strong></li>
<li>缺点 - 在<strong>大流量</strong>的情况下，会有明显的<strong>性能瓶颈</strong>和<strong>稳定性分险</strong></li>
<li><strong>ActiveMQ</strong> 基于 <strong>JMS</strong> 协议（国内较少使用），而 <strong>RabbitMQ</strong> 基于 <strong>AMQP</strong> 协议</li>
<li><strong>AMQP</strong> 是消息队列<strong>协议规范</strong>，并非一款具体的消息队列<ul>
<li>不同消息队列的<strong>访问协议</strong>是不一样的，导致不同的消息队列需要用到<strong>不同的 SDK</strong> 访问</li>
</ul>
</li>
</ol>
<h2 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h2><ol>
<li>RocketMQ 由阿里于 2013 年研发，<strong>2016</strong> 年开源，可满足<strong>大规模</strong>的<strong>微服务</strong>场景<ul>
<li><strong>功能丰富</strong>，基本可以满足<strong>业务消息</strong>场景下的<strong>所有需求</strong></li>
<li><strong>稳定性</strong>、<strong>数据可靠性</strong>表现较好</li>
<li><strong>性能</strong>介于 <strong>RabbitMQ</strong> 和 <strong>Kafka</strong> 之间</li>
<li><strong>RocketMQ</strong> 的定位为 <strong>RabbitMQ</strong> 的升级版</li>
</ul>
</li>
<li><strong>功能</strong><ul>
<li>RocketMQ 与 <strong>RabbitMQ</strong> 类似，<strong>功能丰富</strong>，常用于<strong>业务消息</strong></li>
<li>RocketMQ 在<strong>移动互联网</strong>浪潮下发展起来，场景更复杂，支持更多功能 - <strong>消息 Tag</strong>、<strong>消息轨迹</strong>、<strong>消息查询</strong>等</li>
</ul>
</li>
<li><strong>架构+性能</strong><ul>
<li><strong>RabbitMQ</strong> 在设计时，<strong>分布式的设计理念</strong>不成熟，导致其在<strong>架构</strong>上<strong>存在较大缺陷</strong><ul>
<li>在遇到<strong>大流量</strong>、<strong>高并发</strong>的时候，容易出现<strong>集群不可用</strong>、<strong>网络分区</strong>等情况</li>
</ul>
</li>
<li><strong>RocketMQ</strong> 在<strong>分布式架构</strong>上实现得更<strong>合理优雅</strong>，在<strong>大流量</strong>、<strong>高并发</strong>的场景下表现<strong>优秀稳定</strong></li>
</ul>
</li>
</ol>
<h2 id="Pulsar"><a href="#Pulsar" class="headerlink" title="Pulsar"></a>Pulsar</h2><ol>
<li>Pulsar 于 <strong>2017</strong> 年由 Yahoo 开发<ul>
<li>一开始定位为<strong>流计算</strong>领域，同时发展<strong>消息</strong>和<strong>流</strong>两个方向</li>
<li>架构设计优秀 - <strong>计算存储分离</strong>、弹性、多租户</li>
<li>在<strong>功能</strong>上，追赶 <strong>RabbitMQ</strong> 和 <strong>RocketMQ</strong>；在<strong>性能</strong>上，与 <strong>Kafka</strong> 相当，但<strong>稳定性</strong>有待提升</li>
</ul>
</li>
<li><strong>功能</strong><ul>
<li>Pulsar 与 Kafka 类似，主要定位在<strong>流领域</strong>，主打<strong>大吞吐</strong>的<strong>流式计算</strong></li>
<li><strong>Kafka</strong> 的功能相对简单，支持基本的<strong>发布订阅</strong>、<strong>幂等</strong>、<strong>事务消息</strong></li>
<li><strong>Pulsar</strong> 在 <strong>Kafka</strong> 的基础上，有望支持 <strong>RocketMQ</strong> 和 <strong>RabbitMQ</strong> 功能，<strong>功能最为丰富</strong></li>
</ul>
</li>
<li><strong>架构+性能</strong><ul>
<li><strong>Pulsar</strong> 的架构设计比 Kafka 更符合当下<strong>云原生架构</strong></li>
<li><strong>Pulsar</strong> 的定位为 <strong>Kafka</strong> 的升级版，主要解决 Kafka 的一些痛点问题<ul>
<li>集群<strong>扩缩容慢</strong></li>
<li><strong>分区迁移</strong>需要 <strong>Rebalance</strong></li>
<li>无法支持<strong>超多分区</strong></li>
</ul>
</li>
<li>Pulsar 与 Kafka 目前<strong>没有特别大的性能差距</strong></li>
</ul>
</li>
<li>Pulsar <strong>发展时间短</strong>且<strong>架构复杂</strong>，支持较多功能，<strong>稳定性</strong>不如 Kafka</li>
</ol>
<h1 id="演进"><a href="#演进" class="headerlink" title="演进"></a>演进</h1><table>
<thead>
<tr>
<th></th>
<th>发展趋势</th>
</tr>
</thead>
<tbody><tr>
<td>需求</td>
<td><strong>消息 -&gt; 流 -&gt; 消息与流融合</strong></td>
</tr>
<tr>
<td>架构</td>
<td><strong>单机 -&gt; 分布式 -&gt; 云原生&#x2F;Serverless</strong></td>
</tr>
</tbody></table>
<ol>
<li>在 90 年代到 21 世纪初，以 <strong>AMQP</strong> 为代表的 MQ 主要满足<strong>业务</strong>上对<strong>消息</strong>的需求 - <strong>异步通信</strong> + <strong>架构解耦</strong></li>
<li>2010 年左右，移动互联网兴起，传统的 MQ 在架构上无法满足<strong>大流量高吞吐</strong>的需求 - <strong>Kafka</strong> - <strong>分布式</strong></li>
<li>随着场景越来越复杂，<strong>业务消息</strong>的数据量越来越大<ul>
<li>基于 <strong>AMQP</strong> 的 <strong>RabbitMQ</strong> 在<strong>性能</strong>和<strong>架构</strong>上无法满足需求 - <strong>RocketMQ</strong></li>
</ul>
</li>
<li>随着<strong>云原生</strong>和 <strong>Serverless</strong> 的兴起，在<strong>弹性</strong>和<strong>成本</strong>的驱动下<ul>
<li>MQ 利用云上的<strong>弹性计算和存储</strong>等基础设施去实施<strong>架构</strong>上的 <strong>Serverless</strong></li>
<li><strong>按需使用</strong>、<strong>按量付费</strong>，最终达到<strong>免运维</strong>、<strong>低成本</strong></li>
</ul>
</li>
<li>随着<strong>云原生架构设计</strong>的 <strong>Pulsar</strong> 开始走向成熟，<strong>业界的 MQ</strong> 也出现了<strong>计算存储分离</strong>、<strong>分层存储</strong>、<strong>多租户</strong>、<strong>弹性计算</strong>等概念</li>
</ol>
<h1 id="消息-流"><a href="#消息-流" class="headerlink" title="消息 + 流"></a>消息 + 流</h1><ol>
<li>概念<ul>
<li>消息 - 即<strong>业务消息</strong>，在业务架构（<strong>微服务架构</strong>）中用来作为<strong>消息</strong>传递，作为系统的<strong>消息总线</strong></li>
<li>流 - 在<strong>大数据架构</strong>中用来做<strong>大流量</strong>时的<strong>数据削峰</strong></li>
</ul>
</li>
<li>在<strong>业务消息</strong>中，经常使用 <strong>RocketMQ</strong> 或者 <strong>RabbitMQ</strong>，而在<strong>大数据系统</strong>中，经常使用 <strong>Kafka</strong> 或者 <strong>Pulsar</strong> - 更高的<strong>研发</strong>和<strong>运维</strong>成本</li>
</ol>
<table>
<thead>
<tr>
<th>MQ</th>
<th>Message + Streaming</th>
</tr>
</thead>
<tbody><tr>
<td><del>RabbitMQ</del></td>
<td>因为开发语言、架构和社区的活跃度和定位等原因，基本不会走这个方向</td>
</tr>
<tr>
<td>Kafka</td>
<td>虽然强调云原生，但主要工作在自身的<strong>架构优化</strong>上（如移除 ZooKeeper），在<strong>消息方向</strong>暂时没有提出明确的概念</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>在<strong>消息领域</strong>已经非常成熟，社区希望打通<strong>流</strong>的场景</td>
</tr>
<tr>
<td><strong>Pulsar</strong></td>
<td>新兴架构，没有历史包袱，主打<strong>云原生</strong>的<strong>消息</strong>和<strong>流</strong>的融合架构，希望满足<strong>更多场景</strong>，解决更多业务需求</td>
</tr>
</tbody></table>
<blockquote>
<p>降本增效</p>
</blockquote>
<ol>
<li><strong>弹性计算</strong> - <strong>计算存储分离</strong>架构</li>
<li><strong>低存储成本</strong> - <strong>分层存储</strong></li>
<li><strong>资源复用</strong> - <strong>多租户</strong></li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2024/10/06/mq-context/">https://blog.zhongmingmao.top/2024/10/06/mq-context/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mq/">MQ</a></div><div class="post-share"><div class="social-share" data-image="https://mq-1253868755.cos.ap-guangzhou.myqcloud.com/0ccbe5e6-1c1d-4316-b8c0-96abf58ed229_1446x680.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/10/07/mq-concept/" title="MQ - Concept"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://mq-1253868755.cos.ap-guangzhou.myqcloud.com/mq-concept.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">MQ - Concept</div></div><div class="info-2"><div class="info-item-1">消息管道 在系统架构中，MQ 的定位是消息和管道，主要起到解耦上下游系统，数据缓存的作用，主要操作为生产和消息     架构 Broker Broker 本质上是一个进程 在实际部署过程中，通常一个物理节点只会起一个进程，在大部分情况下，Broker 表示一个节点  Topic 在大部分 MQ 中，Topic 都是用来组织分区关系的一个逻辑概念 通常情况下，一个 Topic 会包含多个分区 在 RabbitMQ 中，Topic 是指具体的一种主题模式    Partition Queue &#x2F; MessageQueue   在 MQ 中，分区、分片、Partition、Queue、MessageQueue 是一个概念，用来表示数据存储的最小单位 可以将消息写入到一个分区中，也可以将消息写入到 Topic 中，再分发到具体的某个分区 一个 Topic 通常会包含一个或多个分区  Producer 消息的发送方，即发送消息的客户端  Consumer 消息的接收方，即接收消息的客户端  ConsumerGroup Subscription   一般情况下，MQ 中的 ConsumerGroup 和 ...</div></div></div></a><a class="pagination-related" href="/2024/10/05/bigdata-beam-future/" title="Beam - Future"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://big-data-1253868755.cos.ap-guangzhou.myqcloud.com/flink-runner-beam-beam-vision.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Beam - Future</div></div><div class="info-2"><div class="info-item-1">技术迭代 2006，Apache Hadoop 发布，基于 MapReduce 计算模型 2009，Spark 计算框架在 加州伯克利大学诞生，于 2010 年开源，于 2014 年成为 Apache 的顶级项目 Spark 的数据处理效率远在 Hadoop 之上   2014，Flink 面世，流批一体，于 2018 年被阿里收购    Apache Beam Apache Beam 根据 Dataflow Model API 实现的，能完全胜任批流一体的任务 Apache Beam 有中间的抽象转换层，工程师无需学习新 Runner 的 API 的语法，减少学习新技术的时间成本 Runner 可以专心优化效率和迭代功能，而不必担心迁移  Beam Runner 迭代非常快 - 如 Flink  </div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/10/07/mq-concept/" title="MQ - Concept"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://mq-1253868755.cos.ap-guangzhou.myqcloud.com/mq-concept.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-07</div><div class="info-item-2">MQ - Concept</div></div><div class="info-2"><div class="info-item-1">消息管道 在系统架构中，MQ 的定位是消息和管道，主要起到解耦上下游系统，数据缓存的作用，主要操作为生产和消息     架构 Broker Broker 本质上是一个进程 在实际部署过程中，通常一个物理节点只会起一个进程，在大部分情况下，Broker 表示一个节点  Topic 在大部分 MQ 中，Topic 都是用来组织分区关系的一个逻辑概念 通常情况下，一个 Topic 会包含多个分区 在 RabbitMQ 中，Topic 是指具体的一种主题模式    Partition Queue &#x2F; MessageQueue   在 MQ 中，分区、分片、Partition、Queue、MessageQueue 是一个概念，用来表示数据存储的最小单位 可以将消息写入到一个分区中，也可以将消息写入到 Topic 中，再分发到具体的某个分区 一个 Topic 通常会包含一个或多个分区  Producer 消息的发送方，即发送消息的客户端  Consumer 消息的接收方，即接收消息的客户端  ConsumerGroup Subscription   一般情况下，MQ 中的 ConsumerGroup 和 ...</div></div></div></a><a class="pagination-related" href="/2019/09/30/kafka-tuning/" title="Kafka -- 调优"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-6.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-30</div><div class="info-item-2">Kafka -- 调优</div></div><div class="info-2"><div class="info-item-1">调优目标 主要目标：高吞吐量、低延时 吞吐量 即TPS，指的是Broker端进程或Client端应用程序每秒能处理的字节数或消息数   延时，可以有两种理解 从Producer发送消息到Broker持久化完成之间的时间间隔 端到端的延时，即从Producer发送消息到Consumer成功消费该消息的总时长      优化漏斗优化漏斗是调优过程中的分层漏斗，层级越靠上，调优的效果越明显 操作系统层 mount -o noatime 在挂载文件系统时禁用atime（Access Time）更新，记录的是文件最后被访问的时间 记录atime需要操作系统访问inode资源，禁用atime可以避免inode访问时间的写入操作   文件系统选择ext4、XFS、ZFS 将swappiness设置成一个很小的值（1~10，默认是60），防止Linux的OOM Killer开启随机杀掉进程 swappiness&#x3D;0，并不会禁止对swap的使用，只是最大限度地降低使用swap的可能性 因为一旦设置为0，当物理内存耗尽时，操作系统会触发OOM Killer OOM Killer会随机挑选一个进程然后kill掉，不...</div></div></div></a><a class="pagination-related" href="/2019/09/29/kafka-monitor/" title="Kafka -- 监控"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-4.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-29</div><div class="info-item-2">Kafka -- 监控</div></div><div class="info-2"><div class="info-item-1">主机监控 主机监控：监控Kafka集群Broker所在的节点机器的性能 常见的主机监控指标 机器负载 CPU使用率 内存使用率，包括空闲内存和已使用内存 磁盘IO使用率，包括读使用率和写使用率 网络IO使用率 TCP连接数 打开文件数 inode使用情况      JVM监控 重点指标 Full GC发生频率和时长 活跃对象大小 应用线程总数   设置堆大小 经历一次Full GC后，堆上存活的活跃对象大小为S，可以安全地将老年代堆大小设置为1.5S或者2S   从0.9.0.0版本开始，社区将默认的GC收集器设置为G1，而G1的Full GC是由单线程执行的，速度非常慢 一旦发现Broker进程频繁Full GC，可以开启G1的**-XX:+PrintAdaptiveSizePolicy，获知引发Full GC的原因**    集群监控 查看Broker进程是否启动，端口是否建立 在容器化的Kafka环境，容器虽然启动成功，但由于网络配置有误，会出现进程已经启动但端口未成功监听的情形   查看Broker端关键日志 Broker端服务器日志server.log – 最重要 控制器日志controlle...</div></div></div></a><a class="pagination-related" href="/2019/09/28/kafka-admin-client/" title="Kafka -- KafkaAdminClient"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-13.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-28</div><div class="info-item-2">Kafka -- KafkaAdminClient</div></div><div class="info-2"><div class="info-item-1">背景 命令行脚本只能运行在控制台上，在应用程序、运维框架或者监控平台中集成它们，会非常困难 很多命令行脚本都是通过连接ZK来提供服务的，这会存在潜在的问题，即绕过Kafka的安全设置 运行这些命令行脚本需要使用Kafka内部的类实现，也就是Kafka服务端的代码 社区是希望用户使用Kafka客户端代码，通过现有的请求机制来运维管理集群   基于上述原因，社区于0.11版本正式推出Java客户端版的KafkaAdminClient    功能 主题管理 主题的创建、删除、查询   权限管理 具体权限的配置和删除   配置参数管理 Kafka各种资源（Broker、主题、用户、Client-Id等）的参数设置、查询   副本日志管理 副本底层日志路径的变更和详情查询   分区管理 创建额外的主题分区   消息删除 删除指定位移之前的分区消息   Delegation Token管理 Delegation Token的创建、更新、过期、查询   消费者组管理 消费者组的查询、位移查询和删除   Preferred领导者选举 推选指定主题分区的Preferred Broker为领导者    工作原理   Kaf...</div></div></div></a><a class="pagination-related" href="/2019/09/27/kafka-shell/" title="Kafka -- 常用脚本"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-18.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-27</div><div class="info-item-2">Kafka -- 常用脚本</div></div><div class="info-2"><div class="info-item-1">脚本列表12345678connect-distributed              kafka-consumer-perf-test         kafka-reassign-partitions        kafka-verifiable-producerconnect-standalone               kafka-delegation-tokens          kafka-replica-verification       trogdorkafka-acls                       kafka-delete-records             kafka-run-class                  zookeeper-security-migrationkafka-broker-api-versions        kafka-dump-log                   kafka-server-start               zookeeper-server-startkafka-configs      ...</div></div></div></a><a class="pagination-related" href="/2019/09/26/kafka-reset-consumer-group-offset/" title="Kafka -- 重设消费者组位移"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-26</div><div class="info-item-2">Kafka -- 重设消费者组位移</div></div><div class="info-2"><div class="info-item-1">背景 Kafka和传统的消息引擎在设计上有很大的区别，Kafka消费者读取消息是可以重演的 像RabbitMQ和ActiveMQ等传统消息中间件，处理和响应消息的方式是破坏性 一旦消息被成功处理，就会从Broker上被删除   Kafka是基于日志结构（Log-based）的消息引擎 消费者在消费消息时，仅仅是从磁盘文件中读取数据而已，是只读操作，因为消费者不会删除消息数据 同时，由于位移数据是由消费者控制的，因此能够很容易地修改位移值，实现重复消费历史数据的功能   Kafka Or 传统消息中间件 传统消息中间件：消息处理逻辑非常复杂，处理代价高、又不关心消息之间的顺序 Kafka：需要较高的吞吐量、但每条消息的处理时间很短，又关心消息的顺序      重设位移策略 位移维度 直接把消费者的位移值重设成给定的位移值   时间维度 给定一个时间，让消费者把位移调整成大于该时间的最小位移       维度 策略 含义    位移维度 Earliest 把位移调整到当前最早位移处    Latest 把位移调整到当前最新位移处    Current 把位移调整到当前最新提交位移处    Specified...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MQ"><span class="toc-number">1.</span> <span class="toc-text">MQ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A4%BE%E5%8C%BA"><span class="toc-number">2.</span> <span class="toc-text">社区</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Timeline"><span class="toc-number">2.1.</span> <span class="toc-text">Timeline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka"><span class="toc-number">2.2.</span> <span class="toc-text">Kafka</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">2.3.</span> <span class="toc-text">RabbitMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RocketMQ"><span class="toc-number">2.4.</span> <span class="toc-text">RocketMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pulsar"><span class="toc-number">2.5.</span> <span class="toc-text">Pulsar</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%94%E8%BF%9B"><span class="toc-number">3.</span> <span class="toc-text">演进</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF-%E6%B5%81"><span class="toc-number">4.</span> <span class="toc-text">消息 + 流</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Server V1"/></a><div class="content"><a class="title" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1">Observability - Prometheus Server V1</a><time datetime="2025-01-23T16:06:25.000Z" title="Created 2025-01-24 00:06:25">2025-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
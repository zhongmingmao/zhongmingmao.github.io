---
title: RAG - Evolution
mathjax: true
date: 2024-08-16 00:06:25
cover: https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/rag-evolution.webp
categories:
  - AI
  - RAG
tags:
  - AI
  - LLM
  - RAG
---

# 演进

![image-20241023221218155](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241023221218155.png)

<!-- more -->

1. **Naive** RAG -> **Advanced** RAG -> **Modular** RAG
2. 三个范式之间具有**继承**与**发展**的关系
   - **Advanced** RAG 是 **Modular** RAG 的一种**特例**形式
   - **Naive** RAG 是 **Advanced** RAG 的**基础**特例
3. RAG 技术**不断演进**，以适应**更复杂**的任务和场景需求

# Naive RAG

1. Naive RAG 是**最基础**的形式，依赖核心的**索引**和**检索**策略来**增强**生成模型的输出
2. Naive RAG 适用于一些**基础任务**和**产品 MVP 阶段**

# Advanced RAG

> 通过增加**检索前**、**检索中**以及**检索后**的优化策略，提高**检索的准确性**和**生成的关联性** - 适用于**复杂**任务

![image-20241023222632284](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241023222632284.png)

1. Advanced RAG 通过优化**检索前**、**检索中**、**检索后**的各个环节
2. 在**索引质量**、**检索效果**以及**生成内容的上下文相关性**方面都取得显著提升

## 检索前

> 通过**索引**、**分块**、**查询优化**和**内容向量化**等技术手段，提高**检索内容的精确性**和**生成内容的相关性**

### 滑动窗口

> overlap

1. 经典的 **Chunking** 技术，通过在**相邻**的 **Chunk** 之间创建**重叠**区域，确保**关键信息**不会因简单的 Chunking 而**丢失**
2. 在 **Indexing** 过程中，通过在 **Chunk** 之间保留**重复**部分
   - 保证了检索时**上下文**信息的**连贯性**，进而提高了检索的精度

### 元数据

1. 为每个 **Chunk** 添加**元数据**，能够使系统在检索时**快速过滤**掉无关内容

### 分层索引

1. 在 **Indexing** 过程中，可以采用**句子级**、**段落级**甚至**文档级**的**多层次**嵌入方法
2. 系统可以根据查询的具体要求，**灵活**地在**不同层次**上进行检索
   - **复杂**的**长句**查询 - **段落级别**的嵌入能够提供**更加全面的语义匹配**
   - **简短**查询 - **句子级**的嵌入能够提供**更加精确**的结果

### 句子窗口

1. 将文档中的**每个句子**独立嵌入，从而提高**检索的精确度**
2. 在检索过程中，系统找到**与 Query 最相关**的句子后，会**扩展**句子前后的**上下文窗口**
   - 保证**生成模型**能够获取**足够的背景信息**进行**推理**
3. 既能**精准定位关键信息**，又能确保**生成的上下文连贯**

### 查询重写

1. 针对用户输入的**原始查询**进行**重新表诉**，使其更加**清晰易懂**，并且**与检索任务匹配**
2. 针对用户的**模糊提问**，系统可以通过**重写**，使**查询**更加**具体化**，从而检索到更加**精准**的内容

### 查询扩展

1. 通过增加**同义词**、相关**词汇**或者**概念**，**扩展**用户的原始查询，增加了检索结果的**广度**
2. 当用户输入**简短**或**不完整**的查询时，系统能够通过**扩展词汇**找到更多潜在的内容，从而**提升检索效果**

### 内容向量化

> 长短不一

1. 在 RAG 系统中，**Document** 或 **Query** 的**长度**对**向量化**过程有着**显著影响**
2. 对于**短句子**或者**短语**，其生成的向量更加聚焦于**具体细节**，能够实现更加**精确**的**句子级别**匹配
3. **段落**或**文档**级别的向量化涵盖了**更广泛的上下文信息**，能够捕捉到内容的**整体语义**

## 检索中

> 核心环节

### 动态嵌入

1. 通过**动态嵌入模型**根据上下文**实时调整**单词的**嵌入表示**，能够捕捉单词在**不同上下文**中的**不同含义**
2. 动态嵌入可以根据**具体语境**生成合适的向量，从而提高检索的精确性

### 领域特定嵌入微调

> jina-embeddings-v2-base-code

1. 在实际应用中，**不同领域**的数据**语境差异**较大
2. **通用的嵌入模型**无法覆盖某些**特定领域**的专业术语或特定语义
3. 通过对通用嵌入模型进行**微调**，可以**增强**其在**特定领域**的表现

### 假设文档嵌入

> HyDE - **Hypothetical** Document Embeddings - 通过**假设文档**，系统可以**捕捉**到**更准确**的相关文档

1. HyDE 通过**生成假设文档**并将其**向量化**，以提升**查询**与**检索结果**之间的**语义匹配度**
2. 用户输入 **Query** 时，LLM 首先基于 **Query** 生成一个**假设性答案**
   - 该答案**不一定**是**真实存在**的文档内容，但能反映**查询**的**核心语义**
3. 根据**假设性文档**进行**检索**，系统可能最终找到**类似**的**真实文档**

### 混合检索

1. 结合**向量搜索**和**关键词搜索**等多种检索方法，能够同时利用**语义匹配**与**关键词匹配**的优势

### 小到大检索

> **小块**有助于**提高精度**，而**大块**则提供**丰富的背景信息**，使得生成的内容更加**全面** -- **分层检索**

1. 首先通过**较小内容块**（单句或短段落）进行**嵌入**和**检索**，确保模型能找到**与查询最匹配**的**小范围上下文**
2. 检索到相关内容后，在**生成阶段**使用对应的**较大内容块**（完整段落或全文）为模型提供**更广泛的上下文支持**

### 递归块合并

1. **逐级扩展**检索内容，确保生成阶段能够捕捉到**更全面**的上下文信息
2. 在**细粒度**的**子块检索**后，自动**将相关的父块合并**，以便为生成模型提供**完整的上下文**

## 检索后

### 重排序

1. **初始检索**可以找到多个与查询相关的内容块，但这些内容的相关性存在差异，需要**进一步排序**以优化生成结果
2. 通过**重排序模型**根据**上下文的重要性**、**相关性评分**等因素对**已检索**的内容**重新打分**，确保**最相关**的信息被**优先处理**

### 提示压缩

1. **删除冗余信息**、**合并相关内容**、**突出关键信息**等方式来**压缩**提示，为生成模型提供更**简洁**、更**相关**的输入

### 上下文重构

1. 通过对**检索到的内容**进行**加工**或**重组**，以便**更好地符合查询的需求**
2. 将多个检索到的**上下文片段**整合成一个**更具连贯性的文本块**，减少**重复**或者**冲突**的内容，为 LLM 提供**统一**、**清晰**的输入

### 内容过滤

1. 根据**预设规则**，过滤掉**与查询无直接关联**的内容，**语义相似度较低**的片段，**冗长且无关**的背景信息，避免影响生成结果

### 多级推理

1. 系统通过**多个推理步骤**，逐步**整合**信息，以回答复杂查询，常用于需要**跨多个上下文**或**多步推理**的问题

### 知识注入

1. 在检索后通过**外部知识库**或者预定义的领域知识，**增强**生成的上下文内容
2. 适用于对**准确性要求较高**的场景，系统需要补充**额外的专业知识**

# Modular RAG

> 打破传统的**链式**结构，允许不同**模块**之间的**灵活组合**以及**流程**的**适应性编排** - 更高的**灵活性**和**可扩展性**

![image-20241024021807679](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241024021807679.png)

1. Modular RAG **沿袭**了 **Naive RAG** 和 **Advanced RAG** 的**核心原则**，但**超越**了两者，提供了更强的**适应性**和**灵活性**
2. 通过多种**优化策略**和独有的**编排功能**，提高 RAG 系统的**场景适应性**
3. Modular RAG 将 RAG 的过程细分为**多个可优化的模块**，支持**高度定制化**和**优化**
4. Modular RAG 通过将 **Advanced RAG** 的**优化策略**自由组合
   - 根据不同的应用场景**定制化**处理检索和生成任务，显著提升效率和效果
5. 在 Modular RAG 中，**Orchestration** 是区别于 **Advanced RAG** 最显著部分
   - 通过**自由**的流程控制和决策来优化检索和生成的全流程
   - 核心思想 - 通过**智能路由和调度**，**动态地决定**查询处理的路径和步骤，从而在复杂场景下提升 RAG 系统的性能

## Routing

> **路由**是**编排**流程中的关键步骤 - 根据 Query 的特点和上下文，**选择最合适的流程**

### Query Analysis

1. 对 Query 进行**语义分析**，判断其**类型**和**难度**
2. 直接问答式的查询 - 不需要复杂的检索过程
3. 涉及**多步推理**的复杂问题 - 需要走**更长的检索路径**

### Pipeline Selection

1. 根据 **Query Analysis** 的结果，**动态选择**合适的 **Pipeline**
2. 简单查询 - 禁用 LLM 的知识来回答，效率高
3. 需要**领域知识**以及**复杂推理**的查询 - 集合**外部文档及知识**进行**深度检索生成**

## Scheduling

> 管理 Query 的**执行顺序**，并**动态调整**检索和生成步骤

### Query Scheduling

1. 当系统接收到 Query 时，判断是否**需要进行检索**
2. 根据 **Query 重要性**、**上下文信息**、**已有生成结果的质量**等多维度因素进行评估

### Judgment of Retrieval Needs

1. 通过特定的判断节点来确定**是否需要额外检索**
2. 在某些情况下，可能会**多次判断**是否有必要执行**新一轮的检索**

## Knowledge Guide

> 结合**知识图谱**和**推理路径**来**增强**查询处理过程

### Knowledge Graph

1. 在处理**复杂查询**时，系统可以调用**知识图谱**来**辅助检索**
2. 提升了**检索结果的准确性**，还可以通过**知识图谱中的上下文关系**，推导出更为**精确**的答案
3. 当查询涉及**多个实体的关系**，知识图谱能够提供**更深层次的推理支持**

### Reasoning Path

1. 通过推理路径，系统可以设计出一条**符合查询需求**的**推理链条**
2. 系统根据该**推理链条**，进行逐步的**推理**和**检索**
3. 适用于处理具有**强逻辑性**的问题 - 跨多个文档的**关系推理**或**时间序列推理**

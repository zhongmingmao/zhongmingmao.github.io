---
title: 计算机组成 -- 异常
mathjax: false
date: 2020-01-21 02:11:19
categories:
    - Computer Basics
    - Computer Organization
tags:
    - Computer Basics
    - Computer Organization
---

## 异常
1. 异常是一个**硬件和软件组合在一起的处理过程**
   - 异常的**发生**和**捕捉**，是在**硬件**层面完成的
   - 异常的**处理**，是在**软件**层面完成的
2. 计算机会为每一种可能发生的异常，分配一个**异常代码**（Exception Number），别称**中断向量**（Interrupt Vector）
3. 异常发生的时候，通常是CPU检测到一个特殊的**信号**
   - 在组成原理里面，一般叫作发生了一个**事件**（Event），CPU在检测到事件的时候，就已经拿到了**对应的异常代码**
4. 异常代码
   - **IO**发出的信号的异常代码，是由**操作系统**来分配，即由**软件**来设定
   - 像**加法溢出**这样的异常代码，是由**CPU预分配**的，即由**硬件**来设定
5. 拿到**异常代码**后，CPU会触发**异常处理流程**
   - 计算机在**内存**里，会保留一个**异常表**（Exception Table），别称**中断向量表**（Interrupt Vector Table）
   - 存放的是不同的异常代码对应的异常处理程序所在的**地址**
   - CPU拿到异常代码后，会先把当前程序的**执行现场**（CPU当前运行程序**用到的所有寄存器**），保存到**程序栈**里面
   - 然后**根据异常代码查询**，找到对应的**异常处理程序**，最后把后续指令执行的**指挥权**，交给这个异常处理程序
6. 异常可以由**硬件**触发，也可以由**软件**触发

<!-- more -->

<img src="https://computer-composition-1253868755.cos.ap-guangzhou.myqcloud.com/computer-organization-exception.jpg" width=1000/>

### 分类
1. **中断**（Interrupt）
   - 程序执行到**一半**的时候，被**打断**了，该打断执行的信号，来自于CPU外部的**IO设备**
   - 在键盘上按下一个按键，就会触发一个相应的**信号**到达CPU
     - CPU里面某个开关的值发生了变化，即触发了一个**中断类型**的异常
2. **陷阱**（Trap）
   - 陷阱是程序**主动触发**的异常
   - **断点**
     - 当程序的指令执行到某个位置时，会掉入这个陷阱中，然后，对应的**异常处理程序**会来处理
   - **系统调用**
     - 当应用程序**调用系统调用**时，会从程序的**用户态**切换到**内核态**
     - 应用程序通过**系统调用**去读取文件、创建进程，也是通过触发一次**陷阱**来进行的
       - 这是因为**用户态**的应用程序**没有权限**来做这些事情，要把对应的流程转交给**有权限的『异常处理程序』**来进行
3. **故障**（Fault）
   - 与陷阱的区别：陷阱是程序**刻意触发**的，而故障则不是
   - 程序进行**加法计算**时发生了**溢出**，属于**故障**类型的异常
   - 故障和陷阱、中断的一个重要区别
     - **故障**在异常程序处理完成后，仍然回来处理**当前指令**，而不是去执行程序的下一条指令
     - 因为当前指令因为故障的原因并没有成功执行完成，需要**重新执行**一次（抢救一下！）
4. **中止**（Abort）
   - 中止是故障的一种**特殊情况**
   - 当**CPU遇到故障**，但恢复不过来的时候，程序不得不中止（退出程序执行）

| 类型 | 原因 | 示例 | 触发时机 | 处理后操作 |
| --- | --- | --- | --- | --- |
| 中断 | **IO设备信号** | 用户键盘输入 | **异步** | 下一条指令 |
| 陷阱 | **程序刻意触发** | 程序进行**系统调用**（用户态、内核态切换） | 同步 | 下一条指令 |
| 故障 | **程序执行出错** | 程序加载的**缺页错误** | 同步 | **当前指令** |
| 中止 | **故障无法恢复** | ECC内存校验失败 | 同步 | 退出程序 |

1. 异步 + 同步
   - **中断**异常的信号来自于**系统外部**，而不是在程序的执行过程中，因此称为**异步**类型的异常
   - **陷阱**、**故障**以及**中止**类型的异常，是在程序执行的过程中发生的，因此称为**同步**类型的异常
2. 在**处理异常**的过程中，无论是**异步的中断**，还是**同步的陷阱和故障**，都采用**统一**的处理流程
   - **保存现场 -> 异常代码查询 -> 异常处理程序调用**
   - **中止**类型的异常，是**故障**类型异常的一种**特殊**情况
     - 当**中止**异常发生时，发现**没有异常处理程序能够处理这种异常**，程序不得不进入**中止**状态，**退出**当前程序的执行

### 处理 -- 上下文切换
1. 在实际的异常处理流程执行之前，CPU需要去做一次『**保存现场**』的操作
   - 保存现场的操作，和**函数调用**的过程非常类似
   - 切换到异常处理程序的时候，好像去**调用一个异常处理函数**，指令的**控制权**被切换到另一个函数里面
   - 因此要把当前正在执行的指令去**压栈**，这样才能在异常处理程序执行完成之后，重新回到当前指令继续往下执行
2. 切换到异常处理程序，比函数调用，是更**复杂**一些
   - 因为异常情况通常发生在程序**正常执行的预期之外**，如中断、故障发生的时候
     - 因此除了本来程序压栈要做的事情之外，还需要把**CPU当前运行程序用到的所有寄存器**，都放到**栈**里面
       - 典型案例：**条件码寄存器**里面的内容
   - **陷阱**：涉及程序指令在**用户态**和**内核态**之间的切换
     - 在**压栈**的时候，对应的数据是压到**内核栈**里，而不是程序栈
   - **故障**：在异常处理程序执行完成之后，从栈里返回出来，继续执行的不是顺序的下一条指令，而是**故障发生的当前指令**
     - 因为当前指令因为故障没有正常执行成功，必须**重新执行**一次
3. 异常处理流程，不像**顺序执行的指令间的函数调用关系**，而是更像**两个不同的独立进程**之间在**CPU层面的切换**
   - 因此这个过程称为**上下文切换**（Context Switch）

## 参考资料
[深入浅出计算机组成原理](https://time.geekbang.org/column/intro/100026001)
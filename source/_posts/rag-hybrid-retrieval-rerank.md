---
title: RAG - Hybrid retrieval + Rerank
mathjax: true
date: 2024-08-13 00:06:25
cover: https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/rag-rerank-9097303.png
categories:
  - AI
  - RAG
tags:
  - AI
  - LLM
  - RAG
  - Rerank
---

# 向量检索

1. 当前主流的 RAG 检索方式主要采用**向量检索**，通过**语义相似度**来匹配 **Chunk**
2. 向量检索**并非万能**，在某些场景下无法替代**传统关键词检索**的优势
   - 当需要**精准搜索**的时候，向量检索的**准确性**就往往不如关键词检索
   - 当用户输入的**问题**非常**简短**，**语义匹配**的效果可能**不尽理想**
3. **关键词检索**的适用场景
   - **精确**匹配
   - **少量字符**的匹配 - 不适合用向量检索
   - **低频词汇**的匹配

<!-- more -->

![image-20241017195709563](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241017195709563.png)

# 混合检索

> 结合**关键词检索**和**语义匹配**的优势

1. 在 **RAG 检索**场景中，首要目标是确保**最相关的结果**能够出现在**候选列表**中
2. **向量检索**和**关键词检索**各具优势，混合检索通过结合多种检索技术，弥补各自不足，提供一种更加全面的搜索方案
3. **重排序**技术在**检索系统**中扮演着至关重要的角色
   - 即使**检索算法**已经能够捕捉到**所有相关**的结果，重排序过程依然不可或缺
   - 确保最符合**用户意图**和**查询语义**的结果**优先展示**，提升用户的**搜索体验**和结果的**准确性**

> 在多个数据集和多个检索任务中，**混合检索**和**重排序**的组合均取得了最佳表现

![image-20241021231355000](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241021231355000.png)

![image-20241021231538523](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241021231538523.png)

> 融合检索 / 多路召回

![image-20241021232423722](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241021232423722.png)

> https://python.langchain.com/v0.2/api_reference/community/retrievers.html

| 检索方法                    | 方法说明                                                     |
| --------------------------- | ------------------------------------------------------------ |
| 向量检索                    | 通过将**文档**转换为**向量**表示，利用向量之间的**语义相似度**检索，能够找到与查询语义**最相近**的内容 |
| 关键词检索                  | 依赖于**精确匹配**文本中的**关键词**。适用于需要精确查找特定术语、短语或标识符的场景。 |
| 多重提问检索 - **问题扩写** | 通过生成多个**与原始查询相关**的问题，**扩展检索范围**，适用于查询**不明确问题**的情况 |
| 上下文**压缩**检索          | 先检索出**大量相关文档**，然后对其**内容**进行**压缩**，保留**核心信息**，以便 LLM 处理和理解 |
| **父文档**检索              | 不仅检索文档**片段**，而是检索**整个文档**，适用于需要查看**完整文档内容**的场景，确保**信息全面性** |
| **多向量**检索              | 为**每个文档**创建**多个向量**表示，捕捉文档的不同**特征**，能够在检索中识别出文档**多维度**信息 |
| **自查询**检索 - Self RAG   | **理解并重构复杂查询**，从而提高检索的**精度**，使检索结果更贴合**用户意图** |

1. 选择何种检索技术，取决于需要解决什么问题、系统的性能要求、数据的复杂性以及用户的搜索习惯等
2. 针对**具体需求**选择合适的检索技术，能够最大化地提升 RAG 系统的效率和准确性

## BM25

1. **BM25** 是一种强大的**关键词搜索**算法
   - 通过分析**词频**（TF）和**逆向文档频率**（IDF）来评估文档与查询的相关性
2. BM25 检查查询词在文档中的**出现频率**，以及该词在**所有文档**中出现的**稀有程度**
   - 如果一个词在**特定文档**中**频繁出现**，但在**其他文档**中**较少出现** - 该文档**高度相关**
3. BM25 还通过调整文档长度的影响，防止因**文档长度不同**而导致的**词频偏差**
4. BM25 结合了**词频**和**文档长度**平衡的机制，使得 BM25 在**关键词检索**中能够提供**精准**的检索结果

# 重排序

## 概述

1. 在 RAG 检索流程中，**重排序**技术通过对**初始检索结果**进行**重新排序**
   - 改善检索结果的**相关性**，为 LLM 提供**更优质的上下文**，从而提升 RAG 系统的**整体效果**
2. 尽管**向量检索**技术能够为每个 **Chunk** 生成**初步的相关性分数**，但引入**重排序模型**仍然至关重要
3. **向量检索**主要依赖于**全局语义相似性**
   - 通过将**查询**和**文档**映射到**高维语义空间**进行匹配
   - 往往忽略了**查询**与**文档具体内容**之间的**细粒度交互**
4. **重排序模型**大多基于**双塔**或**交叉编码架构**的模型
   - 在此基础上进一步计算**更加精确**的**相关性分数**
   - 能够捕捉**词**与 **Chunk** 之间**更细致的相关性**，从而在细节层面上**提高检索精度**
5. **向量检索**提供了有效的**初步筛选**，**重排序模型**则通过**更深入的分析和排序**
   - 确保最终结果在**语义**和**内容**层面上更紧密地**契合查询意图**，实现**检索质量**的提升
6. RAG 流程有两个概念：**粗排** + **精排**
   - **粗排** - 检索效率**高**，但召回的内容不一定**强相关**
   - **精排** - 效率较**低**，适合在粗排的基础上进一步**优化**，代表技术为**重排序**

## 优势

1. 优化**检索结果**
   - 在 RAG 系统中，初始的检索结果通常来自于**向量检索**或基于**关键词**的检索方法
   - 初始的检索结果可能包含大量的**冗余**信息或与查询完全**不相关**的文档
   - 通过**重排序**技术，可以对初步检索到的文档进行进一步的**筛选**和**排序**，将**最相关**、**最重要**的文档至于前列
2. 增强**上下文相关性**
   - RAG 系统依赖于检索到的文档作为 LLM 的**上下文** - 直接影响**生成结果**
   - 重排序技术通过**重新评估**文档与查询的**相关性**，确保 **LLM** 优先使用那些与查询**最相关**的文档
3. 应对**复杂查询**
   - 对于**复杂查询**，初始检索可能会返回一些与**表面上相关**但**实际上不太匹配**的文档
   - **重排序**技术可以根据查询的复杂性和具体需求，对这些结果进行**更细致**的**分析**和**排序**

## RRF

> Reciprocal Rank Fusion - **递归折减**融合

1. RRF 是一种把来自**不同检索方法**的**排名结果**结合起来的技巧
2. 基本思想：如果一个文档在**不同的检索结果**中**都**排名比较靠前，那么它在**综合排名**中应该得到更高的位置
3. 相比于复杂的重排序技术，RRF 的操作更加简单，不需要对每种检索结果进行复杂的调整或计算
   - 通过**直接考虑**文档在不同方法中的**排名**，快速生成一个合理的**综合排名**
   - 非常适合那些需要**快速融合**多个检索结果的场景，短时间内得到一个有参考价值的排序

## 模型

![image-20241022005105537](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241022005105537.png)

1. **Query** 与每个 **Chunk** 计算对应的**相关性分数**，并根据这些分数对文档进行**重新排序**
2. 市面上**可用**的重排序模型并不多
   - 商用 - **Cohere**
   - 开源 - BGE、Sentence、Mixedbread、T5-Reranker、**BCE**
3. 甚至可以使用 **Prompt** 让 **LLM** 进行**重排**
4. 在生产环境中使用**重排序模型**会面临**资源**和**效率**问题
   - **计算资源消耗高** + **推理速度慢** + **模型参数量大**
5. 重排序模型在对**候选项**进行**精细排序**时，因其**较大参数量**而导致的**高计算需求**和**复杂耗时**的**推理过程**
   - 从而对 RAG 系统的**响应时间**和**整体效率**产生负面影响
6. 在实际应用中，要根据实际资源需求，在**精度**和**效率**之间进行**平衡**

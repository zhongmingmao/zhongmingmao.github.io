---
title: Java并发 -- 线程数量
date: 2019-04-29 10:16:30
categories:
    - Java
    - Concurrent
tags:
    - Java
    - Java Concurrent
---

## 多线程的目的
1. 使用多线程的目的是为了_**提高程序性能**_
2. 度量程序性能的**核心指标**：_**延迟** + **吞吐量**_
    - **延迟**：发出请求到收到响应的**时间**，延迟越短，意味着程序执行得越快，性能越好
    - **吞吐量**：在**单位时间**内能处理请求的数量，吞吐量越大，意味着程序能处理的请求越多，性能越好
    - **同等条件下，延迟越短，吞吐量越大**，但两者隶属于不同的维度（一个**时间**维度，一个**空间**维度），并**不能互相转换**
3. 提升程序性能：_**降低延迟，提高吞吐量**_

<!-- more -->

## 多线程的应用场景
1. 要达到**降低延迟，提高吞吐量**的目的，有两个方向：一个是**优化算法**，一个是_**将硬件的性能发挥到极致**_
    - 前者属于**算法**范畴，后者与**并发编程**息息相关
2. 在**并发编程**领域，_**提高性能本质上就是要提高硬件的利用率**_，主要是提升**IO利用率**和**CPU利用率**
3. 操作系统解决**硬件利用率**问题的对象往往是**单一的硬件设备**，而**并发编程**要解决**CPU和IO设备综合利用率**的问题

### 综合利用率
假设程序按照**CPU计算**和**IO操作**交叉执行的方式运行，而且CPU计算和IO操作的耗时是**1:1**

#### 单线程
<img src="https://java-concurrent-1253868755.cos.ap-guangzhou.myqcloud.com/java-concurrent-thread-count-utilization-rate-single-thread.png" width=800/>

1. 单线程时，执行CPU计算的时候，IO设备空闲，执行IO操作时，CPU空闲，所以CPU利用率和IO设备的利用率都是**50%**

#### 两线程
<img src="https://java-concurrent-1253868755.cos.ap-guangzhou.myqcloud.com/java-concurrent-thread-count-utilization-rate-two-thread.png" width=800/>

1. 两个线程时，当线程A执行CPU计算时，线程B执行IO操作，当线程A执行IO操作时，线程B执行CPU计算
2. 这样CPU利用率和IO设备的利用率都达到了100%，相对于单线程**吞吐量**提高了1倍
3. 逆向思维：如果CPU和IO设备的利用率都**很低**，可以通过**增加线程**来**提高吞吐量**

#### 多核
<img src="https://java-concurrent-1253868755.cos.ap-guangzhou.myqcloud.com/java-concurrent-thread-count-utilization-rate-multi-core.png" width=800/>

1. 在**单核**时代，多线程主要用来_**平衡CPU和IO设备**_
    - 如果程序**只有CPU计算**，那么多线程反而会让**性能变差**，因为增加了**线程切换**的成本
2. 在**多核**时代，纯CPU计算的程序可以利用多线程来**提升性能**，因为利用多核可以_**降低响应时间**_
    - 例如对于4核CPU，可以将一个计算任务拆分成4个**独立**的子任务，交由4个线程分别在4个核上执行
    - 采用单线程时CPU的利用率只有25%，而采用4线程时能将CPU的利用率提高到100%

## 线程数量
需要依据**具体的应用场景**来确定**线程数量**：_**CPU密集型**_ + _**IO密集型**_

### CPU密集型
1. 对于CPU密集型来说，多线程本质上是要_**提升CPU的利用率**_
2. 为了减少**线程切换**的成本，理论上设置为**CPU核数**即可
3. 但在工程上，一般会设置成**CPU核数+1**，这是为了**保证CPU的利用率**（在某个线程阻塞时，额外的线程能够补上）

### IO密集型

#### 单核
> 最佳线程数 = 1 + (IO耗时 / CPU耗时)

##### 三线程
<img src="https://java-concurrent-1253868755.cos.ap-guangzhou.myqcloud.com/java-concurrent-thread-count-utilization-rate-three-thread.png" width=800/>

1. 如果CPU计算和IO操作的耗时比是1:2
2. 对于线程A，当CPU从线程B、C切换回来时，线程A正好执行完IO操作，这样CPU和IO设备的利用率都达到了100%

#### 多核
> 最佳线程数 = CPU核数 * [1 + (IO耗时 / CPU耗时)]

#### 关键参数
1. 对于IO密集型的应用场景，关键参数是**IO耗时/CPU耗时**，但这个参数是**动态变化**的
2. 因此，如果要估算这个参数，需要做各个不同场景下的**压测**
    - 在压测的过程中，要重点关注**CPU、IO设备的利用率**和性能指标（**延迟+吞吐量**）之间的关系

<!-- indicate-the-source -->

## 参考资料
[Java并发编程实战](https://time.geekbang.org/column/intro/100023901)
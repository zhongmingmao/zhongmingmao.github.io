---
title: RAG - Optimization + Evaluation
mathjax: true
date: 2024-08-15 00:06:25
cover: https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/rag-evaluation.png
categories:
  - AI
  - RAG
tags:
  - AI
  - LLM
  - RAG
---

# RAG 

![image-20241022233308732](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241022233308732.png)

<!-- more -->

# 检索优化

## 数据清洗和预处理

1. 在 RAG 索引流程中，文档解析之后，**文档切块之前**，进行数据清洗和预处理
   - 减少**脏数据**和**噪音**，提升文本的**整体质量**和**信息密度**
2. 手段：**清除冗余信息**、**统一格式**、**处理异常字符**等
   - 处理冗余的**模板内容**
   - 消除文档中的**额外空白**和格式不一致
   - 去除文档**脚注**、**页眉页脚**、**版权信息**

## 查询扩写

1. 在 RAG 系统的检索步骤中，用户的查询会转换为**向量**后进行检索
2. **单个向量**查询只能覆盖**向量空间**中一个**有限区域**
3. 如果查询中的嵌入向量未能包含所有**关键信息**，则可能检索到**不相关**的 Chunk
   - **单点查询**的局限性 - 限制系统在庞大文档库中的**搜索范围**，导致**错失**与查询语义相关的内容
4. 查询扩写
   - 通过 **LLM** 从**原始查询语句**生成多个**语义相关**的查询，可以覆盖**向量空间**中的**不同区域**
   - 提高检索的**全面性**和**准确性**
   - 扩写后的查询在被嵌入后，能够击中不同的语义区域
     - 确保系统能够从**更广泛**的文档中检索到与用户需求**相关**的有用信息
5. 通过查询扩写，**原始问题**被分解为**多个子查询**
   - 每个子查询**独立检索**相关文档并生成相应的结果
   - 系统将所有**子查询**的检索结果进行**合并**和**重新排序**
6. 能够有效**扩展**用户的**查询意图**，确保在**复杂信息库**中进行**更全面**的文档检索

```
你是一个AI语言模型助手。
你的任务是生成五个不同版本的用户问题，以便从向量数据库中检索相关文档。
通过从多个角度生成用户问题，你的目标是帮助用户克服基于距离的相似性搜索的一些局限性。
请将这些替代问题用换行符分隔。原始问题：{查询原文}
```

## 自查询 - 关键字

> 通过 LLM **提取** Query 中关键信息，然后进行混合检索（**关键词检索** + **向量检索**）

1. 将用户**查询**转化为**向量**的过程中，无法确保查询中的**所有关键信息**都被**充分捕捉**到向量中
   - 希望**检索结果**依赖**查询**中**标签**，直接通过嵌入向量进行检索无法确保
     - 这些**标签**在**向量表示**中被**完整表达**
     - 或者在与其它向量的**距离计算**中占有足够的**权重**
   - 可能导致检索结果缺乏**相关性**和**准确性**
2. 自查询策略通过 LLM **自动提取**查询中对业务场景至关重要的**元数据字段**
   - 将**元数据字段**结合到嵌入检索过程中，确保嵌入向量包含这些**关键信息**，从而提高检索的**稳定性**和**精确性**
   - 结合**关键词检索**和**向量检索**，提高检索结果的**相关性**和**准确性**

![image-20241023113530986](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241023113530986.png)

## 提示压缩

1. 提示压缩可以**减少上下文中的噪音**，并**突出最相关的信息**，从而提高**检索精度**和**生成质量**
2. 在 RAG 中，检索到的文档通常包含**大量无关的文本**
   - 这些无关的内容可能会**掩盖**与查询高度相关的信息，导致**生成结果**的**相关性**下降
3. 提示压缩通过**精简**上下文、**过滤**掉不相关的信息，确保系统只处理与查询**最相关**、**最重要**的内容
4. 通过提示压缩，系统能够准确提取出与查询**高度相关**的**核心**信息，去除**冗余**内容，并返回**简洁**的**压缩结果**
   - 组成新的指令，输入 LLM 获得回复，提高 RAG 系统答案的**准确度**

![image-20241023133714182](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241023133714182.png)

# 效果评估

1. 建立**统一**的评估标准，能够公平、客观地比较**不同 RAG 系统**及其优化方法，从而识别出最佳实践
2. RAG 效果评估是 RAG 系统完成搭建后的一个**持续优化**流程
   - 通过设定打分标准和评估指标，**综合评分**能够准确反映 RAG 系统的**整体性能**

## 评估方式

1. **LLM 打分**
   - 使用 LLM 对 RAG 的输出进行**自动评分**
   - **评估效率高**，能够快速处理**大规模**的评估任务，但在**准确性**上可能受到**模型本身偏差**的影响
2. **人工打分**
   - 由人类评审员对 RAG 的输出进行逐一打分
   - 人工评估方式可以提供更为**精确**、**细致**的反映 - 检测生成答案中的**细微错误和幻觉**
   - 但**耗时较长** + **成本较高**

## 评估指标

> 更多指标 - Top N 召回率 + 常用 NLP 评估指标

| 指标                  | 描述                                                         |
| --------------------- | ------------------------------------------------------------ |
| **Context Relevancy** | 用于测量**检索到的信息**与**查询上下文**的相关性<br />如果检索到的信息偏离了原始查询，后续的生成任务就会受到负面影响 |
| **Answer Relevancy**  | 衡量**生成答案**与**原始问题**之间的相关性<br />主要评估生成的答案**能否解决用户的问题**，且**内容是否逻辑连贯** |
| **Faithfulness**      | 评估生成的答案中是否存在**幻觉**或**不准确**之处 -- **非常重要**<br />因为**虚假的答案**会极大影响用户对 RAG 系统的**信任** |

![image-20241023135403059](https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/image-20241023135403059.png)

## 打分标准

| Type           | Score |
| -------------- | ----- |
| **Perfect**    | 1.0   |
| **Acceptable** | 0.75  |
| **Missing**    | 0.5   |
| **Incorrect**  | 0     |


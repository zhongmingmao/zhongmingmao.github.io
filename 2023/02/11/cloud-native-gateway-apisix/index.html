<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>APISIX - Doc | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Feature">
<meta property="og:type" content="article">
<meta property="og:title" content="APISIX - Doc">
<meta property="og:url" content="https://blog.zhongmingmao.top/2023/02/11/cloud-native-gateway-apisix/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="Feature">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/apisix.png">
<meta property="article:published_time" content="2023-02-10T16:06:25.000Z">
<meta property="article:modified_time" content="2024-04-05T15:50:22.365Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="API Gateway">
<meta property="article:tag" content="APISIX">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/apisix.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2023/02/11/cloud-native-gateway-apisix/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'APISIX - Doc',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-05 23:50:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">615</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">187</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">79</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/apisix.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">APISIX - Doc</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2023-02-10T16:06:25.000Z" title="Created 2023-02-11 00:06:25">2023-02-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/api-gateway/">API Gateway</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">27.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>140min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Feature"><a href="#Feature" class="headerlink" title="Feature"></a>Feature</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240403120748136.png" alt="image-20240403120748136"></p>
<span id="more"></span>

<ol>
<li>Apache APISIX 基于 <code>Radixtree</code> Route 和 <code>etcd</code> 提供<code>路由极速匹配</code>与<code>配置快速同步</code>的能力</li>
<li>Apache APISIX 提供了自定义插件的能力<ul>
<li>可以在 <code>Balancer</code> 阶段使用<code>自定义负载均衡算法</code>，并使用<code>自定义路由算法</code>对路由进行<code>精细化</code>控制</li>
</ul>
</li>
<li>Apache APISIX 提供了<code>配置热更新</code>、<code>插件热加载</code>能力，在<code>不重新启动实例</code>的情况下可快速更新配置</li>
</ol>
<h1 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h1><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><blockquote>
<p>Apache APISIX 使用 <code>routes</code> 来提供灵活的网关管理功能，在一个<code>请求</code>中，routes 包含了<code>访问路径</code>和<code>上游目标</code>等信息</p>
</blockquote>
<h3 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h3><ol>
<li>Route 是<code>访问上游目标的路径</code></li>
<li>过程<ul>
<li>通过预定的规则来<code>匹配</code>客户端请求</li>
<li>然后<code>加载</code>和<code>执行</code>相应的<code>插件</code></li>
<li>最后将请求<code>转发</code>至特定的 <code>Upstream</code></li>
</ul>
</li>
<li>一个最简单的 Route 仅由<code>匹配路径</code>和 <code>Upstream 地址</code>两个信息组成</li>
</ol>
<h3 id="Upstream"><a href="#Upstream" class="headerlink" title="Upstream"></a>Upstream</h3><ol>
<li>Upstream 是一组具备<code>相同功能</code>的<code>节点集合</code>，它是对<code>虚拟主机</code>的抽象</li>
<li>Upstream 可以通过预先配置的规则对多个服务节点进行<code>负载均衡</code></li>
</ol>
<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><blockquote>
<p>创建路由 &#x3D; Uri + Upstream</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9180/apisix/admin/routes&quot;</span> -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getting-started-ip&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ip&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求路由</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://127.0.0.1:9080/ip&quot;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.18.0.1, 129.227.149.219&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><ol>
<li>负载均衡管理<code>客户端</code>和<code>服务端</code>之间的流量</li>
<li>负载均衡决定由哪个服务来处理特定的请求，从而提高性能、可扩展性和可靠性</li>
<li>Apache APISIX 支持<code>加权</code>负载均衡算法，传入的流量按照<code>预定顺序</code>轮流分配给一组服务器的其中一个</li>
</ol>
<h3 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a>Examples</h3><blockquote>
<p>创建路由，并启用负载均衡</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9180/apisix/admin/routes&quot;</span> -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getting-started-headers&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/headers&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;httpbin.org:443&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mock.api7.ai:443&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pass_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span> # 将传递请求头给上游</span><br><span class="line">    <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https&quot;</span>    # 向上游发送请求时将启用 TLS</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证负载均衡的效果</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ hc=$(seq <span class="number">100</span> | xargs -I <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> curl <span class="string">&quot;http://127.0.0.1:9080/headers&quot;</span> -sL | grep <span class="string">&quot;httpbin&quot;</span> | wc -l); echo httpbin.org<span class="punctuation">:</span> $hc<span class="punctuation">,</span> mock.api7.ai<span class="punctuation">:</span> $((<span class="number">100</span> - $hc))</span><br><span class="line">httpbin.org<span class="punctuation">:</span> <span class="number">48</span><span class="punctuation">,</span> mock.api7.ai<span class="punctuation">:</span> <span class="number">52</span></span><br></pre></td></tr></table></figure>

<h2 id="密钥验证"><a href="#密钥验证" class="headerlink" title="密钥验证"></a>密钥验证</h2><h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><ol>
<li>Consumer 为使用 <code>API</code> 的应用或者开发人员</li>
<li>在 APISIX 中，Consumer 需要一个<code>全局唯一</code>的名称，并选择一个身份验证插件</li>
</ol>
<h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><ol>
<li>管理员为<code>路由</code>添加一个 <code>API 密钥</code></li>
<li>Consumer 在发送请求时，在 <code>Query</code> 或者 <code>Header</code> 中添加 <code>API 密钥</code></li>
</ol>
<h3 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples"></a>Examples</h3><blockquote>
<p>创建名为 <code>tom</code> 的 Consumer，并启用密钥验证插件，密钥设置为 <code>secret-key</code></p>
</blockquote>
<blockquote>
<p>所有携带密钥 <code>secret-key</code> 的请求都会被识别为 Consumer <code>tom</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9180/apisix/admin/consumers&quot;</span> -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tom&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;secret-key&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 <code>PATCH</code> 方法，为现有路由新增插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9180/apisix/admin/routes/getting-started-ip&quot;</span> -X PATCH -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件启用效果</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9080/ip&quot;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Missing API key found in request&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9080/ip&quot;</span> -H &#x27;apikey<span class="punctuation">:</span> wrong-key&#x27;</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Invalid API key in request&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9080/ip&quot;</span> -H &#x27;apikey<span class="punctuation">:</span> secret-key&#x27;</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">46</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.18.0.1, 129.227.149.219&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>禁用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://127.0.0.1:9180/apisix/admin/routes/getting-started-ip&quot;</span> -X PATCH -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;disable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9080/ip&quot;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">46</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.18.0.1, 129.227.149.219&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="限速"><a href="#限速" class="headerlink" title="限速"></a>限速</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240403151912303.png" alt="image-20240403151912303"></p>
<ol>
<li>APISIX 提供限速功能，通过限制在规定时间内发送到上游服务的请求数量来保护 APIs 和微服务</li>
<li>请求的计数在<code>内存</code>中完成，具有<code>低延迟</code>和<code>高性能</code>的特点</li>
<li>APISIX 也支持使用 <code>Redis</code> 集群进行限速配置，即通过 Redis 来进行计数</li>
</ol>
<h3 id="Examples-3"><a href="#Examples-3" class="headerlink" title="Examples"></a>Examples</h3><blockquote>
<p>使用 <code>PATCH</code> 方法，为现有路由新增限速插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="string">&quot;http://127.0.0.1:9180/apisix/admin/routes/getting-started-ip&quot;</span> -X PATCH -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证限速效果</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ count=$(seq <span class="number">100</span> | xargs -I <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> curl <span class="string">&quot;http://127.0.0.1:9080/ip&quot;</span> -I -sL | grep <span class="string">&quot;503&quot;</span> | wc -l); echo \<span class="string">&quot;200\&quot;: $((100 - $count)), \&quot;503\&quot;: $count</span></span><br><span class="line"><span class="string">&quot;</span><span class="number">200</span><span class="string">&quot;: 2, &quot;</span><span class="number">503</span><span class="string">&quot;: 98</span></span><br></pre></td></tr></table></figure>

<h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><blockquote>
<p>Mac -&gt; VM -&gt; Minikube -&gt; Kubernetes -&gt; APISIX</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ minikube profile list</span><br><span class="line">|----------|-----------|---------|--------------|------|---------|---------|-------|--------|</span><br><span class="line">| Profile  | VM Driver | Runtime |      IP      | Port | Version | Status  | Nodes | Active |</span><br><span class="line">|----------|-----------|---------|--------------|------|---------|---------|-------|--------|</span><br><span class="line">| minikube | docker    | docker  | 192.168.49.2 | 8443 | v1.28.3 | Running |     1 | *      |</span><br><span class="line">|----------|-----------|---------|--------------|------|---------|---------|-------|--------|</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add apisix https://charts.apiseven.com</span><br><span class="line">$ helm repo update</span><br><span class="line">$ helm install apisix apisix/apisix --create-namespace  --namespace apisix</span><br></pre></td></tr></table></figure>

<blockquote>
<p>端口转发：apisix-gateway &#x2F; apisix-admin</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k port-forward -n apisix svc/apisix-gateway 9080:80 --address 0.0.0.0</span><br><span class="line"></span><br><span class="line">$ k port-forward -n apisix svc/apisix-admin 9180:9180 --address 0.0.0.0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取 Admin API key</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k get cm -n apisix apisix -oyaml | grep -A5 admin_key</span><br><span class="line">        admin_key:</span><br><span class="line">          # admin: can everything for configuration data</span><br><span class="line">          - name: &quot;admin&quot;</span><br><span class="line">            key: edd1c9f034335f136f87ad84b625c8f1</span><br><span class="line">            role: admin</span><br><span class="line">          # viewer: only can view configuration data</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Mac 上验证</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s &quot;http://apisix:9080&quot; --head | grep Server</span><br><span class="line">Server: APISIX/3.8.0</span><br><span class="line"></span><br><span class="line">$ curl -s &quot;http://apisix:9180&quot; --head | grep Server</span><br><span class="line">Server: openresty</span><br><span class="line"></span><br><span class="line">$ curl -si &quot;http://apisix:9180/apisix/admin/routes?api_key=edd1c9f034335f136f87ad84b625c8f1&quot;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: APISIX/3.8.0</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Access-Control-Expose-Headers: *</span><br><span class="line">Access-Control-Max-Age: 3600</span><br><span class="line">X-API-VERSION: v3</span><br><span class="line"></span><br><span class="line">&#123;&quot;total&quot;:0,&quot;list&quot;:[]&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240403165944201.png" alt="image-20240403165944201"></p>
<ol>
<li>APISIX 构建于 <code>NGINX</code> + <code>ngx_lua</code> 的技术基础之上，充分利用了 <code>LuaJIT</code> 所提供的强大性能</li>
<li>组成部分<ul>
<li>APISIX Core：Lua 插件、多语言插件运行时、WASM 插件运行时（实验性）<ul>
<li>提供了<code>路由匹配</code>、<code>负载均衡</code>、<code>服务发现</code>、<code>API 管理</code>等重要功能，以及<code>配置管理</code>等基础性模块</li>
</ul>
</li>
<li>功能丰富的各种<code>内置插件</code>：可观测性、安全、流量控制<ul>
<li>使用<code>原生 Lua 实现</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="插件加载流程"><a href="#插件加载流程" class="headerlink" title="插件加载流程"></a>插件加载流程</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240403171039337.png" alt="image-20240403171039337"></p>
<h2 id="插件内部结构"><a href="#插件内部结构" class="headerlink" title="插件内部结构"></a>插件内部结构</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240403171212000.png" alt="image-20240403171212000"></p>
<h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="Upstream-1"><a href="#Upstream-1" class="headerlink" title="Upstream"></a>Upstream</h3><ol>
<li>Upstream 是对<code>虚拟主机</code>的抽象，即应用层服务或节点的抽象</li>
<li>Upstream 的作用是按照<code>配置规则</code>对服务节点进行<code>负载均衡</code></li>
<li>配置方式<ul>
<li>Upstream 的<code>地址信息</code>可以直接配置到 <code>Route</code> 或 <code>Service</code> 上</li>
<li>当多个 <code>Route</code> 或者 <code>Service</code> 引用同一个 Upstream 时<ul>
<li>可以创建 <code>Upstream 对象</code>，在 Route 或者 Service 中使用 <code>Upstream ID</code> 的方式<code>引用</code> Upstream 对象</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Route-1"><a href="#Route-1" class="headerlink" title="Route"></a>Route</h3><ol>
<li>Route 是 APISIX 中<code>最基础</code>和<code>最核心</code>的资源对象</li>
<li>APISIX 可以通过 Route 定义规则<ul>
<li><code>匹配</code>客户端请求</li>
<li>根据匹配结果加载并执行相应的<code>插件</code></li>
<li>最后将请求<code>转发</code>到指定的上游服务</li>
</ul>
</li>
<li>Route 组成部分：<code>匹配规则</code>、<code>插件配置</code>、<code>上游信息</code></li>
</ol>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><ol>
<li>Service 是<code>某类 API</code> 的抽象（或者是<code>一组 Route</code> 的抽象）</li>
<li>Service 通常与<code>上游服务抽象</code>是<code>一一对应</code>的</li>
<li><code>Route : Service = N : 1</code></li>
</ol>
<h3 id="Plugin"><a href="#Plugin" class="headerlink" title="Plugin"></a>Plugin</h3><ol>
<li>Plugin 是扩展 APISIX <code>应用层能力</code>的关键机制</li>
<li>Plugin 主要是在 HTTP <code>请求</code>或者<code>响应</code>生命周期期间执行的、针对请求的个性化策略</li>
<li>Plugin 可以与 <code>Route</code>、<code>Service</code>、<code>Consumer</code> 绑定<ul>
<li>如果 Route、Service、Plugin Config、Consumer 都绑定了相同的插件，则<code>只有一份插件配置</code>会生效</li>
<li>插件配置的优先级（越<code>具体</code>，优先级越<code>高</code>）：<code>Consumer &gt; Route &gt; Plugin Config &gt; Service</code></li>
</ul>
</li>
<li>插件执行过程<ul>
<li><code>rewrite</code>、<code>access</code>、<code>before_proxy</code>、<code>header_filter</code>、<code>body_filter</code>、<code>log</code></li>
</ul>
</li>
</ol>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><blockquote>
<p>创建 Upstream</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://apisix:9180/apisix/admin/upstreams/1&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot;</span> -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Route（可以顺便指定 Upstream 的详细配置）</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://apisix:9180/apisix/admin/routes/1&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot;</span> -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/anything/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试 Route</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i -X GET <span class="string">&quot;http://apisix:9080/anything/get?foo1=bar1&amp;foo2=bar2&quot;</span> -H <span class="string">&quot;Host: example.com&quot;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">461</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;foo1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bar1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;foo2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bar2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;form&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/8.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Amzn-Trace-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Root=1-660d232a-620c25703549fffa42f97497&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Forwarded-Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example.com&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;json&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1, 129.227.149.219&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://example.com/anything/get?foo1=bar1&amp;foo2=bar2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2><blockquote>
<p>限流限速</p>
</blockquote>
<table>
<thead>
<tr>
<th>Plugin</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>limit-conn</td>
<td>限制客户端对服务的<code>并发请求数</code></td>
</tr>
<tr>
<td>limit-req</td>
<td>使用<code>漏桶</code>算法限制对服务的请求速率</td>
</tr>
<tr>
<td>limit-count</td>
<td>在指定的时间范围内，限制每个客户端总请求个数 - <code>固定窗口</code></td>
</tr>
</tbody></table>
<blockquote>
<p>创建 Route，配置 limit-count 插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;var&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试 Plugin</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sI http://apisix:9080/index.html</span><br><span class="line">HTTP/1.1 404 NOT FOUND</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 233</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 1</span><br><span class="line">X-RateLimit-Reset: 60</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Server: APISIX/3.8.0</span><br><span class="line"></span><br><span class="line">$ curl -sI http://apisix:9080/index.html</span><br><span class="line">HTTP/1.1 404 NOT FOUND</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 233</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 0</span><br><span class="line">X-RateLimit-Reset: 55</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Server: APISIX/3.8.0</span><br><span class="line"></span><br><span class="line">$ curl -sI http://apisix:9080/index.html</span><br><span class="line">HTTP/1.1 503 Service Temporarily Unavailable</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 269</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 0</span><br><span class="line">X-RateLimit-Reset: 53</span><br><span class="line">Server: APISIX/3.8.0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>流量控制插件</p>
</blockquote>
<table>
<thead>
<tr>
<th>Plugin</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>proxy-cache</td>
<td>缓存<code>后端</code>响应数据，支持基于<code>磁盘</code>和<code>内存</code>的缓存</td>
</tr>
<tr>
<td>request-validation</td>
<td><code>提前验证</code>向上游服务<code>转发</code>的请求</td>
</tr>
<tr>
<td>proxy-mirror</td>
<td>镜像客户端请求，将线上真实流量拷贝到镜像服务中</td>
</tr>
<tr>
<td>api-breaker</td>
<td>API 熔断</td>
</tr>
<tr>
<td>traffic-split</td>
<td>流量百分比，用于实现蓝绿发布、灰度发布</td>
</tr>
<tr>
<td>request-id</td>
<td>为每个请求代理添加 unique_id，用于<code>追踪</code> API 请求</td>
</tr>
<tr>
<td>proxy-control</td>
<td><code>动态</code>控制 <code>Nginx 代理</code>的相关行为</td>
</tr>
<tr>
<td>client-control</td>
<td>通过设置<code>客户端请求体大小</code>的<code>上限</code>来动态控制 Nginx 处理客户端的请求</td>
</tr>
</tbody></table>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><blockquote>
<p>可观测性分为三个关键部分：<code>Logging</code>、<code>Metrics</code>、<code>Tracing</code></p>
</blockquote>
<h3 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h3><blockquote>
<p>在 APISIX 中，日志可以分为<code>访问日志</code>和<code>错误日志</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it -n apisix apisix-688757658f-nw4mj -c apisix -- pwd</span><br><span class="line">/usr/local/apisix</span><br><span class="line"></span><br><span class="line">$ k exec -it -n apisix apisix-688757658f-nw4mj -c apisix -- ls -l logs</span><br><span class="line">total 4</span><br><span class="line">lrwxrwxrwx 1 apisix apisix 11 Feb 22 14:25 access.log -&gt; /dev/stdout</span><br><span class="line">lrwxrwxrwx 1 apisix apisix 11 Feb 22 14:25 error.log -&gt; /dev/stderr</span><br><span class="line">-rw-r--r-- 1 apisix apisix  2 Apr  3 07:47 nginx.pid</span><br><span class="line">srw-rw-rw- 1 apisix apisix  0 Apr  3 07:47 worker_events.sock</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以通过 APISIX 的日志插件，将 APISIX 的日志发送到指定的日志服务中，将日志数据发送到 mockbin.io 服务中</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;http-logger&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://96702d792b6045c49325bec8c3b351c6.api.mockbin.io/&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/get&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求 Route</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//apisix:9080/get</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">291</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">05</span><span class="punctuation">:</span><span class="number">53</span><span class="punctuation">:</span><span class="number">13</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/8.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Amzn-Trace-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Root=1-660e4049-4b39e7d01a6ccd7515bac485&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Forwarded-Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1, 129.227.149.219&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://apisix/get&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404135813854.png" alt="image-20240404135813854"></p>
<h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h3><ol>
<li>Metrics 是一段时间内测量的数值，默认情况下为结构化数据</li>
<li>APISIX 提供 Prometheus 插件来获取 <code>API Metrics</code>，并在 Prometheus 中暴露它们</li>
<li>通过使用 APISIX 提供的 <code>Grafana Dashboard</code> 元数据，并从 Prometheus 中获取 Metrics，可以更加方便地监控 API</li>
</ol>
<blockquote>
<p>APISIX 启用 Prometheus - <code>apisix.prometheus.enabled=true</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ h upgrade apisix apisix/apisix --create-namespace  --namespace apisix --set apisix.prometheus.enabled=true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Route 启用 Prometheus 插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/get&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;prometheus&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取 Prometheus Metrics</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -si http<span class="punctuation">:</span><span class="comment">//apisix:9091/apisix/prometheus/metrics | grep &#x27;apisix_http_status&#x27;</span></span><br><span class="line"># HELP apisix_http_status HTTP status codes per service in APISIX</span><br><span class="line"># TYPE apisix_http_status counter</span><br><span class="line">apisix_http_status<span class="punctuation">&#123;</span>code=<span class="string">&quot;200&quot;</span><span class="punctuation">,</span>route=<span class="string">&quot;1&quot;</span><span class="punctuation">,</span>matched_uri=<span class="string">&quot;/get&quot;</span><span class="punctuation">,</span>matched_host=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>service=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>consumer=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>node=<span class="string">&quot;184.73.70.187&quot;</span><span class="punctuation">&#125;</span> <span class="number">1</span></span><br><span class="line">apisix_http_status<span class="punctuation">&#123;</span>code=<span class="string">&quot;200&quot;</span><span class="punctuation">,</span>route=<span class="string">&quot;1&quot;</span><span class="punctuation">,</span>matched_uri=<span class="string">&quot;/get&quot;</span><span class="punctuation">,</span>matched_host=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>service=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>consumer=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>node=<span class="string">&quot;35.168.90.70&quot;</span><span class="punctuation">&#125;</span> <span class="number">1</span></span><br><span class="line">apisix_http_status<span class="punctuation">&#123;</span>code=<span class="string">&quot;200&quot;</span><span class="punctuation">,</span>route=<span class="string">&quot;1&quot;</span><span class="punctuation">,</span>matched_uri=<span class="string">&quot;/get&quot;</span><span class="punctuation">,</span>matched_host=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>service=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>consumer=<span class="string">&quot;&quot;</span><span class="punctuation">,</span>node=<span class="string">&quot;54.147.29.229&quot;</span><span class="punctuation">&#125;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="Tracing"><a href="#Tracing" class="headerlink" title="Tracing"></a>Tracing</h3><ol>
<li>Tracing 将一次请求还原成调用链路，并将该请求的调用情况使用拓扑的方式呈现</li>
<li>APISIX Zipkin 插件支持根据 <code>Zipkin API 规范</code>收集链路信息并报告给 Zipkin Collector</li>
</ol>
<blockquote>
<p>启用 Zipkin 插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;GET&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/get&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;zipkin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;endpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:9411/api/v2/spans&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sample_ratio&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><blockquote>
<p>健康检查可以在上游节点发生<code>故障</code>或者迁移时，将请求代理到健康的节点上，最大程度避免服务不可用的问题</p>
</blockquote>
<h3 id="主动健康检查"><a href="#主动健康检查" class="headerlink" title="主动健康检查"></a>主动健康检查</h3><ol>
<li>APISIX 通过预设的探针类型（<code>HTTP</code>、<code>HTTPS</code>、<code>TCP</code>），主动探测上游节点的存活性</li>
<li>当发往健康节点 A 的 N 个<code>连续</code>探针都失败，则该节点将被标记为不健康<ul>
<li>不健康的节点将会被 APISIX 的<code>负载均衡器</code>忽略，无法收到请求</li>
</ul>
</li>
<li>如果某个不健康的节点，<code>连续</code> M 个探针都成功，则该节点将被重新标记为健康，进而可以被代理</li>
</ol>
<h3 id="被动健康检查"><a href="#被动健康检查" class="headerlink" title="被动健康检查"></a>被动健康检查</h3><ol>
<li>通过判断从 APISIX 转发到上游节点的请求<code>响应</code>状态，来判断对应的上游节点是否健康<ul>
<li>如果发往健康节点 A 的 N 个<code>连续</code>请求都被判定为失败，则该节点将被标记为不健康</li>
</ul>
</li>
<li>无需发起额外的探针，但也无法提前感知节点状态，可能会存在一定量的失败请求</li>
</ol>
<blockquote>
<p>由于不健康的节点无法收到请求，因此必须配合<code>主动</code>健康检查，才有可能重新标记为健康</p>
</blockquote>
<ol>
<li>只有 Upstream <code>被请求时</code>才会开始健康检查<ul>
<li>如果 Upstream 被<code>配置</code>但没有被请求，不会触发启动健康检查</li>
</ul>
</li>
<li>如果<code>没有健康的节点</code>，那么请求会<code>继续发送</code>到 Upstream</li>
<li>如果 Upstream 中<code>只有一个节点</code>时，<code>不会触发</code>启动健康检查<ul>
<li>因为无论该节点无论是否健康，请求都将转发到该节点</li>
</ul>
</li>
</ol>
<h3 id="Examples-4"><a href="#Examples-4" class="headerlink" title="Examples"></a>Examples</h3><blockquote>
<p>启用健康检查</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1970&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;retries&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;checks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;active&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;http_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/status&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;healthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;successes&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;unhealthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;http_failures&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;req_headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;User-Agent: curl/7.29.0&quot;</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;passive&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;healthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;http_statuses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">200</span><span class="punctuation">,</span> <span class="number">201</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;successes&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;unhealthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;http_statuses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">500</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;http_failures&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;tcp_failures&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发起请求，触发主动健康检查（只配置但没有请求，是不会触发健康检查的）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sI http://apisix:9080/index.html</span><br><span class="line">HTTP/1.1 502 Bad Gateway</span><br><span class="line">Date: Thu, 04 Apr 2024 07:04:40 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 229</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 1</span><br><span class="line">X-RateLimit-Reset: 60</span><br><span class="line">Server: APISIX/3.8.0</span><br><span class="line">X-APISIX-Upstream-Status: 502, 502 :</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404151048367.png" alt="image-20240404151048367"></p>
<h3 id="健康检查信息"><a href="#健康检查信息" class="headerlink" title="健康检查信息"></a>健康检查信息</h3><h4 id="status"><a href="#status" class="headerlink" title="status"></a>status</h4><ol>
<li>在 APISIX 中，节点有 4 个状态：healthy、unhealthy、mostly_unhealthy、mostly_healthy</li>
<li>mostly_healthy<ul>
<li>当前节点状态是健康的，但在健康检查期间，节点健康检测并不是一直都是成功的</li>
</ul>
</li>
<li>mostly_unhealthy<ul>
<li>当前节点状态是不健康的，但在健康检查期间，节点健康检测并不是一直都是失败的</li>
</ul>
</li>
</ol>
<h4 id="counter"><a href="#counter" class="headerlink" title="counter"></a>counter</h4><ol>
<li>节点的状态转换取决于：本次健康检查的结果 + counter</li>
<li>counter 的数据：success、tcp_failure、http_failure、timeout_failure</li>
</ol>
<h4 id="Examples-5"><a href="#Examples-5" class="headerlink" title="Examples"></a>Examples</h4><blockquote>
<p>需要开启 Control API - <code>/v1/healthcheck</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http<span class="punctuation">:</span><span class="comment">//apisix:9090/v1/healthcheck | jq</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/apisix/routes/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unhealthy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;counter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;http_failure&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;timeout_failure&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tcp_failure&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1970</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo.com&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unhealthy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;counter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;http_failure&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;timeout_failure&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tcp_failure&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1980</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="状态转化图"><a href="#状态转化图" class="headerlink" title="状态转化图"></a>状态转化图</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404161136217.png" alt="image-20240404161136217"></p>
<ol>
<li>所有节点在<code>没有初始探测</code>的情况下，都是以 <code>healthy</code> 状态启动</li>
<li>计数器仅在<code>状态变更</code>时重置和更新<ul>
<li>当节点处于 healthy 状态并且后续检查都成功时，success 计数器不会更新，保持为 <code>0</code></li>
</ul>
</li>
<li>如果健康检查失败，counter.success 重置为 0</li>
<li>如果健康检查成功，counter.tcp_failure、counter.http_failure、counter.timeout_failure 重置为 0</li>
</ol>
<h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><ol>
<li>Create a global rule to enable the <code>prometheus</code> plugin on <code>all routes</code> by adding <code>&quot;prometheus&quot;: &#123;&#125;</code> in the plugins option.</li>
<li>APISIX gathers <code>internal runtime metrics</code> and exposes them through port <code>9091</code> and URI path <code>/apisix/prometheus/metrics</code> by default that Prometheus can scrape.</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://apisix:9180/apisix/admin/global_rules&quot;</span> -H <span class="string">&quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot;</span> -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;rule-for-metrics&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;prometheus&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>APISIX automatically exposes <code>health check metrics data</code> for your APIs if the health check parameter is <code>enabled</code> for upstream nodes.</p>
</blockquote>
<blockquote>
<p>Health check data is represented with metrics label <code>apisix_upstream_status</code>.<br>A value of <code>1</code> represents <code>healthy</code> and <code>0</code> means the upstream node is <code>unhealthy</code>.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl -si http<span class="punctuation">:</span><span class="comment">//apisix:9091/apisix/prometheus/metrics | grep &#x27;apisix_upstream_status&#x27;</span></span><br><span class="line"># HELP apisix_upstream_status Upstream status from health check</span><br><span class="line"># TYPE apisix_upstream_status gauge</span><br><span class="line">apisix_upstream_status<span class="punctuation">&#123;</span>name=<span class="string">&quot;/apisix/routes/1&quot;</span><span class="punctuation">,</span>ip=<span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span>port=<span class="string">&quot;1970&quot;</span><span class="punctuation">&#125;</span> <span class="number">0</span></span><br><span class="line">apisix_upstream_status<span class="punctuation">&#123;</span>name=<span class="string">&quot;/apisix/routes/1&quot;</span><span class="punctuation">,</span>ip=<span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span>port=<span class="string">&quot;1980&quot;</span><span class="punctuation">&#125;</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="Consumer-1"><a href="#Consumer-1" class="headerlink" title="Consumer"></a>Consumer</h2><h3 id="API-Consumers"><a href="#API-Consumers" class="headerlink" title="API Consumers"></a>API Consumers</h3><ol>
<li>API consumers are <em>the users of APIs</em>.</li>
<li>An API Management solution should know <code>who</code> the consumer of the API is to configure <code>different rules</code> for <code>different consumers</code>.</li>
</ol>
<h3 id="Apache-APISIX-Consumers"><a href="#Apache-APISIX-Consumers" class="headerlink" title="Apache APISIX Consumers"></a>Apache APISIX Consumers</h3><ol>
<li>In Apache APISIX, the <code>Consumer object</code> is the most common way for API consumers to access APIs published through its API Gateway.</li>
<li>Consumer concept is extremely useful when you have <code>different consumers</code> requesting the <code>same API</code> and you need to execute <code>various</code> Plugins and Upstream configurations based on the consumer.</li>
<li>By publishing APIs through Apache APISIX API Gateway, you can easily <code>secure API access</code> using <code>consumer keys</code> or sometimes it can be referred to as subscription keys.<ul>
<li>Developers who need to <code>consume</code> the published APIs must include a <code>valid</code> subscription key in <code>HTTP</code> requests when calling those APIs.</li>
<li>Without a valid subscription key, the calls are <code>rejected immediately</code> by the API gateway and <code>not forwarded</code> to the back-end services.</li>
</ul>
</li>
<li>Consumers can be associated with <code>various scopes</code>: per Plugin, all APIs, or an individual API. </li>
<li>Use cases<ul>
<li>Enable different <code>authentication</code> methods for different consumers.</li>
<li>Restrict access to API <code>resources</code> for specific consumers.</li>
<li>Route requests to the <code>corresponding backend service</code> based on the consumer.</li>
<li>Define <code>rate limiting</code> on the number of data clients can consume.</li>
<li>Analyze <code>data usage</code> for an individual and a subset of consumers.</li>
</ul>
</li>
</ol>
<h2 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h2><ol>
<li>Caching is capable of <code>storing</code> and <code>retrieving</code> network requests and their corresponding responses.</li>
<li>Caching happens at different levels in a web application<ul>
<li>Edge caching or CDN</li>
<li>Database caching</li>
<li>Server caching (API caching)</li>
<li>Browser caching</li>
</ul>
</li>
<li><code>Reverse Proxy Caching</code> is yet another caching mechanism that is usually implemented inside <code>API Gateway</code>.<ul>
<li>It can reduce the number of calls made to your endpoint and also improve the latency of requests to your API by caching a response from the <code>upstream</code>.</li>
<li>If the API Gateway cache has a fresh copy of the requested resource, it uses that copy to satisfy the request <code>directly</code> instead of making a request to the endpoint.</li>
<li>If the cached data is not found, the request travels to the intended upstream services (backend services).</li>
</ul>
</li>
<li>Apache APISIX API Gateway Proxy Caching<ul>
<li>With the help of Apache APISIX, you can enable API caching with <code>proxy-cache</code> plugin to cache your API endpoint’s responses and enhance the performance.</li>
<li>It can be used together with other Plugins too and currently supports <code>disk-based caching</code>.</li>
<li>The data to be cached can be <em>filtered</em> with <em>responseCodes</em>, <em>requestModes</em>, or more complex methods using the <em>noCache</em> and <em>cacheByPass</em> attributes.</li>
<li>You can specify <code>cache expiration time</code> or a <code>memory capacity</code> in the plugin configuration as well.</li>
</ul>
</li>
</ol>
<h2 id="Versioning"><a href="#Versioning" class="headerlink" title="Versioning"></a>Versioning</h2><ol>
<li>API versioning is the practice of managing changes to an API and ensuring that these changes are made without disrupting clients.</li>
<li>A good API versioning strategy clearly communicates the changes made and allows API consumers to decide when to upgrade to the latest version at their own pace.</li>
<li>Types<ul>
<li>URI Path<ul>
<li><a target="_blank" rel="noopener" href="http://apisix.org/v1/hello">http://apisix.org/v1/hello</a></li>
</ul>
</li>
<li>Query parameters<ul>
<li><a target="_blank" rel="noopener" href="http://apisix.org/hello?version=1">http://apisix.org/hello?version=1</a></li>
</ul>
</li>
<li>Custom request Header<ul>
<li><a target="_blank" rel="noopener" href="http://apisix.org/hello">http://apisix.org/hello</a> -H ‘Version: 1’</li>
</ul>
</li>
</ul>
</li>
<li>The primary goal of versioning is to provide users of an API with the <code>most functionality</code> possible while causing <code>minimal inconvenience</code>.</li>
</ol>
<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><h3 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h3><blockquote>
<p>To establish a WebSocket connection, the client sends a WebSocket <code>handshake</code> request</p>
</blockquote>
<blockquote>
<p>Client</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==</span><br><span class="line">Sec-WebSocket-Protocol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">Origin: http://example.com</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Server</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=</span><br><span class="line">Sec-WebSocket-Protocol: chat</span><br></pre></td></tr></table></figure>

<blockquote>
<p>handshake workflow</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404180117059.png" alt="image-20240404180117059"></p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><ol>
<li>While establishing connections from the client to server in the <code>handshake</code> phase, APISIX first checks its authentication information before choosing to forward the request or deny it.</li>
</ol>
<h3 id="Examples-6"><a href="#Examples-6" class="headerlink" title="Examples"></a>Examples</h3><blockquote>
<p>创建 Route - wss:&#x2F;&#x2F;ws.postman-echo.com&#x2F;raw</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl --location --request PUT &#x27;http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1&#x27; \</span></span><br><span class="line">--header &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line">--header &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; \</span><br><span class="line">--data-raw &#x27;<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;enable_websocket&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;ws.postman-echo.com:443&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Consumer</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl --location --request PUT &#x27;http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/consumers/jack&#x27; \</span></span><br><span class="line">--header &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line">--header &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; \</span><br><span class="line">--data-raw &#x27;<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;this_is_the_key&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试 Route</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404181608318.png" alt="image-20240404181608318"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404182151707.png" alt="image-20240404182151707"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404182208731.png" alt="image-20240404182208731"></p>
<h1 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h1><h2 id="API-Gateway"><a href="#API-Gateway" class="headerlink" title="API Gateway"></a>API Gateway</h2><ol>
<li>API 网关是位于客户端与后端服务集之间的 API 管理工具</li>
<li>API 网关相当于<code>反向代理</code>，用于接受所有 API 的调用、整合处理这些调用所需的各种服务，并返回相应的结果</li>
<li>API 网关通常会处理<strong>跨 API 服务系统使用</strong>的常见任务，并统一接入进行管理</li>
<li>通过 API 网关的统一拦截，可以实现对 API 接口的安全、日志等共性需求，如用户身份验证、速率限制和统计信息</li>
<li>API Gateway vs API Microservices<ul>
<li>它是所有 API 请求的唯一入口</li>
<li>可用于将请求转发到不同的后端，或根据请求头将请求转发到不同的服务</li>
<li>可用于执行身份验证、授权和限速</li>
<li>它可用于支持分析，例如监控、日志记录和跟踪</li>
<li>可以保护 API 免受 SQL 注入、DDOS 攻击和 XSS 等恶意攻击媒介的攻击</li>
<li>它可以降低 API 和微服务的复杂性</li>
</ul>
</li>
</ol>
<h2 id="Consumer-2"><a href="#Consumer-2" class="headerlink" title="Consumer"></a>Consumer</h2><ol>
<li>Consumer 是<code>某类服务</code>的消费者，需要与<code>用户认证</code>配合才可以使用</li>
<li>当不同的消费者请求同一个 API 时，APISIX 会根据当前请求的用户信息，对应不同的 Plugin 或 Upstream 配置</li>
<li>如果 Route、Service、Consumer 和 Plugin Config 都绑定了相同的插件，只有 Consumer 的插件配置会生效<ul>
<li>插件配置的优先级：Consumer &gt; Route &gt; Plugin Config &gt; Service</li>
</ul>
</li>
</ol>
<h3 id="识别消费者"><a href="#识别消费者" class="headerlink" title="识别消费者"></a>识别消费者</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404190202512.png" alt="image-20240404190202512"></p>
<ol>
<li>身份认证<ul>
<li>basic-auth、hmac-auth、jwt-auth、key-auth、ldap-auth、wolf-rbac</li>
</ul>
</li>
<li>获取 Consumer Id - 消费者的唯一标识</li>
<li>获取 Consumer 上<code>绑定</code>的 Plugin 或者 Upstream 信息</li>
</ol>
<h3 id="Examples-7"><a href="#Examples-7" class="headerlink" title="Examples"></a>Examples</h3><blockquote>
<p>创建 Consumer - key-auth + limit-count</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/consumers \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-one&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Route - key-auth</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://apisix:9080/hello -H &#x27;apikey: auth-one&#x27; -I</span><br><span class="line">HTTP/1.1 502 Bad Gateway</span><br><span class="line">Date: Thu, 04 Apr 2024 11:08:47 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 229</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 1</span><br><span class="line">X-RateLimit-Reset: 60</span><br><span class="line">Server: APISIX/3.8.0</span><br><span class="line">X-APISIX-Upstream-Status: 502</span><br><span class="line"></span><br><span class="line">$ HTTP/1.1 502 Bad Gateway</span><br><span class="line">Date: Thu, 04 Apr 2024 11:08:54 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 229</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 0</span><br><span class="line">X-RateLimit-Reset: 53</span><br><span class="line">Server: APISIX/3.8.0</span><br><span class="line">X-APISIX-Upstream-Status: 502</span><br><span class="line"></span><br><span class="line">$ curl http://apisix:9080/hello -H &#x27;apikey: auth-one&#x27; -I</span><br><span class="line">HTTP/1.1 503 Service Temporarily Unavailable</span><br><span class="line">Date: Thu, 04 Apr 2024 11:08:56 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 269</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 0</span><br><span class="line">X-RateLimit-Reset: 51</span><br><span class="line">Server: APISIX/3.8.0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>启用 <code>consumer-restriction</code> 插件，限制 Consumer 对 Route 的访问</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;consumer-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;blacklist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;jack&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://apisix:9080/hello -H &#x27;apikey: auth-one&#x27; -I</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Thu, 04 Apr 2024 11:11:25 GMT</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: APISIX/3.8.0</span><br></pre></td></tr></table></figure>

<h2 id="Consumer-Groups"><a href="#Consumer-Groups" class="headerlink" title="Consumer Groups"></a>Consumer Groups</h2><ol>
<li>在同一个 Consumer Group 中启用任意数量的插件，并在一个或者 Consumer 中引用该 Consumer Group</li>
</ol>
<blockquote>
<p>创建 Consumer Group</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/consumer_groups/company_a \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;grp_company_a&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Consumer 中引用 Consumer Group（如果找不到，终止请求，返回 404）</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/consumers \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-one&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;group_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;company_a&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果 Consumer 已经配置了插件，那么将与 Consumer Group 中的插件<code>合并</code></p>
</blockquote>
<ol>
<li>当一份插件分别在 Consumer、Route、Plugin Config、Service 中时，只会有一份插件配置生效，<code>Consumer</code> 的优先级最高</li>
<li>如果 Consumer 和 Consumer Group 配置了相同的插件，则 <code>Consumer</code> 的插件配置优先级更高</li>
</ol>
<h2 id="Global-Rules"><a href="#Global-Rules" class="headerlink" title="Global Rules"></a>Global Rules</h2><ol>
<li><code>Plugin</code> 的配置可以<code>直接绑定</code>在 Route、Service、Consumer 上</li>
<li>Global Rules 为<code>全局插件配置</code>，作用于<code>所有请求</code>的 Plugin</li>
<li>相对于 Route、Service、Plugin Config、Consumer 中的插件配置、Global Rules 中的插件<code>总是优先执行</code></li>
</ol>
<blockquote>
<p>创建 Global Rules</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/global_rules/1 -X PUT \</span></span><br><span class="line">  -H &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; \</span><br><span class="line">  -H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line">  -d &#x27;<span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看 Global Rules</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/global_rules -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; | jq</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;var&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;allow_degradation&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;show_limit_quota_header&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;update_time&quot;</span><span class="punctuation">:</span> <span class="number">1712229810</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;create_time&quot;</span><span class="punctuation">:</span> <span class="number">1712229810</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;modifiedIndex&quot;</span><span class="punctuation">:</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createdIndex&quot;</span><span class="punctuation">:</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/apisix/global_rules/1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;prometheus&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;prefer_name&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;update_time&quot;</span><span class="punctuation">:</span> <span class="number">1712220359</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;create_time&quot;</span><span class="punctuation">:</span> <span class="number">1712220359</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rule-for-metrics&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;modifiedIndex&quot;</span><span class="punctuation">:</span> <span class="number">57</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createdIndex&quot;</span><span class="punctuation">:</span> <span class="number">57</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/apisix/global_rules/rule-for-metrics&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Plugin-1"><a href="#Plugin-1" class="headerlink" title="Plugin"></a>Plugin</h2><ol>
<li>APISIX 插件可以扩展 APISIX 的功能，以满足组织或用户特定的流量管理、可观测性、安全、请求&#x2F;响应转换、无服务器计算等需求</li>
<li>APISIX 插件可以<code>全局启用</code>，也可以<code>局部绑定</code>到其它对象（Route、Service、Consumer、Plugin Config）</li>
<li>安装的插件首先会被<code>初始化</code>。然后会<code>检查</code>插件的配置，以确保插件配置遵循定义的 <code>JSON Schema</code></li>
<li>当一个请求通过 APISIX 时，插件的相应方法会在以下一个或多个阶段中执行</li>
<li>插件执行顺序<ul>
<li><code>Global Rules</code> Plugin<ul>
<li><code>rewrite</code> 阶段的插件</li>
<li><code>access</code> 阶段的插件</li>
</ul>
</li>
<li><code>绑定</code>到其它对象的插件<ul>
<li><code>rewrite</code> 阶段的插件</li>
<li><code>access</code> 阶段的插件</li>
</ul>
</li>
</ul>
</li>
<li>在每个阶段内，可以在插件的 <code>_meta.priority</code> 字段中可选地定义一个新的优先级数，该优先级数优先于默认插件优先级<ul>
<li>具有<code>更高优先级数</code>的插件<code>首先执行</code></li>
</ul>
</li>
<li>若要将插件实例的优先级<code>重置为默认值</code>，只需从插件配置中删除<code>_meta.priority</code>字段即可</li>
<li>插件<code>合并</code>优先顺序<ul>
<li>当同一个插件在<code>全局规则</code>中和<code>局部规则</code>（例如路由）中同时配置时，两个插件将<code>顺序执行</code></li>
<li>如果相同的插件在多个对象上本地配置，如 Route、Service、Consumer、Plugin Config，<code>每个非全局插件只会执行一次</code><ul>
<li>在执行期间，针对特定的优先顺序，这些对象中配置的插件会被<code>合并</code></li>
<li><code>Consumer &gt; Consumer Group &gt; Route &gt; Plugin Config &gt; Service</code></li>
<li>如果相同的插件在不同的对象中具有不同的配置，则合并期间具有最高优先顺序的插件配置将被使用</li>
</ul>
</li>
</ul>
</li>
<li><code>自定义插件优先级</code>只会影响插件实例<code>绑定</code>的主体，不会影响该插件的所有实例</li>
<li><code>自定义插件优先级</code>不适用于 <code>Consumer</code> 上配置的插件的 <code>rewrite</code> 阶段<ul>
<li><code>Route</code> 上配置的插件的 <code>rewrite</code> 阶段将会优先运行，然后才会运行 <code>Consumer</code> 上除 <code>auth</code> 类插件之外的其他插件的 <code>rewrite</code> 阶段</li>
</ul>
</li>
<li>动态控制插件执行状态<ul>
<li>默认情况下，在 Route 中指定的 Plugin 都会被执行</li>
<li>可以通过 <code>filter</code> 配置项为插件添加一个过滤器，通过过滤器的执行结果控制插件是否执行</li>
</ul>
</li>
<li>APISIX 的插件是<code>热加载</code>的<ul>
<li><code>curl http://apisix:9180/apisix/admin/plugins/reload -H &#39;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#39; -X PUT</code></li>
</ul>
</li>
<li>如果在 Route 里配置了某个 Plugin，但在配置文件中禁用了该 Plugin，则在执行 Route 时会跳过该 Plugin</li>
</ol>
<blockquote>
<p>创建 Route</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d  \</span><br><span class="line">&#x27;<span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/get&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;proxy-rewrite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">[</span><span class="string">&quot;arg_version&quot;</span><span class="punctuation">,</span> <span class="string">&quot;==&quot;</span><span class="punctuation">,</span> <span class="string">&quot;v2&quot;</span><span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/anything&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不携带参数，proxy-rewrite 插件不会执行，请求被转发到上游的 <code>/get</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v /dev/<span class="literal"><span class="keyword">null</span></span> http<span class="punctuation">:</span><span class="comment">//apisix:9080/get -H&quot;host:httpbin.org&quot;</span></span><br><span class="line">* URL rejected<span class="punctuation">:</span> No host part in the URL</span><br><span class="line">* Closing connection</span><br><span class="line">curl<span class="punctuation">:</span> (<span class="number">3</span>) URL rejected<span class="punctuation">:</span> No host part in the URL</span><br><span class="line">*   Trying <span class="number">192.168</span><span class="number">.191</span><span class="number">.175</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to apisix (<span class="number">192.168</span><span class="number">.191</span><span class="number">.175</span>) port <span class="number">9080</span></span><br><span class="line">&gt; GET /get HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span>httpbin.org</span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">8.4</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment">&lt; Content-Type: application/json</span></span><br><span class="line"><span class="comment">&lt; Content-Length: 306</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; X-RateLimit-Limit: 2</span></span><br><span class="line"><span class="comment">&lt; X-RateLimit-Remaining: 0</span></span><br><span class="line"><span class="comment">&lt; X-RateLimit-Reset: 10</span></span><br><span class="line"><span class="comment">&lt; Date: Thu, 04 Apr 2024 11:59:57 GMT</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Allow-Origin: *</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Allow-Credentials: true</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.8.0</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  &quot;args&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">  &quot;headers&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;Accept&quot;: &quot;*/</span>*<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>Host<span class="string">&quot;: &quot;</span>httpbin.org<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>User-Agent<span class="string">&quot;: &quot;</span>curl/<span class="number">8.4</span><span class="number">.0</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>X-Amzn-Trace-Id<span class="string">&quot;: &quot;</span>Root=<span class="number">1</span><span class="number">-660e963</span>d<span class="number">-6</span>f540ee273b539db5066675d<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>X-Forwarded-Host<span class="string">&quot;: &quot;</span>httpbin.org<span class="string">&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;</span>origin<span class="string">&quot;: &quot;</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">,</span> <span class="number">129.227</span><span class="number">.149</span><span class="number">.219</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">  &quot;</span>url<span class="string">&quot;: &quot;</span>http<span class="punctuation">:</span><span class="comment">//httpbin.org/get&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">* Connection #<span class="number">0</span> to host apisix left intact</span><br></pre></td></tr></table></figure>

<blockquote>
<p>携带参数 <code>version=v2</code> 时，则 <code>proxy-rewrite</code> 插件会执行，请求被转发到上游的 <code>/anything</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v /dev/<span class="literal"><span class="keyword">null</span></span> http<span class="punctuation">:</span><span class="comment">//apisix:9080/get\?version\=v2 -H&quot;host:httpbin.org&quot;</span></span><br><span class="line">* URL rejected<span class="punctuation">:</span> No host part in the URL</span><br><span class="line">* Closing connection</span><br><span class="line">curl<span class="punctuation">:</span> (<span class="number">3</span>) URL rejected<span class="punctuation">:</span> No host part in the URL</span><br><span class="line">*   Trying <span class="number">192.168</span><span class="number">.191</span><span class="number">.175</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to apisix (<span class="number">192.168</span><span class="number">.191</span><span class="number">.175</span>) port <span class="number">9080</span></span><br><span class="line">&gt; GET /get?version=v2 HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span>httpbin.org</span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">8.4</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment">&lt; Content-Type: application/json</span></span><br><span class="line"><span class="comment">&lt; Content-Length: 428</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; X-RateLimit-Limit: 2</span></span><br><span class="line"><span class="comment">&lt; X-RateLimit-Remaining: 1</span></span><br><span class="line"><span class="comment">&lt; X-RateLimit-Reset: 60</span></span><br><span class="line"><span class="comment">&lt; Date: Thu, 04 Apr 2024 12:02:18 GMT</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Allow-Origin: *</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Allow-Credentials: true</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.8.0</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  &quot;args&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;version&quot;: &quot;v2&quot;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  &quot;data&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">  &quot;files&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">  &quot;form&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">  &quot;headers&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;Accept&quot;: &quot;*/</span>*<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>Host<span class="string">&quot;: &quot;</span>httpbin.org<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>User-Agent<span class="string">&quot;: &quot;</span>curl/<span class="number">8.4</span><span class="number">.0</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>X-Amzn-Trace-Id<span class="string">&quot;: &quot;</span>Root=<span class="number">1</span><span class="number">-660e96</span>ca<span class="number">-13</span>a4caa52b644579553bedad<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>X-Forwarded-Host<span class="string">&quot;: &quot;</span>httpbin.org<span class="string">&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;</span>json<span class="string">&quot;: null,</span></span><br><span class="line"><span class="string">  &quot;</span>method<span class="string">&quot;: &quot;</span>GET<span class="string">&quot;,</span></span><br><span class="line"><span class="string">  &quot;</span>origin<span class="string">&quot;: &quot;</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">,</span> <span class="number">129.227</span><span class="number">.149</span><span class="number">.219</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">  &quot;</span>url<span class="string">&quot;: &quot;</span>http<span class="punctuation">:</span><span class="comment">//httpbin.org/anything?version=v2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">* Connection #<span class="number">0</span> to host apisix left intact</span><br></pre></td></tr></table></figure>

<h2 id="Plugin-Config"><a href="#Plugin-Config" class="headerlink" title="Plugin Config"></a>Plugin Config</h2><ol>
<li>在不同的 Route 会使用相同的 Plugin 规则，可以通过 Plugin Config 来设置这些规则</li>
<li>Plugin Config 属于一组<code>通用插件配置</code>的<code>抽象</code></li>
<li>plugins 的配置可以通过 Admin API <code>/apisix/admin/plugin_configs</code> 进行单独配置，在 Route 中使用 <code>plugin_config_id</code> 与之进行关联</li>
<li>对于同一个插件的配置，只能有一个是有效的<ul>
<li>优先级为 <code>Consumer &gt; Route &gt; Plugin Config &gt; Service</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>创建 Plugin Config</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/plugin_configs/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enable limit-count plugin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Route 并绑定 Plugin Config（如果找不到 Plugin Config，则在该 Route 上的请求会 <code>503</code>）</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uris&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;/index.html&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugin_config_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果 Route 中已经配置了 <code>plugins</code>，那么 Plugin Config 里的插件配置合并 <code>plugins</code> 的插件配置</p>
</blockquote>
<blockquote>
<p>创建 Plugin Config</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/plugin_configs/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enable ip-restruction and limit-count plugin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ip-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;whitelist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;127.0.0.0/24&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;113.74.26.106&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Route 中引入 Plugin Config</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uris&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;/index.html&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugin_config_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;proxy-rewrite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/add&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix.iresty.com&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>合并后的效果</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uris&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;/index.html&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ip-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;whitelist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;127.0.0.0/24&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;113.74.26.106&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;proxy-rewrite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/add&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix.iresty.com&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Plugin-Metadata"><a href="#Plugin-Metadata" class="headerlink" title="Plugin Metadata"></a>Plugin Metadata</h2><ol>
<li>在 APISIX 中，配置<code>通用</code>的元数据属性，可以作用于包含该元数据插件的所有 <code>Route</code> 及 <code>Service</code> 中</li>
<li>为 rocketmq-logger 指定了 log_format，则所有绑定 rocketmq-logger 的 <code>Route</code> 或 <code>Service</code> 都将使用该日志格式</li>
<li>在插件级别设置的元数据属性更加精细，并且比<code>全局</code>元数据对象具有更高的优先级</li>
<li>插件元数据对象只能用于具有元数据属性的插件</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404202121674.png" alt="image-20240404202121674"></p>
<blockquote>
<p>配置 Plugin Metadata</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/plugin_metadata/http-logger \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;log_format&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$host&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$time_iso8601&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;client_ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$remote_addr&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Route-2"><a href="#Route-2" class="headerlink" title="Route"></a>Route</h2><ol>
<li>Route 是 APISIX 中<code>最基础</code>和<code>最核心</code>的资源对象</li>
<li>APISIX 通过 <code>Route</code> 定义规则来<code>匹配</code>客户端请求，根据匹配结果加载并执行相应的<code>插件</code>，最后将请求<code>转发</code>给到指定的上游服务</li>
<li>组成部分<ul>
<li>匹配规则 - uri、host、remote_addr 等</li>
<li>插件配置</li>
<li>上游信息 - 负载均衡</li>
</ul>
</li>
<li>配置范式<ul>
<li>可以在 Route 中完成<code>所有参数</code>的配置，相对独立</li>
<li>当 Route 中有比较多的<code>重复配置</code>，可以通过配置 Service 和 Upstream 的 <code>ID</code> 或者其他对象的 ID 来完成路由配置<ul>
<li>APISIX 所有的资源对象的 ID，均使用<code>字符串</code>格式</li>
<li>当资源对象的 ID 大于 <code>14</code> 个字符时，请务必使用<code>字符串</code>形式表示该资源对象</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404203031643.png" alt="image-20240404203031643"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugin_config_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456789apacheapisix&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h2><ol>
<li>允许用户选择不同 Router 来更好匹配自由业务，在<code>性能</code>、<code>自由</code>之间做最适合选择</li>
<li>apisix.router.http - HTTP 请求路由<ul>
<li>radixtree_uri<ul>
<li>只使用 <code>uri</code> 作为<code>主索引</code></li>
<li>基于 <code>radixtree</code> 引擎，支持<code>全量</code>和<code>深前缀</code>匹配<ul>
<li>绝对匹配 - <code>/foo/bar</code></li>
<li>前缀匹配 - <code>/foo*</code></li>
</ul>
</li>
<li>匹配优先级<ul>
<li><code>绝对匹配 -&gt; 前缀匹配</code></li>
</ul>
</li>
</ul>
</li>
<li>radixtree_uri_with_parameter<ul>
<li>radixtree_uri + 参数匹配</li>
</ul>
</li>
<li>radixtree_host_uri<ul>
<li>使用 <code>host + uri</code> 作为主索引</li>
<li>基于 <code>radixtree</code> 引擎，对当前请求会同时匹配 <code>host</code> 和 <code>uri</code>，支持的匹配条件与 radixtree_uri 基本一致</li>
</ul>
</li>
</ul>
</li>
<li>在 3.2 之前，默认使用 <code>radixtree_uri</code> 作为<code>默认路由</code><ul>
<li>性能：<code>radixtree_uri &gt; radixtree_host_uri</code></li>
</ul>
</li>
<li>apisix.router.ssl - SSL <code>加载</code>匹配路由<ul>
<li>radixtree_sni<ul>
<li>使用 <code>SNI</code> - Server Name Indication 作为主索引</li>
<li>基于 radixtree 引擎</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h2><ol>
<li>Script 表示将在 <code>HTTP</code> 请求&#x2F;响应生命周期期间执行的<code>脚本</code></li>
<li>Script 配置需要<code>绑定</code>在 <code>Route</code> 上</li>
<li>Script 与 Plugin <code>不兼容</code>，并且 Script <code>优先执行</code><ul>
<li>这意味着配置 Script 后，Route 上配置的 <code>Plugin</code> 将<code>不被执行</code></li>
</ul>
</li>
<li>在 Script 中可以编写<code>任意 Lua 代码</code>，可以<code>直接调用已有的插件</code>以复用已有的代码</li>
<li>Script 支持 <code>access</code>、<code>header_filter</code>、<code>body_filter</code> 和 <code>log</code> 阶段<ul>
<li>系统会在相应阶段中自动执行 Script 脚本中对应阶段的代码</li>
</ul>
</li>
</ol>
<h2 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h2><ol>
<li>Service 是<code>某类 API 的抽象</code>，即<code>一组 Route 的抽象</code></li>
<li>Service 通常与<code>上游服务抽象</code>是<code>一一对应</code>的，但与 <code>Route</code> 之间，通常是 <code>1:N</code> 即一对多的关系</li>
<li>不同 Route 同时绑定到一个 Service 上，这些 Route 将具有<code>相同</code>的 <code>Upstream</code> 和 <code>Plugin</code> 配置，<code>减少冗余配置</code></li>
<li>当 Route 和 Service 都开启同一个插件时，Route 中的插件优先级高于 Service 中的插件</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404205639606.png" alt="image-20240404205639606"></p>
<blockquote>
<p>创建 Service</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/services/200 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Route 并绑定 Service</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/100 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/101 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/foo/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为 Route 指定不同的插件配置或者 Upstream</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/102 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bar/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;102&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Upstream-2"><a href="#Upstream-2" class="headerlink" title="Upstream"></a>Upstream</h2><ol>
<li>Upstream 是对<code>虚拟主机</code>抽象，即应用层服务或节点的抽象</li>
<li>可以通过 Upstream 对象对<code>多个服务节点</code>按照配置规则进行<code>负载均衡</code></li>
<li>当多个Route（或 Service）使用该 Upstream 时，可以单独创建 Upstream 对象<ul>
<li>在 Route 中通过使用 <code>upstream_id</code> 的方式<code>引用</code>资源，减轻维护压力</li>
</ul>
</li>
<li>可以将 Upstream 的信息直接配置在指定 Route 或 Service 中，不过 Route 中的配置优先级更高</li>
<li>Upstream 对象除了基本的<code>负载均衡算法</code>外，还支持对上游做<code>主被动健康检查</code>、<code>重试</code>等逻辑</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404210505234.png" alt="image-20240404210505234"></p>
<blockquote>
<p>创建 Upstream - chash</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/upstreams/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chash&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;127.0.0.1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Route 中引用 Upstream</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将 Upstream 信息直接配置在 Route 或者 Service 中</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置健康检查</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;retries&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;checks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;active&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;http_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/status&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;healthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;successes&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;unhealthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;http_failures&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Consumer</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/consumers \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-jack&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Route，启用 key-auth 插件，<code>hash_on: consumer</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chash&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hash_on&quot;</span><span class="punctuation">:</span> <span class="string">&quot;consumer&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/server_port&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>认证通过后的 <code>consumer_name</code> 作为<code>负载均衡</code>哈希算法的<code>哈希值</code></p>
</blockquote>
<blockquote>
<p><code>hash_on: cookie.sid</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hash_on_cookie&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sid&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chash&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hash_on&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cookie&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9080/hash_on_cookie \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line">-H <span class="string">&quot;Cookie: sid=3c183a30cffcda1408daf1c61d47b274&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>hash_on: header.content-type</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hash_on_header&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;content-type&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chash&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hash_on&quot;</span><span class="punctuation">:</span> <span class="string">&quot;header&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hash_on_header \</span></span><br><span class="line"> -H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line"> -H <span class="string">&quot;Content-Type: application/json&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h2><ol>
<li>Secret 指 APISIX 运行过程中所需的任何<code>敏感</code>信息，可能是核心配置的一部分，也可能是插件中的一些敏感信息</li>
<li>常见 Secret<ul>
<li>一些组件（etcd、Redis、Kafka 等）的用户名、密码</li>
<li>证书的私钥</li>
<li>API 密钥</li>
<li>敏感的插件配置字段，通常用于身份验证、hash、签名或加密</li>
</ul>
</li>
<li>APISIX Secret 允许用户在 APISIX 中通过一些<code>密钥管理服务</code>（Vault 等）来存储密钥<ul>
<li>在使用的时候根据 <code>key</code> 进行读取，确保密钥在整个平台中<code>不以明文</code>的形式存在</li>
</ul>
</li>
<li>支持方式<ul>
<li>环境变量</li>
<li>HashiCorp Vault</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404212429149.png" alt="image-20240404212429149"></p>
<h1 id="Plugin-2"><a href="#Plugin-2" class="headerlink" title="Plugin"></a>Plugin</h1><h2 id="General"><a href="#General" class="headerlink" title="General"></a>General</h2><h3 id="batch-requests"><a href="#batch-requests" class="headerlink" title="batch-requests"></a>batch-requests</h3><ol>
<li>过程<ul>
<li>用户可以通过将多个请求组装成一个请求的形式，把请求发送给网关</li>
<li>网关会从请求体中解析出对应的请求，再分别封装成独立的请求</li>
<li>以 <code>HTTP pipeline</code> 的方式代替用户向<code>网关自身</code>再发起多个 HTTP 请求</li>
<li>经历路由匹配，转发到对应上游等多个阶段，合并结果后再返回客户端</li>
</ul>
</li>
<li>在客户端需要访问多个 API 的情况下，这将<code>显著提高性能</code></li>
<li>用户<code>原始请求</code>中的<code>请求头</code>（除了以 <code>Content-</code> 开始的请求头，例如：<code>Content-Type</code>）将被赋给 <code>HTTP pipeline</code> 中的<code>每个请求</code></li>
<li>对于网关来说，这些以 HTTP pipeline 方式发送给自身的请求与用户直接发起的外部请求没有什么不同<ul>
<li>只能访问已经配置好的路由，并将经历<code>完整的鉴权过程</code>，因此<code>不存在安全问题</code></li>
</ul>
</li>
<li>如果原始请求的请求头与插件中配置的请求头冲突，则以<code>插件</code>中配置的请求头优先</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240404213447723.png" alt="image-20240404213447723"></p>
<h3 id="redirect"><a href="#redirect" class="headerlink" title="redirect"></a>redirect</h3><ol>
<li>配置 URI 重定向</li>
</ol>
<blockquote>
<p>启用插件 - 可以在新的 URI 中使用 Nginx 内置的任意变量</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;redirect&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/default.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ret_code&quot;</span><span class="punctuation">:</span> <span class="number">301</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9080/test/index.html -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">301</span> Moved Permanently</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">13</span><span class="punctuation">:</span><span class="number">49</span><span class="punctuation">:</span><span class="number">18</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">241</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Location<span class="punctuation">:</span> /test/default.html</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">301</span> Moved Permanently&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">301</span> Moved Permanently&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Powered by &lt;a href=<span class="string">&quot;https://apisix.apache.org/&quot;</span>&gt;APISIX&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将 HTTP 重定向到 HTTPS</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;redirect&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;http_to_https&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9080/hello -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">301</span> Moved Permanently</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">13</span><span class="punctuation">:</span><span class="number">50</span><span class="punctuation">:</span><span class="number">58</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">241</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Location<span class="punctuation">:</span> https<span class="punctuation">:</span><span class="comment">//apisix/hello</span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">301</span> Moved Permanently&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">301</span> Moved Permanently&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Powered by &lt;a href=<span class="string">&quot;https://apisix.apache.org/&quot;</span>&gt;APISIX&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>删除插件 - 删除对应的 JSON 配置即可，APISIX 支持配置热更新</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9080/hello -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> Not Found</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">13</span><span class="punctuation">:</span><span class="number">52</span><span class="punctuation">:</span><span class="number">49</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;error_msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;404 Route Not Found&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><ol>
<li>帮助用户尽可能地全面了解如何<code>开发 APISIX 插件</code></li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;echo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;before_body&quot;</span><span class="punctuation">:</span> <span class="string">&quot;before the body modification &quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//apisix:9080/hello</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">502</span> Bad Gateway</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">13</span><span class="punctuation">:</span><span class="number">57</span><span class="punctuation">:</span><span class="number">08</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line">X-APISIX-Upstream-Status<span class="punctuation">:</span> <span class="number">502</span></span><br><span class="line"></span><br><span class="line">before the body modification &lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">502</span> Bad Gateway&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">502</span> Bad Gateway&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Powered by &lt;a href=<span class="string">&quot;https://apisix.apache.org/&quot;</span>&gt;APISIX&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="gzip"><a href="#gzip" class="headerlink" title="gzip"></a>gzip</h3><blockquote>
<p>要求 Apache APISIX 运行在 <code>APISIX-Runtime</code> 上</p>
</blockquote>
<ol>
<li>gzip 插件能<code>动态设置</code> NGINX 的压缩行为</li>
<li>当启用 gzip 插件时，<code>客户端</code>在发起请求时需要在请求头中添加 <code>Accept-Encoding: gzip</code>，以表明客户端支持 gzip 压缩</li>
<li>APISIX 在接收到请求后，会根据客户端的支持情况和服务器配置<code>动态判断</code>是否对响应内容进行 gzip 压缩<ul>
<li>如果判定条件得到满足，APISIX 将在响应头中添加 <code>Content-Encoding: gzip</code> 字段，以指示响应内容已经通过 gzip 压缩</li>
</ul>
</li>
<li>在客户端接收到响应后，根据响应头中的 Content-Encoding 字段使用相应的<code>解压缩算法</code>对响应内容进行解压，从而获取原始的响应内容</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gzip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;buffers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9080/index.html -i -H &quot;Accept-Encoding: gzip&quot;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> NOT FOUND</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">04</span><span class="punctuation">:</span><span class="number">55</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line">Content-Encoding<span class="punctuation">:</span> gzip</span><br><span class="line"></span><br><span class="line">Warning<span class="punctuation">:</span> Binary output can mess up your terminal. Use <span class="string">&quot;--output -&quot;</span> to tell</span><br><span class="line">Warning<span class="punctuation">:</span> curl to output it to your terminal anyway<span class="punctuation">,</span> or consider <span class="string">&quot;--output</span></span><br><span class="line"><span class="string">Warning: &lt;FILE&gt;&quot;</span> to save to a file.</span><br></pre></td></tr></table></figure>

<h3 id="real-ip"><a href="#real-ip" class="headerlink" title="real-ip"></a>real-ip</h3><blockquote>
<p>该插件要求 APISIX 运行在 <code>APISIX-Runtime</code> 上</p>
</blockquote>
<ol>
<li>用于动态改变传递到 Apache APISIX 的<code>客户端</code>的 IP 地址和端口</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;real-ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arg_realip&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;trusted_addresses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;127.0.0.0/24&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;response-rewrite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;remote_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$remote_addr&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;remote_port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$remote_port&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#x27;http<span class="punctuation">:</span><span class="comment">//apisix:9080/index.html?realip=1.2.3.4:9080&#x27; -I</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> NOT FOUND</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">233</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">13</span><span class="punctuation">:</span><span class="number">41</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line">remote-port<span class="punctuation">:</span> <span class="number">9080</span></span><br><span class="line">remote-addr<span class="punctuation">:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<h3 id="server-info"><a href="#server-info" class="headerlink" title="server-info"></a>server-info</h3><ol>
<li>定期将服务基本信息上报至 <code>etcd</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://apisix:9090/v1/server_info -s | jq .</span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;58c96e4d-5322-49fe-ad2c-64d1437b6dff&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;3.8.0&quot;,</span><br><span class="line">  &quot;boot_time&quot;: 1712217096,</span><br><span class="line">  &quot;etcd_version&quot;: &quot;3.5.0&quot;,</span><br><span class="line">  &quot;hostname&quot;: &quot;apisix-5f99bbf5fc-ndqnv&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h2><h3 id="response-rewrite"><a href="#response-rewrite" class="headerlink" title="response-rewrite"></a>response-rewrite</h3><ol>
<li>支持修改上游服务或 APISIX 返回的 Body 和 Header 信息</li>
<li>适用场景<ul>
<li>通过设置 <code>Access-Control-Allow-*</code> 字段实现 <code>CORS</code>（跨域资源共享）的功能</li>
<li>通过设置标头中的 <code>status_code</code> 和 <code>Location</code> 字段实现<code>重定向</code>，如果仅需要重定向功能，建议使用 <code>redirect</code> 插件</li>
</ul>
</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/2 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;response-rewrite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;code\&quot;:\&quot;ok\&quot;,\&quot;message\&quot;:\&quot;new json body\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;set&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;X-Server-id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;X-Server-status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;on&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;X-Server-balancer-addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$balancer_ip:$balancer_port&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org:443&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X GET -i http<span class="punctuation">:</span><span class="comment">//apisix:9080/test/index.html</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> NOT FOUND</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">47</span><span class="punctuation">:</span><span class="number">18</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line">X-Server-balancer-addr<span class="punctuation">:</span> <span class="number">54.147</span><span class="number">.29</span><span class="number">.229</span><span class="punctuation">:</span><span class="number">80</span></span><br><span class="line">X-Server-id<span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">X-Server-status<span class="punctuation">:</span> on</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="string">&quot;ok&quot;</span><span class="punctuation">,</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;new json body&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>filters, X-Amzn-Trace-Id -&gt; X-Amzn-Trace-Id-Replace</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;response-rewrite&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;set&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;X-Server-id&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;X-Server-status&quot;</span><span class="punctuation">:</span><span class="string">&quot;on&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;X-Server-balancer-addr&quot;</span><span class="punctuation">:</span><span class="string">&quot;$balancer_ip:$balancer_port&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span><span class="string">&quot;X-Amzn-Trace-Id&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span><span class="string">&quot;global&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;replace&quot;</span><span class="punctuation">:</span><span class="string">&quot;X-Amzn-Trace-Id-Replace&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;status&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;==&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="number">200</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;httpbin.org:443&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span><span class="string">&quot;/*&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X GET -i http<span class="punctuation">:</span><span class="comment">//apisix:9080/get</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">15</span><span class="punctuation">:</span><span class="number">00</span><span class="punctuation">:</span><span class="number">15</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line">X-Server-status<span class="punctuation">:</span> on</span><br><span class="line">X-Server-balancer-addr<span class="punctuation">:</span> <span class="number">52.201</span><span class="number">.199</span><span class="number">.27</span><span class="punctuation">:</span><span class="number">443</span></span><br><span class="line">X-Server-id<span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/8.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Amzn-Trace-Id-Replace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Root=1-660ec07f-3409b99612877cb55813e41a&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Forwarded-Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1, 129.227.149.219&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://apisix/get&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="proxy-rewrite"><a href="#proxy-rewrite" class="headerlink" title="proxy-rewrite"></a>proxy-rewrite</h3><ol>
<li>处理 <code>Upstream</code> 代理信息重写的插件，支持对 <code>scheme</code>、<code>uri</code>、<code>host</code> 等信息进行重写</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1  \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;proxy-rewrite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/test/home.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iresty.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;set&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;X-Api-Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;X-Api-Engine&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;X-Api-useless&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;add&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;X-Request-ID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;112233&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;remove&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;X-test&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org:443&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X GET http://apisix:9080/test/index.html</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 3.2 Final//EN&quot;&gt;</span><br><span class="line">&lt;title&gt;404 Not Found&lt;/title&gt;</span><br><span class="line">&lt;h1&gt;Not Found&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The requested URL was not found on the server.  If you entered the URL manually please check your spelling and try again.&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>APISIX access.log</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 - - [04/Apr/2024:15:10:26 +0000] apisix:9080 &quot;GET /test/index.html HTTP/1.1&quot; 404 233 1.000 &quot;-&quot; &quot;curl/8.4.0&quot; 184.73.70.187:443 404 0.987 &quot;https://iresty.com/test/home.html&quot;</span><br></pre></td></tr></table></figure>

<h3 id="grpc-transcode"><a href="#grpc-transcode" class="headerlink" title="grpc-transcode"></a>grpc-transcode</h3><ol>
<li>可以在 HTTP 和 gRPC 请求之间进行转换</li>
<li>APISIX 接收 HTTP 请求后，首先对请求进行转码，并将转码后的请求转发到 gRPC 服务，获取响应并以 HTTP 格式将其返回给客户端</li>
</ol>
<h3 id="fault-injection"><a href="#fault-injection" class="headerlink" title="fault-injection"></a>fault-injection</h3><ol>
<li>可以和其他插件一起使用，并在其他插件执行前被执行</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;fault-injection&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;abort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;http_status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fault Injection!&quot;</span></span><br><span class="line">           <span class="punctuation">&#125;</span></span><br><span class="line">       <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9080/hello -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">15</span><span class="punctuation">:</span><span class="number">19</span><span class="punctuation">:</span><span class="number">13</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">Fault Injection!</span><br></pre></td></tr></table></figure>

<blockquote>
<p>指定 delay 属性</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;fault-injection&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;delay&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">           <span class="punctuation">&#125;</span></span><br><span class="line">       <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;httpbin.org:443&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>指定 vars 规则</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fault-injection&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;abort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;http_status&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fault Injection!\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">[</span></span><br><span class="line">                      <span class="punctuation">[</span> <span class="string">&quot;arg_name&quot;</span><span class="punctuation">,</span><span class="string">&quot;==&quot;</span><span class="punctuation">,</span><span class="string">&quot;jack&quot;</span> <span class="punctuation">]</span></span><br><span class="line">                  <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;httpbin.org:443&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span><span class="string">&quot;/*&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X GET -i  http<span class="punctuation">:</span><span class="comment">//apisix:9080/get\?name=allen</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">326</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">15</span><span class="punctuation">:</span><span class="number">29</span><span class="punctuation">:</span><span class="number">41</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;allen&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/8.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Amzn-Trace-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Root=1-660ec764-1086ce3d2e15026224dda734&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Forwarded-Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apisix&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1, 129.227.149.219&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://apisix/get?name=allen&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X GET -i  <span class="string">&quot;http://apisix:9080/get?name=jack&quot;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Thu<span class="punctuation">,</span> <span class="number">04</span> Apr <span class="number">2024</span> <span class="number">15</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">:</span><span class="number">03</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.8</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">Fault Injection!</span><br></pre></td></tr></table></figure>

<h3 id="mocking"><a href="#mocking" class="headerlink" title="mocking"></a>mocking</h3><ol>
<li>将随机返回指定格式的模拟数据，并且请求<code>不会转发</code>到上游</li>
</ol>
<h2 id="Authentication-1"><a href="#Authentication-1" class="headerlink" title="Authentication"></a>Authentication</h2><h3 id="key-auth"><a href="#key-auth" class="headerlink" title="key-auth"></a>key-auth</h3><ol>
<li>用于向 <code>Route</code> 或 <code>Service</code> 添加身份验证密钥（API key）</li>
<li>需要与 <code>Consumer</code> 一起配合才能工作，通过 Consumer 将其密钥添加到 <code>Query</code> 或 <code>Header</code> 中以验证其请求</li>
<li>不同的 Consumer 应有不同的 key，它应当是<code>唯一</code>的</li>
</ol>
<blockquote>
<p>创建 Consumer</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-one&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Route</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;apikey: auth-one&#x27; -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">05</span><span class="punctuation">:</span><span class="number">48</span><span class="punctuation">:</span><span class="number">53</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">05</span><span class="punctuation">:</span><span class="number">49</span><span class="punctuation">:</span><span class="number">14</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Missing API key found in request&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;apikey: xxxx&#x27; -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">05</span><span class="punctuation">:</span><span class="number">49</span><span class="punctuation">:</span><span class="number">39</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Invalid API key in request&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="basic-auth"><a href="#basic-auth" class="headerlink" title="basic-auth"></a>basic-auth</h3><ol>
<li>可以将 Basic_access_authentication 添加到 <code>Route</code> 或 <code>Service</code> 中</li>
<li>需要与 <code>Consumer</code> 一起使用，API 的消费者可以将它们的密钥添加到 <code>Header</code> 中以验证其请求</li>
<li>Consumer 的 username 是唯一的</li>
</ol>
<blockquote>
<p>创建 Consumer</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bar&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Route</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i -ufoo<span class="punctuation">:</span>bar http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">05</span><span class="punctuation">:</span><span class="number">59</span><span class="punctuation">:</span><span class="number">53</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">00</span><span class="punctuation">:</span><span class="number">13</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">WWW-Authenticate<span class="punctuation">:</span> Basic realm=&#x27;.&#x27;</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Missing authorization in request&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i -uaaa<span class="punctuation">:</span>bbb http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">00</span><span class="punctuation">:</span><span class="number">35</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Invalid user authorization&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="openid-connect"><a href="#openid-connect" class="headerlink" title="openid-connect"></a>openid-connect</h3><ol>
<li>OpenID Connect（<code>OIDC</code>）是基于 <code>OAuth 2.0</code> 的<code>身份认证</code>协议</li>
<li>APISIX 可以与支持该协议的身份认证服务对接，实现对客户端请求的身份认证</li>
</ol>
<h3 id="ldap-auth"><a href="#ldap-auth" class="headerlink" title="ldap-auth"></a>ldap-auth</h3><ol>
<li>可用于给 Route 或 Service 添加 LDAP 身份认证</li>
<li>需要与 Consumer 一起配合使用，API 的调用方可以使用 <code>basic authentication</code> 与 LDAP 服务器进行认证</li>
</ol>
<h3 id="opa"><a href="#opa" class="headerlink" title="opa"></a>opa</h3><ol>
<li>可用于与 Open Policy Agent 进行集成</li>
<li>实现后端服务的认证授权与访问服务等功能<code>解耦</code>，减少系统复杂性</li>
</ol>
<blockquote>
<p>APISIX 向 OPA 发送信息</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\/get&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;user-agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl\/7.68.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*\/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:9080&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">9080</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;var&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1701234567</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9080&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;remote_port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;port&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;remote_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ip address&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;route&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;service&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;consumer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>OPA 向 APISIX 返回数据 - allow 必不可少，表示请求是否允许通过 APISIX 进行转发</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;allow&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;an&quot;</span><span class="punctuation">:</span> <span class="string">&quot;header&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status_code&quot;</span><span class="punctuation">:</span> <span class="number">401</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动 OPA</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name opa -p <span class="number">8181</span><span class="punctuation">:</span><span class="number">8181</span> openpolicyagent/opa<span class="punctuation">:</span><span class="number">0.64</span><span class="number">.0</span>-dev-static-debug run -s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建基本策略</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X PUT &#x27;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">8181</span>/v1/policies/example1&#x27; \</span><br><span class="line">    -H &#x27;Content-Type<span class="punctuation">:</span> text/plain&#x27; \</span><br><span class="line">    -d &#x27;package example1</span><br><span class="line"></span><br><span class="line">import input.request</span><br><span class="line"></span><br><span class="line">default allow = <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"></span><br><span class="line">allow <span class="punctuation">&#123;</span></span><br><span class="line">    # HTTP method must GET</span><br><span class="line">    request.method == <span class="string">&quot;GET&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Route 上配置 OPA</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X PUT &#x27;http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/r1&#x27; \</span></span><br><span class="line">    -H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line">    -H &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; \</span><br><span class="line">    -d &#x27;<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;opa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:8181&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>自定义响应</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X PUT &#x27;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">8181</span>/v1/policies/example2&#x27; \</span><br><span class="line">    -H &#x27;Content-Type<span class="punctuation">:</span> text/plain&#x27; \</span><br><span class="line">    -d &#x27;package example2</span><br><span class="line"></span><br><span class="line">import input.request</span><br><span class="line"></span><br><span class="line">default allow = <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"></span><br><span class="line">allow <span class="punctuation">&#123;</span></span><br><span class="line">    request.method == <span class="string">&quot;GET&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># custom response body (Accepts a string or an object<span class="punctuation">,</span> the object will respond as JSON format)</span><br><span class="line">reason = <span class="string">&quot;test&quot;</span> <span class="punctuation">&#123;</span></span><br><span class="line">    not allow</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># custom response header (The data of the object can be written in this way)</span><br><span class="line">headers = <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://example.com/auth&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="punctuation">&#123;</span></span><br><span class="line">    not allow</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># custom response status code</span><br><span class="line">status_code = <span class="number">302</span> <span class="punctuation">&#123;</span></span><br><span class="line">    not allow</span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>向 OPA 发送 API 更详细的数据（Route、Consumer 等）</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X PUT &#x27;http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/r1&#x27; \</span></span><br><span class="line">    -H &#x27;X-API-KEY<span class="punctuation">:</span> &lt;api-key&gt;&#x27; \</span><br><span class="line">    -H &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; \</span><br><span class="line">    -d &#x27;<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;opa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:8181&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;with_route&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="forward-auth"><a href="#forward-auth" class="headerlink" title="forward-auth"></a>forward-auth</h3><ol>
<li>外部认证，当身份认证失败时，可以实现自定义错误或者重定向到认证页面的场景</li>
<li>将身份认证和授权逻辑移到了一个专门的外部服务中<ul>
<li>APISIX 将用户的请求转发给认证服务并<code>阻塞</code>原始请求，然后在认证服务下以<code>非 2xx</code> 状态响应时进行<code>结果替换</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>外部认证服务</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X PUT &#x27;http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/auth&#x27; \</span></span><br><span class="line">    -H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line">    -H &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; \</span><br><span class="line">    -d &#x27;<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;serverless-pre-function&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rewrite&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;functions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;return function (conf, ctx)</span></span><br><span class="line"><span class="string">                    local core = require(\&quot;apisix.core\&quot;);</span></span><br><span class="line"><span class="string">                    local authorization = core.request.header(ctx, \&quot;Authorization\&quot;);</span></span><br><span class="line"><span class="string">                    if authorization == \&quot;123\&quot; then</span></span><br><span class="line"><span class="string">                        core.response.exit(200);</span></span><br><span class="line"><span class="string">                    elseif authorization == \&quot;321\&quot; then</span></span><br><span class="line"><span class="string">                        core.response.set_header(\&quot;X-User-ID\&quot;, \&quot;i-am-user\&quot;);</span></span><br><span class="line"><span class="string">                        core.response.exit(200);</span></span><br><span class="line"><span class="string">                    else core.response.set_header(\&quot;Location\&quot;, \&quot;http://example.com/auth\&quot;);</span></span><br><span class="line"><span class="string">                        core.response.exit(403);</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                end&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Route 上启用 forward-auth 插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X PUT &#x27;http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1&#x27; \</span></span><br><span class="line">    -H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; \</span><br><span class="line">    -d &#x27;<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/headers&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;forward-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:9080/auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request_headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Authorization&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upstream_headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;X-User-ID&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;client_headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Location&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/headers -H &#x27;Authorization: 123&#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/7.81.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Amzn-Trace-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Root=1-660f9ce4-2087989e0669fb271564f5ff&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Forwarded-Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/headers -H &#x27;Authorization: 321&#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;321&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/7.81.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Amzn-Trace-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Root=1-660f9d26-36939c8453329d0041579cb6&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Forwarded-Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-User-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;i-am-user&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/headers</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">42</span><span class="punctuation">:</span><span class="number">05</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Location<span class="punctuation">:</span> http<span class="punctuation">:</span><span class="comment">//example.com/auth</span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Powered by &lt;a href=<span class="string">&quot;https://apisix.apache.org/&quot;</span>&gt;APISIX&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="multi-auth"><a href="#multi-auth" class="headerlink" title="multi-auth"></a>multi-auth</h3><ol>
<li>用于向 Route 或者 Service 中，添加多种身份验证方式</li>
<li>通过<code>迭代</code> auth_plugins 属性指定的插件列表，提供了灵活的身份认证机制</li>
<li>允许多个 <code>Consumer</code> 在使用不同身份验证方式时共享相同的 Route - <code>认证链</code></li>
</ol>
<blockquote>
<p>创建多个使用不同身份认证插件的 Consumer</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bar1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-one&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Consumer</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;multi-auth&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;auth_plugins&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="string">&quot;apikey&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;hide_credentials&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;header&quot;</span><span class="punctuation">:</span><span class="string">&quot;apikey&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i -ufoo1<span class="punctuation">:</span>bar1 http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">48</span><span class="punctuation">:</span><span class="number">09</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello -H &#x27;apikey: auth-one&#x27; -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">WWW-Authenticate<span class="punctuation">:</span> Basic realm=&#x27;.&#x27;</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">48</span><span class="punctuation">:</span><span class="number">36</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">48</span><span class="punctuation">:</span><span class="number">53</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">WWW-Authenticate<span class="punctuation">:</span> Basic realm=&#x27;.&#x27;</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Authorization Failed&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h2><h3 id="cors"><a href="#cors" class="headerlink" title="cors"></a>cors</h3><ol>
<li>为服务端启用 CORS（Cross-Origin Resource Sharing，跨域资源共享）的返回头</li>
</ol>
<blockquote>
<p>在 Route 上启用 cors 插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//apisix:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello -v</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">9080</span> (#<span class="number">0</span>)</span><br><span class="line">&gt; GET /hello HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080</span></span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">7.81</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Mark bundle as not supporting multiuse</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment">&lt; Content-Type: text/plain; charset=utf-8</span></span><br><span class="line"><span class="comment">&lt; Content-Length: 10</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; Date: Fri, 05 Apr 2024 07:11:24 GMT</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.9.0</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Allow-Origin: *</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Allow-Methods: *</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Max-Age: 5</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Expose-Headers: *</span></span><br><span class="line"><span class="comment">&lt; Access-Control-Allow-Headers: *</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br><span class="line"><span class="comment">hello web1</span></span><br></pre></td></tr></table></figure>

<h3 id="uri-blocker"><a href="#uri-blocker" class="headerlink" title="uri-blocker"></a>uri-blocker</h3><ol>
<li>通过指定一系列 block_rules 来拦截用户请求</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;uri-blocker&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;block_rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;root.exe&quot;</span><span class="punctuation">,</span> <span class="string">&quot;root.m+&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/root.exe\?a\=a</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">21</span><span class="punctuation">:</span><span class="number">17</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">225</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Powered by &lt;a href=<span class="string">&quot;https://apisix.apache.org/&quot;</span>&gt;APISIX&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ip-restriction"><a href="#ip-restriction" class="headerlink" title="ip-restriction"></a>ip-restriction</h3><ol>
<li>通过将 IP 地址列入<code>白名单</code>或<code>黑名单</code>来限制对服务或路由的访问</li>
<li>支持对单个 IP 地址、多个 IP 地址和类似 10.10.10.0&#x2F;24 的 <code>CIDR</code>（无类别域间路由）范围的限制</li>
<li>whitelist 和 blacklist 属性<code>无法同时</code>在<code>同一个服务或路由</code>上使用，只能使用其中之一</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ip-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;whitelist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;113.74.26.106/24&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">24</span><span class="punctuation">:</span><span class="number">24</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Your IP address is not allowed&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="ua-restriction"><a href="#ua-restriction" class="headerlink" title="ua-restriction"></a>ua-restriction</h3><ol>
<li>通过将指定 <code>User-Agent</code> 列入<code>白名单</code>或<code>黑名单</code>的方式来限制对服务或路由的访问</li>
<li>常见的场景是用来设置<code>爬虫</code>规则</li>
<li>allowlist 和 denylist 不可以同时启用</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ua-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bypass_missing&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;denylist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                 <span class="string">&quot;my-bot2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 <span class="string">&quot;(Twitterspider)/(\\d+)\\.(\\d+)&quot;</span></span><br><span class="line">             <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Do you want to do something bad?&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">29</span><span class="punctuation">:</span><span class="number">46</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html --header &#x27;User-Agent: Twitterspider/2.0&#x27;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">:</span><span class="number">24</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Do you want to do something bad?&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="referer-restriction"><a href="#referer-restriction" class="headerlink" title="referer-restriction"></a>referer-restriction</h3><ol>
<li>允许将 <code>Referer</code> 请求头中的<code>域名</code>列入<code>白名单</code>或<code>黑名单</code>来限制该域名对服务或路由的访问</li>
<li>whitelist 和 blacklist 属性无法同时在同一个服务或路由上使用，只能使用其中之一</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;referer-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bypass_missing&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;whitelist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;xx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;*.xx.com&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">9080</span> (#<span class="number">0</span>)</span><br><span class="line">&gt; GET /index.html HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080</span></span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">7.81</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Mark bundle as not supporting multiuse</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment">&lt; Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="comment">&lt; Content-Length: 10</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; Date: Fri, 05 Apr 2024 07:33:45 GMT</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.9.0</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br><span class="line"><span class="comment">hello web1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;Referer: http://xx.com/x&#x27;</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">9080</span> (#<span class="number">0</span>)</span><br><span class="line">&gt; GET /index.html HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080</span></span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">7.81</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt; Referer: http://xx.com/x</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Mark bundle as not supporting multiuse</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment">&lt; Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="comment">&lt; Content-Length: 10</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; Date: Fri, 05 Apr 2024 07:34:15 GMT</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.9.0</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br><span class="line"><span class="comment">hello web1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;Referer: http://yy.com/x&#x27;</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">9080</span> (#<span class="number">0</span>)</span><br><span class="line">&gt; GET /index.html HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080</span></span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">7.81</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt; Referer: http://yy.com/x</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Mark bundle as not supporting multiuse</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 403 Forbidden</span></span><br><span class="line"><span class="comment">&lt; Date: Fri, 05 Apr 2024 07:34:47 GMT</span></span><br><span class="line"><span class="comment">&lt; Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="comment">&lt; Transfer-Encoding: chunked</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.9.0</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">&#123;&quot;message&quot;:&quot;Your referer host is not allowed&quot;&#125;</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br></pre></td></tr></table></figure>

<h3 id="consumer-restriction"><a href="#consumer-restriction" class="headerlink" title="consumer-restriction"></a>consumer-restriction</h3><ol>
<li>允许根据 Route、Service 或 Consumer 来设置相应的访问限制</li>
</ol>
<h4 id="consumer-name"><a href="#consumer-name" class="headerlink" title="consumer_name"></a>consumer_name</h4><blockquote>
<p>创建 Consumer</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;jack2019&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;jack2020&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;consumer-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;whitelist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;jack1&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -u jack2019<span class="punctuation">:</span><span class="number">123456</span> http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">40</span><span class="punctuation">:</span><span class="number">49</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -u jack2020<span class="punctuation">:</span><span class="number">123456</span> http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">41</span><span class="punctuation">:</span><span class="number">07</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;The consumer_name is forbidden.&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">41</span><span class="punctuation">:</span><span class="number">29</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">WWW-Authenticate<span class="punctuation">:</span> Basic realm=&#x27;.&#x27;</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;Missing authorization in request&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="allowed-by-methods"><a href="#allowed-by-methods" class="headerlink" title="allowed_by_methods"></a>allowed_by_methods</h4><blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;basic-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;consumer-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;allowed_by_methods&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;POST&quot;</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v -u jack2019<span class="punctuation">:</span><span class="number">123456</span> http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">9080</span> (#<span class="number">0</span>)</span><br><span class="line">* Server auth using Basic with user &#x27;jack2019&#x27;</span><br><span class="line">&gt; GET /index.html HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080</span></span><br><span class="line">&gt; Authorization<span class="punctuation">:</span> Basic amFjazIwMTk6MTIzNDU2</span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">7.81</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Mark bundle as not supporting multiuse</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 403 Forbidden</span></span><br><span class="line"><span class="comment">&lt; Date: Fri, 05 Apr 2024 07:43:07 GMT</span></span><br><span class="line"><span class="comment">&lt; Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="comment">&lt; Transfer-Encoding: chunked</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.9.0</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">&#123;&quot;message&quot;:&quot;The consumer_name is forbidden.&quot;&#125;</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v -X POST -u jack2019<span class="punctuation">:</span><span class="number">123456</span> http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html</span></span><br><span class="line">*   Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080.</span>..</span><br><span class="line">* Connected to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) port <span class="number">9080</span> (#<span class="number">0</span>)</span><br><span class="line">* Server auth using Basic with user &#x27;jack2019&#x27;</span><br><span class="line">&gt; POST /index.html HTTP/<span class="number">1.1</span></span><br><span class="line">&gt; Host<span class="punctuation">:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9080</span></span><br><span class="line">&gt; Authorization<span class="punctuation">:</span> Basic amFjazIwMTk6MTIzNDU2</span><br><span class="line">&gt; User-Agent<span class="punctuation">:</span> curl/<span class="number">7.81</span><span class="number">.0</span></span><br><span class="line">&gt; Accept<span class="punctuation">:</span> *<span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;</span></span><br><span class="line"><span class="comment">* Mark bundle as not supporting multiuse</span></span><br><span class="line"><span class="comment">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment">&lt; Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="comment">&lt; Content-Length: 10</span></span><br><span class="line"><span class="comment">&lt; Connection: keep-alive</span></span><br><span class="line"><span class="comment">&lt; Date: Fri, 05 Apr 2024 07:43:39 GMT</span></span><br><span class="line"><span class="comment">&lt; Server: APISIX/3.9.0</span></span><br><span class="line"><span class="comment">&lt;</span></span><br><span class="line"><span class="comment">* Connection #0 to host 127.0.0.1 left intact</span></span><br><span class="line"><span class="comment">hello web1</span></span><br></pre></td></tr></table></figure>

<h4 id="service-id"><a href="#service-id" class="headerlink" title="service_id"></a>service_id</h4><blockquote>
<p>需要与 auth 插件一起使用</p>
</blockquote>
<blockquote>
<p>创建 Service</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/services/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;new service 001&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/services/2 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;new service 002&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Consumer，配置 key-auth + consumer-restriction，限制 Consumer 对 Service 的访问</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;new_consumer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-jack&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;consumer-restriction&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;service_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;whitelist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">403</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Route 上启用 key-auth，并绑定 Service</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$  curl  http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;apikey: auth-jack&#x27; -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">50</span><span class="punctuation">:</span><span class="number">42</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Route 绑定到另一个 Service</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;/apisix/routes/1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;update_time&quot;</span><span class="punctuation">:</span><span class="number">1712303480</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;header&quot;</span><span class="punctuation">:</span><span class="string">&quot;apikey&quot;</span><span class="punctuation">,</span><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="string">&quot;apikey&quot;</span><span class="punctuation">,</span><span class="attr">&quot;hide_credentials&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;create_time&quot;</span><span class="punctuation">:</span><span class="number">1712295917</span><span class="punctuation">,</span><span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span><span class="string">&quot;/index.html&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>识别出 Consumer，但该 Consumer 只能访问 Service 1，而该路由绑定的是 Service 2，因此 Consumer 无法访问</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;apikey: auth-jack&#x27; -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">07</span><span class="punctuation">:</span><span class="number">51</span><span class="punctuation">:</span><span class="number">58</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;The service_id is forbidden.&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="csrf"><a href="#csrf" class="headerlink" title="csrf"></a>csrf</h3><ol>
<li>基于 <code>Double Submit Cookie</code> 的方式，保护用户的 API 免于 CSRF 攻击</li>
<li><code>GET</code>、<code>HEAD</code> 和 <code>OPTIONS</code> 会被定义为 <code>safe-methods</code>（不会被检查拦截），其他的请求方法则定义为 unsafe-methods<ul>
<li>每一个请求都会返回一个新的 Cookie</li>
<li>在后续对该路由进行的 <code>unsafe-methods</code> 请求中，需要从 Cookie 中读取加密的 Token，并在请求头中携带该 Token</li>
</ul>
</li>
</ol>
<blockquote>
<p>启用插件 - 使用 GET 请求 <code>/hello</code> 时，在响应中会有一个携带了<code>加密 Token</code> 的 Cookie</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;csrf&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;edd1c9f034335f136f87ad84b625c8f1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello -X POST</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">08</span><span class="punctuation">:</span><span class="number">16</span><span class="punctuation">:</span><span class="number">37</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line">Set-Cookie<span class="punctuation">:</span> apisix-csrf-token=eyJyYW5kb20iOjAuMDEyOTQxMjMwNzUwMzY5LCJzaWduIjoiMTE3ZWIwYTU4MzExNjNmMDRkMjQ4ODkxYzg5NmY4YmZkZjRjYTJhMmQ3YjhhYmI0Y2FkYmFhY2U3OTg4MmRmMSIsImV4cGlyZXMiOjE3MTIzMDQ5OTd9;path=/;SameSite=Lax;Expires=Fri<span class="punctuation">,</span> <span class="number">05</span>-Apr<span class="number">-24</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">16</span><span class="punctuation">:</span><span class="number">37</span> GMT</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;error_msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;no csrf token in headers&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">08</span><span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">11</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line">Set-Cookie<span class="punctuation">:</span> apisix-csrf-token=eyJyYW5kb20iOjAuMTI3MDI4Mzk5Nzg5ODYsInNpZ24iOiI2ZWExOWJmY2I3OGVlZjVkZjhjZDBkYmI2YjFjODlkMTIzM2Q4MTQzMjEyOWU3ODU4NTEzM2EzNWMyZmJkNWIxIiwiZXhwaXJlcyI6MTcxMjMwNTAzMX0=;path=/;SameSite=Lax;Expires=Fri<span class="punctuation">,</span> <span class="number">05</span>-Apr<span class="number">-24</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">11</span> GMT</span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在请求之前，用户需要从 Cookie 中读取 Token，并在后续的 <code>unsafe-methods</code> 请求的<code>请求头</code>中携带</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello -X POST -H &#x27;apisix-csrf-token: eyJyYW5kb20iOjAuMTI3MDI4Mzk5Nzg5ODYsInNpZ24iOiI2ZWExOWJmY2I3OGVlZjVkZjhjZDBkYmI2YjFjODlkMTIzM2Q4MTQzMjEyOWU3ODU4NTEzM2EzNWMyZmJkNWIxIiwiZXhwaXJlcyI6MTcxMjMwNTAzMX0=&#x27; -b &#x27;apisix-csrf-token=eyJyYW5kb20iOjAuMTI3MDI4Mzk5Nzg5ODYsInNpZ24iOiI2ZWExOWJmY2I3OGVlZjVkZjhjZDBkYmI2YjFjODlkMTIzM2Q4MTQzMjEyOWU3ODU4NTEzM2EzNWMyZmJkNWIxIiwiZXhwaXJlcyI6MTcxMjMwNTAzMX0=&#x27;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">08</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">:</span><span class="number">14</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line">Set-Cookie<span class="punctuation">:</span> apisix-csrf-token=eyJzaWduIjoiZWM1NTU3YjIyNjU0ODE2YmIyNDlkNjE1YTU5NGEyYWE2MzJkNWQwMGU2NDhkMWQwZTViMzYxNTllNTNiMzkyNSIsInJhbmRvbSI6MC4xNzIzOTA1MjM4Njk0MiwiZXhwaXJlcyI6MTcxMjMwNTMzNH0=;path=/;SameSite=Lax;Expires=Fri<span class="punctuation">,</span> <span class="number">05</span>-Apr<span class="number">-24</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">:</span><span class="number">14</span> GMT</span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<h2 id="Traffic"><a href="#Traffic" class="headerlink" title="Traffic"></a>Traffic</h2><h3 id="limit-req"><a href="#limit-req" class="headerlink" title="limit-req"></a>limit-req</h3><ol>
<li>使用<code>漏桶算法</code>限制<code>单个客户端</code>对服务的请求速率</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<ol>
<li>APISIX 将<code>客户端的 IP 地址</code>作为限制请求速率的条件</li>
<li>当请求速率小于 3 次每秒（rate）时，请求正常</li>
<li>当请求速率大于 3 次每秒（rate），小于 5 次每秒（rate + burst）时，将会对超出部分的请求进行<code>延迟处理</code></li>
<li>当请求速率大于 5 次每秒（rate + burst）时，超出规定数量的请求将返回 HTTP 状态码 <code>503</code></li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-req&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rate&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;burst&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;var&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 var_combination</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-req&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rate&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;burst&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;var_combination&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$consumer_name $remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Consumer 上启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/consumers \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;consumer_jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-jack&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limit-req&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rate&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;burst&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;consumer_name&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key-auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth-jack&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="limit-conn"><a href="#limit-conn" class="headerlink" title="limit-conn"></a>limit-conn</h3><ol>
<li>限制客户端对<code>单个服务</code>的并发请求数</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;methods&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-conn&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;conn&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;burst&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;default_conn_delay&quot;</span><span class="punctuation">:</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;var&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="limit-count"><a href="#limit-count" class="headerlink" title="limit-count"></a>limit-count</h3><ol>
<li>使用<code>固定时间窗口算法</code>，主要用于限制<code>单个客户端</code>在指定的时间范围内对服务的总请求数，并且会在 HTTP 响应头中返回<code>剩余</code>可以请求的个数</li>
<li><code>同一个 group</code> 里面的 limit-count 的配置必须<code>保持一致</code>。如果修改配置，需要同时更新对应的 group 的值</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;var&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以在多个 Route 之间<code>共享</code>同一个限流计数器</p>
</blockquote>
<blockquote>
<p>创建 Service</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/services/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;services_1#1640140620&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建多个 Route，并引用同一个 Service，将共享同一个限流计数器</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/2 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;service_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将 key_type 设置为 <code>constant</code>，也可以在<code>所有请求</code>间共享同一个限流计数器</p>
</blockquote>
<blockquote>
<p>当多个 Route 中的 limit-count.group &#x3D; services_1#1640140621 时，访问这些 Route 的请求将共享同一个限流计数器</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/services/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit-count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remote_addr&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;constant&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;services_1#1640140621&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">11</span><span class="punctuation">:</span><span class="number">08</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http://127.0.0.1:9080/index.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 10</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 0</span><br><span class="line">X-RateLimit-Reset: 55</span><br><span class="line">Date: Fri, 05 Apr 2024 09:11:13 GMT</span><br><span class="line">Server: APISIX/3.9.0</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http://127.0.0.1:9080/index.html</span><br><span class="line">HTTP/1.1 503 Service Temporarily Unavailable</span><br><span class="line">Date: Fri, 05 Apr 2024 09:11:14 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 269</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-RateLimit-Limit: 2</span><br><span class="line">X-RateLimit-Remaining: 0</span><br><span class="line">X-RateLimit-Reset: 50</span><br><span class="line">Server: APISIX/3.9.0</span><br></pre></td></tr></table></figure>

<h3 id="proxy-cache"><a href="#proxy-cache" class="headerlink" title="proxy-cache"></a>proxy-cache</h3><ol>
<li>提供<code>缓存后端响应数据</code>的能力</li>
<li>支持基于<code>磁盘</code>和<code>内存</code>的缓存</li>
<li>可以根据<code>响应码</code>和<code>请求模式</code>来指定需要缓存的数据，也可以通过 <code>no_cache</code> 和 <code>cache_bypass</code> 属性配置更复杂的缓存策略</li>
<li>对于基于<code>磁盘</code>的缓存，不能<code>动态配置</code>缓存的<code>过期</code>时间<ul>
<li>只能通过后端服务响应头 <code>Expires</code> 或 <code>Cache-Control</code> 来设置过期时间</li>
<li>当后端响应头中没有 Expires 或 Cache-Control 时，默认缓存时间为 <code>10 秒钟</code></li>
</ul>
</li>
<li>当<code>上游服务不可用</code>时，APISIX 将返回 <code>502</code> 或 <code>504</code> HTTP 状态码，默认缓存时间为 <code>10 秒钟</code></li>
</ol>
<h4 id="disk"><a href="#disk" class="headerlink" title="disk"></a>disk</h4><blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ip&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;proxy-cache&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;cache_key&quot;</span><span class="punctuation">:</span>  <span class="punctuation">[</span><span class="string">&quot;$uri&quot;</span><span class="punctuation">,</span> <span class="string">&quot;-cache-id&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cache_bypass&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;$arg_bypass&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cache_method&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cache_http_status&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">200</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hide_cache_headers&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;no_cache&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;$arg_test&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="memory"><a href="#memory" class="headerlink" title="memory"></a>memory</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ip&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;proxy-cache&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;cache_strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;memory&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cache_zone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;memory_cache&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cache_ttl&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;httpbin.org&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<blockquote>
<p>首次未命中</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/ip -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">46</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Apisix-Cache-Status<span class="punctuation">:</span> MISS</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">23</span><span class="punctuation">:</span><span class="number">01</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.18.0.1, 129.227.149.219&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>过期</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/ip -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">46</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Apisix-Cache-Status<span class="punctuation">:</span> EXPIRED</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">23</span><span class="punctuation">:</span><span class="number">24</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.18.0.1, 129.227.149.219&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>命中</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/ip -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">23</span><span class="punctuation">:</span><span class="number">48</span> GMT</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Age<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">Apisix-Cache-Status<span class="punctuation">:</span> HIT</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.18.0.1, 129.227.149.219&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>清除缓存数据 - <code>PURGE</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/ip -X PURGE</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">25</span><span class="punctuation">:</span><span class="number">24</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/ip -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">46</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Apisix-Cache-Status<span class="punctuation">:</span> MISS</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">25</span><span class="punctuation">:</span><span class="number">29</span> GMT</span><br><span class="line">Access-Control-Allow-Origin<span class="punctuation">:</span> *</span><br><span class="line">Access-Control-Allow-Credentials<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.18.0.1, 129.227.149.219&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="request-validation"><a href="#request-validation" class="headerlink" title="request-validation"></a>request-validation</h3><ol>
<li><code>提前验证</code>向上游服务转发的请求</li>
<li>使用 <code>JSON Schema</code> 机制进行数据验证，可以验证请求的 <code>body</code> 及 <code>header</code> 数据</li>
<li>至少需要配置 header_schema 和 body_schema 属性中的任意一个，两者也可以同时使用</li>
</ol>
<blockquote>
<p>Enum</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;enum_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;enum_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;enum_string_1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;enum_string_2&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enum_string_1&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Boolean</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;bool_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bool_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>数字范围</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;integer_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;integer_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;minimum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;maximum&quot;</span><span class="punctuation">:</span> <span class="number">65535</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>String</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;string_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;string_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;minLength&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;maxLength&quot;</span><span class="punctuation">:</span> <span class="number">32</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Regex</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;regex_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;regex_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;minLength&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;maxLength&quot;</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[[^[a-zA-Z0-9_]+$]]&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Array</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;array_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;array_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;minItems&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;minimum&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maximum&quot;</span><span class="punctuation">:</span> <span class="number">599</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;uniqueItems&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">200</span><span class="punctuation">,</span> <span class="number">302</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Combined</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;boolean_payload&quot;</span><span class="punctuation">,</span> <span class="string">&quot;array_payload&quot;</span><span class="punctuation">,</span> <span class="string">&quot;regex_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;boolean_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;array_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;minItems&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;minimum&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maximum&quot;</span><span class="punctuation">:</span> <span class="number">599</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;uniqueItems&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">200</span><span class="punctuation">,</span> <span class="number">302</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;regex_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;minLength&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;maxLength&quot;</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[[^[a-zA-Z0-9_]+$]]&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/get&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;request-validation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;body_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;required_payload&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;required_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;boolean_payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rejected_msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customize reject message&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i --header <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  --request POST \</span><br><span class="line">  --data &#x27;<span class="punctuation">&#123;</span><span class="attr">&quot;boolean-payload&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;required_payload&quot;</span><span class="punctuation">:</span><span class="string">&quot;hello&quot;</span><span class="punctuation">&#125;</span>&#x27; \</span><br><span class="line">  http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/get</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">33</span><span class="punctuation">:</span><span class="number">26</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<h3 id="proxy-mirror"><a href="#proxy-mirror" class="headerlink" title="proxy-mirror"></a>proxy-mirror</h3><ol>
<li>提供了镜像客户端请求的能力</li>
<li>将线上真实流量拷贝到镜像服务中，以便在不影响线上服务的情况下，对线上流量或请求内容进行具体的分析</li>
<li>镜像请求返回的响应会被<code>忽略</code></li>
<li><code>镜像请求</code>是以<code>子请求</code>的方式实现，子请求的延迟将会导致原始请求<code>阻塞</code>，直到子请求完成，才可以恢复正常</li>
</ol>
<blockquote>
<p>启动镜像服务</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m http.server <span class="number">9797</span></span><br><span class="line">Serving HTTP on <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> port <span class="number">9797</span> (http://<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9797</span>/) ...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1  \</span></span><br><span class="line">  -H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;proxy-mirror&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:9797&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="api-breaker"><a href="#api-breaker" class="headerlink" title="api-breaker"></a>api-breaker</h3><ol>
<li>实现了 API 熔断功能</li>
<li>熔断超时 - 自动按<code>触发不健康状态</code>的次数递增运算<ul>
<li>当上游服务返回 <code>unhealthy.http_statuses</code> 配置中的状态码（默认为 500），并达到 <code>unhealthy.failures</code> 预设次数时（默认为 3 次），则认为上游服务处于不健康状态</li>
<li><code>指数退让</code><ul>
<li>第一次触发不健康状态时，熔断 2 秒</li>
<li>超过熔断时间后，将重新开始转发请求到上游服务，如果继续返回 unhealthy.http_statuses 状态码，记数再次达到 unhealthy.failures 预设次数时，熔断 4 秒</li>
<li>依次类推（2，4，8，16，……），直到达到预设的 max_breaker_sec 值</li>
</ul>
</li>
<li>当上游服务处于不健康状态时，如果转发请求到上游服务并返回 <code>healthy.http_statuses</code> 配置中的状态码（默认为 <code>200</code>），并达到 <code>healthy.successes</code> 次时，则认为上游服务恢复至健康状态</li>
</ul>
</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://127.0.0.1:9180/apisix/admin/routes/1&quot;</span> \</span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;api-breaker&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;break_response_code&quot;</span><span class="punctuation">:</span> <span class="number">502</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;unhealthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;http_statuses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">500</span><span class="punctuation">,</span> <span class="number">503</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;failures&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;healthy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;http_statuses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">200</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;successes&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="traffic-split"><a href="#traffic-split" class="headerlink" title="traffic-split"></a>traffic-split</h3><ol>
<li>通过配置 <code>match</code> 和 <code>weighted_upstreams</code> 属性，从而<code>动态</code>地将部分流量引导至各种上游服务</li>
<li>可应用于<code>灰度发布</code>和<code>蓝绿发布</code>的场景</li>
<li><code>match</code> 属性是用于引导流量的<code>自定义规则</code>，而 <code>weighted_upstreams</code> 属性则用于引导流量的<code>上游服务</code><ul>
<li>当一个请求被 match 属性匹配时，它将根据配置的 weights 属性被引导至上游服务</li>
<li>也可以不使用 match 属性，只根据 weighted_upstreams 属性来引导所有流量</li>
</ul>
</li>
<li>使用了<code>加权循环算法</code>（特别是在<code>重置</code> wrr 状态时），因此在使用该插件时，可能会存在上游服务之间的<code>流量比例不精准</code>现象</li>
<li>在 match 属性中，变量中的表达式以 <code>AND</code> 方式关联，多个变量以 <code>OR</code> 方式关联</li>
<li>如果仅配置了 weight 属性，那么它将会使用该 Route 或 Service 中的上游服务的权重。</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;traffic-split&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;upstream_A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span><span class="number">10</span></span><br><span class="line">                                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;connect&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">&quot;send&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">&quot;read&quot;</span><span class="punctuation">:</span> <span class="number">15</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 upstream_id 来引用 - weighted_upstreams 属性支持同时使用 <code>upstream</code> 和 <code>upstream_id</code> 两种配置方式</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;traffic-split&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h4><blockquote>
<p>60% 的流量 -&gt; 1981 端口，40% 的流量 -&gt; 1980 端口</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;traffic-split&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;upstream_A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span><span class="number">10</span></span><br><span class="line">                                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;connect&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">&quot;send&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">&quot;read&quot;</span><span class="punctuation">:</span> <span class="number">15</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="蓝绿发布"><a href="#蓝绿发布" class="headerlink" title="蓝绿发布"></a>蓝绿发布</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;traffic-split&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_release&quot;</span><span class="punctuation">,</span><span class="string">&quot;==&quot;</span><span class="punctuation">,</span><span class="string">&quot;new_release&quot;</span><span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">]</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;upstream_A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;web2:80&quot;</span><span class="punctuation">:</span><span class="number">10</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;release: new_release&#x27; -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">14</span><span class="punctuation">:</span><span class="number">32</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web2</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -H &#x27;release: old_release&#x27; -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">15</span><span class="punctuation">:</span><span class="number">04</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<h4 id="自定义发布"><a href="#自定义发布" class="headerlink" title="自定义发布"></a>自定义发布</h4><blockquote>
<p>单个 vars 规则</p>
</blockquote>
<ol>
<li>在 match 规则校验<code>通过后</code>，将会有 60% 的请求被引导至插件 1981 端口的上游服务，40% 的请求被引导至路由 1980 端口的上游服务</li>
<li>如果 match 规则校验失败（如缺少请求头 apisix-key）, 那么请求将被引导至路由的 1980 端口的上游服务</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;traffic-split&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;arg_name&quot;</span><span class="punctuation">,</span><span class="string">&quot;==&quot;</span><span class="punctuation">,</span><span class="string">&quot;jack&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_user-id&quot;</span><span class="punctuation">,</span><span class="string">&quot;&gt;&quot;</span><span class="punctuation">,</span><span class="string">&quot;23&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_apisix-key&quot;</span><span class="punctuation">,</span><span class="string">&quot;~~&quot;</span><span class="punctuation">,</span><span class="string">&quot;[a-z]+&quot;</span><span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">]</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;upstream_A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span><span class="number">10</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>多个 vars 规则</p>
</blockquote>
<ol>
<li>如果两个 vars 表达式均匹配成功，match 规则校验通过后<ul>
<li>将会有 60% 的请求被引导至插件 1981 端口的上游服务，40% 的请求命中到路由的 1980 端口的上游服务</li>
</ul>
</li>
<li>如果第二个 vars 的表达式匹配失败（例如缺少 name2 请求参数），match 规则校验通过后，效果将会与上一种相同<ul>
<li>即有 60% 的请求被引导至插件 1981 端口的上游服务，40% 的请求命中到路由的 1980 端口的上游服务</li>
</ul>
</li>
<li>如果两个 vars 的表达式均匹配失败（如缺少 name 和 name2 请求参数），match 规则会校验失败，请求将被引导至路由的 1980 端口的上游服务</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;traffic-split&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;arg_name&quot;</span><span class="punctuation">,</span><span class="string">&quot;==&quot;</span><span class="punctuation">,</span><span class="string">&quot;jack&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_user-id&quot;</span><span class="punctuation">,</span><span class="string">&quot;&gt;&quot;</span><span class="punctuation">,</span><span class="string">&quot;23&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_apisix-key&quot;</span><span class="punctuation">,</span><span class="string">&quot;~~&quot;</span><span class="punctuation">,</span><span class="string">&quot;[a-z]+&quot;</span><span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">]</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;arg_name2&quot;</span><span class="punctuation">,</span><span class="string">&quot;==&quot;</span><span class="punctuation">,</span><span class="string">&quot;rose&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_user-id2&quot;</span><span class="punctuation">,</span><span class="string">&quot;!&quot;</span><span class="punctuation">,</span><span class="string">&quot;&gt;&quot;</span><span class="punctuation">,</span><span class="string">&quot;33&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_apisix-key2&quot;</span><span class="punctuation">,</span><span class="string">&quot;~~&quot;</span><span class="punctuation">,</span><span class="string">&quot;[a-z]+&quot;</span><span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">]</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;upstream_A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span><span class="number">10</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="匹配规则与上游对应"><a href="#匹配规则与上游对应" class="headerlink" title="匹配规则与上游对应"></a>匹配规则与上游对应</h4><blockquote>
<p>配置多个 rules 属性，实现不同的匹配规则与上游一一对应</p>
</blockquote>
<ol>
<li>当请求头 x-api-id 为 1 时，请求会被引导至 1981 端口的上游服务</li>
<li>当 x-api-id 为 2 时，请求会被引导至 1982 端口的上游服务</li>
<li>否则请求会被引导至 1980 端口的上游服务</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;traffic-split&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_x-api-id&quot;</span><span class="punctuation">,</span><span class="string">&quot;==&quot;</span><span class="punctuation">,</span><span class="string">&quot;1&quot;</span><span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">]</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;upstream-A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;127.0.0.1:1981&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;vars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                <span class="punctuation">[</span><span class="string">&quot;http_x-api-id&quot;</span><span class="punctuation">,</span><span class="string">&quot;==&quot;</span><span class="punctuation">,</span><span class="string">&quot;2&quot;</span><span class="punctuation">]</span></span><br><span class="line">                            <span class="punctuation">]</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weighted_upstreams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;upstream-B&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;127.0.0.1:1982&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="request-id"><a href="#request-id" class="headerlink" title="request-id"></a>request-id</h3><ol>
<li>为每一个请求代理添加 unique ID 用于<code>追踪</code> API 请求</li>
<li>如果请求已经配置了 <code>header_name</code> 属性的请求头，该插件将不会为请求添加 unique ID - 不会覆盖</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;request-id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;include_in_response&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">28</span><span class="punctuation">:</span><span class="number">37</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line">X-Request-Id<span class="punctuation">:</span> <span class="number">838</span>b088d<span class="number">-65</span>ab<span class="number">-4895</span>-a03e<span class="number">-11656</span>f671333</span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<h3 id="proxy-control"><a href="#proxy-control" class="headerlink" title="proxy-control"></a>proxy-control</h3><ol>
<li>动态地控制 NGINX 代理的相关行为</li>
<li>需要 APISIX 在 <code>APISIX-Runtime</code> 环境上运行</li>
</ol>
<h3 id="client-control"><a href="#client-control" class="headerlink" title="client-control"></a>client-control</h3><ol>
<li>通过设置<code>客户端请求体大小的上限</code>来动态地控制 NGINX 处理客户端的请求</li>
<li>需要 APISIX 在 <code>APISIX-Runtime</code> 环境上运行</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">  -H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;client-control&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_body_size&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:1980&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/index.html -d &#x27;123&#x27;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">413</span> Request Entity Too Large</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">32</span><span class="punctuation">:</span><span class="number">58</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">255</span></span><br><span class="line">Connection<span class="punctuation">:</span> close</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">413</span> Request Entity Too Large&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">413</span> Request Entity Too Large&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Powered by &lt;a href=<span class="string">&quot;https://apisix.apache.org/&quot;</span>&gt;APISIX&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><ol>
<li>引入 lua-resty-expr 来提供复杂的<code>流量控制</code>功能</li>
<li>actions 中只支持<code>一个元素</code></li>
<li>在 rules 中，按照 rules 的数组下标顺序<code>依次匹配</code> case，如果 case 匹配成功，则直接执行对应的 actions</li>
</ol>
<blockquote>
<p>启用插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 \</span></span><br><span class="line">-H &#x27;X-API-KEY<span class="punctuation">:</span> edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span><span class="string">&quot;/hello/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;workflow&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;case&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">[</span><span class="string">&quot;uri&quot;</span><span class="punctuation">,</span> <span class="string">&quot;==&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/hello/rejected&quot;</span><span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">[</span></span><br><span class="line">                            <span class="string">&quot;return&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">403</span><span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;case&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">[</span><span class="string">&quot;uri&quot;</span><span class="punctuation">,</span> <span class="string">&quot;==&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/hello/v2/appid&quot;</span><span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">[</span></span><br><span class="line">                            <span class="string">&quot;limit-count&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;time_window&quot;</span><span class="punctuation">:</span><span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;rejected_code&quot;</span><span class="punctuation">:</span><span class="number">429</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;web1:80&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试插件</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello/rejected -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">403</span> Forbidden</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">37</span><span class="punctuation">:</span><span class="number">49</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;error_msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;rejected by workflow&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello/v2/appid -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">60</span></span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">38</span><span class="punctuation">:</span><span class="number">12</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br><span class="line"></span><br><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello/v2/appid -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">59</span></span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">38</span><span class="punctuation">:</span><span class="number">18</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br><span class="line"></span><br><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello/v2/appid -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">429</span> Too Many Requests</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">38</span><span class="punctuation">:</span><span class="number">19</span> GMT</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/html; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">241</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">X-RateLimit-Limit<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">X-RateLimit-Remaining<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">X-RateLimit-Reset<span class="punctuation">:</span> <span class="number">53</span></span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">429</span> Too Many Requests&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">429</span> Too Many Requests&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Powered by &lt;a href=<span class="string">&quot;https://apisix.apache.org/&quot;</span>&gt;APISIX&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9080/hello/fake -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type<span class="punctuation">:</span> text/plain; charset=utf<span class="number">-8</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">Connection<span class="punctuation">:</span> keep-alive</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">05</span> Apr <span class="number">2024</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">39</span><span class="punctuation">:</span><span class="number">40</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> APISIX/<span class="number">3.9</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">hello web1</span><br></pre></td></tr></table></figure>

<h1 id="Development"><a href="#Development" class="headerlink" title="Development"></a>Development</h1><h2 id="external-plugin"><a href="#external-plugin" class="headerlink" title="external-plugin"></a>external-plugin</h2><ol>
<li>APISIX 支持使用 <code>Lua</code> 语言编写插件，这种类型的插件在 APISIX <code>内部</code>执行</li>
<li>APISIX 支持以 <code>Sidecar</code> 的方式加载和运行<code>其它语言</code>开发的插件 - <code>External Plugin</code><ul>
<li>Sidecar 为 <code>Plugin Runner</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>工作原理</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240405215316718.png" alt="image-20240405215316718"></p>
<ol>
<li>在 APISIX 中配置了一个 Plugin Runner，APISIX 将以<code>子进程</code>的方式运行该 Plugin Runner</li>
<li>该子进程与 APISIX 进程从属<code>相同用户</code><ul>
<li>当重启或者重新加载 APISIX 时，该 Plugin Runner 也将被<code>重启</code></li>
</ul>
</li>
<li>一旦为指定 Route 配置了 <code>ext-plugin-*</code> 插件<ul>
<li>匹配该 Route 的请求将触发从 <code>APISIX</code> 到 <code>Plugin Runner</code> 的 <code>RPC</code> 调用</li>
<li><code>Plugin Runner</code> 将处理该 RPC 调用，在其侧创建一个<code>请求</code>，运行 <code>External Plugin</code> 并将结果返回给 APISIX</li>
</ul>
</li>
<li>External Plugin 及其<code>执行顺序</code>在这里 <code>ext-plugin-*</code> 配置<ul>
<li>External Plugin 可以<code>动态启用</code>和<code>重新配置</code></li>
</ul>
</li>
<li>默认情况下，Nginx 将<code>隐藏</code>所有环境变量，APISIX 不会将环境变量传递给 Plugin Runner</li>
<li>先发送 <code>SIGTERM</code> 给 Plugin Runner，1 秒后，如果 Plugin Runner 仍然在运行，发送 <code>SIGKILL</code></li>
</ol>
<h1 id="Discovery"><a href="#Discovery" class="headerlink" title="Discovery"></a>Discovery</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240405224159631.png" alt="image-20240405224159631"></p>
<ol>
<li><p>微服务 + 注册中心</p>
<ul>
<li><p>服务启动时将自身的一些信息，比如服务名、IP、端口等信息上报到注册中心</p>
</li>
<li><p>各个服务与注册中心使用一定机制（例如心跳）通信，如果注册中心与服务长时间无法通信，就会注销该实例</p>
</li>
<li><p>当服务下线时，会删除注册中心的实例信息</p>
</li>
</ul>
</li>
<li><p>网关会<code>准实时</code>地从注册中心获取服务实例信息</p>
<ul>
<li>当用户通过网关请求服务时，网关从注册中心获取的实例列表中选择一个进行代理</li>
</ul>
</li>
</ol>
<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;applications&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;application&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USER-SERVICE&quot;</span><span class="punctuation">,</span>                 # 服务名称</span><br><span class="line">              <span class="attr">&quot;instance&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.1.100:8761&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;hostName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.1.100&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USER-SERVICE&quot;</span><span class="punctuation">,</span>          # 服务名称</span><br><span class="line">                      <span class="attr">&quot;ipAddr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.1.100&quot;</span><span class="punctuation">,</span>      # 实例 IP 地址</span><br><span class="line">                      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span>                 # 状态</span><br><span class="line">                      <span class="attr">&quot;overriddenStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">,</span>  # 覆盖状态</span><br><span class="line">                      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                          <span class="attr">&quot;$&quot;</span><span class="punctuation">:</span> <span class="number">8761</span><span class="punctuation">,</span>                  # 端口</span><br><span class="line">                          <span class="attr">&quot;@enabled&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span>          # 开始端口</span><br><span class="line">                      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;securePort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                          <span class="attr">&quot;$&quot;</span><span class="punctuation">:</span> <span class="number">443</span><span class="punctuation">,</span></span><br><span class="line">                          <span class="attr">&quot;@enabled&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">                      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                          <span class="attr">&quot;management.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8761&quot;</span><span class="punctuation">,</span></span><br><span class="line">                          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">100</span>               # 权重，需要通过 spring boot 应用的 eureka.instance.metadata-map.weight 进行配置</span><br><span class="line">                      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;homePageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.1.100:8761/&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;statusPageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.1.100:8761/actuator/info&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;healthCheckUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.1.100:8761/actuator/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      ... ...</span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>首先要选择状态为“UP”的实例：overriddenStatus 值不为 “UNKNOWN” 以 overriddenStatus 为准，否则以 status 的值为准</li>
<li>IP 地址：以 ipAddr 的值为 IP; 并且必须是 IPv4 或 IPv6 格式的</li>
<li>端口<ul>
<li>如果 port[“@enabled”] 等于 “true” 那么使用 port[“$“] 的值</li>
<li>如果 securePort[“@enabled”] 等于 “true” 那么使用 securePort[“$”] 的值</li>
</ul>
</li>
<li>权重<ul>
<li>先判断 <code>metadata.weight</code> 是否有值，如果没有，则取配置中的 <code>eureka.weight</code> 的值，如果还没有，则取默认值<code>100</code></li>
</ul>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">discovery:</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="comment"># it&#x27;s possible to define multiple eureka hosts addresses of the same eureka cluster.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;http://$&#123;username&#125;:$&#123;password&#125;@$&#123;eureka_host1&#125;:$&#123;eureka_port1&#125;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;http://$&#123;username&#125;:$&#123;password&#125;@$&#123;eureka_host2&#125;:$&#123;eureka_port2&#125;&quot;</span></span><br><span class="line">    <span class="attr">prefix:</span> <span class="string">&quot;/eureka/&quot;</span></span><br><span class="line">    <span class="attr">fetch_interval:</span> <span class="number">30</span> <span class="comment"># 从 eureka 中拉取数据的时间间隔，默认 30 秒</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">100</span> <span class="comment"># default weight for node</span></span><br><span class="line">    <span class="attr">timeout:</span></span><br><span class="line">      <span class="attr">connect:</span> <span class="number">2000</span> <span class="comment"># 连接 eureka 的超时时间，默认 2000ms</span></span><br><span class="line">      <span class="attr">send:</span> <span class="number">2000</span> <span class="comment"># 向 eureka 发送数据的超时时间，默认 2000ms</span></span><br><span class="line">      <span class="attr">read:</span> <span class="number">5000</span> <span class="comment"># 从 eureka 读数据的超时时间，默认 5000ms</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Upstream - L7 - （通过 <code>upstream.discovery_type</code> 选择使用的服务发现，<code>upstream.service_name</code> 与注册中心的服务名进行关联）</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/user/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;service_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USER-SERVICE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;discovery_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eureka&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;proxy-rewrite&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;regex_uri&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^/a/(.*)&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/$&#123;1&#125;&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;service_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A-SERVICE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;discovery_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eureka&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/routes/2 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -i -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/b/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;proxy-rewrite&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;regex_uri&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^/b/(.*)&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/$&#123;1&#125;&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;service_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B-SERVICE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;discovery_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eureka&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置 <code>upstream.service_name</code> 后<code>upstream.nodes</code> 将<code>不再生效</code>，而是使用从注册中心的数据来<code>替换</code>，即使注册中心的数据是<code>空</code>的</p>
</blockquote>
<h2 id="Control-Plane"><a href="#Control-Plane" class="headerlink" title="Control Plane"></a>Control Plane</h2><blockquote>
<p>目前已经支持了 ZooKeeper 和 Nacos</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240405230724373.png" alt="image-20240405230724373"></p>
<ol>
<li>通过 Admin API 向 APISIX 注册上游并指定服务发现类型<ul>
<li>APISIX-Seed 将监听 etcd 中的 APISIX 资源变化，过滤服务发现类型并获取服务名称（如 ZooKeeper）</li>
</ul>
</li>
<li>APISIX-Seed 将在服务注册中心（如 ZooKeeper）订阅指定的服务名称，以监控和更新对应的服务信息</li>
<li>客户端向服务注册中心注册服务后，APISIX-Seed 会获取新的服务信息，并将更新后的服务节点写入 etcd</li>
<li>当 APISIX-Seed 在 etcd 中更新相应的服务节点信息时，APISIX 会将最新的服务节点信息同步到内存中</li>
</ol>
<blockquote>
<p>优势</p>
</blockquote>
<ol>
<li>网络拓扑变得更简单<ul>
<li>APISIX 不需要与每个注册中心保持网络连接，只需要关注 etcd 中的配置信息即可</li>
</ul>
</li>
<li>上游服务总数据量变小<ul>
<li>由于 <code>registry</code> 的特性，APISIX 可能会在 Worker 中存储全量的 <code>registry</code> 服务数据</li>
<li>过引入 APISIX-Seed，APISIX 的每个进程将不需要额外缓存上游服务相关信息</li>
</ul>
</li>
<li>更容易管理<ul>
<li>服务发现配置需要为每个 APISIX 实例配置一次</li>
<li>通过引入 APISIX-Seed，APISIX 将对服务注册中心的配置变化无感知</li>
</ul>
</li>
</ol>
<h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><ol>
<li>以 <code>List-Watch</code> 方式监听 Kubernetes 集群 <code>Endpoints</code> 资源的实时变化，并将其值存储到 <code>ngx.shared.DICT</code> 中</li>
<li>支持<code>单集群</code>和<code>多集群</code>模式，分别适用于待发现的服务分布在单个或多个 Kubernetes 的场景</li>
</ol>
<h1 id="PubSub"><a href="#PubSub" class="headerlink" title="PubSub"></a>PubSub</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240405231930066.png" alt="image-20240405231930066"></p>
<h1 id="RadixTree"><a href="#RadixTree" class="headerlink" title="RadixTree"></a>RadixTree</h1><ol>
<li>匹配优先级：<code>完全匹配 -&gt; 深度前缀匹配</code></li>
<li>不同的路由具有<code>相同 uri</code><ul>
<li>通过设置路由的 <code>priority</code> 字段来决定先匹配哪条路由，或者添加其他匹配规则来区分不同的路由</li>
<li>在匹配规则中， <code>priority</code> 字段<code>优先</code>于除 <code>uri</code> 之外的其他规则<ul>
<li>值越大，优先级越高</li>
</ul>
</li>
</ul>
</li>
<li><code>radixtree_uri_with_parameter</code> - 可以用参数匹配路由<ul>
<li>&#x2F;blog&#x2F;:name -&gt; 匹配 &#x2F;blog&#x2F;dog 和 &#x2F;blog&#x2F;cat</li>
</ul>
</li>
</ol>
<h1 id="Stream-Proxy"><a href="#Stream-Proxy" class="headerlink" title="Stream Proxy"></a>Stream Proxy</h1><ol>
<li>APISIX 可以对 <code>TCP/UDP</code> 协议进行代理并实现动态负载均衡</li>
<li>在 nginx 世界，称 TCP&#x2F;UDP 代理为 Stream Proxy</li>
</ol>
<blockquote>
<p>每当 APISIX 服务器 <code>127.0.0.10</code> 和端口 <code>9101</code> 收到连接时，它只会将请求转发到 mysql 上游</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9180/apisix/admin/stream_routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.10&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span> <span class="number">9101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;upstream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;127.0.0.1:3306&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;roundrobin&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h1><ol>
<li>支持通过 TLS 扩展 <code>SNI</code> 实现加载<code>特定的 SSL 证书</code>以实现对 https 的支持</li>
<li>SNI<ul>
<li>允许客户端在服务器端向其发送证书之前向服务器端<code>发送请求的域名</code>，服务器端根据客户端请求的域名<code>选择合适的 SSL 证书</code>发送给客户端</li>
</ul>
</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2023/02/11/cloud-native-gateway-apisix/">https://blog.zhongmingmao.top/2023/02/11/cloud-native-gateway-apisix/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/api-gateway/">API Gateway</a><a class="post-meta__tags" href="/tags/apisix/">APISIX</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/12/cloud-native-serverless-faas-runtime/" title="FaaS - Runtime"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/faas-runtime.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">FaaS - Runtime</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/10/cloud-native-serverless-faas-scaling/" title="FaaS - Scaling"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240318203921511.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">FaaS - Scaling</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/10/14/cloud-native-observability-opentelemetry/" title="Observability - OpenTelemetry"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/cloud-native-observability-opentelemetry.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-14</div><div class="title">Observability - OpenTelemetry</div></div></a></div><div><a href="/2024/10/13/cloud-native-observability-concept/" title="Observability - Concept"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/cloud-native-observability-concept.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-13</div><div class="title">Observability - Concept</div></div></a></div><div><a href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-11</div><div class="title">Kubernetes - Helm Doc</div></div></a></div><div><a href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="title">Go Engineering - CLI</div></div></a></div><div><a href="/2023/05/09/cloud-native-foundation-go-engineering-log/" title="Go Engineering - Log"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-log.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="title">Go Engineering - Log</div></div></a></div><div><a href="/2023/05/08/cloud-native-foundation-go-engineering-err-code/" title="Go Engineering - Error Code"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-error-handling.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="title">Go Engineering - Error Code</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">615</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">187</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">79</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Feature"><span class="toc-number">1.</span> <span class="toc-text">Feature</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Quick-Start"><span class="toc-number">2.</span> <span class="toc-text">Quick Start</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">2.1.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Route"><span class="toc-number">2.1.1.</span> <span class="toc-text">Route</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Upstream"><span class="toc-number">2.1.2.</span> <span class="toc-text">Upstream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples"><span class="toc-number">2.1.3.</span> <span class="toc-text">Examples</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.2.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">Examples</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E9%AA%8C%E8%AF%81"><span class="toc-number">2.3.</span> <span class="toc-text">密钥验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer"><span class="toc-number">2.3.1.</span> <span class="toc-text">Consumer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">2.3.2.</span> <span class="toc-text">设计思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples-2"><span class="toc-number">2.3.3.</span> <span class="toc-text">Examples</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E9%80%9F"><span class="toc-number">2.4.</span> <span class="toc-text">限速</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples-3"><span class="toc-number">2.4.1.</span> <span class="toc-text">Examples</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Installation"><span class="toc-number">3.</span> <span class="toc-text">Installation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Architecture"><span class="toc-number">4.</span> <span class="toc-text">Architecture</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">插件加载流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84"><span class="toc-number">4.2.</span> <span class="toc-text">插件内部结构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#API"><span class="toc-number">5.</span> <span class="toc-text">API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">5.1.</span> <span class="toc-text">概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Upstream-1"><span class="toc-number">5.1.1.</span> <span class="toc-text">Upstream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Route-1"><span class="toc-number">5.1.2.</span> <span class="toc-text">Route</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">5.1.3.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Plugin"><span class="toc-number">5.1.4.</span> <span class="toc-text">Plugin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83"><span class="toc-number">5.2.</span> <span class="toc-text">发布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4"><span class="toc-number">5.3.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7"><span class="toc-number">5.4.</span> <span class="toc-text">监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Logging"><span class="toc-number">5.4.1.</span> <span class="toc-text">Logging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metrics"><span class="toc-number">5.4.2.</span> <span class="toc-text">Metrics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tracing"><span class="toc-number">5.4.3.</span> <span class="toc-text">Tracing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">5.5.</span> <span class="toc-text">健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">5.5.1.</span> <span class="toc-text">主动健康检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A2%AB%E5%8A%A8%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">5.5.2.</span> <span class="toc-text">被动健康检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples-4"><span class="toc-number">5.5.3.</span> <span class="toc-text">Examples</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E4%BF%A1%E6%81%AF"><span class="toc-number">5.5.4.</span> <span class="toc-text">健康检查信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#status"><span class="toc-number">5.5.4.1.</span> <span class="toc-text">status</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#counter"><span class="toc-number">5.5.4.2.</span> <span class="toc-text">counter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Examples-5"><span class="toc-number">5.5.4.3.</span> <span class="toc-text">Examples</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E8%BD%AC%E5%8C%96%E5%9B%BE"><span class="toc-number">5.5.5.</span> <span class="toc-text">状态转化图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus"><span class="toc-number">5.5.6.</span> <span class="toc-text">Prometheus</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer-1"><span class="toc-number">5.6.</span> <span class="toc-text">Consumer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API-Consumers"><span class="toc-number">5.6.1.</span> <span class="toc-text">API Consumers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-APISIX-Consumers"><span class="toc-number">5.6.2.</span> <span class="toc-text">Apache APISIX Consumers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cache"><span class="toc-number">5.7.</span> <span class="toc-text">Cache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Versioning"><span class="toc-number">5.8.</span> <span class="toc-text">Versioning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket"><span class="toc-number">5.9.</span> <span class="toc-text">WebSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Protocol"><span class="toc-number">5.9.1.</span> <span class="toc-text">Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication"><span class="toc-number">5.9.2.</span> <span class="toc-text">Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples-6"><span class="toc-number">5.9.3.</span> <span class="toc-text">Examples</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Terminology"><span class="toc-number">6.</span> <span class="toc-text">Terminology</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#API-Gateway"><span class="toc-number">6.1.</span> <span class="toc-text">API Gateway</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer-2"><span class="toc-number">6.2.</span> <span class="toc-text">Consumer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%86%E5%88%AB%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">6.2.1.</span> <span class="toc-text">识别消费者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples-7"><span class="toc-number">6.2.2.</span> <span class="toc-text">Examples</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer-Groups"><span class="toc-number">6.3.</span> <span class="toc-text">Consumer Groups</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Global-Rules"><span class="toc-number">6.4.</span> <span class="toc-text">Global Rules</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugin-1"><span class="toc-number">6.5.</span> <span class="toc-text">Plugin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugin-Config"><span class="toc-number">6.6.</span> <span class="toc-text">Plugin Config</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugin-Metadata"><span class="toc-number">6.7.</span> <span class="toc-text">Plugin Metadata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Route-2"><span class="toc-number">6.8.</span> <span class="toc-text">Route</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Router"><span class="toc-number">6.9.</span> <span class="toc-text">Router</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Script"><span class="toc-number">6.10.</span> <span class="toc-text">Script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-1"><span class="toc-number">6.11.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Upstream-2"><span class="toc-number">6.12.</span> <span class="toc-text">Upstream</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Secret"><span class="toc-number">6.13.</span> <span class="toc-text">Secret</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Plugin-2"><span class="toc-number">7.</span> <span class="toc-text">Plugin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#General"><span class="toc-number">7.1.</span> <span class="toc-text">General</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#batch-requests"><span class="toc-number">7.1.1.</span> <span class="toc-text">batch-requests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redirect"><span class="toc-number">7.1.2.</span> <span class="toc-text">redirect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#echo"><span class="toc-number">7.1.3.</span> <span class="toc-text">echo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gzip"><span class="toc-number">7.1.4.</span> <span class="toc-text">gzip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#real-ip"><span class="toc-number">7.1.5.</span> <span class="toc-text">real-ip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-info"><span class="toc-number">7.1.6.</span> <span class="toc-text">server-info</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transformation"><span class="toc-number">7.2.</span> <span class="toc-text">Transformation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#response-rewrite"><span class="toc-number">7.2.1.</span> <span class="toc-text">response-rewrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-rewrite"><span class="toc-number">7.2.2.</span> <span class="toc-text">proxy-rewrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grpc-transcode"><span class="toc-number">7.2.3.</span> <span class="toc-text">grpc-transcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fault-injection"><span class="toc-number">7.2.4.</span> <span class="toc-text">fault-injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mocking"><span class="toc-number">7.2.5.</span> <span class="toc-text">mocking</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authentication-1"><span class="toc-number">7.3.</span> <span class="toc-text">Authentication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#key-auth"><span class="toc-number">7.3.1.</span> <span class="toc-text">key-auth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basic-auth"><span class="toc-number">7.3.2.</span> <span class="toc-text">basic-auth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openid-connect"><span class="toc-number">7.3.3.</span> <span class="toc-text">openid-connect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ldap-auth"><span class="toc-number">7.3.4.</span> <span class="toc-text">ldap-auth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#opa"><span class="toc-number">7.3.5.</span> <span class="toc-text">opa</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#forward-auth"><span class="toc-number">7.3.6.</span> <span class="toc-text">forward-auth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#multi-auth"><span class="toc-number">7.3.7.</span> <span class="toc-text">multi-auth</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Security"><span class="toc-number">7.4.</span> <span class="toc-text">Security</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cors"><span class="toc-number">7.4.1.</span> <span class="toc-text">cors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uri-blocker"><span class="toc-number">7.4.2.</span> <span class="toc-text">uri-blocker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip-restriction"><span class="toc-number">7.4.3.</span> <span class="toc-text">ip-restriction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ua-restriction"><span class="toc-number">7.4.4.</span> <span class="toc-text">ua-restriction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#referer-restriction"><span class="toc-number">7.4.5.</span> <span class="toc-text">referer-restriction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consumer-restriction"><span class="toc-number">7.4.6.</span> <span class="toc-text">consumer-restriction</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#consumer-name"><span class="toc-number">7.4.6.1.</span> <span class="toc-text">consumer_name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#allowed-by-methods"><span class="toc-number">7.4.6.2.</span> <span class="toc-text">allowed_by_methods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service-id"><span class="toc-number">7.4.6.3.</span> <span class="toc-text">service_id</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#csrf"><span class="toc-number">7.4.7.</span> <span class="toc-text">csrf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Traffic"><span class="toc-number">7.5.</span> <span class="toc-text">Traffic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-req"><span class="toc-number">7.5.1.</span> <span class="toc-text">limit-req</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-conn"><span class="toc-number">7.5.2.</span> <span class="toc-text">limit-conn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-count"><span class="toc-number">7.5.3.</span> <span class="toc-text">limit-count</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache"><span class="toc-number">7.5.4.</span> <span class="toc-text">proxy-cache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#disk"><span class="toc-number">7.5.4.1.</span> <span class="toc-text">disk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memory"><span class="toc-number">7.5.4.2.</span> <span class="toc-text">memory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#request-validation"><span class="toc-number">7.5.5.</span> <span class="toc-text">request-validation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-mirror"><span class="toc-number">7.5.6.</span> <span class="toc-text">proxy-mirror</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#api-breaker"><span class="toc-number">7.5.7.</span> <span class="toc-text">api-breaker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#traffic-split"><span class="toc-number">7.5.8.</span> <span class="toc-text">traffic-split</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83"><span class="toc-number">7.5.8.1.</span> <span class="toc-text">灰度发布</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83"><span class="toc-number">7.5.8.2.</span> <span class="toc-text">蓝绿发布</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%91%E5%B8%83"><span class="toc-number">7.5.8.3.</span> <span class="toc-text">自定义发布</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99%E4%B8%8E%E4%B8%8A%E6%B8%B8%E5%AF%B9%E5%BA%94"><span class="toc-number">7.5.8.4.</span> <span class="toc-text">匹配规则与上游对应</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#request-id"><span class="toc-number">7.5.9.</span> <span class="toc-text">request-id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-control"><span class="toc-number">7.5.10.</span> <span class="toc-text">proxy-control</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#client-control"><span class="toc-number">7.5.11.</span> <span class="toc-text">client-control</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#workflow"><span class="toc-number">7.5.12.</span> <span class="toc-text">workflow</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Development"><span class="toc-number">8.</span> <span class="toc-text">Development</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#external-plugin"><span class="toc-number">8.1.</span> <span class="toc-text">external-plugin</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Discovery"><span class="toc-number">9.</span> <span class="toc-text">Discovery</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka"><span class="toc-number">9.1.</span> <span class="toc-text">Eureka</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Control-Plane"><span class="toc-number">9.2.</span> <span class="toc-text">Control Plane</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes"><span class="toc-number">9.3.</span> <span class="toc-text">Kubernetes</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PubSub"><span class="toc-number">10.</span> <span class="toc-text">PubSub</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RadixTree"><span class="toc-number">11.</span> <span class="toc-text">RadixTree</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stream-Proxy"><span class="toc-number">12.</span> <span class="toc-text">Stream Proxy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Certificate"><span class="toc-number">13.</span> <span class="toc-text">Certificate</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/15/java-feature-switch/" title="Java Feature - Switch"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-feature-1253868755.cos.ap-guangzhou.myqcloud.com/java-feature-switch.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java Feature - Switch"/></a><div class="content"><a class="title" href="/2024/10/15/java-feature-switch/" title="Java Feature - Switch">Java Feature - Switch</a><time datetime="2024-10-14T16:06:25.000Z" title="Created 2024-10-15 00:06:25">2024-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/14/cloud-native-observability-opentelemetry/" title="Observability - OpenTelemetry"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/cloud-native-observability-opentelemetry.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry"/></a><div class="content"><a class="title" href="/2024/10/14/cloud-native-observability-opentelemetry/" title="Observability - OpenTelemetry">Observability - OpenTelemetry</a><time datetime="2024-10-13T16:06:25.000Z" title="Created 2024-10-14 00:06:25">2024-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/13/cloud-native-observability-concept/" title="Observability - Concept"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/cloud-native-observability-concept.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Concept"/></a><div class="content"><a class="title" href="/2024/10/13/cloud-native-observability-concept/" title="Observability - Concept">Observability - Concept</a><time datetime="2024-10-12T16:06:25.000Z" title="Created 2024-10-13 00:06:25">2024-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/12/java-feature-type-matching/" title="Java Feature - Type Matching"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-feature-1253868755.cos.ap-guangzhou.myqcloud.com/java-feature-pattern-matching.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java Feature - Type Matching"/></a><div class="content"><a class="title" href="/2024/10/12/java-feature-type-matching/" title="Java Feature - Type Matching">Java Feature - Type Matching</a><time datetime="2024-10-11T16:06:25.000Z" title="Created 2024-10-12 00:06:25">2024-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/11/java-feature-sealed/" title="Java Feature - Sealed"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-feature-1253868755.cos.ap-guangzhou.myqcloud.com/java-feature-sealed.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java Feature - Sealed"/></a><div class="content"><a class="title" href="/2024/10/11/java-feature-sealed/" title="Java Feature - Sealed">Java Feature - Sealed</a><time datetime="2024-10-10T16:06:25.000Z" title="Created 2024-10-11 00:06:25">2024-10-11</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2024 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
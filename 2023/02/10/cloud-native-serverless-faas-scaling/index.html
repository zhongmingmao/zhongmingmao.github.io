<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>FaaS - Scaling | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="概述 Serverless 的弹性扩缩容可以将实例缩容为 0，并根据请求量级自动扩缩容，从而有效地提升资源利用率 极致动态扩缩容是 FaaS 的核心内涵，是与 PaaS 平台的核心差异 - 降本增效">
<meta property="og:type" content="article">
<meta property="og:title" content="FaaS - Scaling">
<meta property="og:url" content="https://blog.zhongmingmao.top/2023/02/10/cloud-native-serverless-faas-scaling/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="概述 Serverless 的弹性扩缩容可以将实例缩容为 0，并根据请求量级自动扩缩容，从而有效地提升资源利用率 极致动态扩缩容是 FaaS 的核心内涵，是与 PaaS 平台的核心差异 - 降本增效">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240318203921511.png">
<meta property="article:published_time" content="2023-02-09T16:06:25.000Z">
<meta property="article:modified_time" content="2024-03-27T01:06:36.292Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Infrastructure">
<meta property="article:tag" content="Architecture">
<meta property="article:tag" content="Serverless">
<meta property="article:tag" content="FaaS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240318203921511.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "FaaS - Scaling",
  "url": "https://blog.zhongmingmao.top/2023/02/10/cloud-native-serverless-faas-scaling/",
  "image": "https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240318203921511.png",
  "datePublished": "2023-02-09T16:06:25.000Z",
  "dateModified": "2024-03-27T01:06:36.292Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2023/02/10/cloud-native-serverless-faas-scaling/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'FaaS - Scaling',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">639</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240318203921511.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">FaaS - Scaling</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">FaaS - Scaling</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2023-02-09T16:06:25.000Z" title="Created 2023-02-10 00:06:25">2023-02-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/serverless/">Serverless</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/serverless/faas/">FaaS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">1.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>4mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2024-03-27 09:06:36&quot;}" hidden></div><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ol>
<li>Serverless 的弹性扩缩容可以将实例缩容为 <code>0</code>，并根据请求量级<code>自动扩缩容</code>，从而有效地提升资源利用率</li>
<li><code>极致动态扩缩容</code>是 <code>FaaS</code> 的<code>核心内涵</code>，是与 PaaS 平台的核心差异 - <code>降本增效</code></li>
</ol>
<span id="more"></span>

<h1 id="调度形态"><a href="#调度形态" class="headerlink" title="调度形态"></a>调度形态</h1><ol>
<li>开源的 Serverless 函数计算引擎核心，一般是基于 Kubernetes <code>HPA</code></li>
<li>云厂商一般有封装好的各种底座服务，可以基于底座服务来做封装</li>
<li>云厂商<code>容器调度服务</code>，通常有两种调度形态<ul>
<li>基于 <code>Node</code> 调度</li>
<li>基于<code>容器实例</code>的调度 - <code>Serverless</code></li>
</ul>
</li>
<li>云厂商的<code>函数计算</code>通常是基于<code>容器服务</code>的底座</li>
</ol>
<h2 id="Node-维度"><a href="#Node-维度" class="headerlink" title="Node 维度"></a>Node 维度</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240319133535831.png" alt="image-20240319133535831"></p>
<blockquote>
<p>组件</p>
</blockquote>
<ol>
<li><code>Scheduler</code><ul>
<li>负责将请求打到指定的函数实例（Pod）上，同时负责为集群中的 Node 标记状态，记录到 <code>etcd</code></li>
</ul>
</li>
<li><code>Local-Controller</code><ul>
<li>Node 上的本地控制器，负责管理 Node 上所有<code>函数实例</code>的<code>生命周期</code>，以 <code>DeamonSet</code> 形式存在</li>
</ul>
</li>
<li><code>AutoScaler</code><ul>
<li>定期检测集群中 <code>Node</code> 和 <code>Pod</code> 的使用情况，并根据策略进行扩缩容</li>
<li>在扩容时，向底层的 <code>PaaS</code> 平台<code>申请资源</code></li>
</ul>
</li>
<li><code>Pod</code><ul>
<li><code>Cold</code> 表示该 Pod <code>未被使用</code></li>
<li><code>Warm</code> 表示<code>正在被使用</code>或者处于<code>等待回收</code>的状态</li>
</ul>
</li>
<li><code>Node</code><ul>
<li>状态：闲置、占用</li>
<li>如果一个 Node 上<code>所有的 Pod</code> 都是 <code>cold</code>，该 <code>Node</code> 为<code>闲置</code>状态</li>
</ul>
</li>
</ol>
<blockquote>
<p>过程</p>
</blockquote>
<ol>
<li>AutoScaler 会<code>定期检查</code>集群中所有 Node</li>
<li>如果检测到 Node 处于一个需要扩容的状态，则根据策略（<code>完全自定义</code>）进行扩容</li>
<li>在 Node 形态下，<code>Pod</code> 通常会作为<code>函数实例</code>的<code>通用状态</code><ul>
<li>代码以及不同运行时以<code>挂载</code>的形式<code>注入</code>到容器内 - <code>DeamonSet</code></li>
</ul>
</li>
<li>AutoScaler 会在轮询时，根据 Warm Pod 的<code>闲置时间</code>将其<code>重置</code>为 Cold Pod</li>
<li>在缩容时，理想情况下，AutoScaler 可以将 <code>Node</code> 缩容为 <code>0</code><ul>
<li>但为了应对<code>突发流量</code>，会<code>预留</code>一部分 Buffer</li>
</ul>
</li>
</ol>
<blockquote>
<p>缺点</p>
</blockquote>
<ol>
<li>需要<code>管理 Node 调度</code>，还需要处理 Node 中 Pod 的安全隔离和使用</li>
<li>可以通过<code>空 Pod</code> 来提前占用，<code>预加载</code>一部分 Pod</li>
</ol>
<h2 id="Pod-维度"><a href="#Pod-维度" class="headerlink" title="Pod 维度"></a>Pod 维度</h2><blockquote>
<p>以 <code>Pod</code> 为<code>扩缩容单元</code>，可以更加<code>细粒度</code>地控制函数实例的数量</p>
</blockquote>
<h3 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h3><blockquote>
<p>The HorizontalPodAutoscaler is implemented as a Kubernetes API resource and a controller. The resource determines the behavior of the controller. The horizontal pod autoscaling controller, running within the Kubernetes control plane, periodically adjusts the desired scale of its target (for example, a Deployment) to match observed metrics such as average CPU utilization, average memory utilization, or any other custom metric you specify.</p>
</blockquote>
<ol>
<li><code>定期</code>从 Kubernetes <code>控制面</code>获取资源的各项<code>指标</code>数据（CPU 利用率、内存使用率等）</li>
<li>根据指标数据将资源数量<code>控制</code>在一个目标范围内</li>
</ol>
<blockquote>
<p>HPA 通过控制 Deployment 或者 RC 来实现对 Pod 实际数量的控制</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240320104856175.png" alt="image-20240320104856175"></p>
<ol>
<li>在 Kubernetes 中，不同的 Metric 会由对应的 <code>Metric Server</code> 持续采集</li>
<li>HPA 会<code>定期</code>通过 Metric Server 的 API 或者聚合的 API Server 获取到这些 Metric 指标数据（CPU &#x2F; Memory）<ul>
<li>然后根据<code>自定义的扩缩容规则</code>计算出 Pod 的<code>期望数量</code></li>
<li>最后，根据 Pod 当前的实际数量对 Deployment &#x2F; RC 做出调整，使得 Pod 达到期望数量</li>
</ul>
</li>
</ol>
<blockquote>
<p>HPA 形态的扩缩容不能直接用于 Serverless</p>
</blockquote>
<ol>
<li>Serverless 语义下的动态扩缩容可以让服务缩容到 <code>0</code>，而 HPA 不能</li>
<li>HPA 是通过检测 <code>Pod</code> 的 <code>Metric</code> 来完成 Deployment 的扩缩容<ul>
<li>如果 Deployment 的副本缩容到 0，则 Metric 也变为 0，与 HPA 的机制有<code>根本冲突</code></li>
</ul>
</li>
</ol>
<h3 id="Knative"><a href="#Knative" class="headerlink" title="Knative"></a>Knative</h3><blockquote>
<p><code>从 0 到 1</code> 的扩缩容过程，需要<code>额外</code>的机制来支持</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240320111718443.png" alt="image-20240320111718443"></p>
<h4 id="收集流量指标"><a href="#收集流量指标" class="headerlink" title="收集流量指标"></a>收集流量指标</h4><ol>
<li>在 Knative 中，<code>Revision</code> 代表一个不变的、某一时刻的代码和 Configuration 的<code>快照</code></li>
<li>每个 <code>Revision</code> 会引用一个特定的<code>容器镜像</code>和运行它所需要的任何特定对象（如<code>环境变量</code>和<code>卷</code>）<ul>
<li>再通过 <code>Deployment</code> 控制函数实例（<code>User Pod</code>）的副本数</li>
</ul>
</li>
<li>每个 <code>User Pod</code> 中都有两个容器：<code>Queue Proxy</code> 和 <code>User Container</code></li>
<li><code>Queue Proxy</code><ul>
<li>每个函数实例被创建时，都会被以 <code>Sidecar</code> 的方式将 <code>Queue Proxy</code> 注入</li>
<li><code>Queue Proxy</code> 作为每个 <code>User Pod</code> 的<code>流量入口</code>，负责<code>限流</code>和<code>流量统计</code>的工作</li>
<li><code>AutoScaler</code> 会<code>定时</code>收集 <code>Queue Proxy</code> 统计的流量数据，作为后续扩缩容的重要依据</li>
</ul>
</li>
</ol>
<h4 id="调整实例数量"><a href="#调整实例数量" class="headerlink" title="调整实例数量"></a>调整实例数量</h4><ol>
<li>当收集到<code>流量</code>的指标后，AutoScaler 会通过改变实例 <code>Deployment</code> 来决定实例最终的个数</li>
<li>简单算法 - 按照当前总并发<code>平均划分</code>到期望数量的实例上，使其符合设定的并发值<ul>
<li>当前总并发为 100，设定的并发值为 10，最终调整出来的实例数量为 100&#x2F;10 &#x3D; 10</li>
</ul>
</li>
<li>实际上，扩缩容的实例数量还会考虑系统负载和调度周期等因素</li>
</ol>
<h4 id="从-0-到-1"><a href="#从-0-到-1" class="headerlink" title="从 0 到 1"></a>从 0 到 1</h4><ol>
<li>Knative 专门引入 <code>Activator</code> 组件 - 用于<code>流量暂存</code>和<code>代理负载</code></li>
<li>当 AutoScaler 将函数实例缩容为 <code>0</code> 时，会控制 <code>Activator</code> 作为实例为 0 时的<code>流量接收入口</code></li>
<li><code>Activator</code> 在收到流量后，会将请求和信息暂时<code>缓存</code>，并<code>主动</code>告知 <code>AutoScaler</code> 进行<code>扩容</code><ul>
<li>直到<code>成功扩容</code>出来函数实例，Activator 才会将缓存的流量<code>转发</code>到新生成的函数实例上</li>
</ul>
</li>
</ol>
<h1 id="扩缩容模型"><a href="#扩缩容模型" class="headerlink" title="扩缩容模型"></a>扩缩容模型</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240321122235346.png" alt="image-20240321122235346"></p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2023/02/10/cloud-native-serverless-faas-scaling/">https://blog.zhongmingmao.top/2023/02/10/cloud-native-serverless-faas-scaling/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/infrastructure/">Infrastructure</a><a class="post-meta__tags" href="/tags/architecture/">Architecture</a><a class="post-meta__tags" href="/tags/serverless/">Serverless</a><a class="post-meta__tags" href="/tags/faas/">FaaS</a></div><div class="post-share"><div class="social-share" data-image="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240318203921511.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/02/11/cloud-native-gateway-apisix/" title="APISIX - Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api-gateway-1253868755.cos.ap-guangzhou.myqcloud.com/apisix.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">APISIX - Doc</div></div><div class="info-2"><div class="info-item-1">Feature    Apache APISIX 基于 Radixtree Route 和 etcd 提供路由极速匹配与配置快速同步的能力 Apache APISIX 提供了自定义插件的能力 可以在 Balancer 阶段使用自定义负载均衡算法，并使用自定义路由算法对路由进行精细化控制   Apache APISIX 提供了配置热更新、插件热加载能力，在不重新启动实例的情况下可快速更新配置  Quick Start路由 Apache APISIX 使用 routes 来提供灵活的网关管理功能，在一个请求中，routes 包含了访问路径和上游目标等信息  Route Route 是访问上游目标的路径 过程 通过预定的规则来匹配客户端请求 然后加载和执行相应的插件 最后将请求转发至特定的 Upstream   一个最简单的 Route 仅由匹配路径和 Upstream 地址两个信息组成  Upstream Upstream 是一组具备相同功能的节点集合，它是对虚拟主机的抽象 Upstream 可以通过预先配置的规则对多个服务节点进行负载均衡  Examples 创建路由 &#x3D; Uri + Upstr...</div></div></div></a><a class="pagination-related" href="/2023/02/09/cloud-native-serverless-faas-cold-start/" title="FaaS - Cold Start"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/faas-cold-start.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">FaaS - Cold Start</div></div><div class="info-2"><div class="info-item-1">触发时机 类似于 LoadingCache   首次请求 容器实例在服务请求后被回收    启动过程 容器创建 当所有容器实例都在处理请求时，需要向集群申请创建新的容器 函数计算平台会支持多种语言的运行时 这些运行时一般来说会打包成一个镜像，然后以 DeamonSet 的方式运行在 Kubernetes 中 在冷启动时，会根据不同的参数请求，动态挂载所需的运行时到对应的运行路径    代码包 &#x2F; 层依赖 是整个冷启动耗时比较长的过程 函数计算本身不具备持久化的能力，代码包和层依赖通常都是从其它存储服务端拉取 代码包通常是压缩包的形式，下载到本地后，再解压  环境变量 &#x2F; 参数文件 耗时相对较短 主流的函数计算平台往往提供了环境变量注入的能力，发生在冷启动阶段 运行时以及容器本身还需要准备一些参数配置文件  VPC 打通 &#x2F; 资源准备 如果用户还为函数接入了私有网络，还需要为容器进行一些 VPC 网络打通的初始化工作 如果用户使用了类似分布式文件系统等功能，还需要进行挂载  运行时初始化 通常指的是云厂商标准的 Runtime 环境的启动过程 受编程语言类型的影响比较大（JV...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/02/15/cloud-native-serverless-faas-workflow/" title="FaaS - Workflow"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/faas-workflow.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-15</div><div class="info-item-2">FaaS - Workflow</div></div><div class="info-2"><div class="info-item-1"> </div></div></div></a><a class="pagination-related" href="/2023/02/14/cloud-native-serverless-faas-web-ide/" title="FaaS - WebIDE"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/webide.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-14</div><div class="info-item-2">FaaS - WebIDE</div></div><div class="info-2"><div class="info-item-1">架构   组成 蓝色部分 WebIDE 客户端的核心 Run VS Code on any machine anywhere and access it in the browser   绿色部分 将 WebIDE 与 FaaS 结合的核心   橘色部分 Serverless 形态下的必备支撑服务    过程 用户在 VS Code 的前端页面向后端发出函数在线编辑的请求 服务端，即 FaaS 的 Controller 在接收到请求并验证权限后，再转给 VS Code Server 容器实例   VS Code Server 容器实例会获取用户代码，然后再加载 FaaS 的资源调度系统 根据目前 Container Pool 中的资源现状，动态扩缩容 WebIDE Pod 资源   VS Code Server 根据用户请求，会调用 Serverless Extension BE 基于此时语言的环境，执行操作，并将执行结果返回给 Client 端    注意 可以将 Serverless Extension 插件提前集成在 VS Code Server 的镜像中 FaaS Runtime 依据原来函数计...</div></div></div></a><a class="pagination-related" href="/2023/02/13/cloud-native-serverless-faas-function-invoke/" title="FaaS - Function Invoke"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/faas-function-invoke.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-13</div><div class="info-item-2">FaaS - Function Invoke</div></div><div class="info-2"><div class="info-item-1">函数拆分 成本 云函数的收费：调用次数、公网流量、占用资源时间（最贵）   复用 组件化   性能 对于非串行的功能，拆分成多个函数可以提高并发性      调用方式 同步、异步、编排（具有调度和管理的语义）   同步 需要注意调用延迟和超时带来的费用成本  直接调用 使用云厂商提供的 SDK，调用指定的函数，实现直接调用  12345678import fc2client = fc2.Client(               endpoint=&#x27;&lt;Your Endpoint&gt;&#x27;,               accessKeyID=&#x27;&lt;Your AccessKeyID&gt;&#x27;,               accessKeySecret=&#x27;&lt;Your AccessKeySecret&gt;&#x27;)// 同步调用client.invoke_function(&#x27;service_name&#x27;, &#x27;function_name&#x27;)  网关调用 通过 API 网关调用函数，借助 API 网关来...</div></div></div></a><a class="pagination-related" href="/2023/02/12/cloud-native-serverless-faas-runtime/" title="FaaS - Runtime"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/faas-runtime.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-12</div><div class="info-item-2">FaaS - Runtime</div></div><div class="info-2"><div class="info-item-1">概述 一般的编程语言都有自身的运行时，运行时的主要职责是可以让代码和机器交互，进而实现业务逻辑 函数计算运行时 能够让函数在机器或者容器中执行起来，实现业务逻辑的执行环境 通常由特定语言构建的框架构成   函数计算运行时依赖于语言运行时 函数计算运行时的本质：让函数在容器中执行起来的代码框架      在函数实例初始化时，函数计算运行时一般会由一个初始化进程加载起来 然后函数计算运行时就可以准备接收请求 当请求到达后，业务代码会被对应的语言运行时中加载进来处理请求   Runtime 是一个特定语言环境下的服务框架环境   该服务将以一个进程的形态运行在用户容器中，并与用户代码相关联 该服务启动后，会一直等待请求的到来，一旦请求到达后，Runtime 会关联业务代码去执行（并发）  原理语言类型编译型语言 C&#x2F;C++&#x2F;Go，在编译时将所有用到的静态依赖、源码一起打包，编译完后可以直接运行 Java，经过编译产生的字节码需要 JVM 再次将其转换为机器码，同时具有编译型和解释型的特性 通常需要将所有依赖包打包成一个 jar 包或者 war 包，符合编译型语言的风格   在开发函数时，需...</div></div></div></a><a class="pagination-related" href="/2023/02/09/cloud-native-serverless-faas-cold-start/" title="FaaS - Cold Start"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/faas-cold-start.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-09</div><div class="info-item-2">FaaS - Cold Start</div></div><div class="info-2"><div class="info-item-1">触发时机 类似于 LoadingCache   首次请求 容器实例在服务请求后被回收    启动过程 容器创建 当所有容器实例都在处理请求时，需要向集群申请创建新的容器 函数计算平台会支持多种语言的运行时 这些运行时一般来说会打包成一个镜像，然后以 DeamonSet 的方式运行在 Kubernetes 中 在冷启动时，会根据不同的参数请求，动态挂载所需的运行时到对应的运行路径    代码包 &#x2F; 层依赖 是整个冷启动耗时比较长的过程 函数计算本身不具备持久化的能力，代码包和层依赖通常都是从其它存储服务端拉取 代码包通常是压缩包的形式，下载到本地后，再解压  环境变量 &#x2F; 参数文件 耗时相对较短 主流的函数计算平台往往提供了环境变量注入的能力，发生在冷启动阶段 运行时以及容器本身还需要准备一些参数配置文件  VPC 打通 &#x2F; 资源准备 如果用户还为函数接入了私有网络，还需要为容器进行一些 VPC 网络打通的初始化工作 如果用户使用了类似分布式文件系统等功能，还需要进行挂载  运行时初始化 通常指的是云厂商标准的 Runtime 环境的启动过程 受编程语言类型的影响比较大（JV...</div></div></div></a><a class="pagination-related" href="/2023/02/08/cloud-native-serverless-faas-advanced-attributes/" title="FaaS - Advanced Attributes"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://serverless-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/what-is-faas.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-08</div><div class="info-item-2">FaaS - Advanced Attributes</div></div><div class="info-2"><div class="info-item-1">公共能力 将函数依赖的公共库提炼到层，以减少部署、更新时的代码包体积 对于支持层功能的运行时，函数计算会将特定的目录添加到运行时语言的依赖包搜索路径中 对于自定义层，需要将所有内容打包到一个压缩包，并上传到函数计算平台 函数计算运行时会将层的内容解压并部署到特定的目录   层功能的好处 函数程序包更小 避免在制作函数 zip 包和依赖项过程中出现未知的错误 可以在多个函数中引入使用，减少不必要的存储资源浪费        上传层之后，函数计算会将层的 zip 包上传到对象存储 当调用函数执行时，会从对象存储中下载层的 zip 包并解压到特定目录 应用程序只需要访问特定目录，就能读取层的依赖和公共代码   注意：后序的层会覆盖相同目录下的文件  快速迭代 标准运行时 &#x2F; 自定义镜像   函数计算系统初始化执行环境之前，会扮演该函数的服务角色，获得临时用户名和密码并拉取镜像 镜像拉取成功后，会根据指定的启动命令、参数和端口，启动自定义的 HTTP Server 该 HTTP Server 会接管函数计算系统所有请求的调用     调用方式不同：事件函数 &#x2F; HTTP 函数    在创建函...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">639</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%BD%A2%E6%80%81"><span class="toc-number">2.</span> <span class="toc-text">调度形态</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Node-%E7%BB%B4%E5%BA%A6"><span class="toc-number">2.1.</span> <span class="toc-text">Node 维度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-%E7%BB%B4%E5%BA%A6"><span class="toc-number">2.2.</span> <span class="toc-text">Pod 维度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HPA"><span class="toc-number">2.2.1.</span> <span class="toc-text">HPA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Knative"><span class="toc-number">2.2.2.</span> <span class="toc-text">Knative</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E6%B5%81%E9%87%8F%E6%8C%87%E6%A0%87"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">收集流量指标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E5%AE%9E%E4%BE%8B%E6%95%B0%E9%87%8F"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">调整实例数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E-0-%E5%88%B0-1"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">从 0 到 1</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A9%E7%BC%A9%E5%AE%B9%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">扩缩容模型</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/ai-agent.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - Overview"/></a><div class="content"><a class="title" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview">AI Agent - Overview</a><time datetime="2025-01-17T16:06:25.000Z" title="Created 2025-01-18 00:06:25">2025-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/17/new-java-feature-foreign-function-api/" title="New Java Feature - Foreign Function API"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-feature-1253868755.cos.ap-guangzhou.myqcloud.com/Java-Foreign-Function-API.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="New Java Feature - Foreign Function API"/></a><div class="content"><a class="title" href="/2025/01/17/new-java-feature-foreign-function-api/" title="New Java Feature - Foreign Function API">New Java Feature - Foreign Function API</a><time datetime="2025-01-16T16:06:25.000Z" title="Created 2025-01-17 00:06:25">2025-01-17</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
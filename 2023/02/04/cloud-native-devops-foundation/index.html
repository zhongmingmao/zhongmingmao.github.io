<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>DevOps - Foundation | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="基本原理核心原理">
<meta property="og:type" content="article">
<meta property="og:title" content="DevOps - Foundation">
<meta property="og:url" content="https://blog.zhongmingmao.top/2023/02/04/cloud-native-devops-foundation/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="基本原理核心原理">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/devops.png">
<meta property="article:published_time" content="2023-02-03T16:06:25.000Z">
<meta property="article:modified_time" content="2024-02-19T11:44:01.655Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="DevOps">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Helm">
<meta property="article:tag" content="runc">
<meta property="article:tag" content="Kustomize">
<meta property="article:tag" content="OCI">
<meta property="article:tag" content="BuildKit">
<meta property="article:tag" content="crane">
<meta property="article:tag" content="OCI Image">
<meta property="article:tag" content="OCI Runtime">
<meta property="article:tag" content="Linux Namespace">
<meta property="article:tag" content="Linux CGroup">
<meta property="article:tag" content="K8S Manifest">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/devops.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2023/02/04/cloud-native-devops-foundation/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'DevOps - Foundation',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-02-19 19:44:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">518</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">151</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">69</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/devops.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">DevOps - Foundation</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2023-02-03T16:06:25.000Z" title="Created 2023-02-04 00:06:25">2023-02-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/devops/">DevOps</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">13.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>79min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h1><h2 id="核心原理"><a href="#核心原理" class="headerlink" title="核心原理"></a>核心原理</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/linux-namespace-cgroup.webp" alt="linux-namespace-cgroup"></p>
<span id="more"></span>

<h2 id="隔离机制"><a href="#隔离机制" class="headerlink" title="隔离机制"></a>隔离机制</h2><blockquote>
<p>运行 Nginx 镜像</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d nginx:latest</span><br><span class="line">Unable to find image &#x27;nginx:latest&#x27; locally</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">25d3892798f8: Pull complete</span><br><span class="line">42de7275c085: Pull complete</span><br><span class="line">c459a9332e03: Pull complete</span><br><span class="line">48882f13d668: Pull complete</span><br><span class="line">49180167b771: Pull complete</span><br><span class="line">da4abc2b066c: Pull complete</span><br><span class="line">20dc44ab57ab: Pull complete</span><br><span class="line">Digest: sha256:5f44022eab9198d75939d9eaa5341bc077eca16fa51d4ef32d33f1bd4c8cbe7d</span><br><span class="line">Status: Downloaded newer image for nginx:latest</span><br><span class="line">d821171713e9b805c4180c122f3502583bb6732a8b974ebd16179be741a8e49e</span><br><span class="line"></span><br><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">d821171713e9   nginx:latest   &quot;/docker-entrypoint.…&quot;   41 seconds ago   Up 40 seconds   80/tcp    sad_noether</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取容器在宿主上的 PID</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect --format &#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27; d821171713e9</span><br><span class="line">10909</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看进程详情</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ps -aux | grep 10909</span><br><span class="line">root       10909  0.0  0.0  11140  6972 ?        Ss   14:17   0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">root       11149  0.0  0.0   5860  1900 pts/1    S+   14:40   0:00 grep --color 10909</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取进程所有 namespace 类型</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ lsns --task 10909</span><br><span class="line">        NS TYPE   NPROCS   PID USER COMMAND</span><br><span class="line">4026531834 time      228     1 root /sbin/init</span><br><span class="line">4026531837 user      228     1 root /sbin/init</span><br><span class="line">4026532698 mnt         5 10909 root nginx: master process nginx -g daemon off;</span><br><span class="line">4026532699 uts         5 10909 root nginx: master process nginx -g daemon off;</span><br><span class="line">4026532700 ipc         5 10909 root nginx: master process nginx -g daemon off;</span><br><span class="line">4026532701 pid         5 10909 root nginx: master process nginx -g daemon off;</span><br><span class="line">4026532702 net         5 10909 root nginx: master process nginx -g daemon off;</span><br><span class="line">4026532762 cgroup      5 10909 root nginx: master process nginx -g daemon off;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>进入 filesystem namespace（无需 docker daemon）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ hostname</span><br><span class="line">devops</span><br><span class="line"></span><br><span class="line">$ nsenter --target 10909 --mount bash</span><br><span class="line">root@devops:/# hostname</span><br><span class="line">devops</span><br><span class="line">root@devops:/#</span><br><span class="line">root@devops:/#</span><br><span class="line">root@devops:/# ls</span><br><span class="line">bin   dev           docker-entrypoint.sh  home  media  opt   root  sbin	sys  usr</span><br><span class="line">boot  docker-entrypoint.d  etc             lib   mnt    proc  run   srv	tmp  var</span><br><span class="line">root@devops:/#</span><br><span class="line">root@devops:/# whoami</span><br><span class="line">root</span><br><span class="line">root@devops:/#</span><br><span class="line">root@devops:/# pwd</span><br><span class="line">/</span><br><span class="line">root@devops:/#</span><br><span class="line">root@devops:/# exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改容器主机名，会同时修改宿主主机名，因为并没有进入 utc namespace</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ nsenter --target 10909 --mount bash</span><br><span class="line">root@devops:/# hostname</span><br><span class="line">devops</span><br><span class="line">root@devops:/#</span><br><span class="line">root@devops:/# hostname zhongmingmao</span><br><span class="line">root@devops:/#</span><br><span class="line">root@devops:/# hostname</span><br><span class="line">zhongmingmao</span><br><span class="line">root@devops:/# exit</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">$ hostname</span><br><span class="line">zhongmingmao</span><br></pre></td></tr></table></figure>

<blockquote>
<p>进入所有 namespace，再次修改容器主机名，不会修改宿主主机名</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nsenter --target 10909 --all bash</span><br><span class="line">root@d821171713e9:/#</span><br><span class="line">root@d821171713e9:/# hostname</span><br><span class="line">d821171713e9</span><br><span class="line">root@d821171713e9:/#</span><br><span class="line">root@d821171713e9:/# hostname devops</span><br><span class="line">root@d821171713e9:/#</span><br><span class="line">root@d821171713e9:/# hostname</span><br><span class="line">devops</span><br><span class="line">root@d821171713e9:/# exit</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">$ hostname</span><br><span class="line">zhongmingmao</span><br><span class="line"></span><br><span class="line">$ docker exec -it d821171713e9 hostname</span><br><span class="line">devops</span><br></pre></td></tr></table></figure>

<h2 id="实现容器"><a href="#实现容器" class="headerlink" title="实现容器"></a>实现容器</h2><h3 id="uts"><a href="#uts" class="headerlink" title="uts"></a>uts</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> os.Args[<span class="number">1</span>] &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;run&quot;</span>:</span><br><span class="line">        run()</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;what?&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Running %v as PID %d\n&quot;</span>, os.Args[<span class="number">2</span>:], os.Getpid())</span><br><span class="line"></span><br><span class="line">    cmd := exec.Command(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>:]...)</span><br><span class="line">    cmd.Stdin = os.Stdin</span><br><span class="line">    cmd.Stdout = os.Stdout</span><br><span class="line">    cmd.Stderr = os.Stderr</span><br><span class="line">    cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">        Cloneflags: syscall.CLONE_NEWUTS,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    must(cmd.Run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">must</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现了对 uts namespace 的隔离</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ hostname</span><br><span class="line">devops</span><br><span class="line"></span><br><span class="line">$ go run main.go run /bin/bash</span><br><span class="line">Running [/bin/bash] as PID 12759</span><br><span class="line">root@devops:/tmp#</span><br><span class="line">root@devops:/tmp# hostname</span><br><span class="line">devops</span><br><span class="line">root@devops:/tmp#</span><br><span class="line">root@devops:/tmp# hostname zhongmingmao</span><br><span class="line">root@devops:/tmp#</span><br><span class="line">root@devops:/tmp# hostname</span><br><span class="line">zhongmingmao</span><br><span class="line">root@devops:/tmp#</span><br><span class="line">root@devops:/tmp# cat /etc/issue</span><br><span class="line">Ubuntu 22.04.2 LTS \n \l</span><br><span class="line"></span><br><span class="line">root@devops:/tmp#</span><br><span class="line">root@devops:/tmp# exit</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">$ hostname</span><br><span class="line">devops</span><br></pre></td></tr></table></figure>

<h3 id="pid"><a href="#pid" class="headerlink" title="pid"></a>pid</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> os.Args[<span class="number">1</span>] &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;run&quot;</span>:</span><br><span class="line">        run()</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;child&quot;</span>:</span><br><span class="line">        child()</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;what?&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cmd := exec.Command(<span class="string">&quot;/proc/self/exe&quot;</span>, <span class="built_in">append</span>([]<span class="type">string</span>&#123;<span class="string">&quot;child&quot;</span>&#125;, os.Args[<span class="number">2</span>:]...)...)</span><br><span class="line">    cmd.Stdin = os.Stdin</span><br><span class="line">    cmd.Stdout = os.Stdout</span><br><span class="line">    cmd.Stderr = os.Stderr</span><br><span class="line">    cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">        <span class="comment">// CLONE_NEWUTS 和 CLONE_NEWPID</span></span><br><span class="line">        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    must(cmd.Run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">child</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Running %v as PID %d\n&quot;</span>, os.Args[<span class="number">2</span>:], os.Getpid())</span><br><span class="line"></span><br><span class="line">    cmd := exec.Command(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>:]...)</span><br><span class="line">    cmd.Stdin = os.Stdin</span><br><span class="line">    cmd.Stdout = os.Stdout</span><br><span class="line">    cmd.Stderr = os.Stderr</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chroot 实现独立的文件系统</span></span><br><span class="line">    must(syscall.Chroot(<span class="string">&quot;/tmp/rootfs&quot;</span>))</span><br><span class="line">    must(os.Chdir(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">    must(cmd.Run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">must</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>模拟 rootfs</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ dpu alpine:3.19.1</span><br><span class="line">3.19.1: Pulling from library/alpine</span><br><span class="line">3.19.1: Pulling from library/alpine</span><br><span class="line">bca4290a9639: Pull complete</span><br><span class="line">Digest: sha256:c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b</span><br><span class="line">Status: Downloaded newer image for alpine:3.19.1</span><br><span class="line">docker.io/library/alpine:3.19.1</span><br><span class="line"></span><br><span class="line">$ docker run --rm -it alpine:3.19.1 sh</span><br><span class="line"></span><br><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE           COMMAND   CREATED         STATUS         PORTS     NAMES</span><br><span class="line">c76b50efba54   alpine:3.19.1   &quot;sh&quot;      2 minutes ago   Up 2 minutes             relaxed_sinoussi</span><br><span class="line"></span><br><span class="line">$ docker export c76b50efba54 -o alpine.tar</span><br><span class="line"></span><br><span class="line">$ mkdir /tmp/rootfs</span><br><span class="line"></span><br><span class="line">$ tar -xf alpine.tar -C /tmp/rootfs</span><br><span class="line"></span><br><span class="line">$ ls /tmp/rootfs</span><br><span class="line">bin    etc    lib    mnt    proc   run    srv    tmp    var</span><br><span class="line">dev    home   media  opt    root   sbin   sys    usr</span><br><span class="line"></span><br><span class="line">$ file /tmp/rootfs/bin/sh</span><br><span class="line">/tmp/rootfs/bin/sh: symbolic link to /bin/busybox</span><br></pre></td></tr></table></figure>

<blockquote>
<p>运行 Go 程序</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go run /bin/sh</span><br><span class="line">Running [/bin/sh] as PID 1</span><br><span class="line">/ #</span><br><span class="line">/ # ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">/ #</span><br><span class="line">/ # ls</span><br><span class="line">bin    etc    lib    mnt    proc   run    srv    tmp    var</span><br><span class="line">dev    home   media  opt    root   sbin   sys    usr</span><br><span class="line">/ #</span><br><span class="line">/ # whoami</span><br><span class="line">root</span><br><span class="line">/ #</span><br><span class="line">/ # cat /etc/issue</span><br><span class="line">Welcome to Alpine Linux 3.19</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<h2 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h2><blockquote>
<p>总共 2 层 Layer（FROM + RUN），Layer 名称是以 Layer <code>内容</code>的 <code>hash</code> 值命名</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install nginx -y</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t nginx:v1 -f Dockerfile .</span><br><span class="line">[+] Building 372.7s (6/6) FINISHED                                                                                                                                          docker:default</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                                                                                                  0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 137B                                                                                                                                                  0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/debian:latest                                                                                                                     64.2s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                                                                                     0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                                                                                       0.0s</span><br><span class="line"> =&gt; [1/2] FROM docker.io/library/debian:latest@sha256:79becb70a6247d277b59c09ca340bbe0349af6aacb5afa90ec349528b53ce2c9                                                              254.5s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/debian:latest@sha256:79becb70a6247d277b59c09ca340bbe0349af6aacb5afa90ec349528b53ce2c9                                                                0.0s</span><br><span class="line"> =&gt; =&gt; sha256:79becb70a6247d277b59c09ca340bbe0349af6aacb5afa90ec349528b53ce2c9 1.85kB / 1.85kB                                                                                        0.0s</span><br><span class="line"> =&gt; =&gt; sha256:a250db2ed1e0cdcca7baf72084ba6c4578b69cd984367bd6616abe24c92d61a6 529B / 529B                                                                                            0.0s</span><br><span class="line"> =&gt; =&gt; sha256:e244810c32b8849593705821bec8d7399b3feae991f2b9e8096e58496aa4d594 1.48kB / 1.48kB                                                                                        0.0s</span><br><span class="line"> =&gt; =&gt; sha256:66932e2b787d33a94ee3eb8b489be6e6838b29f5c1d732262da306da9b1f2eed 49.62MB / 49.62MB                                                                                    253.0s</span><br><span class="line"> =&gt; =&gt; extracting sha256:66932e2b787d33a94ee3eb8b489be6e6838b29f5c1d732262da306da9b1f2eed                                                                                             1.4s</span><br><span class="line"> =&gt; [2/2] RUN apt-get update &amp;&amp; apt-get install nginx -y                                                                                                                             53.9s</span><br><span class="line"> =&gt; exporting to image                                                                                                                                                                0.1s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                                                                                               0.1s</span><br><span class="line"> =&gt; =&gt; writing image sha256:05c5750a507a020657c815dace56dc50ee7d87e0e211c673bad91c043b0f2803                                                                                          0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/nginx:v1                                                                                                                                           0.0s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ dils</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx        v1        05c5750a507a   2 minutes ago   177MB</span><br><span class="line">debian       latest    e244810c32b8   4 days ago      139MB</span><br><span class="line"></span><br><span class="line">$ docker save nginx:v1 -o nginx.tar</span><br><span class="line"></span><br><span class="line">$ mkdir nginx</span><br><span class="line"></span><br><span class="line">$ tar -xf nginx.tar -C nginx</span><br><span class="line"></span><br><span class="line">$ tree -L 3 nginx</span><br><span class="line">nginx</span><br><span class="line">|-- blobs</span><br><span class="line">|   `-- sha256</span><br><span class="line">|       |-- 05c5750a507a020657c815dace56dc50ee7d87e0e211c673bad91c043b0f2803</span><br><span class="line">|       |-- 1ba13ff2de2b5c6e6a37d13462d72bf49362230c9df685507f9e3abd0f6494fd</span><br><span class="line">|       |-- 70c00505c8c87b38c586dae20d13765688f1f6015ca17cfa438d17610702d977</span><br><span class="line">|       |-- 9f8c60461a42fd9f275c56f4ec8fea8a8ea2d938493e316e830994a3814cf0aa</span><br><span class="line">|       |-- f885044959b5561449db197b178e8243400bb8ef21a9673035989735e6cf4bb3</span><br><span class="line">|       `-- fbf499cf128f24d47415a9ea80538ca459e5806f8873257d8d55a0500f4be743</span><br><span class="line">|-- index.json</span><br><span class="line">|-- manifest.json</span><br><span class="line">|-- oci-layout</span><br><span class="line">`-- repositories</span><br><span class="line"></span><br><span class="line">$ du -sh nginx/blobs/sha256/*</span><br><span class="line">4.0K    nginx/blobs/sha256/05c5750a507a020657c815dace56dc50ee7d87e0e211c673bad91c043b0f2803</span><br><span class="line">37M    nginx/blobs/sha256/1ba13ff2de2b5c6e6a37d13462d72bf49362230c9df685507f9e3abd0f6494fd</span><br><span class="line">4.0K    nginx/blobs/sha256/70c00505c8c87b38c586dae20d13765688f1f6015ca17cfa438d17610702d977</span><br><span class="line">137M    nginx/blobs/sha256/9f8c60461a42fd9f275c56f4ec8fea8a8ea2d938493e316e830994a3814cf0aa</span><br><span class="line">4.0K    nginx/blobs/sha256/f885044959b5561449db197b178e8243400bb8ef21a9673035989735e6cf4bb3</span><br><span class="line">4.0K    nginx/blobs/sha256/fbf499cf128f24d47415a9ea80538ca459e5806f8873257d8d55a0500f4be743</span><br></pre></td></tr></table></figure>

<blockquote>
<p>repositories</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;nginx&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;v1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1ba13ff2de2b5c6e6a37d13462d72bf49362230c9df685507f9e3abd0f6494fd&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>oci-layout</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;imageLayoutVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>manifest.json</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blobs/sha256/05c5750a507a020657c815dace56dc50ee7d87e0e211c673bad91c043b0f2803&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;nginx:v1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Layers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;blobs/sha256/9f8c60461a42fd9f275c56f4ec8fea8a8ea2d938493e316e830994a3814cf0aa&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;blobs/sha256/1ba13ff2de2b5c6e6a37d13462d72bf49362230c9df685507f9e3abd0f6494fd&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;LayerSources&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;sha256:1ba13ff2de2b5c6e6a37d13462d72bf49362230c9df685507f9e3abd0f6494fd&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.layer.v1.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">38124544</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:1ba13ff2de2b5c6e6a37d13462d72bf49362230c9df685507f9e3abd0f6494fd&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sha256:9f8c60461a42fd9f275c56f4ec8fea8a8ea2d938493e316e830994a3814cf0aa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.layer.v1.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">143643136</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:9f8c60461a42fd9f275c56f4ec8fea8a8ea2d938493e316e830994a3814cf0aa&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>index.json</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.index.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;manifests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:fbf499cf128f24d47415a9ea80538ca459e5806f8873257d8d55a0500f4be743&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">621</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;io.containerd.image.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;docker.io/library/nginx:v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;org.opencontainers.image.ref.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v8&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Overlay"><a href="#Overlay" class="headerlink" title="Overlay"></a>Overlay</h2><blockquote>
<p>lower_dir 为<code>只读层</code>，upper_dir 为<code>读写层</code>，merged_dir 为用户最终看到的目录，work_dir 存储中间结果</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- lower_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 2.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">|-- merged_dir</span><br><span class="line">|-- upper_dir</span><br><span class="line">|   |-- 3.txt</span><br><span class="line">|   |-- 4.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">`-- work_dir</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t overlay -o lowerdir=lower_dir/,upperdir=upper_dir/,workdir=work_dir/ none merged_dir/</span><br><span class="line"></span><br><span class="line">$ df -a</span><br><span class="line">Filesystem                        1K-blocks    Used Available Use% Mounted on</span><br><span class="line">...</span><br><span class="line">none                               31270768 8351528  21305212  29% /root/workspace/iac/merged_dir</span><br><span class="line"></span><br><span class="line">$ cd /root/workspace/iac/</span><br><span class="line"></span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- lower_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 2.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">|-- merged_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 2.txt</span><br><span class="line">|   |-- 3.txt</span><br><span class="line">|   |-- 4.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">|-- upper_dir</span><br><span class="line">|   |-- 3.txt</span><br><span class="line">|   |-- 4.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">`-- work_dir</span><br><span class="line">    `-- work</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同名文件会被上层 Layer 覆盖</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat lower_dir/same.txt</span><br><span class="line">我是底层的 Layer</span><br><span class="line"></span><br><span class="line">$ cat upper_dir/same.txt</span><br><span class="line">我是上层的 Layer</span><br><span class="line"></span><br><span class="line">$ cat merged_dir/same.txt</span><br><span class="line">我是上层的 Layer</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>写时复制</code>（上层 Layer）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ cat lower_dir/1.txt | wc -l</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">$ cat merged_dir/1.txt | wc -l</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">$ echo &#x27;hello devops&#x27; &gt; merged_dir/1.txt</span><br><span class="line"></span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- lower_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 2.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">|-- merged_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 2.txt</span><br><span class="line">|   |-- 3.txt</span><br><span class="line">|   |-- 4.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">|-- upper_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 3.txt</span><br><span class="line">|   |-- 4.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">`-- work_dir</span><br><span class="line">    `-- work</span><br><span class="line"></span><br><span class="line">$ cat merged_dir/1.txt | wc -l</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ cat upper_dir/1.txt | wc -l</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ cat lower_dir/1.txt | wc -l</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>标记删除</code>（上层 Layer）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf merged_dir/2.txt</span><br><span class="line"></span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- lower_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 2.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">|-- merged_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 3.txt</span><br><span class="line">|   |-- 4.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">|-- upper_dir</span><br><span class="line">|   |-- 1.txt</span><br><span class="line">|   |-- 2.txt</span><br><span class="line">|   |-- 3.txt</span><br><span class="line">|   |-- 4.txt</span><br><span class="line">|   `-- same.txt</span><br><span class="line">`-- work_dir</span><br><span class="line">    `-- work</span><br><span class="line">        `-- #11</span><br><span class="line"></span><br><span class="line">$ ls -la lower_dir</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 zhongmingmao staff 4096 Nov 29 12:39 .</span><br><span class="line">drwxr-xr-x 6 zhongmingmao staff 4096 Feb  6 10:11 ..</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff    0 Sep 20 14:15 1.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff    0 Sep 20 14:15 2.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff   21 Sep 20 14:15 same.txt</span><br><span class="line">        </span><br><span class="line">$ ls -la upper_dir</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 2 zhongmingmao staff 4096 Feb  6 14:14 .</span><br><span class="line">drwxr-xr-x 6 zhongmingmao staff 4096 Feb  6 10:11 ..</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff   13 Feb  6 14:08 1.txt</span><br><span class="line">c--------- 2 root         root  0, 0 Feb  6 14:14 2.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff    0 Sep 20 14:15 3.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff    0 Sep 20 14:15 4.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff   21 Sep 20 14:15 same.txt</span><br><span class="line"></span><br><span class="line">$ ls -la merged_dir</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 1 zhongmingmao staff 4096 Feb  6 14:14 .</span><br><span class="line">drwxr-xr-x 6 zhongmingmao staff 4096 Feb  6 10:11 ..</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff   13 Feb  6 14:08 1.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff    0 Sep 20 14:15 3.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff    0 Sep 20 14:15 4.txt</span><br><span class="line">-rw-r--r-- 1 zhongmingmao staff   21 Sep 20 14:15 same.txt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Docker Image</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ dils</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx        v1        9831fa04701a   4 minutes ago   177MB</span><br><span class="line"></span><br><span class="line">$ docker image inspect nginx:v1 | jq -r &#x27;.[0]|&#123;Data:.GraphDriver.Data&#125;&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;Data&quot;: &#123;</span><br><span class="line">    &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/11ebcd41fca026092de6e607c64e59ef0220b5e85d486e4414ec3a498f51e72a/diff&quot;,</span><br><span class="line">    &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/6rt4ae10ohwu79b3l802u77ls/merged&quot;,</span><br><span class="line">    &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/6rt4ae10ohwu79b3l802u77ls/diff&quot;,</span><br><span class="line">    &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/6rt4ae10ohwu79b3l802u77ls/work&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ ls /var/lib/docker/overlay2/11ebcd41fca026092de6e607c64e59ef0220b5e85d486e4414ec3a498f51e72a/diff</span><br><span class="line">bin  boot  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"></span><br><span class="line">$ ls /var/lib/docker/overlay2/6rt4ae10ohwu79b3l802u77ls/diff</span><br><span class="line">etc  tmp  usr  var</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240206145333549.png" alt="image-20240206145333549"></p>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><blockquote>
<p>ENTRYPOINT &#x2F; CMD</p>
</blockquote>
<ol>
<li>ENTRYPOINT 默认为 <code>/bin/sh -c</code>，因此 CMD 为一个可执行文件时，能运行</li>
<li>ENTRYPOINT + CMD</li>
</ol>
<blockquote>
<p>ADD &#x2F; COPY</p>
</blockquote>
<ol>
<li>优选 <code>COPY</code>，语义更清晰</li>
</ol>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ol>
<li>减少 Layer <code>层数</code></li>
<li>将<code>经常发生变化</code>的 Layer 层<code>移后</code>，尽量利用<code>构建缓存</code></li>
<li>使用 <code>.dockerignore</code></li>
<li>减少镜像<code>体积</code><ul>
<li>基础镜像：<code>alpine</code>、<code>slim</code></li>
<li>使用<code>多阶段构建</code></li>
</ul>
</li>
<li>安全</li>
</ol>
<h3 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h3><blockquote>
<p><code>慎用 alpine 镜像</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>Tag</th>
<th>Size</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>latest</td>
<td>381.88 MB</td>
<td>gnu c library</td>
</tr>
<tr>
<td>slim</td>
<td>70.28 MB</td>
<td>gnu c library</td>
</tr>
<tr>
<td>alpine</td>
<td>47.02 MB</td>
<td><code>musl libc</code></td>
</tr>
</tbody></table>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/labstack/echo/v4&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    e := echo.New()</span><br><span class="line">    e.GET(<span class="string">&quot;/hello&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c echo.Context)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c.String(http.StatusOK, <span class="string">&quot;Hello, World!&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    e.Logger.Fatal(e.Start(<span class="string">&quot;:8888&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.19</span> as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go mod init app &amp;&amp; go mod tidy &amp;&amp; go build -o example</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /opt/app/example ./example</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/opt/app/example&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>go build</code> 默认是<code>动态链接</code>，会找不到动态链接库</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t go-alpine:v1 -f Dockerfile . --no-cache</span><br><span class="line"></span><br><span class="line">$ dils</span><br><span class="line">REPOSITORY      TAG        IMAGE ID       CREATED         SIZE</span><br><span class="line">go-alpine       v1         f998fec48dff   3 seconds ago   14.8MB</span><br><span class="line"></span><br><span class="line">$ docker run go-alpine:v1</span><br><span class="line">exec /opt/app/example: no such file or directory</span><br><span class="line"></span><br><span class="line">$ docker run -it go-alpine:v1 sh</span><br><span class="line">/opt/app # ls</span><br><span class="line">example</span><br><span class="line">/opt/app # ./example</span><br><span class="line">sh: ./example: not found</span><br></pre></td></tr></table></figure>

<blockquote>
<p>静态链接：<code>-tags netgo -ldflags &#39;-extldflags &quot;-static&quot;&#39;</code></p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.19</span> as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go mod init app &amp;&amp; go mod tidy &amp;&amp; go build -tags netgo -ldflags <span class="string">&#x27;-extldflags &quot;-static&quot;&#x27;</span> -o example</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /opt/app/example ./example</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/opt/app/example&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t go-alpine:v2 -f Dockerfile . --no-cache</span><br><span class="line"></span><br><span class="line">$ docker run go-alpine:v2</span><br><span class="line"></span><br><span class="line">   ____    __</span><br><span class="line">  / __/___/ /  ___</span><br><span class="line"> / _// __/ _ \/ _ \</span><br><span class="line">/___/\__/_//_/\___/ v4.11.4</span><br><span class="line">High performance, minimalist Go web framework</span><br><span class="line">https://echo.labstack.com</span><br><span class="line">____________________________________O/_______</span><br><span class="line">                                    O\</span><br><span class="line">⇨ http server started on [::]:8888</span><br></pre></td></tr></table></figure>

<blockquote>
<p>静态链接：<code>CGO_ENABLE=0</code></p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.19</span> as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go mod init app &amp;&amp; go mod tidy &amp;&amp; CGO_ENABLE=0 go build -o example</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /opt/app/example ./example</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/opt/app/example&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t go-alpine:v3 -f Dockerfile . --no-cache</span><br><span class="line"></span><br><span class="line">$ docker run go-alpine:v3</span><br><span class="line"></span><br><span class="line">   ____    __</span><br><span class="line">  / __/___/ /  ___</span><br><span class="line"> / _// __/ _ \/ _ \</span><br><span class="line">/___/\__/_//_/\___/ v4.11.4</span><br><span class="line">High performance, minimalist Go web framework</span><br><span class="line">https://echo.labstack.com</span><br><span class="line">____________________________________O/_______</span><br><span class="line">                                    O\</span><br><span class="line">⇨ http server started on [::]:8888</span><br></pre></td></tr></table></figure>

<blockquote>
<p>统一都使用 alpine 镜像</p>
</blockquote>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.19</span>-alpine as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go mod init app &amp;&amp; go mod tidy &amp;&amp; go build -o example</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /opt/app/example ./example</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/opt/app/example&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t go-alpine:v4 -f Dockerfile . --no-cache</span><br><span class="line"></span><br><span class="line">$ docker run go-alpine:v4</span><br><span class="line"></span><br><span class="line">   ____    __</span><br><span class="line">  / __/___/ /  ___</span><br><span class="line"> / _// __/ _ \/ _ \</span><br><span class="line">/___/\__/_//_/\___/ v4.11.4</span><br><span class="line">High performance, minimalist Go web framework</span><br><span class="line">https://echo.labstack.com</span><br><span class="line">____________________________________O/_______</span><br><span class="line">                                    O\</span><br><span class="line">⇨ http server started on [::]:8888</span><br></pre></td></tr></table></figure>

<h3 id="多阶段构建"><a href="#多阶段构建" class="headerlink" title="多阶段构建"></a>多阶段构建</h3><blockquote>
<p>主要用途：<code>减少镜像大小</code></p>
</blockquote>
<h4 id="单阶段"><a href="#单阶段" class="headerlink" title="单阶段"></a>单阶段</h4><figure class="highlight dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.17</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go mod init app &amp;&amp; go build -o example</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/opt/app/example&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t app:v1 -f Dockerfile .</span><br><span class="line"></span><br><span class="line">$ dils</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">app          v1        21fcbe4fbaa0   About a minute ago   808MB</span><br></pre></td></tr></table></figure>

<h4 id="多阶段"><a href="#多阶段" class="headerlink" title="多阶段"></a>多阶段</h4><figure class="highlight dockerfile"><figcaption><span>Dockerfile-multi-stage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.17</span> as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go mod init app &amp;&amp; go build -o example</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:latest</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /opt/app/example ./example</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/opt/app/example&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t app:v2 -f Dockerfile-multi-stage .</span><br><span class="line"></span><br><span class="line">$ dils</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">app          v2        3133d10045a7   10 seconds ago   67.7MB</span><br></pre></td></tr></table></figure>

<h3 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h3><blockquote>
<p>避免使用 <code>root</code> 用户</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -ms /bin/bash app</span></span><br><span class="line"><span class="keyword">USER</span> app</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t user:v1 -f Dockerfile .</span><br><span class="line"></span><br><span class="line">$ docker run --rm -it user:v1 whoami</span><br><span class="line">app</span><br></pre></td></tr></table></figure>

<h1 id="镜像构建"><a href="#镜像构建" class="headerlink" title="镜像构建"></a>镜像构建</h1><h2 id="DinD"><a href="#DinD" class="headerlink" title="DinD"></a>DinD</h2><blockquote>
<p><code>不安全</code></p>
</blockquote>
<ol>
<li>docker build 依赖于 <code>Docker Daemon</code></li>
<li>DinD - 将宿主上的 <code>Docker Socket</code>（权限很高） 挂载到容器，将宿主的权限<code>暴露</code>到容器中</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it -v /var/run/docker.sock:/var/run/docker.sock docker:dind docker -v</span><br><span class="line">Docker version 25.0.2, build 29cf629</span><br></pre></td></tr></table></figure>

<h2 id="BuildKit"><a href="#BuildKit" class="headerlink" title="BuildKit"></a>BuildKit</h2><ol>
<li><code>buildx</code>：内置在 Docker 的默认构建工具，<code>效率</code>远高于原始的 Docker 构建</li>
<li>不依赖于 Docker Daemon，但依赖于 <code>Buildkit Daemon</code>（可以<code>直接部署在容器中</code>）</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/buildkit.png" alt="buildkit"></p>
<blockquote>
<p>启动 buildkitd 容器（用于构建镜像）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name buildkitd --privileged moby/buildkit:rootless</span><br><span class="line">370d7080ce0a58e500f5f3c78b133fee7d8f5f187c5654afc293381d58b2faf8</span><br><span class="line"></span><br><span class="line">$  docker ps</span><br><span class="line">CONTAINER ID   IMAGE                                  COMMAND                  CREATED              STATUS              PORTS                                                                                                      NAMES</span><br><span class="line">370d7080ce0a   moby/buildkit:rootless                 &quot;rootlesskit buildki…&quot;   About a minute ago   Up About a minute                                                                                                              buildkitd</span><br></pre></td></tr></table></figure>

<blockquote>
<p>构建镜像（指定<code>构建上下文</code>，并传递到 buildkitd 容器）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ buildctl --addr docker-container://buildkitd build \</span><br><span class="line">--frontend=dockerfile.v0 \</span><br><span class="line">--local context=. \</span><br><span class="line">--local dockerfile=. \</span><br><span class="line">--output type=image,name=nginx:v2</span><br><span class="line">[+] Building 128.3s (7/7) FINISHED</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                             0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 138B                                                                             0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                 3.5s</span><br><span class="line"> =&gt; [auth] library/ubuntu:pull token for registry-1.docker.io                                                    0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                  0.0s</span><br><span class="line"> =&gt; [1/2] FROM docker.io/library/ubuntu:latest@sha256:e9569c25505f33ff72e88b2990887c9dcf230f23259da296eb814fc2  39.4s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/ubuntu:latest@sha256:e9569c25505f33ff72e88b2990887c9dcf230f23259da296eb814fc2b  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:b91d8878f844c327b4ff924d4973661a399f10256ed50ac7c640b30c5894166b 27.36MB / 27.36MB                38.9s</span><br><span class="line"> =&gt; =&gt; extracting sha256:b91d8878f844c327b4ff924d4973661a399f10256ed50ac7c640b30c5894166b                        0.5s</span><br><span class="line"> =&gt; [2/2] RUN apt-get update &amp;&amp; apt-get install nginx -y                                                        82.9s</span><br><span class="line"> =&gt; exporting to image                                                                                           2.5s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                          2.4s</span><br><span class="line"> =&gt; =&gt; exporting manifest sha256:4fe3c6e56f30d9566e0b7874c2b878748e95bc5e1cef4e22fed24ca885627774                0.0s</span><br><span class="line"> =&gt; =&gt; exporting config sha256:e5767056cc73207a3e27cf8a3c1f3f5926cd8914172cb022e09630eb4e4b040a                  0.0s</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Option</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>–addr</td>
<td>buildkitd address (default: “unix:&#x2F;&#x2F;&#x2F;run&#x2F;buildkit&#x2F;buildkitd.sock”)</td>
</tr>
</tbody></table>
<h2 id="Kaniko"><a href="#Kaniko" class="headerlink" title="Kaniko"></a>Kaniko</h2><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><blockquote>
<p>Kaniko 用于推送镜像的凭证</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo -n &#x27;zhongmingmao:$&#123;docker_hub_access_token&#125;&#x27; | base64</span><br><span class="line">xxx</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;auths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;https://index.docker.io/v1/&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install python3</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install python3 -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install wget -y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello World&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- app.py</span><br><span class="line">|-- config.json</span><br><span class="line">|-- Dockerfile</span><br><span class="line"></span><br><span class="line">$ docker run \</span><br><span class="line">-v &quot;./config.json:/kaniko/.docker/config.json&quot; \</span><br><span class="line">-v &quot;.:/workspace&quot; \</span><br><span class="line">gcr.io/kaniko-project/executor:latest \</span><br><span class="line">--dockerfile /workspace/Dockerfile \</span><br><span class="line">--destination &quot;zhongmingmao/devops-app:v1&quot; \</span><br><span class="line">--context dir:///workspace/</span><br><span class="line">INFO[0002] Retrieving image manifest debian:latest</span><br><span class="line">INFO[0002] Retrieving image debian:latest from registry index.docker.io</span><br><span class="line">INFO[0006] Built cross stage deps: map[]</span><br><span class="line">INFO[0006] Retrieving image manifest debian:latest</span><br><span class="line">INFO[0006] Returning cached image manifest</span><br><span class="line">INFO[0006] Executing 0 build triggers</span><br><span class="line">INFO[0006] Building stage &#x27;debian:latest&#x27; [idx: &#x27;0&#x27;, base-idx: &#x27;-1&#x27;]</span><br><span class="line">INFO[0006] Unpacking rootfs as cmd COPY . . requires it.</span><br><span class="line">INFO[0097] WORKDIR /app</span><br><span class="line">INFO[0097] Cmd: workdir</span><br><span class="line">INFO[0097] Changed working directory to /app</span><br><span class="line">INFO[0097] Creating directory /app with uid -1 and gid -1</span><br><span class="line">INFO[0097] Taking snapshot of files...</span><br><span class="line">INFO[0097] COPY . .</span><br><span class="line">INFO[0097] Taking snapshot of files...</span><br><span class="line">INFO[0097] RUN apt-get update</span><br><span class="line">INFO[0097] Initializing snapshotter ...</span><br><span class="line">INFO[0097] Taking snapshot of full filesystem...</span><br><span class="line">INFO[0097] Cmd: /bin/sh</span><br><span class="line">INFO[0097] Args: [-c apt-get update]</span><br><span class="line">INFO[0097] Running: [/bin/sh -c apt-get update]</span><br><span class="line">...</span><br><span class="line">INFO[0114] Taking snapshot of full filesystem...</span><br><span class="line">INFO[0115] RUN apt-get install python3 -y</span><br><span class="line">INFO[0115] Cmd: /bin/sh</span><br><span class="line">INFO[0115] Args: [-c apt-get install python3 -y]</span><br><span class="line">INFO[0115] Running: [/bin/sh -c apt-get install python3 -y]</span><br><span class="line">...</span><br><span class="line">INFO[0136] Taking snapshot of full filesystem...</span><br><span class="line">INFO[0144] RUN apt-get install wget -y</span><br><span class="line">INFO[0144] Cmd: /bin/sh</span><br><span class="line">INFO[0144] Args: [-c apt-get install wget -y]</span><br><span class="line">INFO[0144] Running: [/bin/sh -c apt-get install wget -y]</span><br><span class="line">...</span><br><span class="line">INFO[0146] Taking snapshot of full filesystem...</span><br><span class="line">INFO[0146] CMD [&quot;python3&quot;, &quot;app.py&quot;]</span><br><span class="line">INFO[0146] Pushing image to zhongmingmao/devops-app:v1</span><br><span class="line">INFO[0227] Pushed index.docker.io/zhongmingmao/devops-app@sha256:45af3d0bcd801ecb864dd4520efa48b1160647d5c420d225ce6720429395a504</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240206225057362.png" alt="image-20240206225057362"></p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol>
<li>不支持<code>跨平台构建</code>（没有<code>虚拟化</code>）</li>
<li><code>构建速度</code>较慢</li>
<li><code>缓存效率</code>相对于本地缓存更低，一般需要借助<code>网络</code>和 <code>Repository</code></li>
<li><code>资源消耗</code>比较多</li>
</ol>
<h2 id="构建原理"><a href="#构建原理" class="headerlink" title="构建原理"></a>构建原理</h2><h3 id="传统构建"><a href="#传统构建" class="headerlink" title="传统构建"></a>传统构建</h3><blockquote>
<p><code>串行构建</code>，效率低</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install python3</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install python3 -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install wget -y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello World&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>禁用 BuildKit  <code>DOCKER_BUILDKIT=0</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ DOCKER_BUILDKIT=0 docker build -t app:v1 . --no-cache</span><br><span class="line">DEPRECATED: The legacy builder is deprecated and will be removed in a future release.</span><br><span class="line">            BuildKit is currently disabled; enable it by removing the DOCKER_BUILDKIT=0</span><br><span class="line">            environment-variable.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>监控 Docker 资源消耗 - <code>串行创建容器</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stats -a</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207103338445.png" alt="image-20240207103338445"></p>
<blockquote>
<p>查看历史，存在很多<code>中间镜像</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ dils</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">app          v1        4c515a334e32   2 minutes ago   214MB</span><br><span class="line">debian       latest    e244810c32b8   6 days ago      139MB</span><br><span class="line"></span><br><span class="line">$ docker history app:v1</span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">4c515a334e32   2 minutes ago   /bin/sh -c #(nop)  CMD [&quot;python3&quot; &quot;app.py&quot;]     0B</span><br><span class="line">5fcca84b53b5   2 minutes ago   /bin/sh -c apt-get install wget -y              5.08MB</span><br><span class="line">c33eea06254d   3 minutes ago   /bin/sh -c apt-get install python3 -y           51MB</span><br><span class="line">4836a8252d35   3 minutes ago   /bin/sh -c apt-get update                       19.2MB</span><br><span class="line">0dbe04522c2a   3 minutes ago   /bin/sh -c #(nop) COPY dir:97cd23d94493fbd05…   493B</span><br><span class="line">b74b24a3d291   3 minutes ago   /bin/sh -c #(nop) WORKDIR /app                  0B</span><br><span class="line">e244810c32b8   6 days ago      /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B</span><br><span class="line">&lt;missing&gt;      6 days ago      /bin/sh -c #(nop) ADD file:8bc7f537dd3dc4b92…   139MB</span><br></pre></td></tr></table></figure>

<blockquote>
<p>构建过程（<code>串行</code>）</p>
</blockquote>
<ol>
<li>首先通过 <code>docker run</code> 基于基础镜像启动第一个<code>中间容器</code></li>
<li>在中间容器中执行 Dockerfile 中的第一条构建命令</li>
<li>最后通过 <code>docker commit</code> 将中间容器的<code>读写层</code>提交为<code>镜像只读层</code></li>
<li>执行下一条构建命令</li>
</ol>
<blockquote>
<p>总共 6 层 Layer</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207105154984.png" alt="image-20240207105154984"></p>
<h3 id="BuildKit-1"><a href="#BuildKit-1" class="headerlink" title="BuildKit"></a>BuildKit</h3><blockquote>
<p>多阶段构建</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine As kubectl</span><br><span class="line"><span class="keyword">ENV</span> KUBECTL_VERSION=<span class="number">1.22</span>.<span class="number">0</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /output</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add curl</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -LO https://dl.k8s.io/release/v<span class="variable">$&#123;KUBECTL_VERSION&#125;</span>/bin/linux/amd64/kubectl</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x kubectl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine As terraform</span><br><span class="line"><span class="keyword">ENV</span> TERRAFORM_VERSION=<span class="number">1.5</span>.<span class="number">5</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /output</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add curl zip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -LO https://releases.hashicorp.com/terraform/<span class="variable">$&#123;TERRAFORM_VERSION&#125;</span>/terraform_<span class="variable">$&#123;TERRAFORM_VERSION&#125;</span>_linux_amd64.zip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> unzip terraform_<span class="variable">$&#123;TERRAFORM_VERSION&#125;</span>_linux_amd64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=kubectl /output/kubectl /usr/local/bin/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=terraform /output/terraform /usr/local/bin/</span></span><br></pre></td></tr></table></figure>

<h4 id="传统构建-1"><a href="#传统构建-1" class="headerlink" title="传统构建"></a>传统构建</h4><blockquote>
<p><code>串行</code>（Dockerfile 总共 17 行，扫描到 15 个 Step，依次执行）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">$ DOCKER_BUILDKIT=0 docker build -t app:v2.1 . --no-cache</span><br><span class="line">DEPRECATED: The legacy builder is deprecated and will be removed in a future release.</span><br><span class="line">            BuildKit is currently disabled; enable it by removing the DOCKER_BUILDKIT=0</span><br><span class="line">            environment-variable.</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon   2.56kB</span><br><span class="line">Step 1/15 : FROM alpine As kubectl</span><br><span class="line"> ---&gt; ace17d5d883e</span><br><span class="line">Step 2/15 : ENV KUBECTL_VERSION=1.22.0</span><br><span class="line"> ---&gt; Running in 90d2c8328ffa</span><br><span class="line"> ---&gt; Removed intermediate container 90d2c8328ffa</span><br><span class="line"> ---&gt; e533e7cfc049</span><br><span class="line">Step 3/15 : WORKDIR /output</span><br><span class="line"> ---&gt; Running in 34e4a969c829</span><br><span class="line"> ---&gt; Removed intermediate container 34e4a969c829</span><br><span class="line"> ---&gt; 7ea13ef487d2</span><br><span class="line">Step 4/15 : RUN apk add curl</span><br><span class="line"> ---&gt; Running in 8dc705f90042</span><br><span class="line">fetch https://dl-cdn.alpinelinux.org/alpine/v3.19/main/aarch64/APKINDEX.tar.gz</span><br><span class="line">fetch https://dl-cdn.alpinelinux.org/alpine/v3.19/community/aarch64/APKINDEX.tar.gz</span><br><span class="line">(1/8) Installing ca-certificates (20230506-r0)</span><br><span class="line">(2/8) Installing brotli-libs (1.1.0-r1)</span><br><span class="line">(3/8) Installing c-ares (1.24.0-r1)</span><br><span class="line">(4/8) Installing libunistring (1.1-r2)</span><br><span class="line">(5/8) Installing libidn2 (2.3.4-r4)</span><br><span class="line">(6/8) Installing nghttp2-libs (1.58.0-r0)</span><br><span class="line">(7/8) Installing libcurl (8.5.0-r0)</span><br><span class="line">(8/8) Installing curl (8.5.0-r0)</span><br><span class="line">Executing busybox-1.36.1-r15.trigger</span><br><span class="line">Executing ca-certificates-20230506-r0.trigger</span><br><span class="line">OK: 13 MiB in 23 packages</span><br><span class="line"> ---&gt; Removed intermediate container 8dc705f90042</span><br><span class="line"> ---&gt; c053772d0e1f</span><br><span class="line">Step 5/15 : RUN curl -LO https://dl.k8s.io/release/v$&#123;KUBECTL_VERSION&#125;/bin/linux/amd64/kubectl</span><br><span class="line"> ---&gt; Running in cfba68780dba</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   138  100   138    0     0    168      0 --:--:-- --:--:-- --:--:--   168</span><br><span class="line">100 44.7M  100 44.7M    0     0   523k      0  0:01:27  0:01:27 --:--:--  604k</span><br><span class="line"> ---&gt; Removed intermediate container cfba68780dba</span><br><span class="line"> ---&gt; f6a604bfb07d</span><br><span class="line">Step 6/15 : RUN chmod +x kubectl</span><br><span class="line"> ---&gt; Running in 2ca7431e0dac</span><br><span class="line"> ---&gt; Removed intermediate container 2ca7431e0dac</span><br><span class="line"> ---&gt; fe78712a5a48</span><br><span class="line">Step 7/15 : FROM alpine As terraform</span><br><span class="line"> ---&gt; ace17d5d883e</span><br><span class="line">Step 8/15 : ENV TERRAFORM_VERSION=1.5.5</span><br><span class="line"> ---&gt; Running in e04fa5775b46</span><br><span class="line"> ---&gt; Removed intermediate container e04fa5775b46</span><br><span class="line"> ---&gt; 1b39330b4a04</span><br><span class="line">Step 9/15 : WORKDIR /output</span><br><span class="line"> ---&gt; Running in c1e73121e079</span><br><span class="line"> ---&gt; Removed intermediate container c1e73121e079</span><br><span class="line"> ---&gt; 1cd6baf401a1</span><br><span class="line">Step 10/15 : RUN apk add curl zip</span><br><span class="line"> ---&gt; Running in 82cc3da776a3</span><br><span class="line">fetch https://dl-cdn.alpinelinux.org/alpine/v3.19/main/aarch64/APKINDEX.tar.gz</span><br><span class="line">fetch https://dl-cdn.alpinelinux.org/alpine/v3.19/community/aarch64/APKINDEX.tar.gz</span><br><span class="line">(1/10) Installing ca-certificates (20230506-r0)</span><br><span class="line">(2/10) Installing brotli-libs (1.1.0-r1)</span><br><span class="line">(3/10) Installing c-ares (1.24.0-r1)</span><br><span class="line">(4/10) Installing libunistring (1.1-r2)</span><br><span class="line">(5/10) Installing libidn2 (2.3.4-r4)</span><br><span class="line">(6/10) Installing nghttp2-libs (1.58.0-r0)</span><br><span class="line">(7/10) Installing libcurl (8.5.0-r0)</span><br><span class="line">(8/10) Installing curl (8.5.0-r0)</span><br><span class="line">(9/10) Installing unzip (6.0-r14)</span><br><span class="line">(10/10) Installing zip (3.0-r12)</span><br><span class="line">Executing busybox-1.36.1-r15.trigger</span><br><span class="line">Executing ca-certificates-20230506-r0.trigger</span><br><span class="line">OK: 14 MiB in 25 packages</span><br><span class="line"> ---&gt; Removed intermediate container 82cc3da776a3</span><br><span class="line"> ---&gt; c462f291f399</span><br><span class="line">Step 11/15 : RUN curl -LO https://releases.hashicorp.com/terraform/$&#123;TERRAFORM_VERSION&#125;/terraform_$&#123;TERRAFORM_VERSION&#125;_linux_amd64.zip</span><br><span class="line"> ---&gt; Running in 418af7423ff1</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 20.0M  100 20.0M    0     0   580k      0  0:00:35  0:00:35 --:--:--  581k</span><br><span class="line"> ---&gt; Removed intermediate container 418af7423ff1</span><br><span class="line"> ---&gt; f698453c3034</span><br><span class="line">Step 12/15 : RUN unzip terraform_$&#123;TERRAFORM_VERSION&#125;_linux_amd64</span><br><span class="line"> ---&gt; Running in 0f1559fcfb85</span><br><span class="line">Archive:  terraform_1.5.5_linux_amd64.zip</span><br><span class="line">  inflating: terraform</span><br><span class="line"> ---&gt; Removed intermediate container 0f1559fcfb85</span><br><span class="line"> ---&gt; db704a4548c1</span><br><span class="line">Step 13/15 : FROM alpine</span><br><span class="line"> ---&gt; ace17d5d883e</span><br><span class="line">Step 14/15 : COPY --from=kubectl /output/kubectl /usr/local/bin/</span><br><span class="line"> ---&gt; cf63ae19d314</span><br><span class="line">Step 15/15 : COPY --from=terraform /output/terraform /usr/local/bin/</span><br><span class="line"> ---&gt; 55dd577730da</span><br><span class="line">Successfully built 55dd577730da</span><br><span class="line">Successfully tagged app:v2.1</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ dils</span><br><span class="line">REPOSITORY      TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">&lt;none&gt;          &lt;none&gt;    db704a4548c1   About a minute ago   102MB</span><br><span class="line">app             v2.1      55dd577730da   About a minute ago   120MB</span><br><span class="line">&lt;none&gt;          &lt;none&gt;    fe78712a5a48   2 minutes ago        109MB</span><br><span class="line"></span><br><span class="line">$ docker history fe78712a5a48</span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">fe78712a5a48   3 minutes ago   /bin/sh -c chmod +x kubectl                     46.9MB</span><br><span class="line">f6a604bfb07d   3 minutes ago   /bin/sh -c curl -LO https://dl.k8s.io/releas…   46.9MB</span><br><span class="line">c053772d0e1f   5 minutes ago   /bin/sh -c apk add curl                         7.01MB</span><br><span class="line">7ea13ef487d2   5 minutes ago   /bin/sh -c #(nop) WORKDIR /output               0B</span><br><span class="line">e533e7cfc049   5 minutes ago   /bin/sh -c #(nop)  ENV KUBECTL_VERSION=1.22.0   0B</span><br><span class="line">ace17d5d883e   11 days ago     /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot;]              0B</span><br><span class="line">&lt;missing&gt;      11 days ago     /bin/sh -c #(nop) ADD file:d0764a717d1e9d0af…   7.73MB</span><br><span class="line"></span><br><span class="line">$ docker history app:v2.1</span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">55dd577730da   3 minutes ago   /bin/sh -c #(nop) COPY file:e7b95d65dbe7ce17…   65.2MB</span><br><span class="line">cf63ae19d314   3 minutes ago   /bin/sh -c #(nop) COPY file:7db4b8e3cdd20ba1…   46.9MB</span><br><span class="line">ace17d5d883e   11 days ago     /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot;]              0B</span><br><span class="line">&lt;missing&gt;      11 days ago     /bin/sh -c #(nop) ADD file:d0764a717d1e9d0af…   7.73MB</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207111229167.png" alt="image-20240207111229167"></p>
<h4 id="BuildKit-2"><a href="#BuildKit-2" class="headerlink" title="BuildKit"></a>BuildKit</h4><blockquote>
<p><code>并行</code>（借助 <code>DAG</code> 依赖分析，terraform 和 kubectl 没有依赖关系，可以并行）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t app:v2.2 . --no-cache</span><br><span class="line">[+] Building 141.3s (14/14) FINISHED                                                                   docker:default</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                             0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 612B                                                                             0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/alpine:latest                                                 0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                  0.0s</span><br><span class="line"> =&gt; [terraform 1/5] FROM docker.io/library/alpine:latest                                                         0.0s</span><br><span class="line"> =&gt; [terraform 2/5] WORKDIR /output                                                                              0.0s</span><br><span class="line"> =&gt; [kubectl 3/5] RUN apk add curl                                                                              10.6s</span><br><span class="line"> =&gt; [terraform 3/5] RUN apk add curl zip                                                                        12.4s</span><br><span class="line"> =&gt; [kubectl 4/5] RUN curl -LO https://dl.k8s.io/release/v1.22.0/bin/linux/amd64/kubectl                       130.1s</span><br><span class="line"> =&gt; [terraform 4/5] RUN curl -LO https://releases.hashicorp.com/terraform/1.5.5/terraform_1.5.5_linux_amd64.zi  40.4s</span><br><span class="line"> =&gt; [terraform 5/5] RUN unzip terraform_1.5.5_linux_amd64                                                        0.6s</span><br><span class="line"> =&gt; [kubectl 5/5] RUN chmod +x kubectl                                                                           0.3s</span><br><span class="line"> =&gt; [stage-2 2/3] COPY --from=kubectl /output/kubectl /usr/local/bin/                                            0.0s</span><br><span class="line"> =&gt; [stage-2 3/3] COPY --from=terraform /output/terraform /usr/local/bin/                                        0.1s</span><br><span class="line"> =&gt; exporting to image                                                                                           0.1s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                          0.1s</span><br><span class="line"> =&gt; =&gt; writing image sha256:d73ff2cfc061d0b2d15e50a2a2444e294337211a102d1bddf34c78db50213fa8                     0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/app:v2.2                                                                      0.0s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ dils</span><br><span class="line">REPOSITORY      TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">app             v2.2      d73ff2cfc061   59 seconds ago   120MB</span><br><span class="line"></span><br><span class="line">$ docker history app:v2.2</span><br><span class="line">IMAGE          CREATED              CREATED BY                                      SIZE      COMMENT</span><br><span class="line">d73ff2cfc061   About a minute ago   COPY /output/terraform /usr/local/bin/ # bui…   65.2MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      About a minute ago   COPY /output/kubectl /usr/local/bin/ # build…   46.9MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      11 days ago          /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot;]              0B</span><br><span class="line">&lt;missing&gt;      11 days ago          /bin/sh -c #(nop) ADD file:d0764a717d1e9d0af…   7.73MB</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 <code>docker stats -a</code> 观察，不会产生新的中间容器</p>
</blockquote>
<h2 id="多架构"><a href="#多架构" class="headerlink" title="多架构"></a>多架构</h2><h3 id="crane"><a href="#crane" class="headerlink" title="crane"></a>crane</h3><blockquote>
<p>查看镜像的 Manifest</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ crane manifest alpine<span class="punctuation">:</span>latest | jq</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;manifests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b229a85166aadbde58e73e03c5e2b9737fb4642ffb2d98ba453adc90d144c1d8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v6&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:ec299a7ba3c670e38642b0b62a0c779d84b249a3c889757e2b6f841433b4c6fe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v7&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:a0264d60f80df12bc1e6dd98bae6c43debe6667c0ba482711f0d806493467a46&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v8&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:15c46ced65c6abed6a27472a7904b04273e9a8091a5627badd6ff016ab073171&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;386&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b12b826de1ec8c4237aa09a0287e7be8bd317586f32bf6cd9395ec5dba52a3a2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ppc64le&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:5d0da60400afb021f2d8dbfec8b7d26457e77eb8825cba90eba84319133f0efe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s390x&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看镜像某一架构的 Manifest</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ crane manifest alpine<span class="punctuation">:</span>latest@sha256<span class="punctuation">:</span><span class="number">6457</span>d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0 | jq</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.container.image.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1472</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:05455a08881ea9cf0e752bc48e61bbd71a34c029bb13df01e40e3e70e0d007bd&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;layers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">3408729</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>模拟镜像拉取过程（<code>Manifest -&gt; Image -&gt; Layer</code>）</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line">$ crane export -v alpine<span class="punctuation">:</span>latest - | tar xv</span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">20</span> --&gt; GET https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">20</span> GET /v2/ HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> index.docker.io</span><br><span class="line">User-Agent<span class="punctuation">:</span> crane/v0<span class="number">.19</span><span class="number">.0</span> go-containerregistry/v0<span class="number">.19</span><span class="number">.0</span></span><br><span class="line">Accept-Encoding<span class="punctuation">:</span> gzip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">21</span> &lt;-- <span class="number">401</span> https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/ (994.859516ms)</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">21</span> HTTP/<span class="number">1.1</span> <span class="number">401</span> Unauthorized</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">87</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Date<span class="punctuation">:</span> Wed<span class="punctuation">,</span> <span class="number">07</span> Feb <span class="number">2023</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">21</span> GMT</span><br><span class="line">Docker-Distribution-Api-Version<span class="punctuation">:</span> registry/<span class="number">2.0</span></span><br><span class="line">Strict-Transport-Security<span class="punctuation">:</span> max-age=<span class="number">31536000</span></span><br><span class="line">Www-Authenticate<span class="punctuation">:</span> Bearer realm=<span class="string">&quot;https://auth.docker.io/token&quot;</span><span class="punctuation">,</span>service=<span class="string">&quot;registry.docker.io&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="string">&quot;UNAUTHORIZED&quot;</span><span class="punctuation">,</span><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;authentication required&quot;</span><span class="punctuation">,</span><span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">21</span> --&gt; GET https<span class="punctuation">:</span><span class="comment">//auth.docker.io/token?scope=repository%3Alibrary%2Falpine%3Apull&amp;service=registry.docker.io [body redacted: basic token response contains credentials]</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">21</span> GET /token?scope=repository%<span class="number">3</span>Alibrary%<span class="number">2</span>Falpine%<span class="number">3</span>Apull&amp;service=registry.docker.io HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> auth.docker.io</span><br><span class="line">User-Agent<span class="punctuation">:</span> crane/v0<span class="number">.19</span><span class="number">.0</span> go-containerregistry/v0<span class="number">.19</span><span class="number">.0</span></span><br><span class="line">Accept-Encoding<span class="punctuation">:</span> gzip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> &lt;-- <span class="number">200</span> https<span class="punctuation">:</span><span class="comment">//auth.docker.io/token?scope=repository%3Alibrary%2Falpine%3Apull&amp;service=registry.docker.io (1.007807659s) [body redacted: basic token response contains credentials]</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Date<span class="punctuation">:</span> Wed<span class="punctuation">,</span> <span class="number">07</span> Feb <span class="number">2023</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> GMT</span><br><span class="line">Strict-Transport-Security<span class="punctuation">:</span> max-age=<span class="number">31536000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> --&gt; GET https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/library/alpine/manifests/latest</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> GET /v2/library/alpine/manifests/latest HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> index.docker.io</span><br><span class="line">User-Agent<span class="punctuation">:</span> crane/v0<span class="number">.19</span><span class="number">.0</span> go-containerregistry/v0<span class="number">.19</span><span class="number">.0</span></span><br><span class="line">Accept<span class="punctuation">:</span> application/vnd.docker.distribution.manifest.v1+json<span class="punctuation">,</span>application/vnd.docker.distribution.manifest.v1+prettyjws<span class="punctuation">,</span>application/vnd.docker.distribution.manifest.v2+json<span class="punctuation">,</span>application/vnd.oci.image.manifest.v1+json<span class="punctuation">,</span>application/vnd.docker.distribution.manifest.list.v2+json<span class="punctuation">,</span>application/vnd.oci.image.index.v1+json</span><br><span class="line">Authorization<span class="punctuation">:</span> &lt;redacted&gt;</span><br><span class="line">Accept-Encoding<span class="punctuation">:</span> gzip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> &lt;-- <span class="number">200</span> https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/library/alpine/manifests/latest (289.809999ms)</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">1638</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/vnd.docker.distribution.manifest.list.v2+json</span><br><span class="line">Date<span class="punctuation">:</span> Wed<span class="punctuation">,</span> <span class="number">07</span> Feb <span class="number">2023</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> GMT</span><br><span class="line">Docker-Content-Digest<span class="punctuation">:</span> sha256<span class="punctuation">:</span>c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b</span><br><span class="line">Docker-Distribution-Api-Version<span class="punctuation">:</span> registry/<span class="number">2.0</span></span><br><span class="line">Docker-Ratelimit-Source<span class="punctuation">:</span> <span class="number">129.227</span><span class="number">.149</span><span class="number">.221</span></span><br><span class="line">Etag<span class="punctuation">:</span> <span class="string">&quot;sha256:c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b&quot;</span></span><br><span class="line">Ratelimit-Limit<span class="punctuation">:</span> <span class="number">100</span>;w=<span class="number">21600</span></span><br><span class="line">Ratelimit-Remaining<span class="punctuation">:</span> <span class="number">90</span>;w=<span class="number">21600</span></span><br><span class="line">Strict-Transport-Security<span class="punctuation">:</span> max-age=<span class="number">31536000</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;manifests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b229a85166aadbde58e73e03c5e2b9737fb4642ffb2d98ba453adc90d144c1d8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v6&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:ec299a7ba3c670e38642b0b62a0c779d84b249a3c889757e2b6f841433b4c6fe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v7&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:a0264d60f80df12bc1e6dd98bae6c43debe6667c0ba482711f0d806493467a46&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v8&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:15c46ced65c6abed6a27472a7904b04273e9a8091a5627badd6ff016ab073171&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;386&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b12b826de1ec8c4237aa09a0287e7be8bd317586f32bf6cd9395ec5dba52a3a2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ppc64le&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:5d0da60400afb021f2d8dbfec8b7d26457e77eb8825cba90eba84319133f0efe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s390x&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> --&gt; GET https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/library/alpine/manifests/sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> GET /v2/library/alpine/manifests/sha256<span class="punctuation">:</span><span class="number">6457</span>d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0 HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> index.docker.io</span><br><span class="line">User-Agent<span class="punctuation">:</span> crane/v0<span class="number">.19</span><span class="number">.0</span> go-containerregistry/v0<span class="number">.19</span><span class="number">.0</span></span><br><span class="line">Accept<span class="punctuation">:</span> application/vnd.docker.distribution.manifest.v2+json</span><br><span class="line">Authorization<span class="punctuation">:</span> &lt;redacted&gt;</span><br><span class="line">Accept-Encoding<span class="punctuation">:</span> gzip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> &lt;-- <span class="number">200</span> https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/library/alpine/manifests/sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0 (565.099481ms)</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/vnd.docker.distribution.manifest.v2+json</span><br><span class="line">Date<span class="punctuation">:</span> Wed<span class="punctuation">,</span> <span class="number">07</span> Feb <span class="number">2023</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> GMT</span><br><span class="line">Docker-Content-Digest<span class="punctuation">:</span> sha256<span class="punctuation">:</span><span class="number">6457</span>d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0</span><br><span class="line">Docker-Distribution-Api-Version<span class="punctuation">:</span> registry/<span class="number">2.0</span></span><br><span class="line">Docker-Ratelimit-Source<span class="punctuation">:</span> <span class="number">129.227</span><span class="number">.149</span><span class="number">.221</span></span><br><span class="line">Etag<span class="punctuation">:</span> <span class="string">&quot;sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0&quot;</span></span><br><span class="line">Ratelimit-Limit<span class="punctuation">:</span> <span class="number">100</span>;w=<span class="number">21600</span></span><br><span class="line">Ratelimit-Remaining<span class="punctuation">:</span> <span class="number">90</span>;w=<span class="number">21600</span></span><br><span class="line">Strict-Transport-Security<span class="punctuation">:</span> max-age=<span class="number">31536000</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.container.image.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1472</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:05455a08881ea9cf0e752bc48e61bbd71a34c029bb13df01e40e3e70e0d007bd&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;layers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">3408729</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> --&gt; GET https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/library/alpine/blobs/sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8 [body redacted: omitting binary blobs from logs]</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">22</span> GET /v2/library/alpine/blobs/sha256<span class="punctuation">:</span><span class="number">4</span>abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8 HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> index.docker.io</span><br><span class="line">User-Agent<span class="punctuation">:</span> crane/v0<span class="number">.19</span><span class="number">.0</span> go-containerregistry/v0<span class="number">.19</span><span class="number">.0</span></span><br><span class="line">Authorization<span class="punctuation">:</span> &lt;redacted&gt;</span><br><span class="line">Accept-Encoding<span class="punctuation">:</span> gzip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> &lt;-- <span class="number">307</span> https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/library/alpine/blobs/sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8 (243.89499ms) [body redacted: omitting binary blobs from logs]</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> HTTP/<span class="number">1.1</span> <span class="number">307</span> Temporary Redirect</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/octet-stream</span><br><span class="line">Date<span class="punctuation">:</span> Wed<span class="punctuation">,</span> <span class="number">07</span> Feb <span class="number">2023</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> GMT</span><br><span class="line">Docker-Distribution-Api-Version<span class="punctuation">:</span> registry/<span class="number">2.0</span></span><br><span class="line">Location<span class="punctuation">:</span> https<span class="punctuation">:</span><span class="comment">//production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/4a/4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8/data?verify=1707288743-Cy4zDsyi3KttvHMoDxRlm0ey%2BlI%3D</span></span><br><span class="line">Strict-Transport-Security<span class="punctuation">:</span> max-age=<span class="number">31536000</span></span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> --&gt; GET https<span class="punctuation">:</span><span class="comment">//production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/4a/4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8/data?verify=1707288743-Cy4zDsyi3KttvHMoDxRlm0ey%2BlI%3D [body redacted: omitting binary blobs from logs]</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> GET /registry-v2/docker/registry/v2/blobs/sha256/<span class="number">4</span>a/<span class="number">4</span>abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8/data?verify=<span class="number">1707288743</span>-Cy4zDsyi3KttvHMoDxRlm0ey%<span class="number">2</span>BlI%<span class="number">3</span>D HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> production.cloudflare.docker.com</span><br><span class="line">User-Agent<span class="punctuation">:</span> crane/v0<span class="number">.19</span><span class="number">.0</span> go-containerregistry/v0<span class="number">.19</span><span class="number">.0</span></span><br><span class="line">Referer<span class="punctuation">:</span> https<span class="punctuation">:</span><span class="comment">//index.docker.io/v2/library/alpine/blobs/sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8</span></span><br><span class="line">Accept-Encoding<span class="punctuation">:</span> gzip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> &lt;-- <span class="number">200</span> https<span class="punctuation">:</span><span class="comment">//production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/4a/4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8/data?verify=1707288743-Cy4zDsyi3KttvHMoDxRlm0ey%2BlI%3D (182.325023ms) [body redacted: omitting binary blobs from logs]</span></span><br><span class="line"><span class="number">2023</span>/<span class="number">02</span>/<span class="number">07</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> HTTP/<span class="number">2.0</span> <span class="number">200</span> OK</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">3408729</span></span><br><span class="line">Accept-Ranges<span class="punctuation">:</span> bytes</span><br><span class="line">Age<span class="punctuation">:</span> <span class="number">970036</span></span><br><span class="line">Cache-Control<span class="punctuation">:</span> public<span class="punctuation">,</span> max-age=<span class="number">14400</span></span><br><span class="line">Cf-Cache-Status<span class="punctuation">:</span> HIT</span><br><span class="line">Cf-Ray<span class="punctuation">:</span> <span class="number">85196</span>c784e920976-HKG</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/octet-stream</span><br><span class="line">Date<span class="punctuation">:</span> Wed<span class="punctuation">,</span> <span class="number">07</span> Feb <span class="number">2023</span> <span class="number">06</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> GMT</span><br><span class="line">Etag<span class="punctuation">:</span> <span class="string">&quot;a618c0d95d3644232bac3126afb149f9&quot;</span></span><br><span class="line">Expires<span class="punctuation">:</span> Wed<span class="punctuation">,</span> <span class="number">07</span> Feb <span class="number">2023</span> <span class="number">10</span><span class="punctuation">:</span><span class="number">02</span><span class="punctuation">:</span><span class="number">23</span> GMT</span><br><span class="line">Last-Modified<span class="punctuation">:</span> Sat<span class="punctuation">,</span> <span class="number">27</span> Jan <span class="number">2023</span> <span class="number">00</span><span class="punctuation">:</span><span class="number">31</span><span class="punctuation">:</span><span class="number">24</span> GMT</span><br><span class="line">Server<span class="punctuation">:</span> cloudflare</span><br><span class="line">Vary<span class="punctuation">:</span> Accept-Encoding</span><br><span class="line">X-Amz-Id<span class="number">-2</span><span class="punctuation">:</span> nxgqBVRInfsy/+PYjepixKMATpy+iSIBh9FGHqrtS/j7YgRq3bh53lpvx32bePYcT8jx/tajk7k=</span><br><span class="line">X-Amz-Request-Id<span class="punctuation">:</span> <span class="number">322</span>FXJKFDN2ZRHNZ</span><br><span class="line">X-Amz-Server-Side-Encryption<span class="punctuation">:</span> AES256</span><br><span class="line">X-Amz-Version-Id<span class="punctuation">:</span> OSaSg4VWviOKBWIUuIdx3FGSxOHZSoPH</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bin</span><br><span class="line">bin/arch</span><br><span class="line">...</span><br><span class="line">var/tmp</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line">bin  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure>

<blockquote>
<p>复制镜像（所有架构）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ crane cp alpine:latest index.docker.io/zhongmingmao/alpine:latest</span><br><span class="line">2023/02/07 14:22:33 Copying from alpine:latest to index.docker.io/zhongmingmao/alpine:latest</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:30c69795e46bd167df7f6152056f3c885cba4f5b4238e2327c73fb35c226d351</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:4abcf20661432fb2d719aaf90656f55c287f8ca915dc1c92ec14ff61e67fbaf8</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:05455a08881ea9cf0e752bc48e61bbd71a34c029bb13df01e40e3e70e0d007bd</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:bca4290a96390d7a6fc6f2f9929370d06f8dfcacba591c76e3d5c5044e7f420c</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:0dc2e6c0f9ded2daeca96bbf270526d182d2f4267f5c7610c222c05cad6f6b96</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:935b61847fc465ff70ecbd3436253a7596a500e649a16014646a99393ccbb661</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:fda0ff469afd28d9cfbb946e8e0a3c911c591a2691bea62be9187e45a1c50549</span><br><span class="line">2023/02/07 14:22:43 mounted blob: sha256:ace17d5d883e9ea5a21138d0608d60aa2376c68f616c55b0b7e73fba6d8556a3</span><br><span class="line">2023/02/07 14:22:44 index.docker.io/zhongmingmao/alpine@sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0: digest: sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0 size: 528</span><br><span class="line">2023/02/07 14:22:44 index.docker.io/zhongmingmao/alpine@sha256:b229a85166aadbde58e73e03c5e2b9737fb4642ffb2d98ba453adc90d144c1d8: digest: sha256:b229a85166aadbde58e73e03c5e2b9737fb4642ffb2d98ba453adc90d144c1d8 size: 528</span><br><span class="line">2023/02/07 14:22:44 index.docker.io/zhongmingmao/alpine@sha256:a0264d60f80df12bc1e6dd98bae6c43debe6667c0ba482711f0d806493467a46: digest: sha256:a0264d60f80df12bc1e6dd98bae6c43debe6667c0ba482711f0d806493467a46 size: 528</span><br><span class="line">2023/02/07 14:22:44 index.docker.io/zhongmingmao/alpine@sha256:ec299a7ba3c670e38642b0b62a0c779d84b249a3c889757e2b6f841433b4c6fe: digest: sha256:ec299a7ba3c670e38642b0b62a0c779d84b249a3c889757e2b6f841433b4c6fe size: 528</span><br><span class="line">2023/02/07 14:22:45 mounted blob: sha256:f4968021da4ff8b74325e5aebf0f9448b44becfdd14df80ecba474e43cc92546</span><br><span class="line">2023/02/07 14:22:45 mounted blob: sha256:4a0759b5afbffdc507fbb4e32b3a139063c3a5c0829f811973850447f98830ae</span><br><span class="line">2023/02/07 14:22:45 mounted blob: sha256:5b984dd0323cee557fb6a9d8796f4b4414317cf1fb88bb2047d2046ac9447d77</span><br><span class="line">2023/02/07 14:22:45 mounted blob: sha256:8fc740d8c40e45ea330a3f324fe009148dfc1f771bc90254eaf8ff8bbcecfe02</span><br><span class="line">2023/02/07 14:22:45 mounted blob: sha256:2d433224a9f8f46c545c8fc4bc82ea382227d892e9f0c704d90ef585542bf497</span><br><span class="line">2023/02/07 14:22:46 mounted blob: sha256:eb8fba61d86413beda3240c40c599041e040e658cd8314e38ee15e67ea57d349</span><br><span class="line">2023/02/07 14:22:46 index.docker.io/zhongmingmao/alpine@sha256:b12b826de1ec8c4237aa09a0287e7be8bd317586f32bf6cd9395ec5dba52a3a2: digest: sha256:b12b826de1ec8c4237aa09a0287e7be8bd317586f32bf6cd9395ec5dba52a3a2 size: 528</span><br><span class="line">2023/02/07 14:22:46 index.docker.io/zhongmingmao/alpine@sha256:15c46ced65c6abed6a27472a7904b04273e9a8091a5627badd6ff016ab073171: digest: sha256:15c46ced65c6abed6a27472a7904b04273e9a8091a5627badd6ff016ab073171 size: 528</span><br><span class="line">2023/02/07 14:22:46 index.docker.io/zhongmingmao/alpine@sha256:5d0da60400afb021f2d8dbfec8b7d26457e77eb8825cba90eba84319133f0efe: digest: sha256:5d0da60400afb021f2d8dbfec8b7d26457e77eb8825cba90eba84319133f0efe size: 528</span><br><span class="line">2023/02/07 14:22:46 index.docker.io/zhongmingmao/alpine:latest: digest: sha256:c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b size: 1638</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ crane manifest zhongmingmao/alpine<span class="punctuation">:</span>latest | jq</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;manifests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b229a85166aadbde58e73e03c5e2b9737fb4642ffb2d98ba453adc90d144c1d8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v6&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:ec299a7ba3c670e38642b0b62a0c779d84b249a3c889757e2b6f841433b4c6fe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v7&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:a0264d60f80df12bc1e6dd98bae6c43debe6667c0ba482711f0d806493467a46&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v8&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:15c46ced65c6abed6a27472a7904b04273e9a8091a5627badd6ff016ab073171&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;386&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b12b826de1ec8c4237aa09a0287e7be8bd317586f32bf6cd9395ec5dba52a3a2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ppc64le&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:5d0da60400afb021f2d8dbfec8b7d26457e77eb8825cba90eba84319133f0efe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s390x&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207142836765.png" alt="image-20240207142836765"></p>
<blockquote>
<p>查看镜像的所有 Tag</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ crane ls zhongmingmao/alpine</span><br><span class="line">latest</span><br></pre></td></tr></table></figure>

<h3 id="BuildKit-3"><a href="#BuildKit-3" class="headerlink" title="BuildKit"></a>BuildKit</h3><blockquote>
<p>基于 <code>qemu</code> 虚拟化技术</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$ builder=builderx</span><br><span class="line"></span><br><span class="line">$ docker buildx prune -a -f --verbose</span><br><span class="line">Total:    0B</span><br><span class="line"></span><br><span class="line">$ docker buildx stop $&#123;builder&#125; &amp;&amp; docker buildx rm $&#123;builder&#125;</span><br><span class="line">builderx removed</span><br><span class="line"></span><br><span class="line">$ docker buildx create --name=$&#123;builder&#125; --driver docker-container --platform linux/amd64,linux/arm64/v8</span><br><span class="line">builderx</span><br><span class="line"></span><br><span class="line">$ docker buildx inspect --bootstrap --builder $&#123;builder&#125;</span><br><span class="line">[+] Building 16.7s (1/1) FINISHED</span><br><span class="line"> =&gt; [internal] booting buildkit                                                                                                  16.7s</span><br><span class="line"> =&gt; =&gt; pulling image moby/buildkit:buildx-stable-1                                                                               16.4s</span><br><span class="line"> =&gt; =&gt; creating container buildx_buildkit_builderx0                                                                               0.4s</span><br><span class="line">Name:          builderx</span><br><span class="line">Driver:        docker-container</span><br><span class="line">Last Activity: 2023-02-07 07:16:19 +0000 UTC</span><br><span class="line"></span><br><span class="line">Nodes:</span><br><span class="line">Name:      builderx0</span><br><span class="line">Endpoint:  unix:///var/run/docker.sock</span><br><span class="line">Status:    running</span><br><span class="line">Buildkit:  v0.9.3</span><br><span class="line">Platforms: linux/amd64*, linux/arm64*</span><br><span class="line">Labels:</span><br><span class="line"> org.mobyproject.buildkit.worker.executor:    oci</span><br><span class="line"> org.mobyproject.buildkit.worker.hostname:    c11aa7b46da1</span><br><span class="line"> org.mobyproject.buildkit.worker.snapshotter: overlayfs</span><br><span class="line">GC Policy rule#0:</span><br><span class="line"> All:           false</span><br><span class="line"> Filters:       type==source.local,type==exec.cachemount,type==source.git.checkout</span><br><span class="line"> Keep Duration: 48h0m0s</span><br><span class="line"> Keep Bytes:    488.3MiB</span><br><span class="line">GC Policy rule#1:</span><br><span class="line"> All:           false</span><br><span class="line"> Keep Duration: 1440h0m0s</span><br><span class="line"> Keep Bytes:    2.794GiB</span><br><span class="line">GC Policy rule#2:</span><br><span class="line"> All:        false</span><br><span class="line"> Keep Bytes: 2.794GiB</span><br><span class="line">GC Policy rule#3:</span><br><span class="line"> All:        true</span><br><span class="line"> Keep Bytes: 2.794GiB</span><br><span class="line"></span><br><span class="line">$ docker buildx build --no-cache --builder $&#123;builder&#125; --platform linux/amd64,linux/arm64/v8 -t zhongmingmao/multi-arch-app:v1 --push .</span><br><span class="line">[+] Building 215.0s (14/14) FINISHED                                                                         docker-container:builderx</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                                              0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 208B                                                                                              0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                                 0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                                   0.0s</span><br><span class="line"> =&gt; [linux/arm64 internal] load metadata for docker.io/library/ubuntu:22.04                                                       4.9s</span><br><span class="line"> =&gt; [linux/amd64 internal] load metadata for docker.io/library/ubuntu:22.04                                                       5.2s</span><br><span class="line"> =&gt; [auth] library/ubuntu:pull token for registry-1.docker.io                                                                     0.0s</span><br><span class="line"> =&gt; [auth] library/ubuntu:pull token for registry-1.docker.io                                                                     0.0s</span><br><span class="line"> =&gt; [linux/arm64 1/2] FROM docker.io/library/ubuntu:22.04@sha256:e9569c25505f33ff72e88b2990887c9dcf230f23259da296eb814fc2b41af9  84.0s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/ubuntu:22.04@sha256:e9569c25505f33ff72e88b2990887c9dcf230f23259da296eb814fc2b41af999             0.0s</span><br><span class="line"> =&gt; =&gt; sha256:b91d8878f844c327b4ff924d4973661a399f10256ed50ac7c640b30c5894166b 27.36MB / 27.36MB                                 83.4s</span><br><span class="line"> =&gt; =&gt; extracting sha256:b91d8878f844c327b4ff924d4973661a399f10256ed50ac7c640b30c5894166b                                         0.5s</span><br><span class="line"> =&gt; [linux/amd64 1/2] FROM docker.io/library/ubuntu:22.04@sha256:e9569c25505f33ff72e88b2990887c9dcf230f23259da296eb814fc2b41af9  92.0s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/ubuntu:22.04@sha256:e9569c25505f33ff72e88b2990887c9dcf230f23259da296eb814fc2b41af999             0.0s</span><br><span class="line"> =&gt; =&gt; sha256:57c139bbda7eb92a286d974aa8fef81acf1a8cbc742242619252c13b196ab499 29.55MB / 29.55MB                                 91.5s</span><br><span class="line"> =&gt; =&gt; extracting sha256:57c139bbda7eb92a286d974aa8fef81acf1a8cbc742242619252c13b196ab499                                         0.5s</span><br><span class="line"> =&gt; [linux/arm64 2/2] WORKDIR /app                                                                                                0.1s</span><br><span class="line"> =&gt; [linux/amd64 2/2] WORKDIR /app                                                                                                0.1s</span><br><span class="line"> =&gt; exporting to image                                                                                                          117.7s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                                           0.1s</span><br><span class="line"> =&gt; =&gt; exporting manifest sha256:4f07d70eca595adfc262e92b55f8fa0fbcaa940b5735fbc04b13a9125f326ddb                                 0.0s</span><br><span class="line"> =&gt; =&gt; exporting config sha256:893c15d5e83641903282025e37593a13a331f4b908c34145b316a14cf871b309                                   0.0s</span><br><span class="line"> =&gt; =&gt; exporting manifest sha256:45a4ce63c5864fea36890252e8cfa259bffc1a229741f5139fca2c2172401e8a                                 0.0s</span><br><span class="line"> =&gt; =&gt; exporting config sha256:41cb3eff104dbd8cf3e43b276a07e31d5e3ee6da4ab1e8ca0c47e3168d8bb93b                                   0.0s</span><br><span class="line"> =&gt; =&gt; exporting manifest list sha256:52b1a891cf23bd3fc512f300a9f3a5510d70434571193726e6abd1894c492481                            0.0s</span><br><span class="line"> =&gt; =&gt; pushing layers                                                                                                           113.9s</span><br><span class="line"> =&gt; =&gt; pushing manifest for docker.io/zhongmingmao/multi-arch-app:v1@sha256:52b1a891cf23bd3fc512f300a9f3a5510d70434571193726e6ab  3.7s</span><br><span class="line"> =&gt; [auth] zhongmingmao/multi-arch-app:pull,push token for registry-1.docker.io                                                   0.0s</span><br><span class="line"> =&gt; [auth] zhongmingmao/multi-arch-app:pull,push token for registry-1.docker.io                                                   0.0s</span><br><span class="line"> =&gt; [auth] zhongmingmao/multi-arch-app:pull,push token for registry-1.docker.io                                                   0.0s</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207153242370.png" alt="image-20240207153242370"></p>
<h1 id="OCI"><a href="#OCI" class="headerlink" title="OCI"></a>OCI</h1><blockquote>
<p>OCI - <code>Open Container Initiative</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207170723854.png" alt="image-20240207170723854"></p>
<h1 id="runc"><a href="#runc" class="headerlink" title="runc"></a>runc</h1><blockquote>
<p>runc - <code>Open Container Initiative runtime</code></p>
</blockquote>
<blockquote>
<p>runc is a command line client for running applications packaged according to<br>the Open Container Initiative (OCI) format and is a compliant implementation of the<br>Open Container Initiative specification.</p>
</blockquote>
<blockquote>
<p>Containers are configured using <code>bundles</code>. A bundle for a container is a directory<br>that includes a specification file named “<code>config.json</code>“ and a <code>root filesystem</code>.<br>The root filesystem contains the contents of the container.</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207171252044.png" alt="image-20240207171252044"></p>
<h2 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /tmp/rootfs</span><br><span class="line"></span><br><span class="line">$ cd /tmp/rootfs</span><br><span class="line"></span><br><span class="line">$ crane manifest alpine<span class="punctuation">:</span>latest | jq</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;manifests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:6457d53fb065d6f250e1504b9bc42d5b6c65941d57532c072d929dd0628977d0&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b229a85166aadbde58e73e03c5e2b9737fb4642ffb2d98ba453adc90d144c1d8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v6&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:ec299a7ba3c670e38642b0b62a0c779d84b249a3c889757e2b6f841433b4c6fe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v7&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:a0264d60f80df12bc1e6dd98bae6c43debe6667c0ba482711f0d806493467a46&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v8&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:15c46ced65c6abed6a27472a7904b04273e9a8091a5627badd6ff016ab073171&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;386&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b12b826de1ec8c4237aa09a0287e7be8bd317586f32bf6cd9395ec5dba52a3a2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ppc64le&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:5d0da60400afb021f2d8dbfec8b7d26457e77eb8825cba90eba84319133f0efe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s390x&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">528</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ arch</span><br><span class="line">aarch64</span><br><span class="line"></span><br><span class="line">$ crane export alpine:latest@sha256:a0264d60f80df12bc1e6dd98bae6c43debe6667c0ba482711f0d806493467a46 - | tar xv</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">bin  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure>

<h2 id="config-json"><a href="#config-json" class="headerlink" title="config.json"></a>config.json</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /tmp/</span><br><span class="line"></span><br><span class="line">$ runc spec</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ociVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.2-dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;process&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;terminal&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;gid&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;sh&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;TERM=xterm&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bounding&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;CAP_AUDIT_WRITE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_KILL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;effective&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;CAP_AUDIT_WRITE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_KILL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;permitted&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;CAP_AUDIT_WRITE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_KILL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ambient&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;CAP_AUDIT_WRITE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_KILL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CAP_NET_BIND_SERVICE&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rlimits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RLIMIT_NOFILE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hard&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;soft&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;noNewPrivileges&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;root&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rootfs&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;readonly&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/proc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;proc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;proc&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tmpfs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tmpfs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;nosuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;strictatime&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;mode=755&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;size=65536k&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/dev/pts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;devpts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;devpts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;nosuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;noexec&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;newinstance&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;ptmxmode=0666&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;mode=0620&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;gid=5&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/dev/shm&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tmpfs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shm&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;nosuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;noexec&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;nodev&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;mode=1777&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;size=65536k&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/dev/mqueue&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mqueue&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mqueue&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;nosuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;noexec&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;nodev&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/sys&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sysfs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sysfs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;nosuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;noexec&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;nodev&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;ro&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/sys/fs/cgroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cgroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cgroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;nosuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;noexec&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;nodev&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;relatime&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;ro&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;linux&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;devices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;allow&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;access&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rwm&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;namespaces&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pid&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;network&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ipc&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uts&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mount&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cgroup&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maskedPaths&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;/proc/acpi&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/asound&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/kcore&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/keys&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/latency_stats&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/timer_list&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/timer_stats&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/sched_debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/sys/firmware&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/scsi&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;readonlyPaths&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;/proc/bus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/fs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/irq&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/sys&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/proc/sysrq-trigger&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><blockquote>
<p>启动容器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ runc run runc-app</span><br><span class="line">/ # hostname</span><br><span class="line">runc</span><br><span class="line">/ #</span><br><span class="line">/ # ps aux</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">    8 root      0:00 ps aux</span><br><span class="line">/ #</span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看容器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ runc list</span><br><span class="line">ID          PID         STATUS      BUNDLE      CREATED                         OWNER</span><br><span class="line">runc-app    16571       running     /tmp        2023-02-07T10:10:38.98848122Z   root</span><br><span class="line"></span><br><span class="line">$ runc state runc-app</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ociVersion&quot;: &quot;1.0.2-dev&quot;,</span><br><span class="line">  &quot;id&quot;: &quot;runc-app&quot;,</span><br><span class="line">  &quot;pid&quot;: 16571,</span><br><span class="line">  &quot;status&quot;: &quot;running&quot;,</span><br><span class="line">  &quot;bundle&quot;: &quot;/tmp&quot;,</span><br><span class="line">  &quot;rootfs&quot;: &quot;/tmp/rootfs&quot;,</span><br><span class="line">  &quot;created&quot;: &quot;2023-02-07T10:10:38.98848122Z&quot;,</span><br><span class="line">  &quot;owner&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ runc exec -t runc-app sh</span><br><span class="line">/ # hostname</span><br><span class="line">runc</span><br><span class="line">/ #</span><br><span class="line">/ # ls</span><br><span class="line">bin    etc    lib    mnt    proc   run    srv    tmp    var</span><br><span class="line">dev    home   media  opt    root   sbin   sys    usr</span><br><span class="line">/ #</span><br><span class="line">/ # cat /etc/issue</span><br><span class="line">Welcome to Alpine Linux 3.19</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<blockquote>
<p>二次开发：<a target="_blank" rel="noopener" href="https://github.com/opencontainers">https://github.com/opencontainers</a></p>
</blockquote>
<h1 id="Manifest"><a href="#Manifest" class="headerlink" title="Manifest"></a>Manifest</h1><table>
<thead>
<tr>
<th>Type</th>
<th>Item</th>
</tr>
</thead>
<tbody><tr>
<td>Workload</td>
<td><em>Deployment</em></td>
</tr>
<tr>
<td></td>
<td><em>StatefulSet</em></td>
</tr>
<tr>
<td></td>
<td>DaemonSet</td>
</tr>
<tr>
<td></td>
<td>Job</td>
</tr>
<tr>
<td></td>
<td>CronJob</td>
</tr>
<tr>
<td>Service</td>
<td><em>ClusterIP</em></td>
</tr>
<tr>
<td></td>
<td>NodePort</td>
</tr>
<tr>
<td></td>
<td><em>Loadbalancer</em></td>
</tr>
<tr>
<td></td>
<td>Headless - StatefulSet</td>
</tr>
<tr>
<td></td>
<td><em>Ingress</em></td>
</tr>
<tr>
<td><em>Config</em></td>
<td>ConfigMap</td>
</tr>
<tr>
<td></td>
<td>Secret</td>
</tr>
<tr>
<td><em>HPA</em></td>
<td></td>
</tr>
<tr>
<td><em>Storage</em></td>
<td>StorageClass</td>
</tr>
<tr>
<td></td>
<td>PV &#x2F; PVC</td>
</tr>
</tbody></table>
<h2 id="kubectl-create"><a href="#kubectl-create" class="headerlink" title="kubectl create"></a>kubectl create</h2><blockquote>
<p>使用 kubectl create 命令来生成 YAML 模板</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">create</span> <span class="string">deployment</span> <span class="string">nginx</span> <span class="string">--image=nginx</span> <span class="string">-oyaml</span> <span class="string">--dry-run=client</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">create</span> <span class="string">service</span> <span class="string">clusterip</span> <span class="string">my-cs</span> <span class="string">--tcp=5678:8080</span> <span class="string">-oyaml</span> <span class="string">--dry-run=client</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-cs</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-cs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">5678</span><span class="number">-8080</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5678</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-cs</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">create</span> <span class="string">configmap</span> <span class="string">my-cm</span> <span class="string">--from-literal=name=zhongmingmao</span> <span class="string">--from-literal=city=gz</span> <span class="string">-oyaml</span> <span class="string">--dry-run=client</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">city:</span> <span class="string">gz</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhongmingmao</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-cm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ k create configmap --help</span><br></pre></td></tr></table></figure>

<h2 id="文件合并"><a href="#文件合并" class="headerlink" title="文件合并"></a>文件合并</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">app-1</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">app-2</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h2 id="挪威问题"><a href="#挪威问题" class="headerlink" title="挪威问题"></a>挪威问题</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NORWAY</span></span><br><span class="line">        <span class="attr">value:</span> <span class="literal">NO</span> <span class="comment"># NO 会被转换为布尔值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">y|Y|yes|Yes|YES|n|N|no|No|NO</span><br><span class="line">|true|True|TRUE|false|False|FALSE</span><br><span class="line">|on|On|ON|off|Off|OFF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不确定时，用<code>双引号</code>包裹</p>
</blockquote>
<h2 id="保留关键字"><a href="#保留关键字" class="headerlink" title="保留关键字"></a>保留关键字</h2><blockquote>
<p>保留关键字不能作为 <code>Key</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">on:</span> <span class="string">&quot;yes&quot;</span> <span class="comment"># 自动转换为 True: &quot;yes&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NORWAY</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">1.10</span> <span class="comment"># 自动转换为数字 1.1，需要用引号包裹</span></span><br></pre></td></tr></table></figure>

<h2 id="多行内容"><a href="#多行内容" class="headerlink" title="多行内容"></a>多行内容</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key1:</span> <span class="string">&gt;</span>   <span class="comment"># 不保留文字间的换行 + 保留末尾换行</span></span><br><span class="line">  <span class="string">xxx</span></span><br><span class="line">  <span class="string">yyy</span></span><br><span class="line"><span class="attr">key2:</span> <span class="string">&gt;-</span>  <span class="comment"># 不保留文字间的换行 + 不保留末尾换行</span></span><br><span class="line">  <span class="string">xxx</span></span><br><span class="line">  <span class="string">yyy</span></span><br><span class="line"><span class="attr">key3:</span> <span class="string">|</span>   <span class="comment"># 保留文字间的换行 + 保留末尾换行</span></span><br><span class="line">  <span class="string">xxx</span></span><br><span class="line">  <span class="string">yyy</span></span><br><span class="line"><span class="attr">key4:</span> <span class="string">|-</span>  <span class="comment"># 保留文字间的换行 + 不保留末尾换行</span></span><br><span class="line">  <span class="string">xxx</span></span><br><span class="line">  <span class="string">yyy</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207210233611.png" alt="image-20240207210233611"></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><blockquote>
<p>比较少用</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207211001028.png" alt="image-20240207211001028"></p>
<h1 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h1><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207215205288.png" alt="image-20240207215205288"></p>
<h2 id="Manifest-1"><a href="#Manifest-1" class="headerlink" title="Manifest"></a>Manifest</h2><h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- k8s-specifications</span><br><span class="line">|   |-- db-deployment.yaml</span><br><span class="line">|   |-- db-service.yaml</span><br><span class="line">|   |-- redis-deployment.yaml</span><br><span class="line">|   |-- redis-service.yaml</span><br><span class="line">|   |-- result-deployment.yaml</span><br><span class="line">|   |-- result-service.yaml</span><br><span class="line">|   |-- vote-deployment.yaml</span><br><span class="line">|   |-- vote-service.yaml</span><br><span class="line">|   `-- worker-deployment.yaml</span><br><span class="line">|-- result</span><br><span class="line">|   |-- docker-compose.test.yml</span><br><span class="line">|   |-- Dockerfile</span><br><span class="line">|   |-- package.json</span><br><span class="line">|   |-- package-lock.json</span><br><span class="line">|   |-- server.js</span><br><span class="line">|   |-- tests</span><br><span class="line">|   |   |-- Dockerfile</span><br><span class="line">|   |   |-- render.js</span><br><span class="line">|   |   `-- tests.sh</span><br><span class="line">|   `-- views</span><br><span class="line">|       |-- angular.min.js</span><br><span class="line">|       |-- app.js</span><br><span class="line">|       |-- index.html</span><br><span class="line">|       |-- socket.io.js</span><br><span class="line">|       `-- stylesheets</span><br><span class="line">|           `-- style.css</span><br><span class="line">|-- seed-data</span><br><span class="line">|   |-- Dockerfile</span><br><span class="line">|   |-- generate-votes.sh</span><br><span class="line">|   `-- make-data.py</span><br><span class="line">|-- vote</span><br><span class="line">|   |-- app.py</span><br><span class="line">|   |-- Dockerfile</span><br><span class="line">|   |-- requirements.txt</span><br><span class="line">|   |-- static</span><br><span class="line">|   |   `-- stylesheets</span><br><span class="line">|   |       `-- style.css</span><br><span class="line">|   `-- templates</span><br><span class="line">|       `-- index.html</span><br><span class="line">`-- worker</span><br><span class="line">    |-- Dockerfile</span><br><span class="line">    |-- Program.cs</span><br><span class="line">    `-- Worker.csproj</span><br></pre></td></tr></table></figure>

<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ k --kubeconfig ~/.kube/devops-camp apply -f k8s-specifications</span><br><span class="line">deployment.apps/db created</span><br><span class="line">service/db created</span><br><span class="line">deployment.apps/redis created</span><br><span class="line">service/redis created</span><br><span class="line">deployment.apps/result created</span><br><span class="line">service/result created</span><br><span class="line">deployment.apps/vote created</span><br><span class="line">service/vote created</span><br><span class="line">deployment.apps/worker created</span><br><span class="line"></span><br><span class="line">$ k --kubeconfig ~/.kube/devops-camp get pod -A</span><br><span class="line">NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   local-path-provisioner-69dff9496c-8rjh2   1/1     Running   0          8m52s</span><br><span class="line">kube-system   coredns-8b9777675-bm792                   1/1     Running   0          8m52s</span><br><span class="line">kube-system   metrics-server-854c559bd-nqpf9            1/1     Running   0          8m52s</span><br><span class="line">default       redis-79f984f6b5-m25sm                    1/1     Running   0          70s</span><br><span class="line">default       db-579b55967d-c9bp7                       1/1     Running   0          70s</span><br><span class="line">default       result-5c4b4bf59c-hnbdr                   1/1     Running   0          69s</span><br><span class="line">default       vote-97d848469-4fmmd                      1/1     Running   0          69s</span><br><span class="line">default       worker-549b9c46d8-6tbmz                   1/1     Running   0          69s</span><br><span class="line"></span><br><span class="line">$ k --kubeconfig ~/.kube/devops-camp get svc -owide</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE     SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.43.0.1       &lt;none&gt;        443/TCP          10m     &lt;none&gt;</span><br><span class="line">db           ClusterIP   10.43.89.33     &lt;none&gt;        5432/TCP         2m25s   app=db</span><br><span class="line">redis        ClusterIP   10.43.239.164   &lt;none&gt;        6379/TCP         2m25s   app=redis</span><br><span class="line">result       NodePort    10.43.7.237     &lt;none&gt;        5001:31001/TCP   2m24s   app=result</span><br><span class="line">vote         NodePort    10.43.153.143   &lt;none&gt;        5000:31000/TCP   2m24s   app=vote</span><br></pre></td></tr></table></figure>

<blockquote>
<p>投票</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207222429742.png" alt="image-20240207222429742"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240207222451153.png" alt="image-20240207222451153"></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="Vote"><a href="#Vote" class="headerlink" title="Vote"></a>Vote</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    voter_id = request.cookies.get(<span class="string">&#x27;voter_id&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> voter_id:</span><br><span class="line">        voter_id = <span class="built_in">hex</span>(random.getrandbits(<span class="number">64</span>))[<span class="number">2</span>:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    vote = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        redis = get_redis()</span><br><span class="line">        vote = request.form[<span class="string">&#x27;vote&#x27;</span>]</span><br><span class="line">        app.logger.info(<span class="string">&#x27;Received vote for %s&#x27;</span>, vote)</span><br><span class="line">        data = json.dumps(&#123;<span class="string">&#x27;voter_id&#x27;</span>: voter_id, <span class="string">&#x27;vote&#x27;</span>: vote&#125;)</span><br><span class="line">        redis.rpush(<span class="string">&#x27;votes&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line">    resp = make_response(render_template(</span><br><span class="line">        <span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">        option_a=option_a,</span><br><span class="line">        option_b=option_b,</span><br><span class="line">        hostname=hostname,</span><br><span class="line">        vote=vote,</span><br><span class="line">    ))</span><br><span class="line">    resp.set_cookie(<span class="string">&#x27;voter_id&#x27;</span>, voter_id)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<h4 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Slow down to prevent CPU spike, only query each 100ms</span></span><br><span class="line">    Thread.Sleep(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reconnect redis if down</span></span><br><span class="line">    <span class="keyword">if</span> (redisConn == <span class="literal">null</span> || !redisConn.IsConnected) &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Reconnecting Redis&quot;</span>);</span><br><span class="line">        redisConn = OpenRedisConnection(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        redis = redisConn.GetDatabase();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">string</span> json = redis.ListLeftPopAsync(<span class="string">&quot;votes&quot;</span>).Result;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> vote = JsonConvert.DeserializeAnonymousType(json, definition);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Processing vote for &#x27;<span class="subst">&#123;vote.vote&#125;</span>&#x27; by &#x27;<span class="subst">&#123;vote.voter_id&#125;</span>&#x27;&quot;</span>);</span><br><span class="line">        <span class="comment">// Reconnect DB if down</span></span><br><span class="line">        <span class="keyword">if</span> (!pgsql.State.Equals(System.Data.ConnectionState.Open))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Reconnecting DB&quot;</span>);</span><br><span class="line">            pgsql = OpenDbConnection(<span class="string">&quot;Server=db;Username=postgres;Password=postgres;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; <span class="comment">// Normal +1 vote requested</span></span><br><span class="line">            UpdateVote(pgsql, vote.voter_id, vote.vote);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        keepAliveCommand.ExecuteNonQuery();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>.<span class="title function_">retry</span>(</span><br><span class="line">  &#123;<span class="attr">times</span>: <span class="number">1000</span>, <span class="attr">interval</span>: <span class="number">1000</span>&#125;,</span><br><span class="line">  <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    pool.<span class="title function_">connect</span>(<span class="keyword">function</span>(<span class="params">err, client, done</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Waiting for db&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">callback</span>(err, client);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">function</span>(<span class="params">err, client</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Giving up&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Connected to db&quot;</span>);</span><br><span class="line">    <span class="title function_">getVotes</span>(client);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getVotes</span>(<span class="params">client</span>) &#123;</span><br><span class="line">  client.<span class="title function_">query</span>(<span class="string">&#x27;SELECT vote, COUNT(id) AS count FROM votes GROUP BY vote&#x27;</span>, [], <span class="keyword">function</span>(<span class="params">err, result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error performing query: &quot;</span> + err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> votes = <span class="title function_">collectVotesFromResult</span>(result);</span><br><span class="line">      io.<span class="property">sockets</span>.<span class="title function_">emit</span>(<span class="string">&quot;scores&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(votes)); <span class="comment">// 数据实时刷新</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;<span class="title function_">getVotes</span>(client) &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Dockerfile-1"><a href="#Dockerfile-1" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><blockquote>
<p>对于 node.js，使用 <code>tini</code> 作为 1 号进程，否则会产生很多<code>僵尸进程</code></p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">18</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># add curl for healthcheck</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install -y --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    tini \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># have nodemon available for local dev use (file watching)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install -g nodemon</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm ci \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; npm cache clean --force \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; <span class="built_in">mv</span> /app/node_modules /node_modules</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PORT <span class="number">80</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/tini&quot;</span>, <span class="string">&quot;--&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;server.js&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="服务依赖"><a href="#服务依赖" class="headerlink" title="服务依赖"></a>服务依赖</h3><blockquote>
<ol>
<li>通过 <code>initContainers</code> 使用 <code>k8s-wait-for</code> 来控制 Pod 的<code>启动顺序</code></li>
<li>基于<code>指数退让</code>，大规模应用集合的启动时间可能会很久</li>
</ol>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">develop-oneprovider-krakow</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">develop-oneprovider-krakow</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">oneprovider-krakow</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">develop</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">Tiller</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">oneprovider</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;0.2.17&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">develop-oneprovider-krakow</span></span><br><span class="line">      <span class="attr">chart:</span> <span class="string">oneprovider-krakow</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">develop</span></span><br><span class="line">      <span class="attr">heritage:</span> <span class="string">Tiller</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">&quot;oneprovider&quot;</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">develop-oneprovider-krakow</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">develop-oneprovider-krakow</span></span><br><span class="line">        <span class="attr">chart:</span> <span class="string">oneprovider-krakow</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">develop</span></span><br><span class="line">        <span class="attr">heritage:</span> <span class="string">Tiller</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">&quot;oneprovider&quot;</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">&quot;0.2.17&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait-for-onezone</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">ghcr.io/groundnuty/k8s-wait-for:v1.6</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;job&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;develop-onezone-ready-check&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait-for-volume-ceph</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">ghcr.io/groundnuty/k8s-wait-for:v1.6</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;pod&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;-lapp=develop-volume-ceph-krakow&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait-for-volume-gluster</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">ghcr.io/groundnuty/k8s-wait-for:v1.6</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;pod&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;-lapp=develop-volume-gluster-krakow&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">oneprovider</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.onedata.org/oneprovider:ID-a3a9ff0d78</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<h3 id="数据初始化"><a href="#数据初始化" class="headerlink" title="数据初始化"></a>数据初始化</h3><ol>
<li>业务代码负责初始化</li>
<li>通过 <code>K8S Job</code> 进行初始化</li>
</ol>
<h1 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h1><blockquote>
<p><code>动态 Manifests</code></p>
</blockquote>
<ol>
<li>管理 K8S 对象</li>
<li>将多个微服务的工作负载、配置对象等<code>封装</code>成一个应用</li>
<li>屏蔽终端用户使用的复杂度</li>
<li><code>参数化</code>、<code>模板化</code>，支持多环境</li>
</ol>
<h2 id="Helm-Chart"><a href="#Helm-Chart" class="headerlink" title="Helm Chart"></a>Helm Chart</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/bitnami/charts">https://github.com/bitnami/charts</a></li>
<li><a target="_blank" rel="noopener" href="https://artifacthub.io/">https://artifacthub.io</a></li>
</ol>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><table>
<thead>
<tr>
<th>Concepts</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>Chart</code></td>
<td>K8S 应用安装包，包含应用的 K8S 对象，用于创建实例</td>
</tr>
<tr>
<td><code>Release</code></td>
<td>使用默认或者特定参数安装的 Helm 实例（<code>运行中</code>的实例）</td>
</tr>
<tr>
<td><code>Repository</code></td>
<td>用于<code>存储</code>和<code>分发</code> Helm Chart 仓库（<code>Git</code>、<code>OCI</code>）</td>
</tr>
</tbody></table>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><table>
<thead>
<tr>
<th>Command</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>install</td>
<td>安装 Helm Chart</td>
</tr>
<tr>
<td><code>uninstall</code></td>
<td>卸载 Helm Chart，不会删除 <code>PVC</code> 和 <code>PV</code></td>
</tr>
<tr>
<td>get &#x2F; status &#x2F; list</td>
<td>获取 Helm Release 信息（存储在 <code>K8S Secret</code> 中）</td>
</tr>
<tr>
<td>repo add &#x2F; list &#x2F; remove &#x2F; index</td>
<td>Repository 相关命令</td>
</tr>
<tr>
<td>search</td>
<td>在 Repository 中查找 Helm Chart</td>
</tr>
<tr>
<td><code>create</code> &#x2F; <code>package</code></td>
<td>创建和打包 Helm Chart</td>
</tr>
<tr>
<td><code>pull</code></td>
<td>拉取 Helm Chart</td>
</tr>
</tbody></table>
<h2 id="Scratch"><a href="#Scratch" class="headerlink" title="Scratch"></a>Scratch</h2><blockquote>
<p>创建 Helm Chart<br>templates 为 manifests 模板，charts 为<code>依赖</code>的子 Chart，<code>helm dependency build</code> 会<code>拉取</code>远端仓库的 Chart</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ h create demo</span><br><span class="line">Creating demo</span><br><span class="line"></span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">└── demo</span><br><span class="line">    ├── Chart.yaml</span><br><span class="line">    ├── charts</span><br><span class="line">    ├── templates</span><br><span class="line">    │   ├── NOTES.txt</span><br><span class="line">    │   ├── _helpers.tpl</span><br><span class="line">    │   ├── deployment.yaml</span><br><span class="line">    │   ├── hpa.yaml</span><br><span class="line">    │   ├── ingress.yaml</span><br><span class="line">    │   ├── service.yaml</span><br><span class="line">    │   ├── serviceaccount.yaml</span><br><span class="line">    │   └── tests</span><br><span class="line">    │       └── test-connection.yaml</span><br><span class="line">    └── values.yaml</span><br><span class="line"></span><br><span class="line">5 directories, 10 files</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Chart.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">Kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A chart can be either an &#x27;application&#x27; or a &#x27;library&#x27; chart.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Application charts are a collection of templates that can be packaged into versioned archives</span></span><br><span class="line"><span class="comment"># to be deployed.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Library charts provide useful utilities or functions for the chart developer. They&#x27;re included as</span></span><br><span class="line"><span class="comment"># a dependency of application charts to inject those utilities and functions into the rendering</span></span><br><span class="line"><span class="comment"># pipeline. Library charts do not define any templates and therefore cannot be deployed.</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">application</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the chart version. This version number should be incremented each time you make changes</span></span><br><span class="line"><span class="comment"># to the chart and its templates, including the app version.</span></span><br><span class="line"><span class="comment"># Versions are expected to follow Semantic Versioning (https://semver.org/)</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the version number of the application being deployed. This version number should be</span></span><br><span class="line"><span class="comment"># incremented each time you make changes to the application. Versions are not expected to</span></span><br><span class="line"><span class="comment"># follow Semantic Versioning. They should reflect the version the application is using.</span></span><br><span class="line"><span class="comment"># It is recommended to use it with quotes.</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">&quot;1.16.0&quot;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Key</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>apiVersion</td>
<td>API 版本，默认 v2</td>
</tr>
<tr>
<td>name</td>
<td>Helm Chart 名称</td>
</tr>
<tr>
<td>type</td>
<td>application &#x2F; library</td>
</tr>
<tr>
<td>version</td>
<td>Helm Chart 版本</td>
</tr>
<tr>
<td>appVersion</td>
<td>应用版本</td>
</tr>
<tr>
<td><code>dependencies</code></td>
<td>依赖其它子 Chart</td>
</tr>
</tbody></table>
<blockquote>
<p>values.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default values for demo.</span></span><br><span class="line"><span class="comment"># This is a YAML-formatted file.</span></span><br><span class="line"><span class="comment"># Declare variables to be passed into your templates.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># Overrides the image tag whose default is the chart appVersion.</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">imagePullSecrets:</span> []</span><br><span class="line"><span class="attr">nameOverride:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">fullnameOverride:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">serviceAccount:</span></span><br><span class="line">  <span class="comment"># Specifies whether a service account should be created</span></span><br><span class="line">  <span class="attr">create:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Annotations to add to the service account</span></span><br><span class="line">  <span class="attr">annotations:</span> &#123;&#125;</span><br><span class="line">  <span class="comment"># The name of the service account to use.</span></span><br><span class="line">  <span class="comment"># If not set and create is true, a name is generated using the fullname template</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">podAnnotations:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">podSecurityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="comment"># fsGroup: 2000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="comment"># capabilities:</span></span><br><span class="line">  <span class="comment">#   drop:</span></span><br><span class="line">  <span class="comment">#   - ALL</span></span><br><span class="line">  <span class="comment"># readOnlyRootFilesystem: true</span></span><br><span class="line">  <span class="comment"># runAsNonRoot: true</span></span><br><span class="line">  <span class="comment"># runAsUser: 1000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">className:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">annotations:</span> &#123;&#125;</span><br><span class="line">    <span class="comment"># kubernetes.io/ingress.class: nginx</span></span><br><span class="line">    <span class="comment"># kubernetes.io/tls-acme: &quot;true&quot;</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">chart-example.local</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">  <span class="attr">tls:</span> []</span><br><span class="line">  <span class="comment">#  - secretName: chart-example-tls</span></span><br><span class="line">  <span class="comment">#    hosts:</span></span><br><span class="line">  <span class="comment">#      - chart-example.local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="comment"># We usually recommend not to specify default resources and to leave this as a conscious</span></span><br><span class="line">  <span class="comment"># choice for the user. This also increases chances charts run on environments with little</span></span><br><span class="line">  <span class="comment"># resources, such as Minikube. If you do want to specify resources, uncomment the following</span></span><br><span class="line">  <span class="comment"># lines, adjust them as necessary, and remove the curly braces after &#x27;resources:&#x27;.</span></span><br><span class="line">  <span class="comment"># limits:</span></span><br><span class="line">  <span class="comment">#   cpu: 100m</span></span><br><span class="line">  <span class="comment">#   memory: 128Mi</span></span><br><span class="line">  <span class="comment"># requests:</span></span><br><span class="line">  <span class="comment">#   cpu: 100m</span></span><br><span class="line">  <span class="comment">#   memory: 128Mi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">autoscaling:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># targetMemoryUtilizationPercentage: 80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nodeSelector:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">tolerations:</span> []</span><br><span class="line"></span><br><span class="line"><span class="attr">affinity:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>templates&#x2F;deployment.yaml</p>
<ol>
<li><code>image: &quot;&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag | default .Chart.AppVersion &#125;&#125;&quot;</code></li>
<li><code>imagePullPolicy: &#123;&#123; .Values.image.pullPolicy &#125;&#125;</code></li>
</ol>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">include</span> <span class="string">&quot;demo.fullname&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    &#123;&#123;<span class="bullet">-</span> <span class="string">include</span> <span class="string">&quot;demo.labels&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">4</span> &#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">not</span> <span class="string">.Values.autoscaling.enabled</span> &#125;&#125;</span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.replicaCount</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">include</span> <span class="string">&quot;demo.selectorLabels&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">6</span> &#125;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.podAnnotations</span> &#125;&#125;</span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">include</span> <span class="string">&quot;demo.selectorLabels&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.imagePullSecrets</span> &#125;&#125;</span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">      <span class="attr">serviceAccountName:</span> &#123;&#123; <span class="string">include</span> <span class="string">&quot;demo.serviceAccountName&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.Values.podSecurityContext</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> &#123;&#123; <span class="string">.Chart.Name</span> &#125;&#125;</span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.Values.securityContext</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">12</span> &#125;&#125;</span><br><span class="line">          <span class="attr">image:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Values.image.repository &#125;&#125;</span>:<span class="template-variable">&#123;&#123; .Values.image.tag | default .Chart.AppVersion &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> &#123;&#123; <span class="string">.Values.image.pullPolicy</span> &#125;&#125;</span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.Values.resources</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">12</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.nodeSelector</span> &#125;&#125;</span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.affinity</span> &#125;&#125;</span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.tolerations</span> &#125;&#125;</span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本地渲染：<code>Render chart templates locally and display the output.</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">h</span> <span class="string">template</span> <span class="string">.</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: demo/templates/serviceaccount.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">release-name-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">demo-0.1.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: demo/templates/service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">release-name-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">demo-0.1.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: demo/templates/deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">release-name-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">demo-0.1.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">demo</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">demo</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">release-name-demo</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            &#123;&#125;</span><br><span class="line">          <span class="attr">image:</span> <span class="string">&quot;nginx:1.16.0&quot;</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: demo/templates/tests/test-connection.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;release-name-demo-test-connection&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">demo-0.1.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">&quot;1.16.0&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">&quot;helm.sh/hook&quot;:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wget</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;wget&#x27;</span>]</span><br><span class="line">      <span class="attr">args:</span> [<span class="string">&#x27;release-name-demo:80&#x27;</span>]</span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>安装（等价）</p>
</blockquote>
<ol>
<li><code>h install .</code></li>
<li><code>h template . | k apply -f -</code></li>
</ol>
<blockquote>
<p>调试：inspect</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ h inspect values oci://registry-1.docker.io/bitnamicharts/redis</span><br></pre></td></tr></table></figure>

<h2 id="Dependency"><a href="#Dependency" class="headerlink" title="Dependency"></a>Dependency</h2><blockquote>
<p>Chart.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">vote</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">Kubernetes</span> <span class="string">vote</span> <span class="string">application</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">application</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span> <span class="comment"># 子 Chart</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;17.16.0&quot;</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">&quot;oci://registry-1.docker.io/bitnamicharts&quot;</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">redis.enabled</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middleware</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresql-ha</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;11.9.0&quot;</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">&quot;oci://registry-1.docker.io/bitnamicharts&quot;</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">postgresql-ha.enabled</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middleware</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>values.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 父 Chart 覆写子 Chart 的默认值</span></span><br><span class="line"><span class="attr">redis:</span> <span class="comment"># 子 Chart 要一致</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">fullnameOverride:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># https://github.com/bitnami/charts/blob/cf413a8a118a0dd1288b72b6ae9936f655221e9b/bitnami/redis/values.yaml#L125</span></span><br><span class="line"></span><br><span class="line"><span class="attr">postgresql-ha:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>helm dependency build 会<code>拉取</code>远端仓库的 Chart</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ helm dependency build</span><br><span class="line">Hang tight while we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the &quot;koderover-chart&quot; chart repository</span><br><span class="line">...Successfully got an update from the &quot;bitnami&quot; chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line">Saving 2 charts</span><br><span class="line">Downloading redis from repo oci://registry-1.docker.io/bitnamicharts</span><br><span class="line">Pulled: registry-1.docker.io/bitnamicharts/redis:17.16.0</span><br><span class="line">Digest: sha256:2ac70a7a7aa27e71d05bf95dbf898c9c3901494963070788bfd5eeec65567493</span><br><span class="line">Downloading postgresql-ha from repo oci://registry-1.docker.io/bitnamicharts</span><br><span class="line">Pulled: registry-1.docker.io/bitnamicharts/postgresql-ha:11.9.0</span><br><span class="line">Digest: sha256:099ad0a22567f340b7fe772b50431e9b1eb4bcd56faacccfaf320ce62a576e29</span><br><span class="line">Deleting outdated charts</span><br><span class="line"></span><br><span class="line">$ tree .</span><br><span class="line">.</span><br><span class="line">├── Chart.lock</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── charts</span><br><span class="line">│   ├── postgresql-ha-11.9.0.tgz</span><br><span class="line">│   └── redis-17.16.0.tgz</span><br><span class="line">├── templates</span><br><span class="line">│   ├── result-db-secret.yaml</span><br><span class="line">│   ├── result-deployment.yaml</span><br><span class="line">│   ├── result-service.yaml</span><br><span class="line">│   ├── vote-configmap.yaml</span><br><span class="line">│   ├── vote-deployment.yaml</span><br><span class="line">│   ├── vote-service.yaml</span><br><span class="line">│   ├── worker-db-secret.yaml</span><br><span class="line">│   └── worker-deployment.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure>

<h2 id="高级技术"><a href="#高级技术" class="headerlink" title="高级技术"></a>高级技术</h2><blockquote>
<p><code>Dependency</code> 基于 <code>Subcharts</code>（放在 <code>charts</code> 目录） 来实现</p>
</blockquote>
<table>
<thead>
<tr>
<th>Key</th>
<th>Link</th>
</tr>
</thead>
<tbody><tr>
<td>Built-in Objects</td>
<td><a target="_blank" rel="noopener" href="https://helm.sh/docs/chart_template_guide/builtin_objects/">https://helm.sh/docs/chart_template_guide/builtin_objects/</a></td>
</tr>
<tr>
<td>Template Function List</td>
<td><a target="_blank" rel="noopener" href="https://helm.sh/docs/chart_template_guide/function_list/">https://helm.sh/docs/chart_template_guide/function_list/</a></td>
</tr>
<tr>
<td>Helm Dependency</td>
<td><a target="_blank" rel="noopener" href="https://helm.sh/docs/helm/helm_dependency/">https://helm.sh/docs/helm/helm_dependency/</a></td>
</tr>
<tr>
<td>Debugging Templates</td>
<td><a target="_blank" rel="noopener" href="https://helm.sh/docs/chart_template_guide/debugging/">https://helm.sh/docs/chart_template_guide/debugging/</a></td>
</tr>
<tr>
<td>Subcharts and Global Values</td>
<td><a target="_blank" rel="noopener" href="https://helm.sh/docs/chart_template_guide/subcharts_and_globals/">https://helm.sh/docs/chart_template_guide/subcharts_and_globals/</a></td>
</tr>
<tr>
<td>Chart Hooks</td>
<td><a target="_blank" rel="noopener" href="https://helm.sh/docs/topics/charts_hooks/">https://helm.sh/docs/topics/charts_hooks/</a></td>
</tr>
</tbody></table>
<blockquote>
<p><code>pre-install</code> - 同样可以执行数据库的初始化</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Release.Name &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> &#123;&#123; <span class="string">.Release.Service</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> &#123;&#123; <span class="string">.Release.Name</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> &#123;&#123; <span class="string">.Chart.AppVersion</span> &#125;&#125;</span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Chart.Name &#125;&#125;</span>-<span class="template-variable">&#123;&#123; .Chart.Version &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># This is what defines this resource as a hook. Without this line, the</span></span><br><span class="line">    <span class="comment"># job is considered part of the release.</span></span><br><span class="line">    <span class="attr">&quot;helm.sh/hook&quot;:</span> <span class="string">post-install</span></span><br><span class="line">    <span class="attr">&quot;helm.sh/hook-weight&quot;:</span> <span class="string">&quot;-5&quot;</span></span><br><span class="line">    <span class="attr">&quot;helm.sh/hook-delete-policy&quot;:</span> <span class="string">hook-succeeded</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Release.Name &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/managed-by:</span> &#123;&#123; <span class="string">.Release.Service</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> &#123;&#123; <span class="string">.Release.Name</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">        <span class="attr">helm.sh/chart:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Chart.Name &#125;&#125;</span>-<span class="template-variable">&#123;&#123; .Chart.Version &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">post-install-job</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;alpine:3.3&quot;</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sleep&quot;</span>,<span class="string">&quot;<span class="template-variable">&#123;&#123; default &quot;10&quot; .Values.sleepyTime &#125;&#125;</span>&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="Helm-Upgrade"><a href="#Helm-Upgrade" class="headerlink" title="Helm Upgrade"></a>Helm Upgrade</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240218230216421.png" alt="image-20240218230216421"></p>
<h2 id="Helm-Cheat-Sheet"><a href="#Helm-Cheat-Sheet" class="headerlink" title="Helm Cheat Sheet"></a>Helm Cheat Sheet</h2><blockquote>
<p>安装或者升级</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm upgrade --install &lt;release-name&gt; --values &lt;values file&gt; &lt;chart directory&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看 Helm Chart values.yaml 配置信息，主要用于观测 Subcharts</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm inspect values &lt;CHART&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看 Helm Chart Repository 列表</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo list</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看所有命名空间的 Release</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm list --all-namespaces</span><br></pre></td></tr></table></figure>

<blockquote>
<p>先更新依赖（Subcharts），再升级应用 – <code>helm dependency build</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm upgrade &lt;release&gt; &lt;chart&gt; --dependency-update</span><br></pre></td></tr></table></figure>

<blockquote>
<p>回滚应用，只能在 <code>Manifests</code> 层级，而非业务层级</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm rollback &lt;release&gt; &lt;revision&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Kustomize"><a href="#Kustomize" class="headerlink" title="Kustomize"></a>Kustomize</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>增强版 YAML，类似于<code>声明式版本</code>的 <code>yq</code></p>
</blockquote>
<blockquote>
<p>Kubernetes native configuration management</p>
</blockquote>
<ol>
<li>Kustomize 是一个 <code>CLI</code> 工具</li>
<li>可以对 <code>Manifests</code> 的<code>任何字段</code>进行<code>覆写</code></li>
<li>适用于<code>多环境</code>的场景</li>
<li>由 K8S 团队开发，并内置到 <code>kubectl</code></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/image-20240219011001692.png" alt="image-20240219011001692"></p>
<blockquote>
<p>base - 基础目录，不同环境的<code>通用</code>的 Manifest</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ tree .</span><br><span class="line">.</span><br><span class="line">├── base</span><br><span class="line">│   ├── db-deployment.yaml</span><br><span class="line">│   ├── db-secret.yaml</span><br><span class="line">│   ├── db-service.yaml</span><br><span class="line">│   ├── kustomization.yaml</span><br><span class="line">│   ├── redis-deployment.yaml</span><br><span class="line">│   ├── redis-service.yaml</span><br><span class="line">│   ├── result-db-secret.yaml</span><br><span class="line">│   ├── result-deployment.yaml</span><br><span class="line">│   ├── result-service.yaml</span><br><span class="line">│   ├── vote-configmap.yaml</span><br><span class="line">│   ├── vote-deployment.yaml</span><br><span class="line">│   ├── vote-service.yaml</span><br><span class="line">│   ├── worker-db-secret.yaml</span><br><span class="line">│   └── worker-deployment.yaml</span><br><span class="line">└── overlays</span><br><span class="line">    └── dev</span><br><span class="line">        └── kustomization.yaml</span><br><span class="line"></span><br><span class="line">$ ls -a overlays/dev</span><br><span class="line">.  ..  .env  kustomization.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>overlays/dev/kustomization.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">../../base</span></span><br><span class="line"></span><br><span class="line"><span class="attr">secretGenerator:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">result-db-secret</span></span><br><span class="line">    <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env=.env</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">worker-db-secret</span></span><br><span class="line">    <span class="attr">envs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line"></span><br><span class="line"><span class="attr">configMapGenerator:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vote-configmap</span></span><br><span class="line">    <span class="attr">literals:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPTION_A=InfoQ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPTION_B=GeekBang</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>kustomization.yaml 常用配置</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">Config</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td align="left">resources</td>
<td>定义 Manifest 资源、文件、目录或者 URL</td>
</tr>
<tr>
<td align="left">secretGenerator</td>
<td>生成 Secret 对象</td>
</tr>
<tr>
<td align="left">configMapGenerator</td>
<td>生成 ConfigMap 对象</td>
</tr>
<tr>
<td align="left">images</td>
<td>覆写 image tag</td>
</tr>
<tr>
<td align="left"><code>helmCharts</code></td>
<td>定义依赖的 helm chart</td>
</tr>
<tr>
<td align="left">patchesStrategicMerge</td>
<td>覆写操作（<code>任意字段</code>），v1 版本将废弃，建议迁移至 <code>patches</code></td>
</tr>
</tbody></table>
<blockquote>
<p>渲染（类似于 <code>helm template &lt;dir&gt;</code>）</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">kustomize</span> <span class="string">./overlays/dev</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">DB_HOST:</span> <span class="string">ZGI=</span></span><br><span class="line">  <span class="attr">DB_NAME:</span> <span class="string">cG9zdGdyZXM=</span></span><br><span class="line">  <span class="attr">DB_PASS:</span> <span class="string">cG9zdGdyZXM=</span></span><br><span class="line">  <span class="attr">DB_USER:</span> <span class="string">cG9zdGdyZXM=</span></span><br><span class="line">  <span class="attr">REDIS_HOST:</span> <span class="string">cmVkaXM=</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">worker-db-secret-b27f9282dh</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>部署</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl kustomize ./overlays/dev | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<h2 id="引用-Helm-Chart"><a href="#引用-Helm-Chart" class="headerlink" title="引用 Helm Chart"></a>引用 Helm Chart</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ tree -L 5</span><br><span class="line">.</span><br><span class="line">├── base</span><br><span class="line">│   ├── kustomization.yaml</span><br><span class="line">│   ├── result-db-secret.yaml</span><br><span class="line">│   ├── result-deployment.yaml</span><br><span class="line">│   ├── result-service.yaml</span><br><span class="line">│   ├── vote-configmap.yaml</span><br><span class="line">│   ├── vote-deployment.yaml</span><br><span class="line">│   ├── vote-service.yaml</span><br><span class="line">│   ├── worker-db-secret.yaml</span><br><span class="line">│   └── worker-deployment.yaml</span><br><span class="line">└── overlays</span><br><span class="line">    └── dev</span><br><span class="line">        ├── charts</span><br><span class="line">        │   ├── postgresql-ha</span><br><span class="line">        │   │   ├── Chart.lock</span><br><span class="line">        │   │   ├── Chart.yaml</span><br><span class="line">        │   │   ├── README.md</span><br><span class="line">        │   │   ├── charts</span><br><span class="line">        │   │   ├── templates</span><br><span class="line">        │   │   └── values.yaml</span><br><span class="line">        │   └── redis</span><br><span class="line">        │       ├── Chart.lock</span><br><span class="line">        │       ├── Chart.yaml</span><br><span class="line">        │       ├── README.md</span><br><span class="line">        │       ├── charts</span><br><span class="line">        │       ├── img</span><br><span class="line">        │       ├── templates</span><br><span class="line">        │       ├── values.schema.json</span><br><span class="line">        │       └── values.yaml</span><br><span class="line">        └── kustomization.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>kustomization.yaml</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>overlays/dev/kustomization.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">../../base</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">images:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xxx/result</span></span><br><span class="line">    <span class="attr">newTag:</span> <span class="string">env</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xxx/vote</span></span><br><span class="line">    <span class="attr">newTag:</span> <span class="string">env</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xxx/worker</span></span><br><span class="line">    <span class="attr">newTag:</span> <span class="string">env</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 patchs 修改镜像版本，效果同 images 字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># patches:</span></span><br><span class="line"><span class="comment">#   - patch: |-</span></span><br><span class="line"><span class="comment">#       - op: replace</span></span><br><span class="line"><span class="comment">#         path: /spec/template/spec/containers/0/image</span></span><br><span class="line"><span class="comment">#         value: xxx/vote:env</span></span><br><span class="line"><span class="comment">#     target:</span></span><br><span class="line"><span class="comment">#       kind: Deployment</span></span><br><span class="line"><span class="comment">#       name: vote</span></span><br><span class="line"><span class="comment">#   - patch: |-</span></span><br><span class="line"><span class="comment">#       - op: replace</span></span><br><span class="line"><span class="comment">#         path: /spec/template/spec/containers/0/image</span></span><br><span class="line"><span class="comment">#         value: xxx/result:env</span></span><br><span class="line"><span class="comment">#     target:</span></span><br><span class="line"><span class="comment">#       kind: Deployment</span></span><br><span class="line"><span class="comment">#       name: result</span></span><br><span class="line"><span class="comment">#   - patch: |-</span></span><br><span class="line"><span class="comment">#       - op: replace</span></span><br><span class="line"><span class="comment">#         path: /spec/template/spec/containers/0/image</span></span><br><span class="line"><span class="comment">#         value: xxx/worker:env</span></span><br><span class="line"><span class="comment">#     target:</span></span><br><span class="line"><span class="comment">#       kind: Deployment</span></span><br><span class="line"><span class="comment">#       name: worker</span></span><br><span class="line"></span><br><span class="line"><span class="attr">secretGenerator:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">result-db-secret</span></span><br><span class="line">    <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env=.env</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">worker-db-secret</span></span><br><span class="line">    <span class="attr">envs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line"></span><br><span class="line"><span class="attr">configMapGenerator:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vote-configmap</span></span><br><span class="line">    <span class="attr">literals:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPTION_A=InfoQ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPTION_B=GeekBang</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis-master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">helmCharts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;17.16.0&quot;</span></span><br><span class="line">    <span class="comment"># 暂不支持 OCI，使用传统的 Helm Repository：https://github.com/kubernetes-sigs/kustomize/pull/5167</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">&quot;https://charts.bitnami.com/bitnami&quot;</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">valuesInline:</span> <span class="comment"># 覆写，类似 Helm Subcharts</span></span><br><span class="line">      <span class="attr">fullnameOverride:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">auth:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresql-ha</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;11.9.0&quot;</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">&quot;https://charts.bitnami.com/bitnami&quot;</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">valuesInline:</span></span><br><span class="line">      <span class="attr">fullnameOverride:</span> <span class="string">db</span></span><br><span class="line">      <span class="attr">global:</span></span><br><span class="line">        <span class="attr">postgresql:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">database:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">repmgrUsername:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">repmgrPassword:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure>

<h2 id="对比-Helm-Chart"><a href="#对比-Helm-Chart" class="headerlink" title="对比 Helm Chart"></a>对比 Helm Chart</h2><ol>
<li>可以覆写<code>任何</code> Manifest 字段和值</li>
<li><code>学习成本</code>低</li>
<li>在<code>多环境</code>下，Base 和 Overlays 模式能够很好地实现 <code>Manifest</code> 的<code>复用</code></li>
<li>可以从 <code>ENV</code> 生成 ConfigMap、Secret 对象，避免<code>凭据泄漏</code></li>
<li>Helm 屏蔽应用细节，对终端用户友好；Kustomize 暴露所有 K8S API，对开发者友好</li>
</ol>
<h2 id="与-Helm-Chart-混用"><a href="#与-Helm-Chart-混用" class="headerlink" title="与 Helm Chart 混用"></a>与 Helm Chart 混用</h2><ol>
<li><code>Helm Chart</code> 主要提供<code>模板化</code>和<code>参数化</code>的能力，而 <code>Kustomize</code> 可以<code>覆写任意字段</code></li>
<li>结合：在 <code>Helm Hooks</code> 中集成 Kustomize</li>
</ol>
<h2 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h2><ol>
<li><code>分发</code>没有 Helm Chart 方便</li>
<li><code>生态</code>不如 Helm</li>
<li><code>强依赖</code>于<code>目录结构</code></li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2023/02/04/cloud-native-devops-foundation/">https://blog.zhongmingmao.top/2023/02/04/cloud-native-devops-foundation/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/devops/">DevOps</a><a class="post-meta__tags" href="/tags/docker/">Docker</a><a class="post-meta__tags" href="/tags/helm/">Helm</a><a class="post-meta__tags" href="/tags/runc/">runc</a><a class="post-meta__tags" href="/tags/kustomize/">Kustomize</a><a class="post-meta__tags" href="/tags/oci/">OCI</a><a class="post-meta__tags" href="/tags/buildkit/">BuildKit</a><a class="post-meta__tags" href="/tags/crane/">crane</a><a class="post-meta__tags" href="/tags/oci-image/">OCI Image</a><a class="post-meta__tags" href="/tags/oci-runtime/">OCI Runtime</a><a class="post-meta__tags" href="/tags/linux-namespace/">Linux Namespace</a><a class="post-meta__tags" href="/tags/linux-cgroup/">Linux CGroup</a><a class="post-meta__tags" href="/tags/k8s-manifest/">K8S Manifest</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/05/cloud-native-devops-iac/" title="DevOps - IaC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/iac.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">DevOps - IaC</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/03/cloud-native-devops-overview/" title="DevOps - Overview"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/DevOps-Lifecycle.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">DevOps - Overview</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/02/05/cloud-native-devops-iac/" title="DevOps - IaC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/iac.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-05</div><div class="title">DevOps - IaC</div></div></a></div><div><a href="/2023/02/03/cloud-native-devops-overview/" title="DevOps - Overview"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-native-devops-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/DevOps-Lifecycle.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-03</div><div class="title">DevOps - Overview</div></div></a></div><div><a href="/2022/10/01/kubernetes-container-interconnection/" title="Kubernetes - Container Interconnection"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://kubernetes-1253868755.cos.ap-guangzhou.myqcloud.com/docker/docker-04.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-01</div><div class="title">Kubernetes - Container Interconnection</div></div></a></div><div><a href="/2022/09/26/kubernetes-docker-hub/" title="Kubernetes - Docker Hub"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://kubernetes-1253868755.cos.ap-guangzhou.myqcloud.com/docker/docker-hub.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-26</div><div class="title">Kubernetes - Docker Hub</div></div></a></div><div><a href="/2022/09/19/kubernetes-dockerfile/" title="Kubernetes - Dockerfile"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://kubernetes-1253868755.cos.ap-guangzhou.myqcloud.com/docker/docker-02.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-19</div><div class="title">Kubernetes - Dockerfile</div></div></a></div><div><a href="/2022/09/18/kubernetes-containerization/" title="Kubernetes - Containerization"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://kubernetes-1253868755.cos.ap-guangzhou.myqcloud.com/docker/docker-01.png.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-18</div><div class="title">Kubernetes - Containerization</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">518</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">151</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">69</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">基本原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">核心原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">隔离机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%AE%B9%E5%99%A8"><span class="toc-number">1.3.</span> <span class="toc-text">实现容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#uts"><span class="toc-number">1.3.1.</span> <span class="toc-text">uts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pid"><span class="toc-number">1.3.2.</span> <span class="toc-text">pid</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Image"><span class="toc-number">1.4.</span> <span class="toc-text">Image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overlay"><span class="toc-number">1.5.</span> <span class="toc-text">Overlay</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dockerfile"><span class="toc-number">1.6.</span> <span class="toc-text">Dockerfile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-number">1.6.1.</span> <span class="toc-text">命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.2.</span> <span class="toc-text">最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F"><span class="toc-number">1.6.3.</span> <span class="toc-text">镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA"><span class="toc-number">1.6.4.</span> <span class="toc-text">多阶段构建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E9%98%B6%E6%AE%B5"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">单阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E9%98%B6%E6%AE%B5"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">多阶段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8"><span class="toc-number">1.6.5.</span> <span class="toc-text">安全</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">镜像构建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DinD"><span class="toc-number">2.1.</span> <span class="toc-text">DinD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BuildKit"><span class="toc-number">2.2.</span> <span class="toc-text">BuildKit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kaniko"><span class="toc-number">2.3.</span> <span class="toc-text">Kaniko</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.3.1.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-number">2.3.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%8E%9F%E7%90%86"><span class="toc-number">2.4.</span> <span class="toc-text">构建原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%9E%84%E5%BB%BA"><span class="toc-number">2.4.1.</span> <span class="toc-text">传统构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BuildKit-1"><span class="toc-number">2.4.2.</span> <span class="toc-text">BuildKit</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%9E%84%E5%BB%BA-1"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">传统构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BuildKit-2"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">BuildKit</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E6%9E%B6%E6%9E%84"><span class="toc-number">2.5.</span> <span class="toc-text">多架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#crane"><span class="toc-number">2.5.1.</span> <span class="toc-text">crane</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BuildKit-3"><span class="toc-number">2.5.2.</span> <span class="toc-text">BuildKit</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OCI"><span class="toc-number">3.</span> <span class="toc-text">OCI</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#runc"><span class="toc-number">4.</span> <span class="toc-text">runc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rootfs"><span class="toc-number">4.1.</span> <span class="toc-text">rootfs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#config-json"><span class="toc-number">4.2.</span> <span class="toc-text">config.json</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#run"><span class="toc-number">4.3.</span> <span class="toc-text">run</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Manifest"><span class="toc-number">5.</span> <span class="toc-text">Manifest</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kubectl-create"><span class="toc-number">5.1.</span> <span class="toc-text">kubectl create</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6"><span class="toc-number">5.2.</span> <span class="toc-text">文件合并</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%AA%E5%A8%81%E9%97%AE%E9%A2%98"><span class="toc-number">5.3.</span> <span class="toc-text">挪威问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">5.4.</span> <span class="toc-text">保留关键字</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E5%AD%97"><span class="toc-number">5.5.</span> <span class="toc-text">数字</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%A1%8C%E5%86%85%E5%AE%B9"><span class="toc-number">5.6.</span> <span class="toc-text">多行内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">5.7.</span> <span class="toc-text">引用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.</span> <span class="toc-text">微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">6.1.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Manifest-1"><span class="toc-number">6.2.</span> <span class="toc-text">Manifest</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">6.2.1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">6.2.2.</span> <span class="toc-text">部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.2.3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Vote"><span class="toc-number">6.2.3.1.</span> <span class="toc-text">Vote</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Worker"><span class="toc-number">6.2.3.2.</span> <span class="toc-text">Worker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Result"><span class="toc-number">6.2.3.3.</span> <span class="toc-text">Result</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile-1"><span class="toc-number">6.2.4.</span> <span class="toc-text">Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E4%BE%9D%E8%B5%96"><span class="toc-number">6.2.5.</span> <span class="toc-text">服务依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.2.6.</span> <span class="toc-text">数据初始化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Helm"><span class="toc-number">7.</span> <span class="toc-text">Helm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm-Chart"><span class="toc-number">7.1.</span> <span class="toc-text">Helm Chart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">7.2.</span> <span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">7.3.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scratch"><span class="toc-number">7.4.</span> <span class="toc-text">Scratch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dependency"><span class="toc-number">7.5.</span> <span class="toc-text">Dependency</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF"><span class="toc-number">7.6.</span> <span class="toc-text">高级技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm-Upgrade"><span class="toc-number">7.7.</span> <span class="toc-text">Helm Upgrade</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm-Cheat-Sheet"><span class="toc-number">7.8.</span> <span class="toc-text">Helm Cheat Sheet</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kustomize"><span class="toc-number">8.</span> <span class="toc-text">Kustomize</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">8.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8-Helm-Chart"><span class="toc-number">8.2.</span> <span class="toc-text">引用 Helm Chart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94-Helm-Chart"><span class="toc-number">8.3.</span> <span class="toc-text">对比 Helm Chart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8E-Helm-Chart-%E6%B7%B7%E7%94%A8"><span class="toc-number">8.4.</span> <span class="toc-text">与 Helm Chart 混用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-1"><span class="toc-number">8.5.</span> <span class="toc-text">缺点</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-lint.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Engineering - Lint"/></a><div class="content"><a class="title" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint">Go Engineering - Lint</a><time datetime="2023-05-05T16:06:25.000Z" title="Created 2023-05-06 00:06:25">2023-05-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-makefile.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Engineering - Makefile"/></a><div class="content"><a class="title" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile">Go Engineering - Makefile</a><time datetime="2023-05-04T16:06:25.000Z" title="Created 2023-05-05 00:06:25">2023-05-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/04/cloud-native-foundation-go-engineering-rpc-api/" title="Go Engineering - RPC API"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-grpc-7924583.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Engineering - RPC API"/></a><div class="content"><a class="title" href="/2023/05/04/cloud-native-foundation-go-engineering-rpc-api/" title="Go Engineering - RPC API">Go Engineering - RPC API</a><time datetime="2023-05-03T16:06:25.000Z" title="Created 2023-05-04 00:06:25">2023-05-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/03/cloud-native-foundation-go-engineering-restful-api/" title="Go Engineering - RESTful API"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-restful-api.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Engineering - RESTful API"/></a><div class="content"><a class="title" href="/2023/05/03/cloud-native-foundation-go-engineering-restful-api/" title="Go Engineering - RESTful API">Go Engineering - RESTful API</a><time datetime="2023-05-02T16:06:25.000Z" title="Created 2023-05-03 00:06:25">2023-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/02/cloud-native-foundation-go-engineering-design-pattern/" title="Go Engineering - Design Pattern"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-design-pattern.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Engineering - Design Pattern"/></a><div class="content"><a class="title" href="/2023/05/02/cloud-native-foundation-go-engineering-design-pattern/" title="Go Engineering - Design Pattern">Go Engineering - Design Pattern</a><time datetime="2023-05-01T16:06:25.000Z" title="Created 2023-05-02 00:06:25">2023-05-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2024 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
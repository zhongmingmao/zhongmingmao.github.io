<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - Operator | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="应用接入应用容器化开销风险 Log Driver Blocking mode Non-Blocking mode   共享 Kernel 共享系统参数配置 进程数共享 fd 数共享 主机磁盘共享">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Operator">
<meta property="og:url" content="https://blog.zhongmingmao.top/2023/01/27/cloud-native-foundation-k8s-operator/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="应用接入应用容器化开销风险 Log Driver Blocking mode Non-Blocking mode   共享 Kernel 共享系统参数配置 进程数共享 fd 数共享 主机磁盘共享">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-operators.png">
<meta property="article:published_time" content="2023-01-26T16:06:25.000Z">
<meta property="article:modified_time" content="2023-12-18T15:53:14.508Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cloud Native Foundation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-operators.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2023/01/27/cloud-native-foundation-k8s-operator/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - Operator',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-18 23:53:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">526</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">158</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">71</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-operators.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - Operator</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2023-01-26T16:06:25.000Z" title="Created 2023-01-27 00:06:25">2023-01-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">4.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>26min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="应用接入"><a href="#应用接入" class="headerlink" title="应用接入"></a>应用接入</h1><h2 id="应用容器化"><a href="#应用容器化" class="headerlink" title="应用容器化"></a>应用容器化</h2><h3 id="开销风险"><a href="#开销风险" class="headerlink" title="开销风险"></a>开销风险</h3><ol>
<li>Log Driver<ul>
<li>Blocking mode</li>
<li>Non-Blocking mode</li>
</ul>
</li>
<li>共享 Kernel<ul>
<li>共享系统参数配置</li>
<li>进程数共享</li>
<li>fd 数共享</li>
<li>主机磁盘共享</li>
</ul>
</li>
</ol>
<span id="more"></span>

<h3 id="资源监控"><a href="#资源监控" class="headerlink" title="资源监控"></a>资源监控</h3><h4 id="应用视角"><a href="#应用视角" class="headerlink" title="应用视角"></a>应用视角</h4><blockquote>
<p>容器中看到的资源是<code>主机资源</code></p>
</blockquote>
<ol>
<li>top</li>
<li>Java Runtime.availableProcessors()</li>
<li>cat &#x2F;proc&#x2F;cpuinfo</li>
<li>cat &#x2F;proc&#x2F;meminfo</li>
<li>df -k</li>
</ol>
<h4 id="影响应用"><a href="#影响应用" class="headerlink" title="影响应用"></a>影响应用</h4><blockquote>
<p>Java</p>
</blockquote>
<ol>
<li>Concurrent GC Thread</li>
<li>Heap Size</li>
<li>线程数不可控</li>
</ol>
<h4 id="判断规则"><a href="#判断规则" class="headerlink" title="判断规则"></a>判断规则</h4><blockquote>
<p>查询 <code>/proc/1/cgroup</code> 是否包含 <code>kubepods</code> 关键字 </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/1/cgroup</span><br><span class="line">12:cpuset:/</span><br><span class="line">11:devices:/init.scope</span><br><span class="line">10:blkio:/init.scope</span><br><span class="line">9:freezer:/</span><br><span class="line">8:net_cls,net_prio:/</span><br><span class="line">7:pids:/init.scope</span><br><span class="line">6:perf_event:/</span><br><span class="line">5:memory:/init.scope</span><br><span class="line">4:rdma:/</span><br><span class="line">3:cpu,cpuacct:/init.scope</span><br><span class="line">2:hugetlb:/</span><br><span class="line">1:name=systemd:/init.scope</span><br><span class="line">0::/init.scope</span><br><span class="line"></span><br><span class="line">$ k get po</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-59d675bcb5-c2hv5   1/1     Running   0          41s</span><br><span class="line">nginx-deployment-59d675bcb5-j8mct   1/1     Running   0          42s</span><br><span class="line"></span><br><span class="line">$ k exec -it nginx-deployment-59d675bcb5-c2hv5 -- sh -c &quot;cat /proc/1/cgroup&quot;</span><br><span class="line">12:cpuset:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">11:devices:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">10:blkio:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">9:freezer:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">8:net_cls,net_prio:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">7:pids:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">6:perf_event:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">5:memory:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">4:rdma:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">3:cpu,cpuacct:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">2:hugetlb:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">1:name=systemd:/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br><span class="line">0::/kubepods.slice/kubepods-pod7f282c81_59bd_4373_a196_3a1f7e0a526a.slice/docker-ee82e2aba6a09214a9f0e766b6c0bcb3647cc922ee2e95d552314b117bfe7a5e.scope</span><br></pre></td></tr></table></figure>

<h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><blockquote>
<p>宿主 - 4C</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/cpuinfo | grep processor</span><br><span class="line">processor    : 0</span><br><span class="line">processor    : 1</span><br><span class="line">processor    : 2</span><br><span class="line">processor    : 3</span><br></pre></td></tr></table></figure>

<blockquote>
<p>容器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k get po nginx-deployment-59d675bcb5-c2hv5 -oyaml</span><br><span class="line">...</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 250m</span><br><span class="line">        memory: 1Gi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 250m</span><br><span class="line">        memory: 1Gi</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>配额 - 0.25C</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it nginx-deployment-59d675bcb5-c2hv5 -- sh -c &quot;cat /sys/fs/cgroup/cpu/cpu.cfs_period_us&quot;</span><br><span class="line">100000</span><br><span class="line"></span><br><span class="line">$ k exec -it nginx-deployment-59d675bcb5-c2hv5 -- sh -c &quot;cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us&quot;</span><br><span class="line">25000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>用量</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it nginx-deployment-59d675bcb5-c2hv5 -- sh -c &quot;cat /sys/fs/cgroup/cpuacct/cpuacct.usage_percpu&quot;</span><br><span class="line">13780426 9142250 29424126 10507041</span><br><span class="line"></span><br><span class="line">$ k exec -it nginx-deployment-59d675bcb5-c2hv5 -- sh -c &quot;cat /sys/fs/cgroup/cpuacct/cpuacct.usage&quot;</span><br><span class="line">65110467</span><br></pre></td></tr></table></figure>

<h4 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h4><blockquote>
<p>宿主 - 12G</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/meminfo | grep MemTotal</span><br><span class="line">MemTotal:       12234472 kB</span><br></pre></td></tr></table></figure>

<blockquote>
<p>配额 - 1G</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it nginx-deployment-59d675bcb5-c2hv5 -- sh -c &quot;cat /sys/fs/cgroup/memory/memory.limit_in_bytes&quot;</span><br><span class="line">1073741824</span><br></pre></td></tr></table></figure>

<blockquote>
<p>用量</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it nginx-deployment-59d675bcb5-c2hv5 -- sh -c &quot;cat /sys/fs/cgroup/memory/memory.usage_in_bytes&quot;</span><br><span class="line">5840896</span><br></pre></td></tr></table></figure>

<h2 id="PID-泄露"><a href="#PID-泄露" class="headerlink" title="PID 泄露"></a>PID 泄露</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217155237873.png" alt="image-20231217155237873"></p>
<ol>
<li>通过 <code>EntryPoint</code> fork 出来 probe，而 probe 会做网络调用，可能会<code>超时</code></li>
<li>一旦超时，<code>kubelet</code> 会强制将 probe 杀死，此时要求 <code>EntryPoint</code> 有<code>清理子进程</code>的能力<ul>
<li>EntryPoint 负责<code>优雅终止</code>，需要将 <code>SIGTERM</code> 信号<code>传递</code>到<code>子进程</code></li>
<li>EntryPoint 必须负责<code>清理</code> fork 出来的所有子进程</li>
</ul>
</li>
<li>建议采用 <code>HTTPCheck</code> 作为 Probe，为 <code>ExecProbe</code> 设置合理的<code>超时时间</code></li>
</ol>
<blockquote>
<p>开源方案：采用 <code>tini</code> 作为容器的初始化进程（PID&#x3D;1），容器中的僵尸进程的父进程会被设置为 1</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217160638665.png" alt="image-20231217160638665"></p>
<h2 id="PodDisruptionBudget"><a href="#PodDisruptionBudget" class="headerlink" title="PodDisruptionBudget"></a>PodDisruptionBudget</h2><blockquote>
<p>pdb 在<code>自主中断</code>（如节点故障等）时保障应用的<code>高可用</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>App</th>
<th>Goal</th>
<th>Solution</th>
</tr>
</thead>
<tbody><tr>
<td>无状态应用</td>
<td>至少 60% 的副本可用</td>
<td>创建 pdb，设置 minAvailable 为 60%，或者 maxUnAvailable 为 40%</td>
</tr>
<tr>
<td>单实例<br />有状态应用</td>
<td>客户同意后才能终止该实例</td>
<td>创建 pdb，设置 maxUnAvailable 为 0%</td>
</tr>
<tr>
<td>多实例<br />有状态应用</td>
<td>最少可用实例为 N</td>
<td>创建 pdb，设置 minAvailable 为 N，或者 maxUnAvailable 为 1</td>
</tr>
</tbody></table>
<blockquote>
<p>运维移除一个 Node</p>
</blockquote>
<ol>
<li>将 node 设置为不可调度：<code>k cordon &lt;node&gt;</code></li>
<li>将 node 排空：<code>k drain &lt;node&gt;</code></li>
</ol>
<blockquote>
<p>业务设置 pdb，保证应用不会被意外中断</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-pdb</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">minAvailable:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">zookeeper</span></span><br></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight yaml"><figcaption><span>nginx-deployment.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:stable-alpine3.17</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>pdb.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minAvailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line"></span><br><span class="line">$ k get po -l app=nginx</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-7f8c49f5b4-98fr6   1/1     Running   0          3m15s</span><br><span class="line">nginx-deployment-7f8c49f5b4-bp9pq   1/1     Running   0          3m15s</span><br><span class="line">nginx-deployment-7f8c49f5b4-pj5v8   1/1     Running   0          3m15s</span><br><span class="line"></span><br><span class="line">$ k apply -f pdb.yaml</span><br><span class="line">poddisruptionbudget.policy/nginx-deployment created</span><br><span class="line"></span><br><span class="line">$ k get pdb</span><br><span class="line">NAME               MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE</span><br><span class="line">nginx-deployment   1               N/A               2                     43s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get pdb nginx-deployment -oyaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;policy/v1&quot;,&quot;kind&quot;:&quot;PodDisruptionBudget&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;minAvailable&quot;:1,&quot;selector&quot;:&#123;&quot;matchLabels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-12-17T09:06:33Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;18673&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">3955cb69-7dea-4d39-84b0-40a7bf38c868</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minAvailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-12-17T09:06:33Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">observedGeneration:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">SufficientPods</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisruptionAllowed</span></span><br><span class="line">  <span class="attr">currentHealthy:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">desiredHealthy:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">disruptionsAllowed:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">expectedPods:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>副本缩小为 1</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k scale deployment nginx-deployment --replicas=1</span><br><span class="line">deployment.apps/nginx-deployment scaled</span><br><span class="line"></span><br><span class="line">$ k get po -l app=nginx</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-7f8c49f5b4-pj5v8   1/1     Running   0          4m38s</span><br><span class="line"></span><br><span class="line">$ k get pdb</span><br><span class="line">NAME               MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE</span><br><span class="line">nginx-deployment   1               N/A               0                     4m32s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果此时尝试<code>驱逐</code> Pod（没有对应的 kubectl 命令），但因为受限于 pdb 而失败，保证了应用的<code>可用性</code></p>
</blockquote>
<h1 id="应用管理"><a href="#应用管理" class="headerlink" title="应用管理"></a>应用管理</h1><h2 id="无状态"><a href="#无状态" class="headerlink" title="无状态"></a>无状态</h2><ol>
<li>ReplicaSet</li>
<li>Deployment - 描述<code>部署过程</code><ul>
<li><code>版本管理</code><ul>
<li>metadata.annotations.deployment.kubernetes.io&#x2F;revision &#x3D; “1”</li>
<li>spec.revisionHistoryLimit &#x3D; 10</li>
</ul>
</li>
<li><code>滚动升级策略</code><ul>
<li>spec.strategy.type &#x3D; RollingUpdate</li>
<li>spec.strategy.rollingUpdate.maxSurge &#x3D; 25%</li>
<li>spec.strategy.rollingUpdate.maxUnavailable &#x3D; 25%</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="有状态"><a href="#有状态" class="headerlink" title="有状态"></a>有状态</h2><h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><ol>
<li>spec.serviceName<ul>
<li>Pod 新增两个属性，<code>CodeDNS</code> 为该 Pod 创建一个 <code>A 记录</code><ul>
<li>PodName -&gt; <code>hostname</code></li>
<li>serviceName -&gt; <code>subdomain</code></li>
</ul>
</li>
</ul>
</li>
<li>spec.volumeClaimTemplates<ul>
<li>正是因为有状态，rollout restart 时，StatefulSet 需要先关闭（<code>解除状态占用</code>）再重启</li>
</ul>
</li>
</ol>
<h3 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h3><blockquote>
<p>创建 <code>Operator</code> 的关键是 <code>CRD</code> 的设计，<code>Operator = CRD + Controller</code></p>
</blockquote>
<h4 id="使用-CRD"><a href="#使用-CRD" class="headerlink" title="使用 CRD"></a>使用 CRD</h4><blockquote>
<p>用户向 Kubernetes API 注册一个带有 <code>schema</code> 的资源，并定义相关 <code>API</code></p>
</blockquote>
<ol>
<li><code>注册</code>一系列该资源的<code>实例</code></li>
<li>在 Kubernetes 的其它资源对象中<code>引用</code>这个新注册资源的对象实例</li>
<li>用户自定义的 <code>Controller</code> 需要保证让新资源对象达到<code>预期状态</code></li>
</ol>
<h4 id="开发-CRD"><a href="#开发-CRD" class="headerlink" title="开发 CRD"></a>开发 CRD</h4><ol>
<li>借助 Kubernetes <code>RBAC</code> 和 <code>Authentication</code> 机制<ul>
<li>来保证 CRD 的 security、access control、authentication 和 multi-tenancy</li>
</ul>
</li>
<li>将 CRD 的数据存储到 Kubernetes <code>etcd</code> 集群</li>
<li>借助 Kubernetes 提供的 <code>Controller</code> 模式开发框架，实现新的 Controller<ul>
<li>并借助 <code>API Server</code> 监听 etcd 关于该资源的状态并定义状态变化的处理逻辑</li>
</ul>
</li>
<li>自定义的 Controller 与 Kubernetes 原生组件一样，Operator 直接使用 <code>Kubernetes API</code> 进行开发</li>
</ol>
<blockquote>
<p>Controller 模式</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217192520532.png" alt="image-20231217192520532"></p>
<h1 id="Operator-1"><a href="#Operator-1" class="headerlink" title="Operator"></a>Operator</h1><h2 id="生成-CRD"><a href="#生成-CRD" class="headerlink" title="生成 CRD"></a>生成 CRD</h2><blockquote>
<p>kubebuilder</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubebuilder version</span><br><span class="line">Version: main.version&#123;KubeBuilderVersion:&quot;3.4.0&quot;, KubernetesVendor:&quot;1.23.5&quot;, GitCommit:&quot;75241ab9ff9457de77e902645792cee41ba29fed&quot;, BuildDate:&quot;2022-04-28T17:09:31Z&quot;, GoOs:&quot;darwin&quot;, GoArch:&quot;arm64&quot;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>脚手架</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir my-operator</span><br><span class="line">$ cd my-operator/</span><br><span class="line"></span><br><span class="line">$ kubebuilder init --domain zhongmingmao.io</span><br><span class="line">Writing kustomize manifests for you to edit...</span><br><span class="line">Writing scaffold for you to edit...</span><br><span class="line">Get controller runtime:</span><br><span class="line">$ go get sigs.k8s.io/controller-runtime@v0.11.2</span><br><span class="line">go: downloading sigs.k8s.io/controller-runtime v0.11.2</span><br><span class="line">go: downloading k8s.io/client-go v0.23.5</span><br><span class="line">go: downloading k8s.io/apimachinery v0.23.5</span><br><span class="line">go: downloading k8s.io/utils v0.0.0-20211116205334-6203023598ed</span><br><span class="line">go: downloading github.com/go-logr/logr v1.2.0</span><br><span class="line">go: downloading github.com/prometheus/client_golang v1.11.0</span><br><span class="line">go: downloading github.com/google/gofuzz v1.1.0</span><br><span class="line">go: downloading k8s.io/component-base v0.23.5</span><br><span class="line">go: downloading sigs.k8s.io/structured-merge-diff/v4 v4.2.1</span><br><span class="line">go: downloading k8s.io/api v0.23.5</span><br><span class="line">go: downloading k8s.io/apiextensions-apiserver v0.23.5</span><br><span class="line">go: downloading github.com/google/go-cmp v0.5.5</span><br><span class="line">go: downloading golang.org/x/term v0.0.0-20210615171337-6886f2dfbf5b</span><br><span class="line">go: downloading golang.org/x/net v0.0.0-20211209124913-491a49abca63</span><br><span class="line">go: downloading github.com/google/uuid v1.1.2</span><br><span class="line">go: downloading github.com/prometheus/common v0.28.0</span><br><span class="line">go: downloading github.com/fsnotify/fsnotify v1.5.1</span><br><span class="line">go: downloading github.com/cespare/xxhash/v2 v2.1.1</span><br><span class="line">go: downloading github.com/prometheus/procfs v0.6.0</span><br><span class="line">go: downloading golang.org/x/sys v0.0.0-20211029165221-6e7872819dc8</span><br><span class="line">go: downloading golang.org/x/oauth2 v0.0.0-20210819190943-2bc19b11175f</span><br><span class="line">go: downloading google.golang.org/protobuf v1.27.1</span><br><span class="line">go: downloading gopkg.in/yaml.v3 v3.0.0-20210107192922-496545a6307b</span><br><span class="line">go: downloading golang.org/x/text v0.3.7</span><br><span class="line">Update dependencies:</span><br><span class="line">$ go mod tidy</span><br><span class="line">go: downloading github.com/stretchr/testify v1.7.0</span><br><span class="line">go: downloading github.com/Azure/go-autorest/autorest v0.11.18</span><br><span class="line">go: downloading github.com/Azure/go-autorest/autorest/adal v0.9.13</span><br><span class="line">go: downloading cloud.google.com/go v0.81.0</span><br><span class="line">go: downloading gopkg.in/check.v1 v1.0.0-20200227125254-8fa46927fb4f</span><br><span class="line">go: downloading github.com/niemeyer/pretty v0.0.0-20200227124842-a10e7caefd8e</span><br><span class="line">go: downloading github.com/Azure/go-autorest v14.2.0+incompatible</span><br><span class="line">go: downloading github.com/Azure/go-autorest/tracing v0.6.0</span><br><span class="line">go: downloading golang.org/x/crypto v0.0.0-20210817164053-32db794688a5</span><br><span class="line">go: downloading github.com/Azure/go-autorest/autorest/mocks v0.4.1</span><br><span class="line">go: downloading github.com/Azure/go-autorest/logger v0.2.1</span><br><span class="line">go: downloading github.com/Azure/go-autorest/autorest/date v0.3.0</span><br><span class="line">go: downloading github.com/form3tech-oss/jwt-go v3.2.3+incompatible</span><br><span class="line">go: downloading github.com/cespare/xxhash v1.1.0</span><br><span class="line">Next: define a resource with:</span><br><span class="line">$ kubebuilder create api</span><br><span class="line"></span><br><span class="line">$ cat PROJECT</span><br><span class="line">domain: zhongmingmao.io</span><br><span class="line">layout:</span><br><span class="line">- go.kubebuilder.io/v3</span><br><span class="line">projectName: my-operator</span><br><span class="line">repo: github.com/zhongmingmao/my-operator</span><br><span class="line">version: &quot;3&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成 CRD</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ kubebuilder create api --group apps --version v1beta1 --kind MyDaemonSet</span><br><span class="line">Create Resource [y/n]</span><br><span class="line">y</span><br><span class="line">Create Controller [y/n]</span><br><span class="line">y</span><br><span class="line">Writing kustomize manifests for you to edit...</span><br><span class="line">Writing scaffold for you to edit...</span><br><span class="line">api/v1beta1/mydaemonset_types.go</span><br><span class="line">controllers/mydaemonset_controller.go</span><br><span class="line">Update dependencies:</span><br><span class="line">$ go mod tidy</span><br><span class="line">Running make:</span><br><span class="line">$ make generate</span><br><span class="line">mkdir -p /Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin</span><br><span class="line">GOBIN=/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.8.0</span><br><span class="line">go: downloading sigs.k8s.io/controller-tools v0.8.0</span><br><span class="line">go: downloading github.com/spf13/cobra v1.2.1</span><br><span class="line">go: downloading github.com/fatih/color v1.12.0</span><br><span class="line">go: downloading golang.org/x/tools v0.1.6-0.20210820212750-d4cc65f0b2ff</span><br><span class="line">go: downloading github.com/gobuffalo/flect v0.2.3</span><br><span class="line">go: downloading github.com/mattn/go-colorable v0.1.8</span><br><span class="line">go: downloading github.com/mattn/go-isatty v0.0.12</span><br><span class="line">go: downloading sigs.k8s.io/structured-merge-diff/v4 v4.1.2</span><br><span class="line">go: downloading github.com/google/go-cmp v0.5.6</span><br><span class="line">go: downloading golang.org/x/net v0.0.0-20210825183410-e898025ed96a</span><br><span class="line">go: downloading golang.org/x/sys v0.0.0-20210831042530-f4d43177bf5e</span><br><span class="line">go: downloading golang.org/x/mod v0.4.2</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line">Next: implement your new API and generate the manifests (e.g. CRDs,CRs) with:</span><br><span class="line">$ make manifests</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217210153870.png" alt="image-20231217210153870"></p>
<blockquote>
<p>groupversion_info.go</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217205510682.png" alt="image-20231217205510682"></p>
<blockquote>
<p>mydaemonset_types.go</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217205620304.png" alt="image-20231217205620304"></p>
<blockquote>
<p>make</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ make help</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  make &lt;target&gt;</span><br><span class="line"></span><br><span class="line">General</span><br><span class="line">  help             Display this help.</span><br><span class="line"></span><br><span class="line">Development</span><br><span class="line">  manifests        Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">  generate         Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.</span><br><span class="line">  fmt              Run go fmt against code.</span><br><span class="line">  vet              Run go vet against code.</span><br><span class="line">  test             Run tests.</span><br><span class="line"></span><br><span class="line">Build</span><br><span class="line">  build            Build manager binary.</span><br><span class="line">  run              Run a controller from your host.</span><br><span class="line">  docker-build     Build docker image with the manager.</span><br><span class="line">  docker-push      Push docker image with the manager.</span><br><span class="line"></span><br><span class="line">Deployment</span><br><span class="line">  install          Install CRDs into the K8s cluster specified in ~/.kube/config.</span><br><span class="line">  uninstall        Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">  deploy           Deploy controller to the K8s cluster specified in ~/.kube/config.</span><br><span class="line">  undeploy         Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line"></span><br><span class="line">Build Dependencies</span><br><span class="line">  kustomize        Download kustomize locally if necessary.</span><br><span class="line">  controller-gen   Download controller-gen locally if necessary.</span><br><span class="line">  envtest          Download envtest-setup locally if necessary.</span><br></pre></td></tr></table></figure>

<h2 id="修改-CRD"><a href="#修改-CRD" class="headerlink" title="修改 CRD"></a>修改 CRD</h2><blockquote>
<p>为 Spec 定义字段 Image</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyDaemonSetSpec defines the desired state of MyDaemonSet</span></span><br><span class="line"><span class="keyword">type</span> MyDaemonSetSpec <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span></span><br><span class="line">    <span class="comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Foo is an example field of MyDaemonSet. Edit mydaemonset_types.go to remove/update</span></span><br><span class="line">    Image <span class="type">string</span> <span class="string">`json:&quot;image,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyDaemonSetStatus defines the observed state of MyDaemonSet</span></span><br><span class="line"><span class="keyword">type</span> MyDaemonSetStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span></span><br><span class="line">    <span class="comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span></span><br><span class="line">    AvailableReplicas <span class="type">int</span> <span class="string">`json:&quot;availableReplicas,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>重新生成</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make generate</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make manifests</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217211020667.png" alt="image-20231217211020667"></p>
<figure class="highlight yaml"><figcaption><span>apps.zhongmingmao.io_mydaemonsets.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.8.0</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydaemonsets.apps.zhongmingmao.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">apps.zhongmingmao.io</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">MyDaemonSet</span></span><br><span class="line">    <span class="attr">listKind:</span> <span class="string">MyDaemonSetList</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">mydaemonsets</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">mydaemonset</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1beta1</span></span><br><span class="line">    <span class="attr">schema:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">MyDaemonSet</span> <span class="string">is</span> <span class="string">the</span> <span class="string">Schema</span> <span class="string">for</span> <span class="string">the</span> <span class="string">mydaemonsets</span> <span class="string">API</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">apiVersion:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">&#x27;APIVersion defines the versioned schema of this representation</span></span><br><span class="line"><span class="string">              of an object. Servers should convert recognized schemas to the latest</span></span><br><span class="line"><span class="string">              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27;</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">kind:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">&#x27;Kind is a string value representing the REST resource this</span></span><br><span class="line"><span class="string">              object represents. Servers may infer this from the endpoint the client</span></span><br><span class="line"><span class="string">              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27;</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">MyDaemonSetSpec</span> <span class="string">defines</span> <span class="string">the</span> <span class="string">desired</span> <span class="string">state</span> <span class="string">of</span> <span class="string">MyDaemonSet</span></span><br><span class="line">            <span class="attr">properties:</span></span><br><span class="line">              <span class="attr">image:</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">Foo</span> <span class="string">is</span> <span class="string">an</span> <span class="string">example</span> <span class="string">field</span> <span class="string">of</span> <span class="string">MyDaemonSet.</span> <span class="string">Edit</span> <span class="string">mydaemonset_types.go</span></span><br><span class="line">                  <span class="string">to</span> <span class="string">remove/update</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">status:</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">MyDaemonSetStatus</span> <span class="string">defines</span> <span class="string">the</span> <span class="string">observed</span> <span class="string">state</span> <span class="string">of</span> <span class="string">MyDaemonSet</span></span><br><span class="line">            <span class="attr">properties:</span></span><br><span class="line">              <span class="attr">availableReplicas:</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">&#x27;INSERT ADDITIONAL STATUS FIELD - define observed state</span></span><br><span class="line"><span class="string">                  of cluster Important: Run &quot;make&quot; to regenerate code after modifying</span></span><br><span class="line"><span class="string">                  this file&#x27;</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">    <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">subresources:</span></span><br><span class="line">      <span class="attr">status:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">acceptedNames:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">conditions:</span> []</span><br><span class="line">  <span class="attr">storedVersions:</span> []</span><br></pre></td></tr></table></figure>

<h2 id="编写-Controller"><a href="#编写-Controller" class="headerlink" title="编写 Controller"></a>编写 Controller</h2><h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217211522013.png" alt="image-20231217211522013"></p>
<blockquote>
<p>SetupWithManager - 监听 MyDaemonSet 对象</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231217211902290.png" alt="image-20231217211902290"></p>
<blockquote>
<p>Reconcile - Worker 处理实际逻辑</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MyDaemonSetReconciler)</span></span> Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <span class="type">error</span>) &#123;</span><br><span class="line">    _ = log.FromContext(ctx)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO(user): your logic here</span></span><br><span class="line"></span><br><span class="line">    ds := appsv1beta1.MyDaemonSet&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := r.Get(ctx, req.NamespacedName, &amp;ds); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ctrl.Result&#123;&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ds.Spec.Image == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ctrl.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> nodes = v1.NodeList&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := r.Client.List(ctx, &amp;nodes); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ctrl.Result&#123;&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, node := <span class="keyword">range</span> nodes.Items &#123;</span><br><span class="line">        pod := v1.Pod&#123;</span><br><span class="line">            TypeMeta: metav1.TypeMeta&#123;</span><br><span class="line">                APIVersion: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">                Kind:       <span class="string">&quot;Pod&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">                Namespace:    ds.Namespace,</span><br><span class="line">                GenerateName: fmt.Sprintf(<span class="string">&quot;%s-&quot;</span>, node.Name),</span><br><span class="line">            &#125;,</span><br><span class="line">            Spec: v1.PodSpec&#123;</span><br><span class="line">                Containers: []v1.Container&#123;</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name:  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">                        Image: ds.Spec.Image,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">                NodeName: node.Name,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err := r.Client.Create(ctx, &amp;pod); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ctrl.Result&#123;&#125;, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctrl.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make build</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line">go fmt ./...</span><br><span class="line">go vet ./...</span><br><span class="line">go build -o bin/manager main.go</span><br></pre></td></tr></table></figure>

<h2 id="安装-CRD"><a href="#安装-CRD" class="headerlink" title="安装 CRD"></a>安装 CRD</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ make install</span><br><span class="line">GOBIN=/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.8.0</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">curl -s &quot;https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh&quot; | bash -s -- 3.8.7 /Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin</span><br><span class="line">Version v3.8.7 does not exist for darwin/arm64, trying darwin/amd64 instead.</span><br><span class="line">&#123;Version:kustomize/v3.8.7 GitCommit:ad092cc7a91c07fdf63a2e4b7f13fa588a39af4f BuildDate:2020-11-11T23:19:38Z GoOs:darwin GoArch:amd64&#125;</span><br><span class="line">kustomize installed to /Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/kustomize</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/kustomize build config/crd | kubectl apply -f -</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/mydaemonsets.apps.zhongmingmao.io created</span><br><span class="line"></span><br><span class="line">$ k api-resources| grep my</span><br><span class="line">mydaemonsets                                                                      apps.zhongmingmao.io/v1beta1           true         MyDaemonSet</span><br><span class="line"></span><br><span class="line">$ k get crd -owide | grep my</span><br><span class="line">mydaemonsets.apps.zhongmingmao.io                     2022-12-17T13:46:34Z</span><br><span class="line"></span><br><span class="line">$ k get mydaemonsets -A</span><br><span class="line">No resources found</span><br></pre></td></tr></table></figure>

<h2 id="运行-Controller"><a href="#运行-Controller" class="headerlink" title="运行 Controller"></a>运行 Controller</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ make run</span><br><span class="line">GOBIN=/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.8.0</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line">go fmt ./...</span><br><span class="line">go vet ./...</span><br><span class="line">go run ./main.go</span><br><span class="line">1.7028209916749592e+09    INFO	controller-runtime.metrics	Metrics server is starting to listen	&#123;&quot;addr&quot;: &quot;:8080&quot;&#125;</span><br><span class="line">1.702820991675578e+09    INFO	setup	starting manager</span><br><span class="line">1.70282099167606e+09    INFO	Starting server	&#123;&quot;kind&quot;: &quot;health probe&quot;, &quot;addr&quot;: &quot;[::]:8081&quot;&#125;</span><br><span class="line">1.70282099167611e+09    INFO	Starting server	&#123;&quot;path&quot;: &quot;/metrics&quot;, &quot;kind&quot;: &quot;metrics&quot;, &quot;addr&quot;: &quot;[::]:8080&quot;&#125;</span><br><span class="line">1.7028209916764538e+09    INFO	controller.mydaemonset	Starting EventSource	&#123;&quot;reconciler group&quot;: &quot;apps.zhongmingmao.io&quot;, &quot;reconciler kind&quot;: &quot;MyDaemonSet&quot;, &quot;source&quot;: &quot;kind source: *v1beta1.MyDaemonSet&quot;&#125;</span><br><span class="line">1.702820991676507e+09    INFO	controller.mydaemonset	Starting Controller	&#123;&quot;reconciler group&quot;: &quot;apps.zhongmingmao.io&quot;, &quot;reconciler kind&quot;: &quot;MyDaemonSet&quot;&#125;</span><br><span class="line">1.7028209917778409e+09    INFO	controller.mydaemonset	Starting workers	&#123;&quot;reconciler group&quot;: &quot;apps.zhongmingmao.io&quot;, &quot;reconciler kind&quot;: &quot;MyDaemonSet&quot;, &quot;worker count&quot;: 1&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tree config/samples</span><br><span class="line">config/samples</span><br><span class="line">└── apps_v1beta1_mydaemonset.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>apps_v1beta1_mydaemonset.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps.zhongmingmao.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MyDaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydaemonset-sample</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">nginx:stable-alpine3.17</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f config/samples/apps_v1beta1_mydaemonset.yaml</span><br><span class="line">mydaemonset.apps.zhongmingmao.io/mydaemonset-sample created</span><br><span class="line"></span><br><span class="line">$ k get mydaemonsets -A</span><br><span class="line">NAMESPACE   NAME                 AGE</span><br><span class="line">default     mydaemonset-sample   22s</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE     IP                NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">zhongmingmao-b8kzg   1/1     Running   0          2m12s   192.168.216.211   zhongmingmao   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get po zhongmingmao-b8kzg -oyaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cni.projectcalico.org/containerID:</span> <span class="string">40860da765849549606348d9ba20a2bd963515c3522b1244d40f71b2f31b4bfa</span></span><br><span class="line">    <span class="attr">cni.projectcalico.org/podIP:</span> <span class="number">192.168</span><span class="number">.216</span><span class="number">.211</span><span class="string">/32</span></span><br><span class="line">    <span class="attr">cni.projectcalico.org/podIPs:</span> <span class="number">192.168</span><span class="number">.216</span><span class="number">.211</span><span class="string">/32</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-12-17T13:53:06Z&quot;</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">zhongmingmao-</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhongmingmao-b8kzg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;47820&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">256211d1-bc1a-43dd-b961-956d8a1f0fdf</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:stable-alpine3.17</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-2vsk6</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">zhongmingmao</span></span><br><span class="line">  <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-2vsk6</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-12-17T13:53:06Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-12-17T13:53:07Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-12-17T13:53:07Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-12-17T13:53:06Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://e425f12f3f92b19ebd2b2cf12aea2545080bb8e6f5a8ce20f94095219097d3e8</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:stable-alpine3.17</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:0571deea2fbe77c6779607b66ee64e270922bb289849f764d9edc15645d132f5</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-12-17T13:53:07Z&quot;</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">192.168</span><span class="number">.191</span><span class="number">.167</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">192.168</span><span class="number">.216</span><span class="number">.211</span></span><br><span class="line">  <span class="attr">podIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.216</span><span class="number">.211</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2022-12-17T13:53:06Z&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="生成-webhook"><a href="#生成-webhook" class="headerlink" title="生成 webhook"></a>生成 webhook</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubebuilder create webhook --group apps --version v1beta1 --kind MyDaemonSet --defaulting --programmatic-validation</span><br><span class="line">Writing kustomize manifests for you to edit...</span><br><span class="line">Writing scaffold for you to edit...</span><br><span class="line">api/v1beta1/mydaemonset_webhook.go</span><br><span class="line">Update dependencies:</span><br><span class="line">$ go mod tidy</span><br><span class="line">Running make:</span><br><span class="line">$ make generate</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line">Next: implement your new Webhook and generate the manifests with:</span><br><span class="line">$ make manifests</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231218224955108.png" alt="image-20231218224955108"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ValidateCreate implements webhook.Validator so a webhook will be registered for the type</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *MyDaemonSet)</span></span> ValidateCreate() <span class="type">error</span> &#123;</span><br><span class="line">    mydaemonsetlog.Info(<span class="string">&quot;validate create&quot;</span>, <span class="string">&quot;name&quot;</span>, r.Name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO(user): fill in your validation logic upon object creation.</span></span><br><span class="line">    <span class="keyword">if</span> r.Spec.Image == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;image is required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make manifests</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231218225257085.png" alt="image-20231218225257085"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ make docker-build</span><br><span class="line">$ make docker-push</span><br><span class="line"></span><br><span class="line">$ make deploy</span><br><span class="line">GOBIN=/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.8.0</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">cd config/manager &amp;&amp; /Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/kustomize edit set image controller=zhongmingmao/controller:0.0.1</span><br><span class="line">/Users/zhongmingmao/workspace/go/src/github.com/zhongmingmao/my-operator/bin/kustomize build config/default | kubectl apply -f -</span><br><span class="line">namespace/my-operator-system created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/mydaemonsets.apps.zhongmingmao.io configured</span><br><span class="line">serviceaccount/my-operator-controller-manager created</span><br><span class="line">role.rbac.authorization.k8s.io/my-operator-leader-election-role created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/my-operator-manager-role created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/my-operator-metrics-reader created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/my-operator-proxy-role created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/my-operator-leader-election-rolebinding created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/my-operator-manager-rolebinding created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/my-operator-proxy-rolebinding created</span><br><span class="line">configmap/my-operator-manager-config created</span><br><span class="line">service/my-operator-controller-manager-metrics-service created</span><br><span class="line">service/my-operator-webhook-service created</span><br><span class="line">deployment.apps/my-operator-controller-manager created</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.io/my-operator-mutating-webhook-configuration created</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.io/my-operator-validating-webhook-configuration created</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ k get all -n my-operator-system</span><br><span class="line">NAME                                                 READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/my-operator-controller-manager-57f4b55f6-nh9bq   0/2     ContainerCreating   0          4m20s</span><br><span class="line"></span><br><span class="line">NAME                                                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/my-operator-controller-manager-metrics-service   ClusterIP   10.109.32.208   &lt;none&gt;        8443/TCP   4m20s</span><br><span class="line">service/my-operator-webhook-service                      ClusterIP   10.99.60.181    &lt;none&gt;        443/TCP    4m20s</span><br><span class="line"></span><br><span class="line">NAME                                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/my-operator-controller-manager   0/1     1            0           4m20s</span><br><span class="line"></span><br><span class="line">NAME                                                       DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/my-operator-controller-manager-57f4b55f6   1         1         0       4m20s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get po -n my-operator-system my-operator-controller-manager-57f4b55f6-nh9bq -oyaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp/k8s-webhook-server/serving-certs</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cert</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cert</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">webhook-server-cert</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get validatingwebhookconfigurations.admissionregistration.k8s.io</span><br><span class="line">NAME                                           WEBHOOKS   AGE</span><br><span class="line">my-operator-validating-webhook-configuration   1          9m36s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get validatingwebhookconfigurations.admissionregistration.k8s.io my-operator-validating-webhook-configuration -oyaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cert-manager.io/inject-ca-from:</span> <span class="string">my-operator-system/my-operator-serving-cert</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;admissionregistration.k8s.io/v1&quot;,&quot;kind&quot;:&quot;ValidatingWebhookConfiguration&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;cert-manager.io/inject-ca-from&quot;:&quot;my-operator-system/my-operator-serving-cert&quot;&#125;,&quot;name&quot;:&quot;my-operator-validating-webhook-configuration&quot;&#125;,&quot;webhooks&quot;:[&#123;&quot;admissionReviewVersions&quot;:[&quot;v1&quot;],&quot;clientConfig&quot;:&#123;&quot;service&quot;:&#123;&quot;name&quot;:&quot;my-operator-webhook-service&quot;,&quot;namespace&quot;:&quot;my-operator-system&quot;,&quot;path&quot;:&quot;/validate-apps-zhongmingmao-io-v1beta1-mydaemonset&quot;&#125;&#125;,&quot;failurePolicy&quot;:&quot;Fail&quot;,&quot;name&quot;:&quot;vmydaemonset.kb.io&quot;,&quot;rules&quot;:[&#123;&quot;apiGroups&quot;:[&quot;apps.zhongmingmao.io&quot;],&quot;apiVersions&quot;:[&quot;v1beta1&quot;],&quot;operations&quot;:[&quot;CREATE&quot;,&quot;UPDATE&quot;],&quot;resources&quot;:[&quot;mydaemonsets&quot;]&#125;],&quot;sideEffects&quot;:&quot;None&quot;&#125;]&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-12-18T15:37:36Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-operator-validating-webhook-configuration</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;61873&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">22c5221f-9fe1-42df-871b-df1463d4fb26</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">admissionReviewVersions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-operator-webhook-service</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">my-operator-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/validate-apps-zhongmingmao-io-v1beta1-mydaemonset</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmydaemonset.kb.io</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">objectSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apps.zhongmingmao.io</span></span><br><span class="line">    <span class="attr">apiVersions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">    <span class="attr">operations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">UPDATE</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mydaemonsets</span></span><br><span class="line">    <span class="attr">scope:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2023/01/27/cloud-native-foundation-k8s-operator/">https://blog.zhongmingmao.top/2023/01/27/cloud-native-foundation-k8s-operator/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/28/cloud-native-foundation-k8s-helm/" title="Kubernetes - Helm"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-helm.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes - Helm</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/26/go-foundation-pointer/" title="Go - Pointer"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-pointer.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Go - Pointer</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-11</div><div class="title">Kubernetes - Helm Doc</div></div></a></div><div><a href="/2023/02/02/cloud-native-foundation-k8s-security/" title="Kubernetes - Security"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-security.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-02</div><div class="title">Kubernetes - Security</div></div></a></div><div><a href="/2023/02/01/cloud-native-foundation-k8s-federation/" title="Kubernetes - Federation"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/federation.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">Kubernetes - Federation</div></div></a></div><div><a href="/2023/01/31/cloud-native-foundation-k8s-istio/" title="Kubernetes - Istio"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-31</div><div class="title">Kubernetes - Istio</div></div></a></div><div><a href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/go-envoy.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-30</div><div class="title">Kubernetes - Envoy</div></div></a></div><div><a href="/2023/01/29/cloud-native-foundation-k8s-scaling/" title="Kubernetes - Scaling"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231223144041516.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-29</div><div class="title">Kubernetes - Scaling</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">526</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">158</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">71</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%8E%A5%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">应用接入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">应用容器化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E9%94%80%E9%A3%8E%E9%99%A9"><span class="toc-number">1.1.1.</span> <span class="toc-text">开销风险</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7"><span class="toc-number">1.1.2.</span> <span class="toc-text">资源监控</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%A7%86%E8%A7%92"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">应用视角</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E5%BA%94%E7%94%A8"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">影响应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">判断规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memory"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">Memory</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PID-%E6%B3%84%E9%9C%B2"><span class="toc-number">1.2.</span> <span class="toc-text">PID 泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PodDisruptionBudget"><span class="toc-number">1.3.</span> <span class="toc-text">PodDisruptionBudget</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">应用管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E7%8A%B6%E6%80%81"><span class="toc-number">2.1.</span> <span class="toc-text">无状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E7%8A%B6%E6%80%81"><span class="toc-number">2.2.</span> <span class="toc-text">有状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#StatefulSet"><span class="toc-number">2.2.1.</span> <span class="toc-text">StatefulSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Operator"><span class="toc-number">2.2.2.</span> <span class="toc-text">Operator</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-CRD"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">使用 CRD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91-CRD"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">开发 CRD</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Operator-1"><span class="toc-number">3.</span> <span class="toc-text">Operator</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90-CRD"><span class="toc-number">3.1.</span> <span class="toc-text">生成 CRD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-CRD"><span class="toc-number">3.2.</span> <span class="toc-text">修改 CRD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99-Controller"><span class="toc-number">3.3.</span> <span class="toc-text">编写 Controller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81"><span class="toc-number">3.3.1.</span> <span class="toc-text">编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">3.3.2.</span> <span class="toc-text">构建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-CRD"><span class="toc-number">3.4.</span> <span class="toc-text">安装 CRD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-Controller"><span class="toc-number">3.5.</span> <span class="toc-text">运行 Controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.6.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90-webhook"><span class="toc-number">3.7.</span> <span class="toc-text">生成 webhook</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/27/llm-langchain-rag/" title="LLM - LangChain + RAG"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/langchain-rag.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM - LangChain + RAG"/></a><div class="content"><a class="title" href="/2024/06/27/llm-langchain-rag/" title="LLM - LangChain + RAG">LLM - LangChain + RAG</a><time datetime="2024-06-26T16:06:25.000Z" title="Created 2024-06-27 00:06:25">2024-06-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/26/llm-prompt/" title="LLM - Prompt"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/llm-prompt.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM - Prompt"/></a><div class="content"><a class="title" href="/2024/06/26/llm-prompt/" title="LLM - Prompt">LLM - Prompt</a><time datetime="2024-06-25T16:06:25.000Z" title="Created 2024-06-26 00:06:25">2024-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/25/llm-chatgpt/" title="LLM - ChatGPT"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/llm-chatgpt.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM - ChatGPT"/></a><div class="content"><a class="title" href="/2024/06/25/llm-chatgpt/" title="LLM - ChatGPT">LLM - ChatGPT</a><time datetime="2024-06-24T16:06:25.000Z" title="Created 2024-06-25 00:06:25">2024-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - Helm Doc"/></a><div class="content"><a class="title" href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc">Kubernetes - Helm Doc</a><time datetime="2023-05-10T16:06:25.000Z" title="Created 2023-05-11 00:06:25">2023-05-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Engineering - CLI"/></a><div class="content"><a class="title" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI">Go Engineering - CLI</a><time datetime="2023-05-09T16:06:25.000Z" title="Created 2023-05-10 00:06:25">2023-05-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2024 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
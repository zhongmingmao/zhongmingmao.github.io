<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - Istio | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="CRD 核心为 networking  12345678910111213141516171819202122$ istioctl versionclient version: 1.19.3control plane version: 1.19.3data plane version: 1.19.3 (2 proxies)$ k get crdNAME">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Istio">
<meta property="og:url" content="https://blog.zhongmingmao.top/2023/01/31/cloud-native-foundation-k8s-istio/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="CRD 核心为 networking  12345678910111213141516171819202122$ istioctl versionclient version: 1.19.3control plane version: 1.19.3data plane version: 1.19.3 (2 proxies)$ k get crdNAME">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp">
<meta property="article:published_time" content="2023-01-30T16:06:25.000Z">
<meta property="article:modified_time" content="2024-01-12T14:18:50.810Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cloud Native Foundation">
<meta property="article:tag" content="Service Mesh">
<meta property="article:tag" content="Istio">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2023/01/31/cloud-native-foundation-k8s-istio/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - Istio',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-12 22:18:50'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">531</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">166</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">71</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - Istio</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2023-01-30T16:06:25.000Z" title="Created 2023-01-31 00:06:25">2023-01-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">9.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>55min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h1><blockquote>
<p>核心为 <code>networking</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl version</span><br><span class="line">client version: 1.19.3</span><br><span class="line">control plane version: 1.19.3</span><br><span class="line">data plane version: 1.19.3 (2 proxies)</span><br><span class="line"></span><br><span class="line">$ k get crd</span><br><span class="line">NAME                                       CREATED AT</span><br><span class="line">authorizationpolicies.security.istio.io    2022-12-27T02:58:37Z</span><br><span class="line">destinationrules.networking.istio.io       2022-12-27T02:58:37Z</span><br><span class="line">envoyfilters.networking.istio.io           2022-12-27T02:58:37Z</span><br><span class="line">gateways.networking.istio.io               2022-12-27T02:58:37Z</span><br><span class="line">istiooperators.install.istio.io            2022-12-27T02:58:37Z</span><br><span class="line">peerauthentications.security.istio.io      2022-12-27T02:58:37Z</span><br><span class="line">proxyconfigs.networking.istio.io           2022-12-27T02:58:37Z</span><br><span class="line">requestauthentications.security.istio.io   2022-12-27T02:58:37Z</span><br><span class="line">serviceentries.networking.istio.io         2022-12-27T02:58:37Z</span><br><span class="line">sidecars.networking.istio.io               2022-12-27T02:58:37Z</span><br><span class="line">telemetries.telemetry.istio.io             2022-12-27T02:58:37Z</span><br><span class="line">virtualservices.networking.istio.io        2022-12-27T02:58:37Z</span><br><span class="line">wasmplugins.extensions.istio.io            2022-12-27T02:58:37Z</span><br><span class="line">workloadentries.networking.istio.io        2022-12-27T02:58:37Z</span><br><span class="line">workloadgroups.networking.istio.io         2022-12-27T02:58:37Z</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="Sidecar"><a href="#Sidecar" class="headerlink" title="Sidecar"></a>Sidecar</h1><blockquote>
<p>创建 namespace</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k create ns sidecar</span><br><span class="line">namespace/sidecar created</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为新建的 namespace 打上 label，该 namespace 下的 Pod 需要自动插入 sidecar</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k label ns sidecar istio-injection=enabled</span><br><span class="line">namespace/sidecar labeled</span><br><span class="line"></span><br><span class="line">$ k get mutatingwebhookconfigurations.admissionregistration.k8s.io</span><br><span class="line">NAME                         WEBHOOKS   AGE</span><br><span class="line">istio-revision-tag-default   4          5d8h</span><br><span class="line">istio-sidecar-injector       4          5d8h</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get mutatingwebhookconfigurations.admissionregistration.k8s.io istio-sidecar-injector -oyaml<br>监听到 <code>Pod</code> 的<code>创建事件</code>后，调用 <code>istio-system.istiod:443/inject</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MutatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-12-27T02:58:37Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sidecar-injector</span></span><br><span class="line">    <span class="attr">install.operator.istio.io/owning-resource:</span> <span class="string">installed-state</span></span><br><span class="line">    <span class="attr">install.operator.istio.io/owning-resource-namespace:</span> <span class="string">istio-system</span></span><br><span class="line">    <span class="attr">istio.io/rev:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">operator.istio.io/component:</span> <span class="string">Pilot</span></span><br><span class="line">    <span class="attr">operator.istio.io/managed:</span> <span class="string">Reconcile</span></span><br><span class="line">    <span class="attr">operator.istio.io/version:</span> <span class="number">1.19</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">istio</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">istio-sidecar-injector</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;1785&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">fddd28a2-5961-498e-8f40-179b9007b0db</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">admissionReviewVersions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">caBundle:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvRENDQWVTZ0F3SUJBZ0lRYmhJa3NCZVNoY3lnTzZpK0hMc0RsREFOQmdrcWhraUc5dzBCQVFzRkFEQVkKTVJZd0ZBWURWUVFLRXcxamJIVnpkR1Z5TG14dlkyRnNNQjRYRFRJek1USXlOekF6TURBek5Gb1hEVE16TVRJeQpOREF6TURBek5Gb3dHREVXTUJRR0ExVUVDaE1OWTJ4MWMzUmxjaTVzYjJOaGJEQ0NBU0l3RFFZSktvWklodmNOCkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMczVVZGg5K285c1FUUndwRUdBd2ZCNlRmQWZMUTFFbnVPK0U5QWkKK0dMd3p2dXhyZGFBcmRkUXYzY0ZMc2pwWjJlVGZWRUw5Vm9mRGowTXlMSUZNUEgrV0c5OU1hQ0dkVnJSVlZFdApWWHdKa3V1bVB3bEQxdmdIQXdQUUgrSXJPTlZpU2hkeXVwUUtmMzFpb3ZrWStaMkpXK2pnZ0NqSEJWdk5uQnB4CmJKUTd1Q1NJZEpiYmQxaDg3V2x0NVZ4TFAwc0p4RUxGQlo4NFp4RWJHYVQzSXV1UWRWbFdoVElFN2Q5ZjZucDQKcnNzSmZXd3RqZmsyNmxlQktaelJtSmZzeGV2MTFQWjZYNzkyWUtlRHJ6ZU8rSDREem5IeUpNT01qTHJsb0hkUwpRWi9NNkI1bW9TdklTZkZIbG1NSTU2OTE4bWFDZkF2SW12c0NoMVY1YWlKMzUwOENBd0VBQWFOQ01FQXdEZ1lEClZSMFBBUUgvQkFRREFnSUVNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGSUlidVY3VTI0cUsKYjVVOG9HSVFlYXU4Y0JNZE1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQXVva2p5TmxySU5pNWhwNDYvWkR2UApaakd0aW5sM21VR2NtUTljOE1teE5FZUxWa2hvaXppc1NPK2tkNEZVMDBtcEsxWmJyMXpyeE9oWVBHL1dlS3k4CkVKbmFpRm95QUFveEptUlhNUTUxaE1FaDFEc2VKM3NTTmZtUzE3U0lPSDIraGMrcHBsWE1sdFgrY1p3Z3RwNEMKMFdDVVB1WERJcktBbEQxZi9OTGtxSDZudnZUTnNwOGlYWndLblF2ZHE0M2lBclgvSkptdGR4cGFQTmZsSUFwdgozdy9QM1J3R3E2L0tKWDNSTUYzZjRxYlFVZExCMVBxeUhHT0hBR2xWZzV4SFNqZmw3bzlnYlhVWDBXOUpQWmtQCjFrREtYN0xYcllINXErVXBSRmlKcGhSK3ovM25LaFRpVGdyemEvSm1zR1pteEt4Vkk4Q1h5Wm5UckZJdlR3QVkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istiod</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/inject</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rev.namespace.sidecar-injector.istio.io</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">objectSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">reinvocationPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">apiVersions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">operations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">scope:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">admissionReviewVersions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">caBundle:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvRENDQWVTZ0F3SUJBZ0lRYmhJa3NCZVNoY3lnTzZpK0hMc0RsREFOQmdrcWhraUc5dzBCQVFzRkFEQVkKTVJZd0ZBWURWUVFLRXcxamJIVnpkR1Z5TG14dlkyRnNNQjRYRFRJek1USXlOekF6TURBek5Gb1hEVE16TVRJeQpOREF6TURBek5Gb3dHREVXTUJRR0ExVUVDaE1OWTJ4MWMzUmxjaTVzYjJOaGJEQ0NBU0l3RFFZSktvWklodmNOCkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMczVVZGg5K285c1FUUndwRUdBd2ZCNlRmQWZMUTFFbnVPK0U5QWkKK0dMd3p2dXhyZGFBcmRkUXYzY0ZMc2pwWjJlVGZWRUw5Vm9mRGowTXlMSUZNUEgrV0c5OU1hQ0dkVnJSVlZFdApWWHdKa3V1bVB3bEQxdmdIQXdQUUgrSXJPTlZpU2hkeXVwUUtmMzFpb3ZrWStaMkpXK2pnZ0NqSEJWdk5uQnB4CmJKUTd1Q1NJZEpiYmQxaDg3V2x0NVZ4TFAwc0p4RUxGQlo4NFp4RWJHYVQzSXV1UWRWbFdoVElFN2Q5ZjZucDQKcnNzSmZXd3RqZmsyNmxlQktaelJtSmZzeGV2MTFQWjZYNzkyWUtlRHJ6ZU8rSDREem5IeUpNT01qTHJsb0hkUwpRWi9NNkI1bW9TdklTZkZIbG1NSTU2OTE4bWFDZkF2SW12c0NoMVY1YWlKMzUwOENBd0VBQWFOQ01FQXdEZ1lEClZSMFBBUUgvQkFRREFnSUVNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGSUlidVY3VTI0cUsKYjVVOG9HSVFlYXU4Y0JNZE1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQXVva2p5TmxySU5pNWhwNDYvWkR2UApaakd0aW5sM21VR2NtUTljOE1teE5FZUxWa2hvaXppc1NPK2tkNEZVMDBtcEsxWmJyMXpyeE9oWVBHL1dlS3k4CkVKbmFpRm95QUFveEptUlhNUTUxaE1FaDFEc2VKM3NTTmZtUzE3U0lPSDIraGMrcHBsWE1sdFgrY1p3Z3RwNEMKMFdDVVB1WERJcktBbEQxZi9OTGtxSDZudnZUTnNwOGlYWndLblF2ZHE0M2lBclgvSkptdGR4cGFQTmZsSUFwdgozdy9QM1J3R3E2L0tKWDNSTUYzZjRxYlFVZExCMVBxeUhHT0hBR2xWZzV4SFNqZmw3bzlnYlhVWDBXOUpQWmtQCjFrREtYN0xYcllINXErVXBSRmlKcGhSK3ovM25LaFRpVGdyemEvSm1zR1pteEt4Vkk4Q1h5Wm5UckZJdlR3QVkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istiod</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/inject</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rev.object.sidecar-injector.istio.io</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">objectSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">reinvocationPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">apiVersions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">operations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">scope:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">admissionReviewVersions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">caBundle:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvRENDQWVTZ0F3SUJBZ0lRYmhJa3NCZVNoY3lnTzZpK0hMc0RsREFOQmdrcWhraUc5dzBCQVFzRkFEQVkKTVJZd0ZBWURWUVFLRXcxamJIVnpkR1Z5TG14dlkyRnNNQjRYRFRJek1USXlOekF6TURBek5Gb1hEVE16TVRJeQpOREF6TURBek5Gb3dHREVXTUJRR0ExVUVDaE1OWTJ4MWMzUmxjaTVzYjJOaGJEQ0NBU0l3RFFZSktvWklodmNOCkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMczVVZGg5K285c1FUUndwRUdBd2ZCNlRmQWZMUTFFbnVPK0U5QWkKK0dMd3p2dXhyZGFBcmRkUXYzY0ZMc2pwWjJlVGZWRUw5Vm9mRGowTXlMSUZNUEgrV0c5OU1hQ0dkVnJSVlZFdApWWHdKa3V1bVB3bEQxdmdIQXdQUUgrSXJPTlZpU2hkeXVwUUtmMzFpb3ZrWStaMkpXK2pnZ0NqSEJWdk5uQnB4CmJKUTd1Q1NJZEpiYmQxaDg3V2x0NVZ4TFAwc0p4RUxGQlo4NFp4RWJHYVQzSXV1UWRWbFdoVElFN2Q5ZjZucDQKcnNzSmZXd3RqZmsyNmxlQktaelJtSmZzeGV2MTFQWjZYNzkyWUtlRHJ6ZU8rSDREem5IeUpNT01qTHJsb0hkUwpRWi9NNkI1bW9TdklTZkZIbG1NSTU2OTE4bWFDZkF2SW12c0NoMVY1YWlKMzUwOENBd0VBQWFOQ01FQXdEZ1lEClZSMFBBUUgvQkFRREFnSUVNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGSUlidVY3VTI0cUsKYjVVOG9HSVFlYXU4Y0JNZE1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQXVva2p5TmxySU5pNWhwNDYvWkR2UApaakd0aW5sM21VR2NtUTljOE1teE5FZUxWa2hvaXppc1NPK2tkNEZVMDBtcEsxWmJyMXpyeE9oWVBHL1dlS3k4CkVKbmFpRm95QUFveEptUlhNUTUxaE1FaDFEc2VKM3NTTmZtUzE3U0lPSDIraGMrcHBsWE1sdFgrY1p3Z3RwNEMKMFdDVVB1WERJcktBbEQxZi9OTGtxSDZudnZUTnNwOGlYWndLblF2ZHE0M2lBclgvSkptdGR4cGFQTmZsSUFwdgozdy9QM1J3R3E2L0tKWDNSTUYzZjRxYlFVZExCMVBxeUhHT0hBR2xWZzV4SFNqZmw3bzlnYlhVWDBXOUpQWmtQCjFrREtYN0xYcllINXErVXBSRmlKcGhSK3ovM25LaFRpVGdyemEvSm1zR1pteEt4Vkk4Q1h5Wm5UckZJdlR3QVkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istiod</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/inject</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">namespace.sidecar-injector.istio.io</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">objectSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">reinvocationPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">apiVersions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">operations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">scope:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">admissionReviewVersions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">caBundle:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvRENDQWVTZ0F3SUJBZ0lRYmhJa3NCZVNoY3lnTzZpK0hMc0RsREFOQmdrcWhraUc5dzBCQVFzRkFEQVkKTVJZd0ZBWURWUVFLRXcxamJIVnpkR1Z5TG14dlkyRnNNQjRYRFRJek1USXlOekF6TURBek5Gb1hEVE16TVRJeQpOREF6TURBek5Gb3dHREVXTUJRR0ExVUVDaE1OWTJ4MWMzUmxjaTVzYjJOaGJEQ0NBU0l3RFFZSktvWklodmNOCkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMczVVZGg5K285c1FUUndwRUdBd2ZCNlRmQWZMUTFFbnVPK0U5QWkKK0dMd3p2dXhyZGFBcmRkUXYzY0ZMc2pwWjJlVGZWRUw5Vm9mRGowTXlMSUZNUEgrV0c5OU1hQ0dkVnJSVlZFdApWWHdKa3V1bVB3bEQxdmdIQXdQUUgrSXJPTlZpU2hkeXVwUUtmMzFpb3ZrWStaMkpXK2pnZ0NqSEJWdk5uQnB4CmJKUTd1Q1NJZEpiYmQxaDg3V2x0NVZ4TFAwc0p4RUxGQlo4NFp4RWJHYVQzSXV1UWRWbFdoVElFN2Q5ZjZucDQKcnNzSmZXd3RqZmsyNmxlQktaelJtSmZzeGV2MTFQWjZYNzkyWUtlRHJ6ZU8rSDREem5IeUpNT01qTHJsb0hkUwpRWi9NNkI1bW9TdklTZkZIbG1NSTU2OTE4bWFDZkF2SW12c0NoMVY1YWlKMzUwOENBd0VBQWFOQ01FQXdEZ1lEClZSMFBBUUgvQkFRREFnSUVNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGSUlidVY3VTI0cUsKYjVVOG9HSVFlYXU4Y0JNZE1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQXVva2p5TmxySU5pNWhwNDYvWkR2UApaakd0aW5sM21VR2NtUTljOE1teE5FZUxWa2hvaXppc1NPK2tkNEZVMDBtcEsxWmJyMXpyeE9oWVBHL1dlS3k4CkVKbmFpRm95QUFveEptUlhNUTUxaE1FaDFEc2VKM3NTTmZtUzE3U0lPSDIraGMrcHBsWE1sdFgrY1p3Z3RwNEMKMFdDVVB1WERJcktBbEQxZi9OTGtxSDZudnZUTnNwOGlYWndLblF2ZHE0M2lBclgvSkptdGR4cGFQTmZsSUFwdgozdy9QM1J3R3E2L0tKWDNSTUYzZjRxYlFVZExCMVBxeUhHT0hBR2xWZzV4SFNqZmw3bzlnYlhVWDBXOUpQWmtQCjFrREtYN0xYcllINXErVXBSRmlKcGhSK3ovM25LaFRpVGdyemEvSm1zR1pteEt4Vkk4Q1h5Wm5UckZJdlR3QVkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istiod</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/inject</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">object.sidecar-injector.istio.io</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">objectSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">istio.io/deactivated:</span> <span class="string">never-match</span></span><br><span class="line">  <span class="attr">reinvocationPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">apiVersions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">operations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">scope:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>服务端：Deployment + Service</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>nginx.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>部署服务端，Pod 中注入了 Sidecar，总共 2 个容器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f nginx.yaml -n sidecar</span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line">service/nginx created</span><br><span class="line"></span><br><span class="line">$ k get po -n sidecar</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-7fc7f5758-46mzh   2/2     Running   0          4m57s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get po -n sidecar nginx-deployment-7fc7f5758-46mzh -oyaml</p>
<ol>
<li><code>istio/proxyv2</code> 本质上是一个 <code>Envoy</code> Sidecar</li>
<li>还插入了一个 <code>initContainer</code>，执行 <code>istio-iptables</code> 命令，修改了<code>容器内部</code>的 <code>iptables</code> 规则</li>
</ol>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">istio.io/rev:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/default-container:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/default-logs-container:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">prometheus.io/path:</span> <span class="string">/stats/prometheus</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&quot;15020&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">sidecar.istio.io/status:</span> <span class="string">&#x27;&#123;&quot;initContainers&quot;:[&quot;istio-init&quot;],&quot;containers&quot;:[&quot;istio-proxy&quot;],&quot;volumes&quot;:[&quot;workload-socket&quot;,&quot;credential-socket&quot;,&quot;workload-certs&quot;,&quot;istio-envoy&quot;,&quot;istio-data&quot;,&quot;istio-podinfo&quot;,&quot;istio-token&quot;,&quot;istiod-ca-cert&quot;],&quot;imagePullSecrets&quot;:null,&quot;revision&quot;:&quot;default&quot;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-01-01T11:40:31Z&quot;</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">nginx-deployment-7fc7f5758-</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">pod-template-hash:</span> <span class="string">7fc7f5758</span></span><br><span class="line">    <span class="attr">security.istio.io/tlsMode:</span> <span class="string">istio</span></span><br><span class="line">    <span class="attr">service.istio.io/canonical-name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">service.istio.io/canonical-revision:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment-7fc7f5758-46mzh</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sidecar</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-deployment-7fc7f5758</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">9277a14d-cb83-4d2e-92d9-1f9694ec9a5d</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;4841&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">1d4c7d67-b162-4138-a781-7f8a472c9b34</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-4wmmn</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">proxy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sidecar</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--domain</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxyLogLevel=warning</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxyComponentLogLevel=misc:error</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--log_output_level=default:info</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JWT_POLICY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">third-party-jwt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PILOT_CERT_PROVIDER</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">istiod</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CA_ADDR</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">istiod.istio-system.svc:15012</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INSTANCE_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVICE_ACCOUNT</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.serviceAccountName</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_CPU_LIMIT</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">resourceFieldRef:</span></span><br><span class="line">          <span class="attr">divisor:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">          <span class="attr">resource:</span> <span class="string">limits.cpu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROXY_CONFIG</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        &#123;&#125;</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_POD_PORTS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        [</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string"></span>    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_APP_CONTAINERS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GOMEMLIMIT</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">resourceFieldRef:</span></span><br><span class="line">          <span class="attr">divisor:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">          <span class="attr">resource:</span> <span class="string">limits.memory</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GOMAXPROCS</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">resourceFieldRef:</span></span><br><span class="line">          <span class="attr">divisor:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">          <span class="attr">resource:</span> <span class="string">limits.cpu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_CLUSTER_ID</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">Kubernetes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_NODE_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_INTERCEPTION_MODE</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">REDIRECT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_WORKLOAD_NAME</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_OWNER</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">kubernetes://apis/apps/v1/namespaces/sidecar/deployments/nginx-deployment</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_MESH_ID</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">cluster.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TRUST_DOMAIN</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">cluster.local</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/istio/proxyv2:1.19.3</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-proxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">15090</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http-envoy-prom</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz/ready</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15021</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">40Mi</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">drop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">runAsGroup:</span> <span class="number">1337</span></span><br><span class="line">      <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">1337</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/workload-spiffe-uds</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">workload-socket</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/credential-uds</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">credential-socket</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/workload-spiffe-credentials</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">workload-certs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/istio</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istiod-ca-cert</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/istio/data</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/proxy</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-envoy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/tokens</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-token</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-podinfo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-4wmmn</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">istio-iptables</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-p</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;15001&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-z</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;15006&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-u</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;1337&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-m</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">REDIRECT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-i</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-x</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-b</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-d</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">15090</span><span class="string">,15021,15020</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--log_output_level=default:info</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/istio/proxyv2:1.19.3</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-init</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">40Mi</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NET_RAW</span></span><br><span class="line">        <span class="attr">drop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">runAsNonRoot:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-4wmmn</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">minikube</span></span><br><span class="line">  <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">workload-socket</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">credential-socket</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">workload-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span></span><br><span class="line">      <span class="attr">medium:</span> <span class="string">Memory</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-envoy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-data</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.labels</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">labels</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.annotations</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">annotations</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-podinfo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">istio-token</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">audience:</span> <span class="string">istio-ca</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">43200</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">istio-token</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-ca-root-cert</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istiod-ca-cert</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-4wmmn</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-01T11:40:33Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-01T11:43:10Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-01T11:43:10Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-01T11:40:31Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://0f7fe83cc80e801f9d1eb3e695f699eecc1a64ce00a1a606a8849626973a37e5</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">istio/proxyv2:1.19.3</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">docker-pullable://istio/proxyv2@sha256:47b08c6d59b97e69c43387df40e6b969a2c1979af29665e85698c178fceda0a4</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-proxy</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-01-01T11:42:56Z&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://5c801e6a40f1715485e86f11901f1382c7e11f8c75de95bb4696ec1fd196f3b4</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:2bdc49f2f8ae8d8dc50ed00f2ee56d00385c6f8bc8a8b320d0a294d9e3b49026</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-01-01T11:42:56Z&quot;</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">192.168</span><span class="number">.49</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">initContainerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://b4586714d4a41cef9bc0ea6fee2fc1d267e129add845c87ae2432f237a34790c</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">istio/proxyv2:1.19.3</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">docker-pullable://istio/proxyv2@sha256:47b08c6d59b97e69c43387df40e6b969a2c1979af29665e85698c178fceda0a4</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-init</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">terminated:</span></span><br><span class="line">        <span class="attr">containerID:</span> <span class="string">docker://b4586714d4a41cef9bc0ea6fee2fc1d267e129add845c87ae2432f237a34790c</span></span><br><span class="line">        <span class="attr">exitCode:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">finishedAt:</span> <span class="string">&quot;2022-01-01T11:40:32Z&quot;</span></span><br><span class="line">        <span class="attr">reason:</span> <span class="string">Completed</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-01-01T11:40:32Z&quot;</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.6</span></span><br><span class="line">  <span class="attr">podIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.6</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">Burstable</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2022-01-01T11:40:31Z&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>istio-proxy - sidecar; istio-init - initContainer<br>同一个 Pod 中的所有容器是<code>共用</code>网络 Namespace，所以 initContainer 能修改 iptables 规则并生效</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a | grep nginx</span><br><span class="line">0f7fe83cc80e   ef821b2a218f                                                    &quot;/usr/local/bin/pilo…&quot;   3 hours ago   Up 3 hours                           k8s_istio-proxy_nginx-deployment-7fc7f5758-46mzh_sidecar_1d4c7d67-b162-4138-a781-7f8a472c9b34_0</span><br><span class="line">5c801e6a40f1   nginx                                                           &quot;/docker-entrypoint.…&quot;   3 hours ago   Up 3 hours                           k8s_nginx_nginx-deployment-7fc7f5758-46mzh_sidecar_1d4c7d67-b162-4138-a781-7f8a472c9b34_0</span><br><span class="line">b4586714d4a4   ef821b2a218f                                                    &quot;/usr/local/bin/pilo…&quot;   3 hours ago   Exited (0) 3 hours ago               k8s_istio-init_nginx-deployment-7fc7f5758-46mzh_sidecar_1d4c7d67-b162-4138-a781-7f8a472c9b34_0</span><br><span class="line">7b46f9b6cd22   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9   &quot;/pause&quot;                 3 hours ago   Up 3 hours                           k8s_POD_nginx-deployment-7fc7f5758-46mzh_sidecar_1d4c7d67-b162-4138-a781-7f8a472c9b34_0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>客户端</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>toolbox.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">toolbox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">toolbox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">toolbox</span></span><br><span class="line">        <span class="attr">access:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">toolbox</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">centos:7.9.2009</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">tail</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/dev/null</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>部署客户端，同样注入了 Sidecar</p>
</blockquote>
<blockquote>
<p>在没有 Sidecar 时的数据链路：</p>
<ol>
<li>先对 <code>Service</code> 做域名解析，<code>CoreDNS</code> 告知 <code>ClusterIP</code></li>
<li>请求被发送到 <code>ClusterIP</code>，到达宿主后，会有 <code>iptables/ipvs</code> 规则，通过 <code>DNAT</code> 指向 <code>PodIP</code></li>
</ol>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f toolbox.yaml -n sidecar</span><br><span class="line">deployment.apps/toolbox created</span><br><span class="line"></span><br><span class="line">$ k get po -n sidecar</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-7fc7f5758-46mzh   2/2     Running   0          28m</span><br><span class="line">toolbox-97948fc8-ptlct             2/2     Running   0          4m</span><br><span class="line"></span><br><span class="line">$ k get svc -n sidecar</span><br><span class="line">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx   ClusterIP   10.100.93.113   &lt;none&gt;        80/TCP    29m</span><br><span class="line"></span><br><span class="line">$ k exec -it -n sidecar toolbox-97948fc8-ptlct -- curl -sI nginx</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line">date: Mon, 01 Jan 2022 12:11:37 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 24 Oct 2023 13:46:47 GMT</span><br><span class="line">etag: &quot;6537cac7-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">x-envoy-upstream-service-time: 2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在有 Sidecar 时的数据链路</p>
</blockquote>
<blockquote>
<p>客户端，<code>iptables</code> 被修改，流量被<code>劫持</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps | grep toolbox</span><br><span class="line">e5bd83d25a6e   ef821b2a218f                                                    &quot;/usr/local/bin/pilo…&quot;   12 minutes ago   Up 12 minutes             k8s_istio-proxy_toolbox-97948fc8-ptlct_sidecar_b187a8cb-dde2-4cb6-821b-023700674256_0</span><br><span class="line">aa143b711dec   centos                                                          &quot;tail -f /dev/null&quot;      12 minutes ago   Up 12 minutes             k8s_toolbox_toolbox-97948fc8-ptlct_sidecar_b187a8cb-dde2-4cb6-821b-023700674256_0</span><br><span class="line">ca6c94829035   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9   &quot;/pause&quot;                 15 minutes ago   Up 15 minutes             k8s_POD_toolbox-97948fc8-ptlct_sidecar_b187a8cb-dde2-4cb6-821b-023700674256_0</span><br><span class="line"></span><br><span class="line">$ docker inspect aa143b711dec | grep Pid</span><br><span class="line">            &quot;Pid&quot;: 70532,</span><br><span class="line">            &quot;PidMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;PidsLimit&quot;: null,</span><br><span class="line">            </span><br><span class="line">$ sudo nsenter -t 70532 -n ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether f6:76:88:cf:ba:dd brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 10.244.0.7/16 brd 10.244.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">$ sudo nsenter -t 70532 -n iptables-legacy-save -t nat</span><br><span class="line"># Generated by iptables-save v1.8.7 on Mon Jan  1 12:25:06 2022</span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [509:30540]</span><br><span class="line">:INPUT ACCEPT [509:30540]</span><br><span class="line">:OUTPUT ACCEPT [52:4460]</span><br><span class="line">:POSTROUTING ACCEPT [55:4640]</span><br><span class="line">:ISTIO_INBOUND - [0:0]</span><br><span class="line">:ISTIO_IN_REDIRECT - [0:0]</span><br><span class="line">:ISTIO_OUTPUT - [0:0]</span><br><span class="line">:ISTIO_REDIRECT - [0:0]</span><br><span class="line">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class="line">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class="line">-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -p tcp -m tcp ! --dport 15008 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -p tcp -m tcp ! --dport 15008 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class="line">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Mon Jan  1 12:25:06 2022</span><br></pre></td></tr></table></figure>

<blockquote>
<p>往外走的流量，首先经过 <code>OUTPUT</code> Chain<br>效果：任何往外走的 <code>TCP</code> 流量，都会转发到 <code>15001</code> 端口（即 Envoy 监听）</p>
</blockquote>
<ol>
<li>-A OUTPUT -p tcp -j ISTIO_OUTPUT<ul>
<li>是 TCP 协议则走 <code>ISTIO_OUTPUT</code></li>
</ul>
</li>
<li>ISTIO_OUTPUT 前面的规则都不匹配，直接到 <code>ISTIO_REDIRECT</code></li>
<li>ISTIO_REDIRECT 转发到 <code>15001</code> 端口</li>
</ol>
<blockquote>
<p>listener</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl --help</span><br><span class="line">Istio configuration command line utility for service operators to</span><br><span class="line">debug and diagnose their Istio mesh.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  istioctl [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  admin                Manage control plane (istiod) configuration</span><br><span class="line">  analyze              Analyze Istio configuration and print validation messages</span><br><span class="line">  authz                (authz is experimental. Use `istioctl experimental authz`)</span><br><span class="line">  bug-report           Cluster information and log capture support tool.</span><br><span class="line">  completion           Generate the autocompletion script for the specified shell</span><br><span class="line">  create-remote-secret Create a secret with credentials to allow Istio to access remote Kubernetes apiservers</span><br><span class="line">  dashboard            Access to Istio web UIs</span><br><span class="line">  experimental         Experimental commands that may be modified or deprecated</span><br><span class="line">  help                 Help about any command</span><br><span class="line">  install              Applies an Istio manifest, installing or reconfiguring Istio on a cluster.</span><br><span class="line">  kube-inject          Inject Istio sidecar into Kubernetes pod resources</span><br><span class="line">  manifest             Commands related to Istio manifests</span><br><span class="line">  operator             Commands related to Istio operator controller.</span><br><span class="line">  profile              Commands related to Istio configuration profiles</span><br><span class="line">  proxy-config         Retrieve information about proxy configuration from Envoy [kube only]</span><br><span class="line">  proxy-status         Retrieves the synchronization status of each Envoy in the mesh [kube only]</span><br><span class="line">  remote-clusters      Lists the remote clusters each istiod instance is connected to.</span><br><span class="line">  tag                  Command group used to interact with revision tags</span><br><span class="line">  uninstall            Uninstall Istio from a cluster</span><br><span class="line">  upgrade              Upgrade Istio control plane in-place</span><br><span class="line">  validate             Validate Istio policy and rules files</span><br><span class="line">  verify-install       Verifies Istio Installation Status</span><br><span class="line">  version              Prints out build version information</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --context string          Kubernetes configuration context</span><br><span class="line">  -h, --help                    help for istioctl</span><br><span class="line">  -i, --istioNamespace string   Istio system namespace (default &quot;istio-system&quot;)</span><br><span class="line">  -c, --kubeconfig string       Kubernetes configuration file</span><br><span class="line">  -n, --namespace string        Kubernetes namespace</span><br><span class="line">      --vklog Level             number for the log level verbosity. Like -v flag. ex: --vklog=9</span><br><span class="line"></span><br><span class="line">Additional help topics:</span><br><span class="line">  istioctl options              Displays istioctl global options</span><br><span class="line"></span><br><span class="line">Use &quot;istioctl [command] --help&quot; for more information about a command.</span><br><span class="line"></span><br><span class="line">$ istioctl proxy-status</span><br><span class="line">NAME                                                   CLUSTER        CDS        LDS        EDS        RDS          ECDS         ISTIOD                      VERSION</span><br><span class="line">istio-egressgateway-84776fd7f6-dfn6m.istio-system      Kubernetes     SYNCED     SYNCED     SYNCED     NOT SENT     NOT SENT     istiod-566dc66cff-d9chq     1.19.3</span><br><span class="line">istio-ingressgateway-779c475c44-j4tds.istio-system     Kubernetes     SYNCED     SYNCED     SYNCED     NOT SENT     NOT SENT     istiod-566dc66cff-d9chq     1.19.3</span><br><span class="line">nginx-deployment-7fc7f5758-46mzh.sidecar               Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-566dc66cff-d9chq     1.19.3</span><br><span class="line">toolbox-97948fc8-ptlct.sidecar                         Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-566dc66cff-d9chq     1.19.3</span><br><span class="line"></span><br><span class="line">$ istioctl proxy-config -n sidecar listener toolbox-97948fc8-ptlct</span><br><span class="line">ADDRESSES      PORT  MATCH                                                                                         DESTINATION</span><br><span class="line">10.96.0.10     53    ALL                                                                                           Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local</span><br><span class="line">0.0.0.0        80    Trans: raw_buffer; App: http/1.1,h2c                                                          Route: 80</span><br><span class="line">0.0.0.0        80    ALL                                                                                           PassthroughCluster</span><br><span class="line">10.101.85.142  443   ALL                                                                                           Cluster: outbound|443||istio-egressgateway.istio-system.svc.cluster.local</span><br><span class="line">10.107.180.168 443   ALL                                                                                           Cluster: outbound|443||istiod.istio-system.svc.cluster.local</span><br><span class="line">10.108.4.104   443   ALL                                                                                           Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local</span><br><span class="line">10.96.0.1      443   ALL                                                                                           Cluster: outbound|443||kubernetes.default.svc.cluster.local</span><br><span class="line">10.96.0.10     9153  Trans: raw_buffer; App: http/1.1,h2c                                                          Route: kube-dns.kube-system.svc.cluster.local:9153</span><br><span class="line">10.96.0.10     9153  ALL                                                                                           Cluster: outbound|9153||kube-dns.kube-system.svc.cluster.local</span><br><span class="line">0.0.0.0        15001 ALL                                                                                           PassthroughCluster</span><br><span class="line">0.0.0.0        15001 Addr: *:15001                                                                                 Non-HTTP/Non-TCP</span><br><span class="line">0.0.0.0        15006 Addr: *:15006                                                                                 Non-HTTP/Non-TCP</span><br><span class="line">0.0.0.0        15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                      InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0        15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0                                         InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0        15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                     InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0        15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                            InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0        15006 Trans: tls; Addr: 0.0.0.0/0                                                                   InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0        15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:80 Cluster: inbound|80||</span><br><span class="line">0.0.0.0        15006 Trans: raw_buffer; Addr: *:80                                                                 Cluster: inbound|80||</span><br><span class="line">0.0.0.0        15010 Trans: raw_buffer; App: http/1.1,h2c                                                          Route: 15010</span><br><span class="line">0.0.0.0        15010 ALL                                                                                           PassthroughCluster</span><br><span class="line">10.107.180.168 15012 ALL                                                                                           Cluster: outbound|15012||istiod.istio-system.svc.cluster.local</span><br><span class="line">0.0.0.0        15014 Trans: raw_buffer; App: http/1.1,h2c                                                          Route: 15014</span><br><span class="line">0.0.0.0        15014 ALL                                                                                           PassthroughCluster</span><br><span class="line">0.0.0.0        15021 ALL                                                                                           Inline Route: /healthz/ready*</span><br><span class="line">10.108.4.104   15021 Trans: raw_buffer; App: http/1.1,h2c                                                          Route: istio-ingressgateway.istio-system.svc.cluster.local:15021</span><br><span class="line">10.108.4.104   15021 ALL                                                                                           Cluster: outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local</span><br><span class="line">0.0.0.0        15090 ALL                                                                                           Inline Route: /stats/prometheus*</span><br><span class="line">10.108.4.104   15443 ALL                                                                                           Cluster: outbound|15443||istio-ingressgateway.istio-system.svc.cluster.local</span><br><span class="line">10.108.4.104   31400 ALL                                                                                           Cluster: outbound|31400||istio-ingressgateway.istio-system.svc.cluster.local</span><br></pre></td></tr></table></figure>

<blockquote>
<p>istioctl proxy-config -n sidecar listener toolbox-97948fc8-ptlct -ojson<br><code>routeConfigName</code> - 80</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0_80&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;socketAddress&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;portValue&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filterChains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                                ...</span><br><span class="line">                <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;envoy.filters.network.http_connection_manager&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;typedConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                        ...</span><br><span class="line">                            <span class="attr">&quot;rds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                                ...</span><br><span class="line">                                <span class="attr">&quot;routeConfigName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">...</span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;virtualOutbound&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;socketAddress&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;portValue&quot;</span><span class="punctuation">:</span> <span class="number">15001</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>route</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl proxy-config -n sidecar route toolbox-97948fc8-ptlct</span><br><span class="line">NAME                                                          VHOST NAME                                                    DOMAINS                                             MATCH                  VIRTUAL SERVICE</span><br><span class="line">istio-ingressgateway.istio-system.svc.cluster.local:15021     istio-ingressgateway.istio-system.svc.cluster.local:15021     *                                                   /*</span><br><span class="line">80                                                            istio-egressgateway.istio-system.svc.cluster.local:80         istio-egressgateway.istio-system, 10.101.85.142     /*</span><br><span class="line">80                                                            istio-ingressgateway.istio-system.svc.cluster.local:80        istio-ingressgateway.istio-system, 10.108.4.104     /*</span><br><span class="line">80                                                            nginx.sidecar.svc.cluster.local:80                            nginx, nginx.sidecar + 1 more...                    /*</span><br><span class="line">15014                                                         istiod.istio-system.svc.cluster.local:15014                   istiod.istio-system, 10.107.180.168                 /*</span><br><span class="line">kube-dns.kube-system.svc.cluster.local:9153                   kube-dns.kube-system.svc.cluster.local:9153                   *                                                   /*</span><br><span class="line">15010                                                         istiod.istio-system.svc.cluster.local:15010                   istiod.istio-system, 10.107.180.168                 /*</span><br><span class="line">                                                              backend                                                       *                                                   /healthz/ready*</span><br><span class="line">InboundPassthroughClusterIpv4                                 inbound|http|0                                                *                                                   /*</span><br><span class="line">                                                              backend                                                       *                                                   /stats/prometheus*</span><br><span class="line">InboundPassthroughClusterIpv4                                 inbound|http|0                                                *                                                   /*</span><br><span class="line">inbound|80||                                                  inbound|http|80                                               *                                                   /*</span><br><span class="line">inbound|80||                                                  inbound|http|80                                               *                                                   /*</span><br></pre></td></tr></table></figure>

<blockquote>
<p>istioctl proxy-config -n sidecar route toolbox-97948fc8-ptlct –name&#x3D;80 -ojson<br><code>cluster</code> - outbound|80||nginx.sidecar.svc.cluster.local</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;80&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;virtualHosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        ...</span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx.sidecar.svc.cluster.local:80&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;nginx.sidecar.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;nginx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;nginx.sidecar.svc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;nginx.sidecar&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;10.100.93.113&quot;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;route&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;outbound|80||nginx.sidecar.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0s&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;retryPolicy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                            ...</span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;maxGrpcTimeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0s&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;decorator&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx.sidecar.svc.cluster.local:80/*&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;includeRequestAttemptCount&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              ...</span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;validateClusters&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxDirectResponseBodySizeBytes&quot;</span><span class="punctuation">:</span> <span class="number">1048576</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ignorePortInHostMatching&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>cluster</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl proxy-config -n sidecar cluster toolbox-97948fc8-ptlct</span><br><span class="line">SERVICE FQDN                                            PORT      SUBSET     DIRECTION     TYPE             DESTINATION RULE</span><br><span class="line">                                                        80        -          inbound       ORIGINAL_DST</span><br><span class="line">BlackHoleCluster                                        -         -          -             STATIC</span><br><span class="line">InboundPassthroughClusterIpv4                           -         -          -             ORIGINAL_DST</span><br><span class="line">PassthroughCluster                                      -         -          -             ORIGINAL_DST</span><br><span class="line">agent                                                   -         -          -             STATIC</span><br><span class="line">istio-egressgateway.istio-system.svc.cluster.local      80        -          outbound      EDS</span><br><span class="line">istio-egressgateway.istio-system.svc.cluster.local      443       -          outbound      EDS</span><br><span class="line">istio-ingressgateway.istio-system.svc.cluster.local     80        -          outbound      EDS</span><br><span class="line">istio-ingressgateway.istio-system.svc.cluster.local     443       -          outbound      EDS</span><br><span class="line">istio-ingressgateway.istio-system.svc.cluster.local     15021     -          outbound      EDS</span><br><span class="line">istio-ingressgateway.istio-system.svc.cluster.local     15443     -          outbound      EDS</span><br><span class="line">istio-ingressgateway.istio-system.svc.cluster.local     31400     -          outbound      EDS</span><br><span class="line">istiod.istio-system.svc.cluster.local                   443       -          outbound      EDS</span><br><span class="line">istiod.istio-system.svc.cluster.local                   15010     -          outbound      EDS</span><br><span class="line">istiod.istio-system.svc.cluster.local                   15012     -          outbound      EDS</span><br><span class="line">istiod.istio-system.svc.cluster.local                   15014     -          outbound      EDS</span><br><span class="line">kube-dns.kube-system.svc.cluster.local                  53        -          outbound      EDS</span><br><span class="line">kube-dns.kube-system.svc.cluster.local                  9153      -          outbound      EDS</span><br><span class="line">kubernetes.default.svc.cluster.local                    443       -          outbound      EDS</span><br><span class="line">nginx.sidecar.svc.cluster.local                         80        -          outbound      EDS</span><br><span class="line">prometheus_stats                                        -         -          -             STATIC</span><br><span class="line">sds-grpc                                                -         -          -             STATIC</span><br><span class="line">xds-grpc                                                -         -          -             STATIC</span><br><span class="line">zipkin                                                  -         -          -             STRICT_DNS</span><br></pre></td></tr></table></figure>

<blockquote>
<p>endpoint</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl proxy-config -n sidecar endpoint toolbox-97948fc8-ptlct --cluster=&quot;outbound|80||nginx.sidecar.svc.cluster.local&quot;</span><br><span class="line">ENDPOINT          STATUS      OUTLIER CHECK     CLUSTER</span><br><span class="line">10.244.0.6:80     HEALTHY     OK                outbound|80||nginx.sidecar.svc.cluster.local</span><br><span class="line"></span><br><span class="line">$ k get po -n sidecar -owide</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-7fc7f5758-46mzh   2/2     Running   0          115m   10.244.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">toolbox-97948fc8-ptlct             2/2     Running   0          90m    10.244.0.7   minikube   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Envoy Sidecar 会<code>服务发现</code>当前 Kubernetes 集群的 <code>Service</code> 和 <code>Endpoint</code> 信息，并将其组装成 <code>Envoy</code> 配置<br>基于 Envoy Sidecar 的数据链路，不再依赖于宿主上的 <code>iptables/ipvs</code>，在 Envoy Sidecar 中已经做好了<code>路由判决</code></p>
</blockquote>
<blockquote>
<p>此时的流量要往 Nginx Pod 转发，同样要经过 iptables OUTPUT<br>useradd -m –uid <code>1337</code><br>表明这是来自于 Envoy Sidecar 的 OUTPUT 流量，不会再进入到 ISTIO_REDIRECT，而是直接 RETURN，避免死循环</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ docker images | grep istio/proxyv2</span><br><span class="line">istio/proxyv2                                                                 1.19.3     ef821b2a218f   2 months ago    242MB</span><br><span class="line"></span><br><span class="line">$ docker history ef821b2a218f</span><br><span class="line">IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT</span><br><span class="line">ef821b2a218f   2 months ago   ENTRYPOINT [&quot;/usr/local/bin/pilot-agent&quot;]       0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY arm64/pilot-agent /usr/local/bin/pilot-…   43.1MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ARG TARGETARCH                                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV ISTIO_META_ISTIO_PROXY_SHA=a1ff538a63890…   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY arm64/envoy /usr/local/bin/envoy # buil…   112MB     buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ARG TARGETARCH                                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY gcp_envoy_bootstrap.json /var/lib/istio…   8.94kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY envoy_bootstrap.json /var/lib/istio/env…   22kB      buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ARG SIDECAR=envoy                               0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ARG proxy_version                               0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   WORKDIR /                                       0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 months ago   RUN /bin/sh -c useradd -m --uid 1337 istio-p…   10.4kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 months ago   RUN /bin/sh -c apt-get update &amp;&amp;   apt-get i…   17.6MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 months ago   ENV DEBIAN_FRONTEND=noninteractive              0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      6 months ago   /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B</span><br><span class="line">&lt;missing&gt;      6 months ago   /bin/sh -c #(nop) ADD file:262490f82459c1463…   69.2MB</span><br><span class="line">&lt;missing&gt;      6 months ago   /bin/sh -c #(nop)  LABEL org.opencontainers.…   0B</span><br><span class="line">&lt;missing&gt;      6 months ago   /bin/sh -c #(nop)  LABEL org.opencontainers.…   0B</span><br><span class="line">&lt;missing&gt;      6 months ago   /bin/sh -c #(nop)  ARG LAUNCHPAD_BUILD_ARCH     0B</span><br><span class="line">&lt;missing&gt;      6 months ago   /bin/sh -c #(nop)  ARG RELEASE                  0B</span><br></pre></td></tr></table></figure>

<blockquote>
<p>入站流量，先通过 PREROUTING</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps | grep nginx</span><br><span class="line">0f7fe83cc80e   ef821b2a218f                                                    &quot;/usr/local/bin/pilo…&quot;   2 hours ago   Up 2 hours             k8s_istio-proxy_nginx-deployment-7fc7f5758-46mzh_sidecar_1d4c7d67-b162-4138-a781-7f8a472c9b34_0</span><br><span class="line">5c801e6a40f1   nginx                                                           &quot;/docker-entrypoint.…&quot;   2 hours ago   Up 2 hours             k8s_nginx_nginx-deployment-7fc7f5758-46mzh_sidecar_1d4c7d67-b162-4138-a781-7f8a472c9b34_0</span><br><span class="line">7b46f9b6cd22   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9   &quot;/pause&quot;                 2 hours ago   Up 2 hours             k8s_POD_nginx-deployment-7fc7f5758-46mzh_sidecar_1d4c7d67-b162-4138-a781-7f8a472c9b34_0</span><br><span class="line"></span><br><span class="line">$ docker inspect 0f7fe83cc80e | grep Pid</span><br><span class="line">            &quot;Pid&quot;: 47974,</span><br><span class="line">            &quot;PidMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;PidsLimit&quot;: null,</span><br><span class="line"></span><br><span class="line">$ sudo nsenter -t 47974 -n iptables-legacy-save -t nat</span><br><span class="line"># Generated by iptables-save v1.8.7 on Mon Jan  1 14:10:21 2022</span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [4423:265380]</span><br><span class="line">:INPUT ACCEPT [4425:265500]</span><br><span class="line">:OUTPUT ACCEPT [263:23779]</span><br><span class="line">:POSTROUTING ACCEPT [263:23779]</span><br><span class="line">:ISTIO_INBOUND - [0:0]</span><br><span class="line">:ISTIO_IN_REDIRECT - [0:0]</span><br><span class="line">:ISTIO_OUTPUT - [0:0]</span><br><span class="line">:ISTIO_REDIRECT - [0:0]</span><br><span class="line">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class="line">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class="line">-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -p tcp -m tcp ! --dport 15008 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -p tcp -m tcp ! --dport 15008 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class="line">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Mon Jan  1 14:10:21 2022</span><br></pre></td></tr></table></figure>

<blockquote>
<p>效果：非特殊端口的 TCP 流量，转发到 15006 端口</p>
</blockquote>
<ol>
<li>-A PREROUTING -p tcp -j ISTIO_INBOUND<ul>
<li>任何 TCP 流量都会跳转到 ISTIO_INBOUND</li>
</ul>
</li>
<li>ISTIO_INBOUND 针对特定端口（15008、15090、15021、15020）不处理</li>
<li>80 端口会跳转到 ISTIO_IN_REDIRECT，进而转发到 15006 端口</li>
</ol>
<blockquote>
<p>listener</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl proxy-config -n sidecar listener nginx-deployment-7fc7f5758-46mzh --port=15006</span><br><span class="line">ADDRESSES PORT  MATCH                                                                                         DESTINATION</span><br><span class="line">0.0.0.0   15006 Addr: *:15006                                                                                 Non-HTTP/Non-TCP</span><br><span class="line">0.0.0.0   15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                      InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0   15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0                                         InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0   15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                     InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0   15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                            InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0   15006 Trans: tls; Addr: 0.0.0.0/0                                                                   InboundPassthroughClusterIpv4</span><br><span class="line">0.0.0.0   15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:80 Cluster: inbound|80||</span><br><span class="line">0.0.0.0   15006 Trans: raw_buffer; Addr: *:80                                                                 Cluster: inbound|80||</span><br></pre></td></tr></table></figure>

<blockquote>
<p>istioctl proxy-config -n sidecar listener nginx-deployment-7fc7f5758-46mzh -ojson<br>route - <code>inbound|80||</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">                        <span class="attr">&quot;typedConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;statPrefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inbound_0.0.0.0_80&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;routeConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inbound|80||&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;virtualHosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                    <span class="punctuation">&#123;</span></span><br><span class="line">                                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inbound|http|80&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                            <span class="string">&quot;*&quot;</span></span><br><span class="line">                                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                        <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                            <span class="punctuation">&#123;</span></span><br><span class="line">                                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                    <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                                                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                                                <span class="attr">&quot;route&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                    <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inbound|80||&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0s&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                    <span class="attr">&quot;maxStreamDuration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                        <span class="attr">&quot;maxStreamDuration&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0s&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                        <span class="attr">&quot;grpcTimeoutHeaderMax&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0s&quot;</span></span><br><span class="line">                                                    <span class="punctuation">&#125;</span></span><br><span class="line">                                                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                                                <span class="attr">&quot;decorator&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                    <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx.sidecar.svc.cluster.local:80/*&quot;</span></span><br><span class="line">                                                <span class="punctuation">&#125;</span></span><br><span class="line">                                            <span class="punctuation">&#125;</span></span><br><span class="line">                                        <span class="punctuation">]</span></span><br><span class="line">                                    <span class="punctuation">&#125;</span></span><br><span class="line">                                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;validateClusters&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">...</span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;virtualInbound&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;socketAddress&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;portValue&quot;</span><span class="punctuation">:</span> <span class="number">15006</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>istioctl proxy-config -n sidecar route nginx-deployment-7fc7f5758-46mzh –name&#x3D;80 -ojson<br>cluster - <code>outbound|80||nginx.sidecar.svc.cluster.local</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;80&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;virtualHosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              ...</span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx.sidecar.svc.cluster.local:80&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;nginx.sidecar.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;nginx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;nginx.sidecar.svc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;nginx.sidecar&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;10.100.93.113&quot;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;route&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;outbound|80||nginx.sidecar.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0s&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;retryPolicy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                                            ...</span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;maxGrpcTimeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0s&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;decorator&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx.sidecar.svc.cluster.local:80/*&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;includeRequestAttemptCount&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        ...</span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;validateClusters&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;maxDirectResponseBodySizeBytes&quot;</span><span class="punctuation">:</span> <span class="number">1048576</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ignorePortInHostMatching&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>istioctl proxy-config -n sidecar endpoint  nginx-deployment-7fc7f5758-46mzh –cluster&#x3D;”outbound|80||nginx.sidecar.svc.cluster.local” -ojson</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;outbound|80||nginx.sidecar.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;addedViaApi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hostStatuses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;socketAddress&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.244.0.6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;portValue&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cx_connect_fail&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cx_total&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rq_error&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rq_success&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rq_timeout&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rq_total&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GAUGE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cx_active&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GAUGE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rq_active&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;healthStatus&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;edsHealthStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HEALTHY&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;locality&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;circuitBreakers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;maxConnections&quot;</span><span class="punctuation">:</span> <span class="number">4294967295</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maxPendingRequests&quot;</span><span class="punctuation">:</span> <span class="number">4294967295</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maxRequests&quot;</span><span class="punctuation">:</span> <span class="number">4294967295</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maxRetries&quot;</span><span class="punctuation">:</span> <span class="number">4294967295</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maxConnections&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maxPendingRequests&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maxRequests&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;maxRetries&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;observabilityName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;outbound|80||nginx.sidecar.svc.cluster.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;edsServiceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;outbound|80||nginx.sidecar.svc.cluster.local&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>此时 Envoy Sidecar 准备执行 OUTPUT，与客户端类似，能标识为 Envoy Sidecar 的流量，最终到达实际的 Nginx 容器</p>
</blockquote>
<blockquote>
<p>获取 Envoy Config（非常大），Istio 默认会服务发现<code>所有</code>的 Service 和 Endpoint，对于大集群，存在<code>性能隐患</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$  k exec -it -n sidecar toolbox-97948fc8-ptlct -- bash</span><br><span class="line">[root@toolbox-97948fc8-ptlct /]# curl 127.1:15000/config_dump</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@toolbox-97948fc8-ptlct /]# curl -sI 127.1:15000/config_dump</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">content-type: application/json</span><br><span class="line">cache-control: no-cache, max-age=0</span><br><span class="line">x-content-type-options: nosniff</span><br><span class="line">date: Mon, 01 Jan 2022 15:08:54 GMT</span><br><span class="line">server: envoy</span><br><span class="line">transfer-encoding: chunked</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Envoy 只监听了 <code>15001</code> 和 <code>15006</code>，其内部配置的其余端口，并<code>没有实际绑定 Socket</code></p>
</blockquote>
<h1 id="主要能力"><a href="#主要能力" class="headerlink" title="主要能力"></a>主要能力</h1><h2 id="流量管理"><a href="#流量管理" class="headerlink" title="流量管理"></a>流量管理</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20240102222731576.png" alt="image-20240102222731576"></p>
<h2 id="服务通信"><a href="#服务通信" class="headerlink" title="服务通信"></a>服务通信</h2><ol>
<li>客户端不知道服务端不同版本之间的差异<ul>
<li>客户端使用服务端的主机名或者 IP 继续访问服务端</li>
<li>Envoy Sidecar <code>拦截并转发</code>客户端与服务端之间的<code>所有</code>请求和相应</li>
</ul>
</li>
<li>Istio 为同一服务版本的多个实例提供<code>流量负载均衡</code></li>
<li>Istio <code>不提供 DNS</code>，应用程序尝试使 Kubernetes 的 DNS 服务来解析 FQDN</li>
</ol>
<h2 id="Ingress-x2F-Egress"><a href="#Ingress-x2F-Egress" class="headerlink" title="Ingress &#x2F; Egress"></a>Ingress &#x2F; Egress</h2><blockquote>
<p>Istio 假设进入和离开服务网格的<code>所有流量</code>都会通过 Envoy 代理进行传输</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20240102224106525.png" alt="image-20240102224106525"></p>
<ol>
<li>将 Envoy 部署在服务之前，可以进行 A&#x2F;B 测试、金丝雀部署</li>
<li>使用 Envoy 将流量路由到外部 Web 服务，并为这些服务添加超时控制、重试、断路器等功能，并获得各种指标</li>
</ol>
<blockquote>
<p>Ingress 本身并非成熟模型，无法完成<code>高级流量管理</code>，Istio 通过一套模型<code>统一</code>：入站流量、东西向流量、出站流量</p>
</blockquote>
<h2 id="服务发现-x2F-负载均衡"><a href="#服务发现-x2F-负载均衡" class="headerlink" title="服务发现 &#x2F; 负载均衡"></a>服务发现 &#x2F; 负载均衡</h2><ol>
<li>Istio 负载均衡服务网格中<code>实例</code>之间的通信</li>
<li>Istio 假设存在<code>服务注册表</code>，用来跟踪服务的 <code>Pod/VM</code><ul>
<li>假设服务的新实例<code>自动注册</code>到服务注册表，并且不健康的实例将会被<code>自动删除</code></li>
</ul>
</li>
<li>Pilot 使用<code>服务注册表</code>的信息，并提供与平台无关的<code>服务发现</code>接口<ul>
<li>服务网格中的 <code>Envoy</code> 实例执行<code>服务发现</code>，并相应地更新其<code>负载均衡池</code></li>
</ul>
</li>
<li>服务网格中的服务使用 <code>FQDN</code> 来访问其它服务<ul>
<li>服务的<code>所有 HTTP 流量</code>都会通过 <code>Envoy</code> 自动<code>重新路由</code></li>
<li>Envoy 在<code>负载均衡池</code>中的实例之间分发流量</li>
</ul>
</li>
<li>Envoy 支持复杂的负载均衡算法，但 Istio 仅支持：<code>轮询</code>、<code>随机</code>、<code>带权重的最少请求</code></li>
<li>Envoy 还会<code>定期检查</code>负载均衡池中每个实例的运行状况<ul>
<li>Envoy 遵循<code>熔断器</code>风格模式，根据健康检查 API 调用的<code>失败率</code>将实例分为不健康和健康<ul>
<li>当实例的健康检查<code>失败次数</code>超过阈值，将被从负载均衡池中<code>弹出</code></li>
<li>当实例的健康检查<code>成功次数</code>超过阈值，将被<code>添加</code>到负载均衡池</li>
</ul>
</li>
<li>如果实例响应 <code>HTTP 503</code>，将<code>立即弹出</code></li>
</ul>
</li>
</ol>
<h2 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h2><ol>
<li><code>超时</code>处理</li>
<li>基于超时预算的<code>重试</code>机制</li>
<li>基于并发连接和请求的<code>流量控制</code></li>
<li>对负载均衡器成员的<code>健康检查</code></li>
<li>细粒度的<code>熔断</code>机制</li>
</ol>
<h2 id="配置微调"><a href="#配置微调" class="headerlink" title="配置微调"></a>配置微调</h2><ol>
<li>Istio 可以为每个服务设置<code>全局默认值</code></li>
<li>客户端可以通过特殊的 HTTP 头<code>覆盖</code>超时和重试的默认值<ul>
<li>x-envoy-upstream-rq-timeout-ms</li>
<li>x-envoy-max-retries</li>
</ul>
</li>
</ol>
<h2 id="故障注入"><a href="#故障注入" class="headerlink" title="故障注入"></a>故障注入</h2><ol>
<li>Istio 允许在<code>网络层</code>按<code>协议</code>注入错误</li>
<li>注入的错误可以<code>基于特定的条件</code>，也可以设置<code>出现错误的比例</code><ul>
<li><code>Delay</code> - 提高网络延迟</li>
<li><code>Aborts</code> - 直接返回特定的错误码</li>
</ul>
</li>
</ol>
<h1 id="规则配置"><a href="#规则配置" class="headerlink" title="规则配置"></a>规则配置</h1><table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td><code>VirtualService</code></td>
<td>在 Istio 中定义<code>路由规则</code>，控制如何路由到服务上</td>
</tr>
<tr>
<td><code>DestinationRule</code></td>
<td>VirtualService 路由生效后，配置应用与请求的策略集</td>
</tr>
<tr>
<td><code>ServiceEntry</code></td>
<td>在 Istio <code>之外</code>启用对服务的请求</td>
</tr>
<tr>
<td><code>Gateway</code></td>
<td>为 HTTP&#x2F;TCP 流量配置负载均衡器<br />常在服务网格边缘，启用应用程序的入口流量</td>
</tr>
</tbody></table>
<h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><blockquote>
<p>创建 namespace</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k create ns simple</span><br><span class="line">namespace/simple created</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Deployment + Service</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>simple.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">simple</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">simple</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">simple</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">simple</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f simple.yaml -n simple</span><br><span class="line">deployment.apps/simple created</span><br><span class="line">service/simple created</span><br><span class="line"></span><br><span class="line">$ k get po -n simple</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">simple-665cbb55bf-rq6ln   1/1     Running   0          44s</span><br><span class="line"></span><br><span class="line">$ k get svc -n simple</span><br><span class="line">NAME     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">simple   ClusterIP   10.100.93.113   &lt;none&gt;        80/TCP    57s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 Gateway 将服务发布到集群外</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>istio-specs.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">simple</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">simple.zhongmingmao.io</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">simple.simple.svc.cluster.local</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">simple.zhongmingmao.io</span></span><br><span class="line">      <span class="attr">port:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">http-simple</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>VirtualService</code> - 对应 <code>Envoy Route</code><ul>
<li>host 为 simple.zhongmingmao.io 且端口为 80 的请求，将被转发到 simple.simple.svc.cluster.local:80</li>
<li>gateways - simple，与 Gateway 产生关联</li>
</ul>
</li>
<li><code>Gateway</code> - 对应 <code>Envoy Listener</code><ul>
<li><code>istio: ingressgateway</code> 实际选中的是 istio-ingressgateway-779c475c44-j4tds</li>
<li>语义：往 istio-ingressgateway 的 Pod 插入一些规则<ul>
<li>在 ingressgateway 上监听 <a target="_blank" rel="noopener" href="http://simple.zhongmingmao.io/">http://simple.zhongmingmao.io:80</a></li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>istio-ingressgateway-779c475c44-j4tds 带有 <code>istio=ingressgateway</code>，本质也是一个 Envoy</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k get po -n istio-system --show-labels</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">istio-egressgateway-84776fd7f6-dfn6m    1/1     Running   0          6d13h   app=istio-egressgateway,chart=gateways,heritage=Tiller,install.operator.istio.io/owning-resource=unknown,istio.io/rev=default,istio=egressgateway,operator.istio.io/component=EgressGateways,pod-template-hash=84776fd7f6,release=istio,service.istio.io/canonical-name=istio-egressgateway,service.istio.io/canonical-revision=latest,sidecar.istio.io/inject=false</span><br><span class="line">istio-ingressgateway-779c475c44-j4tds   1/1     Running   0          6d13h   app=istio-ingressgateway,chart=gateways,heritage=Tiller,install.operator.istio.io/owning-resource=unknown,istio.io/rev=default,istio=ingressgateway,operator.istio.io/component=IngressGateways,pod-template-hash=779c475c44,release=istio,service.istio.io/canonical-name=istio-ingressgateway,service.istio.io/canonical-revision=latest,sidecar.istio.io/inject=false</span><br><span class="line">istiod-566dc66cff-d9chq                 1/1     Running   0          6d13h   app=istiod,install.operator.istio.io/owning-resource=unknown,istio.io/rev=default,istio=pilot,operator.istio.io/component=Pilot,pod-template-hash=566dc66cff,sidecar.istio.io/inject=false</span><br></pre></td></tr></table></figure>

<blockquote>
<p>应用 VirtualService 和 Gateway</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f istio-specs.yaml -n simple</span><br><span class="line">virtualservice.networking.istio.io/simple created</span><br><span class="line">gateway.networking.istio.io/simple created</span><br><span class="line"></span><br><span class="line">$ k get svc -n istio-system</span><br><span class="line">NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE</span><br><span class="line">istio-egressgateway    ClusterIP      10.101.85.142    &lt;none&gt;        80/TCP,443/TCP                                                               6d13h</span><br><span class="line">istio-ingressgateway   LoadBalancer   10.108.4.104     &lt;pending&gt;     15021:32339/TCP,80:30634/TCP,443:30831/TCP,31400:32121/TCP,15443:31001/TCP   6d13h</span><br><span class="line">istiod                 ClusterIP      10.107.180.168   &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        6d13h</span><br><span class="line"></span><br><span class="line">$ k describe svc -n istio-system istio-ingressgateway</span><br><span class="line">...</span><br><span class="line">Endpoints:                10.244.0.4:15443</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ k get po -n istio-system -owide</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">istio-egressgateway-84776fd7f6-dfn6m    1/1     Running   0          6d13h   10.244.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-ingressgateway-779c475c44-j4tds   1/1     Running   0          6d13h   10.244.0.4   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istiod-566dc66cff-d9chq                 1/1     Running   0          6d13h   10.244.0.3   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ curl -sI 10.108.4.104</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">date: Tue, 02 Jan 2022 16:20:30 GMT</span><br><span class="line">server: istio-envoy</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line"></span><br><span class="line">$ curl -sI -H &#x27;host: simple.zhongmingmao.io&#x27; 10.108.4.104</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: istio-envoy</span><br><span class="line">date: Tue, 02 Jan 2022 16:20:54 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 24 Oct 2023 13:46:47 GMT</span><br><span class="line">etag: &quot;6537cac7-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">x-envoy-upstream-service-time: 2</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20240103000723604.png" alt="image-20240103000723604"></p>
<blockquote>
<p>细化七层路由规则</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>istio-specs.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">simple</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">simple.zhongmingmao.io</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">            <span class="attr">prefix:</span> <span class="string">&quot;/nginx&quot;</span></span><br><span class="line">      <span class="attr">rewrite:</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">simple.simple.svc.cluster.local</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">simple.zhongmingmao.io</span></span><br><span class="line">      <span class="attr">port:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">http-simple</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f istio-specs.yaml -n simple</span><br><span class="line">virtualservice.networking.istio.io/simple configured</span><br><span class="line">gateway.networking.istio.io/simple unchanged</span><br><span class="line"></span><br><span class="line">$ curl -sI -H &#x27;host: simple.zhongmingmao.io&#x27; 10.108.4.104</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">date: Tue, 02 Jan 2022 16:29:57 GMT</span><br><span class="line">server: istio-envoy</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line"></span><br><span class="line">$ curl -sI -H &#x27;host: simple.zhongmingmao.io&#x27; 10.108.4.104/nginx</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: istio-envoy</span><br><span class="line">date: Tue, 02 Jan 2022 16:30:18 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 24 Oct 2023 13:46:47 GMT</span><br><span class="line">etag: &quot;6537cac7-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">x-envoy-upstream-service-time: 0</span><br></pre></td></tr></table></figure>

<h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><blockquote>
<p>创建 namespace</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k create ns securesvc</span><br><span class="line">namespace/securesvc created</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Deployment + Service</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>httpserver.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpserver</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">httpserver</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">httpserver</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">httpserver</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpserver</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">httpserver</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ k create -f httpserver.yaml -n securesvc</span><br><span class="line">deployment.apps/httpserver created</span><br><span class="line">service/httpserver created</span><br><span class="line"></span><br><span class="line">$ k get po -n securesvc</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">httpserver-84bf965f9c-rq6ln   1/1     Running   0          36s</span><br><span class="line"></span><br><span class="line">$ k get svc -n securesvc</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">httpserver   ClusterIP   10.100.93.113   &lt;none&gt;        80/TCP    78s</span><br><span class="line"></span><br><span class="line">$ k exec -it -n securesvc httpserver-84bf965f9c-rq6ln -- curl -sI httpserver.securesvc.svc</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.3</span><br><span class="line">Date: Tue, 02 Jan 2022 17:12:29 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 24 Oct 2021 13:46:47 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;6537cac7-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成证书，需要放到 <code>istio-system</code> 下，Istio 监听 443 的时候需要 TLS</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj &#x27;/O=zhongmingmao Inc./CN=*.zhongmingmao.io&#x27; -keyout zhongmingmao.io.key -out zhongmingmao.io.crt</span><br><span class="line"></span><br><span class="line">$ k create -n istio-system secret tls zhongmingmao-credential --key=zhongmingmao.io.key --cert=zhongmingmao.io.crt</span><br><span class="line">secret/zhongmingmao-credential created</span><br></pre></td></tr></table></figure>

<blockquote>
<p>VirtualService + Gateway</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>istio-specs.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpsserver</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">httpsserver</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">httpsserver.zhongmingmao.io</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">httpserver.securesvc.svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpsserver</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">httpsserver.zhongmingmao.io</span></span><br><span class="line">      <span class="attr">port:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">https-default</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">SIMPLE</span></span><br><span class="line">        <span class="attr">credentialName:</span> <span class="string">zhongmingmao-credential</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f istio-specs.yaml -n securesvc</span><br><span class="line">virtualservice.networking.istio.io/httpsserver created</span><br><span class="line">gateway.networking.istio.io/httpsserver created</span><br><span class="line"></span><br><span class="line">$ k get svc -n istio-system</span><br><span class="line">NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE</span><br><span class="line">istio-egressgateway    ClusterIP      10.101.85.142    &lt;none&gt;        80/TCP,443/TCP                                                               6d14h</span><br><span class="line">istio-ingressgateway   LoadBalancer   10.108.4.104     &lt;pending&gt;     15021:32339/TCP,80:30634/TCP,443:30831/TCP,31400:32121/TCP,15443:31001/TCP   6d14h</span><br><span class="line">istiod                 ClusterIP      10.107.180.168   &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        6d14h</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于 HTTPS，一个 443 端口，可能支持了很多域名，需要绑定很多证书<br>请求借助 Server Name Indication 机制（–resolve，新增 DNS 缓存，相当于修改 &#x2F;etc&#x2F;hosts）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">$ curl --resolve httpsserver.zhongmingmao.io:443:10.108.4.104 https://httpsserver.zhongmingmao.io -v -k</span><br><span class="line">* Added httpsserver.zhongmingmao.io:443:10.108.4.104 to DNS cache</span><br><span class="line">* Hostname httpsserver.zhongmingmao.io was found in DNS cache</span><br><span class="line">*   Trying 10.108.4.104:443...</span><br><span class="line">* Connected to httpsserver.zhongmingmao.io (10.108.4.104) port 443 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* TLSv1.0 (OUT), TLS header, Certificate Status (22):</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Certificate Status (22):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Finished (20):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, CERT verify (15):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Finished (20):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Finished (20):</span><br><span class="line">* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Finished (20):</span><br><span class="line">* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384</span><br><span class="line">* ALPN, server accepted to use h2</span><br><span class="line">* Server certificate:</span><br><span class="line">*  subject: O=zhongmingmao Inc.; CN=*.zhongmingmao.io</span><br><span class="line">*  start date: Jan  2 16:43:50 2022 GMT</span><br><span class="line">*  expire date: Jan  1 16:43:50 2025 GMT</span><br><span class="line">*  issuer: O=zhongmingmao Inc.; CN=*.zhongmingmao.io</span><br><span class="line">*  SSL certificate verify result: self-signed certificate (18), continuing anyway.</span><br><span class="line">* Using HTTP2, server supports multiplexing</span><br><span class="line">* Connection state changed (HTTP/2 confirmed)</span><br><span class="line">* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* Using Stream ID: 1 (easy handle 0xaaab0761aca0)</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">&gt; GET / HTTP/2</span><br><span class="line">&gt; Host: httpsserver.zhongmingmao.io</span><br><span class="line">&gt; user-agent: curl/7.81.0</span><br><span class="line">&gt; accept: */*</span><br><span class="line">&gt;</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">* old SSL session ID is stale, removing</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* Connection state changed (MAX_CONCURRENT_STREAMS == 2147483647)!</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">&lt; HTTP/2 503</span><br><span class="line">&lt; content-length: 95</span><br><span class="line">&lt; content-type: text/plain</span><br><span class="line">&lt; date: Tue, 02 Jan 2022 16:50:41 GMT</span><br><span class="line">&lt; server: istio-envoy</span><br></pre></td></tr></table></figure>

<h1 id="Canary"><a href="#Canary" class="headerlink" title="Canary"></a>Canary</h1><blockquote>
<p>创建 namespace</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k create ns canary</span><br><span class="line">namespace/canary created</span><br><span class="line"></span><br><span class="line">$ k label ns canary istio-injection=enabled</span><br><span class="line">namespace/canary labeled</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Canary V1</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>canary-v1.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">canary</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f canary-v1.yaml -n canary</span><br><span class="line">deployment.apps/canary-v1 created</span><br><span class="line">service/canary created</span><br><span class="line"></span><br><span class="line">$ k get svc -n canary</span><br><span class="line">NAME     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">canary   ClusterIP   10.100.93.113   &lt;none&gt;        80/TCP    2m9s</span><br><span class="line"></span><br><span class="line">$ k get ep -n canary</span><br><span class="line">NAME     ENDPOINTS       AGE</span><br><span class="line">canary   10.244.0.6:80   86s</span><br><span class="line"></span><br><span class="line">$ k get po -n canary -owide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">canary-v1-69ddb8864b-rq6ln   2/2     Running   0          105s   10.244.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Client</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>toolbox.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">toolbox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">toolbox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">toolbox</span></span><br><span class="line">        <span class="attr">access:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">toolbox</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">centos:7.9.2009</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">tail</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/dev/null</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f toolbox.yaml -n canary</span><br><span class="line">deployment.apps/toolbox created</span><br><span class="line"></span><br><span class="line">$ k get po -n canary</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">canary-v1-69ddb8864b-rq6ln   2/2     Running   0          3m55s</span><br><span class="line">toolbox-97948fc8-ptlct       2/2     Running   0          76s</span><br><span class="line"></span><br><span class="line">$ k exec -n canary toolbox-97948fc8-ptlct -- curl -sI canary</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line">date: Wed, 03 Jan 2022 14:59:56 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 24 Oct 2021 13:46:47 GMT</span><br><span class="line">etag: &quot;6537cac7-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">x-envoy-upstream-service-time: 4</span><br><span class="line"></span><br><span class="line">$ k logs -n canary --tail=1 canary-v1-69ddb8864b-rq6ln</span><br><span class="line">127.0.0.6 - - [03/Jan/2022:14:59:56 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/7.29.0&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Canary V2</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>canary-v2.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.3</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f canary-v2.yaml -n canary</span><br><span class="line">deployment.apps/canary-v2 created</span><br><span class="line"></span><br><span class="line">$ k get svc -n canary -owide</span><br><span class="line">NAME     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">canary   ClusterIP   10.100.93.113   &lt;none&gt;        80/TCP    12m   app=canary</span><br><span class="line"></span><br><span class="line">$ k get po -n canary -owide -l app=canary --show-labels</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES   LABELS</span><br><span class="line">canary-v1-69ddb8864b-rq6ln   2/2     Running   0          11m    10.244.0.6   minikube   &lt;none&gt;           &lt;none&gt;            app=canary,pod-template-hash=69ddb8864b,security.istio.io/tlsMode=istio,service.istio.io/canonical-name=canary,service.istio.io/canonical-revision=v1,version=v1</span><br><span class="line">canary-v2-69b48c89b7-h87vk   2/2     Running   0          3m2s   10.244.0.8   minikube   &lt;none&gt;           &lt;none&gt;            app=canary,pod-template-hash=69b48c89b7,security.istio.io/tlsMode=istio,service.istio.io/canonical-name=canary,service.istio.io/canonical-revision=v2,version=v2</span><br><span class="line"></span><br><span class="line">$ k get ep -n canary</span><br><span class="line">NAME     ENDPOINTS                     AGE</span><br><span class="line">canary   10.244.0.6:80,10.244.0.8:80   9m17s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>VirtualService + DestinationRule</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>istio-specs.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">user:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">zhongmingmao</span></span><br><span class="line">      <span class="attr">route:</span> <span class="comment"># 如果 curl -H &#x27;user: zhongmingmao&#x27; 则到 v2 Destination</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">canary</span></span><br><span class="line">            <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span> <span class="comment"># 默认 Destination</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">canary</span></span><br><span class="line">          <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">RANDOM</span> <span class="comment"># 默认的负载均衡策略</span></span><br><span class="line">  <span class="attr">subsets:</span> <span class="comment"># 流量切分</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">trafficPolicy:</span> <span class="comment"># 覆盖默认的负载均衡策略</span></span><br><span class="line">        <span class="attr">loadBalancer:</span></span><br><span class="line">          <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问 Canary V2</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f istio-specs.yaml -n canary</span><br><span class="line">virtualservice.networking.istio.io/canary created</span><br><span class="line">destinationrule.networking.istio.io/canary created</span><br><span class="line"></span><br><span class="line">$ k exec -n canary toolbox-97948fc8-ptlct -- curl -sI -H &#x27;user: zhongmingmao&#x27; canary</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line">date: Wed, 03 Jan 2022 15:16:52 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 24 Oct 2021 13:46:47 GMT</span><br><span class="line">etag: &quot;6537cac7-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">x-envoy-upstream-service-time: 4</span><br><span class="line"></span><br><span class="line">$ k logs -n canary --tail=1 canary-v1-69ddb8864b-rq6ln</span><br><span class="line">127.0.0.6 - - [03/Jan/2022:14:59:56 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/7.29.0&quot; &quot;-&quot;</span><br><span class="line"></span><br><span class="line">$ k logs -n canary --tail=1 canary-v2-69b48c89b7-h87vk</span><br><span class="line">127.0.0.6 - - [03/Jan/2022:15:16:52 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/7.29.0&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问 Canary V1</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -n canary toolbox-97948fc8-ptlct -- curl -sI canary</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line">date: Wed, 03 Jan 2022 15:18:11 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 24 Oct 2021 13:46:47 GMT</span><br><span class="line">etag: &quot;6537cac7-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">x-envoy-upstream-service-time: 25</span><br><span class="line"></span><br><span class="line">$ k logs -n canary --tail=1 canary-v1-69ddb8864b-rq6ln</span><br><span class="line">127.0.0.6 - - [03/Jan/2022:15:18:11 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/7.29.0&quot; &quot;-&quot;</span><br><span class="line"></span><br><span class="line">$ k logs -n canary --tail=1 canary-v2-69b48c89b7-h87vk</span><br><span class="line">127.0.0.6 - - [03/Jan/2022:15:16:52 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/7.29.0&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<h1 id="故障注入-1"><a href="#故障注入-1" class="headerlink" title="故障注入"></a>故障注入</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">            <span class="attr">user:</span></span><br><span class="line">              <span class="attr">exact:</span> <span class="string">zhongmingmao</span></span><br><span class="line">      <span class="attr">route:</span> <span class="comment"># 如果 curl -H &#x27;user: zhongmingmao&#x27; 则到 v2 Destination</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">canary</span></span><br><span class="line">            <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="comment"># upstream 返回 500 时重试</span></span><br><span class="line">        <span class="attr">attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">perTryTimeout:</span> <span class="string">2s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span> <span class="comment"># 默认 Destination</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">canary</span></span><br><span class="line">          <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">fault:</span></span><br><span class="line">        <span class="attr">abort:</span></span><br><span class="line">          <span class="attr">httpStatus:</span> <span class="number">500</span></span><br><span class="line">          <span class="attr">percentage:</span></span><br><span class="line">            <span class="attr">value:</span> <span class="number">80</span> <span class="comment"># 80% 的概率返回 500</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">RANDOM</span> <span class="comment"># 默认的负载均衡策略</span></span><br><span class="line">  <span class="attr">subsets:</span> <span class="comment"># 流量切分</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">trafficPolicy:</span> <span class="comment"># 覆盖默认的负载均衡策略</span></span><br><span class="line">        <span class="attr">loadBalancer:</span></span><br><span class="line">          <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>5.755 s ≈ 6 s</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f istio-specs.yaml -n canary</span><br><span class="line">virtualservice.networking.istio.io/canary configured</span><br><span class="line">destinationrule.networking.istio.io/canary unchanged</span><br><span class="line"></span><br><span class="line">$ time k exec -n canary toolbox-97948fc8-ptlct -- curl -sI -H &#x27;user: zhongmingmao&#x27; canary</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line">date: Wed, 03 Jan 2022 15:47:07 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 24 Oct 2021 13:46:47 GMT</span><br><span class="line">etag: &quot;6537cac7-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">x-envoy-upstream-service-time: 3</span><br><span class="line"></span><br><span class="line">kubectl exec -n canary toolbox-97948fc8-ptlct -- curl -sI -H  canary  0.14s user 0.05s system 3% cpu 5.755 total</span><br></pre></td></tr></table></figure>

<h1 id="网络栈"><a href="#网络栈" class="headerlink" title="网络栈"></a>网络栈</h1><blockquote>
<p>iptables&#x2F;ipvs 基于 netfilter 框架（内核协议栈），优化空间很小</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20240105214246226.png" alt="image-20240105214246226"></p>
<blockquote>
<p>Cilium 基于 eBPF</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20240105214535638.png" alt="image-20240105214535638"></p>
<ol>
<li>新版 Linux Kernel 提供了很多的 Hook，允许插入自定义程序（并非规则）<ul>
<li>对 Linux Kernel 非常熟悉，编写 C 代码，编译成符合 eBPF 要求的机器码后</li>
<li>最后通过 eBPF 的用户态程序加载到 Linux Kernel</li>
</ul>
</li>
<li>Cilium 充分利用了 Hook<ul>
<li>建立 TCP 连接依然会走内核协议栈，依然有开销</li>
<li>但<code>数据拷贝</code>，可以直接在<code>用户态</code>进行 Socket 对拷，不需要再经过内核协议栈</li>
</ul>
</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2023/01/31/cloud-native-foundation-k8s-istio/">https://blog.zhongmingmao.top/2023/01/31/cloud-native-foundation-k8s-istio/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a><a class="post-meta__tags" href="/tags/service-mesh/">Service Mesh</a><a class="post-meta__tags" href="/tags/istio/">Istio</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/01/cloud-native-foundation-k8s-federation/" title="Kubernetes - Federation"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/federation.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes - Federation</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/go-envoy.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Kubernetes - Envoy</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/02/02/cloud-native-foundation-k8s-security/" title="Kubernetes - Security"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-security.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-02</div><div class="title">Kubernetes - Security</div></div></a></div><div><a href="/2023/02/01/cloud-native-foundation-k8s-federation/" title="Kubernetes - Federation"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/federation.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">Kubernetes - Federation</div></div></a></div><div><a href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/go-envoy.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-30</div><div class="title">Kubernetes - Envoy</div></div></a></div><div><a href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-11</div><div class="title">Kubernetes - Helm Doc</div></div></a></div><div><a href="/2023/01/29/cloud-native-foundation-k8s-scaling/" title="Kubernetes - Scaling"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231223144041516.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-29</div><div class="title">Kubernetes - Scaling</div></div></a></div><div><a href="/2023/01/28/cloud-native-foundation-k8s-helm/" title="Kubernetes - Helm"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-helm.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-28</div><div class="title">Kubernetes - Helm</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">531</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">166</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">71</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CRD"><span class="toc-number">1.</span> <span class="toc-text">CRD</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sidecar"><span class="toc-number">2.</span> <span class="toc-text">Sidecar</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E8%83%BD%E5%8A%9B"><span class="toc-number">3.</span> <span class="toc-text">主要能力</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">流量管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1"><span class="toc-number">3.2.</span> <span class="toc-text">服务通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ingress-x2F-Egress"><span class="toc-number">3.3.</span> <span class="toc-text">Ingress &#x2F; Egress</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-x2F-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.4.</span> <span class="toc-text">服务发现 &#x2F; 负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="toc-number">3.5.</span> <span class="toc-text">故障处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%BE%AE%E8%B0%83"><span class="toc-number">3.6.</span> <span class="toc-text">配置微调</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5"><span class="toc-number">3.7.</span> <span class="toc-text">故障注入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">规则配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ingress"><span class="toc-number">5.</span> <span class="toc-text">Ingress</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTPS"><span class="toc-number">6.</span> <span class="toc-text">HTTPS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Canary"><span class="toc-number">7.</span> <span class="toc-text">Canary</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5-1"><span class="toc-number">8.</span> <span class="toc-text">故障注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%A0%88"><span class="toc-number">9.</span> <span class="toc-text">网络栈</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/02/llm-core-ml-concept/" title="LLM Core - Machine Learning Concept"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/llm-ml.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM Core - Machine Learning Concept"/></a><div class="content"><a class="title" href="/2024/07/02/llm-core-ml-concept/" title="LLM Core - Machine Learning Concept">LLM Core - Machine Learning Concept</a><time datetime="2024-07-01T16:06:25.000Z" title="Created 2024-07-02 00:06:25">2024-07-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/01/llm-api/" title="LLM - API"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/image-20240817181521113.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM - API"/></a><div class="content"><a class="title" href="/2024/07/01/llm-api/" title="LLM - API">LLM - API</a><time datetime="2024-06-30T16:06:25.000Z" title="Created 2024-07-01 00:06:25">2024-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/30/llm-rag-chatglm3-6b-langchain-faiss/" title="LLM RAG - ChatGLM3-6B + LangChain + Faiss"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/rag.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM RAG - ChatGLM3-6B + LangChain + Faiss"/></a><div class="content"><a class="title" href="/2024/06/30/llm-rag-chatglm3-6b-langchain-faiss/" title="LLM RAG - ChatGLM3-6B + LangChain + Faiss">LLM RAG - ChatGLM3-6B + LangChain + Faiss</a><time datetime="2024-06-29T16:06:25.000Z" title="Created 2024-06-30 00:06:25">2024-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/29/llm-peft-chatglm3-6b-lora/" title="LLM PEFT - ChatGLM3-6B + LoRA"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/lora.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM PEFT - ChatGLM3-6B + LoRA"/></a><div class="content"><a class="title" href="/2024/06/29/llm-peft-chatglm3-6b-lora/" title="LLM PEFT - ChatGLM3-6B + LoRA">LLM PEFT - ChatGLM3-6B + LoRA</a><time datetime="2024-06-28T16:06:25.000Z" title="Created 2024-06-29 00:06:25">2024-06-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/28/llm-deploy-chatglm3-6b/" title="LLM Deploy - ChatGLM3-6B"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/chatglm3-6b.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM Deploy - ChatGLM3-6B"/></a><div class="content"><a class="title" href="/2024/06/28/llm-deploy-chatglm3-6b/" title="LLM Deploy - ChatGLM3-6B">LLM Deploy - ChatGLM3-6B</a><time datetime="2024-06-27T16:06:25.000Z" title="Created 2024-06-28 00:06:25">2024-06-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2024 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Go Engineering - Foundation - CLI | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="CLI Cobra 很好地集成了 Pflag 和 Viper     工具包 用途    Pflag 命令行参数解析   Viper 配置文件解析   Cobra 命令行框架   Pflag Pflag 通过创建 Flag 和 FlagSet 来使用，使用 Pflag 的开源项目：Kubernetes、Istio、Helm、Docker、Etcd  Flag 一个命令行参数会被解析成一个 Flag">
<meta property="og:type" content="article">
<meta property="og:title" content="Go Engineering - Foundation - CLI">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/05/03/cloud-native-foundation-go-engineering-foundation-cli/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="CLI Cobra 很好地集成了 Pflag 和 Viper     工具包 用途    Pflag 命令行参数解析   Viper 配置文件解析   Cobra 命令行框架   Pflag Pflag 通过创建 Flag 和 FlagSet 来使用，使用 Pflag 的开源项目：Kubernetes、Istio、Helm、Docker、Etcd  Flag 一个命令行参数会被解析成一个 Flag">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-23.png">
<meta property="article:published_time" content="2022-05-02T16:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.567Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Go Engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-23.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go Engineering - Foundation - CLI",
  "url": "https://blog.zhongmingmao.top/2022/05/03/cloud-native-foundation-go-engineering-foundation-cli/",
  "image": "https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-23.png",
  "datePublished": "2022-05-02T16:06:25.000Z",
  "dateModified": "2023-04-03T10:04:59.567Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/05/03/cloud-native-foundation-go-engineering-foundation-cli/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go Engineering - Foundation - CLI',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">640</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-23.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Go Engineering - Foundation - CLI</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Go Engineering - Foundation - CLI</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-05-02T16:06:25.000Z" title="Created 2022-05-03 00:06:25">2022-05-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/go-engineering/">Go Engineering</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">3.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>18mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-04-03 18:04:59&quot;}" hidden></div><h1 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h1><blockquote>
<p>Cobra 很好地集成了 Pflag 和 Viper</p>
</blockquote>
<table>
<thead>
<tr>
<th>工具包</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Pflag</strong></td>
<td><strong>命令行参数</strong>解析</td>
</tr>
<tr>
<td><strong>Viper</strong></td>
<td><strong>配置文件</strong>解析</td>
</tr>
<tr>
<td><strong>Cobra</strong></td>
<td><strong>命令行框架</strong></td>
</tr>
</tbody></table>
<h1 id="Pflag"><a href="#Pflag" class="headerlink" title="Pflag"></a>Pflag</h1><blockquote>
<p>Pflag 通过创建 <strong>Flag</strong> 和 <strong>FlagSet</strong> 来使用，使用 Pflag 的开源项目：Kubernetes、Istio、Helm、Docker、Etcd</p>
</blockquote>
<h2 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h2><blockquote>
<p>一个<strong>命令行参数</strong>会被解析成一个 <strong>Flag 类型的变量</strong></p>
</blockquote>
<span id="more"></span>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Flag represents the state of a flag.</span></span><br><span class="line"><span class="keyword">type</span> Flag <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name                <span class="type">string</span>              <span class="comment">// name as it appears on command line</span></span><br><span class="line">    Shorthand           <span class="type">string</span>              <span class="comment">// one-letter abbreviated flag</span></span><br><span class="line">    Usage               <span class="type">string</span>              <span class="comment">// help message</span></span><br><span class="line">    Value               Value               <span class="comment">// value as set</span></span><br><span class="line">    DefValue            <span class="type">string</span>              <span class="comment">// default value (as text); for usage message</span></span><br><span class="line">    Changed             <span class="type">bool</span>                <span class="comment">// If the user set the value (or if left to default)</span></span><br><span class="line">    NoOptDefVal         <span class="type">string</span>              <span class="comment">// default value (as text); if the flag is on the command line without any options</span></span><br><span class="line">    Deprecated          <span class="type">string</span>              <span class="comment">// If this flag is deprecated, this string is the new or now thing to use</span></span><br><span class="line">    Hidden              <span class="type">bool</span>                <span class="comment">// used by cobra.Command to allow flags to be hidden from help/usage text</span></span><br><span class="line">    ShorthandDeprecated <span class="type">string</span>              <span class="comment">// If the shorthand of this flag is deprecated, this string is the new or now thing to use</span></span><br><span class="line">    Annotations         <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span> <span class="comment">// used by cobra.Command bash autocomple code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将 Flag 的值抽象成一个<strong>接口</strong>，可以自定义 Flag 类型</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Value is the interface to the dynamic value stored in a flag.</span></span><br><span class="line"><span class="comment">// (The default value is represented as a string.)</span></span><br><span class="line"><span class="keyword">type</span> Value <span class="keyword">interface</span> &#123;</span><br><span class="line">    String() <span class="type">string</span>     <span class="comment">// 将flag类型的值转换为string类型的值，并返回string的内容</span></span><br><span class="line">    Set(<span class="type">string</span>) <span class="type">error</span>   <span class="comment">// 将string类型的值转换为flag类型的值，转换失败报错</span></span><br><span class="line">    Type() <span class="type">string</span>       <span class="comment">// 返回flag的类型，例如：string、int、ip等</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FlagSet"><a href="#FlagSet" class="headerlink" title="FlagSet"></a>FlagSet</h2><ol>
<li>FlagSet 是一些<strong>预先</strong>定义好的 <strong>Flag 集合</strong>，几乎所有的 Pflag 操作都可以借助 FlagSet 提供的方法来完成</li>
<li>获取 FlagSet<ul>
<li>调用 <strong>NewFlagSet</strong> 创建一个 FlagSet</li>
<li>使用 Pflag 包定义的全局 FlagSet：<strong>CommandLine</strong><ul>
<li><code>var CommandLine = NewFlagSet(os.Args[0], ExitOnError)</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>自定义 FlagSet：通过定义一个新的 FlagSet 来定义<strong>命令</strong>及其<strong>子命令</strong>的 Flag</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> version <span class="type">bool</span></span><br><span class="line">flagSet := pflag.NewFlagSet(<span class="string">&quot;test&quot;</span>, pflag.ContinueOnError)</span><br><span class="line">flagSet.BoolVar(&amp;version, <span class="string">&quot;version&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Print version information and quit.&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>全局 FlagSet，适用于<strong>不需要定义子命令</strong>的命令行工具</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/spf13/pflag&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">pflag.BoolVarP(&amp;version, <span class="string">&quot;version&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Print version information and quit.&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CommandLine 是一个<strong>包级别</strong>的变量</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> CommandLine = NewFlagSet(os.Args[<span class="number">0</span>], ExitOnError)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BoolVarP</span><span class="params">(p *<span class="type">bool</span>, name, shorthand <span class="type">string</span>, value <span class="type">bool</span>, usage <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    flag := CommandLine.VarPF(newBoolValue(value, p), name, shorthand, usage)</span><br><span class="line">    flag.NoOptDefVal = <span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><h3 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h3><blockquote>
<p>长选项 + 默认值 + 使用文本，返回指针</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name := pflag.String(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;Input Your Name&quot;</span>)</span><br><span class="line"></span><br><span class="line">pflag.Parse()</span><br><span class="line">log.Println(*name)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>长选项 + 短选项 + 默认值 + 使用文本，返回指针</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name := pflag.StringP(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;Input Your Name&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>长选项 + 默认值 + 使用文本，将标志的值绑定到变量</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="type">string</span></span><br><span class="line">pflag.StringVar(&amp;name, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;Input Your Name&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>长选项 + 短选项 + 默认值 + 使用文本，将标志的值绑定到变量</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="type">string</span></span><br><span class="line">pflag.StringVarP(&amp;name, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;Input Your Name&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Get"><a href="#Get" class="headerlink" title="Get&lt;Type&gt;"></a><code>Get&lt;Type&gt;</code></h3><blockquote>
<p>Type 为 Pflag 所支持的类型</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/image-20220503153518143.png" alt="image-20220503153518143"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flagName := <span class="string">&quot;name&quot;</span></span><br><span class="line">pflag.String(flagName, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;Input Your Name&quot;</span>)</span><br><span class="line">pflag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> name, err := pflag.CommandLine.GetString(flagName); err == <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Println(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Flag-vs-Arg"><a href="#Flag-vs-Arg" class="headerlink" title="Flag vs Arg"></a>Flag vs Arg</h3><blockquote>
<p><strong>非选项参数：arg；选项参数（标志）：flag</strong></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flagName := <span class="string">&quot;name&quot;</span></span><br><span class="line">name := pflag.String(flagName, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;Input Your Name&quot;</span>)</span><br><span class="line">pflag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="comment">// flag</span></span><br><span class="line">log.Println(*name)</span><br><span class="line"></span><br><span class="line"><span class="comment">// arg</span></span><br><span class="line">log.Printf(<span class="string">&quot;%v, %v, %v\n&quot;</span>, pflag.NArg(), pflag.Args(), pflag.Args()[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go --name zhongmingwu hello pflag</span><br><span class="line">2022/05/03 15:42:49 zhongmingwu</span><br><span class="line">2022/05/03 15:42:49 2, [hello pflag], hello</span><br></pre></td></tr></table></figure>

<h3 id="Flag-NoOptDefVal"><a href="#Flag-NoOptDefVal" class="headerlink" title="Flag.NoOptDefVal"></a>Flag.NoOptDefVal</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flagName := <span class="string">&quot;name&quot;</span></span><br><span class="line">name := pflag.String(flagName, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;Input Your Name&quot;</span>)</span><br><span class="line">pflag.Lookup(flagName).NoOptDefVal = <span class="string">&quot;zhongmingwu&quot;</span></span><br><span class="line">pflag.Parse()</span><br><span class="line"></span><br><span class="line">log.Println(*name)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go --name zhongmingwu            </span><br><span class="line">2022/05/03 15:46:38 zhongmingwu</span><br><span class="line"></span><br><span class="line">$ go run main.go --name            </span><br><span class="line">2022/05/03 15:46:41 zhongmingwu</span><br><span class="line"></span><br><span class="line">$ go run main.go       </span><br><span class="line">2022/05/03 15:46:45 zhongmingmao</span><br></pre></td></tr></table></figure>

<h3 id="MarkDeprecated"><a href="#MarkDeprecated" class="headerlink" title="MarkDeprecated"></a>MarkDeprecated</h3><blockquote>
<p>help 文档中不会显式弃用的 flag</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pflag.String(<span class="string">&quot;protocol&quot;</span>, <span class="string">&quot;http&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">pflag.String(<span class="string">&quot;proto&quot;</span>, <span class="string">&quot;https&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">_ = pflag.CommandLine.MarkDeprecated(<span class="string">&quot;protocol&quot;</span>, <span class="string">&quot;please use --proto instead&quot;</span>)</span><br><span class="line">pflag.Parse()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -h          </span><br><span class="line">Usage of ./main:</span><br><span class="line">      --proto string    (default &quot;https&quot;)</span><br><span class="line">pflag: help requested</span><br><span class="line"></span><br><span class="line">$ ./main --protocol https</span><br><span class="line">Flag --protocol has been deprecated, please use --proto instead</span><br><span class="line"></span><br><span class="line">$ ./main --proto https</span><br></pre></td></tr></table></figure>

<h3 id="MarkShorthandDeprecated"><a href="#MarkShorthandDeprecated" class="headerlink" title="MarkShorthandDeprecated"></a>MarkShorthandDeprecated</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flagName := <span class="string">&quot;protocol&quot;</span></span><br><span class="line">pflag.StringP(flagName, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;http&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">_ = pflag.CommandLine.MarkShorthandDeprecated(flagName, <span class="string">&quot;please use --&quot;</span>+flagName+<span class="string">&quot; only&quot;</span>)</span><br><span class="line">pflag.Parse()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -h      </span><br><span class="line">Usage of ./main:</span><br><span class="line">      --protocol string    (default &quot;http&quot;)</span><br><span class="line">pflag: help requested</span><br><span class="line"></span><br><span class="line">$ ./main -P https</span><br><span class="line">Flag shorthand -P has been deprecated, please use --protocol only</span><br><span class="line"></span><br><span class="line">$ ./main --protocol https</span><br></pre></td></tr></table></figure>

<h3 id="MarkHidden"><a href="#MarkHidden" class="headerlink" title="MarkHidden"></a>MarkHidden</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pflag.String(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">pflag.String(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;i do not know&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">_ = pflag.CommandLine.MarkHidden(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">pflag.Parse()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -h              </span><br><span class="line">Usage of ./main:</span><br><span class="line">      --user string    (default &quot;zhongmingmao&quot;)</span><br><span class="line">pflag: help requested</span><br><span class="line"></span><br><span class="line">$ ./main --user zhongmingmao</span><br><span class="line"></span><br><span class="line">$ ./main --user zhongmingmao --password 123456</span><br></pre></td></tr></table></figure>

<h1 id="Viper"><a href="#Viper" class="headerlink" title="Viper"></a>Viper</h1><blockquote>
<p>Viper 能够处理<strong>不同格式</strong>的配置文件，<strong>Viper Key</strong> 是<strong>不区分大小写</strong></p>
</blockquote>
<h2 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a>配置优先级</h2><blockquote>
<p>高优先级的配置会<strong>覆盖</strong>低优先级的配置，优先级<strong>由高到低</strong>如下</p>
</blockquote>
<ol>
<li>通过 <code>viper.Set</code> 函数<strong>显式设置</strong>的配置 – Go 代码</li>
<li>命令行参数</li>
<li>环境变量</li>
<li>配置文件</li>
<li>远程 KV 存储</li>
<li>默认值</li>
</ol>
<h2 id="读入配置"><a href="#读入配置" class="headerlink" title="读入配置"></a>读入配置</h2><blockquote>
<p>将配置读入 Viper 中</p>
</blockquote>
<h3 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">viper.SetDefault(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhongmingmao&quot;</span>)</span><br><span class="line">viper.SetDefault(<span class="string">&quot;info&quot;</span>, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;zhongmingmao&quot;</span>, <span class="string">&quot;location&quot;</span>: <span class="string">&quot;China&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><blockquote>
<p>支持 <strong>JSON</strong>、<strong>TOML</strong>、<strong>YAML</strong>、<strong>Properties</strong>、<strong>Env</strong> 等格式；支持<strong>多路径搜索</strong></p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>config config_search.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">boot:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">collector</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">profile:</span></span><br><span class="line">  <span class="attr">active:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debug:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/spf13/pflag&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">    <span class="string">&quot;gopkg.in/yaml.v2&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    cfg  = pflag.StringP(<span class="string">&quot;config&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;Configuration file.&quot;</span>)</span><br><span class="line">    help = pflag.BoolP(<span class="string">&quot;help&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;Show help message.&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    pflag.Parse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> *help &#123;</span><br><span class="line">        pflag.Usage()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *cfg != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        viper.SetConfigFile(*cfg)</span><br><span class="line">        viper.SetConfigType(<span class="string">&quot;yaml&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//多路径搜索</span></span><br><span class="line">        viper.AddConfigPath(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        viper.AddConfigPath(<span class="string">&quot;$GOPATH/src/&quot;</span>)</span><br><span class="line">        <span class="comment">//尝试搜索：config_search.yaml、config_search.json 等</span></span><br><span class="line">        viper.SetConfigName(<span class="string">&quot;config_search&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := viper.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;Fatal error config file: %v&quot;</span>, err))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//序列化</span></span><br><span class="line">    marshal, _ := yaml.Marshal(viper.AllSettings())</span><br><span class="line">    log.Printf(<span class="string">&quot;\n%s\n&quot;</span>, <span class="type">string</span>(marshal))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ ls                                                                              </span><br><span class="line">config             config_search.yaml go.mod             go.sum             main               main.go</span><br><span class="line"></span><br><span class="line">$ ./main -h</span><br><span class="line">Usage of ./main:</span><br><span class="line">  -c, --config string   Configuration file.</span><br><span class="line">  -h, --help            Show help message.</span><br><span class="line">  </span><br><span class="line">$ ./main -c config                                                                       </span><br><span class="line">2022/05/03 16:46:07 </span><br><span class="line">debug:</span><br><span class="line">  enable: true</span><br><span class="line">  port: 9090</span><br><span class="line">profile:</span><br><span class="line">  active: prod</span><br><span class="line">spring:</span><br><span class="line">  boot:</span><br><span class="line">    name: collector</span><br><span class="line">  server:</span><br><span class="line">    port: 8080</span><br><span class="line">    </span><br><span class="line">$ ./main          </span><br><span class="line">2022/05/03 16:46:23 </span><br><span class="line">debug:</span><br><span class="line">  enable: true</span><br><span class="line">  port: 9090</span><br><span class="line">profile:</span><br><span class="line">  active: prod</span><br><span class="line">spring:</span><br><span class="line">  boot:</span><br><span class="line">    name: collector</span><br><span class="line">  server:</span><br><span class="line">    port: 8080</span><br></pre></td></tr></table></figure>

<h3 id="热加载"><a href="#热加载" class="headerlink" title="热加载"></a>热加载</h3><blockquote>
<p>不建议使用热加载功能，因为不一定能实际生效，例如修改监听端口等</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">viper.WatchConfig()</span><br><span class="line">viper.OnConfigChange(<span class="function"><span class="keyword">func</span><span class="params">(in fsnotify.Event)</span></span> &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;Config changed, %s\n&quot;</span>, in.Name)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="显式设置"><a href="#显式设置" class="headerlink" title="显式设置"></a>显式设置</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//覆盖配置文件中对应的值</span></span><br><span class="line">viper.Set(<span class="string">&quot;profile.active&quot;</span>, <span class="string">&quot;dev&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./main          </span><br><span class="line">2022/05/03 16:56:12 </span><br><span class="line">debug:</span><br><span class="line">  enable: true</span><br><span class="line">  port: 9090</span><br><span class="line">profile:</span><br><span class="line">  active: dev</span><br><span class="line">spring:</span><br><span class="line">  boot:</span><br><span class="line">    name: collector</span><br><span class="line">  server:</span><br><span class="line">    port: 8080</span><br></pre></td></tr></table></figure>

<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><blockquote>
<p>Viper <strong>读取环境变量</strong>是<strong>区分大小写</strong>的</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SetEnvPrefix(in <span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">BindEnv(input ...<span class="type">string</span>) <span class="type">error</span> <span class="comment">// BindEnv binds a Viper key to a ENV variable.</span></span><br><span class="line">SetEnvKeyReplacer(r *strings.Replacer)</span><br><span class="line"></span><br><span class="line">AllowEmptyEnv(allowEmptyEnv <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">AutomaticEnv()</span><br></pre></td></tr></table></figure>

<h4 id="SetEnvPrefix"><a href="#SetEnvPrefix" class="headerlink" title="SetEnvPrefix"></a>SetEnvPrefix</h4><blockquote>
<p>用来确保环境变量是<strong>唯一</strong>的</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.SetEnvPrefix(<span class="string">&quot;viper&quot;</span>)</span><br><span class="line">viper.AutomaticEnv()</span><br><span class="line">log.Println(viper.Get(<span class="string">&quot;api_version&quot;</span>)) <span class="comment">// VIPER_API_VERSION</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ VIPER_API_VERSION=0.0.1 go run main.go</span><br><span class="line">2022/05/03 17:03:17 0.0.1</span><br></pre></td></tr></table></figure>

<h4 id="SetEnvKeyReplacer-BindEnv"><a href="#SetEnvKeyReplacer-BindEnv" class="headerlink" title="SetEnvKeyReplacer + BindEnv"></a>SetEnvKeyReplacer + BindEnv</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">id := <span class="string">&quot;user.secret-id&quot;</span></span><br><span class="line">key := <span class="string">&quot;user.secret-key&quot;</span></span><br><span class="line">viper.SetEnvPrefix(<span class="string">&quot;VIPER&quot;</span>)</span><br><span class="line"><span class="comment">// . -&gt; _</span></span><br><span class="line"><span class="comment">// - -&gt; _</span></span><br><span class="line">viper.SetEnvKeyReplacer(strings.NewReplacer(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;_&quot;</span>))</span><br><span class="line">viper.BindEnv(id, <span class="string">&quot;USER_SECRET_ID&quot;</span>) <span class="comment">// USER_SECRET_ID</span></span><br><span class="line">viper.BindEnv(key)                  <span class="comment">// VIPER_USER_SECRET_KEY</span></span><br><span class="line"></span><br><span class="line">log.Printf(<span class="string">&quot;%v %v\n&quot;</span>, viper.Get(id), viper.IsSet(id))</span><br><span class="line">log.Printf(<span class="string">&quot;%v %v\n&quot;</span>, viper.Get(key), viper.IsSet(key))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ USER_SECRET_ID=1 VIPER_USER_SECRET_KEY=key go run main.go</span><br><span class="line">2022/05/03 17:17:30 1 true</span><br><span class="line">2022/05/03 17:17:30 key true</span><br><span class="line"></span><br><span class="line">$ USER_SECRET_ID=1 VIPER_USER_SECRET_KEY= go run main.go   </span><br><span class="line">2022/05/03 17:17:32 1 true</span><br><span class="line">2022/05/03 17:17:32 &lt;nil&gt; false</span><br></pre></td></tr></table></figure>

<h4 id="AllowEmptyEnv"><a href="#AllowEmptyEnv" class="headerlink" title="AllowEmptyEnv"></a>AllowEmptyEnv</h4><blockquote>
<p>默认情况下，<strong>空环境</strong>变量会被认为<strong>未设置</strong></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">viper.AllowEmptyEnv(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ USER_SECRET_ID=1 VIPER_USER_SECRET_KEY= go run main.go</span><br><span class="line">2022/05/03 17:18:49 1 true</span><br><span class="line">2022/05/03 17:18:49  true</span><br></pre></td></tr></table></figure>

<h3 id="Key-bind-Flag"><a href="#Key-bind-Flag" class="headerlink" title="Key bind Flag"></a>Key bind Flag</h3><blockquote>
<p>Viper 支持 Pflag，能够绑定 <strong>Viper key</strong> 到 <strong>Pflag flag</strong>；绑定时不会设置该值，在<strong>访问</strong>时才会<strong>设置</strong></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pflag.String(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;xxx&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">pflag.String(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;yyy&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment">//绑定 Flag</span></span><br><span class="line">_ = viper.BindPFlag(<span class="string">&quot;v.id&quot;</span>, pflag.Lookup(<span class="string">&quot;id&quot;</span>))</span><br><span class="line"><span class="comment">//绑定 FlagSet</span></span><br><span class="line">_ = viper.BindPFlags(pflag.CommandLine)</span><br><span class="line">pflag.Parse()</span><br><span class="line"></span><br><span class="line">log.Println(viper.Get(<span class="string">&quot;v.id&quot;</span>))</span><br><span class="line">log.Println(viper.Get(<span class="string">&quot;key&quot;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go --id 1</span><br><span class="line">2022/05/03 17:29:56 1</span><br><span class="line">2022/05/03 17:29:56 yyy</span><br></pre></td></tr></table></figure>

<h2 id="读取配置"><a href="#读取配置" class="headerlink" title="读取配置"></a>读取配置</h2><blockquote>
<p>Get 在<strong>找不到</strong>值的时候都会返回<strong>零值</strong>，可以通过 <code>IsSet</code> 来判断 key 是否存在</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Get(key <span class="type">string</span>) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">Get&lt;Type&gt;(key <span class="type">string</span>) &lt;Type&gt;</span><br><span class="line">AllSettings() <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">IsSet(key <span class="type">string</span>) <span class="type">bool</span></span><br></pre></td></tr></table></figure>

<h3 id="嵌套的键"><a href="#嵌套的键" class="headerlink" title="嵌套的键"></a>嵌套的键</h3><blockquote>
<p>嵌套的路径通过 <code>.</code> 进行分隔</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">boot:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">collector</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">profile:</span></span><br><span class="line">  <span class="attr">active:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debug:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.Println(viper.GetString(<span class="string">&quot;spring.boot.name&quot;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -c config</span><br><span class="line">2022/05/03 17:39:43 </span><br><span class="line">debug:</span><br><span class="line">  enable: true</span><br><span class="line">  port: 9090</span><br><span class="line">profile:</span><br><span class="line">  active: dev</span><br><span class="line">spring:</span><br><span class="line">  boot:</span><br><span class="line">    name: collector</span><br><span class="line">  server:</span><br><span class="line">    port: 8080</span><br><span class="line"></span><br><span class="line">2022/05/03 17:39:43 collector</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 如果 Key 被更高优先级的配置<strong>覆盖</strong>，该 Key 下的所有子 Key 都是<strong>未定义状态</strong></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">viper.Set(<span class="string">&quot;spring.boot&quot;</span>, <span class="string">&quot;overlay&quot;</span>)</span><br><span class="line">log.Println(viper.IsSet(<span class="string">&quot;spring.boot.name&quot;</span>)) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果存在与分隔的路径<strong>完全匹配</strong>的 Key，直接返回其值</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.boot.name:</span> <span class="string">client</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">boot:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">collector</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">profile:</span></span><br><span class="line">  <span class="attr">active:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debug:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.Println(viper.Get(<span class="string">&quot;spring.boot.name&quot;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -c config</span><br><span class="line">2022/05/03 17:45:34 </span><br><span class="line">debug:</span><br><span class="line">  enable: true</span><br><span class="line">  port: 9090</span><br><span class="line">profile:</span><br><span class="line">  active: dev</span><br><span class="line">spring:</span><br><span class="line">  boot:</span><br><span class="line">    name: client</span><br><span class="line">  server:</span><br><span class="line">    port: 8080</span><br><span class="line"></span><br><span class="line">2022/05/03 17:45:34 client</span><br></pre></td></tr></table></figure>

<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Boot <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">    port <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Spring <span class="keyword">struct</span> &#123;</span><br><span class="line">    boot   Boot</span><br><span class="line">    server Server</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Profile <span class="keyword">struct</span> &#123;</span><br><span class="line">    active <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Debug <span class="keyword">struct</span> &#123;</span><br><span class="line">    enable    <span class="type">bool</span></span><br><span class="line">    debugPort <span class="type">int</span> <span class="string">`mapstructure:&quot;port&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> YamlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    spring  Spring</span><br><span class="line">    profile Profile</span><br><span class="line">    debug   Debug</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> yc = YamlConfig&#123;&#125;</span><br><span class="line">_ = viper.Unmarshal(&amp;yc)</span><br><span class="line">yamlSettings, _ := yaml.Marshal(viper.AllSettings())</span><br><span class="line">log.Printf(<span class="string">&quot;\n%s\n&quot;</span>, <span class="type">string</span>(yamlSettings))</span><br><span class="line">jsonSettings, _ := json.Marshal(viper.AllSettings())</span><br><span class="line">log.Printf(<span class="string">&quot;\n%s\n&quot;</span>, <span class="type">string</span>(jsonSettings))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -c config</span><br><span class="line">2022/05/03 17:57:58 </span><br><span class="line">debug:</span><br><span class="line">  enable: true</span><br><span class="line">  port: 9090</span><br><span class="line">profile:</span><br><span class="line">  active: prod</span><br><span class="line">spring:</span><br><span class="line">  boot:</span><br><span class="line">    name: collector</span><br><span class="line">  server:</span><br><span class="line">    port: 8080</span><br><span class="line"></span><br><span class="line">2022/05/03 17:57:58 </span><br><span class="line">&#123;&quot;debug&quot;:&#123;&quot;enable&quot;:true,&quot;port&quot;:9090&#125;,&quot;profile&quot;:&#123;&quot;active&quot;:&quot;prod&quot;&#125;,&quot;spring&quot;:&#123;&quot;boot&quot;:&#123;&quot;name&quot;:&quot;collector&quot;&#125;,&quot;server&quot;:&#123;&quot;port&quot;:8080&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Cobra"><a href="#Cobra" class="headerlink" title="Cobra"></a>Cobra</h1><blockquote>
<p>建立在 <strong>commands</strong>（命令）、<strong>arguments</strong>（非选项参数） 和 <strong>flags</strong>（选项参数） 之上</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># clone 是一个命令，URL 是一个非选项参数，bare 是一个选项参数</span><br><span class="line">$ git clone URL --bare</span><br></pre></td></tr></table></figure>

<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><blockquote>
<p>使用 Cobra 库创建命令</p>
</blockquote>
<h3 id="root"><a href="#root" class="headerlink" title="root"></a>root</h3><figure class="highlight go"><figcaption><span>cmd/root.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/mitchellh/go-homedir&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gitCmd = &amp;cobra.Command&#123;</span><br><span class="line">    Use:   <span class="string">&quot;git&quot;</span>,</span><br><span class="line">    Short: <span class="string">&quot;Short&quot;</span>,</span><br><span class="line">    Long:  <span class="string">&quot;Long&quot;</span>,</span><br><span class="line">    Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">        log.Println(<span class="string">&quot;Run in cmd: git&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    cfg     <span class="type">string</span></span><br><span class="line">    path    <span class="type">string</span></span><br><span class="line">    license <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cobra.OnInitialize(initConfig)</span><br><span class="line"></span><br><span class="line">    gitCmd.PersistentFlags().StringVarP(&amp;cfg, <span class="string">&quot;config&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;config file (default is $HOME/.cobra.yaml)&quot;</span>)</span><br><span class="line">    gitCmd.PersistentFlags().StringVarP(&amp;path, <span class="string">&quot;path&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;base project directory&quot;</span>)</span><br><span class="line">    gitCmd.PersistentFlags().StringVarP(&amp;license, <span class="string">&quot;license&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;Name of license for the project&quot;</span>)</span><br><span class="line"></span><br><span class="line">    _ = viper.BindPFlag(<span class="string">&quot;v.path&quot;</span>, gitCmd.PersistentFlags().Lookup(<span class="string">&quot;path&quot;</span>))</span><br><span class="line">    _ = viper.BindPFlag(<span class="string">&quot;v.license&quot;</span>, gitCmd.PersistentFlags().Lookup(<span class="string">&quot;license&quot;</span>))</span><br><span class="line">    viper.SetDefault(<span class="string">&quot;v.license&quot;</span>, <span class="string">&quot;MIT&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initConfig</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> cfg != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        viper.SetConfigFile(cfg)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        home, err := homedir.Dir()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Println(err)</span><br><span class="line">            os.Exit(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        viper.AddConfigPath(home)</span><br><span class="line">        viper.SetConfigName(<span class="string">&quot;.cobra&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := viper.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Execute</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := gitCmd.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/zhongmingmao/cli/cobra/cmd&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cmd.Execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -h</span><br><span class="line">Long</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  git [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -c, --config string    config file (default is $HOME/.cobra.yaml)</span><br><span class="line">  -h, --help             help for git</span><br><span class="line">  -l, --license string   Name of license for the project</span><br><span class="line">  -p, --path string      base project directory</span><br><span class="line">  </span><br><span class="line">$ ./main   </span><br><span class="line">2022/05/03 18:34:00 Run in cmd: git</span><br></pre></td></tr></table></figure>

<h3 id="AddCommand"><a href="#AddCommand" class="headerlink" title="AddCommand"></a>AddCommand</h3><figure class="highlight go"><figcaption><span>cmd/version.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> versionCmd = &amp;cobra.Command&#123;</span><br><span class="line">    Use:   <span class="string">&quot;version&quot;</span>,</span><br><span class="line">    Short: <span class="string">&quot;Print the version number&quot;</span>,</span><br><span class="line">    Long:  <span class="string">&quot;Print the version code&quot;</span>,</span><br><span class="line">    Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">        log.Println(<span class="string">&quot;git version 2.36.0&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    gitCmd.AddCommand(versionCmd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ./main -h</span><br><span class="line">Long</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  git [flags]</span><br><span class="line">  git [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  completion  Generate the autocompletion script for the specified shell</span><br><span class="line">  help        Help about any command</span><br><span class="line">  version     Print the version number</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -c, --config string    config file (default is $HOME/.cobra.yaml)</span><br><span class="line">  -h, --help             help for git</span><br><span class="line">  -l, --license string   Name of license for the project</span><br><span class="line">  -p, --path string      base project directory</span><br><span class="line"></span><br><span class="line">Use &quot;git [command] --help&quot; for more information about a command.</span><br><span class="line"></span><br><span class="line">$ ./main version</span><br><span class="line">2022/05/03 18:36:00 git version 2.36.0</span><br></pre></td></tr></table></figure>

<h2 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h2><h3 id="pflag"><a href="#pflag" class="headerlink" title="pflag"></a>pflag</h3><blockquote>
<p>Cobra 可以与 Pflag 集成，使用强大的标志功能</p>
</blockquote>
<h4 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h4><blockquote>
<p>持久化：该标志可用于它所分配的命令以及该命令下的每个子命令</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rootCmd.PersistentFlags().Bool(<span class="string">&quot;viper&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Use Viper for configuration&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="本地"><a href="#本地" class="headerlink" title="本地"></a>本地</h4><blockquote>
<p>本地：只能用在它所绑定的命令上</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rootCmd.Flags().StringVarP(&amp;Source, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;Source directory to read from&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>--source</code> 只能在 rootCmd 上引用，而不能在 rootCmd 的子命令上引用，例如 version</p>
</blockquote>
<h4 id="标志绑定到-Viper"><a href="#标志绑定到-Viper" class="headerlink" title="标志绑定到 Viper"></a>标志绑定到 Viper</h4><blockquote>
<p>将标志绑定到 Viper 上，后续可以通过 viper.Get() 来获取标志的值</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> author <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  rootCmd.PersistentFlags().StringVar(&amp;author, <span class="string">&quot;author&quot;</span>, <span class="string">&quot;YOUR NAME&quot;</span>, <span class="string">&quot;Author name for copyright attribution&quot;</span>)</span><br><span class="line">  viper.BindPFlag(<span class="string">&quot;author&quot;</span>, rootCmd.PersistentFlags().Lookup(<span class="string">&quot;author&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="必选标志"><a href="#必选标志" class="headerlink" title="必选标志"></a>必选标志</h4><blockquote>
<p>默认情况下，标志为可选的</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootCmd.Flags().StringVarP(&amp;Region, <span class="string">&quot;region&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;AWS region (required)&quot;</span>)</span><br><span class="line">rootCmd.MarkFlagRequired(<span class="string">&quot;region&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="非选项参数验证"><a href="#非选项参数验证" class="headerlink" title="非选项参数验证"></a>非选项参数验证</h3><blockquote>
<p>可以使用 Command 的 Args 字段来验证非选项参数，或者通过 Cobra 的内置验证函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>Cobra 内置验证函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>NoArgs</td>
<td>如果存在任何非选项参数，报错</td>
</tr>
<tr>
<td>ArbitraryArgs</td>
<td>接受任意非选项参数</td>
</tr>
<tr>
<td>OnlyValidArgs</td>
<td>任何非选项参数不在 Command 的 ValidArgs 字段中，报错</td>
</tr>
<tr>
<td>MinimumNArgs(int)</td>
<td>少于 N 个非选项参数，报错</td>
</tr>
<tr>
<td>MaximumNArgs(int)</td>
<td>多于 N 个非选项参数，报错</td>
</tr>
<tr>
<td>ExactArgs(int)</td>
<td>不等于 N 个非选项参数，报错</td>
</tr>
<tr>
<td>ExactValidArgs(int)</td>
<td>不等于 N 个非选项参数 或者 非选项参数不在 Command 的 ValidArgs 字段中，报错</td>
</tr>
<tr>
<td>RangeArgs(min, max)</td>
<td>非选项参数的个数不在 min 和 max 之间，报错</td>
</tr>
</tbody></table>
<blockquote>
<p>内置验证函数</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cmd = &amp;cobra.Command&#123;</span><br><span class="line">  Short: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">  Args: cobra.MinimumNArgs(<span class="number">1</span>), <span class="comment">// 使用内置的验证函数</span></span><br><span class="line">  Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello, World!&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>自定义验证函数</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cmd = &amp;cobra.Command&#123;</span><br><span class="line">  Short: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">  <span class="comment">// Args: cobra.MinimumNArgs(10), // 使用内置的验证函数</span></span><br><span class="line">  Args: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123; <span class="comment">// 自定义验证函数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> errors.New(<span class="string">&quot;requires at least one arg&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> myapp.IsValidColor(args[<span class="number">0</span>]) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid color specified: %s&quot;</span>, args[<span class="number">0</span>])</span><br><span class="line">  &#125;,</span><br><span class="line">  Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello, World!&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hooks-PreRun-PostRun"><a href="#Hooks-PreRun-PostRun" class="headerlink" title="Hooks: PreRun + PostRun"></a>Hooks: PreRun + PostRun</h3><blockquote>
<p>在运行 Run 函数时，可以运行一些 Hook 函数</p>
</blockquote>
<blockquote>
<p>如果子命令没有指定的 <code>Persistent*Run</code> 函数，则将继承父命令的 <code>Persistent*Run</code> 函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>运行顺序</th>
<th>Hook</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>PersistentPreRun</td>
</tr>
<tr>
<td>2</td>
<td>PreRun</td>
</tr>
<tr>
<td>3</td>
<td>Run</td>
</tr>
<tr>
<td>4</td>
<td>PostRun</td>
</tr>
<tr>
<td>5</td>
<td>PersistentPostRun</td>
</tr>
</tbody></table>
<blockquote>
<p>父级的 PreRun 只会在父级命令运行时调用，子命令不会调用</p>
</blockquote>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/05/03/cloud-native-foundation-go-engineering-foundation-cli/">https://blog.zhongmingmao.top/2022/05/03/cloud-native-foundation-go-engineering-foundation-cli/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/go/">Go</a><a class="post-meta__tags" href="/tags/go-engineering/">Go Engineering</a></div><div class="post-share"><div class="social-share" data-image="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-23.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/05/14/infrastructure-security-oauth2-authorization-code-grant/" title="Infrastructure - Security - OAuth 2.0 - Authorization Code Grant"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-5.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Infrastructure - Security - OAuth 2.0 - Authorization Code Grant</div></div><div class="info-2"><div class="info-item-1">  </div></div></div></a><a class="pagination-related" href="/2022/05/02/cloud-native-foundation-go-engineering-foundation-log-package/" title="Go Engineering - Foundation - Log - Package"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Go Engineering - Foundation - Log - Package</div></div><div class="info-2"><div class="info-item-1">开源日志包标准库 log 包 标准库自带，无需安装   只提供 Print、Panic、Fatal 函数用于日志输出 Go 标准库大量使用了该 log 包  glog Kubernetes 使用的 klog 是基于 glog 进行封装   Google 推出的轻量级日志包 特性 支持 4 种日志级别： Info、Warning、Error、Fatal 支持命令行选项 支持根据文件大小切割日志文件 支持日志按级别分类输出 支持 V level – 开发者自定义日志级别 支持 vmodule – 开发者对不同的文件使用不同的日志级别 支持 traceLocation – 打印指定位置的栈信息      logrus Github star 数量最多的日志包，Docker 和 Prometheus 也在使用 logrus   支持常用的日志级别 可扩展：允许使用者通过 Hook 的方式，将日志分发到任意地方 支持自定义的日志格式：内置支持 JSON 和 TEXT 结构化日志记录：Field 机制允许使用者自定义字段 预设日志字段：Default Field 机制，可以给一部分或者全部日志统一添加共同的日志字段...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="info-item-2">Go Engineering - CLI</div></div><div class="info-2"><div class="info-item-1">应用框架 命令行参数解析 - Pflag 配置文件解析 - Viper 应用的命令行框架 - Cobra 命令需要具备 help 功能 命令需要能够解析命令行参数和配置文件 命令需要能够初始化业务代码，并最终启动业务进程      Pflag 命令行参数解析工具 - Kubernetes &#x2F; Istio &#x2F; Helm &#x2F; Docker &#x2F; Etcd &#x2F; …  Flag 一个命令行参数会被解析成一个 Flag 类型的变量  1234567891011121314// A Flag represents the state of a flag.type Flag struct &#123;    Name                string              // name as it appears on command line    Shorthand           string              // one-letter abbreviated flag    Usage               string   ...</div></div></div></a><a class="pagination-related" href="/2023/05/09/cloud-native-foundation-go-engineering-log/" title="Go Engineering - Log"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-log.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="info-item-2">Go Engineering - Log</div></div><div class="info-2"><div class="info-item-1">功能设计基础功能 支持基本的日志信息 - 时间戳、文件名、行号、日志级别、日志信息 支持不同的日志级别 - Debug &#x2F; Info &#x2F; Warn &#x2F; Error &#x2F; Panic &#x2F; Fatal logrus 支持 Trace 日志级别，Trace 不是必须的 Trace 和 Panic 是可选的级别   支持自定义配置 - 不同的环境采用不同的配置 开发环境的日志级别为 Debug，而生产环境的日志级别为 Info 通过配置，可以在不重新编译代码的情况下，改变记录日志的行为   支持输出到标准输出和文件     至少实现 6 个日志级别    日志调用时的属性   输出级别 glog.Info(“This is info message”)   开关级别 启动程序时，期望哪些输出级别的日志会被打印 glog -v=L - 只有输出级别 ≥L 的日志才会被打印     高级功能 支持多种日志格式 - TEXT &#x2F; JSON &#x2F; … 开发环境采用 TEXT 格式，生产环境采用 JSON 格式   按日志级别分类输出 - Error 级别...</div></div></div></a><a class="pagination-related" href="/2023/05/08/cloud-native-foundation-go-engineering-err-code/" title="Go Engineering - Error Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-error-handling.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="info-item-2">Go Engineering - Error Code</div></div><div class="info-2"><div class="info-item-1">预期功能 有业务 Code 码标识 - HTTP Code 码有限 安全 - 对内对外展示不同的错误信息    设计方式 无论请求成功与否，都返回 200，在 HTTP Body 中包含错误信息 HTTP Code 通常代表 HTTP Transport 层的状态信息 缺点：性能不佳（需解析 Body） + 对客户端不友好   返回 4xx or 5xx，并在 Body 中返回简单的错误信息 返回 4xx or 5xx，并在 Body 中返回详细的错误信息 - 推荐  设计思路 区别于 http status code，业务码需要有一定的规则，可以通过业务码判断出是哪类错误 请求出错时，可以通过 http status code，直接感知到请求出错 需要在请求出错时，返回详细的信息：Code + Message + Reference（Optional） 返回的错误信息，需要是可以直接展示给用户的安全信息，不能包含敏感信息 但同时也要有内部更详细的错误信息，方便 Debug   返回的数据格式应该是固定的，规范的 错误信息要保持简洁，并提供有用的信息  Biz Code 纯数字表示，不同部位代表不同的服...</div></div></div></a><a class="pagination-related" href="/2023/05/07/cloud-native-foundation-go-engineering-doc/" title="Go Engineering - Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-doc.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="info-item-2">Go Engineering - Doc</div></div><div class="info-2"><div class="info-item-1">Swagger Swagger 是一套围绕 OpenAPI 规范构建的开源工具     Component Desc    Swagger Editor 基于浏览器的编辑器，可以编写 OpenAPI 规范，并实时预览   Swagger UI 将 OpenAPI 规范呈现为交互式 API 文档   Swagger Codegen 根据 OpenAPI 规范，生成服务器存根和客户端代码库，涵盖 40 多种语言     OpenAPI OpenAPI 是一个 API 规范，其前身为 Swagger 规范 通过定义一种用来描述 API 格式或者 API 定义的 DSL，来规范 RESTful API 的开发过程 OpenAPI 3.0 ≈ Swagger 2.0   API 基本信息 对 API 的描述，介绍 API 可以实现的功能 每个 API 上可用的 Path 和 Method 每个 API 的输入和返回参数 验证方法 联系信息、许可证、使用条款和其它信息   OpenAPI 是一个 API 规范，而 Swagger 是实现该 API 规范的工具  go-swagger特性 功能强大、高性能、可以根据代...</div></div></div></a><a class="pagination-related" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-lint.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="info-item-2">Go Engineering - Lint</div></div><div class="info-2"><div class="info-item-1">golangci-lint 使用最多    优点   Advantage Desc    速度快 基于 gometalinter 开发，但比 gometalinter 快 5 倍原因：并行检查 + 复用 go build 缓存 + 缓存分析结果   可配置 支持 YAML 格式的配置文件   IDE 集成 Goland &#x2F; VS Code   linter 聚合器 不需要单独安装   最少误报数 调整了所集成 linter 的默认配置，大幅度减少误报   良好的输出 颜色、行号等   迭代快 不断有新的 linter 被集成到 golangci-lint 中   选项 配置 同时出现 - 命令行选项 &#x2F; 配置文件   bool&#x2F;string&#x2F;int - 命令行选项 slice - 合并  命令行选项 golangci-lint run -h     Flag Desc    –print-issued-lines Print lines of code with issue (default true)   –print-linter-name Print lin...</div></div></div></a><a class="pagination-related" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-makefile.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="info-item-2">Go Engineering - Makefile</div></div><div class="info-2"><div class="info-item-1">基础语法 https://github.com/seisman/how-to-write-makefile   规则语法 伪目标 变量赋值 特殊变量 自动化变量  功能设计Target   Target Desc    gen Generate all necessary files, such as error code files.   format Gofmt (reformat) package sources (exclude vendor dir if existed).   lint Check syntax and styling of go sources.   test Run unit test.   cover Run unit test and get test coverage.   build Build source code for host platform.   build.multiarch Build source code for multiple platforms. See option PLATFORMS.   image Build docker im...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">640</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CLI"><span class="toc-number">1.</span> <span class="toc-text">CLI</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pflag"><span class="toc-number">2.</span> <span class="toc-text">Pflag</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flag"><span class="toc-number">2.1.</span> <span class="toc-text">Flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FlagSet"><span class="toc-number">2.2.</span> <span class="toc-text">FlagSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Usage"><span class="toc-number">2.3.</span> <span class="toc-text">Usage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Definition"><span class="toc-number">2.3.1.</span> <span class="toc-text">Definition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get"><span class="toc-number">2.3.2.</span> <span class="toc-text">Get&lt;Type&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-vs-Arg"><span class="toc-number">2.3.3.</span> <span class="toc-text">Flag vs Arg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag-NoOptDefVal"><span class="toc-number">2.3.4.</span> <span class="toc-text">Flag.NoOptDefVal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MarkDeprecated"><span class="toc-number">2.3.5.</span> <span class="toc-text">MarkDeprecated</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MarkShorthandDeprecated"><span class="toc-number">2.3.6.</span> <span class="toc-text">MarkShorthandDeprecated</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MarkHidden"><span class="toc-number">2.3.7.</span> <span class="toc-text">MarkHidden</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Viper"><span class="toc-number">3.</span> <span class="toc-text">Viper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">3.1.</span> <span class="toc-text">配置优先级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%85%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.</span> <span class="toc-text">读入配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">3.2.1.</span> <span class="toc-text">默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.2.3.</span> <span class="toc-text">热加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E5%BC%8F%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.2.4.</span> <span class="toc-text">显式设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.5.</span> <span class="toc-text">环境变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SetEnvPrefix"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">SetEnvPrefix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SetEnvKeyReplacer-BindEnv"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">SetEnvKeyReplacer + BindEnv</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllowEmptyEnv"><span class="toc-number">3.2.5.3.</span> <span class="toc-text">AllowEmptyEnv</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-bind-Flag"><span class="toc-number">3.2.6.</span> <span class="toc-text">Key bind Flag</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">读取配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E7%9A%84%E9%94%AE"><span class="toc-number">3.3.1.</span> <span class="toc-text">嵌套的键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.3.2.</span> <span class="toc-text">反序列化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cobra"><span class="toc-number">4.</span> <span class="toc-text">Cobra</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.1.</span> <span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#root"><span class="toc-number">4.1.1.</span> <span class="toc-text">root</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main"><span class="toc-number">4.1.2.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AddCommand"><span class="toc-number">4.1.3.</span> <span class="toc-text">AddCommand</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">核心特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pflag"><span class="toc-number">4.2.1.</span> <span class="toc-text">pflag</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">持久化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E5%BF%97%E7%BB%91%E5%AE%9A%E5%88%B0-Viper"><span class="toc-number">4.2.1.3.</span> <span class="toc-text">标志绑定到 Viper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%85%E9%80%89%E6%A0%87%E5%BF%97"><span class="toc-number">4.2.1.4.</span> <span class="toc-text">必选标志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81"><span class="toc-number">4.2.2.</span> <span class="toc-text">非选项参数验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hooks-PreRun-PostRun"><span class="toc-number">4.2.3.</span> <span class="toc-text">Hooks: PreRun + PostRun</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/ai-agent.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - Overview"/></a><div class="content"><a class="title" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview">AI Agent - Overview</a><time datetime="2025-01-17T16:06:25.000Z" title="Created 2025-01-18 00:06:25">2025-01-18</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
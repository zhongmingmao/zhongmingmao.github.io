<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Go Engineering - Foundation - Error - Package | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="功能需求 支持错误堆栈 支持不同的打印格式，例如 %+v、%v、%s 等 支持 Wrap&#x2F;Unwrap 功能：在已有 error 的基础上，追加一些新的信息 errors.Wrap(err, &quot;open file failed&quot;) 调用 Wrap 时，会生成一个错误堆栈节点   支持 Is 方法：判断某个 error 是否为指定的 error Go 1.13 之前，并">
<meta property="og:type" content="article">
<meta property="og:title" content="Go Engineering - Foundation - Error - Package">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/05/01/cloud-native-foundation-go-engineering-foundation-error-package/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="功能需求 支持错误堆栈 支持不同的打印格式，例如 %+v、%v、%s 等 支持 Wrap&#x2F;Unwrap 功能：在已有 error 的基础上，追加一些新的信息 errors.Wrap(err, &quot;open file failed&quot;) 调用 Wrap 时，会生成一个错误堆栈节点   支持 Is 方法：判断某个 error 是否为指定的 error Go 1.13 之前，并">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png">
<meta property="article:published_time" content="2022-04-30T17:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.568Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Go Engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go Engineering - Foundation - Error - Package",
  "url": "https://blog.zhongmingmao.top/2022/05/01/cloud-native-foundation-go-engineering-foundation-error-package/",
  "image": "https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png",
  "datePublished": "2022-04-30T17:06:25.000Z",
  "dateModified": "2023-04-03T10:04:59.568Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/05/01/cloud-native-foundation-go-engineering-foundation-error-package/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go Engineering - Foundation - Error - Package',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Go Engineering - Foundation - Error - Package</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Go Engineering - Foundation - Error - Package</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-04-30T17:06:25.000Z" title="Created 2022-05-01 01:06:25">2022-05-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/go-engineering/">Go Engineering</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>13mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-04-03 18:04:59&quot;}" hidden></div><h1 id="功能需求"><a href="#功能需求" class="headerlink" title="功能需求"></a>功能需求</h1><ol>
<li>支持错误<strong>堆栈</strong></li>
<li>支持不同的<strong>打印格式</strong>，例如 <code>%+v</code>、<code>%v</code>、<code>%s</code> 等</li>
<li>支持 <strong>Wrap&#x2F;Unwrap</strong> 功能：在已有 error 的基础上，追加一些新的信息<ul>
<li><code>errors.Wrap(err, &quot;open file failed&quot;)</code></li>
<li>调用 <strong>Wrap</strong> 时，会生成一个<strong>错误堆栈节点</strong></li>
</ul>
</li>
<li>支持 <strong>Is</strong> 方法：判断某个 error 是否为指定的 error<ul>
<li><strong>Go 1.13</strong> 之前，并没有 <strong>wrapping error</strong><ul>
<li><code>if err == os.ErrNotExist &#123;&#125;</code></li>
</ul>
</li>
<li>有 wrapping error 后，直接用 <code>==</code> 判断会有问题，因为可能是 wrapping error<ul>
<li><strong><code>func Is(err, target error) bool</code></strong><ul>
<li>err 和 target 是<strong>同一个</strong></li>
<li>当 err 是 wrapping error 时，target <strong>包含</strong>在这个<strong>嵌套 error 链</strong>中</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>支持 <strong>As</strong> 函数<ul>
<li><strong>Go 1.13</strong> 之前，并没有 <strong>wrapping error</strong>，可以使用 <strong>type assertion</strong> 或者 <strong>type switch</strong><ul>
<li><code>if perr, ok := err.(*os.PathError); ok &#123;&#125;</code></li>
</ul>
</li>
<li>有 wrapping error 时<ul>
<li><code>var perr *os.PathError</code></li>
<li><code>if errors.As(err, &amp;perr) &#123;&#125;</code></li>
</ul>
</li>
</ul>
</li>
<li>支持两种错误<strong>创建</strong>方式<ul>
<li><code>errors.New(&quot;file not found&quot;)</code></li>
<li><code>errors.Errorf(&quot;file %s not found&quot;, &quot;iam-apiserver&quot;)</code></li>
</ul>
</li>
</ol>
<span id="more"></span>

<h1 id="使用样例"><a href="#使用样例" class="headerlink" title="使用样例"></a>使用样例</h1><blockquote>
<p>生产环境使用 <strong>JSON</strong> 格式打印日志，便于后续<strong>日志系统</strong>的解析，即 <code>%#-v</code> 或 <code>%#+v</code></p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/18a93313e017d4f3b21370099d011c5c.webp" alt="18a93313e017d4f3b21370099d011c5c"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/marmotedu/errors&quot;</span></span><br><span class="line">    code <span class="string">&quot;github.com/marmotedu/sample-code&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := bindUser(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// %s: Returns the user-safe error string mapped to the error code or the error message if none is specified.</span></span><br><span class="line">        fmt.Println(<span class="string">&quot;====================&gt; %s &lt;====================&quot;</span>)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%s\n\n&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// %v: Alias for %s.</span></span><br><span class="line">        fmt.Println(<span class="string">&quot;====================&gt; %v &lt;====================&quot;</span>)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%v\n\n&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// %-v: Output caller details, useful for troubleshooting.</span></span><br><span class="line">        fmt.Println(<span class="string">&quot;====================&gt; %-v &lt;====================&quot;</span>)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%-v\n\n&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// %+v: Output full error stack details, useful for debugging.</span></span><br><span class="line">        fmt.Println(<span class="string">&quot;====================&gt; %+v &lt;====================&quot;</span>)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%+v\n\n&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// %#-v: Output caller details, useful for troubleshooting with JSON formatted output.</span></span><br><span class="line">        fmt.Println(<span class="string">&quot;====================&gt; %#-v &lt;====================&quot;</span>)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%#-v\n\n&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// %#+v: Output full error stack details, useful for debugging with JSON formatted output.</span></span><br><span class="line">        fmt.Println(<span class="string">&quot;====================&gt; %#+v &lt;====================&quot;</span>)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%#+v\n\n&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do some business process based on the error type</span></span><br><span class="line">        <span class="keyword">if</span> errors.IsCode(err, code.ErrEncodingFailed) &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;this is a ErrEncodingFailed error&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> errors.IsCode(err, code.ErrDatabase) &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;this is a ErrDatabase error&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we can also find the cause error</span></span><br><span class="line">        fmt.Println(errors.Cause(err))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bindUser</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := getUser(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// Step3: Wrap the error with a new error message and a new error code if needed.</span></span><br><span class="line">        <span class="keyword">return</span> errors.WrapC(err, code.ErrEncodingFailed, <span class="string">&quot;encoding user &#x27;Lingfei Kong&#x27; failed.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getUser</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := queryDatabase(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// Step2: Wrap the error with a new error message.</span></span><br><span class="line">        <span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;get user failed.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryDatabase</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// Step1. Create error with specified error code.</span></span><br><span class="line">    <span class="keyword">return</span> errors.WithCode(code.ErrDatabase, <span class="string">&quot;user &#x27;Lingfei Kong&#x27; not found.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/image-20220501201732321.png" alt="image-20220501201732321"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;caller&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#2 /Users/zhongmingmao/workspace/go/src/github.com/marmotedu/errors/main/main.go:53 (main.bindUser)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">100301</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;encoding user \u0027Lingfei Kong\u0027 failed.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Encoding failed due to an error with the data&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;caller&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#1 /Users/zhongmingmao/workspace/go/src/github.com/marmotedu/errors/main/main.go:62 (main.getUser)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">100101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;get user failed.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Database error&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;caller&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#0 /Users/zhongmingmao/workspace/go/src/github.com/marmotedu/errors/main/main.go:70 (main.queryDatabase)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">100101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user \u0027Lingfei Kong\u0027 not found.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Database error&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><h2 id="withCode"><a href="#withCode" class="headerlink" title="withCode"></a>withCode</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> withCode <span class="keyword">struct</span> &#123;</span><br><span class="line">    err   <span class="type">error</span></span><br><span class="line">    code  <span class="type">int</span></span><br><span class="line">    cause <span class="type">error</span></span><br><span class="line">    *stack</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// stack represents a stack of program counters.</span></span><br><span class="line"><span class="keyword">type</span> stack []<span class="type">uintptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Error return the externally-safe error message.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *withCode)</span></span> Error() <span class="type">string</span> &#123; <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, w) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cause return the cause of the withCode error.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *withCode)</span></span> Cause() <span class="type">error</span> &#123; <span class="keyword">return</span> w.cause &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unwrap provides compatibility for Go 1.13 error chains.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *withCode)</span></span> Unwrap() <span class="type">error</span> &#123; <span class="keyword">return</span> w.cause &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Format implements fmt.Formatter. https://golang.org/pkg/fmt/#hdr-Printing</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Verbs:</span></span><br><span class="line"><span class="comment">//     %s  - Returns the user-safe error string mapped to the error code or</span></span><br><span class="line"><span class="comment">//       ┊   the error message if none is specified.</span></span><br><span class="line"><span class="comment">//     %v      Alias for %s</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Flags:</span></span><br><span class="line"><span class="comment">//      #      JSON formatted output, useful for logging</span></span><br><span class="line"><span class="comment">//      -      Output caller details, useful for troubleshooting</span></span><br><span class="line"><span class="comment">//      +      Output full error stack details, useful for debugging</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *withCode)</span></span> Format(state fmt.State, verb <span class="type">rune</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WrapC"><a href="#WrapC" class="headerlink" title="WrapC"></a>WrapC</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WrapC</span><span class="params">(err <span class="type">error</span>, code <span class="type">int</span>, format <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;withCode&#123;</span><br><span class="line">        err:   fmt.Errorf(format, args...),</span><br><span class="line">        code:  code,</span><br><span class="line">        cause: err,</span><br><span class="line">        stack: callers(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-init.png" alt="go-init"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/image-20220501204150242.png" alt="image-20220501204150242"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/image-20220501204307135.png" alt="image-20220501204307135"></p>
<blockquote>
<p><strong>Must</strong> 是一种 Go 代码设计技巧，在不满足某种情况时会 <strong>panic</strong>，建议使用</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// codes contains a map of error codes to metadata.</span></span><br><span class="line"><span class="keyword">var</span> codes = <span class="keyword">map</span>[<span class="type">int</span>]Coder&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> codeMux = &amp;sync.Mutex&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register register a user define error code.</span></span><br><span class="line"><span class="comment">// It will overrid the exist code.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">(coder Coder)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> coder.Code() == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;code `0` is reserved by `github.com/marmotedu/errors` as unknownCode error code&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    codeMux.Lock()</span><br><span class="line">    <span class="keyword">defer</span> codeMux.Unlock()</span><br><span class="line"></span><br><span class="line">    codes[coder.Code()] = coder</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MustRegister register a user define error code.</span></span><br><span class="line"><span class="comment">// It will panic when the same Code already exist.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MustRegister</span><span class="params">(coder Coder)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> coder.Code() == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;code &#x27;0&#x27; is reserved by &#x27;github.com/marmotedu/errors&#x27; as ErrUnknown error code&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    codeMux.Lock()</span><br><span class="line">    <span class="keyword">defer</span> codeMux.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, ok := codes[coder.Code()]; ok &#123;</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;code: %d already exist&quot;</span>, coder.Code()))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    codes[coder.Code()] = coder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Coder defines an interface for an error code detail information.</span></span><br><span class="line"><span class="keyword">type</span> Coder <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// HTTP status that should be used for the associated error code.</span></span><br><span class="line">    HTTPStatus() <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// External (user) facing error text.</span></span><br><span class="line">    String() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reference returns the detail documents for user.</span></span><br><span class="line">    Reference() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Code returns the code of the coder</span></span><br><span class="line">    Code() <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ErrCode implements `github.com/marmotedu/errors`.Coder interface.</span></span><br><span class="line"><span class="keyword">type</span> ErrCode <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// C refers to the code of the ErrCode.</span></span><br><span class="line">    C <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// HTTP status that should be used for the associated error code.</span></span><br><span class="line">    HTTP <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// External (user) facing error text.</span></span><br><span class="line">    Ext <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ref specify the reference document.</span></span><br><span class="line">    Ref <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Code returns the integer code of ErrCode.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(coder ErrCode)</span></span> Code() <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> coder.C</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// String implements stringer. String returns the external error message,</span></span><br><span class="line"><span class="comment">// if any.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(coder ErrCode)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> coder.Ext</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reference returns the reference document.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(coder ErrCode)</span></span> Reference() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> coder.Ref</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTPStatus returns the associated HTTP status code, if any. Otherwise,</span></span><br><span class="line"><span class="comment">// returns 200.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(coder ErrCode)</span></span> HTTPStatus() <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> coder.HTTP == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">500</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> coder.HTTP</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Is-As-Unwrap"><a href="#Is-As-Unwrap" class="headerlink" title="Is + As + Unwrap"></a>Is + As + Unwrap</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +build go1.13</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> errors</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    stderrors <span class="string">&quot;errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is reports whether any error in err&#x27;s chain matches target.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The chain consists of err itself followed by the sequence of errors obtained by</span></span><br><span class="line"><span class="comment">// repeatedly calling Unwrap.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// An error is considered to match a target if it is equal to that target or if</span></span><br><span class="line"><span class="comment">// it implements a method Is(error) bool such that Is(target) returns true.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Is</span><span class="params">(err, target <span class="type">error</span>)</span></span> <span class="type">bool</span> &#123; <span class="keyword">return</span> stderrors.Is(err, target) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// As finds the first error in err&#x27;s chain that matches target, and if so, sets</span></span><br><span class="line"><span class="comment">// target to that error value and returns true.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The chain consists of err itself followed by the sequence of errors obtained by</span></span><br><span class="line"><span class="comment">// repeatedly calling Unwrap.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// An error matches target if the error&#x27;s concrete value is assignable to the value</span></span><br><span class="line"><span class="comment">// pointed to by target, or if the error has a method As(interface&#123;&#125;) bool such that</span></span><br><span class="line"><span class="comment">// As(target) returns true. In the latter case, the As method is responsible for</span></span><br><span class="line"><span class="comment">// setting target.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// As will panic if target is not a non-nil pointer to either a type that implements</span></span><br><span class="line"><span class="comment">// error, or to any interface type. As returns false if err is nil.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">As</span><span class="params">(err <span class="type">error</span>, target <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123; <span class="keyword">return</span> stderrors.As(err, target) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unwrap returns the result of calling the Unwrap method on err, if err&#x27;s</span></span><br><span class="line"><span class="comment">// type contains an Unwrap method returning error.</span></span><br><span class="line"><span class="comment">// Otherwise, Unwrap returns nil.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Unwrap</span><span class="params">(err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> stderrors.Unwrap(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IsCode"><a href="#IsCode" class="headerlink" title="IsCode"></a>IsCode</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IsCode reports whether any error in err&#x27;s chain contains the given error code.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsCode</span><span class="params">(err <span class="type">error</span>, code <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> v, ok := err.(*withCode); ok &#123;</span><br><span class="line">        <span class="keyword">if</span> v.code == code &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> v.cause != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> IsCode(v.cause, code)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ParseCoder"><a href="#ParseCoder" class="headerlink" title="ParseCoder"></a>ParseCoder</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ParseCoder parse any error into *withCode.</span></span><br><span class="line"><span class="comment">// nil error will return nil direct.</span></span><br><span class="line"><span class="comment">// None withStack error will be parsed as ErrUnknown.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParseCoder</span><span class="params">(err <span class="type">error</span>)</span></span> Coder &#123;</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v, ok := err.(*withCode); ok &#123;</span><br><span class="line">        <span class="keyword">if</span> coder, ok := codes[v.code]; ok &#123;</span><br><span class="line">            <span class="keyword">return</span> coder</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unknownCoder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="记录错误"><a href="#记录错误" class="headerlink" title="记录错误"></a>记录错误</h1><h2 id="利用堆栈"><a href="#利用堆栈" class="headerlink" title="利用堆栈"></a>利用堆栈</h2><blockquote>
<p>使用样例如上</p>
</blockquote>
<h2 id="原始位置"><a href="#原始位置" class="headerlink" title="原始位置"></a>原始位置</h2><blockquote>
<p>仅在错误产生的<strong>最原始位置</strong>调用<strong>日志包</strong>记录函数，打印错误信息，其他位置<strong>直接返回</strong></p>
</blockquote>
<figure class="highlight go"><figcaption><span>errortrack_log.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/marmotedu/errors&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/marmotedu/log&quot;</span></span><br><span class="line"></span><br><span class="line">    code <span class="string">&quot;github.com/marmotedu/sample-code&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := getUser(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getUser</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := queryDatabase(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryDatabase</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    opts := &amp;log.Options&#123;</span><br><span class="line">        Level:            <span class="string">&quot;info&quot;</span>,</span><br><span class="line">        Format:           <span class="string">&quot;console&quot;</span>,</span><br><span class="line">        EnableColor:      <span class="literal">true</span>,</span><br><span class="line">        EnableCaller:     <span class="literal">true</span>,</span><br><span class="line">        OutputPaths:      []<span class="type">string</span>&#123;<span class="string">&quot;test.log&quot;</span>, <span class="string">&quot;stdout&quot;</span>&#125;,</span><br><span class="line">        ErrorOutputPaths: []<span class="type">string</span>&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Init(opts)</span><br><span class="line">    <span class="keyword">defer</span> log.Flush()</span><br><span class="line"></span><br><span class="line">    err := errors.WithCode(code.ErrDatabase, <span class="string">&quot;user &#x27;Lingfei Kong&#x27; not found.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Errorf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ go run errortrack_log.go </span><br><span class="line">2022-05-01 21:11:08.171 ERROR   log/errortrack_log.go:41        Database error</span><br><span class="line">Database error</span><br><span class="line"></span><br><span class="line">$ cat test.log </span><br><span class="line">2022-05-01 21:11:08.171 ERROR   log/errortrack_log.go:41        Database error</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这种情况，一般不需要再对错误进行<strong>封装</strong></p>
</blockquote>
<h1 id="错误码"><a href="#错误码" class="headerlink" title="错误码"></a>错误码</h1><h2 id="通用错误码"><a href="#通用错误码" class="headerlink" title="通用错误码"></a>通用错误码</h2><figure class="highlight go"><figcaption><span>base.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> code</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:generate codegen -type=int</span></span><br><span class="line"><span class="comment">//go:generate codegen -type=int -doc -output ./error_code_generated.md</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通用: 基本错误</span></span><br><span class="line"><span class="comment">// Code must start with 1xxxxx</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    <span class="comment">// ErrSuccess - 200: OK.</span></span><br><span class="line">    ErrSuccess <span class="type">int</span> = <span class="literal">iota</span> + <span class="number">100001</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ErrUnknown - 500: Internal server error.</span></span><br><span class="line">    ErrUnknown</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ErrBind - 400: Error occurred while binding the request body to the struct.</span></span><br><span class="line">    ErrBind</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ErrValidation - 400: Validation failed.</span></span><br><span class="line">    ErrValidation</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ErrTokenInvalid - 401: Token invalid.</span></span><br><span class="line">    ErrTokenInvalid</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>codegen 可以生成 sample_code_generated.go 和 error_code_generated.md</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make tools.install.codegen</span><br><span class="line">===========&gt; Installing codegen</span><br><span class="line"></span><br><span class="line">$ cd ../sample-code</span><br><span class="line">$ go generate</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实际开发过程中，将错误码包独立成一个包，放在 <code>internal/pkg/code/</code> 目录下，方便整个应用调用</p>
</blockquote>
<h2 id="业务错误码"><a href="#业务错误码" class="headerlink" title="业务错误码"></a>业务错误码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls internal/pkg/code   </span><br><span class="line">apiserver.go      authzserver.go    base.go           code.go           code_generated.go doc.go</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同一服务不同模块的错误码，使用不同的 <strong>const 代码块</strong>区分</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iam-apiserver: user errors.</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    <span class="comment">// ErrUserNotFound - 404: User not found.</span></span><br><span class="line">    ErrUserNotFound <span class="type">int</span> = <span class="literal">iota</span> + <span class="number">110001</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ErrUserAlreadyExist - 400: User already exist.</span></span><br><span class="line">    ErrUserAlreadyExist</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// iam-apiserver: secret errors.</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    <span class="comment">// ErrEncrypt - 400: Secret reach the max count.</span></span><br><span class="line">    ErrReachMaxCount <span class="type">int</span> = <span class="literal">iota</span> + <span class="number">110101</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ErrSecretNotFound - 404: Secret not found.</span></span><br><span class="line">    ErrSecretNotFound</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="集成使用"><a href="#集成使用" class="headerlink" title="集成使用"></a>集成使用</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Response defines project response format which in marmotedu organization.</span></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</span><br><span class="line">    Code      errors.Code <span class="string">`json:&quot;code,omitempty&quot;`</span></span><br><span class="line">    Message   <span class="type">string</span>      <span class="string">`json:&quot;message,omitempty&quot;`</span></span><br><span class="line">    Reference <span class="type">string</span>      <span class="string">`json:&quot;reference,omitempty&quot;`</span></span><br><span class="line">    Data      <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;data,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WriteResponse used to write an error and JSON data into response.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteResponse</span><span class="params">(c *gin.Context, err <span class="type">error</span>, data <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        coder := errors.ParseCoder(err)</span><br><span class="line"></span><br><span class="line">        c.JSON(coder.HTTPStatus(), Response&#123;</span><br><span class="line">            Code:      coder.Code(),</span><br><span class="line">            Message:   coder.String(),</span><br><span class="line">            Reference: coder.Reference(),</span><br><span class="line">            Data:      data,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.JSON(http.StatusOK, Response&#123;Data: data&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUser</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    log.Info(<span class="string">&quot;get user function called.&quot;</span>, <span class="string">&quot;X-Request-Id&quot;</span>, requestid.Get(c))</span><br><span class="line">    <span class="comment">// Get the user by the `username` from the database.</span></span><br><span class="line">    user, err := store.Client().Users().Get(c.Param(<span class="string">&quot;username&quot;</span>), metav1.GetOptions&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        core.WriteResponse(c, code.ErrUserNotFound.Error(), <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    core.WriteResponse(c, <span class="literal">nil</span>, user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/05/01/cloud-native-foundation-go-engineering-foundation-error-package/">https://blog.zhongmingmao.top/2022/05/01/cloud-native-foundation-go-engineering-foundation-error-package/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/go/">Go</a><a class="post-meta__tags" href="/tags/go-engineering/">Go Engineering</a></div><div class="post-share"><div class="social-share" data-image="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/05/01/cloud-native-foundation-go-engineering-foundation-log-design/" title="Go Engineering - Foundation - Log - Design"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-12.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Go Engineering - Foundation - Log - Design</div></div><div class="info-2"><div class="info-item-1">功能需求基础功能 支持基本的日志信息：时间戳、文件名、行号、日志级别、日志内容 支持不同的日志级别：Trace（可选）、Debug、Info、Warn、Error、Panic（可选）、Fatal 期望级别：glog.Info(&quot;This is info message&quot;) 开关级别：glog -v=4，只有日志级别高于等于 4 的日志才会被打印   支持自定义配置：不同的运行环境，需要不同的日志输出配置，在不重新编译代码的情况下，改变记录日志的行为 支持输出到标准输出（实时读取）和本地文件（采集索引）     高级功能 支持多种日志格式：TEXT、JSON 按日志级别分类输出：至少 Error 级别的日志输出到独立的文件中 支持结构化日志：使用 JSON 或者其它编码方式使日志结构化 支持日志轮转：借助 Linux Logrotate 来完成，不在日志包中实现 具备 Hook 能力 例如：当 Error 级别的日志产生时，发送邮件或者调用告警接口进行告警 日志告警的最佳方案：通过旁路功能，将日志采集到第三方组件（如 ES），日志包功能应尽量内聚    1234567891011121...</div></div></div></a><a class="pagination-related" href="/2022/05/01/cloud-native-foundation-go-engineering-foundation-error-code/" title="Go Engineering - Foundation - Error - Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-13.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Go Engineering - Foundation - Error - Code</div></div><div class="info-2"><div class="info-item-1">设计方式 场景：用户账号没有找到  200 HTTP Code 通常代表的是 HTTP Transport 层的状态信息；但对性能有一定的影响，因为需要解析 HTTP Body  12345678&#123;  &quot;error&quot;: &#123;    &quot;message&quot;: &quot;Syntax error \&quot;Field picture specified more than once. This is only possible before version 2.1\&quot; at character 23: id,name,picture,picture&quot;,    &quot;type&quot;: &quot;OAuthException&quot;,    &quot;code&quot;: 2500,    &quot;fbtrace_id&quot;: &quot;xxxxxxxxxxx&quot;  &#125;&#125;    4xx + 简单信息 可以让客户端快速感知请求失败，但提供的信息过于简单，不能准确地定位问题 ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="info-item-2">Go Engineering - CLI</div></div><div class="info-2"><div class="info-item-1">应用框架 命令行参数解析 - Pflag 配置文件解析 - Viper 应用的命令行框架 - Cobra 命令需要具备 help 功能 命令需要能够解析命令行参数和配置文件 命令需要能够初始化业务代码，并最终启动业务进程      Pflag 命令行参数解析工具 - Kubernetes &#x2F; Istio &#x2F; Helm &#x2F; Docker &#x2F; Etcd &#x2F; …  Flag 一个命令行参数会被解析成一个 Flag 类型的变量  1234567891011121314// A Flag represents the state of a flag.type Flag struct &#123;    Name                string              // name as it appears on command line    Shorthand           string              // one-letter abbreviated flag    Usage               string   ...</div></div></div></a><a class="pagination-related" href="/2023/05/09/cloud-native-foundation-go-engineering-log/" title="Go Engineering - Log"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-log.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="info-item-2">Go Engineering - Log</div></div><div class="info-2"><div class="info-item-1">功能设计基础功能 支持基本的日志信息 - 时间戳、文件名、行号、日志级别、日志信息 支持不同的日志级别 - Debug &#x2F; Info &#x2F; Warn &#x2F; Error &#x2F; Panic &#x2F; Fatal logrus 支持 Trace 日志级别，Trace 不是必须的 Trace 和 Panic 是可选的级别   支持自定义配置 - 不同的环境采用不同的配置 开发环境的日志级别为 Debug，而生产环境的日志级别为 Info 通过配置，可以在不重新编译代码的情况下，改变记录日志的行为   支持输出到标准输出和文件     至少实现 6 个日志级别    日志调用时的属性   输出级别 glog.Info(“This is info message”)   开关级别 启动程序时，期望哪些输出级别的日志会被打印 glog -v=L - 只有输出级别 ≥L 的日志才会被打印     高级功能 支持多种日志格式 - TEXT &#x2F; JSON &#x2F; … 开发环境采用 TEXT 格式，生产环境采用 JSON 格式   按日志级别分类输出 - Error 级别...</div></div></div></a><a class="pagination-related" href="/2023/05/08/cloud-native-foundation-go-engineering-err-code/" title="Go Engineering - Error Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-error-handling.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="info-item-2">Go Engineering - Error Code</div></div><div class="info-2"><div class="info-item-1">预期功能 有业务 Code 码标识 - HTTP Code 码有限 安全 - 对内对外展示不同的错误信息    设计方式 无论请求成功与否，都返回 200，在 HTTP Body 中包含错误信息 HTTP Code 通常代表 HTTP Transport 层的状态信息 缺点：性能不佳（需解析 Body） + 对客户端不友好   返回 4xx or 5xx，并在 Body 中返回简单的错误信息 返回 4xx or 5xx，并在 Body 中返回详细的错误信息 - 推荐  设计思路 区别于 http status code，业务码需要有一定的规则，可以通过业务码判断出是哪类错误 请求出错时，可以通过 http status code，直接感知到请求出错 需要在请求出错时，返回详细的信息：Code + Message + Reference（Optional） 返回的错误信息，需要是可以直接展示给用户的安全信息，不能包含敏感信息 但同时也要有内部更详细的错误信息，方便 Debug   返回的数据格式应该是固定的，规范的 错误信息要保持简洁，并提供有用的信息  Biz Code 纯数字表示，不同部位代表不同的服...</div></div></div></a><a class="pagination-related" href="/2023/05/07/cloud-native-foundation-go-engineering-doc/" title="Go Engineering - Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-doc.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="info-item-2">Go Engineering - Doc</div></div><div class="info-2"><div class="info-item-1">Swagger Swagger 是一套围绕 OpenAPI 规范构建的开源工具     Component Desc    Swagger Editor 基于浏览器的编辑器，可以编写 OpenAPI 规范，并实时预览   Swagger UI 将 OpenAPI 规范呈现为交互式 API 文档   Swagger Codegen 根据 OpenAPI 规范，生成服务器存根和客户端代码库，涵盖 40 多种语言     OpenAPI OpenAPI 是一个 API 规范，其前身为 Swagger 规范 通过定义一种用来描述 API 格式或者 API 定义的 DSL，来规范 RESTful API 的开发过程 OpenAPI 3.0 ≈ Swagger 2.0   API 基本信息 对 API 的描述，介绍 API 可以实现的功能 每个 API 上可用的 Path 和 Method 每个 API 的输入和返回参数 验证方法 联系信息、许可证、使用条款和其它信息   OpenAPI 是一个 API 规范，而 Swagger 是实现该 API 规范的工具  go-swagger特性 功能强大、高性能、可以根据代...</div></div></div></a><a class="pagination-related" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-lint.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="info-item-2">Go Engineering - Lint</div></div><div class="info-2"><div class="info-item-1">golangci-lint 使用最多    优点   Advantage Desc    速度快 基于 gometalinter 开发，但比 gometalinter 快 5 倍原因：并行检查 + 复用 go build 缓存 + 缓存分析结果   可配置 支持 YAML 格式的配置文件   IDE 集成 Goland &#x2F; VS Code   linter 聚合器 不需要单独安装   最少误报数 调整了所集成 linter 的默认配置，大幅度减少误报   良好的输出 颜色、行号等   迭代快 不断有新的 linter 被集成到 golangci-lint 中   选项 配置 同时出现 - 命令行选项 &#x2F; 配置文件   bool&#x2F;string&#x2F;int - 命令行选项 slice - 合并  命令行选项 golangci-lint run -h     Flag Desc    –print-issued-lines Print lines of code with issue (default true)   –print-linter-name Print lin...</div></div></div></a><a class="pagination-related" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-makefile.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="info-item-2">Go Engineering - Makefile</div></div><div class="info-2"><div class="info-item-1">基础语法 https://github.com/seisman/how-to-write-makefile   规则语法 伪目标 变量赋值 特殊变量 自动化变量  功能设计Target   Target Desc    gen Generate all necessary files, such as error code files.   format Gofmt (reformat) package sources (exclude vendor dir if existed).   lint Check syntax and styling of go sources.   test Run unit test.   cover Run unit test and get test coverage.   build Build source code for host platform.   build.multiarch Build source code for multiple platforms. See option PLATFORMS.   image Build docker im...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">功能需求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A0%B7%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text">使用样例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#withCode"><span class="toc-number">3.1.</span> <span class="toc-text">withCode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WrapC"><span class="toc-number">3.2.</span> <span class="toc-text">WrapC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init"><span class="toc-number">3.3.</span> <span class="toc-text">init</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Is-As-Unwrap"><span class="toc-number">3.4.</span> <span class="toc-text">Is + As + Unwrap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IsCode"><span class="toc-number">3.5.</span> <span class="toc-text">IsCode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ParseCoder"><span class="toc-number">3.6.</span> <span class="toc-text">ParseCoder</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E9%94%99%E8%AF%AF"><span class="toc-number">4.</span> <span class="toc-text">记录错误</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%A0%86%E6%A0%88"><span class="toc-number">4.1.</span> <span class="toc-text">利用堆栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E4%BD%8D%E7%BD%AE"><span class="toc-number">4.2.</span> <span class="toc-text">原始位置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">错误码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-number">5.1.</span> <span class="toc-text">通用错误码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-number">5.2.</span> <span class="toc-text">业务错误码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E4%BD%BF%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">集成使用</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Server V1"/></a><div class="content"><a class="title" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1">Observability - Prometheus Server V1</a><time datetime="2025-01-23T16:06:25.000Z" title="Created 2025-01-24 00:06:25">2025-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - Architectural principles | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="主要功能">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Architectural principles">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/01/cloud-native-foundation-k8s-architectural-principles/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="主要功能">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/BLOG-Kubernets-1024x536.png">
<meta property="article:published_time" content="2022-11-30T16:06:25.000Z">
<meta property="article:modified_time" content="2023-06-04T10:17:29.636Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Cloud Native Foundation">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/BLOG-Kubernets-1024x536.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/01/cloud-native-foundation-k8s-architectural-principles/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - Architectural principles',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-04 18:17:29'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">482</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">125</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">65</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/BLOG-Kubernets-1024x536.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - Architectural principles</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-11-30T16:06:25.000Z" title="Created 2022-12-01 00:06:25">2022-12-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">9.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>46min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230527222605582.png" alt="image-20230527222605582"></p>
<span id="more"></span>

<ol>
<li>基于<code>容器</code>的应用部署、维护和滚动升级</li>
<li><code>服务发现</code>和<code>负载均衡</code></li>
<li><code>跨机器</code>和<code>跨地区</code>的集群调度</li>
<li><code>自动伸缩</code></li>
<li><code>无状态</code>服务和<code>有状态</code>服务</li>
<li><code>插件机制</code>保证扩展性</li>
</ol>
<h1 id="命令式-vs-声明式"><a href="#命令式-vs-声明式" class="headerlink" title="命令式 vs 声明式"></a>命令式 vs 声明式</h1><blockquote>
<p>YAML</p>
</blockquote>
<ol>
<li><code>命令式</code>关注：<code>如何做</code></li>
<li><code>声明式</code>关注：<code>做什么</code></li>
</ol>
<h1 id="核心对象"><a href="#核心对象" class="headerlink" title="核心对象"></a>核心对象</h1><blockquote>
<p>Kubernetes 的所有管理能力是构建在<code>对象抽象</code>的基础上</p>
</blockquote>
<table>
<thead>
<tr>
<th>对象</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>Node</code></td>
<td><code>计算节点</code>的抽象</td>
</tr>
<tr>
<td><code>Namespace</code></td>
<td><code>资源隔离</code>的基本单位</td>
</tr>
<tr>
<td><code>Pod</code></td>
<td>用来描述<code>应用实例</code>，最为<code>核心</code>的对象</td>
</tr>
<tr>
<td><code>Service</code></td>
<td>如何将应用发布为<code>服务</code>，本质上是<code>负载均衡</code>和<code>域名服务</code>的<code>声明</code></td>
</tr>
</tbody></table>
<h1 id="核心架构"><a href="#核心架构" class="headerlink" title="核心架构"></a>核心架构</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230527235207609.png" alt="image-20230527235207609"></p>
<h1 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h1><blockquote>
<p><code>Scheduler</code>关注<code>没有与 Node 绑定的 Pod</code>，完成调度后，会将信息写入 <code>etcd</code>，而 <code>kubelet</code> 会<code>监听</code>到</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230528001919213.png" alt="image-20230528001919213"></p>
<h2 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h2><table>
<thead>
<tr>
<th>组件</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>API Server</code></td>
<td>API 网关</td>
</tr>
<tr>
<td><code>Cluster Data Store</code></td>
<td><code>etcd</code>：<code>分布式 kv 存储</code>，K8S 将<code>所有 API 对象</code>持久存储在 <code>etcd</code></td>
</tr>
<tr>
<td><code>Controller Manager</code></td>
<td>处理集群日常任务的控制器：节点控制器、副本控制器等</td>
</tr>
<tr>
<td><code>Scheduler</code></td>
<td>监控<code>新建的 Pods</code> 并将其分配给 Node</td>
</tr>
</tbody></table>
<h2 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h2><table>
<thead>
<tr>
<th>组件</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>Kubelet</code></td>
<td>负责被调度该 Node 上的 <code>Pod</code> 的<code>生命周期管理</code>，执行任务并将 Pod 的状态<code>上报</code>给 Master<br />通过<code>容器运行时</code>来运行容器<br /><code>定期</code>对容器进行<code>健康探测</code></td>
</tr>
<tr>
<td><code>Kube-proxy</code></td>
<td>负责<code>节点网络</code>：在主机上维护网络规则并执行连接转发<br />负责对正在服务的 Pods 进行<code>负载均衡</code>  - Service</td>
</tr>
</tbody></table>
<h2 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h2><blockquote>
<p>etcd 是 <code>CoreOS</code> 基于 <code>Raft</code> 开发的<code>分布式 kv 存储</code>，可用于<code>服务发现</code>、<code>共享配置</code>以及<code>一致性保障</code></p>
</blockquote>
<ol>
<li>基本的 kv 存储</li>
<li><code>监听</code>机制 - <code>watch</code></li>
<li>key 的<code>过期</code>以及<code>续约</code>机制：用于<code>监控</code>和<code>服务发现</code></li>
<li>原子 <code>CAS</code> 和 <code>CAD</code>：用于<code>分布式锁</code>和 <code>Leader 选举</code></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230528021712591.png" alt="image-20230528021712591"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ k -n kube-system get po</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7f6cbbb7b8-2jx7p      1/1     Running   0          7h21m</span><br><span class="line">coredns-7f6cbbb7b8-b59cb      1/1     Running   0          7h21m</span><br><span class="line">etcd-k8s                      1/1     Running   0          7h21m</span><br><span class="line">kube-apiserver-k8s            1/1     Running   0          7h21m</span><br><span class="line">kube-controller-manager-k8s   1/1     Running   0          7h21m</span><br><span class="line">kube-proxy-t5v9f              1/1     Running   0          7h21m</span><br><span class="line">kube-scheduler-k8s            1/1     Running   0          7h21m</span><br><span class="line"></span><br><span class="line">$ export ETCDCTL_API=3</span><br><span class="line"></span><br><span class="line">$ sudo etcdctl --endpoints https://localhost:2379 --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key --cacert /etc/kubernetes/pki/etcd/ca.crt get --keys-only --prefix /</span><br><span class="line">/registry/apiextensions.k8s.io/customresourcedefinitions/apiservers.operator.tigera.io</span><br><span class="line">/registry/apiextensions.k8s.io/customresourcedefinitions/bgpconfigurations.crd.projectcalico.org</span><br><span class="line">...</span><br><span class="line">/registry/pods/default/nginx</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ sudo etcdctl --endpoints https://localhost:2379 --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key --cacert /etc/kubernetes/pki/etcd/ca.crt watch --prefix /registry/pods/default/nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k edit pods nginx</span><br><span class="line">...</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    my.app: nginx</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前一个窗口会得到一个<code>事件通知</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230529223051970.png" alt="image-20230529223051970"></p>
<blockquote>
<p>API Server 是<code>唯一</code>与 etcd 通信的组件，<code>API Server 本身也提供 Watch 机制</code>，供 Kubelet 等其它组件使用</p>
</blockquote>
<h2 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h2><blockquote>
<p>API Server 是 Kubernetes 中<code>最为核心</code>的组件之一</p>
</blockquote>
<ol>
<li>提供<code>集群管理</code>的 <code>REST API</code> 接口：<code>认证</code>、<code>授权</code>、<code>准入</code></li>
<li>提供其他模块之间的数据交互和通信的<code>枢纽</code><ul>
<li><code>只有 API Server 才能直接操作 ectd</code>：其他模块通过 API Server 查询或修改数据</li>
</ul>
</li>
<li>API Server 提供 etcd 的<code>数据缓存</code>（减少集群对 etcd 的访问）</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230529223604468.png" alt="image-20230529223604468"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230529224212775.png" alt="image-20230529224212775"></p>
<h2 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h2><ol>
<li>Controller Manager 是集群的<code>大脑</code></li>
<li><code>声明式</code>：确保系统的<code>真实状态</code>与用户定义的<code>期望状态</code>一致</li>
<li>Controller Manager 是<code>多个 Controller 的组合</code><ul>
<li>Controller 本质上是一个 <code>control loop</code>，负责<code>监听</code>其管控的对象，当对象发生变更时完成配置</li>
</ul>
</li>
<li><code>自动重试</code> + <code>最终一致性</code><ul>
<li>Controller 配置失败会触发自动重试，整个集群会在 Controller 不断重试的机制下确保最终一致性</li>
</ul>
</li>
</ol>
<blockquote>
<p>基于 <code>watch</code> 机制<br>收到通知后，<code>生产者</code>将事件放入队列，<code>消费者</code>消费队列，如果处理失败，需要<code>重新放回</code>队列，进行重试</p>
</blockquote>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><blockquote>
<p><code>生产者消费者模型</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230529225117328.png" alt="image-20230529225117328"></p>
<h3 id="Informer"><a href="#Informer" class="headerlink" title="Informer"></a>Informer</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230529225928598.png" alt="image-20230529225928598"></p>
<ol>
<li>定义任意的 <code>K8S 对象</code>，都只需要定义其<code>数据结构</code>，然后在 <code>API Server</code> 发布<ul>
<li>所有的对象访问都需要经过 <code>API Server</code></li>
</ul>
</li>
<li>API Server 提供 <code>List &amp; Watch</code> 机制<ul>
<li>Informer 在<code>启动</code>时，发起一个<code>长连接</code>到 API Server，然后 <code>List &amp; Watch</code> 自身关注的对象</li>
</ul>
</li>
<li>API Server 提供的是 <code>REST API</code>，返回给 Informer 的是 <code>String</code> 或者 <code>Protobuf</code> 的<code>序列化</code>数据<ul>
<li>需要借助 <code>Reflector</code> 通过<code>反射</code>进行<code>反序列化</code>成 <code>Go 对象</code></li>
</ul>
</li>
<li><code>Delta FIFO Queue</code> 是一个 <code>Ring Buffer</code><ul>
<li>Informer 会从 Delta FIFO Queue 取出对象，然后放入 <code>Thread Safe Store</code></li>
<li>并且将对象的<code>变化事件</code>分配给对应的 Handler<ul>
<li>Handler 再借助 <code>Indexer</code> 去 <code>Thread Safe Store</code> 获取上一步存储的对象 - 减少 API Server 的<code>访问压力</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>任何的 <code>Controller</code> 都应该使用 <code>SharedInformer Framework</code><br>所有的 API 对象会有一份<code>本地缓存</code>（Thread Safe Store），降低 API Server 的压力</p>
</blockquote>
<blockquote>
<p>由 <code>SharedInformer Framework</code> 来保证 <code>Thread Safe Store</code> 与 <code>API Server</code> 的<code>数据一致性</code></p>
</blockquote>
<blockquote>
<p>Controller 避免<code>频繁访问</code> API Server（应从 Thread Safe Store 读取），只有<code>更新对象</code>时，才需要与 API Server 有交互</p>
</blockquote>
<h3 id="各司其职"><a href="#各司其职" class="headerlink" title="各司其职"></a>各司其职</h3><blockquote>
<p>所有 Controller 只与 API Server 通信<br>API Server 负责与 <code>etcd</code> 通信，所有 Controller 也会基于 API Server 的 <code>List &amp; Watch</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230601225457858.png" alt="image-20230601225457858"></p>
<blockquote>
<p>YAML</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Controller Manager</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ k get po -n kube-system -owide -l component=kube-controller-manager,tier=control-plane</span><br><span class="line"></span><br><span class="line">NAME                              READY   STATUS    RESTARTS       AGE    IP                NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-controller-manager-mac-k8s   1/1     Running   3 (4d5h ago)   4d5h   192.168.191.138   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k logs kube-controller-manager-mac-k8s -n kube-system | grep nginx</span><br><span class="line">I0530 02:17:02.860036       1 event.go:291] &quot;Event occurred&quot; object=&quot;default/nginx-deployment&quot; kind=&quot;Deployment&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Normal&quot; reason=&quot;ScalingReplicaSet&quot; message=&quot;Scaled up replica set nginx-deployment-6799fc88d8 to 1&quot;</span><br><span class="line">I0530 02:17:02.866669       1 event.go:291] &quot;Event occurred&quot; object=&quot;default/nginx-deployment-6799fc88d8&quot; kind=&quot;ReplicaSet&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Normal&quot; reason=&quot;SuccessfulCreate&quot; message=&quot;Created pod: nginx-deployment-6799fc88d8-j5rnt&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Deployment</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ k get deployments.apps -owide</span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">nginx-deployment   1/1     1            1           3m33s   nginx        nginx    app=nginx</span><br><span class="line"></span><br><span class="line">$ k describe deployments.apps nginx-deployment</span><br><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Tue, 30 May 2022 02:17:02 +0000</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-6799fc88d8 (1/1 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age    From                   Message</span><br><span class="line">  ----    ------             ----   ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  6m55s  deployment-controller  Scaled up replica set nginx-deployment-6799fc88d8 to 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ReplicaSet</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">$ k describe replicasets.apps nginx-deployment-6799fc88d8</span><br><span class="line">Name:           nginx-deployment-6799fc88d8</span><br><span class="line">Namespace:      default</span><br><span class="line">Selector:       app=nginx,pod-template-hash=6799fc88d8</span><br><span class="line">Labels:         app=nginx</span><br><span class="line">                pod-template-hash=6799fc88d8</span><br><span class="line">Annotations:    deployment.kubernetes.io/desired-replicas: 1</span><br><span class="line">                deployment.kubernetes.io/max-replicas: 2</span><br><span class="line">                deployment.kubernetes.io/revision: 1</span><br><span class="line">Controlled By:  Deployment/nginx-deployment</span><br><span class="line">Replicas:       1 current / 1 desired</span><br><span class="line">Pods Status:    1 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">           pod-template-hash=6799fc88d8</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason            Age   From                   Message</span><br><span class="line">  ----    ------            ----  ----                   -------</span><br><span class="line">  Normal  SuccessfulCreate  12m   replicaset-controller  Created pod: nginx-deployment-6799fc88d8-j5rnt</span><br><span class="line"></span><br><span class="line">$ k get replicasets.apps nginx-deployment-6799fc88d8 -oyaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/desired-replicas: &quot;1&quot;</span><br><span class="line">    deployment.kubernetes.io/max-replicas: &quot;2&quot;</span><br><span class="line">    deployment.kubernetes.io/revision: &quot;1&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T02:17:02Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">    pod-template-hash: 6799fc88d8</span><br><span class="line">  name: nginx-deployment-6799fc88d8</span><br><span class="line">  namespace: default</span><br><span class="line">  ownerReferences:</span><br><span class="line">  - apiVersion: apps/v1</span><br><span class="line">    blockOwnerDeletion: true</span><br><span class="line">    controller: true</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx-deployment</span><br><span class="line">    uid: eaafeaa4-02cb-441b-a8ae-59e2d16f0e45</span><br><span class="line">  resourceVersion: &quot;3710&quot;</span><br><span class="line">  uid: 591b0bf5-f1a0-4343-9624-b5706d1e7243</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">      pod-template-hash: 6799fc88d8</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">        pod-template-hash: 6799fc88d8</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: nginx</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">      securityContext: &#123;&#125;</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">status:</span><br><span class="line">  availableReplicas: 1</span><br><span class="line">  fullyLabeledReplicas: 1</span><br><span class="line">  observedGeneration: 1</span><br><span class="line">  readyReplicas: 1</span><br><span class="line">  replicas: 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Pod<br>nodeName 一开始为<code>空</code>，调度器会监听到，然后通过<code>调度策略</code>调度到某个 <code>Node</code><br>该 Node 上的 kubelet 也会监听到调度到自己的 Pod</p>
</blockquote>
<blockquote>
<p>kubelet 会尝试去构建 Pod，由于 Docker 的 <code>Network Manager</code> 比较厚重，K8S 一般是使用 <code>CNI</code></p>
</blockquote>
<blockquote>
<p>K8S 在启动容器的时候，<code>只会启动 Runtime</code>，网络配置则通过 <code>CNI</code> 去调用<code>网络插件</code> 来处理</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">$ k get po nginx-deployment-6799fc88d8-j5rnt -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    cni.projectcalico.org/containerID: d2c650e2c20df38a6fce8d56e62a94155469b91cfa5aee741b08a62238d122d4</span><br><span class="line">    cni.projectcalico.org/podIP: 192.168.185.8/32</span><br><span class="line">    cni.projectcalico.org/podIPs: 192.168.185.8/32</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T02:17:02Z&quot;</span><br><span class="line">  generateName: nginx-deployment-6799fc88d8-</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">    pod-template-hash: 6799fc88d8</span><br><span class="line">  name: nginx-deployment-6799fc88d8-j5rnt</span><br><span class="line">  namespace: default</span><br><span class="line">  ownerReferences:</span><br><span class="line">  - apiVersion: apps/v1</span><br><span class="line">    blockOwnerDeletion: true</span><br><span class="line">    controller: true</span><br><span class="line">    kind: ReplicaSet</span><br><span class="line">    name: nginx-deployment-6799fc88d8</span><br><span class="line">    uid: 591b0bf5-f1a0-4343-9624-b5706d1e7243</span><br><span class="line">  resourceVersion: &quot;3709&quot;</span><br><span class="line">  uid: 84f898e7-8899-46c1-9028-9799fa1bd77c</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    name: nginx</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">    terminationMessagePath: /dev/termination-log</span><br><span class="line">    terminationMessagePolicy: File</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">      name: kube-api-access-l2vp5</span><br><span class="line">      readOnly: true</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">  enableServiceLinks: true</span><br><span class="line">  nodeName: mac-k8s</span><br><span class="line">  preemptionPolicy: PreemptLowerPriority</span><br><span class="line">  priority: 0</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">  schedulerName: default-scheduler</span><br><span class="line">  securityContext: &#123;&#125;</span><br><span class="line">  serviceAccount: default</span><br><span class="line">  serviceAccountName: default</span><br><span class="line">  terminationGracePeriodSeconds: 30</span><br><span class="line">  tolerations:</span><br><span class="line">  - effect: NoExecute</span><br><span class="line">    key: node.kubernetes.io/not-ready</span><br><span class="line">    operator: Exists</span><br><span class="line">    tolerationSeconds: 300</span><br><span class="line">  - effect: NoExecute</span><br><span class="line">    key: node.kubernetes.io/unreachable</span><br><span class="line">    operator: Exists</span><br><span class="line">    tolerationSeconds: 300</span><br><span class="line">  volumes:</span><br><span class="line">  - name: kube-api-access-l2vp5</span><br><span class="line">    projected:</span><br><span class="line">      defaultMode: 420</span><br><span class="line">      sources:</span><br><span class="line">      - serviceAccountToken:</span><br><span class="line">          expirationSeconds: 3607</span><br><span class="line">          path: token</span><br><span class="line">      - configMap:</span><br><span class="line">          items:</span><br><span class="line">          - key: ca.crt</span><br><span class="line">            path: ca.crt</span><br><span class="line">          name: kube-root-ca.crt</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">            path: namespace</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastProbeTime: null</span><br><span class="line">    lastTransitionTime: &quot;2022-05-30T02:17:02Z&quot;</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: Initialized</span><br><span class="line">  - lastProbeTime: null</span><br><span class="line">    lastTransitionTime: &quot;2022-05-30T02:17:26Z&quot;</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: Ready</span><br><span class="line">  - lastProbeTime: null</span><br><span class="line">    lastTransitionTime: &quot;2022-05-30T02:17:26Z&quot;</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: ContainersReady</span><br><span class="line">  - lastProbeTime: null</span><br><span class="line">    lastTransitionTime: &quot;2022-05-30T02:17:02Z&quot;</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: PodScheduled</span><br><span class="line">  containerStatuses:</span><br><span class="line">  - containerID: docker://57bac5f87cf75da4f2143868399bc030d1a036e19818c9d8958bb3e0d1b5a904</span><br><span class="line">    image: nginx:latest</span><br><span class="line">    imageID: docker-pullable://nginx@sha256:af296b188c7b7df99ba960ca614439c99cb7cf252ed7bbc23e90cfda59092305</span><br><span class="line">    lastState: &#123;&#125;</span><br><span class="line">    name: nginx</span><br><span class="line">    ready: true</span><br><span class="line">    restartCount: 0</span><br><span class="line">    started: true</span><br><span class="line">    state:</span><br><span class="line">      running:</span><br><span class="line">        startedAt: &quot;2022-05-30T02:17:26Z&quot;</span><br><span class="line">  hostIP: 192.168.191.138</span><br><span class="line">  phase: Running</span><br><span class="line">  podIP: 192.168.185.8</span><br><span class="line">  podIPs:</span><br><span class="line">  - ip: 192.168.185.8</span><br><span class="line">  qosClass: BestEffort</span><br><span class="line">  startTime: &quot;2022-05-30T02:17:02Z&quot;</span><br><span class="line"></span><br><span class="line">$ curl -sI 192.168.185.8</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.0</span><br><span class="line">Date: Tue, 30 May 2022 02:34:39 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 23 May 2022 15:08:20 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;646cd6e4-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>手动删除 Pod</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k delete pod nginx-deployment-6799fc88d8-j5rnt</span><br><span class="line">pod &quot;nginx-deployment-6799fc88d8-j5rnt&quot; deleted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ k get pods -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-6799fc88d8-4ppnm   1/1     Running   0          25s   192.168.185.9   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加副本数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ k describe deployments.apps nginx-deployment</span><br><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Tue, 30 May 2022 02:15:32 +0000</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-6799fc88d8 (3/3 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age   From                   Message</span><br><span class="line">  ----    ------             ----  ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  6m5s  deployment-controller  Scaled up replica set nginx-deployment-6799fc88d8 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  100s  deployment-controller  Scaled up replica set nginx-deployment-6799fc88d8 to 3</span><br><span class="line"></span><br><span class="line">$ k describe rs nginx-deployment-6799fc88d8</span><br><span class="line">Name:           nginx-deployment-6799fc88d8</span><br><span class="line">Namespace:      default</span><br><span class="line">Selector:       app=nginx,pod-template-hash=6799fc88d8</span><br><span class="line">Labels:         app=nginx</span><br><span class="line">                pod-template-hash=6799fc88d8</span><br><span class="line">Annotations:    deployment.kubernetes.io/desired-replicas: 3</span><br><span class="line">                deployment.kubernetes.io/max-replicas: 4</span><br><span class="line">                deployment.kubernetes.io/revision: 1</span><br><span class="line">Controlled By:  Deployment/nginx-deployment</span><br><span class="line">Replicas:       3 current / 3 desired</span><br><span class="line">Pods Status:    3 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">           pod-template-hash=6799fc88d8</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason            Age    From                   Message</span><br><span class="line">  ----    ------            ----   ----                   -------</span><br><span class="line">  Normal  SuccessfulCreate  10m    replicaset-controller  Created pod: nginx-deployment-6799fc88d8-j5rnt</span><br><span class="line">  Normal  SuccessfulCreate  9m5s   replicaset-controller  Created pod: nginx-deployment-6799fc88d8-4ppnm</span><br><span class="line">  Normal  SuccessfulCreate  5m35s  replicaset-controller  Created pod: nginx-deployment-6799fc88d8-ltc2g</span><br><span class="line">  Normal  SuccessfulCreate  5m35s  replicaset-controller  Created pod: nginx-deployment-6799fc88d8-rt8w2</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-6799fc88d8-4ppnm   1/1     Running   0          6m27s   192.168.185.9    mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-6799fc88d8-ltc2g   1/1     Running   0          2m57s   192.168.185.11   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-6799fc88d8-rt8w2   1/1     Running   0          2m57s   192.168.185.10   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Service：<code>负载均衡</code> + <code>高可用</code>，基于 <code>TCP</code>，没有流量的<code>精细控制</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ k get po --show-labels</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">nginx-deployment-6799fc88d8-4ppnm   1/1     Running   0          14m   app=nginx,pod-template-hash=6799fc88d8</span><br><span class="line">nginx-deployment-6799fc88d8-ltc2g   1/1     Running   0          10m   app=nginx,pod-template-hash=6799fc88d8</span><br><span class="line">nginx-deployment-6799fc88d8-rt8w2   1/1     Running   0          10m   app=nginx,pod-template-hash=6799fc88d8</span><br><span class="line"></span><br><span class="line">$ k expose deployment nginx-deployment --selector app=nginx --port=80 --type=NodePort</span><br><span class="line">service/nginx-deployment exposed</span><br><span class="line"></span><br><span class="line">$ k get svc</span><br><span class="line">NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes         ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        40m</span><br><span class="line">nginx-deployment   NodePort    10.105.14.129   &lt;none&gt;        80:31834/TCP   29s</span><br><span class="line"></span><br><span class="line">$ curl -sI 10.105.14.129</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.0</span><br><span class="line">Date: Tue, 30 May 2022 02:30:01 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 23 May 2022 15:08:20 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;646cd6e4-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">$ k delete pod nginx-deployment-6799fc88d8-4ppnm</span><br><span class="line">pod &quot;nginx-deployment-6799fc88d8-4ppnm&quot; deleted</span><br><span class="line"></span><br><span class="line">$ curl -sI 10.105.14.129</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.0</span><br><span class="line">Date: Tue, 30 May 2022 02:32:28 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 23 May 2022 15:08:20 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;646cd6e4-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">$ curl -sI mac-k8s:31834</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.0</span><br><span class="line">Date: Tue, 30 May 2022 02:33:27 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 23 May 2022 15:08:20 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;646cd6e4-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>滚动更新，<code>maxSurge</code>：先创建新版本的最大比例，<code>maxUnavailable</code>：不可用的最大比例</p>
</blockquote>
<blockquote>
<p>滚动机制：计算 Template 的<code>字符串的散列值</code><br>如 <code>nginx</code> -&gt; <code>nginx:latest</code>，本质上为同一个镜像，但散列值不一样，因此<code>散列算法</code>要<code>前向兼容</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">$ k edit deployments.apps nginx-deployment</span><br><span class="line">deployment.apps/nginx-deployment edited</span><br><span class="line"></span><br><span class="line">$ k get pods -owide</span><br><span class="line">NAME                                READY   STATUS              RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-55649fd747-csj2k   0/1     ContainerCreating   0          1s      &lt;none&gt;           mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-55649fd747-mtpm6   1/1     Running             0          25s     192.168.185.13   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-6799fc88d8-k9hl4   1/1     Terminating         0          8m55s   192.168.185.12   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-6799fc88d8-ltc2g   1/1     Running             0          21m     192.168.185.11   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-6799fc88d8-rt8w2   1/1     Running             0          21m     192.168.185.10   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get rs</span><br><span class="line">NAME                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-55649fd747   3         3         3       117s</span><br><span class="line">nginx-deployment-6799fc88d8   0         0         0       27m</span><br><span class="line"></span><br><span class="line">$ k describe deployments.apps nginx-deployment</span><br><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Tue, 30 May 2022 02:15:32 +0000</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 2</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:latest</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-55649fd747 (3/3 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age    From                   Message</span><br><span class="line">  ----    ------             ----   ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  27m    deployment-controller  Scaled up replica set nginx-deployment-6799fc88d8 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  23m    deployment-controller  Scaled up replica set nginx-deployment-6799fc88d8 to 3</span><br><span class="line">  Normal  ScalingReplicaSet  2m28s  deployment-controller  Scaled up replica set nginx-deployment-55649fd747 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  2m4s   deployment-controller  Scaled down replica set nginx-deployment-6799fc88d8 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  2m4s   deployment-controller  Scaled up replica set nginx-deployment-55649fd747 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  94s    deployment-controller  Scaled down replica set nginx-deployment-6799fc88d8 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  94s    deployment-controller  Scaled up replica set nginx-deployment-55649fd747 to 3</span><br><span class="line">  Normal  ScalingReplicaSet  70s    deployment-controller  Scaled down replica set nginx-deployment-6799fc88d8 to 0</span><br><span class="line">  </span><br><span class="line">$ curl -sI 10.105.14.129</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.0</span><br><span class="line">Date: Sat, 03 Jun 2022 08:16:01 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 23 May 2022 3 15:08:20 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;646cd6e4-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h2 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h2><blockquote>
<p>Scheduler 是<code>特殊的 Controller</code></p>
</blockquote>
<blockquote>
<p>监控当前集群所有<code>未调度的 Pod</code>，并获取当前集群所有<code>节点</code>的<code>健康情况</code>和<code>资源使用情况</code><br>为待调度的 Pod 选择<code>最佳</code>的计算节点，完成调度</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603163534863.png" alt="image-20230603163534863"></p>
<blockquote>
<p>调度阶段 - <code>Scoring</code> 是可扩展的</p>
</blockquote>
<table>
<thead>
<tr>
<th>阶段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>Predict</code></td>
<td>过滤<code>不能满足需求</code>的节点（资源不足、端口冲突等）</td>
</tr>
<tr>
<td><code>Priority</code></td>
<td>按<code>既定要素</code>为满足调度需求的节点<code>评分</code>，选择<code>最佳节点</code></td>
</tr>
<tr>
<td><code>Bind</code></td>
<td>将计算节点与 Pod 绑定，完成调度</td>
</tr>
</tbody></table>
<h2 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h2><blockquote>
<p>K8S 的 <code>init system</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603164731775.png" alt="image-20230603164731775"></p>
<ol>
<li>从不同源获取 <code>Pod 清单</code>，并按需启动 Pod 的<code>核心组件</code><ul>
<li>数据源：<code>本地文件目录</code>、<code>HTTP Server</code>、<code>K8S API Server</code></li>
</ul>
</li>
<li>负责汇报当前<code>节点</code>的<code>资源信息</code>和<code>健康情况</code></li>
<li>负责 <code>Pod</code> 的<code>健康检查</code>和<code>状态汇报</code></li>
</ol>
<blockquote>
<p>Kubelet 进行了抽象</p>
</blockquote>
<table>
<thead>
<tr>
<th>组件</th>
<th>抽象</th>
</tr>
</thead>
<tbody><tr>
<td>运行时</td>
<td><code>CRI</code></td>
</tr>
<tr>
<td>网络</td>
<td><code>CNI</code></td>
</tr>
<tr>
<td>存储</td>
<td><code>CSI</code></td>
</tr>
</tbody></table>
<h2 id="Kube-Proxy"><a href="#Kube-Proxy" class="headerlink" title="Kube-Proxy"></a>Kube-Proxy</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603165608327.png" alt="image-20230603165608327"></p>
<ol>
<li>监控集群中发布的 <code>Service</code>，并完成<code>负载均衡</code>的配置</li>
<li>每个 <code>Node</code> 上的 <code>Kube-Proxy</code> 都会配置<code>相同的负载均衡策略</code><ul>
<li>使得整个集群的<code>服务发现</code>建立在<code>分布式负载均衡器</code>之上，<code>服务调用</code>无需经过<code>额外的网络跳转</code></li>
</ul>
</li>
<li>负载均衡配置基于不同的<code>插件</code>实现<ul>
<li><code>userspace</code></li>
<li><code>OS 网络协议栈</code>不同的 <code>Hooks</code> 和<code>插件</code>：<code>iptables</code>、<code>ipvs</code></li>
</ul>
</li>
</ol>
<h1 id="Add-ons"><a href="#Add-ons" class="headerlink" title="Add-ons"></a>Add-ons</h1><table>
<thead>
<tr>
<th>Add-on</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>kube-dns</code></td>
<td>负责为整个集群提供 <code>DNS</code> 服务</td>
</tr>
<tr>
<td><code>Ingress Controller</code></td>
<td>为 <code>Service</code> 提供<code>外网入口</code></td>
</tr>
<tr>
<td><code>MetricsServer</code></td>
<td>提供<code>资源监控</code></td>
</tr>
<tr>
<td><code>Dashboard</code></td>
<td>提供 GUI</td>
</tr>
<tr>
<td><code>Fluentd-Elasticsearch</code></td>
<td>提供集群日志采集、存储和查询</td>
</tr>
</tbody></table>
<h1 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><blockquote>
<p>kubectl 将接收到的用户请求转化为 <code>REST</code> 请求，与 <code>API Server</code> 通信</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ k get ns default -v 9</span><br><span class="line">I0603 09:08:59.761062  141446 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0603 09:08:59.764914  141446 round_trippers.go:435] curl -v -XGET  -H &quot;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces/default&#x27;</span><br><span class="line">I0603 09:08:59.770927  141446 round_trippers.go:454] GET https://192.168.191.138:6443/api/v1/namespaces/default 200 OK in 5 milliseconds</span><br><span class="line">I0603 09:08:59.770943  141446 round_trippers.go:460] Response Headers:</span><br><span class="line">I0603 09:08:59.770947  141446 round_trippers.go:463]     Audit-Id: 701d086f-ab0d-43ae-9c79-b629691326f6</span><br><span class="line">I0603 09:08:59.770949  141446 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0603 09:08:59.770952  141446 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0603 09:08:59.770955  141446 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0603 09:08:59.770957  141446 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0603 09:08:59.770959  141446 round_trippers.go:463]     Content-Length: 1659</span><br><span class="line">I0603 09:08:59.770965  141446 round_trippers.go:463]     Date: Sat, 03 Jun 2022 09:08:59 GMT</span><br><span class="line">I0603 09:08:59.770987  141446 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;Table&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;resourceVersion&quot;:&quot;192&quot;&#125;,&quot;columnDefinitions&quot;:[&#123;&quot;name&quot;:&quot;Name&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;name&quot;,&quot;description&quot;:&quot;Name must be unique within a namespace. Is required when creating resources, although some resources may allow a client to request the generation of an appropriate name automatically. Name is primarily intended for creation idempotence and configuration definition. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/identifiers#names&quot;,&quot;priority&quot;:0&#125;,&#123;&quot;name&quot;:&quot;Status&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;&quot;,&quot;description&quot;:&quot;The status of the namespace&quot;,&quot;priority&quot;:0&#125;,&#123;&quot;name&quot;:&quot;Age&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;&quot;,&quot;description&quot;:&quot;CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.\n\nPopulated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&quot;,&quot;priority&quot;:0&#125;],&quot;rows&quot;:[&#123;&quot;cells&quot;:[&quot;default&quot;,&quot;Active&quot;,&quot;4d7h&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;c3b0eddd-c1de-4ea6-87ac-079b96ea14a5&quot;,&quot;resourceVersion&quot;:&quot;192&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:48:56Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;default&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-apiserver&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:48:56Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;]&#125;</span><br><span class="line">NAME      STATUS   AGE</span><br><span class="line">default   Active   4d7h</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Context</code> 是通过<code>组合</code>的方式：<code>user</code> + <code>cluster</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EVXpNREF4TkRnME9Wb1hEVE16TURVeU56QXhORGcwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnRrCjIvRERGSXpuNmhoOVl6RFVmRzJDcXRlSzBzbTVGVkIyK0lXaXpCWk5ZVnNQbFpuN3NLL0NVYm4wdGJpUGpmUEoKUUJpUkxJZ3FCS1AydWRJanhjbUhqQ0hlSVFnOGswT3RnYXRCUTNzOEkwVVdhWW1QSXNQZWxwMllrZlkxK3Q3KwpQdUVsaHl1cE13eHJlSGFLQThTMG9Dd2NRT2g1L3piN290aXNrTDFlZzNZTWZaWjU1MWJKenBsc3hRdGdsdGp3CnBmcUU3UDBoQ2VTQkpwVmNGb1BXd3RNd2wvOVRvc1lKSC9TWU9kNnV0ZUllWFlEa1F6U3czZ2lkMHBkTitoS2EKemE2MEcvN2Q2a01aamUrQmRLMVFjenZpcE9zZWUvSHVDZklUNERtLzRiOFZuS1EwVU94QWZHRVg3UUdHcUlEMApOR0xSbXhXbVU4SnUraXFaaDkwQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZEZStoM2orN1BDckZXSDZjUnE5QVFGcHpvMTZNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRXZsWEJGRHRpQzJyK2VqSFBERgozeUxzbjA4Sjd1bENnN0xwMGJRaUxPZzIzZStjTTRzRnN0UVJadnFNYW1MU3l0U2hlZHAvVExFMnR0RlZOYnAvCkJlNVJiRGtuNWRFdFg5ejRva09IVTJ3ekFlaWZ5NnhCZEloYUdGZC9WT3B1SldBZ040aU9DVkRUQTA1OWNuTDMKSmJvVHJCNkRBdUo0a2JWNis5NGZkK001RXY1TVhiWXA2L2ExYTliMmVpWnNxbjM3djUvOWZlWU51Q3JYS0xGagprKzhvUWV0UGNEbW5TdkRrdUlteUZ0TGxjRjN1MGw1RmdwU2FQQnlWekJUckZQb25jTlcyV1ZkWWxLZ3ArWWFqCithT3JkRFNzbEVTY055R0hxTEkyS0RsTHIwWlBDQWtYSjFyRDcrenI5cFVEZC9LL1B5VFBlM3JaVWd3cjh2NjIKdFlJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.191.138:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJVWVlRlYzZjRCdjR3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBMU16QXdNVFE0TkRsYUZ3MHlOREExTWprd01UUTROVEZhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXZQOVpSS09yMWE5YjhKV2wKeWVtVzNKZVp6MGtKTXc1ZjN6UFN5dkdzbDZod3FLaDNKNXNKTTJrWXJMWUtKK25vbldmTjBCekwwclF5QTdScQpPSkJFKytsa0E2d3B4bzhOSnVITyttRHBwMnhhdHFmTWpFSEhseGV4UnlmTUUveDlDZmZsVHhPV1BUcFRqbGllCkZDQlhROTBPZmZwV3RENnM2Z2JVZXZMQzJTMStyMFJyMmhRWmE2bkxpQW9RdWhmZnJtTGJ2ZVJmblp0ZDVlS08KOUQ5SXAybmhjRE5PeWlIQWNoRlU3OW5id3JzRS9XRks5SVVtL3g1cU52WUFjS2pSUmpKSFJseUNENVdFTzBldgpYUGJjSXRZcnlHSDBBTWNkcXU5ZTc0WEFCTUNYa3VjbGs0UndkUEl1UHBMTHFJNnFTQWwvek0vdFJyQm1kL1V1ClRKbXE2d0lEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JRM3ZvZDQvdXp3cXhWaCtuRWF2UUVCYWM2TgplakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBdm1zQ3VXcWJ1ZlI2UHVFTUlrRXg5TDZFeU1zY2NhZzlqWER2CmNTY1hXNUVUSkllcW5ISmtzRVY4NEdCdDhlcGx0aGhUM1pFVUZvSURvR3FHNk1CVDFJdG5jaVlKRG5NUHZ5djAKWFBpVno4MFM3RFZhQjhwVjJvK3JjaFRmMHdSYVUvQWF4dWdtUWwzZHVUcEtYbU1DTThGQ3FpTVJYbm1veGJVUgpqTklsTGcwbjJzMXF0Tk1LVGRCSlB3dUVqdFJZMWVpU09GRGgwclFhYmZUc2dHa25SOGxCcHdDd28rWVdaMGs0CmlZaWtrT21ERnZsakZ6Z1VpcWpTRGdjRnNnUjlFWXZ1TGdtSHlJVnpxZG1NZURMandwL2NWM1VubGNoa3hsZEsKVDcyYWs5cnhzTGwrUFVGajlFZE92Y2tKanI0VFhZcWFJR2FwNWhyTDg1bEdNcTgyVXc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdlA5WlJLT3IxYTliOEpXbHllbVczSmVaejBrSk13NWYzelBTeXZHc2w2aHdxS2gzCko1c0pNMmtZckxZS0orbm9uV2ZOMEJ6TDByUXlBN1JxT0pCRSsrbGtBNndweG84Tkp1SE8rbURwcDJ4YXRxZk0KakVISGx4ZXhSeWZNRS94OUNmZmxUeE9XUFRwVGpsaWVGQ0JYUTkwT2ZmcFd0RDZzNmdiVWV2TEMyUzErcjBScgoyaFFaYTZuTGlBb1F1aGZmcm1MYnZlUmZuWnRkNWVLTzlEOUlwMm5oY0ROT3lpSEFjaEZVNzluYndyc0UvV0ZLCjlJVW0veDVxTnZZQWNLalJSakpIUmx5Q0Q1V0VPMGV2WFBiY0l0WXJ5R0gwQU1jZHF1OWU3NFhBQk1DWGt1Y2wKazRSd2RQSXVQcExMcUk2cVNBbC96TS90UnJCbWQvVXVUSm1xNndJREFRQUJBb0lCQURGR3BrQ21KOFFqMzJXLwpycVVST1JzMGo0Nmk3VG9aa2xlQWpJSUxOc09uMEErNU5LL24xU05KVUh5ZlRkQ1FST3pkUnFUdkRSbFhqLzYxClNFaU5ITjlOUDUxUmd1YlpIMFcyOUI4RnE0WFNVMmh5SVh1a0h1Uys4YUtxdHFPelhlcCticFFLZUU1b2FhYWcKWmo2N0crVit1aXVRWEpETUVvdEYwcHBudHZPbVhEUXBueE9EVHhwNkhmREdodERtdEkxb0FlSng3aXJlNFQ5Rwp3MWR1SHJDZWpuQWp5QTkwbmtnVEhNWWVSZHoxcmE4bVZqNzE5VnpYbWxyRFFYTkhDZzJFMFZ5b29GNGc4R29CCm1rTldLVTh6NUxqN05sVFEwbElsazlrbVZTZTE2V2g0MWR6dkRIbGxtdFZyVHdPWXZjNjdWY3UzVFE4Ly84bDcKbldwME9CRUNnWUVBKzlEL09nSmxoSnoyNnBTNG5mbWt3YTVUZ3NHVWJhSEttV1ZDeVBwUFNGZzRSeXNDc2U3NwpnaXV4UkxVK2F4aU9MTm5Jc1pmb1hZUzlVbXpacWFQRzRhVHhiT2RXY2RMUTdweThHZmJranVHcmlKb0FqRDZDCmFWYXRGN3k4VU5SNXg4eXZNcjgxWGRTYmdONUFuSUJ6QkZQVzFOV3VDcjVtQnE3c2tEUVpBZmtDZ1lFQXdDTXQKQW9xMmYyTGFtdWtYNUpnK3FHc3NoMG5rZzVrZ213ODVYSEJzcHFGT3B2TWhIa0RhWUtuZHBXTkVubXF3REY2UQp4Yi9aNVBWU3hGMElFS1ZhTVZ6N1N1ekk4MnBXeVlEWnNrelpwUU80d2x4a1F5Q0lwWHQzL1R4UUV3aGd6Y3A0ClJ1SDFmUVhiUURkSVpQV0FnSVY2U2lLTWwxUW0yZFp2eVVJZERRTUNnWUVBdGxxejZPdEJYdFpZVEtua1E2bzcKOEhId1Vka2pSbjBLZlNrQ1F3NVpDWmV4TVlCcEZEZHU5T1gxR2o5eDh4WTJKeTZURW1CaVNnN05GdnB5YVZHTAp2VzIzMDFoM2xqZkhTM1EvRjBKZVkwWHk5Um9vMldhUEEvOWJtN3YyVjBaMjVnUkl2eVFPWG1PUE5MUTk3OWRvCjh6SlBlWk0vMU5IcWlsNTBPejB1K3VrQ2dZQjVKM1VoVGpDSG9PRHhuNXVtVkczbUt6WjMxSnRZYy8xQWFWZ2wKTnVyOEkya0NFdnRHSldUT1lTNVhOSUkzVmxUT1orN29FdktsMGgrdm5HNFNlUUduY05jd1JxRHNCSmpYRlAydwoxWTdENDlYa0VQaFQ3N2JhaWtGK0dFTHh6VzJsTmsramVxWWVnTXZnOFRzZ0ZrSkNTR2gxU05YWU1vTVJCNHVUCm43SEwyd0tCZ1FDQlhCUWRlbWhhMmxMbDhhbEZ5Umd1dmJyOHJsbmVIc29RUEdOeEgwSVZNVVZPaWNnM1Y5bEoKZUNGdVl0dGxpRm5yRXppeHBsRTBzU1JZMzYxdkJtMzN3eXU5RXlmN2hBTy9TUTlsYWpUdDVMR0FZdkx3TDNvcgpGeFNEaFd1cVVTZGhqSGRLb0JTWXpjOEFXUkd2S2xrU0UyTjV0M2JRSFNZL2NBOUtsSDdSbEE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br></pre></td></tr></table></figure>

<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><blockquote>
<p>资源列表</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources</span><br></pre></td></tr></table></figure>

<blockquote>
<p>get：查看对象<br><code>-oyaml</code>，YAML 详细信息；<code>-owide</code>，详细列表；<code>-w</code>，监听</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ k get po -oyaml -w</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">$ k label ns default a=b</span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line">$ k get ns default -oyaml -w -v 9</span><br><span class="line">I0603 10:41:40.955475  240520 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0603 10:41:40.957875  240520 round_trippers.go:435] curl -v -XGET  -H &quot;Accept: application/json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces/default&#x27;</span><br><span class="line">I0603 10:41:40.962655  240520 round_trippers.go:454] GET https://192.168.191.138:6443/api/v1/namespaces/default 200 OK in 4 milliseconds</span><br><span class="line">I0603 10:41:40.962670  240520 round_trippers.go:460] Response Headers:</span><br><span class="line">I0603 10:41:40.962673  240520 round_trippers.go:463]     Date: Sat, 03 Jun 2022 10:41:40 GMT</span><br><span class="line">I0603 10:41:40.962675  240520 round_trippers.go:463]     Audit-Id: c4eb9cfa-18e2-4c74-a5cb-aaa3fc9c7e1f</span><br><span class="line">I0603 10:41:40.962677  240520 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0603 10:41:40.962681  240520 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0603 10:41:40.962682  240520 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0603 10:41:40.962684  240520 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0603 10:41:40.962687  240520 round_trippers.go:463]     Content-Length: 520</span><br><span class="line">I0603 10:41:40.962704  240520 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;Namespace&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;c3b0eddd-c1de-4ea6-87ac-079b96ea14a5&quot;,&quot;resourceVersion&quot;:&quot;192&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:48:56Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;default&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-apiserver&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:48:56Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;,&quot;spec&quot;:&#123;&quot;finalizers&quot;:[&quot;kubernetes&quot;]&#125;,&quot;status&quot;:&#123;&quot;phase&quot;:&quot;Active&quot;&#125;&#125;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T01:48:56Z&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/metadata.name: default</span><br><span class="line">  name: default</span><br><span class="line">  resourceVersion: &quot;192&quot;</span><br><span class="line">  uid: c3b0eddd-c1de-4ea6-87ac-079b96ea14a5</span><br><span class="line">spec:</span><br><span class="line">  finalizers:</span><br><span class="line">  - kubernetes</span><br><span class="line">status:</span><br><span class="line">  phase: Active</span><br><span class="line">I0603 10:41:40.962977  240520 round_trippers.go:435] curl -v -XGET  -H &quot;Accept: application/json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces?fieldSelector=metadata.name%3Ddefault&amp;resourceVersion=0&amp;watch=true&#x27;</span><br><span class="line">I0603 10:41:40.963578  240520 round_trippers.go:454] GET https://192.168.191.138:6443/api/v1/namespaces?fieldSelector=metadata.name%3Ddefault&amp;resourceVersion=0&amp;watch=true 200 OK in 0 milliseconds</span><br><span class="line">I0603 10:41:40.963618  240520 round_trippers.go:460] Response Headers:</span><br><span class="line">I0603 10:41:40.963661  240520 round_trippers.go:463]     Audit-Id: 97cf544f-fa33-46c5-a0df-c619a34471d0</span><br><span class="line">I0603 10:41:40.963699  240520 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0603 10:41:40.963768  240520 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0603 10:41:40.963807  240520 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0603 10:41:40.963839  240520 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0603 10:41:40.963868  240520 round_trippers.go:463]     Date: Sat, 03 Jun 2022 10:41:40 GMT</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T01:48:56Z&quot;</span><br><span class="line">  labels:</span><br><span class="line">    a: b</span><br><span class="line">    kubernetes.io/metadata.name: default</span><br><span class="line">  name: default</span><br><span class="line">  resourceVersion: &quot;17391&quot;</span><br><span class="line">  uid: c3b0eddd-c1de-4ea6-87ac-079b96ea14a5</span><br><span class="line">spec:</span><br><span class="line">  finalizers:</span><br><span class="line">  - kubernetes</span><br><span class="line">status:</span><br><span class="line">  phase: Active</span><br></pre></td></tr></table></figure>

<blockquote>
<p>describe：详细信息和相关 <code>Event</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ k describe deployments.apps nginx-deployment</span><br><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Tue, 30 May 2022 02:21:16 +0000</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx</span><br><span class="line">    Port:         &lt;none&gt;</span><br><span class="line">    Host Port:    &lt;none&gt;</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-6799fc88d8 (2/2 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age   From                   Message</span><br><span class="line">  ----    ------             ----  ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  29s   deployment-controller  Scaled down replica set nginx-deployment-6799fc88d8 to 2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>exec：进入容器进行 debug</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it nginx-deployment-6799fc88d8-4ppnm -- sh</span><br><span class="line"># cat /etc/issue</span><br><span class="line">Debian GNU/Linux 11 \n \l</span><br></pre></td></tr></table></figure>

<blockquote>
<p>logs：查看 pod 的 <code>stdout</code> 和 <code>stderr</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ k logs --tail 10 nginx-deployment-6799fc88d8-4ppnm</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: nginx/1.25.0</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6)</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: OS: Linux 5.4.0-149-generic</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: start worker processes</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: start worker process 28</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: start worker process 29</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: start worker process 30</span><br><span class="line">2022/05/30 02:22:31 [notice] 1#1: start worker process 31</span><br><span class="line">192.168.191.138 - - [30/May/2022:02:23:06 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/7.68.0&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<h1 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h1><blockquote>
<p>云计算分类：<code>IaaS</code> -&gt; <code>PaaS</code> -&gt; <code>SaaS</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603185756665.png" alt="image-20230603185756665"></p>
<blockquote>
<p>K8S 生态系统</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603190354181.png" alt="image-20230603190354181"></p>
<blockquote>
<p>设计理念</p>
</blockquote>
<ol>
<li><code>高可用</code><ul>
<li>基于 <code>ReplicaSet</code> 和 <code>StatefulSet</code> 的<code>应用高可用</code></li>
<li>Kubernetes <code>组件高可用</code></li>
</ul>
</li>
<li><code>安全</code><ul>
<li>基于 <code>TLS</code> 提供服务</li>
<li><code>ServiceAccount</code>（内部） 和 <code>User</code>（外部）</li>
<li>基于 <code>Namespace</code> 的隔离</li>
<li><code>Secret</code>（加密）</li>
<li><code>Taints</code>、<code>PodSecurityPolicies</code>、<code>NetworkPolicies</code></li>
</ul>
</li>
<li><code>可移植</code><ul>
<li>多种 <code>Arch</code> + <code>OS</code></li>
<li>基于<code>集群联邦</code>建立<code>混合云</code></li>
</ul>
</li>
<li><code>弹性</code><ul>
<li>基于<code>微服务</code>部署应用</li>
<li><code>横向</code>扩缩容</li>
<li><code>自动</code>扩缩容</li>
</ul>
</li>
<li><code>可扩展</code><ul>
<li>基于 <code>CRD</code> 扩展</li>
<li><code>插件化</code>的生态系统</li>
</ul>
</li>
</ol>
<blockquote>
<p>分层架构 - 灵活的扩展性</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603192359946.png" alt="image-20230603192359946"></p>
<ol>
<li>核心层 - <code>Nucleus: API and Execution</code><ul>
<li>Kubernetes 最核心的功能，<code>对外</code>提供 <code>API</code> 构建高层的应用，<code>对内</code>提供<code>插件式应用执行环境</code></li>
</ul>
</li>
<li>应用层 - <code>Application Layer: Deployment and Routing</code><ul>
<li><code>部署</code>：无状态应用（Deployment）、有状态应用（StatefulSet）、批处理任务（Job&#x2F;CronJob）、集群应用</li>
<li><code>路由</code>：服务发现、DNS 解析等</li>
</ul>
</li>
<li>管理层 - <code>Governance Layer: Automation and Policy Enforcement</code><ul>
<li><code>系统度量</code>：基础设施、容器、网络</li>
<li><code>自动化</code>：自动扩展、动态 Provision 等</li>
<li><code>策略管理</code>：RBAC、Quota、PodSecurityPolicies、NetworkPolicies</li>
</ul>
</li>
<li>接口层：<code>Interface Layer: Client Libraries and Tools</code><ul>
<li>Kubectl、客户端 SDK、集群联邦</li>
</ul>
</li>
<li>生态系统：<code>Ecosystem</code> - 集群管理调度<ul>
<li>外部：日志、监控、配置管理、CI&#x2F;CD、Workflow、FaaS、ChatOps 等</li>
<li>内部：CRI、CNI、CVI、Image Registry、Cloud Provider、集群自身的配置和管理等</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603194559265.png" alt="image-20230603194559265"></p>
<blockquote>
<p>API 设计原则</p>
</blockquote>
<ol>
<li>所有 API 都应该是<code>声明式</code>的</li>
<li>API 对象是<code>彼此互补</code>而且是<code>可组合</code>的 - <code>高内聚</code> + <code>低耦合</code></li>
<li><code>高层 API</code> 以<code>操作意图</code>为<code>基础设计</code> - 满足业务需求</li>
<li><code>低层 API</code> 根据<code>高层 API</code> 的<code>控制需要</code>设计<ul>
<li>低层 API 被高层 API 所使用，应以减少冗余，<code>提高重用性</code>为目的</li>
</ul>
</li>
<li><code>避免简单封装</code>，也应避免外部 API <code>无法显式知道的内部隐藏的机制</code></li>
<li>API <code>操作复杂度</code>与<code>对象数量</code>成<code>正比</code>，API 操作复杂度不能超过 <code>O(N)</code></li>
<li>API <code>对象状态</code>不能依赖于<code>网络连接状态</code> - 在分布式系统中，<code>网络断连</code>经常发生</li>
<li>避免让<code>操作机制</code>依赖<code>全局状态</code> - 在分布式系统中，<code>强一致性</code>很难保证</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603201519821.png" alt="image-20230603201519821"></p>
<blockquote>
<p>架构设计原则</p>
</blockquote>
<ol>
<li>只有 <code>API Server</code> 可以直接访问 <code>etcd</code>，其他服务必须通过 API Server 来访问集群状态</li>
<li><code>单点故障</code>不应该影响<code>集群状态</code></li>
<li>在<code>没有新请求</code>的情况下，<code>所有组件</code>应该在<code>故障恢复</code>后继续执行<code>上次最后收到的请求</code></li>
<li><code>所有组件</code>都应该在<code>内存</code>中保持所需要的状态<ul>
<li>API Server 将状态写入 etcd，而其它组件通过 API Server 进行 <code>List &amp; Watch</code></li>
</ul>
</li>
<li>优先使用<code>事件监听</code>而非轮询</li>
</ol>
<blockquote>
<p>引导原则</p>
</blockquote>
<ol>
<li>目标：<code>Self-hosting</code><ul>
<li>将<code>控制面</code>的<code>核心组件</code>（除了 <code>kubelet</code>，kubelet 被 <code>systemd</code> 管理）<code>容器化</code></li>
<li>kubelet 相当于 K8S 的 <code>init system</code></li>
<li>kubelet  会扫描 <code>staticPodPath</code> 里面的文件清单，kubelet 会在 <code>API Server</code> 将 Pod 定义补全并写入到 <code>etcd</code></li>
</ul>
</li>
<li><code>减少依赖</code></li>
<li>通过<code>分层原则</code>来<code>管理依赖</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ k get pod -n kube-system</span><br><span class="line">NAME                              READY   STATUS    RESTARTS        AGE</span><br><span class="line">coredns-7f6cbbb7b8-97knk          1/1     Running   0               4d11h</span><br><span class="line">coredns-7f6cbbb7b8-rs667          1/1     Running   0               4d11h</span><br><span class="line">etcd-mac-k8s                      1/1     Running   0               4d11h</span><br><span class="line">kube-apiserver-mac-k8s            1/1     Running   0               4d11h</span><br><span class="line">kube-controller-manager-mac-k8s   1/1     Running   3 (4d10h ago)   4d11h</span><br><span class="line">kube-proxy-6cjvs                  1/1     Running   0               4d11h</span><br><span class="line">kube-scheduler-mac-k8s            1/1     Running   3 (4d10h ago)   4d11h</span><br><span class="line"></span><br><span class="line">$ ps -ef | grep kubelet</span><br><span class="line">...</span><br><span class="line">root        9094       1  6 07:59 ?        00:19:23 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.5</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>/var/lib/kubelet/config.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">anonymous:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="attr">cacheTTL:</span> <span class="string">0s</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">x509:</span></span><br><span class="line">    <span class="attr">clientCAFile:</span> <span class="string">/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="attr">cacheAuthorizedTTL:</span> <span class="string">0s</span></span><br><span class="line">    <span class="attr">cacheUnauthorizedTTL:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">systemd</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="attr">cpuManagerReconcilePeriod:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">evictionPressureTransitionPeriod:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">fileCheckFrequency:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="attr">httpCheckFrequency:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">imageMinimumGCAge:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">logging:</span> &#123;&#125;</span><br><span class="line"><span class="attr">memorySwap:</span> &#123;&#125;</span><br><span class="line"><span class="attr">nodeStatusReportFrequency:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">nodeStatusUpdateFrequency:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">resolvConf:</span> <span class="string">/run/systemd/resolve/resolv.conf</span></span><br><span class="line"><span class="attr">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">shutdownGracePeriod:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">shutdownGracePeriodCriticalPods:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">staticPodPath:</span> <span class="string">/etc/kubernetes/manifests</span></span><br><span class="line"><span class="attr">streamingConnectionIdleTimeout:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">syncFrequency:</span> <span class="string">0s</span></span><br><span class="line"><span class="attr">volumeStatsAggPeriod:</span> <span class="string">0s</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls /etc/kubernetes/manifests</span><br><span class="line">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml</span><br></pre></td></tr></table></figure>

<h1 id="API-对象"><a href="#API-对象" class="headerlink" title="API 对象"></a>API 对象</h1><blockquote>
<p>API 对象是 K8S 集群中的<code>管理操作单元</code>，API 对象有 4 类属性：<code>TypeMeta</code>、<code>MetaData</code>、<code>Spec</code>、<code>Status</code></p>
</blockquote>
<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><blockquote>
<p>通用属性：<code>TypeMeta + MetaData</code>，特有属性：<code>Spec + Status</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="TypeMeta"><a href="#TypeMeta" class="headerlink" title="TypeMeta"></a>TypeMeta</h3><blockquote>
<p>K8S 对象的最基本定义，通过 <code>GKV</code> 模型定义一个<code>对象的类型</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>GKV</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>G &#x3D; <code>Group</code></td>
<td>将对象依据其<code>功能</code>归入不同的分组</td>
</tr>
<tr>
<td>K &#x3D; <code>Kind</code></td>
<td>对象的<code>基本类型</code></td>
</tr>
<tr>
<td>V &#x3D;  <code>Version</code></td>
<td>v1alpha1（Snapshot） -&gt; v1alpha2（Snapshot） -&gt; v1beta1（RC） -&gt; <code>v1</code>（Release）</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&#x27;&#x27;</span><br><span class="line">NAME                     SHORTNAMES   APIVERSION   NAMESPACED   KIND</span><br><span class="line">bindings                              v1           true         Binding</span><br><span class="line">componentstatuses        cs           v1           false        ComponentStatus</span><br><span class="line">configmaps               cm           v1           true         ConfigMap</span><br><span class="line">endpoints                ep           v1           true         Endpoints</span><br><span class="line">events                   ev           v1           true         Event</span><br><span class="line">limitranges              limits       v1           true         LimitRange</span><br><span class="line">namespaces               ns           v1           false        Namespace</span><br><span class="line">nodes                    no           v1           false        Node</span><br><span class="line">persistentvolumeclaims   pvc          v1           true         PersistentVolumeClaim</span><br><span class="line">persistentvolumes        pv           v1           false        PersistentVolume</span><br><span class="line">pods                     po           v1           true         Pod</span><br><span class="line">podtemplates                          v1           true         PodTemplate</span><br><span class="line">replicationcontrollers   rc           v1           true         ReplicationController</span><br><span class="line">resourcequotas           quota        v1           true         ResourceQuota</span><br><span class="line">secrets                               v1           true         Secret</span><br><span class="line">serviceaccounts          sa           v1           true         ServiceAccount</span><br><span class="line">services                 svc          v1           true         Service</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&#x27;apps&#x27;</span><br><span class="line">NAME                  SHORTNAMES   APIVERSION   NAMESPACED   KIND</span><br><span class="line">controllerrevisions                apps/v1      true         ControllerRevision</span><br><span class="line">daemonsets            ds           apps/v1      true         DaemonSet</span><br><span class="line">deployments           deploy       apps/v1      true         Deployment</span><br><span class="line">replicasets           rs           apps/v1      true         ReplicaSet</span><br><span class="line">statefulsets          sts          apps/v1      true         StatefulSet</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&#x27;batch&#x27;</span><br><span class="line">NAME       SHORTNAMES   APIVERSION   NAMESPACED   KIND</span><br><span class="line">cronjobs   cj           batch/v1     true         CronJob</span><br><span class="line">jobs                    batch/v1     true         Job</span><br></pre></td></tr></table></figure>

<h3 id="MetaData"><a href="#MetaData" class="headerlink" title="MetaData"></a>MetaData</h3><blockquote>
<p>MetaData 中的通过  <code>Namespace</code> 和 <code>Name</code>  来<code>唯一</code>定义了某个<code>对象实例</code><br>但 <code>Node</code> 是不区分 Namespace 的（<code>Non-Namespace Object</code>）</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">c:</span> <span class="string">d</span></span><br><span class="line">    <span class="attr">deployment.kubernetes.io/revision:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;replicas&quot;:3,&quot;selector&quot;:&#123;&quot;matchLabels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;&#125;,&quot;template&quot;:&#123;&quot;metadata&quot;:&#123;&quot;labels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;image&quot;:&quot;nginx&quot;,&quot;name&quot;:&quot;nginx&quot;&#125;]&#125;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-05-30T02:21:16Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">a:</span> <span class="string">b</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;37353&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">b3560021-1183-472f-a4ea-c638c561e0e7</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Label</code>：采用 <code>KV</code> 形式，一个对象可以有任意对标签，一般结合 <code>Selector</code> 来<code>过滤</code>查询</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603223151346.png" alt="image-20230603223151346"></p>
<ol>
<li>Label 是<code>识别 K8S 对象</code>的标签，以 <code>KV</code> 的方式附加在对象上</li>
<li>长度限制：<code>key - 63 字节</code>，<code>value - 253 字节</code></li>
<li>Label <code>不提供唯一性</code></li>
<li>Label 定义好后，可以使用 <code>Label Selector</code> 来选择一组相同 Label 的对象</li>
<li>Label Selector<ul>
<li><code>相等</code>：<code>app=nginx</code>、<code>env!=production</code></li>
<li><code>集合</code>：<code>env in (production, qa)</code></li>
<li>多个 Label 之间是 <code>AND</code> 关系：<code>app=nginx,env=test</code></li>
</ul>
</li>
</ol>
<blockquote>
<p><code>Annotation</code>：采用 <code>KV</code> 形式，作为<code>属性扩展</code>，更多面向<code>系统管理员</code>和<code>开发人员</code></p>
</blockquote>
<ol>
<li>Annotation 以 KV 的形式附加在对象上</li>
<li>与 Label 的用途差异<ul>
<li>Label 用于<code>标记</code>和<code>选择</code>对象</li>
<li>Annotation 用来记录一些<code>附加信息</code>（用来辅助<code>应用部署</code>、<code>安全策略</code>、<code>调度策略</code>等）</li>
</ul>
</li>
</ol>
<blockquote>
<p><code>Finalizer</code>：是一个<code>资源锁</code>，不能被<code>物理删除</code><br>K8S 在接收到某个对象的<code>删除请求</code>时，如果 <code>Finalizer</code> 不为<code>空</code>则只对其做<code>逻辑删除</code><br><code>逻辑删除</code>：更新对象的 <code>metadata.deletionTimestamp</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ k run --image=nginx my-nginx --restart=&#x27;Always&#x27;</span><br><span class="line">pod/my-nginx created</span><br><span class="line"></span><br><span class="line">$ k edit pod nginx</span><br><span class="line">...</span><br><span class="line">metadata:</span><br><span class="line">  finalizers:</span><br><span class="line">  - kubernetes</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ k delete po nginx</span><br><span class="line">pod &quot;nginx&quot; deleted</span><br><span class="line"></span><br><span class="line">$ k get po</span><br><span class="line">NAME    READY   STATUS        RESTARTS   AGE</span><br><span class="line">nginx   0/1     Terminating   0          5m26s</span><br><span class="line"></span><br><span class="line">$ k get po nginx -oyaml</span><br><span class="line">...</span><br><span class="line">metadata:</span><br><span class="line">  deletionTimestamp: &quot;2022-05-30T02:29:18Z&quot;</span><br><span class="line">    finalizers:</span><br><span class="line">    - kubernetes</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ k edit pod nginx</span><br><span class="line">删除 finalizers</span><br><span class="line"></span><br><span class="line">$ k get po</span><br><span class="line">No resources found in default namespace.</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>ResourceVersion</code>：是一个<code>乐观锁</code>，每个对象在任意时刻都有 ResourceVersion，类似于 JVM 中的 <code>CAS</code> 机制</p>
</blockquote>
<h3 id="Spec"><a href="#Spec" class="headerlink" title="Spec"></a>Spec</h3><blockquote>
<p>对象的<code>期望状态</code>，由创建对象的<code>用户端</code>来定义</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h3><blockquote>
<p>对象的<code>实际状态</code>，由对应的 <code>Controller</code> 收集实际状态并更新</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">availableReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-05-30T02:22:32Z&quot;</span></span><br><span class="line">    <span class="attr">lastUpdateTime:</span> <span class="string">&quot;2022-05-30T02:22:32Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Deployment</span> <span class="string">has</span> <span class="string">minimum</span> <span class="string">availability.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">MinimumReplicasAvailable</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Available</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-05-30T02:21:16Z&quot;</span></span><br><span class="line">    <span class="attr">lastUpdateTime:</span> <span class="string">&quot;2022-05-30T02:22:32Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">ReplicaSet</span> <span class="string">&quot;nginx-deployment-6799fc88d8&quot;</span> <span class="string">has</span> <span class="string">successfully</span> <span class="string">progressed.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">NewReplicaSetAvailable</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Progressing</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">readyReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">updatedReplicas:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230603224732338.png" alt="image-20230603224732338"></p>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><ol>
<li>Node 是 Pod 真正运行的主机，可以是<code>物理机</code>，也可以是<code>虚拟机</code></li>
<li>每个 Node 至少要运行 <code>Container runtime</code>、<code>Kubelet</code>、<code>Kube-proxy</code></li>
</ol>
<h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><ol>
<li>Namespace 是对一组<code>资源</code>和<code>对象</code>的<code>抽象隔离</code></li>
<li>分类<ul>
<li>Namespace Object：Pod、Service、Deployment 等</li>
<li>Non-Namespace Object：<code>Node</code>、<code>PV</code></li>
</ul>
</li>
</ol>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><ol>
<li>Pod 是一组<code>紧密关联</code>的<code>容器集合</code>，是 K8S <code>调度的基本单位</code><ul>
<li>共享 <code>Linux Namespace</code>：<code>PID</code>、<code>IPC</code>、<code>Network</code>（默认共享）、<code>UTS</code></li>
</ul>
</li>
<li>Pod 的设计理念<ul>
<li>支持多个容器在一个 Pod 中共享<code>网络</code>和<code>文件系统</code>，可以通过<code>进程间通信</code>和<code>文件共享</code>来组合完成服务</li>
</ul>
</li>
<li>同一个 Pod 中不同容器可以共享的资源<ul>
<li>共享<code>网络</code> Namespace（彼此通过 <code>Loopback</code> 地址访问，<code>sidecar</code>）</li>
<li>通过挂载<code>存储卷</code>来共享<code>存储</code></li>
<li>共享 <code>Security Context</code></li>
</ul>
</li>
<li>环境变量（应用与配置分离）<ul>
<li>直接设置值</li>
<li>读取 <code>Pod Spec</code> 的属性</li>
<li>从 <code>ConfigMap</code> 读取</li>
<li>从 <code>Secret</code> 读取</li>
</ul>
</li>
</ol>
<blockquote>
<p>直接设置值</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lang</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">go</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>读取 <code>Pod Spec</code> 的属性</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lang</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>从 <code>ConfigMap</code> 读取</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lang</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-env</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">my-lang</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>从 <code>Secret</code> 读取</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lang</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">my-lang</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ k get cm</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      4d13h</span><br><span class="line"></span><br><span class="line">$ k get cm kube-root-ca.crt -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  ca.crt: |</span><br><span class="line">    -----BEGIN CERTIFICATE-----</span><br><span class="line">    MIIC/jCCAeagAwIBAgIBADANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwprdWJl</span><br><span class="line">    cm5ldGVzMB4XDTIzMDUzMDAxNDg0OVoXDTMzMDUyNzAxNDg0OVowFTETMBEGA1UE</span><br><span class="line">    AxMKa3ViZXJuZXRlczCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANtk</span><br><span class="line">    2/DDFIzn6hh9YzDUfG2CqteK0sm5FVB2+IWizBZNYVsPlZn7sK/CUbn0tbiPjfPJ</span><br><span class="line">    QBiRLIgqBKP2udIjxcmHjCHeIQg8k0OtgatBQ3s8I0UWaYmPIsPelp2YkfY1+t7+</span><br><span class="line">    PuElhyupMwxreHaKA8S0oCwcQOh5/zb7otiskL1eg3YMfZZ551bJzplsxQtgltjw</span><br><span class="line">    pfqE7P0hCeSBJpVcFoPWwtMwl/9TosYJH/SYOd6uteIeXYDkQzSw3gid0pdN+hKa</span><br><span class="line">    za60G/7d6kMZje+BdK1QczvipOsee/HuCfIT4Dm/4b8VnKQ0UOxAfGEX7QGGqID0</span><br><span class="line">    NGLRmxWmU8Ju+iqZh90CAwEAAaNZMFcwDgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB</span><br><span class="line">    /wQFMAMBAf8wHQYDVR0OBBYEFDe+h3j+7PCrFWH6cRq9AQFpzo16MBUGA1UdEQQO</span><br><span class="line">    MAyCCmt1YmVybmV0ZXMwDQYJKoZIhvcNAQELBQADggEBAEvlXBFDtiC2r+ejHPDF</span><br><span class="line">    3yLsn08J7ulCg7Lp0bQiLOg23e+cM4sFstQRZvqMamLSytShedp/TLE2ttFVNbp/</span><br><span class="line">    Be5RbDkn5dEtX9z4okOHU2wzAeify6xBdIhaGFd/VOpuJWAgN4iOCVDTA059cnL3</span><br><span class="line">    JboTrB6DAuJ4kbV6+94fd+M5Ev5MXbYp6/a1a9b2eiZsqn37v5/9feYNuCrXKLFj</span><br><span class="line">    k+8oQetPcDmnSvDkuImyFtLlcF3u0l5FgpSaPByVzBTrFPoncNW2WVdYlKgp+Yaj</span><br><span class="line">    +aOrdDSslEScNyGHqLI2KDlLr0ZPCAkXJ1rD7+zr9pUDd/K/PyTPe3rZUgwr8v62</span><br><span class="line">    tYI=</span><br><span class="line">    -----END CERTIFICATE-----</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/description: Contains a CA bundle that can be used to verify the</span><br><span class="line">      kube-apiserver when using internal endpoints such as the internal service IP</span><br><span class="line">      or kubernetes.default.svc. No other usage is guaranteed across distributions</span><br><span class="line">      of Kubernetes clusters.</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T01:49:11Z&quot;</span><br><span class="line">  name: kube-root-ca.crt</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;375&quot;</span><br><span class="line">  uid: 6d397037-bb80-4f16-a2e5-ea9f9cb3da51</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ k get secrets</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-tcwxj   kubernetes.io/service-account-token   3      4d13h</span><br><span class="line"></span><br><span class="line">$ k get secrets default-token-tcwxj -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EVXpNREF4TkRnME9Wb1hEVE16TURVeU56QXhORGcwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnRrCjIvRERGSXpuNmhoOVl6RFVmRzJDcXRlSzBzbTVGVkIyK0lXaXpCWk5ZVnNQbFpuN3NLL0NVYm4wdGJpUGpmUEoKUUJpUkxJZ3FCS1AydWRJanhjbUhqQ0hlSVFnOGswT3RnYXRCUTNzOEkwVVdhWW1QSXNQZWxwMllrZlkxK3Q3KwpQdUVsaHl1cE13eHJlSGFLQThTMG9Dd2NRT2g1L3piN290aXNrTDFlZzNZTWZaWjU1MWJKenBsc3hRdGdsdGp3CnBmcUU3UDBoQ2VTQkpwVmNGb1BXd3RNd2wvOVRvc1lKSC9TWU9kNnV0ZUllWFlEa1F6U3czZ2lkMHBkTitoS2EKemE2MEcvN2Q2a01aamUrQmRLMVFjenZpcE9zZWUvSHVDZklUNERtLzRiOFZuS1EwVU94QWZHRVg3UUdHcUlEMApOR0xSbXhXbVU4SnUraXFaaDkwQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZEZStoM2orN1BDckZXSDZjUnE5QVFGcHpvMTZNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRXZsWEJGRHRpQzJyK2VqSFBERgozeUxzbjA4Sjd1bENnN0xwMGJRaUxPZzIzZStjTTRzRnN0UVJadnFNYW1MU3l0U2hlZHAvVExFMnR0RlZOYnAvCkJlNVJiRGtuNWRFdFg5ejRva09IVTJ3ekFlaWZ5NnhCZEloYUdGZC9WT3B1SldBZ040aU9DVkRUQTA1OWNuTDMKSmJvVHJCNkRBdUo0a2JWNis5NGZkK001RXY1TVhiWXA2L2ExYTliMmVpWnNxbjM3djUvOWZlWU51Q3JYS0xGagprKzhvUWV0UGNEbW5TdkRrdUlteUZ0TGxjRjN1MGw1RmdwU2FQQnlWekJUckZQb25jTlcyV1ZkWWxLZ3ArWWFqCithT3JkRFNzbEVTY055R0hxTEkyS0RsTHIwWlBDQWtYSjFyRDcrenI5cFVEZC9LL1B5VFBlM3JaVWd3cjh2NjIKdFlJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">  namespace: ZGVmYXVsdA==</span><br><span class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkluSjNTRXcwUm1GUlExSXlVVVZFWjFKa1VqZFJkelYyV1hCU1h6VjFWVTFyVTFaVWNtVTBkblJQVGtVaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRHTjNlR29pTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU15TWpobU1tTXdMVFpsTjJFdE5HVmtNQzA1WkdSakxUQTROR05tWVRaalpqUm1ZaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZzJwX2xYVURHYTNPOGxPenNRb19OTS1GN0FtREtrQ1A2bG96TDAyR081QzR1R1RoM0UyMTZLRExNZWZpUzVlV3p6b2lKZGs3LVZrczdyUFBvN0RjQkp5VUxJOEVqVko3UTlyZEl6MV83WU1tTkZSWUFjZkJWYks2RnhpME5yZlR6a0FMSWlaeTNQSS1KTVg3OGpNMFFoQktOTDh0YWdPY3YwRkJLR2R0ZnV4QlZIa3VpdW51b3NFNHprVml1anFxOG52WDNEaXJwZ1EtT2lQREZLckZCaHkzcDhhelE2ZUpaSUlFZjRQUm84cUdOaVp6WERNOGw3VEtYUmhCUU5hR2pERFJ2LXRjQ3dFelpMd3ZzcFVJeVR6WWZKZWZWaHU2d3VLN0NXR0FuY2hadHhfOGp0LVpUbzh3V2lmWG85UzUyLXlSY2d2QlNWb2g3dFpJUmlaZFJn</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/service-account.name: default</span><br><span class="line">    kubernetes.io/service-account.uid: c228f2c0-6e7a-4ed0-9ddc-084cfa6cf4fb</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T01:49:12Z&quot;</span><br><span class="line">  name: default-token-tcwxj</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;409&quot;</span><br><span class="line">  uid: d08bd61f-4cbb-4060-bbec-9f3c902e9890</span><br><span class="line">type: kubernetes.io/service-account-token</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>存储卷</code>可以将<code>外挂存储</code>挂载到 Pod 内使用</p>
</blockquote>
<ol>
<li><code>Volume</code>：定义 Pod 可以使用的<code>存储卷来源</code></li>
<li><code>VolumeMounts</code>：定义存储卷<code>如何 Mount</code> 到容器内部</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k exec nginx-volume -- ls -d /data</span><br><span class="line">/data</span><br></pre></td></tr></table></figure>

<blockquote>
<p>资源限制：通过 <code>Cgroups</code> 提供容器资源管理的功能，可以限制每个<code>容器</code>的 <code>CPU</code> 和<code>内存</code>使用</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ k set resources deployment nginx-deployment -c=nginx --limits=cpu=500m,memory=128Mi</span><br><span class="line">deployment.apps/nginx-deployment resource requirements updated</span><br><span class="line"></span><br><span class="line">$ k get deployments.apps nginx-deployment -oyaml</span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">    ...</span><br><span class="line">  template:</span><br><span class="line">    ...</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: nginx</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 128Mi</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>健康检查，探活方式：<code>Exec</code>、<code>TCP socket</code>、<code>HTTP</code></p>
</blockquote>
<blockquote>
<p><code>StartupProbe</code> 类似于 <code>ReadinessProbe</code>，但检查<code>频率更低</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>探针</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>LivenessProbe</code></td>
<td>探测应用是否处于<code>健康</code>状态，如果不健康则<code>删除</code>并<code>重新创建</code>容器</td>
</tr>
<tr>
<td><code>ReadinessProbe</code></td>
<td>探测应用是否<code>就绪</code>并且处于<code>正常服务</code>状态，如果不正常不会接收到 <code>K8S Service</code> 的<code>流量</code></td>
</tr>
<tr>
<td><code>StartupProbe</code></td>
<td>探测应用是否<code>启动完成</code><br />如果在 <code>failureThreshold × periodSeconds</code> 内未就绪，应用进程会被<code>重启</code></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ k get po nginx-deployment-6d8f8db69-ddsnb -oyaml</span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    livenessProbe:</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /</span><br><span class="line">        port: 80</span><br><span class="line">        scheme: HTTP</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">      successThreshold: 1</span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">    name: nginx</span><br><span class="line">    readinessProbe:</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /</span><br><span class="line">        port: 80</span><br><span class="line">        scheme: HTTP</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">      successThreshold: 1</span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><ol>
<li>ConfigMap 将<code>非机密性</code>的数据保存在 <code>KV</code> 中</li>
<li>Pod 将 ConfigMap 用作<code>环境变量</code>、<code>命令行参数</code>、<code>存储卷中的配置文件</code></li>
<li>ConfigMap 将<code>配置信息</code>和<code>容器镜像</code>进行了<code>解耦</code></li>
</ol>
<h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><ol>
<li>Secret 用来保存<code>敏感信息</code>：密码、密钥、认证凭证等</li>
<li>优势：意图明显、避免重复、减少暴露机会</li>
</ol>
<h3 id="SA"><a href="#SA" class="headerlink" title="SA"></a>SA</h3><blockquote>
<p>User Account + Service Account</p>
</blockquote>
<blockquote>
<p>与 API Server 通信，需要进行<code>认证鉴权</code></p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>User Account</th>
<th>Service Account</th>
</tr>
</thead>
<tbody><tr>
<td>用途</td>
<td>为<code>人</code>提供账号标识</td>
<td>为<code>计算机进程</code>或者集群中运行的 <code>Pod</code> 提供账号标识</td>
</tr>
<tr>
<td>作用范围</td>
<td>与 Namespace <code>无关</code></td>
<td>与 Namespace <code>相关</code></td>
</tr>
</tbody></table>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230604011545130.png" alt="image-20230604011545130"></p>
<ol>
<li>Service 是<code>应用服务的抽象</code>，通过 <code>Label</code> 为应用提供<code>负载均衡</code>和<code>服务发现</code><ul>
<li><code>匹配</code> Label 的 <code>Pod IP</code> 和 <code>Pod Port</code> 列表组成 <code>Endpoints</code>，</li>
<li>由 <code>Kube-proxy</code> 负责将<code>服务 IP</code> 负载均衡到 <code>Endpoints</code> 上</li>
</ul>
</li>
<li>每个 Service 都会自动分配一个 <code>Cluster IP</code>（仅<code>集群内</code>可访问的虚拟地址） 和 <code>DNS 域名</code></li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8078</span> <span class="comment"># the port that this service should serve on</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span> <span class="comment"># the container on each pod to connect to, can be a name (e.g. &#x27;www&#x27;) or a number (e.g. 80)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ k get svc</span><br><span class="line">NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes         ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        41m</span><br><span class="line">nginx              ClusterIP   10.104.195.232   &lt;none&gt;        8078/TCP       27s</span><br><span class="line">nginx-deployment   NodePort    10.105.14.129    &lt;none&gt;        80:31834/TCP   7m56s</span><br><span class="line"></span><br><span class="line">$ curl -sI 10.104.195.232:8078</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.0</span><br><span class="line">Date: Tue, 30 May 2022 02:31:04 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 23 May 2022 15:08:20 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;646cd6e4-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h3><ol>
<li>Pod 只是<code>单个应用实例</code>的抽象，要构建<code>高可用</code>应用，需要构建<code>多个副本</code>来提供<code>同一个服务</code></li>
<li>K8S 抽象出 ReplicaSet，每个 Pod 都会被当作一个<code>无状态</code>的成员进行管理<ul>
<li>允许用户定义<code>副本数</code>，K8S 保证用户期望的数量的 Pod 正常运行</li>
</ul>
</li>
</ol>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><ol>
<li>Deployment 表示用户对 K8S 集群的<code>一次更新操作</code></li>
<li><code>滚动更新</code><ul>
<li>创建一个新的 ReplicaSet</li>
<li>然后逐渐将新 ReplicaSet 中的副本数增加到理想状态，将旧的 ReplicaSet 中的副本数减少到 0</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230604143501615.png" alt="image-20230604143501615"></p>
<h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><ol>
<li>对于 StatefulSet 中的 Pod，每个 Pod 挂载自己<code>独立的存储</code><ul>
<li>如果一个 Pod 出现故障，从<code>其它节点</code>启动一个<code>同样名字</code>的 Pod</li>
<li>需要挂载上<code>原来 Pod 的存储</code>，继续以它的状态提供服务</li>
</ul>
</li>
<li><code>高可用</code><ul>
<li><code>Pod</code> 仍然可以通过<code>漂移到不同节点</code>提供<code>高可用</code>，而<code>存储</code>可以通过<code>外挂存储</code>来提供<code>高可靠性</code></li>
<li>StatefulSet 只是将<code>确定的 Pod</code> 和<code>确定的存储</code>关联起来，保证<code>状态的连续性</code></li>
</ul>
</li>
<li>适合 StatefulSet 的业务<ul>
<li>数据库服务：MySQL、PostgreSQL</li>
<li>集群化管理服务：ZooKeeper、etcd</li>
</ul>
</li>
<li>与 Deployment 的差异<ul>
<li><code>身份标识</code><ul>
<li>StatefulSet Controller 为每个 Pod 编号，<code>序号从 0 开始</code></li>
</ul>
</li>
<li><code>数据存储</code><ul>
<li>StatefulSet 允许用户定义 <code>volumeClaimTemplates</code></li>
<li>当 Pod 被<code>创建</code>的同时，K8S 会以 <code>volumeClaimTemplates</code> 中定义的模板创建存储卷，并挂载给 Pod</li>
</ul>
</li>
<li><code>升级策略</code><ul>
<li><code>onDelete</code>、<code>滚动升级</code>、<code>分片升级</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230604144821831.png" alt="image-20230604144821831"></p>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><ol>
<li>Job 是 K8S 用来控制<code>批处理任务</code>的 API 对象</li>
<li>Job 管理的 Pod 根据用户的设置，把<code>任务完成</code>后<code>自动退出</code></li>
<li>成功完成的标志根据不同的 <code>spec.completions</code> 策略而不同<ul>
<li><code>单 Pod</code> 型任务：有一个 Pod 成功就标志完成</li>
<li><code>定数</code>成功型任务：保证有 N 个任务全部成功</li>
<li><code>工作队列</code>型任务：根据应用确认的<code>全局成功</code>而标志成功</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230604145943889.png" alt="image-20230604145943889"></p>
<h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><ol>
<li>DaemonSet 保证每个 <code>Node</code> 上都有一个此类 Pod 运行</li>
<li>Node 可能是<code>所有集群节点</code>，也可能是通过 <code>nodeSelector</code> 选定的一些特定集群节点</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230604150318331.png" alt="image-20230604150318331"></p>
<h3 id="PV-PVC"><a href="#PV-PVC" class="headerlink" title="PV + PVC"></a>PV + PVC</h3><ol>
<li>PersistentVolume 是集群中的一块存储卷<ul>
<li>可以由管理员<code>手动设置</code></li>
<li>当用户创建 <code>PersistentVolumeClaim</code> 时根据 <code>StorageClass</code> 来<code>动态设置</code></li>
</ul>
</li>
<li><code>PV 和 PVC 与 Pod 的生命周期无关</code></li>
<li>对于不同的使用场景，需要设置<code>不同属性</code>（性能、访问模式等）的 <code>PV</code></li>
</ol>
<h3 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h3><blockquote>
<p>CRD：<code>CustomResourceDefinition</code></p>
</blockquote>
<ol>
<li>CRD 类似于数据库的开放式表结构，允许用户<code>自定义 Schema</code><ul>
<li>用户可以基于 CRD 定义一切需要的模型，满足不同业务的需求</li>
</ul>
</li>
<li>基于 CRD 构建的主流扩展应用：Istio、Knative</li>
<li>基于 CRD 推出了 <code>Operator Mode</code> 和 <code>Operator SDK</code><ul>
<li>极低的开发成本：<code>定义新对象</code> + <code>构建新对象的控制器</code></li>
</ul>
</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/01/cloud-native-foundation-k8s-architectural-principles/">https://blog.zhongmingmao.top/2022/12/01/cloud-native-foundation-k8s-architectural-principles/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/02/cloud-native-foundation-k8s-etcd/" title="Kubernetes - etcd"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/etcd-5874937.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes - etcd</div></div></a></div><div class="next-post pull-right"><a href="/2022/11/08/cloud-native-foundation-k8s-cgroups/" title="Kubernetes - Cgroups"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/FrbadS8XgAAtfvr.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Kubernetes - Cgroups</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/12/15/cloud-native-foundation-k8s-devops/" title="Kubernetes - DevOps"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/devops.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-15</div><div class="title">Kubernetes - DevOps</div></div></a></div><div><a href="/2022/12/14/cloud-native-foundation-k8s-production-ops/" title="Kubernetes - Production Ops"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-ops.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-14</div><div class="title">Kubernetes - Production Ops</div></div></a></div><div><a href="/2022/12/13/cloud-native-foundation-k8s-manage-production-clusters/" title="Kubernetes - Manage Production Clusters"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/2bc58949d451b7e5f8f8759c44d962d01b2ed48d-1108x1108.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-13</div><div class="title">Kubernetes - Manage Production Clusters</div></div></a></div><div><a href="/2022/12/12/cloud-native-foundation-k8s-service-discovery/" title="Kubernetes - Service Discovery"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-service-discovery.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">Kubernetes - Service Discovery</div></div></a></div><div><a href="/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/" title="Kubernetes - Pod Life Cycle"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/pod-life-cycle.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-10</div><div class="title">Kubernetes - Pod Life Cycle</div></div></a></div><div><a href="/2022/12/09/cloud-native-foundation-k8s-csi/" title="Kubernetes - CSI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-csi.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-09</div><div class="title">Kubernetes - CSI</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">482</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">125</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">65</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">1.</span> <span class="toc-text">主要功能</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%BC%8F-vs-%E5%A3%B0%E6%98%8E%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">命令式 vs 声明式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.</span> <span class="toc-text">核心对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text">核心架构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Master"><span class="toc-number">5.1.</span> <span class="toc-text">Master</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Worker"><span class="toc-number">5.2.</span> <span class="toc-text">Worker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#etcd"><span class="toc-number">5.3.</span> <span class="toc-text">etcd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-Server"><span class="toc-number">5.4.</span> <span class="toc-text">API Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Controller-Manager"><span class="toc-number">5.5.</span> <span class="toc-text">Controller Manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">5.5.1.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Informer"><span class="toc-number">5.5.2.</span> <span class="toc-text">Informer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E5%8F%B8%E5%85%B6%E8%81%8C"><span class="toc-number">5.5.3.</span> <span class="toc-text">各司其职</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scheduler"><span class="toc-number">5.6.</span> <span class="toc-text">Scheduler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubelet"><span class="toc-number">5.7.</span> <span class="toc-text">Kubelet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kube-Proxy"><span class="toc-number">5.8.</span> <span class="toc-text">Kube-Proxy</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Add-ons"><span class="toc-number">6.</span> <span class="toc-text">Add-ons</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubectl"><span class="toc-number">7.</span> <span class="toc-text">kubectl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">7.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">7.2.</span> <span class="toc-text">常用命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">8.</span> <span class="toc-text">设计思想</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#API-%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.</span> <span class="toc-text">API 对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7"><span class="toc-number">9.1.</span> <span class="toc-text">属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TypeMeta"><span class="toc-number">9.1.1.</span> <span class="toc-text">TypeMeta</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MetaData"><span class="toc-number">9.1.2.</span> <span class="toc-text">MetaData</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spec"><span class="toc-number">9.1.3.</span> <span class="toc-text">Spec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Status"><span class="toc-number">9.1.4.</span> <span class="toc-text">Status</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.2.</span> <span class="toc-text">对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Node"><span class="toc-number">9.2.1.</span> <span class="toc-text">Node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Namespace"><span class="toc-number">9.2.2.</span> <span class="toc-text">Namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod"><span class="toc-number">9.2.3.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigMap"><span class="toc-number">9.2.4.</span> <span class="toc-text">ConfigMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Secret"><span class="toc-number">9.2.5.</span> <span class="toc-text">Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SA"><span class="toc-number">9.2.6.</span> <span class="toc-text">SA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">9.2.7.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">9.2.8.</span> <span class="toc-text">ReplicaSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment"><span class="toc-number">9.2.9.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StatefulSet"><span class="toc-number">9.2.10.</span> <span class="toc-text">StatefulSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job"><span class="toc-number">9.2.11.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DaemonSet"><span class="toc-number">9.2.12.</span> <span class="toc-text">DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PV-PVC"><span class="toc-number">9.2.13.</span> <span class="toc-text">PV + PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CRD"><span class="toc-number">9.2.14.</span> <span class="toc-text">CRD</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/24/go-foundation-type-parameter/" title="Go - Type Parameter"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-generics-01.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Type Parameter"/></a><div class="content"><a class="title" href="/2023/01/24/go-foundation-type-parameter/" title="Go - Type Parameter">Go - Type Parameter</a><time datetime="2023-01-23T16:06:25.000Z" title="Created 2023-01-24 00:06:25">2023-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/23/go-foundation-gc/" title="Go - GC"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-gc-1533114.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - GC"/></a><div class="content"><a class="title" href="/2023/01/23/go-foundation-gc/" title="Go - GC">Go - GC</a><time datetime="2023-01-22T16:06:25.000Z" title="Created 2023-01-23 00:06:25">2023-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/22/go-foundation-module-maintainer/" title="Go - Module Maintainer"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-module-02.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Module Maintainer"/></a><div class="content"><a class="title" href="/2023/01/22/go-foundation-module-maintainer/" title="Go - Module Maintainer">Go - Module Maintainer</a><time datetime="2023-01-21T16:06:25.000Z" title="Created 2023-01-22 00:06:25">2023-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/21/go-foundation-generics/" title="Go - Generics"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-generics.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Generics"/></a><div class="content"><a class="title" href="/2023/01/21/go-foundation-generics/" title="Go - Generics">Go - Generics</a><time datetime="2023-01-20T16:06:25.000Z" title="Created 2023-01-21 00:06:25">2023-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/20/go-foundation-private-module/" title="Go - Private Module"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-modules.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Private Module"/></a><div class="content"><a class="title" href="/2023/01/20/go-foundation-private-module/" title="Go - Private Module">Go - Private Module</a><time datetime="2023-01-19T16:06:25.000Z" title="Created 2023-01-20 00:06:25">2023-01-20</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2023 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - Service Discovery | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="基本概念发展历程">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Service Discovery">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/12/cloud-native-foundation-k8s-service-discovery/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="基本概念发展历程">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-service-discovery.jpeg">
<meta property="article:published_time" content="2022-12-11T16:06:25.000Z">
<meta property="article:modified_time" content="2023-09-24T14:05:19.502Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cloud Native Foundation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-service-discovery.jpeg"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/12/cloud-native-foundation-k8s-service-discovery/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - Service Discovery',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-24 22:05:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">560</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">179</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">73</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-service-discovery.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - Service Discovery</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-12-11T16:06:25.000Z" title="Created 2022-12-12 00:06:25">2022-12-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">12.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>64min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><h2 id="发展历程"><a href="#发展历程" class="headerlink" title="发展历程"></a>发展历程</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920204247842.png" alt="image-20230920204247842"></p>
<span id="more"></span>

<h2 id="数据包"><a href="#数据包" class="headerlink" title="数据包"></a>数据包</h2><blockquote>
<p>负载均衡的核心原理 - <code>修改包头数据</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230830203557222.png" alt="image-20230830203557222"></p>
<blockquote>
<p>通过浏览器访问某网站的过程（<code>组包</code>在<code>应用</code>层，<code>传包</code>在<code>内核</code>层）</p>
</blockquote>
<ol>
<li>在浏览器输入网站的网址<ul>
<li>浏览器本质上是一个 HTTP 客户端，组装成 HTTP 包</li>
</ul>
</li>
<li>做 DNS 解析（递归）</li>
<li>封装 TCP 包（源端口 + 目标端口）</li>
<li>封装 IP 包（源 IP + 目标 IP - <code>来自于 DNS</code>）</li>
</ol>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><blockquote>
<p>面向连接的负载均衡不一定能保证平均，如 grpc 是基于 http&#x2F;2，会复用 TCP 连接，L4 的负载均衡就无法实现平均</p>
</blockquote>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><h3 id="集中式"><a href="#集中式" class="headerlink" title="集中式"></a>集中式</h3><blockquote>
<p>F5（HLB） &#x2F; Nginx（SLB） - 接入集群外部流量</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920205129072.png" alt="image-20230920205129072"></p>
<ol>
<li>在服务消费者和服务提供者之间有一个<code>独立</code>的 LB</li>
<li><code>LB</code> 上有所有服务的地址映射表，通常由<code>运维</code>配置注册</li>
<li>当服务消费者调用某个目标服务时，向 LB 发起请求，由 LB 以某种策略做<code>负载均衡</code>后将请求转发到目标服务</li>
<li>LB 一般具备<code>健康检查</code>的能力，能<code>自动摘除</code>不健康的服务实例</li>
<li>服务消费者通过 <code>DNS</code> 发现 LB，运维人员配置一个指向该 LB 的 DNS 域名</li>
<li>优缺点<ul>
<li>优点<ul>
<li>方案简单，在 LB 上容易实现<code>集中式</code>的访问控制，为业界主流</li>
</ul>
</li>
<li>缺点<ul>
<li><code>单点</code>问题，LB 容易成为<code>性能瓶颈</code></li>
<li>服务调用<code>增加 1 跳</code>的性能开销</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="进程内"><a href="#进程内" class="headerlink" title="进程内"></a>进程内</h3><blockquote>
<p>集群内部 - 微服务流量治理</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920210850551.png" alt="image-20230920210850551"></p>
<ol>
<li>将 LB 的功能以<code>库</code>的形式集成到<code>服务消费者</code>进程里面，也称为<code>客户端负载均衡</code></li>
<li><code>Service Registry</code> 配合支持<code>服务注册</code>和<code>服务发现</code><ul>
<li>服务提供者启动时，首先将服务地址注册到 Service Registry，并定时上报心跳保活</li>
</ul>
</li>
<li>服务消费者要访问某个服务时<ul>
<li>通过<code>内置</code>的 LB 组件向 Service Registry 查询（同时<code>缓存</code>并<code>定时刷新</code>）目标服务的地址列表</li>
<li>然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求</li>
</ul>
</li>
<li>对 Service Registry 的 <code>HA</code> 要求很高，常用为 zookeeper、consul、etcd 等</li>
<li>优缺点<ul>
<li>优点<ul>
<li>性能较好 - LB 和服务发现能力被<code>分散</code>到每一个服务消费者的进程内部，同时直接进行服务调用，没有额外开销</li>
</ul>
</li>
<li>缺点<ul>
<li>可能需要维护多种语言的客户端</li>
<li>内嵌到服务消费者，客户端升级成本较大</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Sidecar"><a href="#Sidecar" class="headerlink" title="Sidecar"></a>Sidecar</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920212859960.png" alt="image-20230920212859960"></p>
<ol>
<li>将 LB 和服务发现功能从服务消费者进程剥离，变成主机上的一个<code>独立进程</code><ul>
<li>服务消费者要访问目标服务时，需要通过<code>同一主机上独立的 LB 进程</code>做服务发现和负载均衡</li>
</ul>
</li>
<li>LB 独立进程可以进一步与服务消费者进行解耦，以<code>独立集群</code>的形式提供<code>高可用</code>的负载均衡服务</li>
<li>优缺点<ul>
<li>优点<ul>
<li>无单点问题，只会影响<code>同一主机</code>上的服务消费者</li>
<li>服务消费者和 LB 之间是<code>进程间调用</code>，性能好</li>
<li>不需要为不同的语言开发不同的库，LB 可<code>单独升级</code></li>
</ul>
</li>
<li>缺点<ul>
<li>部署复杂，问题排查不方便</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><ol>
<li>解决并发压力，提高应用<code>处理性能</code>，增加吞吐量，加强网络处理能力</li>
<li>提供 <code>Failover</code>，实现 <code>HA</code></li>
<li>实现<code>横向扩展</code>，增强应用的<code>弹性</code>能力</li>
<li><code>安全防护</code>，可以在 LB 上做一些过滤等处理</li>
</ol>
<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><blockquote>
<p>最早的负载均衡技术，在 DNS 服务器，配置多个 <code>A 记录</code>，这些 A 记录对应的服务器构成集群</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920215022414.png" alt="image-20230920215022414"></p>
<ol>
<li><p>优点</p>
<ul>
<li>使用简单，负载均衡交给 DNS 服务器</li>
<li><code>加速访问</code>，可以实现基于<code>地址</code>的域名解析</li>
</ul>
</li>
<li><p>缺点</p>
<ul>
<li><p><code>TTL</code></p>
<ul>
<li>进程有可能一直使用第一个 A 记录，直到该 A 记录失效</li>
</ul>
</li>
<li><p><code>可用性差</code></p>
<ul>
<li>DNS 解析为<code>多级解析</code>，修改 DNS 后，解析时间较长，解析过程中，用户访问网站将失败</li>
</ul>
</li>
<li><p><code>扩展性低</code></p>
<ul>
<li>控制权在<code>域名商</code></li>
</ul>
</li>
<li><p><code>维护性差</code></p>
<ul>
<li>不能反映服务器的当前运行状态，支持算法少，不能区分服务器的差异</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="相关技术"><a href="#相关技术" class="headerlink" title="相关技术"></a>相关技术</h2><blockquote>
<p>现阶段，重点关注 <code>NAT</code> 和 <code>Tunnel</code> 即可</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920220311289.png" alt="image-20230920220311289"></p>
<h3 id="网络层-NAT"><a href="#网络层-NAT" class="headerlink" title="网络层 - NAT"></a>网络层 - NAT</h3><blockquote>
<p><code>不修改 TCP 连接</code>，通过修改数据包的源地址（<code>SNAT</code>）或目标地址（<code>DNAT</code>）来控制数据包的转发行为</p>
</blockquote>
<blockquote>
<p><code>丢失原始客户端的 IP 地址</code>，上游服务器只能感知到<code>负载均衡器</code>，而无法感知到<code>原始客户端</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920221310309.png" alt="image-20230920221310309"></p>
<ol>
<li>客户端访问负载均衡器的 VIP，即 <code>IP2:PORT2</code></li>
<li>负载均衡器不会修改 TCP 连接<ul>
<li>而是修改数据包包头的源地址和目标地址为负载均衡器自身的 IP 端口（即 <code>IP3:PORT3</code>）和上游服务器的 IP 端口</li>
</ul>
</li>
<li>上游服务器处理完后，再将数据包返回给负载均衡器</li>
<li>负载均衡器会记录 <code>Connection Table</code>，会找到 3-4 对应的连接是 1-2，最终将数据返回给原始客户端</li>
</ol>
<h3 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h3><blockquote>
<p>让上游服务器能够感知到原始客户端，基于传输层的负载均衡，<code>将相关信息写入新建 TCP 连接的数据包</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920222414654.png" alt="image-20230920222414654"></p>
<ol>
<li>负载均衡器真实监听端口 <code>IP2:PORT2</code></li>
<li>实现方式<ul>
<li>利用<code>空闲的 TCP Options</code> 记录原始的客户端信息 - 需要 <code>Linux Kernel</code> 支持<ul>
<li><code>Tcp Proxy Protocol</code> 也预留了空间，在 TCP 数据包的前段</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="链路层"><a href="#链路层" class="headerlink" title="链路层"></a>链路层</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230920223804880.png" alt="image-20230920223804880"></p>
<ol>
<li><p>数据分发时，<code>不修改 IP 地址</code>，而是修改<code>目标 Mac 地址</code></p>
<ul>
<li><code>上游服务器 VIP</code> 和<code>负载均衡器 VIP</code> 要保持<code>一致</code></li>
<li>不修改数据包的源地址和目标地址，进行数据分发</li>
</ul>
</li>
<li><p>实际处理服务器 IP 和数据请求目的 IP 一致</p>
<ul>
<li><p>回包不再需要经过负载均衡器进行<code>地址转换</code>，可将响应数据包直接返回给用户浏览器</p>
</li>
<li><p>避免负载均衡服务器网卡带宽成为瓶颈，也称为<code>直接路由模式</code></p>
</li>
</ul>
</li>
<li><p>只改 Mac 地址，源地址和目标地址没有改变，可以直接回包</p>
<ul>
<li>进包 - 负载均衡，修改 Mac 地址</li>
<li>出包 - 直接路由回包</li>
</ul>
</li>
<li><p>优缺点</p>
<ul>
<li>优点<ul>
<li>性能很好</li>
</ul>
</li>
<li>缺点<ul>
<li>客户端、负载均衡器、上游服务器都必须在<code>同一个子网</code>，且<code>配置很复杂</code>，不常用</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="隧道-Tunnel"><a href="#隧道-Tunnel" class="headerlink" title="隧道 - Tunnel"></a>隧道 - Tunnel</h3><blockquote>
<p>链路与链路层负载均衡类似，<code>负载均衡器</code>负责<code>封包</code>，<code>上游服务器解包</code>后，<code>直接回包</code>给客户端，性能也很好</p>
</blockquote>
<ol>
<li>负载均衡中常用的隧道技术是 <code>IP in IP Tunneling</code><ul>
<li>保持原始数据包的 IP 头不变，在 IP 头外层增加额外的 IP 头后转发到上游服务器</li>
</ul>
</li>
<li>上游服务器接收到 IP 数据包后，解开外层 IP 包头后，剩下的是原始数据包</li>
<li>上游服务器处理完数据请求后，响应包通过网关直接返回给客户端</li>
</ol>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><h2 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h2><blockquote>
<p>用于描述负载均衡</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol>
<li>Selector<ul>
<li>Kubernetes 允许将 <code>Pod</code> 对象通过 <code>Label</code> 进行标记</li>
<li>通过 Service Selector 定义基于 <code>Pod Label</code> 的<code>过滤</code>规则，来选择 Service 的 <code>Upstream</code></li>
</ul>
</li>
<li>Ports<ul>
<li>定义<code>协议</code>和<code>端口</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>Service 实际上是要配置负载均衡，监听一个 <code>VIP:PORT</code>，然后做 <code>NAT</code><br>Upstream 的 Port 即 <code>targetPort</code>，Upstream 的 IP 即 Selector 匹配到的 <code>Pod IP</code></p>
</blockquote>
<h2 id="Endpoint"><a href="#Endpoint" class="headerlink" title="Endpoint"></a>Endpoint</h2><blockquote>
<p>Endpoint 是<code>中间</code>对象，用于处理<code>多对多</code>（<code>Service</code> 对 <code>Pod</code>）的关系</p>
</blockquote>
<blockquote>
<p>kube-proxy 会监听 <code>Service</code> 对象和 <code>Endpoint</code> 对象，调用本机的接口去配置本机的<code>负载均衡</code><br>kube-proxy 的配置在所有 <code>Node</code> 上要<code>一致</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoint</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.21</span></span><br><span class="line">        <span class="attr">nodeName:</span> <span class="string">minikube</span></span><br><span class="line">        <span class="attr">targetRef:</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-deployment-5754944d6c-hnw27</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">resourceVersion:</span> <span class="string">&#x27;722191&#x27;</span></span><br><span class="line">          <span class="attr">uid:</span> <span class="string">8a3390ae-2f8e-47bf-b8dd-70fae7fb0d32</span></span><br></pre></td></tr></table></figure>

<ol>
<li>当 Service 的 Selector 不为空时<ul>
<li><code>Kubernetes Endpoint Controller</code> 会监听 <code>Service</code> 的<code>创建</code>事件，创建与 Service <code>同名</code>的 Endpoint 对象</li>
</ul>
</li>
<li>Selector 能够选取的所有 <code>Pod IP</code> 都会被配置到 <code>Address</code> 属性中<ul>
<li>如果 Selector <code>查询不到</code>匹配的 Pod，则 Address 列表为<code>空</code></li>
<li>默认情况下，如果对应的 Pod 为 <code>Not Ready</code> 状态，对应的 Pod IP 只会出现在 subsets 的 <code>notReadyAddresses</code><ul>
<li>意味着对应的 Pod 还未准备好提供服务，不能作为<code>流量转发</code>的目标</li>
</ul>
</li>
<li>如果设置了 <code>PublishNotReadyAddress</code> 为 true，则无论 Pod 是否就绪都会被加入 <code>addresses</code>（接收流量）</li>
</ul>
</li>
</ol>
<blockquote>
<p>Deployment</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>nginx-deploy.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">exec:</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f nginx-deploy.yaml</span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-7b89c988df-tmpl8   0/1     Running   0          7s    192.168.185.14   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k describe po nginx-deployment-7b89c988df-tmpl8</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age               From               Message</span><br><span class="line">  ----     ------     ----              ----               -------</span><br><span class="line">  Normal   Scheduled  38s               default-scheduler  Successfully assigned default/nginx-deployment-7b89c988df-tmpl8 to mac-k8s</span><br><span class="line">  Normal   Pulled     38s               kubelet            Container image &quot;nginx:1.25.2&quot; already present on machine</span><br><span class="line">  Normal   Created    38s               kubelet            Created container nginx</span><br><span class="line">  Normal   Started    38s               kubelet            Started container nginx</span><br><span class="line">  Warning  Unhealthy  4s (x6 over 29s)  kubelet            Readiness probe failed: cat: /tmp/healthy: No such file or directory</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Service</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>service.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f service.yaml</span><br><span class="line">service/nginx-basic created</span><br><span class="line"></span><br><span class="line">$ k get service -owide</span><br><span class="line">NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   24d   &lt;none&gt;</span><br><span class="line">nginx-basic   ClusterIP   10.100.49.21   &lt;none&gt;        80/TCP    20s   app=nginx</span><br><span class="line"></span><br><span class="line">$ k get endpoints -owide</span><br><span class="line">NAME          ENDPOINTS              AGE</span><br><span class="line">kubernetes    192.168.191.153:6443   24d</span><br><span class="line">nginx-basic                          47s</span><br><span class="line"></span><br><span class="line">$ curl -v 10.100.49.21:80</span><br><span class="line">*   Trying 10.100.49.21:80...</span><br><span class="line">* connect to 10.100.49.21 port 80 failed: Connection refused</span><br><span class="line">* Failed to connect to 10.100.49.21 port 80 after 1006 ms: Connection refused</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (7) Failed to connect to 10.100.49.21 port 80 after 1006 ms: Connection refused</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;nginx-basic&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;ports&quot;:[&#123;&quot;name&quot;:&quot;http&quot;,&quot;port&quot;:80,&quot;protocol&quot;:&quot;TCP&quot;&#125;],&quot;selector&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;type&quot;:&quot;ClusterIP&quot;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-21T14:26:13Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;11697&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">e67ad8a5-36f7-421e-9ebf-27618ae92207</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">endpoints.kubernetes.io/last-change-trigger-time:</span> <span class="string">&quot;2022-09-21T14:26:13Z&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-21T14:26:13Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;11698&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">9401e4ba-612f-49aa-8404-c418863407f5</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">notReadyAddresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.14</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-7b89c988df-tmpl8</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;11433&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">0d47f22e-c5b9-4852-adac-10eb5ffaaf61</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k scale deployment nginx-deployment --replicas=2</span><br><span class="line">deployment.apps/nginx-deployment scaled</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE    IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-7b89c988df-tmpl8   0/1     Running   0          8m8s   192.168.185.14   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-7b89c988df-z86bc   0/1     Running   0          18s    192.168.185.15   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">endpoints.kubernetes.io/last-change-trigger-time:</span> <span class="string">&quot;2022-09-21T14:31:41Z&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-21T14:26:13Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;12281&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">9401e4ba-612f-49aa-8404-c418863407f5</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">notReadyAddresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.14</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-7b89c988df-tmpl8</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;11433&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">0d47f22e-c5b9-4852-adac-10eb5ffaaf61</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.15</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-7b89c988df-z86bc</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;12280&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">1df5dd0a-dccf-41e3-93bb-7313f5a9c51e</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使得某个 Pod 变成 Ready</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it nginx-deployment-7b89c988df-tmpl8 -- touch /tmp/healthy</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-7b89c988df-tmpl8   1/1     Running   0          11m     192.168.185.14   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-7b89c988df-z86bc   0/1     Running   0          3m50s   192.168.185.15   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get endpoints -owide</span><br><span class="line">NAME          ENDPOINTS              AGE</span><br><span class="line">kubernetes    192.168.191.153:6443   24d</span><br><span class="line">nginx-basic   192.168.185.14:80      9m47s</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">endpoints.kubernetes.io/last-change-trigger-time:</span> <span class="string">&quot;2022-09-21T14:35:16Z&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-21T14:26:13Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;12670&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">9401e4ba-612f-49aa-8404-c418863407f5</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.14</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-7b89c988df-tmpl8</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;12669&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">0d47f22e-c5b9-4852-adac-10eb5ffaaf61</span></span><br><span class="line">  <span class="attr">notReadyAddresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.15</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-7b89c988df-z86bc</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;12280&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">1df5dd0a-dccf-41e3-93bb-7313f5a9c51e</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sI 10.100.49.21:80</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">Date: Thu, 21 Sep 2022 14:37:08 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将 Service 的 PublishNotReadyAddress 设置为 true</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$  k get po -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-7b89c988df-tmpl8   1/1     Running   0          18m   192.168.185.14   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-7b89c988df-z86bc   0/1     Running   0          10m   192.168.185.15   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get endpoints nginx-basic -owide</span><br><span class="line">NAME          ENDPOINTS                             AGE</span><br><span class="line">nginx-basic   192.168.185.14:80,192.168.185.15:80   16m</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;nginx-basic&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;ports&quot;:[&#123;&quot;name&quot;:&quot;http&quot;,&quot;port&quot;:80,&quot;protocol&quot;:&quot;TCP&quot;&#125;],&quot;selector&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;type&quot;:&quot;ClusterIP&quot;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-21T14:26:13Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;13365&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">e67ad8a5-36f7-421e-9ebf-27618ae92207</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">publishNotReadyAddresses:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-21T14:26:13Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;13366&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">9401e4ba-612f-49aa-8404-c418863407f5</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.14</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-7b89c988df-tmpl8</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;12669&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">0d47f22e-c5b9-4852-adac-10eb5ffaaf61</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.15</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-7b89c988df-z86bc</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;12280&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">1df5dd0a-dccf-41e3-93bb-7313f5a9c51e</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<h2 id="EndpointSlice"><a href="#EndpointSlice" class="headerlink" title="EndpointSlice"></a>EndpointSlice</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">discovery.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EndpointSlice</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-abc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">addressType:</span> <span class="string">IPv4</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10.1.2.3&quot;</span></span><br><span class="line">    <span class="attr">conditions:</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">pod-1</span></span><br><span class="line">    <span class="attr">topology:</span></span><br><span class="line">      <span class="attr">kubernetes.io/hostname:</span> <span class="string">node-1</span></span><br><span class="line">      <span class="attr">topology.kubernetes.io/zone:</span> <span class="string">us-west2-a</span></span><br></pre></td></tr></table></figure>

<ol>
<li>当某个 Service 对应的 <code>Backend Pod 较多</code>时，Endpoint 对象会因为保存的地址信息过多而变得庞大</li>
<li>Pod 状态的变更会引起 Endpoint 的变更，而 <code>Endpoint 的变更会被推送到所有的 Node</code>，占用大量的<code>网络带宽</code></li>
<li>EndpointSlice 对 Pod 较多的 Endpoint 进行<code>切片</code>，切片大小可自定义</li>
</ol>
<h2 id="No-Selector"><a href="#No-Selector" class="headerlink" title="No Selector"></a>No Selector</h2><blockquote>
<p>创建了 Service 但不定义 Selector</p>
</blockquote>
<ol>
<li>Kubernetes Endpoint Controller <code>不会</code>为该 Service <code>自动创建</code> Endpoint</li>
<li>可以<code>手动创建 Endpoint 对象</code>（需要与 Service <code>同名</code>），并设置<code>任意 IP 地址</code>到 <code>Address</code></li>
<li>可以为<code>集群外</code>的一组 Endpoint 创建服务</li>
</ol>
<figure class="highlight yaml"><figcaption><span>service-without-selector.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-without-selector</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f service-without-selector.yaml</span><br><span class="line">service/service-without-selector created</span><br><span class="line"></span><br><span class="line">$ k get services -owide</span><br><span class="line">NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes                 ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   24d   &lt;none&gt;</span><br><span class="line">nginx-basic                ClusterIP   10.100.49.21    &lt;none&gt;        80/TCP    42m   app=nginx</span><br><span class="line">service-without-selector   ClusterIP   10.98.161.143   &lt;none&gt;        80/TCP    7s    &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get endpoints -owide</span><br><span class="line">NAME          ENDPOINTS                             AGE</span><br><span class="line">kubernetes    192.168.191.153:6443                  24d</span><br><span class="line">nginx-basic   192.168.185.14:80,192.168.185.15:80   43m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>指向集群外站点</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup blog.zhongmingmao.top</span><br><span class="line">Server:        127.0.0.53</span><br><span class="line">Address:    127.0.0.53#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:    blog.zhongmingmao.top</span><br><span class="line">Address: 172.67.185.241</span><br><span class="line">Name:    blog.zhongmingmao.top</span><br><span class="line">Address: 104.21.36.56</span><br><span class="line">Name:    blog.zhongmingmao.top</span><br><span class="line">Address: 2606:4700:3030::6815:2438</span><br><span class="line">Name:    blog.zhongmingmao.top</span><br><span class="line">Address: 2606:4700:3031::ac43:b9f1</span><br><span class="line"></span><br><span class="line">$ curl -sI 172.67.185.241:80</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Thu, 21 Sep 2022 15:17:20 GMT</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Content-Length: 16</span><br><span class="line">Connection: close</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Referrer-Policy: same-origin</span><br><span class="line">Cache-Control: private, max-age=0, no-store, no-cache, must-revalidate, post-check=0, pre-check=0</span><br><span class="line">Expires: Thu, 01 Jan 1970 00:00:01 GMT</span><br><span class="line">Server: cloudflare</span><br><span class="line">CF-RAY: 80a3464328b96e3f-HKG</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>service-without-selector-ep.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-without-selector</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">172.67</span><span class="number">.185</span><span class="number">.241</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f service-without-selector-ep.yaml</span><br><span class="line">endpoints/service-without-selector created</span><br><span class="line"></span><br><span class="line">$ k get services -owide</span><br><span class="line">NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes                 ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   24d   &lt;none&gt;</span><br><span class="line">nginx-basic                ClusterIP   10.100.49.21    &lt;none&gt;        80/TCP    54m   app=nginx</span><br><span class="line">service-without-selector   ClusterIP   10.98.161.143   &lt;none&gt;        80/TCP    11m   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get endpoints -owide</span><br><span class="line">NAME                       ENDPOINTS                             AGE</span><br><span class="line">kubernetes                 192.168.191.153:6443                  24d</span><br><span class="line">nginx-basic                192.168.185.14:80,192.168.185.15:80   54m</span><br><span class="line">service-without-selector   172.67.185.241:80                     47s</span><br><span class="line"></span><br><span class="line">$ curl -sI 10.98.161.143:80</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Thu, 21 Sep 2022 15:21:04 GMT</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Content-Length: 16</span><br><span class="line">Connection: close</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Referrer-Policy: same-origin</span><br><span class="line">Cache-Control: private, max-age=0, no-store, no-cache, must-revalidate, post-check=0, pre-check=0</span><br><span class="line">Expires: Thu, 01 Jan 1970 00:00:01 GMT</span><br><span class="line">Server: cloudflare</span><br><span class="line">CF-RAY: 80a34bb85a43195f-HKG</span><br></pre></td></tr></table></figure>

<h2 id="对应关系"><a href="#对应关系" class="headerlink" title="对应关系"></a>对应关系</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230921232228822.png" alt="image-20230921232228822"></p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><blockquote>
<p>包含关系：<code>ClusterIP</code> -&gt; <code>NodePort</code> -&gt; <code>LoadBalancer</code></p>
</blockquote>
<h3 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h3><ol>
<li>Service 的默认类型，服务被发布到<code>仅集群内部可见</code>的 <code>VIP</code> 上</li>
<li>在 <code>API Server</code> 启动时，需要通过 <code>service-cluster-ip-range</code> 参数来配置 <code>VIP 地址段</code><ul>
<li><code>API Server</code> 中有用于<code>分配 IP 地址和端口</code>的组件，当该组件<code>捕获 Service 对象并创建事件</code>时</li>
<li>会从配置的 <code>VIP 地址段</code>中取一个有效的 IP 地址，分配给该 Service 对象</li>
</ul>
</li>
<li>通过 API Server 创建 Service 时，ClusterIP 本身为空</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep &#x27;service-cluster-ip-range&#x27;</span><br><span class="line">    - --service-cluster-ip-range=10.96.0.0/12</span><br></pre></td></tr></table></figure>

<h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><ol>
<li>在 <code>API Server</code> 启动时，需要通过 <code>node-port-range</code> 参数配置 NodePort 的范围（默认值为 <code>30000 ~ 32767</code>）<ul>
<li>API Server 组件会<code>捕获 Service 对象并创建事件</code>时</li>
<li>会从配置好的 NodePort 范围取一个有效端口，分配被该 Service</li>
</ul>
</li>
<li>每个 <code>Node</code> 上的 <code>kube-proxy</code> 会尝试在 <code>Service</code> 分配的 <code>NodePort</code> 上建立<code>监听器</code>接收请求<ul>
<li>并转发给 Service 对应的 <code>Backend Pod</code></li>
</ul>
</li>
</ol>
<h3 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h3><ol>
<li><code>IDC</code> 一般会采购一些<code>负载均衡器</code>，作为<code>外网请求</code>进入 IDC 的统一流量入口<ul>
<li>需要配置外部的 LB，一般由<code>云厂商</code>提供</li>
</ul>
</li>
<li>针对不同的基础架构云平台，<code>Kubernetes Cloud Manager</code> 提供支持不同供应商 API 的 <code>Service Controller</code></li>
</ol>
<h3 id="Headless-Service"><a href="#Headless-Service" class="headerlink" title="Headless Service"></a>Headless Service</h3><blockquote>
<p>不配置 <code>VIP</code>，不需要<code>负载均衡</code>的能力</p>
</blockquote>
<ol>
<li>将 <code>ClusterIP</code> 显式定义为 <code>None</code></li>
<li>Kubernetes 不会为 Headless Service 分配<code>统一入口</code>，包括 ClusterIP、NodePort 等</li>
</ol>
<figure class="highlight yaml"><figcaption><span>headless-svc.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-headless</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f headless-svc.yaml</span><br><span class="line">service/nginx-headless created</span><br><span class="line"></span><br><span class="line">$ k get services -owide</span><br><span class="line">NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE    SELECTOR</span><br><span class="line">kubernetes                 ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   24d    &lt;none&gt;</span><br><span class="line">nginx-basic                ClusterIP   10.100.49.21    &lt;none&gt;        80/TCP    167m   app=nginx</span><br><span class="line">nginx-headless             ClusterIP   None            &lt;none&gt;        80/TCP    26s    app=nginx</span><br><span class="line">service-without-selector   ClusterIP   10.98.161.143   &lt;none&gt;        80/TCP    125m   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get endpoints -owide</span><br><span class="line">NAME                       ENDPOINTS                             AGE</span><br><span class="line">kubernetes                 192.168.191.153:6443                  24d</span><br><span class="line">nginx-basic                192.168.185.14:80,192.168.185.15:80   168m</span><br><span class="line">nginx-headless             192.168.185.14:80                     40s</span><br><span class="line">service-without-selector   172.67.185.241:80                     114m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问有 ClusterIP 的 Service，DNS 解析出其 <code>VIP</code>（<code>一条 A 记录</code>），再通过 <code>ipvs</code> 或者 <code>iptables</code> 做<code>负载均衡</code><br>而访问 Headless Service，DNS 解析出来的是 <code>Pod IP</code> 的<code>多条 A 记录</code>，本质上是通过 <code>DNS</code> 做<code>负载均衡</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it nginx-deployment-7b89c988df-tmpl8 -- curl -vsI nginx-basic.default</span><br><span class="line">*   Trying 10.100.49.21:80...</span><br><span class="line">* Connected to nginx-basic.default (10.100.49.21) port 80 (#0)</span><br><span class="line">&gt; HEAD / HTTP/1.1</span><br><span class="line">&gt; Host: nginx-basic.default</span><br><span class="line">&gt; User-Agent: curl/7.88.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">&lt; Server: nginx/1.25.2</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">&lt; Date: Thu, 21 Sep 2022 17:19:25 GMT</span><br><span class="line">Date: Thu, 21 Sep 2022 17:19:25 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 615</span><br><span class="line">Content-Length: 615</span><br><span class="line">&lt; Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">Connection: keep-alive</span><br><span class="line">&lt; ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">&lt;</span><br><span class="line">* Connection #0 to host nginx-basic.default left intact</span><br><span class="line"></span><br><span class="line">$ k exec -it nginx-deployment-7b89c988df-tmpl8 -- curl -vsI nginx-headless.default</span><br><span class="line">*   Trying 192.168.185.14:80...</span><br><span class="line">* Connected to nginx-headless.default (192.168.185.14) port 80 (#0)</span><br><span class="line">&gt; HEAD / HTTP/1.1</span><br><span class="line">&gt; Host: nginx-headless.default</span><br><span class="line">&gt; User-Agent: curl/7.88.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">&lt; Server: nginx/1.25.2</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">&lt; Date: Thu, 21 Sep 2022 17:19:59 GMT</span><br><span class="line">Date: Thu, 21 Sep 2022 17:19:59 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 615</span><br><span class="line">Content-Length: 615</span><br><span class="line">&lt; Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">Connection: keep-alive</span><br><span class="line">&lt; ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">&lt;</span><br><span class="line">* Connection #0 to host nginx-headless.default left intact</span><br></pre></td></tr></table></figure>

<h3 id="ExternalName-Service"><a href="#ExternalName-Service" class="headerlink" title="ExternalName Service"></a>ExternalName Service</h3><blockquote>
<p>相当于外部服务的 <code>cname</code></p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>service-external-name.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">tencent.com</span></span><br></pre></td></tr></table></figure>

<h2 id="Service-Topology"><a href="#Service-Topology" class="headerlink" title="Service Topology"></a>Service Topology</h2><ol>
<li>Kubernetes 提供<code>通用标签</code>来标记 <code>Node</code> 所处的<code>物理位置</code><ul>
<li>topology.kubernetes.io&#x2F;<code>zone</code>: us-west2-a</li>
<li>failure-domain.beta.kubernetes.io&#x2F;<code>region</code>: us-west</li>
<li>failure-domain.tess.io&#x2F;<code>network-device</code>: us-west05-ra053</li>
<li>failure-domain.tess.io&#x2F;<code>rack</code>: us_west02_02-314_19_12</li>
<li>kubernetes.io&#x2F;<code>hostname</code>: node-1</li>
</ul>
</li>
<li>Service 引入 <code>topologyKeys</code> 来控制<code>流量</code><ul>
<li>[“kubernetes.io&#x2F;<code>hostname</code>“]<ul>
<li>调用 Service 的客户端所在 Node 上如果有该 Service 的服务实例正在运行</li>
<li>则该服务实例处理请求，否则调用失败</li>
</ul>
</li>
<li>[“kubernetes.io&#x2F;<code>hostname</code>“, “topology.kubernetes.io&#x2F;<code>zone</code>“, “topology. kubernetes.io&#x2F;<code>region</code>“<ul>
<li>若同一 Node 上有对应的服务实例，则请求优先转发到该实例</li>
<li>否则，顺序查找<code>当前 zone</code> 以及<code>当前 region</code> 是否有该服务实例，并将请求<code>按顺序转发</code></li>
</ul>
</li>
<li>[“topology. kubernetes.io&#x2F;<code>region</code>“, “*”] <ul>
<li>请求会被优先转发到<code>当前 region</code> 的服务实例</li>
<li>如果当前 region 不存在服务实例，则请求会被转发到<code>任意服务实例</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>只在本机转发</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>topology-nodelocal.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nodelocal</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">topologyKeys:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>优先选择本机转发</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>topology-prefer-nodelocal.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prefer-nodelocal</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">topologyKeys:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;topology.kubernetes.io/zone&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;topology.kubernetes.io/region&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h1><blockquote>
<p>kube-proxy 为控制面组件，运行模式为 <code>Control-Loop</code></p>
</blockquote>
<blockquote>
<p><code>iptables</code> 专注于<code>防火墙</code>，而 <code>ipvs</code> 专注于<code>负载均衡</code></p>
</blockquote>
<ol>
<li>每个 <code>Node</code> 上都运行一个 kube-proxy 服务<ul>
<li>监听 <code>API Server</code> 中的 <code>Service</code> 和 <code>Endpoint</code> 的变化</li>
<li>并通过 <code>iptables</code> 等来为 Service 配置<code>负载均衡</code>（仅支持 <code>TCP</code> 和 <code>UDP</code>）</li>
</ul>
</li>
<li>kube-proxy 可以直接运行在 <code>Node</code> 上，也可以通过 <code>Static Pod</code> 或者 <code>DaemonSet</code> 的方式运行</li>
<li>kube-proxy 支持的实现方式<ul>
<li><code>userspace</code><ul>
<li><code>最早</code>的负载均衡方案</li>
<li>在<code>用户空间</code>监听一个<code>端口</code>，所有服务通过 <code>iptables</code> 转发到该端口，然后在其内部负载均衡到实际的 Pod</li>
<li>缺点<ul>
<li>效率低，有明显的<code>性能瓶颈</code></li>
<li>数据包先到 <code>Kernel</code>，再转到 <code>kube-proxy</code>（通过负载均衡选择一个 Pod IP），最后又回到 <code>Kernel</code></li>
</ul>
</li>
</ul>
</li>
<li><code>winuserspace</code><ul>
<li>同 userspace，仅工作在 Windows 上</li>
</ul>
</li>
<li><code>iptables</code><ul>
<li>目前<code>推荐</code>的方案，完全以 <code>iptables 规则</code>的方式来实现 Service 的负载均衡</li>
<li>Kernel 中的 TCP 协议栈本身可以通过 <code>Netfilter</code> 框架对数据包（<code>三层 / 四层</code>）做转发</li>
<li>缺点<ul>
<li>在 Service 多的时候会产生太多的 iptables 规则</li>
<li><code>非增量式更新</code>会引入一定的<code>延时</code>，在<code>大规模</code>的情况下会有明显的<code>性能问题</code></li>
</ul>
</li>
</ul>
</li>
<li><code>ipvs</code><ul>
<li>为了解决 <code>iptables</code> 模式的<code>性能</code>问题<ul>
<li>在 <code>v1.8</code> 新增了 ipvs 模式，采用<code>增量式更新</code>，并保证 <code>Service 更新期间连接保持不断开</code></li>
</ul>
</li>
<li>ipvs <code>专注于数据包处理</code>，但能力没有 iptables 丰富，因此很多能力需要<code>依托于 iptables</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get ds -n kube-system -owide</span><br><span class="line">NAME         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE   CONTAINERS   IMAGES                                                       SELECTOR</span><br><span class="line">kube-proxy   1         1         1       1            1           kubernetes.io/os=linux   26d   kube-proxy   registry.aliyuncs.com/google_containers/kube-proxy:v1.23.3   k8s-app=kube-proxy</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Cilium 基于 <code>eBPF</code>，完全<code>绕过</code>了 <code>TCP 协议栈</code>（Netfilter）</p>
</blockquote>
<h2 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h2><blockquote>
<p>NAT - 实现 Service 的负载均衡</p>
</blockquote>
<blockquote>
<p>routing decision 之前只能 nat 而不能 filter</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230923151325785.png" alt="image-20230923151325785"></p>
<h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230923153743183.png" alt="image-20230923153743183"></p>
<ol>
<li>网卡接收到数据包后，会给 CPU 发送硬件中断，唤醒 CPU</li>
<li>但 CPU 不会直接读取和处理数据包，响应硬件中断时，无法处理其它事项，效率非常低</li>
<li>因此 <code>CPU 会软中断 Kernel</code>，触发 SoftIRQ Handler 去读取数据包</li>
<li>SoftIRQ Handler 会在 Kernel 构造 SKB，然后再将 SKB 交给 Netfilter （TCP 协议栈）</li>
<li>Netfilter 会去读取并执行 kube-proxy 在<code>用户空间</code>定义的一些 iptables 规则</li>
</ol>
<blockquote>
<p>重点关注 <code>nat</code> 和 <code>filter</code> 规则</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230923164856642.png" alt="image-20230923164856642"></p>
<blockquote>
<p>锚点 - 针对负载均衡，主要关注 <code>PREROUTING</code> 和 <code>OUTPUT </code></p>
</blockquote>
<table>
<thead>
<tr>
<th>table &#x2F; chain</th>
<th><code>PREROUTING</code></th>
<th>INPUT</th>
<th>FOREORD</th>
<th><code>OUTPUT</code></th>
<th>POSTROUTING</th>
</tr>
</thead>
<tbody><tr>
<td>raw</td>
<td>Y</td>
<td></td>
<td></td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td>mangle</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td><code>dnat</code></td>
<td><code>Y</code></td>
<td></td>
<td></td>
<td><code>Y</code></td>
<td></td>
</tr>
<tr>
<td><code>filter</code></td>
<td></td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td><code>snat</code></td>
<td></td>
<td>Y</td>
<td></td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody></table>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230923170710358.png" alt="image-20230923170710358"></p>
<ol>
<li>API Server 接收请求<ul>
<li>创建 Service 或者 Endpoint，对应的 Service Controller 或者 Endpoint Controller 会执行对应的动作</li>
</ul>
</li>
<li>kube-proxy 会通过 API Server 监听 Service 或者 Endpoint 的变化</li>
<li>如果 kube-proxy 采用 iptables 模式，会创建对应的 iptables 规则<ul>
<li>iptables 不会感知不同类型的 Service（ClusterIP、NodePort 等），都是<code>一视同仁</code>地创建 iptables 规则</li>
</ul>
</li>
<li>Load Balancer 一般在<code>集群外部</code>，跟 Kubernetes 集群不在一个网络体系<ul>
<li>Pod IP 一般为私有 IP，对 Load Balancer 来说不可达，此时要借助 <code>NodePort</code></li>
<li>Node 可能会出故障，<code>Load Balancer 相当于 NodePort 的负载均衡</code><ul>
<li>在 Node 上打 <code>Label</code>，配置 Load Balancer 时得出对应的 NodeIP + NodePort</li>
</ul>
</li>
<li>如果 Load Balancer 对 Pod 可见，可以定制 Service Controller，让 Load Balancer 直连 Pod，从而绕过 NodePort</li>
</ul>
</li>
</ol>
<blockquote>
<p>所有 Node 上的 kube-proxy 的行为是<code>完全一致</code>的，形成<code>分布式</code>的<code>负载均衡</code> - Node 本地就能完成负载均衡</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230923184757261.png" alt="image-20230923184757261"></p>
<h3 id="ClusterIP-1"><a href="#ClusterIP-1" class="headerlink" title="ClusterIP"></a>ClusterIP</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k get services -owide</span><br><span class="line">NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   26d   &lt;none&gt;</span><br><span class="line">nginx-basic   ClusterIP   10.100.49.21   &lt;none&gt;        80/TCP    32s   app=nginx</span><br><span class="line"></span><br><span class="line">$ k get po -l app=nginx -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-57cdf669d6-8lnzt   1/1     Running   0          12s     192.168.185.15   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-57cdf669d6-clpll   1/1     Running   0          12s     192.168.185.14   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-57cdf669d6-pk4z7   1/1     Running   0          3m24s   192.168.185.13   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;nginx-basic&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;ports&quot;:[&#123;&quot;name&quot;:&quot;http&quot;,&quot;port&quot;:80,&quot;protocol&quot;:&quot;TCP&quot;&#125;],&quot;selector&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;type&quot;:&quot;ClusterIP&quot;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-23T09:18:31Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;20688&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">becfd869-1437-4d90-9c00-461c31ad05e7</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>VIP</th>
<th>Backend</th>
</tr>
</thead>
<tbody><tr>
<td>10.100.49.21:80</td>
<td>192.168.185.15:80</td>
</tr>
<tr>
<td></td>
<td>192.168.185.14:80</td>
</tr>
<tr>
<td></td>
<td>192.168.185.13:80</td>
</tr>
</tbody></table>
<blockquote>
<p>sudo iptables-save -t nat</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">:PREROUTING ACCEPT [454:20430]</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [929:57021]</span><br><span class="line">:POSTROUTING ACCEPT [1380:77271]</span><br><span class="line">:KUBE-SERVICES - [0:0]</span><br><span class="line"></span><br><span class="line">-A PREROUTING -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line">-A OUTPUT -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line"></span><br><span class="line">-A KUBE-SERVICES -d 10.100.49.21/32 -p tcp -m comment --comment &quot;default/nginx-basic:http cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-WWRFY3PZ7W3FGMQW</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Key</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>-A</td>
<td>Add</td>
</tr>
<tr>
<td>-j</td>
<td>Jump</td>
</tr>
<tr>
<td>-d</td>
<td>Destination</td>
</tr>
<tr>
<td>–dport</td>
<td>Destination Port</td>
</tr>
<tr>
<td>-p</td>
<td>Protocol</td>
</tr>
</tbody></table>
<blockquote>
<p>iptables 为规则引擎，<code>自上而下逐条执行</code></p>
</blockquote>
<blockquote>
<p><code>随机实现平均</code>（<code>ipvs</code> 支持 <code>round robin</code>）</p>
<ol>
<li>第1条 33%</li>
<li>第1条不命中后，第2条 50%（总体上还是 33%）</li>
<li>第2条不命中后，第3条 100%（总体上还是 33%）</li>
</ol>
</blockquote>
<blockquote>
<p>如果有 N 个 Pod，就会有 N 条类似的规则，时间复杂度为 <code>O(N)</code><br><code>首包慢</code> - 未建立 TCP 连接，首包需要<code>逐条匹配</code>，匹配成功后，会在 <code>raw</code> 表中记录（Kernel Connection Checking）</p>
</blockquote>
<blockquote>
<p><code>不支持增量更新</code><br>一旦 <code>Service</code> 或者 <code>Endpoint</code> 发生变化，需要<code>重新生成整个 iptables 表</code> - 触发 <code>CPU Soft Lock</code>，影响应用</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW ! -s 192.168.0.0/16 -d 10.100.49.21/32 -p tcp -m comment --comment &quot;default/nginx-basic:http cluster IP&quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment &quot;default/nginx-basic:http&quot; -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-C6OXGZ6X74U4SWF2</span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment &quot;default/nginx-basic:http&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-D5OXRFJGQH2C25YK</span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment &quot;default/nginx-basic:http&quot; -j KUBE-SEP-2W6OV52L6MRXKJPO</span><br></pre></td></tr></table></figure>

<blockquote>
<p>DNAT</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">:KUBE-SEP-C6OXGZ6X74U4SWF2 - [0:0]</span><br><span class="line">-A KUBE-SEP-C6OXGZ6X74U4SWF2 -s 192.168.185.13/32 -m comment --comment &quot;default/nginx-basic:http&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-C6OXGZ6X74U4SWF2 -p tcp -m comment --comment &quot;default/nginx-basic:http&quot; -m tcp -j DNAT --to-destination 192.168.185.13:80</span><br><span class="line"></span><br><span class="line">:KUBE-SEP-D5OXRFJGQH2C25YK - [0:0]</span><br><span class="line">-A KUBE-SEP-D5OXRFJGQH2C25YK -s 192.168.185.14/32 -m comment --comment &quot;default/nginx-basic:http&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-D5OXRFJGQH2C25YK -p tcp -m comment --comment &quot;default/nginx-basic:http&quot; -m tcp -j DNAT --to-destination 192.168.185.14:80</span><br><span class="line"></span><br><span class="line">:KUBE-SEP-2W6OV52L6MRXKJPO - [0:0]</span><br><span class="line">-A KUBE-SEP-2W6OV52L6MRXKJPO -s 192.168.185.15/32 -m comment --comment &quot;default/nginx-basic:http&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-2W6OV52L6MRXKJPO -p tcp -m comment --comment &quot;default/nginx-basic:http&quot; -m tcp -j DNAT --to-destination 192.168.185.15:80</span><br></pre></td></tr></table></figure>

<h3 id="NodePort-1"><a href="#NodePort-1" class="headerlink" title="NodePort"></a>NodePort</h3><blockquote>
<p>将 ClusterIP 修改为 NodePort</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>监听端口 31195</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;nginx-basic&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;ports&quot;:[&#123;&quot;name&quot;:&quot;http&quot;,&quot;port&quot;:80,&quot;protocol&quot;:&quot;TCP&quot;&#125;],&quot;selector&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-23T09:18:31Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;25300&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">becfd869-1437-4d90-9c00-461c31ad05e7</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.100</span><span class="number">.49</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31195</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ss -lt</span><br><span class="line">State                 Recv-Q                Send-Q                                 Local Address:Port                                 Peer Address:Port               Process</span><br><span class="line">...</span><br><span class="line">LISTEN                0                     4096                                         0.0.0.0:31195                                     0.0.0.0:*</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ sudo lsof -i:31195</span><br><span class="line">COMMAND     PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME</span><br><span class="line">kube-prox 16369 root   12u  IPv4 1275439      0t0  TCP *:31195 (LISTEN)</span><br><span class="line"></span><br><span class="line">$ curl -sI 192.168.191.153:31195</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">Date: Sat, 23 Sep 2022 10:32:56 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>与前面 ClusterIP 的 KUBE-SVC-WWRFY3PZ7W3FGMQW 能<code>串联</code>起来，<code>复用</code> ClusterIP 的负载均衡能力</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">:KUBE-NODEPORTS - [0:0]</span><br><span class="line"></span><br><span class="line">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/nginx-basic:http&quot; -m tcp --dport 31195 -j KUBE-SVC-WWRFY3PZ7W3FGMQW</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW ! -s 192.168.0.0/16 -d 10.100.49.21/32 -p tcp -m comment --comment &quot;default/nginx-basic:http cluster IP&quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW -p tcp -m comment --comment &quot;default/nginx-basic:http&quot; -m tcp --dport 31195 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment &quot;default/nginx-basic:http&quot; -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-C6OXGZ6X74U4SWF2</span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment &quot;default/nginx-basic:http&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-D5OXRFJGQH2C25YK</span><br><span class="line">-A KUBE-SVC-WWRFY3PZ7W3FGMQW -m comment --comment &quot;default/nginx-basic:http&quot; -j KUBE-SEP-2W6OV52L6MRXKJPO</span><br></pre></td></tr></table></figure>

<h3 id="VIP"><a href="#VIP" class="headerlink" title="VIP"></a>VIP</h3><blockquote>
<p>在 <code>iptables</code> 模式下，<code>VIP 不会绑定任何设备</code>（ping 不通，ICMP 包），只会存在于 iptables 规则中</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ping -c 1 10.100.49.21</span><br><span class="line">PING 10.100.49.21 (10.100.49.21) 56(84) bytes of data.</span><br><span class="line">From 10.192.4.116 icmp_seq=1 Time to live exceeded</span><br><span class="line"></span><br><span class="line">--- 10.100.49.21 ping statistics ---</span><br><span class="line">1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms</span><br><span class="line"></span><br><span class="line">$ curl -sI 10.100.49.21</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">Date: Sat, 23 Sep 2022 10:22:23 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h2 id="IPVS"><a href="#IPVS" class="headerlink" title="IPVS"></a>IPVS</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230923185021559.png" alt="image-20230923185021559"></p>
<ol>
<li>ipvs 和 iptables 都是 Netfilter 插件，但只支持 <code>LOCAL_IN</code> &#x2F; <code>LOCAL_OUT</code> &#x2F; <code>FORWARD</code></li>
<li>不支持 <code>PREROUTING</code> 的 <code>dnat</code><ul>
<li>在 ipvs 模式下，会在 <code>Node</code> 上启动一个虚拟网卡 <code>kube-ipvs0</code>，并<code>绑定所有的 ClusterIP</code></li>
<li>当接收到数据包时（请求 <code>VIP</code>），Kernel 能识别是否为<code>本机 IP</code>，进而转发到 <code>LOCAL_IN</code>（再做后续的 <code>DNAT</code>）</li>
</ul>
</li>
</ol>
<h3 id="切换"><a href="#切换" class="headerlink" title="切换"></a>切换</h3><blockquote>
<p>将 kube-proxy 的 mode 修改为 ipvs</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k edit cm -n kube-system kube-proxy</span><br><span class="line">...</span><br><span class="line">data:</span><br><span class="line">  mode: &quot;ipvs&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>重建 kube-proxy</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$  k delete po -n kube-system kube-proxy-vz9p8</span><br><span class="line">pod &quot;kube-proxy-vz9p8&quot; deleted</span><br></pre></td></tr></table></figure>

<blockquote>
<p>刷新 iptables 规则，减少了很多在 iptables 模式下产生的 iptables 规则</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables -F -t nat</span><br><span class="line"></span><br><span class="line">$ sudo iptables-save -t nat</span><br><span class="line"># Generated by iptables-save v1.8.4 on Sat Sep 23 20:25:37 2022</span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [6:270]</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [15:900]</span><br><span class="line">:POSTROUTING ACCEPT [21:1170]</span><br><span class="line">:DOCKER - [0:0]</span><br><span class="line">:KUBE-FIREWALL - [0:0]</span><br><span class="line">:KUBE-KUBELET-CANARY - [0:0]</span><br><span class="line">:KUBE-LOAD-BALANCER - [0:0]</span><br><span class="line">:KUBE-MARK-DROP - [0:0]</span><br><span class="line">:KUBE-MARK-MASQ - [0:0]</span><br><span class="line">:KUBE-NODE-PORT - [0:0]</span><br><span class="line">:KUBE-NODEPORTS - [0:0]</span><br><span class="line">:KUBE-POSTROUTING - [0:0]</span><br><span class="line">:KUBE-PROXY-CANARY - [0:0]</span><br><span class="line">:KUBE-SEP-2QTYKTXAEZZXTHRU - [0:0]</span><br><span class="line">:KUBE-SEP-2W6OV52L6MRXKJPO - [0:0]</span><br><span class="line">:KUBE-SEP-3BKZQAKRFZP5XGF6 - [0:0]</span><br><span class="line">:KUBE-SEP-5JU4MOHAISY5VNTG - [0:0]</span><br><span class="line">:KUBE-SEP-AUSLFFF7R44XU4TT - [0:0]</span><br><span class="line">:KUBE-SEP-C6OXGZ6X74U4SWF2 - [0:0]</span><br><span class="line">:KUBE-SEP-D5OXRFJGQH2C25YK - [0:0]</span><br><span class="line">:KUBE-SEP-FVZ3XY4ZSUKGBNTC - [0:0]</span><br><span class="line">:KUBE-SEP-FWQL7FVUECLM7ENQ - [0:0]</span><br><span class="line">:KUBE-SEP-H7MAFNHDOGBTEIBX - [0:0]</span><br><span class="line">:KUBE-SEP-KKZZ4SVFDMI2QRXA - [0:0]</span><br><span class="line">:KUBE-SEP-U5T5YS3CUAKLO7V4 - [0:0]</span><br><span class="line">:KUBE-SEP-YKN5KDPQYGFRMCEV - [0:0]</span><br><span class="line">:KUBE-SERVICES - [0:0]</span><br><span class="line">:KUBE-SVC-ERIFXISQEP7F7OF4 - [0:0]</span><br><span class="line">:KUBE-SVC-I24EZXP75AX5E7TU - [0:0]</span><br><span class="line">:KUBE-SVC-JD5MR3NA4I4DYORP - [0:0]</span><br><span class="line">:KUBE-SVC-NPX46M4PTMTKRN6Y - [0:0]</span><br><span class="line">:KUBE-SVC-RK657RLKDNVNU64O - [0:0]</span><br><span class="line">:KUBE-SVC-TCOU7JCQXEZGVUNU - [0:0]</span><br><span class="line">:KUBE-SVC-WWRFY3PZ7W3FGMQW - [0:0]</span><br><span class="line">:cali-OUTPUT - [0:0]</span><br><span class="line">:cali-POSTROUTING - [0:0]</span><br><span class="line">:cali-PREROUTING - [0:0]</span><br><span class="line">:cali-fip-dnat - [0:0]</span><br><span class="line">:cali-fip-snat - [0:0]</span><br><span class="line">:cali-nat-outgoing - [0:0]</span><br><span class="line">-A PREROUTING -m comment --comment &quot;cali:6gwbT8clXdHdC1b1&quot; -j cali-PREROUTING</span><br><span class="line">-A PREROUTING -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line">-A OUTPUT -m comment --comment &quot;cali:tVnHkvAo15HuiPy0&quot; -j cali-OUTPUT</span><br><span class="line">-A OUTPUT -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line">-A POSTROUTING -m comment --comment &quot;cali:O3lYWMrLQYEMJtB5&quot; -j cali-POSTROUTING</span><br><span class="line">-A POSTROUTING -m comment --comment &quot;kubernetes postrouting rules&quot; -j KUBE-POSTROUTING</span><br><span class="line">-A KUBE-FIREWALL -j KUBE-MARK-DROP</span><br><span class="line">-A KUBE-LOAD-BALANCER -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span><br><span class="line">-A KUBE-NODE-PORT -p tcp -m comment --comment &quot;Kubernetes nodeport TCP port for masquerade purpose&quot; -m set --match-set KUBE-NODE-PORT-TCP dst -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment &quot;Kubernetes endpoints dst ip:port, source ip for solving hairpin purpose&quot; -m set --match-set KUBE-LOOP-BACK dst,dst,src -j MASQUERADE</span><br><span class="line">-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span><br><span class="line">-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -j MASQUERADE --random-fully</span><br><span class="line">-A KUBE-SERVICES ! -s 192.168.0.0/16 -m comment --comment &quot;Kubernetes service cluster ip + port for masquerade purpose&quot; -m set --match-set KUBE-CLUSTER-IP dst,dst -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SERVICES -m addrtype --dst-type LOCAL -j KUBE-NODE-PORT</span><br><span class="line">-A KUBE-SERVICES -m set --match-set KUBE-CLUSTER-IP dst,dst -j ACCEPT</span><br><span class="line">-A cali-OUTPUT -m comment --comment &quot;cali:GBTAv2p5CwevEyJm&quot; -j cali-fip-dnat</span><br><span class="line">-A cali-POSTROUTING -m comment --comment &quot;cali:Z-c7XtVd2Bq7s_hA&quot; -j cali-fip-snat</span><br><span class="line">-A cali-POSTROUTING -m comment --comment &quot;cali:nYKhEzDlr11Jccal&quot; -j cali-nat-outgoing</span><br><span class="line">-A cali-POSTROUTING -o vxlan.calico -m comment --comment &quot;cali:e9dnSgSVNmIcpVhP&quot; -m addrtype ! --src-type LOCAL --limit-iface-out -m addrtype --src-type LOCAL -j MASQUERADE --random-fully</span><br><span class="line">-A cali-PREROUTING -m comment --comment &quot;cali:r6XmIziWUJsdOK6Z&quot; -j cali-fip-dnat</span><br><span class="line">-A cali-nat-outgoing -m comment --comment &quot;cali:flqWnvo8yq4ULQLa&quot; -m set --match-set cali40masq-ipam-pools src -m set ! --match-set cali40all-ipam-pools dst -j MASQUERADE --random-fully</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Sat Sep 23 20:25:37 2022</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看 ipvs 规则（rr &#x3D; <code>round robin</code>）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ipvsadm -L -n</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.17.0.1:31195 rr</span><br><span class="line">  -&gt; 192.168.185.13:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.14:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.15:80            Masq    1      0          0</span><br><span class="line">TCP  192.168.185.0:31195 rr</span><br><span class="line">  -&gt; 192.168.185.13:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.14:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.15:80            Masq    1      0          0</span><br><span class="line">TCP  192.168.191.153:31195 rr</span><br><span class="line">  -&gt; 192.168.185.13:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.14:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.15:80            Masq    1      0          0</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.191.153:6443         Masq    1      0          0</span><br><span class="line">TCP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 192.168.185.1:53             Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.3:53             Masq    1      0          0</span><br><span class="line">TCP  10.96.0.10:9153 rr</span><br><span class="line">  -&gt; 192.168.185.1:9153           Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.3:9153           Masq    1      0          0</span><br><span class="line">TCP  10.99.180.41:5473 rr</span><br><span class="line">  -&gt; 192.168.191.153:5473         Masq    1      0          0</span><br><span class="line">TCP  10.100.49.21:80 rr</span><br><span class="line">  -&gt; 192.168.185.13:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.14:80            Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.15:80            Masq    1      0          0</span><br><span class="line">TCP  10.101.177.188:443 rr</span><br><span class="line">  -&gt; 192.168.185.5:5443           Masq    1      1          1</span><br><span class="line">  -&gt; 192.168.185.6:5443           Masq    1      1          0</span><br><span class="line">UDP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 192.168.185.1:53             Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.185.3:53             Masq    1      0          0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看 <code>kube-ipvs0</code> 虚拟网卡</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ip a</span><br><span class="line">...</span><br><span class="line">26: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default</span><br><span class="line">    link/ether 5a:1e:de:69:7f:c7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.96.0.10/32 scope global kube-ipvs0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.99.180.41/32 scope global kube-ipvs0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.101.177.188/32 scope global kube-ipvs0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.100.49.21/32 scope global kube-ipvs0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.96.0.1/32 scope global kube-ipvs0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试 Service</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ k get service -owide</span><br><span class="line">NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE    SELECTOR</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        26d    &lt;none&gt;</span><br><span class="line">nginx-basic   NodePort    10.100.49.21   &lt;none&gt;        80:31195/TCP   147m   app=nginx</span><br><span class="line"></span><br><span class="line">$ curl -sI 10.100.49.21:80</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">Date: Sat, 23 Sep 2022 11:46:01 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">$ curl -sI 192.168.191.153:31195</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">Date: Sat, 23 Sep 2022 11:46:27 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 ipvs 模式下，由于 ClusterIP 会绑定在 <code>kube-ipvs0</code> 的虚拟网卡下，所以能 ping 通</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ping -c 1 10.100.49.21</span><br><span class="line">PING 10.100.49.21 (10.100.49.21) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.100.49.21: icmp_seq=1 ttl=64 time=0.073 ms</span><br><span class="line"></span><br><span class="line">--- 10.100.49.21 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.073/0.073/0.073/0.000 ms</span><br></pre></td></tr></table></figure>

<h3 id="iptables-1"><a href="#iptables-1" class="headerlink" title="iptables"></a>iptables</h3><blockquote>
<p>结合 <code>ipset</code>（减少 iptables 规则），通过<code>一条 iptables 规则</code>实现 <code>IP 伪装</code>（snat）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ipset -L</span><br><span class="line">...</span><br><span class="line">Name: KUBE-CLUSTER-IP</span><br><span class="line">Type: hash:ip,port</span><br><span class="line">Revision: 5</span><br><span class="line">Header: family inet hashsize 1024 maxelem 65536</span><br><span class="line">Size in memory: 640</span><br><span class="line">References: 2</span><br><span class="line">Number of entries: 7</span><br><span class="line">Members:</span><br><span class="line">10.100.49.21,tcp:80</span><br><span class="line">10.101.177.188,tcp:443</span><br><span class="line">10.96.0.10,tcp:53</span><br><span class="line">10.96.0.1,tcp:443</span><br><span class="line">10.96.0.10,udp:53</span><br><span class="line">10.99.180.41,tcp:5473</span><br><span class="line">10.96.0.10,tcp:9153</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>避免了原本在 iptables 模式下产生很多 iptables 规则的情况</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ iptables-save -t nat</span><br><span class="line"></span><br><span class="line">:KUBE-SERVICES - [0:0]</span><br><span class="line">-A PREROUTING -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line">-A OUTPUT -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line">-A KUBE-SERVICES -m set --match-set KUBE-CLUSTER-IP dst,dst -j ACCEPT</span><br></pre></td></tr></table></figure>

<h1 id="DNS-1"><a href="#DNS-1" class="headerlink" title="DNS"></a>DNS</h1><blockquote>
<p>Kubernetes 提供了内置的域名服务，Service 会自动获得域名<br>无论 Service 重建多少次，只要 Service 名称不变，对应的域名也不会发生改变</p>
</blockquote>
<blockquote>
<p>DNS 主要与 <code>Service</code> 配合，而 Service 工作在<code>四层</code></p>
</blockquote>
<h2 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230923213744058.png" alt="image-20230923213744058"></p>
<ol>
<li>CoreDNS 包含一个<code>内存态</code> DNS，并且本身也是一个<code>控制器</code></li>
<li>工作原理<ul>
<li>控制器监听 <code>Service</code> 和 <code>Endpoint</code> 的变化并配置 <code>DNS</code></li>
<li>客户端 Pod 在进行域名解析时，会从 CoreDNS 中查询 Service 对应的地址记录</li>
</ul>
</li>
<li>递归查询<ul>
<li>查询 CoreDNS 本身的 A 记录，如果不存在，则转发到 CoreDNS 的上游 DNS 服务器（配置来自于 <code>Node</code>）</li>
</ul>
</li>
</ol>
<blockquote>
<p><code>kube-proxy</code> 采用 <code>DaemonSet</code> 部署，<code>CoreDNS</code> 采用 <code>Deployment</code> 部署</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get deployments.apps -n kube-system -owide</span><br><span class="line">NAME      READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                                                   SELECTOR</span><br><span class="line">coredns   2/2     2            2           26d   coredns      registry.aliyuncs.com/google_containers/coredns:v1.8.6   k8s-app=kube-dns</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ k get po</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">centos                              1/1     Running   0          6s</span><br><span class="line">nginx-deployment-57cdf669d6-8lnzt   1/1     Running   0          4h26m</span><br><span class="line">nginx-deployment-57cdf669d6-clpll   1/1     Running   0          4h26m</span><br><span class="line">nginx-deployment-57cdf669d6-pk4z7   1/1     Running   0          4h29m</span><br><span class="line"></span><br><span class="line">$ k get services -owide</span><br><span class="line">NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        26d     &lt;none&gt;</span><br><span class="line">nginx-basic   NodePort    10.100.49.21   &lt;none&gt;        80:31195/TCP   4h29m   app=nginx</span><br><span class="line"></span><br><span class="line">$ k get svc -n kube-system -owide</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE   SELECTOR</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   26d   k8s-app=kube-dns</span><br><span class="line"></span><br><span class="line">$ k get po -A -l k8s-app=kube-dns -owide</span><br><span class="line">NAMESPACE     NAME                      READY   STATUS    RESTARTS   AGE   IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-6d8c4cb4d-jmk8s   1/1     Running   0          26d   192.168.185.3   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-6d8c4cb4d-vxcs8   1/1     Running   0          26d   192.168.185.1   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>ndots:5</code> - 如果提供的域名少于 5 个 <code>.</code>，则会认为是<code>短名</code>，尝试从 <code>search domain</code> 中<code>依次</code>匹配</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it centos -- bash</span><br><span class="line">[root@centos /]# cat /etc/resolv.conf</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local localdomain</span><br><span class="line">options ndots:5</span><br><span class="line">[root@centos /]#</span><br><span class="line">[root@centos /]# ping -c 1 nginx-basic</span><br><span class="line">PING nginx-basic.default.svc.cluster.local (10.100.49.21) 56(84) bytes of data.</span><br><span class="line">64 bytes from nginx-basic.default.svc.cluster.local (10.100.49.21): icmp_seq=1 ttl=64 time=0.039 ms</span><br><span class="line"></span><br><span class="line">--- nginx-basic.default.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.039/0.039/0.039/0.000 ms</span><br><span class="line">[root@centos /]#</span><br><span class="line">[root@centos /]# ping -c 1 nginx-basic.default</span><br><span class="line">PING nginx-basic.default.svc.cluster.local (10.100.49.21) 56(84) bytes of data.</span><br><span class="line">64 bytes from nginx-basic.default.svc.cluster.local (10.100.49.21): icmp_seq=1 ttl=64 time=0.047 ms</span><br><span class="line"></span><br><span class="line">--- nginx-basic.default.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.047/0.047/0.047/0.000 ms</span><br><span class="line">[root@centos /]#</span><br><span class="line">[root@centos /]# ping -c 1 nginx-basic.default.svc</span><br><span class="line">PING nginx-basic.default.svc.cluster.local (10.100.49.21) 56(84) bytes of data.</span><br><span class="line">64 bytes from nginx-basic.default.svc.cluster.local (10.100.49.21): icmp_seq=1 ttl=64 time=0.023 ms</span><br><span class="line"></span><br><span class="line">--- nginx-basic.default.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.023/0.023/0.023/0.000 ms</span><br><span class="line">[root@centos /]#</span><br><span class="line">[root@centos /]# ping -c 1 nginx-basic.default.svc.cluster.local</span><br><span class="line">PING nginx-basic.default.svc.cluster.local (10.100.49.21) 56(84) bytes of data.</span><br><span class="line">64 bytes from nginx-basic.default.svc.cluster.local (10.100.49.21): icmp_seq=1 ttl=64 time=0.067 ms</span><br><span class="line"></span><br><span class="line">--- nginx-basic.default.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.067/0.067/0.067/0.000 ms</span><br><span class="line">[root@centos /]#</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CoreDNS 会使用 Node 上的 <code>/etc/resolv.conf</code> 文件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolv.conf </span><br><span class="line">options timeout:2 attempts:3 rotate single-request-reopen</span><br><span class="line">; generated by /usr/sbin/dhclient-script</span><br><span class="line">nameserver 10.192.33.32</span><br><span class="line">nameserver 10.192.26.32</span><br><span class="line">search cluster.local</span><br><span class="line"></span><br><span class="line">$ docker ps | grep coredns</span><br><span class="line">d910c836fc10        9e06444eed17                                                                                      &quot;/coredns -conf /etc…&quot;   6 weeks ago         Up 6 weeks                              k8s_coredns_coredns-ccd4fb7b9-5szdn_kube-system_d978dd5b-f438-4269-8733-ce2f29b94ae2_0</span><br><span class="line">59475c9aee07        registry-vpc.cn-hangzhou.aliyuncs.com/acs/pause:3.2                                               &quot;/pause&quot;                 6 weeks ago         Up 6 weeks                              k8s_POD_coredns-ccd4fb7b9-5szdn_kube-system_d978dd5b-f438-4269-8733-ce2f29b94ae2_0</span><br><span class="line"></span><br><span class="line">$ docker inspect d910c836fc10 | grep Pid</span><br><span class="line">            &quot;Pid&quot;: 1392519,</span><br><span class="line">            &quot;PidMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;PidsLimit&quot;: null,</span><br><span class="line"></span><br><span class="line">$ nsenter -t 1392519 -n cat /etc/resolv.conf </span><br><span class="line">options timeout:2 attempts:3 rotate single-request-reopen</span><br><span class="line">; generated by /usr/sbin/dhclient-script</span><br><span class="line">nameserver 10.192.33.32</span><br><span class="line">nameserver 10.192.26.32</span><br><span class="line">search cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="DNS-Record"><a href="#DNS-Record" class="headerlink" title="DNS Record"></a>DNS Record</h2><blockquote>
<p>依赖 <code>ClusterIP</code> 来做服务调用，<code>相对稳定 </code></p>
</blockquote>
<ol>
<li>Common Service<ul>
<li>ClusterIP、NodePort、LoadBalancer 类型的 Service 都拥有 <code>API Server</code> 分配的 <code>ClusterIP</code></li>
<li>CoreDNS 会为其创建 <code>FQDN</code> 格式的 <code>A 记录</code>和 <code>PTR 记录</code>，并为<code>端口</code>创建 <code>SRV 记录</code><ul>
<li>FQDN - <code>fully</code> qualified domain name，即 <code>$&#123;svcname&#125;.$&#123;ns&#125;.svc.$&#123;clusterdomain&#125;</code></li>
</ul>
</li>
</ul>
</li>
<li>Headless Service<ul>
<li>显式指定 ClusterIP 为 <code>None</code>，所以 API Server <code>不会为其分配 ClusterIP</code><ul>
<li>但还是会<code>创建同名的 Endpoint</code>，只有 Selector 为空才不会自动创建 Endpoint</li>
</ul>
</li>
<li>CoreDNS 需为此类 Service 创建<code>多条 A 记录</code>，目标为每个<code>就绪的 Pod IP</code><ul>
<li>如果某个 Pod <code>不 Ready</code>，CoreDNS 会<code>把对应的 A 记录移除</code></li>
</ul>
</li>
<li>每个 Pod 会拥有一个 <code>FQDN</code> 的 <code>A 记录</code>指向 Pod IP<ul>
<li><code>$&#123;podname&#125;.$&#123;svcname&#125;.$&#123;ns&#125;.svc.$&#123;clusterdomain&#125;</code></li>
</ul>
</li>
<li>Pod 的属性 <code>hostname</code> 和 <code>subdomain</code> 组成 <code>$&#123;podname&#125;</code><ul>
<li><code>$&#123;hostname&#125;.$&#123;subdomain&#125;.$&#123;svcname&#125;.$&#123;ns&#125;.svc.$&#123;clusterdomain&#125;</code></li>
<li>如 StatefulSet</li>
</ul>
</li>
<li>客户端通过 CoreDNS 拿到的就是 Pod IP，对 Pod IP 请求不再需要经过 <code>ipvs</code> 或者 <code>iptables</code></li>
</ul>
</li>
<li>ExternalName Service<ul>
<li>此类 Service 用来引用一个<code>已经存在</code>的域名</li>
<li>CoreDNS 会为该 Service 创建一个 <code>CName 记录</code>指向该目标域名</li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th>Type</th>
<th>DNS</th>
<th>Key</th>
<th>Value</th>
<th>Count</th>
</tr>
</thead>
<tbody><tr>
<td>Common</td>
<td>a</td>
<td><code>$&#123;svcname&#125;.$&#123;ns&#125;.svc.$&#123;clusterdomain&#125;</code></td>
<td>ClusterIP</td>
<td>1</td>
</tr>
<tr>
<td>Headless</td>
<td>a</td>
<td><code>$&#123;podname&#125;.$&#123;svcname&#125;.$&#123;ns&#125;.svc.$&#123;clusterdomain&#125;</code><br /><code>$&#123;hostname&#125;.$&#123;subdomain&#125;.$&#123;svcname&#125;.$&#123;ns&#125;.svc.$&#123;clusterdomain&#125;</code></td>
<td>Ready PodIP</td>
<td>N</td>
</tr>
<tr>
<td>ExternalName</td>
<td>cname</td>
<td>Alias</td>
<td>Existed Domain</td>
<td>1</td>
</tr>
</tbody></table>
<h2 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h2><ol>
<li>Pod 默认的 <code>DNSPolicy</code> 为 <code>ClusterFirst</code>（即 <code>CoreDNS</code>）<ul>
<li>如果使用 <code>Default</code>，则采用 <code>Node</code> 上的 <code>/etc/resolv.conf</code></li>
</ul>
</li>
<li>Pod 启动后的 <code>/etc/resolv.conf</code> 会被<code>改写</code>，所有的地址解析优先发送到 <code>CoreDNS</code></li>
<li>当 Pod 启动时，<code>同一 Namespace</code> 的所有 <code>Service</code> 都会以<code>环境变量</code>的形式设置到容器内</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ k get svc -owide</span><br><span class="line">NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        26d     &lt;none&gt;</span><br><span class="line">nginx-basic   NodePort    10.100.49.21   &lt;none&gt;        80:31195/TCP   5h49m   app=nginx</span><br><span class="line"></span><br><span class="line">$ k exec -it centos -- bash</span><br><span class="line">[root@centos /]# env | grep SERVICE | sort</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.96.0.1</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line">KUBERNETES_SERVICE_PORT_HTTPS=443</span><br><span class="line">NGINX_BASIC_SERVICE_HOST=10.100.49.21</span><br><span class="line">NGINX_BASIC_SERVICE_PORT=80</span><br><span class="line">NGINX_BASIC_SERVICE_PORT_HTTP=80</span><br></pre></td></tr></table></figure>

<blockquote>
<p>自定义 <code>DNSPolicy</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">dnsPolicy:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">    <span class="attr">dnsConfig:</span></span><br><span class="line">        <span class="attr">nameservers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">        <span class="attr">searchs:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">xx.yy.zz</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ndots</span></span><br><span class="line">                <span class="attr">values:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="生产落地"><a href="#生产落地" class="headerlink" title="生产落地"></a>生产落地</h2><ol>
<li>Service 在<code>集群内</code>通过 <code>CoreDNS</code> 寻址，在<code>集群外</code>通过<code>企业 DNS</code> 寻址，Service 在集群内外有<code>统一标识</code></li>
<li>Service 需要发布到企业 DNS<ul>
<li>在企业 DNS，同样创建 <code>A/PTR/SRV</code> 记录（通常解析地址为 <code>LoadBalancer VIP</code>）</li>
<li><code>Headless Service</code><ul>
<li>在 <code>Pod IP</code> 可<code>全局路由</code>的前提下，<code>按需</code>创建 DNS 记录<ul>
<li>否则对企业 DNS 是很大的冲击（DNS 不是专门用于<code>负载均衡</code>）</li>
</ul>
</li>
<li>CoreDNS 支持<code>横向扩展</code>，而一般的企业 DNS 不具备这个扩展能力</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><h2 id="负载均衡-1"><a href="#负载均衡-1" class="headerlink" title="负载均衡"></a>负载均衡</h2><blockquote>
<p>Kubernetes 中的负载均衡技术</p>
</blockquote>
<table>
<thead>
<tr>
<th>L4 Service</th>
<th>L7 Ingress</th>
</tr>
</thead>
<tbody><tr>
<td>基于 <code>iptables</code> &#x2F; <code>ipvs</code> 的<code>分布式</code>四层负载均衡技术（<code>五元组</code>）</td>
<td>基于七层应用层，提供更多功能</td>
</tr>
<tr>
<td>多种 <code>Load Balancer Provider</code> 提供与企业现有 ELB（比较贵） 整合</td>
<td>TLS termination<br />反向代理处理 TLS，业务开发只关注 HTTP 即可</td>
</tr>
<tr>
<td><code>kube-proxy</code> 基于 <code>iptables rules</code> 为 Kubernetes 形成<code>全局统一</code>的<code>分布式</code>负载均衡器</td>
<td>L7 path forwarding</td>
</tr>
<tr>
<td>kube-proxy 是一种 <code>mesh</code>，内部客户端无论通过 <code>ClusterIP</code>、<code>NodePort</code>、<code>LB VIP</code> 都经过 kube-proxy 跳转到 pod</td>
<td>URL&#x2F;http header rewrite</td>
</tr>
<tr>
<td>属于 <code>Kubernetes Core</code></td>
<td>与采用 7 层软件紧密相关</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>每个应用<code>独占 ELB</code>，浪费资源</td>
<td>多个应用<code>共享 ELB</code>，节省资源</td>
</tr>
<tr>
<td>为每个 Service <code>动态创建 DNS 记录</code>，频繁的 DNS 更新</td>
<td>多个应用共享一个 <code>Domain</code>，采用<code>静态 DNS 配置</code></td>
</tr>
<tr>
<td>支持 <code>TCP</code> 和 <code>UDP</code>，如果需要启动 <code>HTTPS</code> 服务，需要<code>管理证书</code></td>
<td><code>TLS termination</code> 发生在 Ingress 层，可<code>集中管理证书</code></td>
</tr>
<tr>
<td></td>
<td>更复杂，更多的网络 hop</td>
</tr>
</tbody></table>
<blockquote>
<p>Ingress 是<code>反向代理</code> + <code>控制器</code><br>监听 Ingress Spec，生成对应的反向代理规则，应用到 Ingress 的反向代理，Ingress 会执行 TLS termination</p>
</blockquote>
<blockquote>
<p>Ingress 工作在七层，但前面还有一个<code>四层</code>的 <code>Ingress Service</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230924094933734.png" alt="image-20230924094933734"></p>
<h2 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h2><ol>
<li>Ingress<ul>
<li>Ingress 是一层<code>反向代理</code></li>
<li>根据 <code>hostname</code> 和 <code>path</code> 将流量转发到不同的服务，使得<code>同一个负载均衡器</code>用于<code>多个后端应用</code></li>
<li><code>Ingress Spec</code> 是<code>转发规则</code>的集合</li>
</ul>
</li>
<li>Ingress Controller<ul>
<li><code>负载均衡</code>配置</li>
<li><code>边缘路由</code>配置</li>
<li><code>DNS</code> 配置</li>
</ul>
</li>
</ol>
<h2 id="逻辑结构"><a href="#逻辑结构" class="headerlink" title="逻辑结构"></a>逻辑结构</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230924105453073.png" alt="image-20230924105453073"></p>
<h3 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h3><blockquote>
<p>CN &#x3D; Common Name，如果为 <code>*</code>，表示不做域名校验</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=z.com/O=z&quot; -addext &quot;subjectAltName = DNS:z.com&quot;</span><br><span class="line">Generating a RSA private key</span><br><span class="line">..................................+++++</span><br><span class="line">...........+++++</span><br><span class="line">writing new private key to &#x27;tls.key&#x27;</span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line">$ kubectl create secret tls z-tls --cert=./tls.crt --key=./tls.key</span><br><span class="line">secret/z-tls created</span><br></pre></td></tr></table></figure>

<h3 id="Ingress-1"><a href="#Ingress-1" class="headerlink" title="Ingress"></a>Ingress</h3><blockquote>
<p><code>kubernetes.io/ingress.class</code> 指定 <code>IngressClass</code>，再通过 IngressClass 关联 <code>Ingress Controller</code></p>
</blockquote>
<blockquote>
<p>Ingress Controller 应遵循统一规范，<code>只解析需要解析的 Ingress</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">z.com</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">z-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">z.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get ingressclasses.networking.k8s.io -A</span><br><span class="line">NAME    CONTROLLER             PARAMETERS   AGE</span><br><span class="line">nginx   k8s.io/ingress-nginx   &lt;none&gt;       73s</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;networking.k8s.io/v1&quot;,&quot;kind&quot;:&quot;IngressClass&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;app.kubernetes.io/component&quot;:&quot;controller&quot;,&quot;app.kubernetes.io/instance&quot;:&quot;ingress-nginx&quot;,&quot;app.kubernetes.io/managed-by&quot;:&quot;Helm&quot;,&quot;app.kubernetes.io/name&quot;:&quot;ingress-nginx&quot;,&quot;app.kubernetes.io/version&quot;:&quot;1.0.0&quot;,&quot;helm.sh/chart&quot;:&quot;ingress-nginx-4.0.1&quot;&#125;,&quot;name&quot;:&quot;nginx&quot;&#125;,&quot;spec&quot;:&#123;&quot;controller&quot;:&quot;k8s.io/ingress-nginx&quot;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-24T03:01:44Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-4.0.1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;81101&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">f2d56aa2-a59f-49c9-a8dc-d4c862761604</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">k8s.io/ingress-nginx</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f z-ingress.yaml</span><br><span class="line">ingress.networking.k8s.io/gateway created</span><br><span class="line"></span><br><span class="line">$ k get ingress gateway -owide</span><br><span class="line">NAME      CLASS    HOSTS   ADDRESS           PORTS     AGE</span><br><span class="line">gateway   &lt;none&gt;   z.com   192.168.191.153   80, 443   13m</span><br><span class="line"></span><br><span class="line">$ k describe ingress gateway</span><br><span class="line">Name:             gateway</span><br><span class="line">Labels:           &lt;none&gt;</span><br><span class="line">Namespace:        default</span><br><span class="line">Address:          192.168.191.153</span><br><span class="line">Default backend:  default-http-backend:80 (&lt;error: endpoints &quot;default-http-backend&quot; not found&gt;)</span><br><span class="line">TLS:</span><br><span class="line">  z-tls terminates z.com</span><br><span class="line">Rules:</span><br><span class="line">  Host        Path  Backends</span><br><span class="line">  ----        ----  --------</span><br><span class="line">  z.com</span><br><span class="line">              /   nginx-basic:80 (192.168.185.13:80,192.168.185.14:80,192.168.185.15:80)</span><br><span class="line">Annotations:  kubernetes.io/ingress.class: nginx</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason  Age                  From                      Message</span><br><span class="line">  ----    ------  ----                 ----                      -------</span><br><span class="line">  Normal  Sync    8m21s (x3 over 11m)  nginx-ingress-controller  Scheduled for sync</span><br><span class="line">  </span><br><span class="line">$ k get endpoints nginx-basic</span><br><span class="line">NAME          ENDPOINTS                                               AGE</span><br><span class="line">nginx-basic   192.168.185.13:80,192.168.185.14:80,192.168.185.15:80   18h</span><br><span class="line"></span><br><span class="line">$ k get po -n ingress-nginx -owide</span><br><span class="line">NAME                                        READY   STATUS      RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">ingress-nginx-admission-create-pp5hp        0/1     Completed   0          19m   192.168.185.20   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx-admission-patch-252nh         0/1     Completed   1          19m   192.168.185.19   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx-controller-75f58fbf6b-ghqjg   1/1     Running     0          19m   192.168.185.21   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;networking.k8s.io/v1&quot;,&quot;kind&quot;:&quot;Ingress&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;kubernetes.io/ingress.class&quot;:&quot;nginx&quot;&#125;,&quot;name&quot;:&quot;gateway&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;rules&quot;:[&#123;&quot;host&quot;:&quot;z.com&quot;,&quot;http&quot;:&#123;&quot;paths&quot;:[&#123;&quot;backend&quot;:&#123;&quot;service&quot;:&#123;&quot;name&quot;:&quot;nginx-basic&quot;,&quot;port&quot;:&#123;&quot;number&quot;:80&#125;&#125;&#125;,&quot;path&quot;:&quot;/&quot;,&quot;pathType&quot;:&quot;Prefix&quot;&#125;]&#125;&#125;],&quot;tls&quot;:[&#123;&quot;hosts&quot;:[&quot;z.com&quot;],&quot;secretName&quot;:&quot;z-tls&quot;&#125;]&#125;&#125;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-09-24T03:19:58Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;83537&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">876ef437-85df-40dd-a74c-938fd10bbdda</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">z.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-basic</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">z.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">z-tls</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.191</span><span class="number">.153</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>直接访问 Ingress Controller 的 Pod IP（会被 ipvs 拦截）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H &quot;Host: z.com&quot; https://192.168.185.21 -v -k</span><br><span class="line">*   Trying 192.168.185.21:443...</span><br><span class="line">* Connected to 192.168.185.21 (192.168.185.21) port 443 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* TLSv1.0 (OUT), TLS header, Certificate Status (22):</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Certificate Status (22):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Finished (20):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, CERT verify (15):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Finished (20):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Finished (20):</span><br><span class="line">* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Finished (20):</span><br><span class="line">* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384</span><br><span class="line">* ALPN, server accepted to use h2</span><br><span class="line">* Server certificate:</span><br><span class="line">*  subject: O=Acme Co; CN=Kubernetes Ingress Controller Fake Certificate</span><br><span class="line">*  start date: Sep 24 03:01:46 2022 GMT</span><br><span class="line">*  expire date: Sep 23 03:01:46 2024 GMT</span><br><span class="line">*  issuer: O=Acme Co; CN=Kubernetes Ingress Controller Fake Certificate</span><br><span class="line">*  SSL certificate verify result: self-signed certificate (18), continuing anyway.</span><br><span class="line">* Using HTTP2, server supports multiplexing</span><br><span class="line">* Connection state changed (HTTP/2 confirmed)</span><br><span class="line">* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* Using Stream ID: 1 (easy handle 0xaaaad5a01620)</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">&gt; GET / HTTP/2</span><br><span class="line">&gt; Host: z.com</span><br><span class="line">&gt; user-agent: curl/7.81.0</span><br><span class="line">&gt; accept: */*</span><br><span class="line">&gt;</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span><br><span class="line">* old SSL session ID is stale, removing</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* Connection state changed (MAX_CONCURRENT_STREAMS == 128)!</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">&lt; HTTP/2 200</span><br><span class="line">&lt; date: Sun, 24 Sep 2022 03:25:06 GMT</span><br><span class="line">&lt; content-type: text/html</span><br><span class="line">&lt; content-length: 615</span><br><span class="line">&lt; last-modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">&lt; etag: &quot;64dbafc8-267&quot;</span><br><span class="line">&lt; accept-ranges: bytes</span><br><span class="line">&lt; strict-transport-security: max-age=15724800; includeSubDomains</span><br><span class="line">&lt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* TLSv1.2 (IN), TLS header, Supplemental data (23):</span><br><span class="line">* Connection #0 to host 192.168.185.21 left intact</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 <code>Ingress Service</code> 来访问 - https 的 NodePort 端口为 31590</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ k get service -n ingress-nginx -owide</span><br><span class="line">NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE   SELECTOR</span><br><span class="line">ingress-nginx-controller             NodePort    10.97.88.8       &lt;none&gt;        80:30687/TCP,443:31590/TCP   38m   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx</span><br><span class="line">ingress-nginx-controller-admission   ClusterIP   10.100.139.239   &lt;none&gt;        443/TCP                      38m   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx</span><br><span class="line"></span><br><span class="line">$ curl -H &#x27;Host: z.com&#x27; https://10.97.88.8 -ksI</span><br><span class="line">HTTP/2 200</span><br><span class="line">date: Sun, 24 Sep 2022 03:45:22 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">etag: &quot;64dbafc8-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">strict-transport-security: max-age=15724800; includeSubDomains</span><br><span class="line"></span><br><span class="line">$ curl -H &#x27;Host: z.com&#x27; https://192.168.191.153:31590 -ksI</span><br><span class="line">HTTP/2 200</span><br><span class="line">date: Sun, 24 Sep 2022 03:43:55 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 615</span><br><span class="line">last-modified: Tue, 15 Aug 2022 17:03:04 GMT</span><br><span class="line">etag: &quot;64dbafc8-267&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line">strict-transport-security: max-age=15724800; includeSubDomains</span><br></pre></td></tr></table></figure>

<h2 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h2><blockquote>
<p>Ingress 已毕业，但很难满足所有业务场景<br>导致很多 Ingress Controller 采用<code>非标准化</code>的方式来实现一些高级功能，主要是借助 <code>Annotation</code></p>
</blockquote>
<blockquote>
<p>七层的流量治理是一个很大的范畴，很难通过一个 Ingress Spec 去完整定义 - <code>Service API</code> &#x2F; <code>（Envoy + Istio） </code></p>
</blockquote>
<ol>
<li>TLS 配置受限（如无法配置 cypher, dhkey, TLSVersion）</li>
<li>无法实现基于 <code>Header</code> 来配置规则</li>
<li>无法实现 <code>Rewriting</code><ul>
<li>Header rewriting</li>
<li>URI rewriting</li>
</ul>
</li>
</ol>
<h1 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230924164001922.png" alt="image-20230924164001922"></p>
<blockquote>
<p>L4</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230924164038458.png" alt="image-20230924164038458"></p>
<blockquote>
<p>L7 - IP in IP Tunneling</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230924164100548.png" alt="image-20230924164100548"></p>
<blockquote>
<p>数据流</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230924164216219.png" alt="image-20230924164216219"></p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/12/cloud-native-foundation-k8s-service-discovery/">https://blog.zhongmingmao.top/2022/12/12/cloud-native-foundation-k8s-service-discovery/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/13/cloud-native-foundation-k8s-manage-production-clusters/" title="Kubernetes - Manage Production Clusters"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/2bc58949d451b7e5f8f8759c44d962d01b2ed48d-1108x1108.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes - Manage Production Clusters</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/11/go-foundation-design-philosophy/" title="Go - Design Philosophy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Go - Design Philosophy</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-11</div><div class="title">Kubernetes - Helm Doc</div></div></a></div><div><a href="/2023/02/02/cloud-native-foundation-k8s-security/" title="Kubernetes - Security"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-security.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-02</div><div class="title">Kubernetes - Security</div></div></a></div><div><a href="/2023/02/01/cloud-native-foundation-k8s-federation/" title="Kubernetes - Federation"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/federation.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">Kubernetes - Federation</div></div></a></div><div><a href="/2023/01/31/cloud-native-foundation-k8s-istio/" title="Kubernetes - Istio"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-31</div><div class="title">Kubernetes - Istio</div></div></a></div><div><a href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/go-envoy.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-30</div><div class="title">Kubernetes - Envoy</div></div></a></div><div><a href="/2023/01/29/cloud-native-foundation-k8s-scaling/" title="Kubernetes - Scaling"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231223144041516.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-29</div><div class="title">Kubernetes - Scaling</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">560</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">179</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">73</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">发展历程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-number">1.2.</span> <span class="toc-text">数据包</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%88"><span class="toc-number">2.1.</span> <span class="toc-text">方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F"><span class="toc-number">2.1.1.</span> <span class="toc-text">集中式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%86%85"><span class="toc-number">2.1.2.</span> <span class="toc-text">进程内</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sidecar"><span class="toc-number">2.1.3.</span> <span class="toc-text">Sidecar</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS"><span class="toc-number">2.3.</span> <span class="toc-text">DNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF"><span class="toc-number">2.4.</span> <span class="toc-text">相关技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82-NAT"><span class="toc-number">2.4.1.</span> <span class="toc-text">网络层 - NAT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82"><span class="toc-number">2.4.2.</span> <span class="toc-text">传输层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E5%B1%82"><span class="toc-number">2.4.3.</span> <span class="toc-text">链路层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%A7%E9%81%93-Tunnel"><span class="toc-number">2.4.4.</span> <span class="toc-text">隧道 - Tunnel</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Service"><span class="toc-number">3.</span> <span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-1"><span class="toc-number">3.1.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Endpoint"><span class="toc-number">3.2.</span> <span class="toc-text">Endpoint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EndpointSlice"><span class="toc-number">3.3.</span> <span class="toc-text">EndpointSlice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-Selector"><span class="toc-number">3.4.</span> <span class="toc-text">No Selector</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-number">3.5.</span> <span class="toc-text">对应关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">3.6.</span> <span class="toc-text">分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterIP"><span class="toc-number">3.6.1.</span> <span class="toc-text">ClusterIP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NodePort"><span class="toc-number">3.6.2.</span> <span class="toc-text">NodePort</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadBalancer"><span class="toc-number">3.6.3.</span> <span class="toc-text">LoadBalancer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Headless-Service"><span class="toc-number">3.6.4.</span> <span class="toc-text">Headless Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExternalName-Service"><span class="toc-number">3.6.5.</span> <span class="toc-text">ExternalName Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-Topology"><span class="toc-number">3.7.</span> <span class="toc-text">Service Topology</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kube-proxy"><span class="toc-number">4.</span> <span class="toc-text">kube-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Netfilter"><span class="toc-number">4.1.</span> <span class="toc-text">Netfilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables"><span class="toc-number">4.2.</span> <span class="toc-text">iptables</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterIP-1"><span class="toc-number">4.3.1.</span> <span class="toc-text">ClusterIP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NodePort-1"><span class="toc-number">4.3.2.</span> <span class="toc-text">NodePort</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VIP"><span class="toc-number">4.3.3.</span> <span class="toc-text">VIP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPVS"><span class="toc-number">4.4.</span> <span class="toc-text">IPVS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2"><span class="toc-number">4.4.1.</span> <span class="toc-text">切换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iptables-1"><span class="toc-number">4.4.2.</span> <span class="toc-text">iptables</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DNS-1"><span class="toc-number">5.</span> <span class="toc-text">DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CoreDNS"><span class="toc-number">5.1.</span> <span class="toc-text">CoreDNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS-Record"><span class="toc-number">5.2.</span> <span class="toc-text">DNS Record</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Resolution"><span class="toc-number">5.3.</span> <span class="toc-text">Resolution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%90%BD%E5%9C%B0"><span class="toc-number">5.4.</span> <span class="toc-text">生产落地</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ingress"><span class="toc-number">6.</span> <span class="toc-text">Ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-1"><span class="toc-number">6.1.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1"><span class="toc-number">6.2.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E7%BB%93%E6%9E%84"><span class="toc-number">6.3.</span> <span class="toc-text">逻辑结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS"><span class="toc-number">6.3.1.</span> <span class="toc-text">TLS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ingress-1"><span class="toc-number">6.3.2.</span> <span class="toc-text">Ingress</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%BA%E9%99%B7"><span class="toc-number">6.4.</span> <span class="toc-text">缺陷</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">7.</span> <span class="toc-text">实战案例</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/08/21/python-io/" title="Python - IO"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://python-1253868755.cos.ap-guangzhou.myqcloud.com/python-io.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - IO"/></a><div class="content"><a class="title" href="/2024/08/21/python-io/" title="Python - IO">Python - IO</a><time datetime="2024-08-20T16:06:25.000Z" title="Created 2024-08-21 00:06:25">2024-08-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/20/python-string/" title="Python - String"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://python-1253868755.cos.ap-guangzhou.myqcloud.com/python-string.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - String"/></a><div class="content"><a class="title" href="/2024/08/20/python-string/" title="Python - String">Python - String</a><time datetime="2024-08-19T16:06:25.000Z" title="Created 2024-08-20 00:06:25">2024-08-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/19/python-dict-set/" title="Python - Dict + Set"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://python-1253868755.cos.ap-guangzhou.myqcloud.com/python-dict.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - Dict + Set"/></a><div class="content"><a class="title" href="/2024/08/19/python-dict-set/" title="Python - Dict + Set">Python - Dict + Set</a><time datetime="2024-08-18T16:06:25.000Z" title="Created 2024-08-19 00:06:25">2024-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/18/python-list-tuple/" title="Python - List + Tuple"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://python-1253868755.cos.ap-guangzhou.myqcloud.com/python-list-tuple.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - List + Tuple"/></a><div class="content"><a class="title" href="/2024/08/18/python-list-tuple/" title="Python - List + Tuple">Python - List + Tuple</a><time datetime="2024-08-17T16:06:25.000Z" title="Created 2024-08-18 00:06:25">2024-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/17/rag-graphrag/" title="RAG - GraphRAG"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/graphrag-9781829.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RAG - GraphRAG"/></a><div class="content"><a class="title" href="/2024/08/17/rag-graphrag/" title="RAG - GraphRAG">RAG - GraphRAG</a><time datetime="2024-08-16T16:06:25.000Z" title="Created 2024-08-17 00:06:25">2024-08-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2024 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
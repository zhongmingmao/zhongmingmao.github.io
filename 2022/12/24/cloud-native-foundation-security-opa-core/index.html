<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Security - OPA Core | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Glance Use OPA for a unified toolset and framework for policy across the cloud native stack. Use OPA to decouple policy from the service’s code so you can release, analyze, and review policies without">
<meta property="og:type" content="article">
<meta property="og:title" content="Security - OPA Core">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/24/cloud-native-foundation-security-opa-core/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="Glance Use OPA for a unified toolset and framework for policy across the cloud native stack. Use OPA to decouple policy from the service’s code so you can release, analyze, and review policies without">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-7255236.png">
<meta property="article:published_time" content="2022-12-23T16:06:25.000Z">
<meta property="article:modified_time" content="2023-10-16T11:16:40.824Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Cloud Native Foundation">
<meta property="article:tag" content="OPA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-7255236.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/24/cloud-native-foundation-security-opa-core/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Security - OPA Core',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-16 19:16:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">541</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">172</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">72</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-7255236.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Security - OPA Core</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-12-23T16:06:25.000Z" title="Created 2022-12-24 00:06:25">2022-12-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/opa/">OPA</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">23.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>144min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Glance"><a href="#Glance" class="headerlink" title="Glance"></a>Glance</h1><ol>
<li>Use OPA for a <em>unified toolset and framework</em> for policy across the <em>cloud native stack</em>.</li>
<li>Use OPA to <em>decouple policy from the service’s code</em> so you can release, analyze, and review policies without sacrificing <em>availability</em> or <em>performance</em>.</li>
<li>Declarative<ul>
<li>Express policy in a <em>high-level</em>, declarative language that promotes <em>safe</em>, <em>performant</em>, <em>fine-grained controls</em>.</li>
<li>Use a language <em>purpose-built</em> for policy in a world where JSON is pervasive.</li>
<li><em>Iterate, traverse hierarchies</em>, and apply 150+ built-ins like string manipulation and JWT decoding to declare the policies you want enforced.</li>
</ul>
</li>
<li>Context-aware<ul>
<li>Leverage <em>external information</em> to write the policies you really care about.</li>
<li>Instead, write logic that adapts to the world around it and attach that logic to the systems that need it.</li>
</ul>
</li>
<li>Architectural Flexibility<ul>
<li><em>Daemon</em> - Sidecar<ul>
<li>Deploy OPA as a <em>separate process</em> on the <em>same host</em> as your service.</li>
<li>Integrate OPA by changing your service’s code, importing an <em>OPA-enabled library</em>, or using a network proxy integrated with OPA.</li>
</ul>
</li>
<li>Library<ul>
<li><em>Embed OPA policies into your service</em>.</li>
<li>Integrate OPA as a <em>Go library</em> that evaluates policy, or integrate a WebAssembly runtime and use OPA to compile policy to WebAssembly instructions.</li>
</ul>
</li>
</ul>
</li>
<li>Policy as Code</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231014114906447.png" alt="image-20231014114906447"></p>
<span id="more"></span>

<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><ol>
<li>OPA provides a <em>high-level declarative language</em> that lets you specify policy as <em>code</em> and <em>simple APIs</em> to <em>offload</em> policy decision-making from your software.</li>
<li>OPA decouples policy <em>decision-making</em> from policy <em>enforcement</em>.<ul>
<li>When your software needs to make policy decisions it queries OPA and supplies <em>structured data</em> (e.g., JSON) as <em>input</em>.</li>
<li>OPA accepts <em>arbitrary</em> structured data as input.</li>
</ul>
</li>
<li>OPA generates policy decisions by evaluating the <em>query input</em> against <em>policies</em> and <em>data</em>.<ul>
<li>OPA and Rego are <em>domain-agnostic</em> so you can describe almost any kind of invariant in your policies.</li>
</ul>
</li>
<li>Policy decisions are not limited to simple yes&#x2F;no or allow&#x2F;deny answers.<ul>
<li>Like query inputs, your policies can generate <em>arbitrary</em> structured data as output.</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231014130946160.png" alt="image-20231014130946160"></p>
<h2 id="Rego"><a href="#Rego" class="headerlink" title="Rego"></a>Rego</h2><ol>
<li>OPA policies are expressed in a high-level declarative language called Rego.</li>
<li>Rego is purpose-built for expressing policies over <em>complex hierarchical data structures</em>.</li>
</ol>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><blockquote>
<p>When OPA evaluates policies it binds data provided in the query to a global variable called <code>input</code>. You can refer to data in the input using the <code>.</code> (dot) operator.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">input.ports</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>To refer to <em>array</em> elements you can use the familiar <em>square-bracket</em> syntax</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.protocols<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;ssh&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can use the same <em>square bracket</em> syntax if keys contain other than <code>[a-zA-Z0-9_]</code>. E.g., <code>input[&quot;foo~bar&quot;]</code>.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="string">&quot;protocols&quot;</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;https&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you refer to a value that <em>does not exist</em>, OPA returns <em>undefined</em>. Undefined means that OPA was not able to find any results.</p>
</blockquote>
<h3 id="Expressions-AND"><a href="#Expressions-AND" class="headerlink" title="Expressions - AND"></a>Expressions - AND</h3><blockquote>
<p>To produce <em>policy decisions</em> in Rego you write expressions against <em>input</em> and <em>other data</em>.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.protocols<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> == <span class="string">&quot;https&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>OPA includes a set of <em>built-in functions</em> you can use to perform common operations like string manipulation, regular expression matching, arithmetic, aggregation, and more.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">count(input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.ports) &gt;= <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Multiple expressions are joined together with the <code>;</code> (<em>AND</em>) operator.</p>
</blockquote>
<blockquote>
<p>For queries to produce results, all of the expressions in the query must be <em>true</em> or <em>defined</em>. The <em>order</em> of expressions <em>does not matter</em>.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.id == <span class="string">&quot;app&quot;</span>; input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.protocols<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> == <span class="string">&quot;ssh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can <em>omit</em> the <code>;</code> (<em>AND</em>) operator by splitting expressions across <em>multiple lines</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.servers[<span class="number">0</span>].id == <span class="string">&quot;app&quot;</span></span><br><span class="line">input.servers[<span class="number">0</span>].protocols[<span class="number">1</span>] == <span class="string">&quot;ssh&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If any of the expressions in the query are not true (or defined) the result is <em>undefined</em>. </p>
</blockquote>
<h3 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h3><blockquote>
<p>You can store values in <em>intermediate variables</em> using the <code>:=</code> (<em>assignment</em>) operator. Variables can be referenced just like <code>input</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[<span class="number">0</span>]</span><br><span class="line">s.id == <span class="string">&quot;app&quot;</span></span><br><span class="line">p := s.protocols[<span class="number">0</span>]</span><br><span class="line">p == <span class="string">&quot;https&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">|    p    |                                 s                                 |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">| <span class="string">&quot;https&quot;</span> | &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;app&quot;</span>,<span class="string">&quot;ports&quot;</span>:[<span class="string">&quot;p1&quot;</span>,<span class="string">&quot;p2&quot;</span>,<span class="string">&quot;p3&quot;</span>],<span class="string">&quot;protocols&quot;</span>:[<span class="string">&quot;https&quot;</span>,<span class="string">&quot;ssh&quot;</span>]&#125; |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When OPA evaluates expressions, it finds values for the variables that make <em>all</em> of the expressions <em>true</em>.<br>If there are no variable assignments that make all of the expressions true, the result is <em>undefined</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[<span class="number">0</span>]</span><br><span class="line">s.id == <span class="string">&quot;app&quot;</span></span><br><span class="line">s.protocols[<span class="number">1</span>] == <span class="string">&quot;telnet&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Variables are <em>immutable</em>. OPA reports an error if you try to assign the same variable twice.</p>
</blockquote>
<blockquote>
<p>OPA must be able to <em>enumerate</em> the values for <em>all variables</em> in all expressions.<br>If OPA cannot enumerate the values of a variable in any expression, OPA will report an error.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="number">1</span></span><br><span class="line">x != y  # y has not been assigned a value</span><br></pre></td></tr></table></figure>

<h3 id="Iteration"><a href="#Iteration" class="headerlink" title="Iteration"></a>Iteration</h3><ol>
<li>Like other declarative languages (e.g., SQL), iteration in Rego happens <em>implicitly</em> when you <em>inject variables into expressions</em>.</li>
<li>There are <em>explicit iteration</em> constructs to express <em>FOR ALL</em> and <em>FOR SOME</em></li>
</ol>
<blockquote>
<p>need to check if any networks are public</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">input.networks</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Now the query asks for values of <code>i</code> that make the <em>overall</em> expression <em>true</em>.</p>
</blockquote>
<blockquote>
<p>When you substitute variables in references, OPA automatically finds variable assignments that satisfy <em>all</em> of the expressions in the query.<br>Just like <em>intermediate variables</em>, OPA returns the values of the variables.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">some i; input.networks[i].public == <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+---+</span><br><span class="line">| i |</span><br><span class="line">+---+</span><br><span class="line">| <span class="number">2</span> |</span><br><span class="line">| <span class="number">3</span> |</span><br><span class="line">+---+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can substitute as <em>many</em> variables as you want.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">some i, j; input.servers[i].protocols[j] == <span class="string">&quot;http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+---+---+</span><br><span class="line">| i | j |</span><br><span class="line">+---+---+</span><br><span class="line">| <span class="number">3</span> | <span class="number">0</span> |</span><br><span class="line">+---+---+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If variables appear <em>multiple times</em> the assignments satisfy <em>all</em> of the expressions.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">some i, j</span><br><span class="line">id := input.ports[i].id</span><br><span class="line">input.ports[i].network == input.networks[j].id</span><br><span class="line">input.networks[j].public</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+---+------+---+</span><br><span class="line">| i |  id  | j |</span><br><span class="line">+---+------+---+</span><br><span class="line">| <span class="number">1</span> | <span class="string">&quot;p2&quot;</span> | <span class="number">2</span> |</span><br><span class="line">+---+------+---+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you only refer to the variable <em>once</em>, you can replace it with the special <code>_</code> (wildcard variable) operator. Conceptually, each instance of <code>_</code> is a <em>unique</em> variable.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input.servers[_].protocols[_] == <span class="string">&quot;http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If OPA is unable to find any variable assignments that satisfy <em>all</em> of the expressions, the result is <em>undefined</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">some i; input.servers[i].protocols[i] == <span class="string">&quot;ssh&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>backwards-compatibility</p>
</blockquote>
<ol>
<li>In the first stage, users can opt-in to using the new keywords via a special import: <code>import future.keywords.every</code> introduces the <code>every</code> keyword described here.<ul>
<li>Importing <code>every</code> means also importing <code>in</code> without an extra <code>import</code> statement.</li>
</ul>
</li>
<li>At some point in the future, the keyword will become <em>standard</em>, and the import will become a no-op that can safely be removed.</li>
</ol>
<h4 id="FOR-SOME"><a href="#FOR-SOME" class="headerlink" title="FOR SOME"></a>FOR SOME</h4><ol>
<li><code>some ... in ...</code> is used to iterate over the collection (its last argument), and will bind its variables (<em>key</em>, <em>value position</em>) to the collection items.</li>
<li>It introduces <em>new bindings</em> to the evaluation of the rest of the rule body.</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public_network contains net.id <span class="keyword">if</span> &#123;</span><br><span class="line">    some net in input.networks # some network exists and..</span><br><span class="line">    net.public                 # it is public.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;net3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;net4&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">shell_accessible contains server.id <span class="keyword">if</span> &#123;</span><br><span class="line">    some server in input.servers</span><br><span class="line">    <span class="string">&quot;telnet&quot;</span> in server.protocols</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible contains server.id <span class="keyword">if</span> &#123;</span><br><span class="line">    some server in input.servers</span><br><span class="line">    <span class="string">&quot;ssh&quot;</span> in server.protocols</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">  <span class="string">&quot;busybox&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="FOR-ALL"><a href="#FOR-ALL" class="headerlink" title="FOR ALL"></a>FOR ALL</h4><blockquote>
<p><code>every</code> allows us to succinctly express that a condition holds for <em>all elements of a domain</em>.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ftp&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">no_telnet_exposed <span class="keyword">if</span> &#123;</span><br><span class="line">    every server in input.servers &#123;</span><br><span class="line">        every protocol in server.protocols &#123;</span><br><span class="line">            <span class="string">&quot;telnet&quot;</span> != protocol</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">no_telnet_exposed_alt <span class="keyword">if</span> &#123;</span><br><span class="line">    every server in input.servers &#123;</span><br><span class="line">        not <span class="string">&quot;telnet&quot;</span> in server.protocols</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">any_telnet_exposed <span class="keyword">if</span> &#123;</span><br><span class="line">    some server in input.servers</span><br><span class="line">    <span class="string">&quot;telnet&quot;</span> in server.protocols</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">no_telnet_exposed_not_any <span class="keyword">if</span> &#123;</span><br><span class="line">    not any_telnet_exposed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3><blockquote>
<p>Rego lets you <em>encapsulate</em> and <em>re-use</em> logic with rules. Rules are just <em>if-then</em> logic statements.</p>
</blockquote>
<h4 id="Complete-Rules"><a href="#Complete-Rules" class="headerlink" title="Complete Rules"></a>Complete Rules</h4><blockquote>
<p>Complete rules are <em>if-then</em> statements that assign <em>a single value</em> to <em>a variable</em>.</p>
</blockquote>
<blockquote>
<p>Every rule consists of a <em>head</em> and a <em>body</em>.<br>In Rego we say the rule head is true <em>if</em> the rule body is true for some set of variable assignments.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks := <span class="literal">true</span> <span class="keyword">if</span> &#123;</span><br><span class="line">    some net in input.networks # some network exists and..</span><br><span class="line">    net.public                 # it is public.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>any_public_networks := true</code> is the head</li>
<li><code>some net in input.networks; net.public</code> is the body</li>
</ol>
<blockquote>
<p><em>All values generated by rules</em> can be queried via the global <code>data</code> variable.<br>The path of a rule is always: <code>data.&lt;package-path&gt;.&lt;rule-name&gt;</code>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data.example.rules.any_public_networks</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you <em>omit</em> the <code>= &lt;value&gt;</code> part of the <em>rule head</em> the value defaults to <code>true</code>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks <span class="keyword">if</span> &#123;</span><br><span class="line">    some net in input.networks</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>To define <em>constants</em>, <em>omit</em> the <em>rule body</em>. When you <em>omit</em> the <em>rule body</em> it defaults to <code>true</code>.<br>Since the <em>rule body</em> is <em>true</em>, the <em>rule head</em> is <code>always</code> true&#x2F;defined.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.constants</span><br><span class="line"></span><br><span class="line">pi := <span class="number">3.14</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pi &gt; <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If OPA cannot find variable assignments that satisfy the <em>rule body</em>, we say that the rule is <em>undefined</em>.(which is not the same as <em>false</em>.) </p>
</blockquote>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;n1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;n2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks <span class="keyword">if</span> &#123;</span><br><span class="line">    some net in input.networks</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">undefined decision</span><br></pre></td></tr></table></figure>

<h4 id="Partial-Rules"><a href="#Partial-Rules" class="headerlink" title="Partial Rules"></a>Partial Rules</h4><blockquote>
<p>Partial rules are <em>if-then</em> statements that generate <em>a set of values</em> and assign that set to <em>a variable</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public_network contains net.id <span class="keyword">if</span> &#123;</span><br><span class="line">    some net in input.networks # some network exists and..</span><br><span class="line">    net.public                 # it is public.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;net3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;net4&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ol>
<li><code>public_network[net.id]</code> is the rule head</li>
<li><code>net := input.networks[_]; net.public</code> is the rule body</li>
</ol>
<blockquote>
<p>Iteration over the <em>set of values</em> can be done with the <code>some ... in ...</code> expression</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">some net in public_network</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+--------+</span><br><span class="line">|  net   |</span><br><span class="line">+--------+</span><br><span class="line">| <span class="string">&quot;net3&quot;</span> |</span><br><span class="line">| <span class="string">&quot;net4&quot;</span> |</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>With a <em>literal</em>, or a bound variable, you can check if the value <em>exists</em> in the set via <code>... in ...</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;net3&quot;</span> in public_network</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can also iterate over the set of values by referencing the set elements with a variable</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">some n; public_network[n]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+--------+-------------------+</span><br><span class="line">|   n    | public_network[n] |</span><br><span class="line">+--------+-------------------+</span><br><span class="line">| <span class="string">&quot;net3&quot;</span> | <span class="string">&quot;net3&quot;</span>            |</span><br><span class="line">| <span class="string">&quot;net4&quot;</span> | <span class="string">&quot;net4&quot;</span>            |</span><br><span class="line">+--------+-------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Lastly, you can check if a value <em>exists</em> in the set using the same syntax</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public_network[<span class="string">&quot;net3&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;net3&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Logical-OR"><a href="#Logical-OR" class="headerlink" title="Logical OR"></a>Logical OR</h4><blockquote>
<p>When you join <em>multiple expressions</em> together in a query you are expressing logical <em>AND</em>.<br>To express logical <em>OR</em> in Rego you define <em>multiple rules</em> with the <em>same name</em>.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">,</span> <span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Declares <code>shell_accessible</code> to be <code>true</code> if any servers expose the <code>&quot;telnet&quot;</code> or <code>&quot;ssh&quot;</code> protocols</p>
</blockquote>
<blockquote>
<p>The <code>default</code> keyword tells OPA to assign a value to the variable if all of the other rules with the <em>same name</em> are <em>undefined</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.logical_or</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> shell_accessible := <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">shell_accessible := <span class="literal">true</span> &#123;</span><br><span class="line">    input.servers[_].protocols[_] == <span class="string">&quot;telnet&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible := <span class="literal">true</span> &#123;</span><br><span class="line">    input.servers[_].protocols[_] == <span class="string">&quot;ssh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>When you use logical <em>OR</em> with <em>partial rules</em>, each rule definition <em>contributes</em> to the <em>set of values</em> assigned to the variable.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">,</span> <span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.logical_or</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;telnet&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;ssh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;busybox&quot;</span>,</span><br><span class="line">  <span class="string">&quot;db&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="Putting-It-Together"><a href="#Putting-It-Together" class="headerlink" title="Putting It Together"></a>Putting It Together</h3><blockquote>
<p>desired policy - At a high-level the policy needs to identify servers that violate some conditions.</p>
</blockquote>
<ol>
<li>Servers reachable from the Internet must not expose the insecure ‘http’ protocol.</li>
<li>Servers are not allowed to expose the ‘telnet’ protocol.</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"><span class="keyword">import</span> future.keywords.every # <span class="string">&quot;every&quot;</span> implies <span class="string">&quot;in&quot;</span></span><br><span class="line"></span><br><span class="line">allow := <span class="literal">true</span> &#123;                                     # allow is <span class="literal">true</span> <span class="keyword">if</span>...</span><br><span class="line">    count(violation) == <span class="number">0</span>                           # there are zero violations.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set <span class="keyword">if</span>...</span><br><span class="line">    some server in public_servers                   # it exists in the <span class="string">&#x27;public_servers&#x27;</span> set and...</span><br><span class="line">    <span class="string">&quot;http&quot;</span> in server.protocols                      # it contains the insecure <span class="string">&quot;http&quot;</span> protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set <span class="keyword">if</span>...</span><br><span class="line">    some server in input.servers                    # it exists in the input.servers collection and...</span><br><span class="line">    <span class="string">&quot;telnet&quot;</span> in server.protocols                    # it contains the <span class="string">&quot;telnet&quot;</span> protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public_servers[server] &#123;                            # a server exists in the public_servers set <span class="keyword">if</span>...</span><br><span class="line">    some server in input.servers                    # it exists in the input.servers collection and...</span><br><span class="line"></span><br><span class="line">    some port in server.ports                       # it references a port in the input.ports collection and...</span><br><span class="line">    some input_port in input.ports</span><br><span class="line">    port == input_port.id</span><br><span class="line"></span><br><span class="line">    some input_network in input.networks            # the port references a network in the input.networks collection and...</span><br><span class="line">    input_port.network == input_network.id</span><br><span class="line">    input_network.public                            # the network is public.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line">some x; violation[x]</span><br><span class="line"></span><br><span class="line">+-----------+--------------+</span><br><span class="line">|     x     | violation[x] |</span><br><span class="line">+-----------+--------------+</span><br><span class="line">| <span class="string">&quot;busybox&quot;</span> | <span class="string">&quot;busybox&quot;</span>    |</span><br><span class="line">| <span class="string">&quot;ci&quot;</span>      | <span class="string">&quot;ci&quot;</span>         |</span><br><span class="line">+-----------+--------------+</span><br></pre></td></tr></table></figure>

<h2 id="Running-OPA"><a href="#Running-OPA" class="headerlink" title="Running OPA"></a>Running OPA</h2><h3 id="opa-eval"><a href="#opa-eval" class="headerlink" title="opa eval"></a>opa eval</h3><blockquote>
<p>It is a swiss-army knife that you can use to evaluate <em>arbitrary</em> Rego expressions and policies. </p>
</blockquote>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Short</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>--bundle</code></td>
<td>-b</td>
<td>Load a bundle file or directory into OPA. This flag can be repeated.</td>
</tr>
<tr>
<td><code>--data</code></td>
<td>-d</td>
<td>Load policy or data files into OPA. This flag can be repeated.</td>
</tr>
<tr>
<td><code>--input</code></td>
<td>-i</td>
<td>Load a data file and use it as input. This flag cannot be repeated.</td>
</tr>
<tr>
<td><code>--format</code></td>
<td>-f</td>
<td>Set the <em>output</em> format to use.<br />The default is <code>json</code> and is intended for programmatic use.<br />The <code>pretty</code> format emits more human-readable output.</td>
</tr>
<tr>
<td><code>--fail</code></td>
<td>n&#x2F;a</td>
<td>Exit with a non-zero exit code if the query is undefined.</td>
</tr>
<tr>
<td><code>--fail-defined</code></td>
<td>n&#x2F;a</td>
<td>Exit with a non-zero exit code if the query is not undefined.</td>
</tr>
</tbody></table>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>example.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> allow := <span class="literal">false</span>                              # unless otherwise defined, allow is <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">allow := <span class="literal">true</span> &#123;                                     # allow is <span class="literal">true</span> <span class="keyword">if</span>...</span><br><span class="line">    count(violation) == <span class="number">0</span>                           # there are zero violations.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set <span class="keyword">if</span>...</span><br><span class="line">    some server</span><br><span class="line">    public_server[server]                           # it exists in the <span class="string">&#x27;public_server&#x27;</span> set and...</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;http&quot;</span>                   # it contains the insecure <span class="string">&quot;http&quot;</span> protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set <span class="keyword">if</span>...</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;telnet&quot;</span>                 # it contains the <span class="string">&quot;telnet&quot;</span> protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public_server[server] &#123;                             # a server exists in the public_server set <span class="keyword">if</span>...</span><br><span class="line">    some i, j</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.ports[_] == input.ports[i].id            # it references a port in the input.ports collection and...</span><br><span class="line">    input.ports[i].network == input.networks[j].id  # the port references a network in the input.networks collection and...</span><br><span class="line">    input.networks[j].public                        # the network is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Evaluate a trivial expression.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ opa eval &#x27;1*2+3&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: 5,</span><br><span class="line">          &quot;text&quot;: &quot;1*2+3&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Evaluate a policy on the command line.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ opa eval -i input.json -d example.rego &quot;data.example.violation[x]&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;busybox&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;busybox&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;ci&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;ci&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Evaluate a policy on the command line and use the exit code.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ opa eval --fail-defined -i input.json -d example.rego &quot;data.example.violation[x]&quot;</span><br><span class="line"></span><br><span class="line">$ echo $?</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ opa eval --fail -i input.json -d example.rego &quot;data.example.violation[x]&quot;</span><br><span class="line"></span><br><span class="line">$ echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h3 id="opa-run"><a href="#opa-run" class="headerlink" title="opa run"></a>opa run</h3><h4 id="interactive"><a href="#interactive" class="headerlink" title="interactive"></a>interactive</h4><blockquote>
<p>When you enter statements in the REPL, OPA evaluates them and prints the result.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ opa run</span><br><span class="line">OPA 0.42.0 (commit 9b5fb9b, built at 2022-07-04T12:21:01Z)</span><br><span class="line"></span><br><span class="line">Run &#x27;help&#x27; to see a list of commands and check for updates.</span><br><span class="line"></span><br><span class="line">&gt; true</span><br><span class="line">true</span><br><span class="line">&gt; 3.14</span><br><span class="line">3.14</span><br><span class="line">&gt; [&quot;hello&quot;, &quot;world&quot;]</span><br><span class="line">[</span><br><span class="line">  &quot;hello&quot;,</span><br><span class="line">  &quot;world&quot;</span><br><span class="line">]</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Most REPLs let you define variables that you can reference later on.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ opa run</span><br><span class="line">OPA 0.42.0 (commit 9b5fb9b, built at 2022-07-04T12:21:01Z)</span><br><span class="line"></span><br><span class="line">Run &#x27;help&#x27; to see a list of commands and check for updates.</span><br><span class="line"></span><br><span class="line">&gt; pi := 3.14</span><br><span class="line">Rule &#x27;pi&#x27; defined in package repl. Type &#x27;show&#x27; to see rules.</span><br><span class="line">&gt; show</span><br><span class="line">package repl</span><br><span class="line"></span><br><span class="line">pi := 3.14</span><br><span class="line">&gt;</span><br><span class="line">&gt; pi</span><br><span class="line">3.14</span><br><span class="line">&gt;</span><br><span class="line">&gt; pi &gt; 3</span><br><span class="line">true</span><br><span class="line">&gt;</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can load <em>policy</em> and <em>data</em> files into the REPL by passing them on the command line.<br>By default, <em>JSON</em> and <em>YAML</em> files are rooted under <code>data</code>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ opa run input.json</span><br><span class="line">OPA 0.42.0 (commit 9b5fb9b, built at 2022-07-04T12:21:01Z)</span><br><span class="line"></span><br><span class="line">Run &#x27;help&#x27; to see a list of commands and check for updates.</span><br><span class="line"></span><br><span class="line">&gt; data.servers[0].protocols[1]</span><br><span class="line">&quot;ssh&quot;</span><br><span class="line">&gt;</span><br><span class="line">&gt; data.servers[i].protocols[j]</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| i | j | data.servers[i].protocols[j] |</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| 0 | 0 | &quot;https&quot;                      |</span><br><span class="line">| 0 | 1 | &quot;ssh&quot;                        |</span><br><span class="line">| 1 | 0 | &quot;mysql&quot;                      |</span><br><span class="line">| 2 | 0 | &quot;memcache&quot;                   |</span><br><span class="line">| 3 | 0 | &quot;http&quot;                       |</span><br><span class="line">| 4 | 0 | &quot;telnet&quot;                     |</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">&gt;</span><br><span class="line">&gt; net := data.networks[_]; net.public</span><br><span class="line">+-----------------------------+</span><br><span class="line">|             net             |</span><br><span class="line">+-----------------------------+</span><br><span class="line">| &#123;&quot;id&quot;:&quot;net3&quot;,&quot;public&quot;:true&#125; |</span><br><span class="line">| &#123;&quot;id&quot;:&quot;net4&quot;,&quot;public&quot;:true&#125; |</span><br><span class="line">+-----------------------------+</span><br><span class="line">&gt;</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<blockquote>
<p>To set a <em>data</em> file as the <code>input</code> document in the REPL prefix the file path</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ opa run example.rego repl.input:input.json</span><br><span class="line">OPA 0.42.0 (commit 9b5fb9b, built at 2022-07-04T12:21:01Z)</span><br><span class="line"></span><br><span class="line">Run &#x27;help&#x27; to see a list of commands and check for updates.</span><br><span class="line"></span><br><span class="line">&gt; data.example.public_server[s]</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br><span class="line">|                                 s                                 |                   data.example.public_server[s]                   |</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br><span class="line">| &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; | &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; |</span><br><span class="line">| &#123;&quot;id&quot;:&quot;ci&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;],&quot;protocols&quot;:[&quot;http&quot;]&#125;              | &#123;&quot;id&quot;:&quot;ci&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;],&quot;protocols&quot;:[&quot;http&quot;]&#125;              |</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br><span class="line">&gt;</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<ol>
<li>Prefixing file paths with a reference controls where file is loaded under <code>data</code>.</li>
<li>By convention, the REPL sets the <code>input</code> document that queries see by reading <code>data.repl.input</code> each time a statement is evaluated.</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">$ opa run example.rego repl.input<span class="punctuation">:</span>input.json</span><br><span class="line">OPA <span class="number">0.42</span><span class="number">.0</span> (commit <span class="number">9</span>b5fb9b<span class="punctuation">,</span> built at <span class="number">2022</span><span class="number">-07</span><span class="number">-04</span>T12<span class="punctuation">:</span><span class="number">21</span><span class="punctuation">:</span><span class="number">01</span>Z)</span><br><span class="line"></span><br><span class="line">Run &#x27;help&#x27; to see a list of commands and check for updates.</span><br><span class="line"></span><br><span class="line">&gt; input</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;p3&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ssh&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;p3&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;mysql&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;p3&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;memcache&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;p2&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;http&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;p1&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;telnet&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt; data</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;example&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;allow&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;public_server&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;p3&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ssh&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;p2&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;violation&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;ci&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;repl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;p3&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;ssh&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;p3&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;mysql&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;p3&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;memcache&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;p2&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;http&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;p1&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;telnet&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">&gt;</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><blockquote>
<p>To integrate with OPA you can run it as a server and execute queries over <em>HTTP</em>.(<code>-s</code> &#x2F; <code>--server</code>)<br>By default OPA listens for HTTP connections on <code>0.0.0.0:8181</code>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ opa run -s example.rego</span><br><span class="line">&#123;&quot;addrs&quot;:[&quot;:8181&quot;],&quot;diagnostic-addrs&quot;:[],&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;Initializing server. OPA is running on a public (0.0.0.0) network interface. Unless you intend to expose OPA outside of the host, binding to the localhost interface (--addr localhost:8181) is recommended. See https://www.openpolicyagent.org/docs/latest/security/#interface-binding&quot;,&quot;time&quot;:&quot;2022-10-14T22:32:11+08:00&quot;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When you query the <code>/v1/data</code> HTTP API you must wrap <em>input</em> data inside of a JSON object</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> &lt;value&gt;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF &gt; v1-data-input.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> $(cat input.json)</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ cat v1-data-input.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s <span class="number">127.1</span><span class="punctuation">:</span><span class="number">8181</span>/v1/data/example/violation -d @v1-data-input.json -H &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; | jq</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;ci&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">$ curl -s <span class="number">127.1</span><span class="punctuation">:</span><span class="number">8181</span>/v1/data/example/allow -d @v1-data-input.json -H &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27; | jq</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>By default <code>data.system.main</code> is used to serve policy queries <em>without</em> a path.<br>When you execute queries without providing a path, you do not have to wrap the <em>input</em>.<br>If the <code>data.system.main</code> decision is <em>undefined</em> it is treated as an <em>error</em>.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="number">127.1</span><span class="punctuation">:</span><span class="number">8181</span> -d @input.json -H &#x27;Content-Type<span class="punctuation">:</span> application/json&#x27;</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> Not Found</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Date<span class="punctuation">:</span> Sat<span class="punctuation">,</span> <span class="number">14</span> Oct <span class="number">2022</span> <span class="number">14</span><span class="punctuation">:</span><span class="number">43</span><span class="punctuation">:</span><span class="number">27</span> GMT</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">86</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;undefined_document&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;document missing: data.system.main&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can restart OPA and configure to use any decision as the default decision - <code>default_decision</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ opa run -s --set=default_decision=example/allow  example.rego</span><br><span class="line">&#123;&quot;addrs&quot;:[&quot;:8181&quot;],&quot;diagnostic-addrs&quot;:[],&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;Initializing server. OPA is running on a public (0.0.0.0) network interface. Unless you intend to expose OPA outside of the host, binding to the localhost interface (--addr localhost:8181) is recommended. See https://www.openpolicyagent.org/docs/latest/security/#interface-binding&quot;,&quot;time&quot;:&quot;2022-10-14T22:45:16+08:00&quot;&#125;</span><br><span class="line"></span><br><span class="line">$ curl -i 127.1:8181 -d @input.json -H &#x27;Content-Type: application/json&#x27;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Date: Sat, 14 Oct 2022 14:45:37 GMT</span><br><span class="line">Content-Length: 6</span><br><span class="line"></span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<h3 id="go-library"><a href="#go-library" class="headerlink" title="go library"></a>go library</h3><blockquote>
<p>OPA can be embedded inside Go programs as a library.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;context&quot;</span><br><span class="line">    &quot;encoding/json&quot;</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;github.com/open-policy-agent/opa/rego&quot;</span><br><span class="line">    &quot;log&quot;</span><br><span class="line">    &quot;os&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line"></span><br><span class="line">    // Construct a Rego object that can be prepared or evaluated.</span><br><span class="line">    r := rego.New(</span><br><span class="line">        rego.Query(os.Args[2]),</span><br><span class="line">        rego.Load([]string&#123;os.Args[1]&#125;, nil))</span><br><span class="line"></span><br><span class="line">    // Create a prepared query that can be evaluated.</span><br><span class="line">    query, err := r.PrepareForEval(ctx)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Load the input document from stdin.</span><br><span class="line">    var input interface&#123;&#125;</span><br><span class="line">    dec := json.NewDecoder(os.Stdin)</span><br><span class="line">    dec.UseNumber()</span><br><span class="line">    if err := dec.Decode(&amp;input); err != nil &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Execute the prepared query.</span><br><span class="line">    rs, err := query.Eval(ctx, rego.EvalInput(input))</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Do something with the result.</span><br><span class="line">    fmt.Println(rs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go example.rego &#x27;data.example.violation&#x27; &lt; input.json</span><br><span class="line">[&#123;[[busybox ci]] map[]&#125;]</span><br></pre></td></tr></table></figure>

<h1 id="Philosophy"><a href="#Philosophy" class="headerlink" title="Philosophy"></a>Philosophy</h1><ol>
<li>A <em>policy</em> is a set of <em>rules</em> that governs the <em>behavior</em> of a software service.</li>
<li>OPA helps you <em>decouple</em> any policy using any context from any software system.</li>
</ol>
<h2 id="Policy-Decoupling"><a href="#Policy-Decoupling" class="headerlink" title="Policy Decoupling"></a>Policy Decoupling</h2><blockquote>
<p>Software services should allow policies to be <em>specified declaratively</em>, <em>updated at any time without recompiling or redeploying</em>, and <em>enforced automatically</em>.</p>
</blockquote>
<h2 id="What-is-OPA"><a href="#What-is-OPA" class="headerlink" title="What is OPA?"></a>What is OPA?</h2><ol>
<li>OPA is a <em>lightweight</em> general-purpose policy engine that can be <em>co-located</em> with your service. You can integrate OPA as a <em>sidecar</em>, <em>host-level daemon</em>, or <em>library</em>.</li>
<li>Services <em>offload policy decisions</em> to OPA by executing <em>queries</em>.<ul>
<li>OPA evaluates <em>policies</em> and <em>data</em> to produce <em>query results</em> (which are sent back to the client).</li>
<li><em>Policies</em> are written in a <em>high-level declarative language</em> and can be loaded <em>dynamically</em> into OPA remotely via <em>APIs</em> or through the <em>local filesystem</em>.</li>
</ul>
</li>
</ol>
<h2 id="Why-use-OPA"><a href="#Why-use-OPA" class="headerlink" title="Why use OPA?"></a>Why use OPA?</h2><ol>
<li>OPA is a <em>full-featured policy engine</em> that <em>offloads policy decisions</em> from your software.</li>
<li>Without OPA, you need to implement <em>policy management</em> for your software from scratch. That’s a lot of work.</li>
</ol>
<h2 id="Document-Model"><a href="#Document-Model" class="headerlink" title="Document Model"></a>Document Model</h2><ol>
<li>OPA policies (written in Rego) make decisions based on <em>hierarchical structured</em> data.</li>
<li>Importantly, OPA policies can make decisions based on <em>arbitrary</em> structured data.</li>
<li>OPA itself is <em>not tied to</em> any particular domain model.</li>
<li>Similarly, OPA policies can represent <em>decisions</em> as <em>arbitrary</em> structured data.</li>
<li>Data can be loaded into OPA from outside world using <em>push</em> or <em>pull</em> interfaces that operate <em>synchronously</em> or <em>asynchronously</em> with respect to policy evaluation.</li>
<li>We refer to all data loaded into OPA from the <em>outside</em> world as <em>base documents</em>.<ul>
<li>These base documents almost always contribute to your policy decision-making logic.</li>
<li>However, your policies can also make decisions based on each other.</li>
</ul>
</li>
<li>Policies almost always consist of <em>multiple rules</em> that refer to other rules (possibly authored by different groups).</li>
<li>In OPA, we refer to the values <em>generated by rules</em> (a.k.a., <em>decisions</em>) as <em>virtual documents</em>.<ul>
<li>The term <em>virtual</em> in this case just means the document is <em>computed</em> by the policy, i.e., it’s not loaded into OPA from the outside world.</li>
</ul>
</li>
<li>Base and virtual documents can represent the exact <em>same kind</em> of information.<ul>
<li>Moreover, with Rego, you can refer to both <em>base</em> and <em>virtual</em> documents using the exact same dot&#x2F;bracket-style reference syntax.</li>
</ul>
</li>
<li>Consistency across the types of values that can be represented and the way those values are referenced means that <em>policy authors only need to learn one way of modeling and referring to information that drives policy decision-making</em>.</li>
<li>Additionally, since there is <em>no conceptual difference</em> in the types of values or the way you refer to those values in <em>base</em> and <em>virtual</em> documents<ul>
<li>Rego lets you refer to <em>both</em> base and virtual documents through a global variable called <code>data</code>.</li>
<li>Similarly, OPA lets you query for both <em>base</em> and <em>virtual</em> documents via the <code>/v1/data</code> HTTP API.</li>
</ul>
</li>
<li><em>location</em><ul>
<li>Since <em>base</em> documents come from <em>outside</em> of OPA, their <em>location</em> under <code>data</code> is controlled by the software doing the <em>loading</em>.</li>
<li>On the other hand, the <em>location</em> of <em>virtual</em> documents under <code>data</code> is controlled by policies themselves using the <code>package</code> directive in the language.</li>
</ul>
</li>
<li><em>Base</em> documents can be <em>pushed</em> or <em>pulled</em> into OPA <em>asynchronously</em> by <em>replicating</em> data into OPA when the state of the world changes.<ul>
<li>This can happen <em>periodically</em> or when some <em>event</em> (like a database change notification) occurs.</li>
<li><em>Base</em> documents loaded <em>asynchronously</em> are <em>always</em> accessed under the <code>data</code> global variable.</li>
<li>On the other hand, <em>base</em> documents can also be <em>pushed</em> or <em>pulled</em> into OPA <em>synchronously</em> when your software queries OPA for policy decisions.</li>
<li>We refer to <em>base</em> documents <em>pushed synchronously</em> as <em>input</em>. Policies can access these inputs under the <code>input</code> global variable.</li>
<li>To <em>pull</em> base documents <em>during policy evaluation</em>, OPA exposes (and can be extended with custom) built-in functions like <code>http.send</code>.</li>
<li>Built-in function return values can be assigned to <em>local variables</em> and surfaced in <em>virtual</em> documents.</li>
<li>Data loaded <em>synchronously</em> is kept outside of <code>data</code> to avoid naming conflicts.</li>
</ul>
</li>
</ol>
<blockquote>
<p>Summarizes the different models for loading <em>base</em> documents into OPA, how they can be referenced inside of policies, and the actual mechanism(s) for loading.</p>
</blockquote>
<blockquote>
<p><em>Asynchronous - <code>data</code></em></p>
</blockquote>
<table>
<thead>
<tr>
<th>Model</th>
<th>How to access in Rego</th>
<th>How to integrate with OPA</th>
</tr>
</thead>
<tbody><tr>
<td>Asynchronous Push</td>
<td>The <code>data</code> global variable</td>
<td>Invoke OPA’s API(s), e.g., <code>PUT /v1/data</code></td>
</tr>
<tr>
<td><code>Asynchronous Pull</code></td>
<td>The <code>data</code> global variable</td>
<td>Configure OPA’s <em>Bundle</em> feature</td>
</tr>
<tr>
<td>Synchronous Push</td>
<td>The <code>input</code> global variable</td>
<td>Provide data in policy query, e.g., inside the body of <code>POST /v1/data</code></td>
</tr>
<tr>
<td>Synchronous Pull</td>
<td>The built-in functions, e.g., <code>http.send</code></td>
<td>N&#x2F;A</td>
</tr>
</tbody></table>
<ol>
<li><em>Data</em> loaded <em>asynchronously</em> into OPA is <em>cached in-memory</em> so that it can be <em>read efficiently</em> during <em>policy evaluation</em>.</li>
<li>Similarly, <em>policies</em> are also <em>cached in-memory</em> to ensure <em>high-performance</em> and <em>high-availability</em>.</li>
<li><em>Data pulled synchronously</em> can also be <em>cached in-memory</em>.</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231015014126972.png" alt="image-20231015014126972"></p>
<ol>
<li><em>base</em><ul>
<li>API request information <em>pushed synchronously</em> located under <code>input</code>.</li>
<li>Entitlements data <em>pulled asynchronously</em> and located under <code>data.entitlements</code>.</li>
<li>Resource data <em>pulled synchronously</em> during policy evaluation using the <code>http.send</code> built-in function.</li>
</ul>
</li>
<li><em>virtual</em><ul>
<li>The entitlements and resource information is <em>abstracted</em> by rules that <em>generate virtual documents</em> named <code>data.iam.user_has_role</code> and <code>data.acme.user_is_assigned</code> respectively.</li>
</ul>
</li>
</ol>
<h1 id="External-Data"><a href="#External-Data" class="headerlink" title="External Data"></a>External Data</h1><ol>
<li>OPA was designed to let you make <em>context-aware</em> authorization and policy decisions by <em>injecting external data</em> that describes what is happening in the world and then writing policy using that data.<ul>
<li>OPA has a <em>cache</em> or <em>replica</em> of that <em>data</em>, just as OPA has a <em>cache&#x2F;replica</em> of <em>policy</em>; OPA is not designed to be the source of truth for either.</li>
</ul>
</li>
<li>This document describes options for <em>replicating</em> data into OPA.<ul>
<li>The content of the data does not matter, but the <em>size</em>, <em>frequency of update</em>, and <em>consistency constraints</em> all do impact which kind of <em>data replication</em> to employ.</li>
<li>You should prefer earlier options in the list to later options, but in the end the right choice depends on your situation.</li>
</ul>
</li>
</ol>
<h2 id="JWT-Tokens"><a href="#JWT-Tokens" class="headerlink" title="JWT Tokens"></a>JWT Tokens</h2><ol>
<li>JSON Web Tokens (JWTs) allow you to <em>securely transmit JSON data</em> between software systems and are usually produced during the <em>authentication</em> process.</li>
<li>You can set up authentication so that when the user <em>logs in</em> you <em>create a JWT</em> with that user’s attributes (or any other data as far as OPA is concerned).</li>
<li>Then you hand that JWT to OPA and use OPA’s specialized support for JWTs to <em>extract</em> the information you need to make a policy decision.</li>
</ol>
<h3 id="Flow"><a href="#Flow" class="headerlink" title="Flow"></a>Flow</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231015102647908.png" alt="image-20231015102647908"></p>
<ol>
<li>User <em>logs in</em> to an authentication system, e.g. LDAP&#x2F;AD&#x2F;etc.</li>
<li>The user is given a <em>JWT token</em> encoding group membership and other user attributes stored in LDAP&#x2F;AD</li>
<li>The user provides that JWT token to an <em>OPA-enabled software system</em> for authentication</li>
<li>The OPA-enabled software system includes that token as part of the usual <code>input</code> to OPA.</li>
<li>OPA <em>decodes</em> the JWT token and uses the contents to make policy decisions.</li>
</ol>
<h3 id="Updates"><a href="#Updates" class="headerlink" title="Updates"></a>Updates</h3><ol>
<li>The JWT only gets refreshed when the user <em>authenticates</em>; how often that happens is up to the <em>TTL</em> included in the token.</li>
<li>When <em>user-attribute information changes</em>, those changes will not be seen by OPA until the user authenticates and <em>gets a new JWT</em>.</li>
</ol>
<h3 id="Size-Limitations"><a href="#Size-Limitations" class="headerlink" title="Size Limitations"></a>Size Limitations</h3><ol>
<li>JWTs have a limited size in practice, so if your organization has too many user attributes you may not be able to fit all the required information into a JWT.</li>
</ol>
<h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><ol>
<li>OPA includes <em>primitives</em> to <em>verify</em> the <em>signature</em> of JWT tokens.</li>
<li>OPA let’s you check the <em>TTL</em>.</li>
<li>OPA has support for making <em>HTTP</em> requests during <em>evaluation</em>, which could be used to check if a JWT has been <em>revoked</em>.</li>
</ol>
<h2 id="Overload-input"><a href="#Overload-input" class="headerlink" title="Overload input"></a>Overload input</h2><ol>
<li>For example, suppose your policy says that only a file’s owner may delete it.<ul>
<li>The authentication system does not track resource-ownership, but the system responsible for files certainly does.</li>
</ul>
</li>
<li>The <em>file-ownership system</em> may be the one that is asking for an <em>authorization decision</em> from OPA.<ul>
<li>It already knows which file is being operated on and who the owner is, so it can hand OPA the <em>file-owner</em> as part of OPA’s <code>input</code>.</li>
<li>This can be dangerous in that it ties the integration of OPA to the policy, but often it’s sufficient to have the file-ownership system hand over all the <em>file’s metadata</em>.</li>
</ul>
</li>
</ol>
<h3 id="Flow-1"><a href="#Flow-1" class="headerlink" title="Flow"></a>Flow</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231015104116286.png" alt="image-20231015104116286"></p>
<ol>
<li>OPA-enabled software gathers <em>relevant metadata</em> (and <em>caches</em> it for subsequent requests)</li>
<li>OPA-enabled software sends <code>input</code> to OPA including the <em>external data</em></li>
<li>Policy makes decisions based on external data included in <code>input</code></li>
</ol>
<h3 id="Updates-1"><a href="#Updates-1" class="headerlink" title="Updates"></a>Updates</h3><ol>
<li>External data gets updated <em>as frequently as</em> the OPA-enabled software updates it.</li>
<li>Often some of that data is <em>local</em> to the OPA-enabled software, and sometimes it is <em>remote</em>.</li>
<li>The <em>remote</em> data is usually <em>cached</em> for <em>performance</em> and hence is as updated as the <em>caching strategy</em> allows.</li>
</ol>
<h3 id="Size-Limitations-1"><a href="#Size-Limitations-1" class="headerlink" title="Size Limitations"></a>Size Limitations</h3><ol>
<li>Size limitations are rarely a problem for OPA in this approach because it only sees <em>the metadata for 1 request at a time</em>.</li>
<li>However, the <em>cache</em> of remote data that the OPA-enabled service creates will have a limit that the developer controls.</li>
</ol>
<h3 id="Security-1"><a href="#Security-1" class="headerlink" title="Security"></a>Security</h3><ol>
<li>This approach is as secure as the <em>connection</em> between the OPA-enabled service and OPA itself, under the assumption that the OPA-enabled service gathers the appropriate metadata securely.</li>
<li>That is, using external data with this approach is as secure as using OPA in the first place.</li>
</ol>
<h3 id="Recommended-usage"><a href="#Recommended-usage" class="headerlink" title="Recommended usage"></a>Recommended usage</h3><blockquote>
<p>Local, Dynamic data</p>
</blockquote>
<ol>
<li>This approach is valuable when the <em>data changes fairly frequently</em> and&#x2F;or when <em>the cost of making decisions using stale data is high</em>.</li>
<li>It works especially well when the external data is <em>local</em> to the system asking for authorization decisions.</li>
<li>It can work in the case of remote data as well, but there is more <em>coupling</em> of the system to OPA because the system is <em>hardcoded</em> to fetch the data needed by the policy (and only that data).</li>
</ol>
<h2 id="Bundle-API"><a href="#Bundle-API" class="headerlink" title="Bundle API"></a>Bundle API</h2><ol>
<li>When <em>external data changes infrequently</em> and can reasonably <em>be stored in memory all at once</em>, you can replicate that data in bulk via OPA’s bundle feature.</li>
<li>The bundle feature <em>periodically downloads policy bundles</em> from <em>a centralized server</em>, which can include <em>data</em> as well as <em>policy</em>.</li>
<li>Every time OPA gets <em>updated policies</em>, it gets <em>updated data</em> too.</li>
<li>You must <em>implement the bundle server</em> and <em>integrate your external data into the bundle server</em><ul>
<li>OPA does NOT help with that–but once it is done, OPA will happily <em>pull</em> the data (and <em>policies</em>) out of your <em>bundle server</em>.</li>
</ul>
</li>
</ol>
<h3 id="Flow-2"><a href="#Flow-2" class="headerlink" title="Flow"></a>Flow</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231015105203977.png" alt="image-20231015105203977"></p>
<blockquote>
<p>Three things happen <em>independently</em> with this kind of data integration.</p>
</blockquote>
<ol>
<li>A. OPA-enabled software system asks OPA for <em>policy decisions</em></li>
<li>B. OPA downloads new <em>policy bundles</em> including external data</li>
<li>C. Bundle server <em>replicates data</em> from source of <em>truth</em></li>
</ol>
<h3 id="Updates-2"><a href="#Updates-2" class="headerlink" title="Updates"></a>Updates</h3><ol>
<li>The <em>lag</em> between a data update and OPA having the update is the <em>sum</em> of the lag for an update between <em>data replication</em> and the central bundle server and the lag for an update between the central bundle server and OPA.</li>
<li>So if data replication happens every <em>5</em> minutes, and OPA pulls a new bundle every <em>2</em> minutes, then the total maximum lag is <em>7</em> minutes.</li>
</ol>
<h3 id="Size-limitations"><a href="#Size-limitations" class="headerlink" title="Size limitations"></a>Size limitations</h3><ol>
<li><em>OPA stores the entire datasource at once in memory</em>.</li>
<li>Obviously this can be a problem with large external data sets.</li>
<li>Because the centralized server handles both policy and data it can <em>prune data</em> to just that which is needed for the policies.</li>
</ol>
<h3 id="Recommended-usage-1"><a href="#Recommended-usage-1" class="headerlink" title="Recommended usage"></a>Recommended usage</h3><blockquote>
<p>Static, Medium-sized data</p>
</blockquote>
<ol>
<li>This approach is more <em>flexible</em> than the JWT and <code>input</code> cases above<ul>
<li>because you can include <em>an entirely new data source</em> at the bundle server without changing the authentication service or the OPA-enabled service.</li>
<li>You are also guaranteed that the <em>policy</em> and its corresponding <em>data</em> always arrive at the <em>same time</em>, making the policy-data <em>consistency</em> perfect.</li>
</ul>
</li>
<li>The drawback is that the <em>consistency of the data</em> with the source of truth is worse than the <code>input</code> case and could be better or worse than the consistency for the JWT case (because JWTs only get updated on login).</li>
<li>One feature currently <em>under design</em> is a <em>delta-based bundle protocol</em>, which could improve the <em>data consistency model significantly</em> by <em>lowering the cost of frequent updates</em>.</li>
<li>But as it stands this approach is ideal when the data is <em>relatively static</em> and the data <em>fits into memory</em>.</li>
</ol>
<h2 id="Push-Data"><a href="#Push-Data" class="headerlink" title="Push Data"></a>Push Data</h2><ol>
<li>Another way to replicate external data in its entirety into OPA is to use OPA’s API for <em>injecting arbitrary JSON data</em>.</li>
<li>You can build a <em>replicator</em> that pulls information out of the external data source and pushes that information in OPA through its API.</li>
<li>This approach is similar in most respects to the bundle API, except it lets you optimize for update latency and network traffic.</li>
</ol>
<h3 id="Flow-3"><a href="#Flow-3" class="headerlink" title="Flow"></a>Flow</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231015111505576.png" alt="image-20231015111505576"></p>
<blockquote>
<p>Three things happen <em>independently</em> with this kind of data replication.</p>
</blockquote>
<ol>
<li>A. OPA-enabled software system asks OPA for <em>policy decisions</em></li>
<li>B. Data replicator <em>pushes data</em> into OPA</li>
<li>C. Data replicator <em>replicates data</em> from source of truth</li>
</ol>
<blockquote>
<p>Depending on the replication scheme, B and C could be <em>tied together</em> so that every update the data replicator gets from the source of truth it pushes into OPA,<br>but in general those could be <em>decoupled</em> depending on the desired network load, the changes in the data, and so on.</p>
</blockquote>
<h3 id="Updates-3"><a href="#Updates-3" class="headerlink" title="Updates"></a>Updates</h3><ol>
<li>The total <em>lag</em> between the external data source being updated and OPA being updated is the <em>sum</em> of the lag for an update between the data source and the synchronizer plus the lag for an update between the synchronizer and OPA.</li>
</ol>
<h3 id="Size-limitations-1"><a href="#Size-limitations-1" class="headerlink" title="Size limitations"></a>Size limitations</h3><ol>
<li>The <em>entirety</em> of the external data source is <em>stored in memory</em>, which can obviously be a problem with large external data sources.</li>
<li>But unlike the bundle API, this approach does <em>allow updates to data</em>.</li>
</ol>
<h3 id="Recommended-usage-2"><a href="#Recommended-usage-2" class="headerlink" title="Recommended usage"></a>Recommended usage</h3><blockquote>
<p>Dynamic, Medium-sized data</p>
</blockquote>
<ol>
<li>This approach is very similar to the bundle approach except it updates the data stored in OPA with <em>deltas</em> instead of an entire snapshot at a time.</li>
<li>Because the <em>data</em> is updated as <em>deltas</em>, this approach is <em>well-suited</em> for data that <em>changes frequently</em>.</li>
<li>It assumes the data can fit <em>entirely in memory</em> and so is well-suited to <em>small</em> and <em>medium-sized</em> data sets.</li>
</ol>
<h2 id="Pull-Data-during-Evaluation"><a href="#Pull-Data-during-Evaluation" class="headerlink" title="Pull Data during Evaluation"></a>Pull Data during Evaluation</h2><ol>
<li>OPA includes functionality for reaching out to external servers <em>during evaluation</em>.</li>
<li>This functionality handles those cases where there is <em>too much data</em> to synchronize into OPA, or policy requires information that must be <em>as up to date as possible</em>.</li>
<li>That functionality is implemented using built-in functions such as <code>http.send</code>.</li>
</ol>
<h3 id="Current-limitations"><a href="#Current-limitations" class="headerlink" title="Current limitations"></a>Current limitations</h3><ol>
<li>Credentials needed for the external service can either be <em>hardcoded</em> into policy or <em>pulled</em> from the environment.</li>
<li>The built-in functions <em>do not implement any retry logic</em>.</li>
</ol>
<h3 id="Flow-4"><a href="#Flow-4" class="headerlink" title="Flow"></a>Flow</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231015112817755.png" alt="image-20231015112817755"></p>
<blockquote>
<p>The key difference here is that <em>every decision requires contacting the external data source</em>.<br>If that service or the network connection is <em>slow</em> or <em>unavailable</em>, OPA may not be able to return a decision.</p>
</blockquote>
<ol>
<li>OPA-enabled service asks OPA for a <em>decision</em></li>
<li><em>During evaluation</em> OPA asks the external data source for <em>additional information</em></li>
</ol>
<h3 id="Updates-4"><a href="#Updates-4" class="headerlink" title="Updates"></a>Updates</h3><ol>
<li>External data is <em>perfectly fresh</em>.</li>
<li>There is <em>no lag</em> between an update to the external data and when OPA sees that update.</li>
</ol>
<h3 id="Size-limitations-2"><a href="#Size-limitations-2" class="headerlink" title="Size limitations"></a>Size limitations</h3><ol>
<li>Only the <em>data actually needed by the policy</em> is pulled from the external data source.</li>
<li>There is no need for a replicator to figure out what data the policy will need before execution.</li>
</ol>
<h3 id="Performance-and-Availability"><a href="#Performance-and-Availability" class="headerlink" title="Performance and Availability"></a>Performance and Availability</h3><ol>
<li>Latency and availability of decision-making are dependent on the <em>network</em>.</li>
<li>This approach may still be superior to <em>running OPA on a remote server entirely</em><ul>
<li>because a <em>local OPA</em> can make some decisions without going over the network</li>
<li>those decisions that do not require information from the remote data server.</li>
</ul>
</li>
</ol>
<h3 id="Recommended-usage-3"><a href="#Recommended-usage-3" class="headerlink" title="Recommended usage"></a>Recommended usage</h3><blockquote>
<p>Highly Dynamic or Large-sized data</p>
</blockquote>
<ol>
<li>If the data is <em>too large</em> to fit into memory, or it <em>changes too frequently</em> to cache it inside of OPA, the only real option is to <em>fetch the data on demand</em>.</li>
<li>The <code>input</code> approach fetches data on demand as well<ul>
<li>but puts the burden on the <em>OPA-enabled service to fetch the necessary data</em> (and to know what data is necessary).</li>
</ul>
</li>
<li>The downside to <em>pulling data on demand</em> is <em>reduced performance and availability</em> because of the <em>network</em>, which can be mitigated via <em>caching</em>.<ul>
<li>In the <code>input</code> case, <em>caching</em> is under the control of the <em>OPA-enabled service</em> and can therefore <em>be tailored to fit the properties of the data</em>.</li>
<li>In the <code>http.send</code> case, <em>caching</em> is largely under the control of the <em>remote service</em> that sets HTTP <em>response headers</em> to indicate how long the response can be <em>cached</em> for.</li>
</ul>
</li>
<li>It is crucial in this approach for the <em>OPA-enabled service</em> to handle the case when <em>OPA returns no decision</em>.</li>
</ol>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><table>
<thead>
<tr>
<th>Approach</th>
<th>Perf&#x2F;Avail</th>
<th>Limitations</th>
<th>Recommended Data</th>
</tr>
</thead>
<tbody><tr>
<td>JWT</td>
<td>High</td>
<td>Updates only when user logs back in</td>
<td>User attributes</td>
</tr>
<tr>
<td>Input</td>
<td>High</td>
<td><em>Coupling</em> between service and OPA</td>
<td>Local, dynamic</td>
</tr>
<tr>
<td><code>Bundle</code></td>
<td>High</td>
<td>Updates to <em>policy&#x2F;data</em> at the <em>same time</em>. Size an issue.</td>
<td>Static, medium</td>
</tr>
<tr>
<td>Push</td>
<td>High</td>
<td>Control data refresh rate. Size an issue.</td>
<td>Dynamic, medium</td>
</tr>
<tr>
<td>Evaluation Pull</td>
<td>Dependent on network</td>
<td>Perfectly up to date. No size limit</td>
<td>Dynamic or large</td>
</tr>
</tbody></table>
<h1 id="Policy-Language"><a href="#Policy-Language" class="headerlink" title="Policy Language"></a>Policy Language</h1><h2 id="What-is-Rego"><a href="#What-is-Rego" class="headerlink" title="What is Rego?"></a>What is Rego?</h2><ol>
<li>Rego was inspired by Datalog, which is a well understood, <em>decades</em> old query language.</li>
<li>Rego extends Datalog to support <em>structured document models</em> such as <em>JSON</em>.</li>
<li>Rego queries are <em>assertions on data</em> stored in OPA.<ul>
<li>These queries can be used to define policies that enumerate instances of data that <em>violate</em> the expected state of the system.</li>
</ul>
</li>
</ol>
<h2 id="Why-use-Rego"><a href="#Why-use-Rego" class="headerlink" title="Why use Rego?"></a>Why use Rego?</h2><ol>
<li>Use Rego for defining policy that is <em>easy to read and write</em>.</li>
<li>Rego focuses on providing powerful support for <em>referencing nested documents</em> and ensuring that queries are <em>correct</em> and <em>unambiguous</em>.</li>
<li>Rego is <em>declarative</em> so policy authors can focus on what queries should return rather than how queries should be executed.<ul>
<li>These queries are <em>simpler</em> and <em>more concise</em> than the equivalent in an <em>imperative language</em>.</li>
</ul>
</li>
<li>Like other applications which support declarative query languages, OPA is able to <em>optimize queries</em> to <em>improve performance</em>.</li>
</ol>
<h2 id="The-Basics"><a href="#The-Basics" class="headerlink" title="The Basics"></a>The Basics</h2><blockquote>
<p>The simplest rule is a single expression and is defined in terms of a <em>Scalar Value</em></p>
</blockquote>
<blockquote>
<p>Rules define the <em>content</em> of documents.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi := <span class="number">3.14159</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Rules can also be defined in terms of <em>Composite Values</em></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rect := &#123;<span class="string">&quot;width&quot;</span>: <span class="number">2</span>, <span class="string">&quot;height&quot;</span>: <span class="number">4</span>&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can compare two <em>scalar</em> or <em>composite</em> values, and when you do so you are checking if the two values are the <em>same JSON value</em></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rect := &#123;&quot;width&quot;: 2, &quot;height&quot;: 4&#125;</span><br><span class="line">same if rect == &#123;&quot;height&quot;: 4, &quot;width&quot;: 2&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can define a <em>new concept</em> using a rule.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">undefined</span></span><br><span class="line">v if &quot;hello&quot; == &quot;world&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Expressions that refer to <em>undefined</em> values are also <em>undefined</em>. This includes comparisons such as <code>!=</code>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v if &quot;hello&quot; == &quot;world&quot; # undefined</span><br><span class="line">a if v == true # undefined</span><br><span class="line">b if v != true # undefined</span><br></pre></td></tr></table></figure>

<blockquote>
<p>We can define rules in terms of <em>Variables</em> as well<br>The formal syntax uses the semicolon character <code>;</code> to separate expressions.<br>Rule bodies can separate expressions with <em>newlines</em> and <em>omit</em> the semicolon</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t if &#123;x := 42; y := 41; x &gt; y&#125; # true</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t if &#123;</span><br><span class="line">    x := 42</span><br><span class="line">    y := 41</span><br><span class="line">    x &gt; y</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>if</code> is optional.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">v &#123;</span><br><span class="line">    &quot;hello&quot; == &quot;world&quot;</span><br><span class="line">&#125; # undefined</span><br><span class="line"></span><br><span class="line">t &#123;</span><br><span class="line">    x := 42</span><br><span class="line">    y := 41</span><br><span class="line">    x &gt; y</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When evaluating rule bodies, OPA searches for variable bindings that make <em>all</em> of the expressions <em>true</em>.<br>There may be multiple sets of bindings that make the rule body true. The <em>rule body</em> can be understood intuitively as</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expression-1 AND expression-2 AND ... AND expression-N</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The rule itself can be understood intuitively as<br>If the <strong>value</strong> is omitted, it defaults to <strong>true</strong>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rule-name IS value IF body</span><br></pre></td></tr></table></figure>

<blockquote>
<p>refer to nested documents.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.<span class="keyword">if</span></span><br><span class="line"><span class="keyword">import</span> future.keywords.in</span><br><span class="line"></span><br><span class="line">sites := [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;prod&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;smoke1&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dev&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line">r <span class="keyword">if</span> &#123;</span><br><span class="line">    some site in sites</span><br><span class="line">    site.name == <span class="string">&quot;prod&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The rule <code>r</code> above asserts that there exists (at least) one document within <code>sites</code> where the <code>name</code> attribute equals <code>&quot;prod&quot;</code>.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sites&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prod&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;smoke1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>We can generalize the example above with a rule that defines <em>a set document</em> instead of <em>a boolean document</em></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.contains</span><br><span class="line"><span class="keyword">import</span> future.keywords.<span class="keyword">if</span></span><br><span class="line"><span class="keyword">import</span> future.keywords.in</span><br><span class="line"></span><br><span class="line">sites := [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;prod&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;smoke1&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dev&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line">q contains name <span class="keyword">if</span> &#123;</span><br><span class="line">    some site in sites</span><br><span class="line">    name := site.name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;prod&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;smoke1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sites&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prod&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;smoke1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>We can re-write the rule <code>r</code> from above to make use of <code>q</code>. We will call the new rule <code>p</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.contains</span><br><span class="line"><span class="keyword">import</span> future.keywords.<span class="keyword">if</span></span><br><span class="line"><span class="keyword">import</span> future.keywords.in</span><br><span class="line"></span><br><span class="line">sites := [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;prod&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;smoke1&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dev&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line">q contains name <span class="keyword">if</span> &#123;</span><br><span class="line">    some site in sites</span><br><span class="line">    name := site.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p <span class="keyword">if</span> q[<span class="string">&quot;prod&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;prod&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;smoke1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sites&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prod&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;smoke1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Scalar-Values"><a href="#Scalar-Values" class="headerlink" title="Scalar Values"></a>Scalar Values</h2><blockquote>
<p>Scalar values are the simplest type of term in Rego. Scalar values can be <em>Strings</em>, <em>numbers</em>, <em>booleans</em>, or <em>null</em>.</p>
</blockquote>
<blockquote>
<p>Documents can be defined <em>solely</em> in terms of scalar values.<br>This is useful for defining <em>constants</em> that are referenced in multiple places.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">greeting := <span class="string">&quot;Hello&quot;</span></span><br><span class="line">max_height := <span class="number">42</span></span><br><span class="line">pi := <span class="number">3.14159</span></span><br><span class="line">allowed := <span class="literal">true</span></span><br><span class="line">location := null</span><br><span class="line"></span><br><span class="line">x := [greeting, max_height, pi, allowed, location]</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;allowed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;greeting&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_height&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pi&quot;</span><span class="punctuation">:</span> <span class="number">3.14159</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;Hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">3.14159</span><span class="punctuation">,</span></span><br><span class="line">            <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h2 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h2><blockquote>
<p>Rego supports two different types of syntax for declaring strings.</p>
</blockquote>
<ol>
<li>The first is likely to be the most familiar: <em>characters surrounded by double quotes</em>.<ul>
<li>In such strings, certain characters must be <em>escaped</em> to appear in the string,</li>
<li>such as <em>double quotes themselves</em>, <em>backslashes</em>, etc.</li>
</ul>
</li>
<li>The other type of string declaration is a <em>raw string declaration</em>.<ul>
<li>These are made of characters surrounded by <em>backticks</em> (<em>&#96;</em>),</li>
<li>with the exception that raw strings <em>may not contain backticks themselves</em>.</li>
<li>Raw strings are what they sound like<ul>
<li><em>escape</em> sequences are <em>not interpreted</em>, but instead taken as the <em>literal text</em> inside the backticks.</li>
</ul>
</li>
<li>Raw strings are particularly useful when constructing <em>regular expressions</em> for matching,<ul>
<li>as it eliminates the need to <em>double escape special characters</em>.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="Composite-Values"><a href="#Composite-Values" class="headerlink" title="Composite Values"></a>Composite Values</h2><blockquote>
<p>Composite values define <em>collections</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cube := &#123;<span class="string">&quot;width&quot;</span>: <span class="number">3</span>, <span class="string">&quot;height&quot;</span>: <span class="number">4</span>, <span class="string">&quot;depth&quot;</span>: <span class="number">5</span>&#125;</span><br><span class="line">width := cube.width</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cube&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;depth&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;width&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;width&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Composite values can also be defined in terms of <em>Variables</em> or <em>References</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="number">42</span></span><br><span class="line">b := <span class="literal">false</span></span><br><span class="line">c := null</span><br><span class="line">d := &#123;<span class="string">&quot;a&quot;</span>: a, <span class="string">&quot;x&quot;</span>: [b, c]&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h3><blockquote>
<p>Objects are <em>unordered key-value collections</em>.<br>In Rego, <em>any value type</em> can be used as an <em>object key</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ips_by_port := &#123;</span><br><span class="line">    <span class="number">80</span>: [<span class="string">&quot;1.1.1.1&quot;</span>, <span class="string">&quot;1.1.1.2&quot;</span>],</span><br><span class="line">    <span class="number">443</span>: [<span class="string">&quot;2.2.2.1&quot;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">x := ips_by_port[<span class="number">80</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ips_by_port&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;80&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;1.1.1.2&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;443&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;2.2.2.1&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;1.1.1.2&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ips_by_port := &#123;</span><br><span class="line">    <span class="number">80</span>: [<span class="string">&quot;1.1.1.1&quot;</span>, <span class="string">&quot;1.1.1.2&quot;</span>],</span><br><span class="line">    <span class="number">443</span>: [<span class="string">&quot;2.2.2.1&quot;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">q contains port <span class="keyword">if</span> &#123;</span><br><span class="line">    ips_by_port[port][_] == <span class="string">&quot;1.1.1.1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ips_by_port&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;80&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;1.1.1.2&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;443&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;2.2.2.1&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">80</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>When <em>Rego values</em> are converted to <em>JSON non-string object keys</em> are <em>marshalled as strings</em>, because JSON does not support non-string object keys.</p>
</blockquote>
<h3 id="Sets"><a href="#Sets" class="headerlink" title="Sets"></a>Sets</h3><blockquote>
<p>In addition to <em>arrays</em> and <em>objects</em>, Rego supports set values. Sets are <em>unordered collections of unique values</em>.<br>Just like other composite values, sets can be defined in terms of scalars, variables, references, and other composite values.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cube := &#123;<span class="string">&quot;width&quot;</span>: <span class="number">3</span>, <span class="string">&quot;height&quot;</span>: <span class="number">4</span>, <span class="string">&quot;depth&quot;</span>: <span class="number">5</span>&#125;</span><br><span class="line">s := &#123;cube.width, cube.height, cube.depth&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cube&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;depth&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;width&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;s&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>Set documents are <em>collections of values without keys</em>.</li>
<li>OPA represents set documents as <em>arrays</em> when serializing to <em>JSON</em> or other formats that do not support a set data type.</li>
<li>The important distinction between <em>sets</em> and <em>arrays</em> or <em>objects</em> is that sets are <em>unkeyed</em> while arrays and objects are keyed<ul>
<li>i.e., you cannot refer to the <em>index</em> of an element within a set.</li>
</ul>
</li>
</ol>
<blockquote>
<p>When comparing sets, the order of elements does not matter</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">same_set <span class="keyword">if</span> &#123;</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125; == &#123;<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">&#125; # <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Because sets share <em>curly-brace</em> syntax with <em>objects</em>, and an <em>empty object</em> is defined with <code>&#123;&#125;</code>, an <em>empty set</em> has to be constructed with a different syntax: <code>set()</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size := count(set()) # <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="Variables-1"><a href="#Variables-1" class="headerlink" title="Variables"></a>Variables</h2><blockquote>
<p>Variables are another kind of term in Rego. They appear in both the <em>head</em> and <em>body</em> of rules.</p>
</blockquote>
<ol>
<li>Variables appearing in the <em>head</em> of a rule can be thought of as <em>input</em> and <em>output</em> of the rule.</li>
<li>In Rego a variable is <em>simultaneously</em> an <em>input</em> and an <em>output</em>.<ul>
<li>If a <em>query supplies a value</em> for a variable, that variable is an input</li>
<li>and if the query does not supply a value for a variable, that variable is an output</li>
</ul>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.contains</span><br><span class="line"><span class="keyword">import</span> future.keywords.<span class="keyword">if</span></span><br><span class="line"><span class="keyword">import</span> future.keywords.in</span><br><span class="line"></span><br><span class="line">sites := [</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;prod&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;smoke1&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dev&quot;</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">q contains name <span class="keyword">if</span> &#123;</span><br><span class="line">    some site in sites</span><br><span class="line">    name := site.name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>query - <code>q[x]</code><br>In this case, we evaluate <code>q</code> with a variable <code>x</code> (which is not bound to a value).<br>As a result, the query returns all of the values for <code>x</code> and all of the values for <code>q[x]</code>, which are always the same because <code>q</code> is a set.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------------+</span><br><span class="line">|    x     | data.play.q[x] |</span><br><span class="line">+----------+----------------+</span><br><span class="line">| &quot;dev&quot;    | &quot;dev&quot;          |</span><br><span class="line">| &quot;prod&quot;   | &quot;prod&quot;         |</span><br><span class="line">| &quot;smoke1&quot; | &quot;smoke1&quot;       |</span><br><span class="line">+----------+----------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Query - <code>q[&quot;dev&quot;]</code><br>On the other hand, if we evaluate <code>q</code> with an <em>input value</em> for <code>name</code> we can determine whether <code>name</code> exists in the document defined by <code>q</code>:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;dev&quot;</span><br></pre></td></tr></table></figure>

<ol>
<li><em>Variables</em> appearing in the <em>head</em> of a rule must also appear in a <em>non-negated equality expression</em> within the same rule.</li>
<li>This property ensures that if the rule is evaluated and <em>all</em> of the expressions evaluate to <em>true</em> for some set of <em>variable bindings</em>, the variable in the head of the rule will be <em>defined</em>.</li>
</ol>
<h2 id="References-1"><a href="#References-1" class="headerlink" title="References"></a>References</h2><blockquote>
<p>References are used to access <em>nested documents</em>.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">sites <span class="punctuation">:</span>= <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;region&quot;</span><span class="punctuation">:</span> <span class="string">&quot;east&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prod&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web-0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hydrogen&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;helium&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db-0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lithium&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;region&quot;</span><span class="punctuation">:</span> <span class="string">&quot;west&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;smoke&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web-1000&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;beryllium&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web-1001&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boron&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db-1000&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;carbon&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;region&quot;</span><span class="punctuation">:</span> <span class="string">&quot;west&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web-dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nitrogen&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db-dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;oxygen&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">apps <span class="punctuation">:</span>= <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;web-0&quot;</span><span class="punctuation">,</span> <span class="string">&quot;web-1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;web-1000&quot;</span><span class="punctuation">,</span> <span class="string">&quot;web-1001&quot;</span><span class="punctuation">,</span> <span class="string">&quot;web-dev&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;db-0&quot;</span><span class="punctuation">,</span> <span class="string">&quot;db-1000&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mongodb&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;db-dev&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">containers <span class="punctuation">:</span>= <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;redis&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ipaddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;big_stallman&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ipaddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.0.0.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cranky_euclid&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The simplest reference contains <em>no variables</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sites[<span class="number">0</span>].servers[<span class="number">1</span>].hostname</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;helium&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <em>canonical form</em> does away with <code>.</code> and closely resembles <em>dictionary lookup</em> in a language such as Python</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sites[<span class="number">0</span>][<span class="string">&quot;servers&quot;</span>][<span class="number">1</span>][<span class="string">&quot;hostname&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;helium&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Both forms are <em>valid</em>, however, the <em>dot-access</em> style is typically <em>more readable</em>.<br>Note that there are four cases where <em>brackets</em> must be used</p>
</blockquote>
<ol>
<li><em>String keys</em> containing characters other than <code>[a-z]</code>, <code>[A-Z]</code>, <code>[0-9]</code>, or <code>_</code> (underscore).</li>
<li><em>Non-string keys</em> such as numbers, booleans, and null.</li>
<li><em>Variable keys</em></li>
<li><em>Composite keys</em></li>
</ol>
<blockquote>
<p>The prefix of a reference identifies the <em>root document</em> for that reference.<br>The <em>root document</em> may be</p>
</blockquote>
<ol>
<li>a <em>local variable</em> inside a rule.</li>
<li>a rule inside the <em>same package</em>.</li>
<li>a document stored in OPA.</li>
<li>a documented temporarily provided to OPA as part of a transaction.</li>
<li>an array, object or set, e.g. <code>[1, 2, 3][0]</code>.</li>
<li>a function call, e.g. <code>split(&quot;a.b.c&quot;, &quot;.&quot;)[1]</code>.</li>
<li>a <em>comprehension</em>.</li>
</ol>
<h3 id="Variable-Keys"><a href="#Variable-Keys" class="headerlink" title="Variable Keys"></a>Variable Keys</h3><blockquote>
<p>References can include variables as keys.<br>References written this way are used to select a value from <em>every element</em> in a collection.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sites[i].servers[j].hostname</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+---+---+----------------------------------------+</span><br><span class="line">| i | j | data.play.sites[i].servers[j].hostname |</span><br><span class="line">+---+---+----------------------------------------+</span><br><span class="line">| <span class="number">0</span> | <span class="number">0</span> | <span class="string">&quot;hydrogen&quot;</span>                             |</span><br><span class="line">| <span class="number">0</span> | <span class="number">1</span> | <span class="string">&quot;helium&quot;</span>                               |</span><br><span class="line">| <span class="number">0</span> | <span class="number">2</span> | <span class="string">&quot;lithium&quot;</span>                              |</span><br><span class="line">| <span class="number">1</span> | <span class="number">0</span> | <span class="string">&quot;beryllium&quot;</span>                            |</span><br><span class="line">| <span class="number">1</span> | <span class="number">1</span> | <span class="string">&quot;boron&quot;</span>                                |</span><br><span class="line">| <span class="number">1</span> | <span class="number">2</span> | <span class="string">&quot;carbon&quot;</span>                               |</span><br><span class="line">| <span class="number">2</span> | <span class="number">0</span> | <span class="string">&quot;nitrogen&quot;</span>                             |</span><br><span class="line">| <span class="number">2</span> | <span class="number">1</span> | <span class="string">&quot;oxygen&quot;</span>                               |</span><br><span class="line">+---+---+----------------------------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the reference above, we effectively used variables named <code>i</code> and <code>j</code> to iterate the collections.<br>If the variables are <em>unused</em> outside the reference, we prefer to replace them with an underscore (<code>_</code>) character.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sites[_].servers[_].hostname</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+----------------------------------------+</span><br><span class="line">| data.play.sites[_].servers[_].hostname |</span><br><span class="line">+----------------------------------------+</span><br><span class="line">| <span class="string">&quot;hydrogen&quot;</span>                             |</span><br><span class="line">| <span class="string">&quot;helium&quot;</span>                               |</span><br><span class="line">| <span class="string">&quot;lithium&quot;</span>                              |</span><br><span class="line">| <span class="string">&quot;beryllium&quot;</span>                            |</span><br><span class="line">| <span class="string">&quot;boron&quot;</span>                                |</span><br><span class="line">| <span class="string">&quot;carbon&quot;</span>                               |</span><br><span class="line">| <span class="string">&quot;nitrogen&quot;</span>                             |</span><br><span class="line">| <span class="string">&quot;oxygen&quot;</span>                               |</span><br><span class="line">+----------------------------------------+</span><br></pre></td></tr></table></figure>

<ol>
<li>The <em>underscore</em> is special because it <em>cannot be referred to by other parts of the rule</em>, e.g., the other side of the expression, another expression, etc.</li>
<li>The <em>underscore</em> can be thought of as a <em>special iterator</em>. Each time an underscore is specified, a <em>new iterator</em> is instantiated.<ul>
<li>Under the hood, OPA translates the <code>_</code> character to a <em>unique variable name</em> that does not conflict with variables and rules that are in scope.</li>
</ul>
</li>
</ol>
<h3 id="Composite-Keys"><a href="#Composite-Keys" class="headerlink" title="Composite Keys"></a>Composite Keys</h3><blockquote>
<p>References can include <em>Composite Values</em> as keys if the key is being used to refer into <em>a set</em>.<br>Composite keys may not be used in refs for base data documents, they are only valid for references into <em>virtual documents</em>.</p>
</blockquote>
<blockquote>
<p>This is useful for checking for the <em>presence</em> of <em>composite values</em> within <em>a set</em>, or extracting all values within a set matching some pattern.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s := &#123;[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">1</span>, <span class="number">4</span>], [<span class="number">2</span>, <span class="number">6</span>]&#125;</span><br><span class="line">x := s[[<span class="number">1</span>, <span class="number">2</span>]]</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;s&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">4</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">6</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">s[[<span class="number">1</span>,x]]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+---+--------------------+</span><br><span class="line">| x | data.play.s[[<span class="number">1</span>,x]] |</span><br><span class="line">+---+--------------------+</span><br><span class="line">| <span class="number">2</span> | [<span class="number">1</span>,<span class="number">2</span>]              |</span><br><span class="line">| <span class="number">4</span> | [<span class="number">1</span>,<span class="number">4</span>]              |</span><br><span class="line">+---+--------------------+</span><br></pre></td></tr></table></figure>

<h3 id="Multiple-Expressions"><a href="#Multiple-Expressions" class="headerlink" title="Multiple Expressions"></a>Multiple Expressions</h3><blockquote>
<p>Rules are often written in terms of <em>multiple expressions</em> that contain references to documents.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apps_and_hostnames[[name, hostname]] &#123;</span><br><span class="line">    some i, j, k</span><br><span class="line">    name := apps[i].name</span><br><span class="line">    server := apps[i].servers[_]</span><br><span class="line">    sites[j].servers[k].name == server</span><br><span class="line">    hostname := sites[j].servers[k].hostname</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apps_and_hostnames[x]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+----------------------+---------------------------------+</span><br><span class="line">|          x           | data.play.apps_and_hostnames[x] |</span><br><span class="line">+----------------------+---------------------------------+</span><br><span class="line">| [<span class="string">&quot;mongodb&quot;</span>,<span class="string">&quot;oxygen&quot;</span>] | [<span class="string">&quot;mongodb&quot;</span>,<span class="string">&quot;oxygen&quot;</span>]            |</span><br><span class="line">| [<span class="string">&quot;mysql&quot;</span>,<span class="string">&quot;carbon&quot;</span>]   | [<span class="string">&quot;mysql&quot;</span>,<span class="string">&quot;carbon&quot;</span>]              |</span><br><span class="line">| [<span class="string">&quot;mysql&quot;</span>,<span class="string">&quot;lithium&quot;</span>]  | [<span class="string">&quot;mysql&quot;</span>,<span class="string">&quot;lithium&quot;</span>]             |</span><br><span class="line">| [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;beryllium&quot;</span>]  | [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;beryllium&quot;</span>]             |</span><br><span class="line">| [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;boron&quot;</span>]      | [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;boron&quot;</span>]                 |</span><br><span class="line">| [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;helium&quot;</span>]     | [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;helium&quot;</span>]                |</span><br><span class="line">| [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;hydrogen&quot;</span>]   | [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;hydrogen&quot;</span>]              |</span><br><span class="line">| [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;nitrogen&quot;</span>]   | [<span class="string">&quot;web&quot;</span>,<span class="string">&quot;nitrogen&quot;</span>]              |</span><br><span class="line">+----------------------+---------------------------------+</span><br></pre></td></tr></table></figure>

<ol>
<li>Several variables <em>appear more than once</em> in the <em>body</em>.<ul>
<li>When <em>a variable</em> is used in <em>multiple locations</em>, OPA will only produce documents for the rule with the variable bound to the <em>same value in all expressions</em>.</li>
</ul>
</li>
<li>The rule is <em>joining</em> the <code>apps</code> and <code>sites</code> documents <em>implicitly</em>.<ul>
<li>In Rego (and other languages based on Datalog), <em>joins are implicit</em>.</li>
</ul>
</li>
</ol>
<h3 id="Self-Joins"><a href="#Self-Joins" class="headerlink" title="Self-Joins"></a>Self-Joins</h3><blockquote>
<p>Using a <em>different key</em> on the same array or object provides the equivalent of self-join in SQL.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">same_site[apps[k].name] &#123;</span><br><span class="line">    some i, j, k</span><br><span class="line">    apps[i].name == <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    server := apps[i].servers[_]</span><br><span class="line">    server == sites[j].servers[_].name</span><br><span class="line">    other_server := sites[j].servers[_].name</span><br><span class="line">    server != other_server</span><br><span class="line">    other_server == apps[k].servers[_]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">same_site[x]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+-------+------------------------+</span><br><span class="line">|   x   | data.play.same_site[x] |</span><br><span class="line">+-------+------------------------+</span><br><span class="line">| <span class="string">&quot;web&quot;</span> | <span class="string">&quot;web&quot;</span>                  |</span><br><span class="line">+-------+------------------------+</span><br></pre></td></tr></table></figure>

<h2 id="Comprehensions"><a href="#Comprehensions" class="headerlink" title="Comprehensions"></a>Comprehensions</h2><blockquote>
<p>Comprehensions provide a concise way of <em>building Composite Values</em> from sub-queries.</p>
</blockquote>
<ol>
<li>Like Rules, comprehensions consist of a <em>head</em> and a <em>body</em>.</li>
<li>The body of a comprehension can be understood in exactly the <em>same way</em> as the body of a rule<ul>
<li>that is, one or more expressions that must <em>all</em> be true in order for the overall body to be true.</li>
</ul>
</li>
<li>When the body evaluates to true, the head of the comprehension is evaluated to produce an element in the result.</li>
</ol>
<blockquote>
<p>The body of a comprehension is able to refer to variables defined in the <em>outer</em> body.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">region := <span class="string">&quot;west&quot;</span></span><br><span class="line">names := [name | sites[i].region == region; name := sites[i].name]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the above query, the second expression contains an <em>Array Comprehension</em> that refers to the <em>region</em> variable. The region variable will be bound in the <em>outer</em> body.</p>
</blockquote>
<blockquote>
<p>When a comprehension refers to a variable in an outer body,<br>OPA will <em>reorder expressions</em> in the outer body so that variables referred to in the comprehension are <em>bound</em> by the time the comprehension is <em>evaluated</em>.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;smoke&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;dev&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;region&quot;</span><span class="punctuation">:</span> <span class="string">&quot;west&quot;</span><span class="punctuation">,</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Comprehensions are similar to the same <em>constructs</em> found in other languages like <em>Python</em>.</p>
</blockquote>
<blockquote>
<p>Comprehensions are often used to <em>group elements by some key</em>.</p>
</blockquote>
<h3 id="Array-Comprehensions"><a href="#Array-Comprehensions" class="headerlink" title="Array Comprehensions"></a>Array Comprehensions</h3><blockquote>
<p>Array Comprehensions <em>build array values</em> out of sub-queries</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &lt;term&gt; | &lt;body&gt; ]</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app_to_hostnames[app_name] := hostnames <span class="keyword">if</span> &#123;</span><br><span class="line">    app := apps[_]</span><br><span class="line">    app_name := app.name</span><br><span class="line">    hostnames := [hostname | name := app.servers[_]</span><br><span class="line">                            s := sites[_].servers[_]</span><br><span class="line">                            s.name == name</span><br><span class="line">                            hostname := s.hostname]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app_to_hostnames[app_name]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+-----------+------------------------------------------------------+</span><br><span class="line">| app_name  |         data.play.app_to_hostnames[app_name]         |</span><br><span class="line">+-----------+------------------------------------------------------+</span><br><span class="line">| <span class="string">&quot;mongodb&quot;</span> | [<span class="string">&quot;oxygen&quot;</span>]                                           |</span><br><span class="line">| <span class="string">&quot;mysql&quot;</span>   | [<span class="string">&quot;lithium&quot;</span>,<span class="string">&quot;carbon&quot;</span>]                                 |</span><br><span class="line">| <span class="string">&quot;web&quot;</span>     | [<span class="string">&quot;hydrogen&quot;</span>,<span class="string">&quot;helium&quot;</span>,<span class="string">&quot;beryllium&quot;</span>,<span class="string">&quot;boron&quot;</span>,<span class="string">&quot;nitrogen&quot;</span>] |</span><br><span class="line">+-----------+------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<h3 id="Object-Comprehensions"><a href="#Object-Comprehensions" class="headerlink" title="Object Comprehensions"></a>Object Comprehensions</h3><blockquote>
<p>Object Comprehensions <em>build object values</em> out of sub-queries.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;key&gt;: &lt;term&gt; | &lt;body&gt; &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app_to_hostnames := &#123;app.name: hostnames |</span><br><span class="line">    app := apps[_]</span><br><span class="line">    hostnames := [hostname |</span><br><span class="line">                    name := app.servers[_]</span><br><span class="line">                    s := sites[_].servers[_]</span><br><span class="line">                    s.name == name</span><br><span class="line">                    hostname := s.hostname]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app_to_hostnames[app_name]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+-----------+------------------------------------------------------+</span><br><span class="line">| app_name  |         data.play.app_to_hostnames[app_name]         |</span><br><span class="line">+-----------+------------------------------------------------------+</span><br><span class="line">| <span class="string">&quot;mongodb&quot;</span> | [<span class="string">&quot;oxygen&quot;</span>]                                           |</span><br><span class="line">| <span class="string">&quot;mysql&quot;</span>   | [<span class="string">&quot;lithium&quot;</span>,<span class="string">&quot;carbon&quot;</span>]                                 |</span><br><span class="line">| <span class="string">&quot;web&quot;</span>     | [<span class="string">&quot;hydrogen&quot;</span>,<span class="string">&quot;helium&quot;</span>,<span class="string">&quot;beryllium&quot;</span>,<span class="string">&quot;boron&quot;</span>,<span class="string">&quot;nitrogen&quot;</span>] |</span><br><span class="line">+-----------+------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Object comprehensions are not allowed to have <em>conflicting</em> entries</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x := &#123;<span class="string">&quot;foo&quot;</span>: y | z := [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]; y := z[_] &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval_conflict_error: object keys must be unique</span><br></pre></td></tr></table></figure>

<h3 id="Set-Comprehensions"><a href="#Set-Comprehensions" class="headerlink" title="Set Comprehensions"></a>Set Comprehensions</h3><blockquote>
<p>Set Comprehensions <em>build set values</em> out of sub-queries. </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;term&gt; | &lt;body&gt; &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a := [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">b := &#123;x | x = a[_]&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Rules-1"><a href="#Rules-1" class="headerlink" title="Rules"></a>Rules</h2><blockquote>
<p>Rules define the <em>content</em> of <em>Virtual Documents</em> in OPA.<br>When OPA <em>evaluates</em> a rule, we say OPA <em>generates</em> the content of the document that is defined by the rule.</p>
</blockquote>
<blockquote>
<p>Rule definitions can be <em>more expressive</em> when using the <em>future keywords</em> <code>contains</code> and <code>if</code>.</p>
</blockquote>
<h3 id="Generating-Sets"><a href="#Generating-Sets" class="headerlink" title="Generating Sets"></a>Generating Sets</h3><blockquote>
<p>The following rule defines a set containing the hostnames of all servers</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnames contains name <span class="keyword">if</span> &#123;</span><br><span class="line">    name := sites[_].servers[_].hostname</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hostnames</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;beryllium&quot;</span>,</span><br><span class="line">  <span class="string">&quot;boron&quot;</span>,</span><br><span class="line">  <span class="string">&quot;carbon&quot;</span>,</span><br><span class="line">  <span class="string">&quot;helium&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hydrogen&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lithium&quot;</span>,</span><br><span class="line">  <span class="string">&quot;nitrogen&quot;</span>,</span><br><span class="line">  <span class="string">&quot;oxygen&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note that the (future) keywords <em>contains</em> and <em>if</em> are <em>optional</em> here.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnames[name] &#123;</span><br><span class="line">    name := sites[_].servers[_].hostname</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hostnames</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;beryllium&quot;</span>,</span><br><span class="line">  <span class="string">&quot;boron&quot;</span>,</span><br><span class="line">  <span class="string">&quot;carbon&quot;</span>,</span><br><span class="line">  <span class="string">&quot;helium&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hydrogen&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lithium&quot;</span>,</span><br><span class="line">  <span class="string">&quot;nitrogen&quot;</span>,</span><br><span class="line">  <span class="string">&quot;oxygen&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">hostnames[name]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">+-------------+---------------------------+</span><br><span class="line">|    name     | data.play.hostnames[name] |</span><br><span class="line">+-------------+---------------------------+</span><br><span class="line">| <span class="string">&quot;beryllium&quot;</span> | <span class="string">&quot;beryllium&quot;</span>               |</span><br><span class="line">| <span class="string">&quot;boron&quot;</span>     | <span class="string">&quot;boron&quot;</span>                   |</span><br><span class="line">| <span class="string">&quot;carbon&quot;</span>    | <span class="string">&quot;carbon&quot;</span>                  |</span><br><span class="line">| <span class="string">&quot;helium&quot;</span>    | <span class="string">&quot;helium&quot;</span>                  |</span><br><span class="line">| <span class="string">&quot;hydrogen&quot;</span>  | <span class="string">&quot;hydrogen&quot;</span>                |</span><br><span class="line">| <span class="string">&quot;lithium&quot;</span>   | <span class="string">&quot;lithium&quot;</span>                 |</span><br><span class="line">| <span class="string">&quot;nitrogen&quot;</span>  | <span class="string">&quot;nitrogen&quot;</span>                |</span><br><span class="line">| <span class="string">&quot;oxygen&quot;</span>    | <span class="string">&quot;oxygen&quot;</span>                  |</span><br><span class="line">+-------------+---------------------------+</span><br></pre></td></tr></table></figure>

<ol>
<li>First, the rule defines <em>a set document</em> where the contents are defined by the variable <code>name</code>.<ul>
<li>We know this rule defines <em>a set document</em> because the <em>head</em> only includes a <em>key</em>.</li>
</ul>
</li>
<li>Second, the <code>sites[_].servers[_].hostname</code> fragment selects the <code>hostname</code> attribute from all of the objects in the <code>servers</code> collection.<ul>
<li>From reading the fragment in isolation we cannot tell whether the fragment refers to <em>arrays</em> or <em>objects</em>.</li>
<li>We only know that it refers to a <em>collections</em> of values.</li>
</ul>
</li>
<li>Third, the <code>name := sites[_].servers[_].hostname</code> expression binds the value of the <code>hostname</code> attribute to the variable <code>name</code>, which is also declared in the <em>head</em> of the rule.</li>
</ol>
<blockquote>
<p>All rules have the following form (where key, value, and body are all optional)</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;name&gt; &lt;key&gt;? &lt;value&gt;? &lt;body&gt;?</span><br></pre></td></tr></table></figure>

<h3 id="Generating-Objects"><a href="#Generating-Objects" class="headerlink" title="Generating Objects"></a>Generating Objects</h3><blockquote>
<p>Rules that define <em>objects</em> are very similar to rules that define <em>sets</em></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apps_by_hostname[hostname] := app <span class="keyword">if</span> &#123;</span><br><span class="line">    some i</span><br><span class="line">    server := sites[_].servers[_]</span><br><span class="line">    hostname := server.hostname</span><br><span class="line">    apps[i].servers[_] == server.name</span><br><span class="line">    app := apps[i].name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The rule above defines an <em>object</em> that maps hostnames to app names.</p>
</blockquote>
<blockquote>
<p>The main difference between this rule and one which defines a <em>set</em> is the rule <em>head</em>: in addition to declaring a <em>key</em>, the rule head also declares a <em>value</em> for the document.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apps_by_hostname</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;beryllium&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;boron&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;carbon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;helium&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hydrogen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lithium&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nitrogen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;oxygen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mongodb&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Using the (future) keyword if is <em>optional</em> here.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apps_by_hostname[hostname] := app &#123;</span><br><span class="line">    some i</span><br><span class="line">    server := sites[_].servers[_]</span><br><span class="line">    hostname := server.hostname</span><br><span class="line">    apps[i].servers[_] == server.name</span><br><span class="line">    app := apps[i].name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Incremental-Definitions"><a href="#Incremental-Definitions" class="headerlink" title="Incremental Definitions"></a>Incremental Definitions</h3><ol>
<li>A rule may be <em>defined multiple times</em> with the <em>same name</em>.<ul>
<li>When a rule is defined this way, we refer to the rule definition as <em>incremental</em> because <em>each definition is additive</em>.</li>
</ul>
</li>
<li>The document produced by <em>incrementally defined rules</em> is the <em>union</em> of the documents produced by each <em>individual</em> rule.</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">instances contains instance <span class="keyword">if</span> &#123;</span><br><span class="line">    server := sites[_].servers[_]</span><br><span class="line">    instance := &#123;<span class="string">&quot;address&quot;</span>: server.hostname, <span class="string">&quot;name&quot;</span>: server.name&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">instances contains instance <span class="keyword">if</span> &#123;</span><br><span class="line">    container := containers[_]</span><br><span class="line">    instance := &#123;<span class="string">&quot;address&quot;</span>: container.ipaddress, <span class="string">&quot;name&quot;</span>: container.name&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">instances</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;10.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;big_stallman&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;10.0.0.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;cranky_euclid&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;beryllium&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;web-1000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;boron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;web-1001&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;carbon&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;db-1000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;helium&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;web-1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;hydrogen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;web-0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;lithium&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;db-0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;nitrogen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;web-dev&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;oxygen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;db-dev&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If the <em>head</em> of the rule is <em>same</em>, we can <em>chain multiple rule bodies</em> together to obtain the same result.<br>We <em>don’t recommend</em> using this form anymore.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">instances contains instance if &#123;</span><br><span class="line">    server := sites[_].servers[_]</span><br><span class="line">    instance := &#123;&quot;address&quot;: server.hostname, &quot;name&quot;: server.name&#125;</span><br><span class="line">&#125; &#123;</span><br><span class="line">    container := containers[_]</span><br><span class="line">    instance := &#123;&quot;address&quot;: container.ipaddress, &quot;name&quot;: container.name&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>An <em>incrementally defined rule</em> can be intuitively understood as <code>&lt;rule-1&gt; OR &lt;rule-2&gt; OR ... OR &lt;rule-N&gt;</code>.</p>
</blockquote>
<blockquote>
<p>Note that the (future) keywords contains and if are <em>optional</em> here.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">instances[instance] &#123;</span><br><span class="line">    server := sites[_].servers[_]</span><br><span class="line">    instance := &#123;<span class="string">&quot;address&quot;</span>: server.hostname, <span class="string">&quot;name&quot;</span>: server.name&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">instances[instance] &#123;</span><br><span class="line">    container := containers[_]</span><br><span class="line">    instance := &#123;<span class="string">&quot;address&quot;</span>: container.ipaddress, <span class="string">&quot;name&quot;</span>: container.name&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Complete-Definitions"><a href="#Complete-Definitions" class="headerlink" title="Complete Definitions"></a>Complete Definitions</h3><blockquote>
<p>In addition to rules that <em>partially</em> define <em>sets</em> and <em>objects</em>, Rego also supports so-called <em>complete</em> definitions of any type of document.<br>Rules provide a <em>complete definition</em> by <em>omitting the key in the head</em>. Complete definitions are commonly used for <em>constants</em>:</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi := <span class="number">3.14159</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Rego allows authors to <em>omit the body of rules</em>. If the body is omitted, it defaults to <em>true</em>.</p>
</blockquote>
<blockquote>
<p>Documents produced by rules with <em>complete definitions</em> can only have <em>one value</em> at a time.<br>If evaluation produces multiple values for the same document, an error will be returned.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user := <span class="string">&quot;bob&quot;</span></span><br><span class="line">power_users := &#123;<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;fred&quot;</span>&#125;</span><br><span class="line">restricted_users := &#123;<span class="string">&quot;bob&quot;</span>, <span class="string">&quot;kim&quot;</span>&#125;</span><br><span class="line">max_memory := <span class="number">32</span> <span class="keyword">if</span> power_users[user]</span><br><span class="line">max_memory := <span class="number">4</span> <span class="keyword">if</span> restricted_users[user]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">complete rules must not produce multiple outputs</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In some cases, having an undefined result for a document is not desirable. In those cases, policies can use the <em>Default</em> Keyword to provide a <em>fallback</em> value.</p>
</blockquote>
<blockquote>
<p>Note that the (future) keyword if is <em>optional</em> here.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">max_memory := <span class="number">32</span>  &#123;power_users[user]&#125;</span><br><span class="line">max_memory := <span class="number">4</span>  &#123;restricted_users[user]&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rule-Heads-containing-References"><a href="#Rule-Heads-containing-References" class="headerlink" title="Rule Heads containing References"></a>Rule Heads containing References</h3><blockquote>
<p>As a shorthand for <em>defining nested rule structures</em>, it’s valid to use references as <em>rule heads</em></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.contains</span><br><span class="line"><span class="keyword">import</span> future.keywords.<span class="keyword">if</span></span><br><span class="line"><span class="keyword">import</span> future.keywords.in</span><br><span class="line"></span><br><span class="line">fruit.apple.seeds = <span class="number">12</span></span><br><span class="line">fruit.orange.color = <span class="string">&quot;orange&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fruit&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;apple&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;seeds&quot;</span><span class="punctuation">:</span> <span class="number">12</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;orange&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;orange&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>This module defines <em>two complete rules</em><br><code>data.play.fruit.apple.seeds</code> + <code>data.play.fruit.orange.color</code></p>
</blockquote>
<h4 id="Variables-in-Rule-Head-References"><a href="#Variables-in-Rule-Head-References" class="headerlink" title="Variables in Rule Head References"></a>Variables in Rule Head References</h4><h5 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h5><blockquote>
<p>Any term, <em>except the very first</em>, in a rule <em>head</em>’s reference can be a <em>variable</em>.<br>These variables can be <em>assigned within the rule</em>, just as for any other <em>partial rule</em>, to <em>dynamically construct a nested collection of objects</em>.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;employee&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USA&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bob&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USA&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dora&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sweden&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;admins&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;charlie&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords</span><br><span class="line"></span><br><span class="line"># A partial object rule that converts a list of users to a mapping by <span class="string">&quot;role&quot;</span> and then <span class="string">&quot;id&quot;</span>.</span><br><span class="line">users_by_role[role][id] := user <span class="keyword">if</span> &#123;</span><br><span class="line">    some user in input.users</span><br><span class="line">    id := user.id</span><br><span class="line">    role := user.role</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Partial rule with an explicit <span class="string">&quot;admin&quot;</span> key override</span><br><span class="line">users_by_role.admin[id] := user <span class="keyword">if</span> &#123;</span><br><span class="line">    some user in input.admins</span><br><span class="line">    id := user.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Leaf entries can be partial sets</span><br><span class="line">users_by_country[country] contains user.id <span class="keyword">if</span> &#123;</span><br><span class="line">    some user in input.users</span><br><span class="line">    country := user.country</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;users_by_country&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Sweden&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;dora&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;USA&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;bob&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;users_by_role&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;charlie&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;charlie&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;dora&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sweden&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dora&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;customer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bob&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USA&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bob&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;employee&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;alice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;country&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USA&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;employee&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="Conflicts"><a href="#Conflicts" class="headerlink" title="Conflicts"></a>Conflicts</h5><blockquote>
<p>The <em>first variable</em> declared in a rule <em>head</em>’s reference divides the reference in <em>a leading constant portion</em> and <em>a trailing dynamic portion</em>.<br>Other rules are allowed to <em>overlap</em> with the <em>dynamic portion</em> (dynamic extent) without causing a <em>compile-time conflict</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># R1</span><br><span class="line">p[x].r := y &#123;</span><br><span class="line">    x := <span class="string">&quot;q&quot;</span></span><br><span class="line">    y := <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># R2</span><br><span class="line">p.q.r := <span class="number">2</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the above example, rule <code>R2</code> overlaps with the <em>dynamic portion</em> of rule <code>R1</code>’s reference (<code>[x].r</code>), which is allowed at compile-time, as these rules aren’t guaranteed to produce conflicting output.<br>However, as <code>R1</code> defines <code>x</code> as <code>&quot;q&quot;</code> and <code>y</code> as <code>1</code>, a <em>conflict</em> will be reported at evaluation-time.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval_conflict_error: object keys must be unique</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># R1</span><br><span class="line">p[x].r := y <span class="keyword">if</span> &#123;</span><br><span class="line">    x := <span class="string">&quot;q&quot;</span></span><br><span class="line">    y := <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># R2</span><br><span class="line">p.q.r := <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>Conflicts</em> are detected at <em>compile-time</em>, where possible, between rules even if they are within the dynamic extent of another rule.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords</span><br><span class="line"></span><br><span class="line"># R1</span><br><span class="line">p[x].r := y <span class="keyword">if</span> &#123;</span><br><span class="line">    x := <span class="string">&quot;foo&quot;</span></span><br><span class="line">    y := <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># R2</span><br><span class="line">p.q.r := <span class="number">2</span></span><br><span class="line"></span><br><span class="line"># R3</span><br><span class="line">p.q.r.s := <span class="number">3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rego_type_error: rule data.play.p.q.r conflicts with [data.play.p.q.r.s]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Above, <code>R2</code> and <code>R3</code> are within the <em>dynamic extent</em> of <code>R1</code>, but are in conflict with each other, which is detected at compile-time.</p>
</blockquote>
<blockquote>
<p>Rules are <em>not allowed to overlap</em> with <em>object values</em> of other rules.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># R1</span><br><span class="line">p.q.r := &#123;<span class="string">&quot;s&quot;</span>: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"># R2</span><br><span class="line">p[x].r.t := <span class="number">2</span> &#123;</span><br><span class="line">    x := <span class="string">&quot;q&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval_conflict_error: object keys must be unique</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the above example, <code>R1</code> is within the <em>dynamic extent</em> of <code>R2</code> and a conflict cannot be detected at <em>compile-time</em>.<br>However, at <em>evaluation-time</em> <code>R2</code> will attempt to inject a value under key <code>t</code> in an <em>object value</em> defined by <code>R1</code>.<br>This is a conflict, as rules are not allowed to <em>modify or replace values defined by other rules</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># R1</span><br><span class="line">p.q.r.s := <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># R2</span><br><span class="line">p[x].r.t := <span class="number">2</span> <span class="keyword">if</span> &#123;</span><br><span class="line">    x := <span class="string">&quot;q&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;s&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>As <code>R1</code> is now instead defining a value within the <em>dynamic extent</em> of <code>R2</code>’s reference, which is allowed.</p>
</blockquote>
<h3 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h3><blockquote>
<p>Rego supports <em>user-defined functions</em> that can be called with the same semantics as Built-in Functions.<br>They have access to both the the <em>data</em> Document and the <em>input</em> Document</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords</span><br><span class="line"></span><br><span class="line">trim_and_split(s) := x <span class="keyword">if</span> &#123;</span><br><span class="line">    t := trim(s, <span class="string">&quot; &quot;</span>)</span><br><span class="line">    x := split(t, <span class="string">&quot;.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := trim_and_split(<span class="string">&quot;   foo.bar &quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;bar&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note that the (future) keyword if is <em>optional</em> here.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">trim_and_split(s) := x &#123;</span><br><span class="line">    t := trim(s, <span class="string">&quot; &quot;</span>)</span><br><span class="line">    x := split(t, <span class="string">&quot;.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Functions may have an <em>arbitrary number of inputs</em>, but <em>exactly one output</em>. Function arguments may be <em>any kind of term</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">foo([x, &#123;<span class="string">&quot;bar&quot;</span>: y&#125;]) := z <span class="keyword">if</span> &#123;</span><br><span class="line">    z := &#123;x: y&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r1 := foo([<span class="string">&quot;5&quot;</span>, &#123;<span class="string">&quot;bar&quot;</span>: <span class="string">&quot;hello&quot;</span>&#125;])</span><br><span class="line"></span><br><span class="line">r2 := foo([<span class="string">&quot;5&quot;</span>, &#123;<span class="string">&quot;bar&quot;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>]]&#125;])</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;r1&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;5&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;r2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;5&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;bar&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you need <em>multiple outputs</em>, write your functions so that the output is an <em>array</em>, <em>object</em> or <em>set</em> containing your results.<br>If the output term is <em>omitted</em>, it is equivalent to having the output term be the literal <code>true</code>.<br>Furthermore, <code>if</code> can be used to write <em>shorter definitions</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">f(x) &#123; x == <span class="string">&quot;foo&quot;</span> &#125;</span><br><span class="line">f(x) <span class="keyword">if</span> &#123; x == <span class="string">&quot;foo&quot;</span> &#125;</span><br><span class="line">f(x) <span class="keyword">if</span> x == <span class="string">&quot;foo&quot;</span></span><br><span class="line"></span><br><span class="line">f(x) := <span class="literal">true</span> &#123; x == <span class="string">&quot;foo&quot;</span> &#125;</span><br><span class="line">f(x) := <span class="literal">true</span> <span class="keyword">if</span> &#123; x == <span class="string">&quot;foo&quot;</span> &#125;</span><br><span class="line">f(x) := <span class="literal">true</span> <span class="keyword">if</span> x == <span class="string">&quot;foo&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The outputs of user functions have some additional limitations, namely that they must resolve to <em>a single value</em>.<br>If you write a function that has <em>multiple possible bindings for an output variable</em>, you will get a <em>conflict</em> error</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p(x) := y <span class="keyword">if</span> &#123;</span><br><span class="line">    y := x[_]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := p([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval_conflict_error: functions must not produce multiple outputs for same inputs</span><br></pre></td></tr></table></figure>

<blockquote>
<p>It is possible in Rego to define a function more than once, to achieve a <em>conditional selection</em> of which function to execute: Functions can be <em>defined incrementally</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">q(<span class="number">1</span>, x) := y <span class="keyword">if</span> &#123;</span><br><span class="line">    y := x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">q(<span class="number">2</span>, x) := y <span class="keyword">if</span> &#123;</span><br><span class="line">    y := x * <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r1 := q(<span class="number">1</span>, <span class="number">1</span>) # <span class="number">1</span></span><br><span class="line">r2 := q(<span class="number">2</span>, <span class="number">1</span>) # <span class="number">4</span></span><br><span class="line">r3 := q(<span class="number">3</span>, <span class="number">1</span>) # undefined</span><br></pre></td></tr></table></figure>

<blockquote>
<p>A given function call will execute <em>all</em> functions that match the <em>signature</em> given.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">r(<span class="number">1</span>, x) := y <span class="keyword">if</span> &#123;</span><br><span class="line">    y := x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r(x, <span class="number">2</span>) := y <span class="keyword">if</span> &#123;</span><br><span class="line">    y := x * <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r1 := r(<span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval_conflict_error: functions must not produce multiple outputs for same inputs</span><br></pre></td></tr></table></figure>

<blockquote>
<p>On the other hand, if a call <em>matches no functions</em>, then the result is <em>undefined</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s(x, <span class="number">2</span>) := y <span class="keyword">if</span> &#123;</span><br><span class="line">    y := x * <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := s(<span class="number">5</span>, <span class="number">3</span>) # undefined</span><br></pre></td></tr></table></figure>

<h4 id="Function-overloading"><a href="#Function-overloading" class="headerlink" title="Function overloading"></a>Function overloading</h4><blockquote>
<p>Rego <em>does not currently support</em> the <em>overloading</em> of functions by the <em>number of parameters</em>.<br>If two function definitions are given with the <em>same function name</em> but <em>different numbers of parameters</em>, a <em>compile-time type error</em> is generated.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">r(x) := result <span class="keyword">if</span> &#123;</span><br><span class="line">    result := <span class="number">2</span> * x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r(x, y) := result <span class="keyword">if</span> &#123;</span><br><span class="line">    result := (<span class="number">2</span> * x) + (<span class="number">3</span> * y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rego_type_error: conflicting rules data.play.r found</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The error can be avoided by using different function names.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">r_1(x) := result <span class="keyword">if</span> &#123;</span><br><span class="line">    result := <span class="number">2</span> * x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r_2(x, y) := result <span class="keyword">if</span> &#123;</span><br><span class="line">    result := (<span class="number">2</span> * x) + (<span class="number">3</span> * y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := [r_1(<span class="number">10</span>), r_2(<span class="number">10</span>, <span class="number">1</span>)]</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">23</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the unusual case that it is critical to use the <em>same name</em>, the function could be made to take the <em>list of parameters</em> as <em>a single array</em>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">r(params) := result <span class="keyword">if</span> &#123;</span><br><span class="line">    count(params) == <span class="number">1</span></span><br><span class="line">    result := <span class="number">2</span> * params[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r(params) := result <span class="keyword">if</span> &#123;</span><br><span class="line">    count(params) == <span class="number">2</span></span><br><span class="line">    result := (<span class="number">2</span> * params[<span class="number">0</span>]) + (<span class="number">3</span> * params[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">x := [r([<span class="number">10</span>]), r([<span class="number">10</span>, <span class="number">1</span>])]</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;x&quot;</span>: [</span><br><span class="line">        <span class="number">20</span>,</span><br><span class="line">        <span class="number">23</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Negation"><a href="#Negation" class="headerlink" title="Negation"></a>Negation</h2><blockquote>
<p>To generate the content of a <em>Virtual</em> Document, OPA attempts to bind variables in the body of the rule such that <em>all expressions</em> in the rule evaluate to <em>True</em>.<br>This generates the correct result when the expressions represent <em>assertions</em> about what <em>states</em> should <em>exist</em> in the data stored in OPA.<br>In some cases, you want to express that certain states <em>should not exist</em> in the data stored in OPA. In these cases, <em>negation</em> must be used.</p>
</blockquote>
<blockquote>
<p>For safety, a variable appearing in <em>a negated expression</em> must also appear in another <em>non-negated equality expression</em> in the <em>rule</em>.</p>
</blockquote>
<ol>
<li>OPA will <em>reorder expressions</em> to ensure that <em>negated expressions are evaluated</em> after other <em>non-negated expressions</em> with the <em>same variables</em>.</li>
<li>OPA will <em>reject</em> rules containing <em>negated expressions</em> that do not meet the <em>safety criteria</em> described above.</li>
</ol>
<blockquote>
<p>The simplest use of negation involves only <em>scalar values</em> or <em>variables</em> and is equivalent to <em>complementing the operator</em></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t if &#123;</span><br><span class="line">    greeting := &quot;hello&quot;</span><br><span class="line">    not greeting == &quot;goodbye&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Negation is required to check whether some value <em>does not exist</em> in a collection.<br>That is, <em>complementing</em> the operator in an expression such as <code>p[_] == &quot;foo&quot;</code> yields <code>p[_] != &quot;foo&quot;</code>.<br>However, this is <em>not equivalent to</em> <code>not p[&quot;foo&quot;]</code>.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">prod_servers contains name <span class="keyword">if</span> &#123;</span><br><span class="line">    some site in sites</span><br><span class="line">    site.name == <span class="string">&quot;prod&quot;</span></span><br><span class="line">    some server in site.servers</span><br><span class="line">    name := server.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apps_in_prod contains name <span class="keyword">if</span> &#123;</span><br><span class="line">    some site in sites</span><br><span class="line">    some app in apps</span><br><span class="line">    name := app.name</span><br><span class="line">    some server in app.servers</span><br><span class="line">    prod_servers[server]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apps_not_in_prod contains name <span class="keyword">if</span> &#123;</span><br><span class="line">    some app in apps</span><br><span class="line">    name := app.name</span><br><span class="line">    not apps_in_prod[name]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        <span class="attr">&quot;prod_servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;db-0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;web-0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;web-1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;apps_in_prod&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;web&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;apps_not_in_prod&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;mongodb&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="Universal-Quantification-FOR-ALL"><a href="#Universal-Quantification-FOR-ALL" class="headerlink" title="Universal Quantification - FOR ALL"></a>Universal Quantification - FOR ALL</h2><blockquote>
<p>policy</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">There must be no apps named &quot;bitcoin-miner&quot;.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The most expressive way to state this in Rego is using the <code>every</code> keyword</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">no_bitcoin_miners_using_every if &#123;</span><br><span class="line">    every app in apps &#123;</span><br><span class="line">        app.name != &quot;bitcoin-miner&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Variables in Rego are <em>existentially quantified</em> by default</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arr := [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]</span><br><span class="line">x := i if arr[i] == &quot;three&quot; # 2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Define a rule that finds if there <em>exists</em> a bitcoin-mining app (which is easy using the <code>some</code> keyword).<br>And then you use <em>negation</em> to check that there is NO bitcoin-mining app.<br>Technically, you’re using 2 negations and an existential quantifier, which is logically the same as a universal quantifier.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">any_bitcoin_miners if &#123;</span><br><span class="line">    some app in apps</span><br><span class="line">    app.name == &quot;bitcoin-miner&quot;</span><br><span class="line">&#125; # undefined</span><br><span class="line"></span><br><span class="line">no_bitcoin_miners_using_negation if not any_bitcoin_miners # true</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">no_bitcoin_miners_using_negation with apps as [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;web&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">no_bitcoin_miners_using_negation with apps as [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;bitcoin-miner&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;web&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>undefined</code> result above is expected because we did not define a <em>default</em> value for <code>no_bitcoin_miners_using_negation</code>.<br>Since the body of the rule <em>fails to match</em>, there is <em>no value generated</em>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">no_bitcoin_miners if &#123;</span><br><span class="line">    app := apps[_]</span><br><span class="line">    app.name != &quot;bitcoin-miner&quot;  # THIS IS NOT CORRECT.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">no_bitcoin_miners if &#123;</span><br><span class="line">    some app in apps</span><br><span class="line">    app.name != &quot;bitcoin-miner&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The reason the rule is <em>incorrect</em> is that variables in Rego are <em>existentially quantified</em>. This means that rule bodies and queries express <em>FOR ANY</em> and <em>not FOR ALL</em>.<br>To express <em>FOR ALL</em> in Rego <em>complement the logic in the rule body</em> (e.g., <code>!=</code> becomes <code>==</code>) and then <em>complement the check</em> using <em>negation</em><br><code>FOR ALL = Not FOR ANY</code></p>
</blockquote>
<blockquote>
<p>Alternatively, we can implement the same kind of logic inside a single rule using <em>Comprehensions</em>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">no_bitcoin_miners_using_comprehension if &#123;</span><br><span class="line">    bitcoin_miners := &#123;app | some app in apps; app.name == &quot;bitcoin-miner&quot;&#125;</span><br><span class="line">    count(bitcoin_miners) == 0</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Whether you use <em>negation</em>, <em>comprehensions</em>, or <code>every</code> to express <em>FOR ALL</em> is up to you.<br>The <code>every</code> keyword should lend itself nicely to a rule formulation that closely follows how requirements are stated, and thus enhances your policy’s readability.</p>
</blockquote>
<blockquote>
<p>The <em>comprehension version</em> is <em>more concise</em> than the <em>negation variant</em>, and does not require a <em>helper rule</em> while the negation version is <em>more verbose</em> but a bit <em>simpler</em> and allows for <em>more complex ORs</em>.</p>
</blockquote>
<h2 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h2><blockquote>
<p>In Rego, <em>policies</em> are defined inside <em>modules</em>. Modules consist of:</p>
</blockquote>
<ol>
<li>Exactly <em>one Package declaration</em>.</li>
<li><em>Zero or more Import statements</em>.</li>
<li><em>Zero or more Rule definitions</em>.</li>
</ol>
<blockquote>
<p>Modules are typically <em>represented in Unicode text</em> and <em>encoded in UTF-8</em>.</p>
</blockquote>
<h3 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h3><blockquote>
<p>Comments begin with the <code>#</code> character and continue until the <em>end</em> of the line.</p>
</blockquote>
<h3 id="Packages"><a href="#Packages" class="headerlink" title="Packages"></a>Packages</h3><ol>
<li>Packages <em>group the rules defined</em> in one or more <em>modules</em> into a particular <em>namespace</em>.<ul>
<li>Because rules are <em>namespaced</em> they can be safely shared across projects.</li>
</ul>
</li>
<li>Modules contributing to the <em>same package</em> do not have to be located in the <em>same directory</em>.</li>
<li>The rules defined in a module are <em>automatically exported</em>.</li>
<li>That is, they can be queried under OPA’s Data API provided the appropriate package is given.</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> opa.examples</span><br><span class="line"></span><br><span class="line">pi := <span class="number">3.14159</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>pi</code> document can be queried via the Data API</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://example.com/v1/data/opa/examples/pi HTTP/1.1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Valid package names are <em>variables</em> or <em>references</em> that only contain <em>string operands</em>. valid package names</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">package foo</span><br><span class="line">package foo.bar</span><br><span class="line">package foo.bar.baz</span><br><span class="line">package foo[&quot;bar.baz&quot;].qux</span><br></pre></td></tr></table></figure>

<blockquote>
<p>invalid package names</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">package 1foo        # not a variable</span><br><span class="line">package foo[1].bar  # contains non-string operand</span><br></pre></td></tr></table></figure>

<h3 id="Imports"><a href="#Imports" class="headerlink" title="Imports"></a>Imports</h3><ol>
<li>Import statements declare dependencies that modules have on documents defined outside the package.<ul>
<li>By importing a document, the <em>identifiers exported by that document</em> can be referenced within the current module.</li>
</ul>
</li>
<li>All modules contain <em>implicit statements</em> which import the <code>data</code> and <code>input</code> documents.<ul>
<li>Modules use the same syntax to <em>declare dependencies</em> on <em>Base</em> and <em>Virtual</em> Documents.</li>
</ul>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package play</span><br><span class="line"></span><br><span class="line">import future.keywords # uses &#x27;in&#x27; and &#x27;contains&#x27; and &#x27;if&#x27;</span><br><span class="line"></span><br><span class="line">import data.servers</span><br><span class="line"></span><br><span class="line">http_servers contains server if &#123;</span><br><span class="line">    some server in servers # import data.servers</span><br><span class="line">    &quot;http&quot; in server.protocols</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;http_servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;p2&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;http&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Similarly, modules can <em>declare dependencies</em> on <em>query arguments</em> by specifying an import path that starts with <code>input</code>.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package opa.examples</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">import input.user</span><br><span class="line">import input.method</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow alice to perform any operation.</span></span><br><span class="line">allow <span class="keyword">if</span> user == <span class="string">&quot;alice&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># allow bob to perform read-only operations.</span></span><br><span class="line">allow <span class="keyword">if</span> &#123;</span><br><span class="line">    user == <span class="string">&quot;bob&quot;</span></span><br><span class="line">    method == <span class="string">&quot;GET&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># allows users assigned a &quot;dev&quot; role to perform read-only operations.</span></span><br><span class="line">allow <span class="keyword">if</span> &#123;</span><br><span class="line">    method == <span class="string">&quot;GET&quot;</span></span><br><span class="line">    input.user <span class="keyword">in</span> data.roles[<span class="string">&quot;dev&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># allows user catherine access on Saturday and Sunday</span></span><br><span class="line">allow <span class="keyword">if</span> &#123;</span><br><span class="line">    user == <span class="string">&quot;catherine&quot;</span></span><br><span class="line">    day := time.weekday(time.now_ns())</span><br><span class="line">    day <span class="keyword">in</span> [<span class="string">&quot;Saturday&quot;</span>, <span class="string">&quot;Sunday&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Imports can include an optional <code>as</code> keyword to handle namespacing issues</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package opa.examples</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">import data.servers as my_servers</span><br><span class="line"></span><br><span class="line">http_servers contains server if &#123;</span><br><span class="line">    some server in my_servers</span><br><span class="line">    &quot;http&quot; in server.protocols</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Future-Keywords"><a href="#Future-Keywords" class="headerlink" title="Future Keywords"></a>Future Keywords</h2><blockquote>
<p>To ensure <em>backwards-compatibility</em>, new keywords (like every) are <em>introduced slowly</em>.<br>In the first stage, users can <em>opt-in</em> to using the new keywords via a special import</p>
</blockquote>
<ol>
<li><code>import future.keywords</code> introduces <em>all</em> future keywords, and</li>
<li><code>import future.keywords.x</code> <em>only</em> introduces the <code>x</code> keyword – see below for all known future keywords.</li>
</ol>
<blockquote>
<p>Using <code>import future.keywords</code> to import <em>all</em> future keywords means an <strong>opt-out of a safety measure</strong>:</p>
</blockquote>
<ol>
<li>With a new version of OPA, the set of <em>all</em> future keywords can <em>grow</em>, and policies that worked with the previous version of OPA <em>stop working</em>.</li>
<li>This cannot happen when you <em>selectively import</em> the future keywords as you need them.</li>
</ol>
<blockquote>
<p>At some point in the future, the keyword will become <em>standard</em>, and the import will become a no-op that can safely be removed.</p>
</blockquote>
<blockquote>
<p>Note that some future keyword imports have consequences on <em>pretty-printing</em><br>If <code>contains</code> or <code>if</code> are <em>imported</em>, the <em>pretty-printer</em> will use them as applicable when <em>formatting</em> the modules.</p>
</blockquote>
<h3 id="in"><a href="#in" class="headerlink" title="in"></a>in</h3><blockquote>
<p>More expressive <em>membership</em> and <em>existential quantification</em> keyword</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">deny &#123;</span><br><span class="line">    some x in input.roles # iteration</span><br><span class="line">    x == <span class="string">&quot;denylisted-role&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">deny &#123;</span><br><span class="line">    <span class="string">&quot;denylisted-role&quot;</span> in input.roles # membership check</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>in was introduced in <em>v0.34.0</em>.</p>
</blockquote>
<h3 id="every"><a href="#every" class="headerlink" title="every"></a>every</h3><blockquote>
<p>Expressive <em>universal quantification</em> keyword</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">allowed := &#123;<span class="string">&quot;customer&quot;</span>, <span class="string">&quot;admin&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">    every role in input.roles &#123;</span><br><span class="line">        role.name in allowed</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>There is no need to also import <code>future.keywords.in</code>, that is <strong>implied</strong> by importing <code>future.keywords.every</code>.</p>
</blockquote>
<blockquote>
<p>every was introduced in <em>v0.38.0</em>.</p>
</blockquote>
<h3 id="if"><a href="#if" class="headerlink" title="if"></a>if</h3><blockquote>
<p>This keyword allows more expressive rule <em>heads</em></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deny <span class="keyword">if</span> input.token != <span class="string">&quot;secret&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>if was introduced in <em>v0.42.0</em>.</p>
</blockquote>
<h3 id="contains"><a href="#contains" class="headerlink" title="contains"></a>contains</h3><blockquote>
<p>This keyword allows more expressive <em>rule heads</em> for <em>partial set rules</em></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deny contains msg &#123; msg := &quot;forbidden&quot; &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>contains was introduced in <em>v0.42.0</em>.</p>
</blockquote>
<h2 id="Some-Keyword"><a href="#Some-Keyword" class="headerlink" title="Some Keyword"></a>Some Keyword</h2><blockquote>
<p>The <code>some</code> keyword allows queries to <em>explicitly declare local variables</em>.<br>Use the <code>some</code> keyword in rules that contain unification statements or references with <em>variable</em> operands <strong>if</strong> variables contained in those statements are <em>not declared</em> using <code>:=</code> .</p>
</blockquote>
<table>
<thead>
<tr>
<th>Statement</th>
<th>Example</th>
<th>Variables</th>
</tr>
</thead>
<tbody><tr>
<td>Unification</td>
<td><code>input.a = [[&quot;b&quot;, x], [y, &quot;c&quot;]]</code></td>
<td><code>x</code> and <code>y</code></td>
</tr>
<tr>
<td>Reference with variable operands</td>
<td><code>data.foo[i].bar[j]</code></td>
<td><code>i</code> and <code>j</code></td>
</tr>
</tbody></table>
<blockquote>
<p>For example, the following rule generates tuples of array indices for servers in the “west” region that contain “db” in their name.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tuples contains [i, j] if &#123;</span><br><span class="line">    some i, j</span><br><span class="line">    sites[i].region == &quot;west&quot;</span><br><span class="line">    server := sites[i].servers[j] # note: &#x27;server&#x27; is local because it&#x27;s declared with :=</span><br><span class="line">    contains(server.name, &quot;db&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        <span class="attr">&quot;tuples&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">1</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Since we have declared <code>i</code>, <code>j</code>, and <code>server</code> to be local, we can introduce rules in the same package without affecting the result above:</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Define a rule called <span class="string">&#x27;i&#x27;</span></span></span><br><span class="line">i := 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If we had not declared <code>i</code> with the <code>some</code> keyword, introducing the <code>i</code> rule above would have changed the result of <code>tuples</code> because the <code>i</code> symbol in the body would capture the <em>global</em> value. removing <code>some i, j</code></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Define a rule called <span class="string">&#x27;i&#x27;</span></span></span><br><span class="line">i := 1</span><br><span class="line"></span><br><span class="line">tuples contains [i, j] if &#123;</span><br><span class="line"><span class="meta prompt_">    # </span><span class="language-bash">	some i, j</span></span><br><span class="line">    sites[i].region == &quot;west&quot;</span><br><span class="line">    server := sites[i].servers[j] # note: &#x27;server&#x27; is local because it&#x27;s declared with :=</span><br><span class="line">    contains(server.name, &quot;db&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        <span class="attr">&quot;tuples&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>some</code> keyword is <em>not required</em> but it’s <em>recommended</em> to avoid situations like the one above where introduction of a rule inside a package could change behaviour of other rules.</p>
</blockquote>
<h2 id="Every-Keyword"><a href="#Every-Keyword" class="headerlink" title="Every Keyword"></a>Every Keyword</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">names_with_dev if &#123;</span><br><span class="line">    some site in sites</span><br><span class="line">    site.name == &quot;dev&quot;</span><br><span class="line"></span><br><span class="line">    every server in site.servers &#123;</span><br><span class="line">        endswith(server.name, &quot;-dev&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>every</code> keyword takes an (optional) <em>key</em> argument, a <em>value</em> argument, a domain, and a block of further queries, its “body”.</p>
</blockquote>
<ol>
<li>The keyword is used to <em>explicitly assert</em> that its body is <em>true</em> for <em>any element in the domain</em>.</li>
<li>It will <em>iterate</em> over the domain, <em>bind its variables</em>, and check that the body holds for those bindings.</li>
<li>If <em>one</em> of the bindings <em>does not</em> yield a <em>successful evaluation</em> of the body, the <em>overall</em> statement is <em>undefined</em>.</li>
<li>If the <em>domain</em> is <em>empty</em>, the overall statement is <em>true</em>.</li>
<li>Evaluating <code>every</code> does <strong>not</strong> introduce <em>new bindings</em> into the rule evaluation.</li>
</ol>
<blockquote>
<p>Used with a <em>key</em> argument, the <em>index</em>, or <em>property name</em> (for <em>objects</em>), comes into the scope of the body evaluation</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">array_domain if &#123;</span><br><span class="line">    every i, x in [1, 2, 3] &#123; x - i == 1 &#125; # array domain</span><br><span class="line">&#125; # true</span><br><span class="line"></span><br><span class="line">object_domain if &#123;</span><br><span class="line">    every k, v in &#123;&quot;foo&quot;: &quot;bar&quot;, &quot;fox&quot;: &quot;baz&quot;&#125; &#123; # object domain</span><br><span class="line">        startswith(k, &quot;f&quot;)</span><br><span class="line">        startswith(v, &quot;b&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; # true</span><br><span class="line"></span><br><span class="line">set_domain if &#123;</span><br><span class="line">    every x in &#123;1, 2, 3&#125; &#123; x != 4 &#125; # set domain</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Semantically, <code>every x in xs &#123; p(x) &#125;</code> is equivalent to, but shorter than, a “not-some-not” construct using a helper rule</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xs := [2, 2, 4, 8]</span><br><span class="line"></span><br><span class="line">larger_than_one(x) := x &gt; 1</span><br><span class="line"></span><br><span class="line">rule_every if &#123;</span><br><span class="line">    every x in xs &#123; larger_than_one(x) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">less_or_equal_one if &#123;</span><br><span class="line">    some x in xs</span><br><span class="line">    not larger_than_one(x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">not_less_or_equal_one if not less_or_equal_one</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;not_less_or_equal_one&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rule_every&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;xs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">8</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Negating <code>every</code> is forbidden. If you desire to express <code>not every x in xs &#123; p(x) &#125;</code> please use <code>some x in xs; not p(x)</code> instead.</p>
</blockquote>
<h2 id="With-Keyword"><a href="#With-Keyword" class="headerlink" title="With Keyword"></a>With Keyword</h2><blockquote>
<p>The with keyword allows queries to <em>programmatically</em> specify values <em>nested</em> under the <em>input</em> Document or the <em>data</em> Document, or <em>built-in</em> functions.</p>
</blockquote>
<blockquote>
<p>For example, given the simple authorization policy in the Imports section, we can write a <em>query</em> that checks whether a particular request would be allowed</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allow with input as &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;alice&quot;</span>, <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- </span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allow with input as &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">not allow with input as &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;method&quot;</span>: <span class="string">&quot;DELETE&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allow with input as &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;charlie&quot;</span>, <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>&#125; with data.roles as &#123;<span class="string">&quot;dev&quot;</span>: [<span class="string">&quot;charlie&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">not allow with input as &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;charlie&quot;</span>, <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>&#125; with data.roles as &#123;<span class="string">&quot;dev&quot;</span>: [<span class="string">&quot;bob&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">allow with input as &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;catherine&quot;</span>, <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>&#125;</span><br><span class="line">      with data.roles as &#123;<span class="string">&quot;dev&quot;</span>: [<span class="string">&quot;bob&quot;</span>]&#125;</span><br><span class="line">      with time.weekday as <span class="string">&quot;Sunday&quot;</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>with</code> keyword acts as a <em>modifier</em> on expressions. A single expression is allowed to have <em>zero or more</em> <code>with</code> modifiers. The <code>with</code> keyword has the following syntax<br>The <code>&lt;target&gt;</code>s must be references to values in the <em>input</em> document (or the input document itself) or <em>data</em> document, or references to <em>functions</em> (built-in or not).</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;expr&gt; with &lt;target-1&gt; as &lt;value-1&gt; [with &lt;target-2&gt; as &lt;value-2&gt; [...]]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When applied to the <code>data</code> document, the <code>&lt;target&gt;</code> must <em>not</em> attempt to <em>partially define virtual documents</em>.<br>For example, given a virtual document at path <code>data.foo.bar</code>, the compiler will generate an error if the policy attempts to replace <code>data.foo.bar.baz</code>.</p>
</blockquote>
<blockquote>
<p>The <code>with</code> keyword only <em>affects</em> the <em>attached</em> expression. Subsequent expressions will see the <em>unmodified</em> value.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">inner := [x, y] if &#123; # &#123;&quot;foo&quot;: 100, &quot;bar&quot;: 300&#125;</span><br><span class="line">    x := input.foo</span><br><span class="line">    y := input.bar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">middle := [a, b] if &#123; # &#123;&quot;foo&quot;: 200, &quot;bar&quot;: 300&#125;</span><br><span class="line">    a := inner with input.foo as 100</span><br><span class="line">    b := input # foo still as 200</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">outer := result if &#123;</span><br><span class="line">    result := middle with input as &#123;&quot;foo&quot;: 200, &quot;bar&quot;: 300&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;outer&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">300</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bar&quot;</span><span class="punctuation">:</span> <span class="number">300</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;foo&quot;</span><span class="punctuation">:</span> <span class="number">200</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>When <code>&lt;target&gt;</code> is a reference to a <em>function</em>, like <code>http.send</code>, then its <code>&lt;value&gt;</code> can be any of the following:</p>
</blockquote>
<ol>
<li>a value: <code>with http.send as &#123;&quot;body&quot;: &#123;&quot;success&quot;: true &#125;&#125;</code></li>
<li>a reference to another function: <code>with http.send as mock_http_send</code></li>
<li>a reference to another (possibly custom) built-in function: <code>with custom_builtin as less_strict_custom_builtin</code></li>
<li>a reference to a rule that will be used as the <em>value</em>.</li>
</ol>
<blockquote>
<p>When the <em>replacement value</em> is a <em>function</em>, its <em>arity</em> needs to match the replaced function’s arity; and the <em>types</em> must be compatible.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">f(x) := count(x)</span><br><span class="line"></span><br><span class="line">mock_count(x) := 0 if &quot;x&quot; in x</span><br><span class="line">mock_count(x) := count(x) if not &quot;x&quot; in x</span><br><span class="line"></span><br><span class="line">f([1, 2, 3]) with count as mock_count # 3</span><br><span class="line">f([&quot;x&quot;, &quot;y&quot;, &quot;z&quot;]) with count as mock_count # 0</span><br></pre></td></tr></table></figure>

<h2 id="Default-Keyword"><a href="#Default-Keyword" class="headerlink" title="Default Keyword"></a>Default Keyword</h2><blockquote>
<p>The default keyword allows policies to define <em>a default value</em> for documents produced by rules with <em>Complete Definitions</em>.<br>The default value is used when all of the rules sharing the <em>same name</em> are <em>undefined</em>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">default allow := false # false</span><br><span class="line"></span><br><span class="line">allow if &#123;</span><br><span class="line">    input.user == &quot;bob&quot;</span><br><span class="line">    input.method == &quot;GET&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow if input.user == &quot;alice&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When the <code>allow</code> document is queried, the return value will be either <code>true</code> or <code>false</code><br>Without the default definition, the <code>allow</code> document would simply be <em>undefined</em> for the same input.</p>
</blockquote>
<blockquote>
<p>When the <code>default</code> keyword is used, the rule syntax is restricted to</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default &lt;name&gt; := &lt;term&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The term may be any <em>scalar</em>, <em>composite</em>, or <em>comprehension value</em> but it may not be a <em>variable</em> or <em>reference</em>.<br>If the value is a <em>composite</em> then it may not contain variables or references.<br><em>Comprehensions</em> however may, as the result of a comprehension is <em>never undefined</em>.</p>
</blockquote>
<blockquote>
<p>Similar to <em>rules</em>, the <code>default</code> keyword can be applied to <em>functions</em> as well.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> play</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> clamp_positive(_) := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">clamp_positive(x) = x <span class="keyword">if</span> &#123;</span><br><span class="line">    x &gt; <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := clamp_positive(<span class="number">-1</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When <code>clamp_positive</code> is queried, the return value will be either the argument provided to the function or <code>0</code>.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The value of a <code>default</code> function follows the <em>same conditions</em> as that of a <code>default</code> rule. In addition, a <code>default</code> function satisfies the following properties:</p>
</blockquote>
<ol>
<li>same <em>arity</em> as other functions with the same name</li>
<li>arguments should only be <em>plain variables</em> ie. no composite values</li>
<li>argument names should not be <em>repeated</em></li>
</ol>
<h2 id="Else-Keyword"><a href="#Else-Keyword" class="headerlink" title="Else Keyword"></a>Else Keyword</h2><blockquote>
<p>The <code>else</code> keyword is a basic <em>control flow construct</em> that gives you control over <em>rule evaluation order</em>.<br>Rules grouped together with the <code>else</code> keyword are evaluated <em>until a match is found</em>. Once a match is found, rule evaluation <em>does not proceed to rules further in the chain</em>.</p>
</blockquote>
<blockquote>
<p>The <code>else</code> keyword is useful if you are porting policies into Rego from an <em>order-sensitive</em> system like <em>IPTables</em>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">authorize := &quot;allow&quot; if &#123;</span><br><span class="line">    input.user == &quot;superuser&quot;           # allow &#x27;superuser&#x27; to perform any operation.</span><br><span class="line">&#125; else := &quot;deny&quot; if &#123;</span><br><span class="line">    input.path[0] == &quot;admin&quot;            # disallow &#x27;admin&#x27; operations...</span><br><span class="line">    input.source_network == &quot;external&quot;  # from external networks.</span><br><span class="line">&#125; # ... more rules</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the example below, <em>evaluation stops immediately</em> after the <em>first rule</em> even though the input matches the second rule as well.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;exec_shell&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;source_network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;superuser&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the next example, the input matches the second rule (but not the first) so evaluation continues to the second rule before stopping.</p>
</blockquote>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;exec_shell&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;source_network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>else</code> keyword may be used <em>repeatedly</em> on the same rule and there is <em>no limit</em> imposed on the number of <code>else</code> clauses on a rule.</p>
</blockquote>
<h2 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h2><h3 id="Membership-and-iteration-in"><a href="#Membership-and-iteration-in" class="headerlink" title="Membership and iteration: in"></a>Membership and iteration: in</h3><blockquote>
<p>Membership and iteration</p>
</blockquote>
<blockquote>
<p>The membership operator <code>in</code> lets you check if an element is part of a <em>collection</em> (<em>array</em>, <em>set</em>, or <em>object</em>). It always evaluates to <code>true</code> or <code>false</code></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p := [x, y, z] if &#123;</span><br><span class="line">    x := 3 in [1, 2, 3] # array</span><br><span class="line">    y := 3 in &#123;1, 2, 3&#125; # set</span><br><span class="line">    z := 3 in &#123;&quot;foo&quot;: 1, &quot;bar&quot;: 3&#125; # object</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;p&quot;: [</span><br><span class="line">        true,</span><br><span class="line">        true,</span><br><span class="line">        true</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When providing <em>two arguments</em> on the <em>left-hand</em> side of the <code>in</code> operator, and an <em>object</em> or an <em>array</em> on the <em>right-hand</em> side,<br>the <em>first argument</em> is taken to be the <em>key (object)</em> or <em>index (array)</em>, respectively</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p := [x, y] if &#123;</span><br><span class="line">    x := &quot;foo&quot;, &quot;bar&quot; in &#123;&quot;foo&quot;: &quot;bar&quot;&#125;    # key, val with object</span><br><span class="line">    y := 2, &quot;baz&quot; in [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;] # key, val with array</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>that in <em>list contexts</em>, like <em>set</em> or <em>array</em> definitions and <em>function</em> arguments, <em>parentheses</em> are required to use the form with <em>two left-hand side arguments</em></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p := x if &#123;</span><br><span class="line">    x := &#123; 0, 2 in [2] &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">q := x if &#123;</span><br><span class="line">    x := &#123; (0, 2 in [2]) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">g(x) := sprintf(&quot;one function argument: %v&quot;, [x])</span><br><span class="line">f(x, y) := sprintf(&quot;two function arguments: %v, %v&quot;, [x, y])</span><br><span class="line"></span><br><span class="line">w := x if &#123;</span><br><span class="line">    x := g((0, 2 in [2]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">z := x if &#123;</span><br><span class="line">    x := f(0, 2 in [2])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="string">&quot;one function argument: true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;two function arguments: 0, true&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Combined with <code>not</code>, the operator can be handy when asserting that an element is <em>not member</em> of an array</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deny if not &quot;admin&quot; in input.user.roles</span><br><span class="line"></span><br><span class="line">test_deny if &#123;</span><br><span class="line">    deny with input.user.roles as [&quot;operator&quot;, &quot;user&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test_deny&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>that expressions using the <code>in</code> operator <em>always return <code>true</code> or <code>false</code></em>, even when called in <em>non-collection</em> arguments</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">q := x if &#123;</span><br><span class="line">    x := 3 in &quot;three&quot;</span><br><span class="line">&#125; # false</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Using the <code>some</code> variant, it can be used to introduce <em>new variables based on a collections’ items</em></p>
</blockquote>
<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p<span class="punctuation">[</span>x<span class="punctuation">]</span> <span class="punctuation">&#123;</span></span><br><span class="line">    some x in <span class="punctuation">[</span><span class="string">&quot;a&quot;</span><span class="punctuation">,</span> <span class="string">&quot;r&quot;</span><span class="punctuation">,</span> <span class="string">&quot;r&quot;</span><span class="punctuation">,</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span> <span class="string">&quot;y&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">q<span class="punctuation">[</span>x<span class="punctuation">]</span> <span class="punctuation">&#123;</span></span><br><span class="line">    some x in <span class="punctuation">&#123;</span><span class="string">&quot;s&quot;</span><span class="punctuation">,</span> <span class="string">&quot;e&quot;</span><span class="punctuation">,</span> <span class="string">&quot;t&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">r<span class="punctuation">[</span>x<span class="punctuation">]</span> <span class="punctuation">&#123;</span></span><br><span class="line">    some x in <span class="punctuation">&#123;</span><span class="attr">&quot;foo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bar&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;baz&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quz&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;r&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;y&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;e&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;t&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;bar&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;quz&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Furthermore, passing a <em>second argument</em> allows you to work with <em>object keys</em> and <em>array indices</em></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p[x] &#123;</span><br><span class="line">    some x, &quot;r&quot; in [&quot;a&quot;, &quot;r&quot;, &quot;r&quot;, &quot;a&quot;, &quot;y&quot;] # key variable, value constant</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">q[x] = y if &#123;</span><br><span class="line">     some x, y in [&quot;a&quot;, &quot;r&quot;, &quot;r&quot;, &quot;a&quot;, &quot;y&quot;] # both variables</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r[y] = x if &#123;</span><br><span class="line">    some x, y in &#123;&quot;foo&quot;: &quot;bar&quot;, &quot;baz&quot;: &quot;quz&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;q&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;0&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;r&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;r&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;y&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;quz&quot;</span><span class="punctuation">:</span> <span class="string">&quot;baz&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Any argument to the <code>some</code> variant can be a <em>composite, non-ground value</em></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p[x] = y if &#123;</span><br><span class="line">    some x, &#123;&quot;foo&quot;: y&#125; in [&#123;&quot;foo&quot;: 100&#125;, &#123;&quot;bar&quot;: 200&#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p[x] = y if &#123;</span><br><span class="line">    some &#123;&quot;bar&quot;: x&#125;, &#123;&quot;foo&quot;: y&#125; in &#123;&#123;&quot;bar&quot;: &quot;b&quot;&#125;: &#123;&quot;foo&quot;: &quot;f&quot;&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;0&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Equality-Assignment-Comparison-and-Unification"><a href="#Equality-Assignment-Comparison-and-Unification" class="headerlink" title="Equality: Assignment, Comparison, and Unification"></a>Equality: Assignment, Comparison, and Unification</h3><blockquote>
<p>Rego supports three kinds of equality: <em>assignment</em> (<code>:=</code>), <em>comparison</em> (<code>==</code>), and <em>unification</em> <code>=</code>.<br>We recommend using assignment (<code>:=</code>) and comparison (<code>==</code>) whenever possible for policies that are easier to read and write.</p>
</blockquote>
<h4 id="Assignment"><a href="#Assignment" class="headerlink" title="Assignment :&#x3D;"></a>Assignment :&#x3D;</h4><blockquote>
<p>The assignment operator (<code>:=</code>) is used to <em>assign values to variables</em>.<br>Variables assigned inside a rule are <em>locally scoped</em> to that rule and <em>shadow global variables</em>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x := 100</span><br><span class="line"></span><br><span class="line">p if &#123;</span><br><span class="line">    x := 1     # declare local variable &#x27;x&#x27; and assign value 1</span><br><span class="line">    x != 100   # true because &#x27;x&#x27; refers to local variable</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>Assigned variables</em> are not allowed to <em>appear before the assignment</em> in the query.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p if &#123;</span><br><span class="line">    x != 100</span><br><span class="line">    x := 1     # error because x appears earlier in the query.</span><br><span class="line">&#125; # rego_compile_error: var x referenced above</span><br><span class="line"></span><br><span class="line">q if &#123;</span><br><span class="line">    x := 1</span><br><span class="line">    x := 2     # error because x is assigned twice.</span><br><span class="line">&#125; # rego_compile_error: var x assigned above</span><br></pre></td></tr></table></figure>

<blockquote>
<p>A simple form of <em>destructuring</em> can be used to <em>unpack values from arrays</em> and <em>assign</em> them to variables</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">address := [<span class="string">&quot;3 Abbey Road&quot;</span>, <span class="string">&quot;NW8 9AY&quot;</span>, <span class="string">&quot;London&quot;</span>, <span class="string">&quot;England&quot;</span>]</span><br><span class="line"></span><br><span class="line">in_london <span class="keyword">if</span> &#123;</span><br><span class="line">    [_, _, city, country] := address</span><br><span class="line">    city == <span class="string">&quot;London&quot;</span></span><br><span class="line">    country == <span class="string">&quot;England&quot;</span></span><br><span class="line">&#125; <span class="comment"># true</span></span><br></pre></td></tr></table></figure>

<h4 id="Comparison"><a href="#Comparison" class="headerlink" title="Comparison &#x3D;&#x3D;"></a>Comparison &#x3D;&#x3D;</h4><blockquote>
<p>Comparison checks if two values are equal within a rule. If the left or right hand side contains a variable that <em>has not been assigned</em> a value, the compiler throws an error.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p if &#123;</span><br><span class="line">    x := 100</span><br><span class="line">    x == 100   # true because x refers to the local variable</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">y := 100</span><br><span class="line">q if &#123;</span><br><span class="line">    y == 100   # true because y refers to the global variable</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r if &#123;</span><br><span class="line">    z == 100   # compiler error because z has not been assigned a value</span><br><span class="line">&#125; # rego_unsafe_var_error: var z is unsafe</span><br></pre></td></tr></table></figure>

<h4 id="Unification"><a href="#Unification" class="headerlink" title="Unification &#x3D;"></a>Unification &#x3D;</h4><blockquote>
<p>Unification (<code>=</code>) combines <em>assignment</em> and <em>comparison</em>.<br>Rego will <em>assign variables to values</em> that <em>make the comparison true</em>.<br>Unification lets you ask for values for variables that <em>make an expression true</em>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p[x] = y if &#123;</span><br><span class="line">    [x, &quot;world&quot;] = [&quot;hello&quot;, y]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>As <em>opposed</em> to when assignment (<code>:=</code>) is used, the <em>order</em> of expressions in a rule <em>does not affect</em> the document’s content.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s if &#123;</span><br><span class="line">    x &gt; y</span><br><span class="line">    y = 41</span><br><span class="line">    x = 42</span><br><span class="line">&#125; # true</span><br></pre></td></tr></table></figure>

<h4 id="Best-Practices-for-Equality"><a href="#Best-Practices-for-Equality" class="headerlink" title="Best Practices for Equality"></a>Best Practices for Equality</h4><blockquote>
<p>Here is a <em>comparison</em> of the three forms of equality.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Equality</th>
<th>Applicable</th>
<th>Compiler Errors</th>
<th>Use Case</th>
</tr>
</thead>
<tbody><tr>
<td>:&#x3D;</td>
<td>Everywhere</td>
<td>Var already assigned</td>
<td>Assign variable</td>
</tr>
<tr>
<td>&#x3D;&#x3D;</td>
<td>Everywhere</td>
<td>Var not assigned</td>
<td>Compare values</td>
</tr>
<tr>
<td>&#x3D;</td>
<td>Everywhere</td>
<td>Values cannot be computed</td>
<td>Express query</td>
</tr>
</tbody></table>
<blockquote>
<p>Best practice is to use <em>assignment</em> <code>:=</code> and <em>comparison</em> <code>==</code> wherever possible.<br>The <em>additional compiler checks</em> help avoid errors when writing policy, and the additional syntax helps <em>make the intent clearer</em> when <em>reading</em> policy.</p>
</blockquote>
<blockquote>
<p>Under the hood <code>:=</code> and <code>==</code> are <em>syntactic sugar</em> for <code>=</code>, local variable creation, and additional compiler checks.</p>
</blockquote>
<h3 id="Comparison-Operators"><a href="#Comparison-Operators" class="headerlink" title="Comparison Operators"></a>Comparison Operators</h3><blockquote>
<p>The following comparison operators are supported:</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  ==  b  #  `a` is equal to `b`.</span><br><span class="line">a  !=  b  #  `a` is not equal to `b`.</span><br><span class="line">a  &lt;   b  #  `a` is less than `b`.</span><br><span class="line">a  &lt;=  b  #  `a` is less than or equal to `b`.</span><br><span class="line">a  &gt;   b  #  `a` is greater than `b`.</span><br><span class="line">a  &gt;=  b  #  `a` is greater than or equal to `b`.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>None of these operators <em>bind variables</em> contained in the expression. As a result, if either operand is a variable, the variable must appear in another expression in the same rule that would cause the variable to <em>be bound</em>, i.e., an equality expression or the target position of a built-in function.</p>
</blockquote>
<h2 id="Built-in-Functions"><a href="#Built-in-Functions" class="headerlink" title="Built-in Functions"></a>Built-in Functions</h2><blockquote>
<p>Built-ins can be easily recognized by their <em>syntax</em>. All built-ins have the following form<br>Built-ins usually take <em>one or more input values</em> and <em>produce one output value</em>. Unless stated otherwise, all built-ins accept <em>values</em> or <em>variables</em> as <em>output</em> arguments.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;name&gt;(&lt;arg-1&gt;, &lt;arg-2&gt;, ..., &lt;arg-n&gt;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If a built-in function is invoked with a <em>variable</em> as <em>input</em>, the variable must be <em>safe</em>, i.e., it must be <em>assigned</em> elsewhere in the query.</p>
</blockquote>
<blockquote>
<p>Built-ins can include <code>.</code> characters in the name. This allows them to be <em>namespaced</em>.<br>If you are adding custom built-ins to OPA, consider <em>namespacing</em> them to avoid naming conflicts, e.g., <code>org.example.special_func</code>.</p>
</blockquote>
<h3 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h3><blockquote>
<p>By default, built-in function calls that encounter <em>runtime errors</em> evaluate to <em>undefined</em> (which can usually be treated as <code>false</code>) and <em>do not halt policy evaluation</em>.<br>This ensures that built-in functions can be called with <em>invalid inputs</em> without causing the entire policy to <em>stop evaluating</em>.</p>
</blockquote>
<blockquote>
<p>In most cases, policies do not have to implement any kind of <em>error handling logic</em>.<br>If error handling is required, the built-in function call can be <em>negated</em> to test for <em>undefined</em>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">allow if &#123;</span><br><span class="line">    io.jwt.verify_hs256(input.token, &quot;secret&quot;)</span><br><span class="line">    [_, payload, _] := io.jwt.decode(input.token)</span><br><span class="line">    payload.role == &quot;admin&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reason contains &quot;invalid JWT supplied as input&quot; if &#123;</span><br><span class="line">    not io.jwt.decode(input.token)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a poorly formatted token&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>output.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;invalid JWT supplied as input&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you wish to disable this behaviour and instead have built-in function call errors treated as <em>exceptions</em> that <em>halt policy evaluation</em> enable <code>strict built-in errors</code> in the caller</p>
</blockquote>
<h2 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h2><blockquote>
<p>The package and individual rules in a module can be <em>annotated</em> with a rich set of metadata.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">METADATA</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">title: My rule</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">description: A rule that determines <span class="keyword">if</span> x is allowed.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">authors:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- John Doe &lt;john@example.com&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">entrypoint: <span class="literal">true</span></span></span><br><span class="line">allow &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Annotations are grouped within a <em>metadata block</em>, and must be specified as YAML within a comment block that <strong>must</strong> start with <code># METADATA</code>.<br>Also, every line in the comment block containing the annotation <strong>must</strong> start at Column 1 in the module&#x2F;file, or otherwise, they will be ignored.</p>
</blockquote>
<h2 id="Strict-Mode"><a href="#Strict-Mode" class="headerlink" title="Strict Mode"></a>Strict Mode</h2><ol>
<li>The Rego compiler supports <code>strict mode</code>, where <em>additional constraints</em> and <em>safety checks</em> are <em>enforced</em> during <em>compilation</em>.</li>
<li>Compiler rules that will be enforced by future versions of OPA, but will be a <em>breaking change</em> once introduced, are incubated in strict mode.</li>
<li>This creates an opportunity for users to verify that their policies are compatible with the next version of OPA before upgrading.</li>
</ol>
<blockquote>
<p>Compiler Strict mode is supported by the <code>check</code> command, and can be enabled through the <code>-S</code> flag.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ opa help check</span><br><span class="line">Check Rego source files for parse and compilation errors.</span><br><span class="line"></span><br><span class="line">    If the &#x27;check&#x27; command succeeds in parsing and compiling the source file(s), no output</span><br><span class="line">    is produced. If the parsing or compiling fails, &#x27;check&#x27; will output the errors</span><br><span class="line">    and exit with a non-zero exit code.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  opa check &lt;path&gt; [path [...]] [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -b, --bundle                 load paths as bundle files or root directories</span><br><span class="line">      --capabilities string    set capabilities version or capabilities.json file path</span><br><span class="line">  -f, --format &#123;pretty,json&#125;   set output format (default pretty)</span><br><span class="line">  -h, --help                   help for check</span><br><span class="line">      --ignore strings         set file and directory names to ignore during loading (e.g., &#x27;.*&#x27; excludes hidden files)</span><br><span class="line">  -m, --max-errors int         set the number of errors to allow before compilation fails early (default 10)</span><br><span class="line">  -s, --schema string          set schema file path or directory path</span><br><span class="line">  -S, --strict                 enable compiler strict mode</span><br></pre></td></tr></table></figure>

<h1 id="Policy-Testing"><a href="#Policy-Testing" class="headerlink" title="Policy Testing"></a>Policy Testing</h1><blockquote>
<p>To help you verify the <em>correctness</em> of your policies, OPA also gives you a <em>framework</em> that you can use to write <em>tests</em> for your policies.<br>By writing tests for your policies you can <em>speed up the development process of new rules</em> and <em>reduce the amount of time it takes to modify rules</em> as requirements evolve.</p>
</blockquote>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><blockquote>
<p>The file below implements a simple policy that allows new users to be created and users to access their own profile.</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>example.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">allow if &#123;</span><br><span class="line">    input.path == [&quot;users&quot;]</span><br><span class="line">    input.method == &quot;POST&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow if &#123;</span><br><span class="line">    input.path == [&quot;users&quot;, input.user_id]</span><br><span class="line">    input.method == &quot;GET&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>example_test.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">test_post_allowed if &#123;</span><br><span class="line">    allow with input as &#123;&quot;path&quot;: [&quot;users&quot;], &quot;method&quot;: &quot;POST&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_get_anonymous_denied if &#123;</span><br><span class="line">    not allow with input as &#123;&quot;path&quot;: [&quot;users&quot;], &quot;method&quot;: &quot;GET&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_get_user_allowed if &#123;</span><br><span class="line">    allow with input as &#123;&quot;path&quot;: [&quot;users&quot;, &quot;bob&quot;], &quot;method&quot;: &quot;GET&quot;, &quot;user_id&quot;: &quot;bob&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_get_another_user_denied if &#123;</span><br><span class="line">    not allow with input as &#123;&quot;path&quot;: [&quot;users&quot;, &quot;bob&quot;], &quot;method&quot;: &quot;GET&quot;, &quot;user_id&quot;: &quot;alice&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ls .</span><br><span class="line">example.rego  example_test.rego</span><br><span class="line"></span><br><span class="line">$ opa test . -v</span><br><span class="line">example_test.rego:</span><br><span class="line">data.authz.test_post_allowed: PASS (175.042µs)</span><br><span class="line">data.authz.test_get_anonymous_denied: PASS (247.084µs)</span><br><span class="line">data.authz.test_get_user_allowed: PASS (83µs)</span><br><span class="line">data.authz.test_get_another_user_denied: PASS (81.583µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 4/4</span><br></pre></td></tr></table></figure>

<blockquote>
<p>by removing the first rule in <strong>example.rego</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ opa test . -v</span><br><span class="line">FAILURES</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">data.authz.test_post_allowed: FAIL (110.459µs)</span><br><span class="line"></span><br><span class="line">  query:1                 Enter data.authz.test_post_allowed = _</span><br><span class="line">  example_test.rego:4     | Enter data.authz.test_post_allowed</span><br><span class="line">  example_test.rego:5     | | Fail data.authz.allow with input as &#123;&quot;method&quot;: &quot;POST&quot;, &quot;path&quot;: [&quot;users&quot;]&#125;</span><br><span class="line">  query:1                 | Fail data.authz.test_post_allowed = _</span><br><span class="line"></span><br><span class="line">SUMMARY</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">example_test.rego:</span><br><span class="line">data.authz.test_post_allowed: FAIL (110.459µs)</span><br><span class="line">data.authz.test_get_anonymous_denied: PASS (84.208µs)</span><br><span class="line">data.authz.test_get_user_allowed: PASS (119.458µs)</span><br><span class="line">data.authz.test_get_another_user_denied: PASS (69.209µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 3/4</span><br><span class="line">FAIL: 1/4</span><br></pre></td></tr></table></figure>

<h2 id="Test-Format"><a href="#Test-Format" class="headerlink" title="Test Format"></a>Test Format</h2><blockquote>
<p>Tests are expressed as <em>standard Rego rules</em> with a <em>convention</em> that the <em>rule name</em> is prefixed with <code>test_</code>.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package mypackage</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">test_some_descriptive_name if &#123;</span><br><span class="line">    # test logic</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Test-Discovery"><a href="#Test-Discovery" class="headerlink" title="Test Discovery"></a>Test Discovery</h2><ol>
<li>The <code>opa test</code> subcommand runs all of the tests (i.e., rules prefixed with <code>test_</code>) found in Rego files passed on the command line.</li>
<li>If <em>directories</em> are passed as <em>command line arguments</em>, <code>opa test</code> will load their file contents <em>recursively</em>.</li>
</ol>
<h2 id="Specifying-Tests-to-Run"><a href="#Specifying-Tests-to-Run" class="headerlink" title="Specifying Tests to Run"></a>Specifying Tests to Run</h2><blockquote>
<p>The opa test subcommand supports a <code>--run/-r</code> <em>regex</em> option to further specify which of the <em>discovered tests</em> should be evaluated. The option supports <em>re2 syntax</em></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ opa test . -v -r test_post_allowed</span><br><span class="line">example_test.rego:</span><br><span class="line">data.authz.test_post_allowed: PASS (166.75µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 1/1</span><br><span class="line"></span><br><span class="line">$ opa test . -v -r data.authz.test_post_allowed</span><br><span class="line">example_test.rego:</span><br><span class="line">data.authz.test_post_allowed: PASS (171.542µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 1/1</span><br></pre></td></tr></table></figure>

<h2 id="Test-Results"><a href="#Test-Results" class="headerlink" title="Test Results"></a>Test Results</h2><ol>
<li>If the test rule is <em>undefined</em> or generates a <em>non-true</em> value the test result is reported as <code>FAIL</code>. </li>
<li>If the test encounters a <em>runtime error</em> (e.g., a divide by zero condition) the test result is marked as an <code>ERROR</code>. </li>
<li>Tests prefixed with <code>todo_</code> will be reported as <code>SKIPPED</code>.</li>
<li>Otherwise, the test result is marked as <code>PASS</code>.</li>
</ol>
<figure class="highlight shell"><figcaption><span>pass_fail_error_test.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package example</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">allow if &#123;</span><br><span class="line">    input.path == [&quot;users&quot;]</span><br><span class="line">    input.method == &quot;POST&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow if &#123;</span><br><span class="line">    input.path == [&quot;users&quot;, input.user_id]</span><br><span class="line">    input.method == &quot;GET&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This <span class="built_in">test</span> will pass.</span></span><br><span class="line">test_ok if true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This <span class="built_in">test</span> will fail.</span></span><br><span class="line">test_failure if 1 == 2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This <span class="built_in">test</span> will error.</span></span><br><span class="line">test_error if 1 / 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This <span class="built_in">test</span> will be skipped.</span></span><br><span class="line">todo_test_missing_implementation if &#123;</span><br><span class="line">    allow with data.roles as [&quot;not&quot;, &quot;implemented&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ opa test pass_fail_error_test.rego</span><br><span class="line">pass_fail_error_test.rego:</span><br><span class="line">data.example.test_failure: FAIL (44.125µs)</span><br><span class="line">data.example.test_error: FAIL (47.417µs)</span><br><span class="line">data.example.todo_test_missing_implementation: SKIPPED</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 1/4</span><br><span class="line">FAIL: 2/4</span><br><span class="line">SKIPPED: 1/4</span><br></pre></td></tr></table></figure>

<blockquote>
<p>By default, OPA prints the test results in a <em>human-readable</em> format.<br>If you need to consume the test results <em>programmatically</em>, use the <em>JSON</em> output format.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ opa test --format=json pass_fail_error_test.rego</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pass_fail_error_test.rego&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;package&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data.example&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_ok&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">114708</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pass_fail_error_test.rego&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;package&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data.example&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_failure&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fail&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">46084</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pass_fail_error_test.rego&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;package&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data.example&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_error&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fail&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">45083</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pass_fail_error_test.rego&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;package&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data.example&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;todo_test_missing_implementation&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skip&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h2 id="Data-and-Function-Mocking"><a href="#Data-and-Function-Mocking" class="headerlink" title="Data and Function Mocking"></a>Data and Function Mocking</h2><blockquote>
<p>OPA’s <code>with</code> keyword can be used to <em>replace the data document</em> or <em>called functions with mocks</em>.<br>Both <em>base</em> and <em>virtual</em> documents can be <em>replaced</em>.</p>
</blockquote>
<blockquote>
<p>When replacing functions, built-in or otherwise, the following <em>constraints</em> are in place</p>
</blockquote>
<ol>
<li>Replacing <code>internal.*</code> functions, or <code>rego.metadata.*</code>, or <code>eq</code>; or relations (<code>walk</code>) is <em>not allowed</em>.</li>
<li>Replacement and <em>replaced function</em> need to have the <em>same arity</em>.</li>
<li>Replaced functions can call the functions they’re replacing, and those calls will call out to the original function, and <em>not cause recursion</em>.</li>
</ol>
<blockquote>
<p>Below is a simple policy that depends on the <em>data</em> document</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>authz.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">    some x in data.policies</span><br><span class="line">    x.name == &quot;test_policy&quot;</span><br><span class="line">    matches_role(input.role)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">matches_role(my_role) if input.user in data.roles[my_role]</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>authz_test.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">policies := [&#123;&quot;name&quot;: &quot;test_policy&quot;&#125;]</span><br><span class="line">roles := &#123;&quot;admin&quot;: [&quot;alice&quot;]&#125;</span><br><span class="line"></span><br><span class="line">test_allow_with_data if &#123;</span><br><span class="line">    allow with input as &#123;&quot;user&quot;: &quot;alice&quot;, &quot;role&quot;: &quot;admin&quot;&#125;</span><br><span class="line">          with data.policies as policies # [&#123;&quot;name&quot;: &quot;test_policy&quot;&#125;]</span><br><span class="line">          with data.roles as roles       # &#123;&quot;admin&quot;: [&quot;alice&quot;]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ opa test -v authz.rego authz_test.rego</span><br><span class="line">authz_test.rego:</span><br><span class="line">data.authz.test_allow_with_data: PASS (259.416µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 1/1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Below is an example to <em>replace</em> a <strong>rule without arguments</strong>.</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>authz.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">allow1 if allow2</span><br><span class="line"></span><br><span class="line">allow2 if 2 == 1</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>authz_test.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">test_replace_rule if &#123;</span><br><span class="line">    allow1 with allow2 as true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ opa test -v authz.rego authz_test.rego</span><br><span class="line">authz_test.rego:</span><br><span class="line">data.authz.test_replace_rule: PASS (176.75µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 1/1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Here is an example to <em>replace</em> a rule’s <strong>built-in function</strong> with a <em>user-defined function</em>.</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>authz.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">import data.jwks.cert</span><br><span class="line"></span><br><span class="line">allow if &#123;</span><br><span class="line">    [true, _, _] = io.jwt.decode_verify(input.headers[&quot;x-token&quot;], &#123;&quot;cert&quot;: cert, &quot;iss&quot;: &quot;corp.issuer.com&quot;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>authz_test.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">mock_decode_verify(&quot;my-jwt&quot;, _) := [true, &#123;&#125;, &#123;&#125;]</span><br><span class="line">mock_decode_verify(x, _)        := [false, &#123;&#125;, &#123;&#125;] if x != &quot;my-jwt&quot;</span><br><span class="line"></span><br><span class="line">test_allow if &#123;</span><br><span class="line">    allow</span><br><span class="line">      with input.headers[&quot;x-token&quot;] as &quot;my-jwt&quot;</span><br><span class="line">      with data.jwks.cert as &quot;mock-cert&quot;</span><br><span class="line">      with io.jwt.decode_verify as mock_decode_verify</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ opa test -v authz.rego authz_test.rego</span><br><span class="line">authz_test.rego:</span><br><span class="line">data.authz.test_allow: PASS (236.042µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 1/1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In simple cases, a <em>function</em> can also be replaced with a <em>value</em>, as in<br>Every <em>invocation</em> of the <em>function</em> will then return the <em>replacement value</em>, regardless of the function’s arguments.</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>authz_test.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">mock_decode_verify(&quot;my-jwt&quot;, _) := [true, &#123;&#125;, &#123;&#125;]</span><br><span class="line">mock_decode_verify(x, _)        := [false, &#123;&#125;, &#123;&#125;] if x != &quot;my-jwt&quot;</span><br><span class="line"></span><br><span class="line">test_allow if &#123;</span><br><span class="line">    allow</span><br><span class="line">      with input.headers[&quot;x-token&quot;] as &quot;my-jwt&quot;</span><br><span class="line">      with data.jwks.cert as &quot;mock-cert&quot;</span><br><span class="line">      with io.jwt.decode_verify as mock_decode_verify</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_allow_value if &#123;</span><br><span class="line">    allow</span><br><span class="line">      with input.headers[&quot;x-token&quot;] as &quot;my-jwt&quot;</span><br><span class="line">      with data.jwks.cert as &quot;mock-cert&quot;</span><br><span class="line">      with io.jwt.decode_verify as [true, &#123;&#125;, &#123;&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ opa test -v authz.rego authz_test.rego</span><br><span class="line">authz_test.rego:</span><br><span class="line">data.authz.test_allow: PASS (213.291µs)</span><br><span class="line">data.authz.test_allow_value: PASS (95.125µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 2/2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note that it’s also possible to replace one built-in function by another; or a <em>non-built-in function</em> by a <em>built-in</em> function.</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>authz.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">replace_rule if &#123;</span><br><span class="line">    replace(input.label)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">replace(label) if &#123;</span><br><span class="line">    label == &quot;test_label&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>authz_test.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package authz</span><br><span class="line">import future.keywords</span><br><span class="line"></span><br><span class="line">test_replace_rule if &#123;</span><br><span class="line">    replace_rule </span><br><span class="line">        with input.label as &quot;does-not-matter&quot;</span><br><span class="line">        with replace as true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ opa test -v authz.rego authz_test.rego</span><br><span class="line">authz_test.rego:</span><br><span class="line">data.authz.test_replace_rule: PASS (173.25µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 1/1</span><br></pre></td></tr></table></figure>

<h2 id="Coverage"><a href="#Coverage" class="headerlink" title="Coverage"></a>Coverage</h2><blockquote>
<p>In addition to reporting <em>pass</em>, <em>fail</em>, and <em>error</em> results for tests, <code>opa test</code> can also report <em>coverage</em> for the policies under test.</p>
</blockquote>
<blockquote>
<p>The coverage report includes all of the <em>lines</em> evaluated and not evaluated in the Rego files provided on the command line.<br>When a line is <em>not covered</em> it indicates one of two things</p>
</blockquote>
<ol>
<li>If the line refers to the <em>head</em> of a rule, the <em>body</em> of the rule was <em>never true</em>.</li>
<li>If the line refers to an <em>expression</em> in a rule, the expression was <em>never evaluated</em>.</li>
</ol>
<blockquote>
<p>It is also possible that <em>rule indexing</em> has determined <em>some path unnecessary for evaluation</em>, thereby <em>affecting</em> the lines reported as covered.</p>
</blockquote>
<blockquote>
<p>If we run the coverage report on the original <strong>example.rego</strong> file without <code>test_get_user_allowed</code> from <strong>example_test</strong>.rego.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">$ opa test --coverage --format=json example.rego example_test.rego</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;example.rego&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;covered&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;not_covered&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">11</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">11</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;not_covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coverage&quot;</span><span class="punctuation">:</span> <span class="number">66.65</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;example_test.rego&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;covered&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">16</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">17</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coverage&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;not_covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;coverage&quot;</span><span class="punctuation">:</span> <span class="number">83.35</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>add <code>test_get_user_allowed</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">$ opa test --coverage --format=json example.rego example_test.rego</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;example.rego&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;covered&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">11</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coverage&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;example_test.rego&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;covered&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">12</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">13</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">16</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">17</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coverage&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;not_covered_lines&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;coverage&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="Integrating-OPA"><a href="#Integrating-OPA" class="headerlink" title="Integrating OPA"></a>Integrating OPA</h1><blockquote>
<p>OPA exposes <em>domain-agnostic</em> APIs that your service can call to <em>manage</em> and <em>enforce</em> policies.</p>
</blockquote>
<blockquote>
<p>When integrating with OPA there are two interfaces to consider</p>
</blockquote>
<ol>
<li><strong>Evaluation</strong><ul>
<li>OPA’s interface for <em>asking for policy decisions</em>.</li>
<li>Integrating OPA is primarily focused on integrating an application, service, or tool with OPA’s <em>policy evaluation interface</em>.</li>
<li>This integration results in <em>policy decisions</em> being <em>decoupled</em> from that application, service, or tool.</li>
</ul>
</li>
<li><strong>Management</strong><ul>
<li>OPA’s interface for <em>deploying policies</em>, <em>understanding status</em>, <em>uploading logs</em>, and so on.</li>
<li>This integration is typically the <em>same across all OPA instances</em>, regardless what software the evaluation interface is integrated with.</li>
<li><em>Distributing policy</em>, <em>retrieving status</em>, and <em>storing logs</em> in the same way across all OPAs provides a <em>unified management plane</em> for policy across many different software systems.</li>
</ul>
</li>
</ol>
<blockquote>
<p>This page focuses predominantly on different ways to integrate with OPA’s <em>policy evaluation interface</em> and how they compare</p>
</blockquote>
<table>
<thead>
<tr>
<th>Management Interface</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>Bundle API</td>
<td>distributing policy and data to OPA</td>
</tr>
<tr>
<td>Status API</td>
<td>collecting status reports on bundle activation and agent health</td>
</tr>
<tr>
<td>Decision Log API</td>
<td>collecting a log of policy decisions made by agents</td>
</tr>
<tr>
<td>Health API</td>
<td>checking agent deployment readiness and health</td>
</tr>
<tr>
<td>Prometheus API endpoint</td>
<td>obtain insight into performance and errors</td>
</tr>
</tbody></table>
<h2 id="Evaluating-Policies"><a href="#Evaluating-Policies" class="headerlink" title="Evaluating Policies"></a>Evaluating Policies</h2><blockquote>
<p>OPA supports different ways to <em>evaluate policies</em>.</p>
</blockquote>
<ol>
<li>The <em>REST API</em> returns decisions as <em>JSON</em> over <em>HTTP</em>.</li>
<li>The <em>Go API</em> (GoDoc) returns decisions as <em>simple Go types</em> (bool, string, map[string]interface{}, etc.)</li>
<li>WebAssembly <em>compiles Rego policies into Wasm instructions</em> so they can be embedded and evaluated by any <em>WebAssembly runtime</em>.</li>
<li>Custom <em>compilers</em> and <em>evaluators</em> may be written to <em>parse evaluation plans</em> in the <em>low-level Intermediate Representation format</em>, which can be emitted by the <code>opa build</code> command</li>
<li>The <em>SDK</em> provides <em>high-level APIs</em> for obtaining the <em>output</em> of <em>query evaluation</em> as <em>simple Go types</em> (bool, string, map[string]interface{}, etc.)</li>
</ol>
<h3 id="Integrating-with-the-REST-API"><a href="#Integrating-with-the-REST-API" class="headerlink" title="Integrating with the REST API"></a>Integrating with the REST API</h3><ol>
<li>To integrate with OPA <em>outside of Go</em>, we recommend you deploy OPA as a <em>host-level daemon</em> or <em>sidecar container</em>.</li>
<li>When your application or service needs to make <em>policy decisions</em> it can query OPA locally via <em>HTTP</em>.</li>
<li>Running OPA <em>locally</em> on the <em>same host</em> as your application or service helps ensure <em>policy decisions</em> are <em>fast</em> and <em>highly-available</em>.</li>
</ol>
<h4 id="Named-Policy-Decisions"><a href="#Named-Policy-Decisions" class="headerlink" title="Named Policy Decisions"></a>Named Policy Decisions</h4><blockquote>
<p>Use the <em>Data API</em> to query OPA for <em>named policy decisions</em></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /v1/data/&lt;path&gt;</span><br><span class="line">Content-Type: application/json</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> &lt;the input document&gt;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>&lt;path&gt;</code> in the HTTP request identifies the policy decision to ask for. In OPA, <em>every rule generates a policy decision</em>.</p>
</blockquote>
<blockquote>
<p>In the example below there are two decisions: <code>example/authz/allow</code> and <code>example/authz/is_admin</code>.</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>authz.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package example.authz</span><br><span class="line"></span><br><span class="line">import future.keywords.if</span><br><span class="line">import future.keywords.in</span><br><span class="line"></span><br><span class="line">default allow := false</span><br><span class="line"></span><br><span class="line">allow if &#123;</span><br><span class="line">    input.method == &quot;GET&quot;</span><br><span class="line">    input.path == [&quot;salary&quot;, input.subject.user]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow if is_admin</span><br><span class="line"></span><br><span class="line">is_admin if &quot;admin&quot; in input.subject.groups</span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can request specific decisions by querying for <code>&lt;package path&gt;/&lt;rule name&gt;</code>. For example to request the <code>allow</code> decision execute the following HTTP request</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /v1/data/example/authz/allow</span><br><span class="line">Content-Type: application/json</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> &lt;the input document&gt;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The body of the request specifies the value of the <code>input</code> document to use during <em>policy evaluation</em>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v --location &#x27;127.1:8181/v1/data/example/authz/allow&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data &#x27;&#123;</span><br><span class="line">    &quot;input&quot;: &#123;</span><br><span class="line">        &quot;method&quot;: &quot;GET&quot;,</span><br><span class="line">        &quot;path&quot;: [</span><br><span class="line">            &quot;salary&quot;,</span><br><span class="line">            &quot;bob&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;subject&quot;: &#123;</span><br><span class="line">            &quot;user&quot;: &quot;bob&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line">*   Trying 127.0.0.1:8181...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8181 (#0)</span><br><span class="line">&gt; POST /v1/data/example/authz/allow HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:8181</span><br><span class="line">&gt; User-Agent: curl/7.88.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; Content-Type: application/json</span><br><span class="line">&gt; Content-Length: 175</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Type: application/json</span><br><span class="line">&lt; Vary: Accept-Encoding</span><br><span class="line">&lt; Date: Mon, 16 Oct 2022 10:19:27 GMT</span><br><span class="line">&lt; Content-Length: 16</span><br><span class="line">&lt;</span><br><span class="line">&#123;&quot;result&quot;:true&#125;</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>

<blockquote>
<p>OPA returns an HTTP <code>200</code> response code if the policy was <em>evaluated successfully</em>.<br><em>Non-HTTP 200</em> response codes indicate <em>configuration or runtime errors</em>.<br>The policy decision is contained in the <code>&quot;result&quot;</code> key of the response message body.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v --location &#x27;127.1:8181/v1/data/example/authz/allow&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data &#x27;&#123;</span><br><span class="line">    &quot;input&quot;: &#123;</span><br><span class="line">        &quot;subject&quot;: &#123;</span><br><span class="line">            &quot;user&quot;: &quot;bob&quot;,</span><br><span class="line">            &quot;groups&quot;: [</span><br><span class="line">                &quot;sales&quot;,</span><br><span class="line">                &quot;marketing&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line">*   Trying 127.0.0.1:8181...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8181 (#0)</span><br><span class="line">&gt; POST /v1/data/example/authz/allow HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:8181</span><br><span class="line">&gt; User-Agent: curl/7.88.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; Content-Type: application/json</span><br><span class="line">&gt; Content-Length: 173</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Type: application/json</span><br><span class="line">&lt; Vary: Accept-Encoding</span><br><span class="line">&lt; Date: Mon, 16 Oct 2022 10:23:20 GMT</span><br><span class="line">&lt; Content-Length: 17</span><br><span class="line">&lt;</span><br><span class="line">&#123;&quot;result&quot;:false&#125;</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If the requested policy decision is <em>undefined</em> OPA returns an HTTP <em>200</em> response without the <code>&quot;result&quot;</code> key.<br>For example, the following request for <code>is_admin</code> is <em>undefined</em> because there is <em>no default value</em> for <code>is_admin</code> and the input does not satisfy the <code>is_admin</code> rule body:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v --location &#x27;127.1:8181/v1/data/example/authz/is_admin&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data &#x27;&#123;</span><br><span class="line">    &quot;input&quot;: &#123;</span><br><span class="line">        &quot;subject&quot;: &#123;</span><br><span class="line">            &quot;user&quot;: &quot;bob&quot;,</span><br><span class="line">            &quot;groups&quot;: [</span><br><span class="line">                &quot;sales&quot;,</span><br><span class="line">                &quot;marketing&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line">*   Trying 127.0.0.1:8181...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8181 (#0)</span><br><span class="line">&gt; POST /v1/data/example/authz/is_admin HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:8181</span><br><span class="line">&gt; User-Agent: curl/7.88.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; Content-Type: application/json</span><br><span class="line">&gt; Content-Length: 173</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Type: application/json</span><br><span class="line">&lt; Vary: Accept-Encoding</span><br><span class="line">&lt; Date: Mon, 16 Oct 2022 10:25:38 GMT</span><br><span class="line">&lt; Content-Length: 3</span><br><span class="line">&lt;</span><br><span class="line">&#123;&#125;</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>

<h3 id="Integrating-with-the-Go-SDK"><a href="#Integrating-with-the-Go-SDK" class="headerlink" title="Integrating with the Go SDK"></a>Integrating with the Go SDK</h3><blockquote>
<p>The SDK package contains <em>high-level APIs</em> for <em>embedding OPA</em> inside of <em>Go programs</em> and obtaining the <em>output</em> of <em>query evaluation</em>.</p>
</blockquote>
<blockquote>
<p>A typical workflow when using the <code>sdk</code> package would involve first creating a new <code>sdk.OPA</code> object by calling <code>sdk.New</code> and then invoking its <code>Decision</code> method to fetch the policy decision. The <code>sdk.New</code> call takes the <code>sdk.Options</code> object as an input which allows specifying the OPA configuration, console logger, plugins, etc.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/open-policy-agent/opa/sdk&quot;</span></span><br><span class="line">    sdktest <span class="string">&quot;github.com/open-policy-agent/opa/sdk/test&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a mock HTTP bundle server</span></span><br><span class="line">    server, err := sdktest.NewServer(sdktest.MockBundle(<span class="string">&quot;/bundles/bundle.tar.gz&quot;</span>, <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;example.rego&quot;</span>: <span class="string">`</span></span><br><span class="line"><span class="string">                package authz</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                import future.keywords.if</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                default allow := false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                allow if input.open == &quot;sesame&quot;</span></span><br><span class="line"><span class="string">            `</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// handle error.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> server.Stop()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// provide the OPA configuration which specifies</span></span><br><span class="line">    <span class="comment">// fetching policy bundles from the mock server</span></span><br><span class="line">    <span class="comment">// and logging decisions locally to the console</span></span><br><span class="line">    config := []<span class="type">byte</span>(fmt.Sprintf(<span class="string">`&#123;</span></span><br><span class="line"><span class="string">        &quot;services&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;test&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;url&quot;: %q</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;bundles&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;test&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;resource&quot;: &quot;/bundles/bundle.tar.gz&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;decision_logs&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;console&quot;: true</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;`</span>, server.URL()))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create an instance of the OPA object</span></span><br><span class="line">    opa, err := sdk.New(ctx, sdk.Options&#123;</span><br><span class="line">        ID:     <span class="string">&quot;opa-test-1&quot;</span>,</span><br><span class="line">        Config: bytes.NewReader(config),</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// handle error.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> opa.Stop(ctx)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the named policy decision for the specified input</span></span><br><span class="line">    <span class="keyword">if</span> result, err := opa.Decision(ctx, sdk.DecisionOptions&#123;Path: <span class="string">&quot;/authz/allow&quot;</span>, Input: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;open&quot;</span>: <span class="string">&quot;sesame&quot;</span>&#125;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// handle error.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> decision, ok := result.Result.(<span class="type">bool</span>); !ok || !decision &#123;</span><br><span class="line">        <span class="comment">// handle error.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you executed this code, the output (i.e. <em>Decision Log event</em>) would be logged to the console by default.</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;bundles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;decision_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;160d789a-6da6-490c-9da0-58d3b8c92122&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;open&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sesame&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;opa-test-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.57.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;info&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metrics&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timer_rego_query_compile_ns&quot;</span><span class="punctuation">:</span> <span class="number">25208</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timer_rego_query_eval_ns&quot;</span><span class="punctuation">:</span> <span class="number">93292</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timer_rego_query_parse_ns&quot;</span><span class="punctuation">:</span> <span class="number">20792</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timer_sdk_decision_eval_ns&quot;</span><span class="punctuation">:</span> <span class="number">237500</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Decision Log&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/authz/allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-10-16T18:41:25+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-10-16T10:41:25.964008Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openpolicyagent.org/decision_logs&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Integrating-with-the-Go-API"><a href="#Integrating-with-the-Go-API" class="headerlink" title="Integrating with the Go API"></a>Integrating with the Go API</h3><blockquote>
<p>Use the <em>low-level</em> <a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/open-policy-agent/opa/rego">github.com&#x2F;open-policy-agent&#x2F;opa&#x2F;rego</a> package to <em>embed OPA</em> as a <em>library</em> inside services written in Go, when only policy <strong>evaluation</strong><br>and no other capabilities of OPA, like the management features — are desired.</p>
</blockquote>
<blockquote>
<p>If you’re unsure which one to use, the <em>SDK</em> is probably the <em>better</em> option.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/open-policy-agent/opa/rego&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The <code>rego</code> package exposes different options for <em>customizing how policies are evaluated</em>.<br>Through the <code>rego</code> package you can supply <em>policies</em> and <em>data</em>, enable <em>metrics</em> and <em>tracing</em>, toggle <em>optimizations</em>, etc. In most cases you will</p>
</blockquote>
<ol>
<li>Use the <code>rego</code> package to construct a <em>prepared query</em>.</li>
<li>Execute the prepared query to produce <em>policy decisions</em>.</li>
<li><em>Interpret</em> and <em>enforce</em> the policy decisions.</li>
</ol>
<blockquote>
<p>Preparing queries in advance avoids <em>parsing</em> and <em>compiling</em> the policies on each query and <em>improves performance</em> considerably.<br>Prepared queries are safe to <em>share across multiple Go routines</em>.</p>
</blockquote>
<h2 id="Comparison-1"><a href="#Comparison-1" class="headerlink" title="Comparison"></a>Comparison</h2><blockquote>
<p>A comparison of the different integration choices are summarized below.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Dimension</th>
<th><code>REST API</code> - sidecar</th>
<th>Go Lib</th>
<th>Wasm</th>
</tr>
</thead>
<tbody><tr>
<td>Evaluation</td>
<td>Fast</td>
<td>Faster</td>
<td>Fastest</td>
</tr>
<tr>
<td>Language</td>
<td>Any</td>
<td>Only Go</td>
<td>Any with Wasm</td>
</tr>
<tr>
<td>Operations</td>
<td>Update just OPA</td>
<td>Update entire service</td>
<td>Update service rarely</td>
</tr>
<tr>
<td>Security</td>
<td><em>Must secure API</em></td>
<td>Enable only what is needed</td>
<td>Enable only what is needed</td>
</tr>
</tbody></table>
<blockquote>
<p>REST API</p>
</blockquote>
<ol>
<li>Integrating OPA via the REST API is the <em>most common</em>, at the time of writing.</li>
<li>OPA is most often deployed either as a <em>sidecar</em> or less commonly as an external service.</li>
<li>Operationally this makes it <em>easy to upgrade OPA</em> and to configure it to use its <em>management services</em> (bundles, status, decision logs, etc.).</li>
<li>Because it is a separate process it requires <em>monitoring</em> and <em>logging</em> (though this happens automatically for any sidecar-aware environment like Kubernetes).</li>
<li>OPA’s configuration and APIs must be <em>secured</em> according to the security guide.</li>
</ol>
<blockquote>
<p>Go API</p>
</blockquote>
<ol>
<li>Integrating OPA via the Go API only works for Go software.</li>
<li>Updates to OPA require <em>re-vendoring</em> and <em>re-deploying</em> the software.</li>
<li>Evaluation has <em>less overhead</em> than the REST API because all the communication happens in the <em>same operating-system process</em>.</li>
<li>All of the <em>management functionality</em> (bundles, decision logs, etc.) must be either <em>enabled</em> or <em>implemented</em>.</li>
<li><em>Security concerns</em> are limited to those <em>management features</em> that are enabled or implemented.</li>
</ol>
<blockquote>
<p>Wasm</p>
</blockquote>
<ol>
<li>Wasm policies are <em>embeddable</em> in any programming language that has a <em>Wasm runtime</em>.</li>
<li>Evaluation has <em>less overhead</em> than the REST API (because it is evaluated in the <em>same operating-system process</em>)<ul>
<li>and should <em>outperform</em> the Go API (because the policies have been compiled to a <em>lower-level instruction</em> set).</li>
</ul>
</li>
<li><em>Each programming language</em> will need its own SDKs that implement the <em>management functionality</em> and the <em>evaluation interface</em>.</li>
<li>Typically new OPA language features will not require updating the service since neither the Wasm runtime nor the SDKs will be impacted.<ul>
<li>Updating the <em>SDKs</em> will require <em>re-deploying</em> the service.</li>
</ul>
</li>
<li>Security is analogous to the Go API integration: it is mainly the <em>management functionality</em> that presents <em>security risks</em>.</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/24/cloud-native-foundation-security-opa-core/">https://blog.zhongmingmao.top/2022/12/24/cloud-native-foundation-security-opa-core/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a><a class="post-meta__tags" href="/tags/opa/">OPA</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/25/cloud-native-foundation-security-opa-gatekeeper/" title="Security - OPA Gatekeeper"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-gatekeeper.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Security - OPA Gatekeeper</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/23/go-foundation-block-scope/" title="Go - Block + Scope"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/goscope.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Go - Block + Scope</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/12/27/cloud-native-foundation-security-opa-ops/" title="Security - OPA Operation"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-ops.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">Security - OPA Operation</div></div></a></div><div><a href="/2022/12/26/cloud-native-foundation-security-opa-management/" title="Security - OPA Management"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-management-7474053.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-26</div><div class="title">Security - OPA Management</div></div></a></div><div><a href="/2022/12/25/cloud-native-foundation-security-opa-gatekeeper/" title="Security - OPA Gatekeeper"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-gatekeeper.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-25</div><div class="title">Security - OPA Gatekeeper</div></div></a></div><div><a href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-11</div><div class="title">Kubernetes - Helm Doc</div></div></a></div><div><a href="/2023/02/02/cloud-native-foundation-k8s-security/" title="Kubernetes - Security"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-security.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-02</div><div class="title">Kubernetes - Security</div></div></a></div><div><a href="/2023/02/01/cloud-native-foundation-k8s-federation/" title="Kubernetes - Federation"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/federation.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">Kubernetes - Federation</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">541</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">172</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">72</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Glance"><span class="toc-number">1.</span> <span class="toc-text">Glance</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">2.1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rego"><span class="toc-number">2.2.</span> <span class="toc-text">Rego</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#References"><span class="toc-number">2.2.1.</span> <span class="toc-text">References</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expressions-AND"><span class="toc-number">2.2.2.</span> <span class="toc-text">Expressions - AND</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Variables"><span class="toc-number">2.2.3.</span> <span class="toc-text">Variables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Iteration"><span class="toc-number">2.2.4.</span> <span class="toc-text">Iteration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FOR-SOME"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">FOR SOME</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FOR-ALL"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">FOR ALL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rules"><span class="toc-number">2.2.5.</span> <span class="toc-text">Rules</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Complete-Rules"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">Complete Rules</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Partial-Rules"><span class="toc-number">2.2.5.2.</span> <span class="toc-text">Partial Rules</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Logical-OR"><span class="toc-number">2.2.5.3.</span> <span class="toc-text">Logical OR</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Putting-It-Together"><span class="toc-number">2.2.6.</span> <span class="toc-text">Putting It Together</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Running-OPA"><span class="toc-number">2.3.</span> <span class="toc-text">Running OPA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#opa-eval"><span class="toc-number">2.3.1.</span> <span class="toc-text">opa eval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#opa-run"><span class="toc-number">2.3.2.</span> <span class="toc-text">opa run</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#interactive"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">interactive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#server"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go-library"><span class="toc-number">2.3.3.</span> <span class="toc-text">go library</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Philosophy"><span class="toc-number">3.</span> <span class="toc-text">Philosophy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Policy-Decoupling"><span class="toc-number">3.1.</span> <span class="toc-text">Policy Decoupling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-OPA"><span class="toc-number">3.2.</span> <span class="toc-text">What is OPA?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-use-OPA"><span class="toc-number">3.3.</span> <span class="toc-text">Why use OPA?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Document-Model"><span class="toc-number">3.4.</span> <span class="toc-text">Document Model</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#External-Data"><span class="toc-number">4.</span> <span class="toc-text">External Data</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT-Tokens"><span class="toc-number">4.1.</span> <span class="toc-text">JWT Tokens</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow"><span class="toc-number">4.1.1.</span> <span class="toc-text">Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Updates"><span class="toc-number">4.1.2.</span> <span class="toc-text">Updates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Size-Limitations"><span class="toc-number">4.1.3.</span> <span class="toc-text">Size Limitations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security"><span class="toc-number">4.1.4.</span> <span class="toc-text">Security</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overload-input"><span class="toc-number">4.2.</span> <span class="toc-text">Overload input</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Updates-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">Updates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Size-Limitations-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">Size Limitations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security-1"><span class="toc-number">4.2.4.</span> <span class="toc-text">Security</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recommended-usage"><span class="toc-number">4.2.5.</span> <span class="toc-text">Recommended usage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bundle-API"><span class="toc-number">4.3.</span> <span class="toc-text">Bundle API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow-2"><span class="toc-number">4.3.1.</span> <span class="toc-text">Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Updates-2"><span class="toc-number">4.3.2.</span> <span class="toc-text">Updates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Size-limitations"><span class="toc-number">4.3.3.</span> <span class="toc-text">Size limitations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recommended-usage-1"><span class="toc-number">4.3.4.</span> <span class="toc-text">Recommended usage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Push-Data"><span class="toc-number">4.4.</span> <span class="toc-text">Push Data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow-3"><span class="toc-number">4.4.1.</span> <span class="toc-text">Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Updates-3"><span class="toc-number">4.4.2.</span> <span class="toc-text">Updates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Size-limitations-1"><span class="toc-number">4.4.3.</span> <span class="toc-text">Size limitations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recommended-usage-2"><span class="toc-number">4.4.4.</span> <span class="toc-text">Recommended usage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pull-Data-during-Evaluation"><span class="toc-number">4.5.</span> <span class="toc-text">Pull Data during Evaluation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Current-limitations"><span class="toc-number">4.5.1.</span> <span class="toc-text">Current limitations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow-4"><span class="toc-number">4.5.2.</span> <span class="toc-text">Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Updates-4"><span class="toc-number">4.5.3.</span> <span class="toc-text">Updates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Size-limitations-2"><span class="toc-number">4.5.4.</span> <span class="toc-text">Size limitations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Performance-and-Availability"><span class="toc-number">4.5.5.</span> <span class="toc-text">Performance and Availability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recommended-usage-3"><span class="toc-number">4.5.6.</span> <span class="toc-text">Recommended usage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">4.6.</span> <span class="toc-text">Summary</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Policy-Language"><span class="toc-number">5.</span> <span class="toc-text">Policy Language</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Rego"><span class="toc-number">5.1.</span> <span class="toc-text">What is Rego?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-use-Rego"><span class="toc-number">5.2.</span> <span class="toc-text">Why use Rego?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Basics"><span class="toc-number">5.3.</span> <span class="toc-text">The Basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scalar-Values"><span class="toc-number">5.4.</span> <span class="toc-text">Scalar Values</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Strings"><span class="toc-number">5.5.</span> <span class="toc-text">Strings</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Composite-Values"><span class="toc-number">5.6.</span> <span class="toc-text">Composite Values</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Objects"><span class="toc-number">5.6.1.</span> <span class="toc-text">Objects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sets"><span class="toc-number">5.6.2.</span> <span class="toc-text">Sets</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Variables-1"><span class="toc-number">5.7.</span> <span class="toc-text">Variables</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References-1"><span class="toc-number">5.8.</span> <span class="toc-text">References</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Variable-Keys"><span class="toc-number">5.8.1.</span> <span class="toc-text">Variable Keys</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Composite-Keys"><span class="toc-number">5.8.2.</span> <span class="toc-text">Composite Keys</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Multiple-Expressions"><span class="toc-number">5.8.3.</span> <span class="toc-text">Multiple Expressions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Self-Joins"><span class="toc-number">5.8.4.</span> <span class="toc-text">Self-Joins</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Comprehensions"><span class="toc-number">5.9.</span> <span class="toc-text">Comprehensions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Array-Comprehensions"><span class="toc-number">5.9.1.</span> <span class="toc-text">Array Comprehensions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-Comprehensions"><span class="toc-number">5.9.2.</span> <span class="toc-text">Object Comprehensions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Set-Comprehensions"><span class="toc-number">5.9.3.</span> <span class="toc-text">Set Comprehensions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rules-1"><span class="toc-number">5.10.</span> <span class="toc-text">Rules</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Generating-Sets"><span class="toc-number">5.10.1.</span> <span class="toc-text">Generating Sets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Generating-Objects"><span class="toc-number">5.10.2.</span> <span class="toc-text">Generating Objects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Incremental-Definitions"><span class="toc-number">5.10.3.</span> <span class="toc-text">Incremental Definitions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Complete-Definitions"><span class="toc-number">5.10.4.</span> <span class="toc-text">Complete Definitions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rule-Heads-containing-References"><span class="toc-number">5.10.5.</span> <span class="toc-text">Rule Heads containing References</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Variables-in-Rule-Head-References"><span class="toc-number">5.10.5.1.</span> <span class="toc-text">Variables in Rule Head References</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Example"><span class="toc-number">5.10.5.1.1.</span> <span class="toc-text">Example</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Conflicts"><span class="toc-number">5.10.5.1.2.</span> <span class="toc-text">Conflicts</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Functions"><span class="toc-number">5.10.6.</span> <span class="toc-text">Functions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Function-overloading"><span class="toc-number">5.10.6.1.</span> <span class="toc-text">Function overloading</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Negation"><span class="toc-number">5.11.</span> <span class="toc-text">Negation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Universal-Quantification-FOR-ALL"><span class="toc-number">5.12.</span> <span class="toc-text">Universal Quantification - FOR ALL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modules"><span class="toc-number">5.13.</span> <span class="toc-text">Modules</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Comments"><span class="toc-number">5.13.1.</span> <span class="toc-text">Comments</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Packages"><span class="toc-number">5.13.2.</span> <span class="toc-text">Packages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Imports"><span class="toc-number">5.13.3.</span> <span class="toc-text">Imports</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Future-Keywords"><span class="toc-number">5.14.</span> <span class="toc-text">Future Keywords</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#in"><span class="toc-number">5.14.1.</span> <span class="toc-text">in</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#every"><span class="toc-number">5.14.2.</span> <span class="toc-text">every</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#if"><span class="toc-number">5.14.3.</span> <span class="toc-text">if</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#contains"><span class="toc-number">5.14.4.</span> <span class="toc-text">contains</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Some-Keyword"><span class="toc-number">5.15.</span> <span class="toc-text">Some Keyword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Every-Keyword"><span class="toc-number">5.16.</span> <span class="toc-text">Every Keyword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#With-Keyword"><span class="toc-number">5.17.</span> <span class="toc-text">With Keyword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Default-Keyword"><span class="toc-number">5.18.</span> <span class="toc-text">Default Keyword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Else-Keyword"><span class="toc-number">5.19.</span> <span class="toc-text">Else Keyword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Operators"><span class="toc-number">5.20.</span> <span class="toc-text">Operators</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Membership-and-iteration-in"><span class="toc-number">5.20.1.</span> <span class="toc-text">Membership and iteration: in</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Equality-Assignment-Comparison-and-Unification"><span class="toc-number">5.20.2.</span> <span class="toc-text">Equality: Assignment, Comparison, and Unification</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Assignment"><span class="toc-number">5.20.2.1.</span> <span class="toc-text">Assignment :&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Comparison"><span class="toc-number">5.20.2.2.</span> <span class="toc-text">Comparison &#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Unification"><span class="toc-number">5.20.2.3.</span> <span class="toc-text">Unification &#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Best-Practices-for-Equality"><span class="toc-number">5.20.2.4.</span> <span class="toc-text">Best Practices for Equality</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Comparison-Operators"><span class="toc-number">5.20.3.</span> <span class="toc-text">Comparison Operators</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Built-in-Functions"><span class="toc-number">5.21.</span> <span class="toc-text">Built-in Functions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Errors"><span class="toc-number">5.21.1.</span> <span class="toc-text">Errors</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metadata"><span class="toc-number">5.22.</span> <span class="toc-text">Metadata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Strict-Mode"><span class="toc-number">5.23.</span> <span class="toc-text">Strict Mode</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Policy-Testing"><span class="toc-number">6.</span> <span class="toc-text">Policy Testing</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Getting-Started"><span class="toc-number">6.1.</span> <span class="toc-text">Getting Started</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-Format"><span class="toc-number">6.2.</span> <span class="toc-text">Test Format</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-Discovery"><span class="toc-number">6.3.</span> <span class="toc-text">Test Discovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Specifying-Tests-to-Run"><span class="toc-number">6.4.</span> <span class="toc-text">Specifying Tests to Run</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-Results"><span class="toc-number">6.5.</span> <span class="toc-text">Test Results</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Data-and-Function-Mocking"><span class="toc-number">6.6.</span> <span class="toc-text">Data and Function Mocking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coverage"><span class="toc-number">6.7.</span> <span class="toc-text">Coverage</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Integrating-OPA"><span class="toc-number">7.</span> <span class="toc-text">Integrating OPA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Evaluating-Policies"><span class="toc-number">7.1.</span> <span class="toc-text">Evaluating Policies</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Integrating-with-the-REST-API"><span class="toc-number">7.1.1.</span> <span class="toc-text">Integrating with the REST API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Named-Policy-Decisions"><span class="toc-number">7.1.1.1.</span> <span class="toc-text">Named Policy Decisions</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Integrating-with-the-Go-SDK"><span class="toc-number">7.1.2.</span> <span class="toc-text">Integrating with the Go SDK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Integrating-with-the-Go-API"><span class="toc-number">7.1.3.</span> <span class="toc-text">Integrating with the Go API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Comparison-1"><span class="toc-number">7.2.</span> <span class="toc-text">Comparison</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/08/02/rag-principle/" title="RAG -Principle"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/rag-principle-4736980.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RAG -Principle"/></a><div class="content"><a class="title" href="/2024/08/02/rag-principle/" title="RAG -Principle">RAG -Principle</a><time datetime="2024-08-01T16:06:25.000Z" title="Created 2024-08-02 00:06:25">2024-08-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/01/rag-ai-2/" title="RAG - AI 2.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://rag-1253868755.cos.ap-guangzhou.myqcloud.com/rag-ai-2.0.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RAG - AI 2.0"/></a><div class="content"><a class="title" href="/2024/08/01/rag-ai-2/" title="RAG - AI 2.0">RAG - AI 2.0</a><time datetime="2024-07-31T16:06:25.000Z" title="Created 2024-08-01 00:06:25">2024-08-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/10/llm-core-model-structure/" title="LLM Core - Model Structure"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/llm.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM Core - Model Structure"/></a><div class="content"><a class="title" href="/2024/07/10/llm-core-model-structure/" title="LLM Core - Model Structure">LLM Core - Model Structure</a><time datetime="2024-07-09T16:06:25.000Z" title="Created 2024-07-10 00:06:25">2024-07-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/09/llm-core-decoder-only/" title="LLM Core - Decoder Only"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/transformer-training.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM Core - Decoder Only"/></a><div class="content"><a class="title" href="/2024/07/09/llm-core-decoder-only/" title="LLM Core - Decoder Only">LLM Core - Decoder Only</a><time datetime="2024-07-08T16:06:25.000Z" title="Created 2024-07-09 00:06:25">2024-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/08/llm-core-transformer/" title="LLM Core - Transformer"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://llm-1253868755.cos.ap-guangzhou.myqcloud.com/llm-transformer.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM Core - Transformer"/></a><div class="content"><a class="title" href="/2024/07/08/llm-core-transformer/" title="LLM Core - Transformer">LLM Core - Transformer</a><time datetime="2024-07-07T16:06:25.000Z" title="Created 2024-07-08 00:06:25">2024-07-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2024 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
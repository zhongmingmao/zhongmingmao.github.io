<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Security - OPA Management | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Overview &amp; Architecture OPA exposes a set of APIs that enable unified, logically centralized policy management. Read this page if you are interested in how to build a control plane around OPA that">
<meta property="og:type" content="article">
<meta property="og:title" content="Security - OPA Management">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/26/cloud-native-foundation-security-opa-management/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="Overview &amp; Architecture OPA exposes a set of APIs that enable unified, logically centralized policy management. Read this page if you are interested in how to build a control plane around OPA that">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-management-7474053.png">
<meta property="article:published_time" content="2022-12-25T16:06:25.000Z">
<meta property="article:modified_time" content="2023-10-17T11:30:13.773Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Cloud Native Foundation">
<meta property="article:tag" content="OPA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-management-7474053.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Security - OPA Management",
  "url": "https://blog.zhongmingmao.top/2022/12/26/cloud-native-foundation-security-opa-management/",
  "image": "https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-management-7474053.png",
  "datePublished": "2022-12-25T16:06:25.000Z",
  "dateModified": "2023-10-17T11:30:13.773Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/26/cloud-native-foundation-security-opa-management/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Security - OPA Management',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">641</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-management-7474053.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Security - OPA Management</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Security - OPA Management</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-12-25T16:06:25.000Z" title="Created 2022-12-26 00:06:25">2022-12-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/opa/">OPA</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">4.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>26mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-10-17 19:30:13&quot;}" hidden></div><h1 id="Overview-Architecture"><a href="#Overview-Architecture" class="headerlink" title="Overview &amp; Architecture"></a>Overview &amp; Architecture</h1><ol>
<li>OPA exposes a set of APIs that enable <em>unified, logically centralized policy management</em>.</li>
<li>Read this page if you are interested in how to build a <em>control plane</em> around OPA that enables <em>policy distribution</em> and <em>collection of important telemetry data</em> like <em>decision logs</em>.</li>
</ol>
<span id="more"></span>

<blockquote>
<p>OPA enables <em>low-latency</em>, <em>highly-available</em> policy enforcement by providing a <em>lightweight engine</em> for distributed architectures.<br>By default, all of the <em>policy</em> and <em>data</em> that OPA uses to make decisions is kept <em>in-memory</em>.</p>
</blockquote>
<blockquote>
<p>Host-local Architecture</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231017101619626.png" alt="image-20231017101619626"></p>
<ol>
<li>OPA is designed to enable <em>distributed</em> policy enforcement.<ul>
<li>You can run OPA <em>next to</em> each and every service that needs to <em>offload policy decision-making</em>.</li>
</ul>
</li>
<li>By colocating OPA with the services that require decision-making, you ensure that policy decisions are rendered <em>as fast as possible</em> and <em>in a highly-available manner</em>.</li>
</ol>
<blockquote>
<p>Distributed Enforcement</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231017102021625.png" alt="image-20231017102021625"></p>
<blockquote>
<p>To <em>control</em> and <em>observe</em> a set of OPAs, <em>each OPA</em> can be configured to connect to <em>management APIs</em> that enable</p>
</blockquote>
<table>
<thead>
<tr>
<th>Management API</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>Bundles</td>
<td>Policy distribution</td>
</tr>
<tr>
<td>Decision Logs</td>
<td>Decision telemetry</td>
</tr>
<tr>
<td>Status</td>
<td>Agent telemetry</td>
</tr>
<tr>
<td>Discovery</td>
<td>Dynamic agent configuration</td>
</tr>
</tbody></table>
<blockquote>
<p>By configuring and implementing these management APIs you can unify <em>control</em> and <em>visibility</em> over OPAs in your environments.<br>OPA <em>does not</em> provide a <em>control plane</em> service <em>out-of-the-box</em> today.</p>
</blockquote>
<blockquote>
<p>Control Plane</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/image-20231017102614050.png" alt="image-20231017102614050"></p>
<h1 id="Bundles"><a href="#Bundles" class="headerlink" title="Bundles"></a>Bundles</h1><ol>
<li><p>OPA can <em>periodically</em> download bundles of <em>policy</em> and <em>data</em> from <em>remote HTTP servers</em>.</p>
<ul>
<li>The policies and data are <em>loaded on the fly</em> without requiring a <em>restart</em> of OPA.</li>
<li>Once the policies and data have been loaded, they are enforced <em>immediately</em>.<ul>
<li>Policies and data loaded from bundles are accessible via the standard OPA REST API.</li>
</ul>
</li>
</ul>
</li>
<li><p>Bundles provide an alternative to <em>pushing</em> policies into OPA via the REST APIs.</p>
</li>
<li><p>By default, the OPA REST APIs will prevent you from <em>modifying policy and data loaded via bundles</em>.</p>
</li>
</ol>
<h2 id="Bundle-build"><a href="#Bundle-build" class="headerlink" title="Bundle build"></a>Bundle build</h2><blockquote>
<p>The bundle will be named by default <code>bundle.tar.gz</code>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ls foo</span><br><span class="line">example.rego</span><br><span class="line"></span><br><span class="line">$ opa build -b foo</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">bundle.tar.gz  foo</span><br><span class="line"></span><br><span class="line">$ opa inspect bundle.tar.gz</span><br><span class="line">NAMESPACES:</span><br><span class="line">+--------------------+-------------------+</span><br><span class="line">|     NAMESPACE      |       FILE        |</span><br><span class="line">+--------------------+-------------------+</span><br><span class="line">| data               | /data.json        |</span><br><span class="line">| data.httpapi.authz | /foo/example.rego |</span><br><span class="line">+--------------------+-------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>More, you can <em>optimize</em> the bundle by specifying the <code>--optimize</code> or <code>-O</code> flag.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ opa build -b foo --optimize=1</span><br><span class="line">error: bundle optimizations require at least one entrypoint</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Finally, you can also <em>sign</em> your bundle with <code>opa build</code>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ opa build --verification-key /path/to/public_key.pem --signing-key /path/to/private_key.pem --bundle foo/</span><br></pre></td></tr></table></figure>

<h2 id="Bundle-Service-API"><a href="#Bundle-Service-API" class="headerlink" title="Bundle Service API"></a>Bundle Service API</h2><blockquote>
<p>OPA expects the service to <em>expose an API endpoint</em> that <em>serves bundles</em>.<br>The bundle API should allow clients to <em>download bundles</em> at an <em>arbitrary</em> URL.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;service path&gt;/&lt;resource&gt; HTTP/1.1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If the <em>bundle exists</em>, the server should respond with an <em>HTTP 200 OK</em> status followed by a <em>gzipped tarball</em> in the message body.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/gzip</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Enable <em>bundle downloading</em> via configuration.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">acmecorp</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://example.com/service/v1</span></span><br><span class="line">    <span class="attr">credentials:</span></span><br><span class="line">      <span class="attr">bearer:</span></span><br><span class="line">        <span class="attr">token:</span> <span class="string">&quot;bGFza2RqZmxha3NkamZsa2Fqc2Rsa2ZqYWtsc2RqZmtramRmYWxkc2tm&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bundles:</span></span><br><span class="line">  <span class="attr">authz:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">acmecorp</span></span><br><span class="line">    <span class="attr">resource:</span> <span class="string">somedir/bundle.tar.gz</span></span><br><span class="line">    <span class="attr">persist:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">polling:</span></span><br><span class="line">      <span class="attr">min_delay_seconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">max_delay_seconds:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">signing:</span></span><br><span class="line">      <span class="attr">keyid:</span> <span class="string">my_global_key</span></span><br><span class="line">      <span class="attr">scope:</span> <span class="string">read</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>OPA will fetch bundles from <code>https://example.com/service/v1/somedir/bundle.tar.gz</code>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://example.com/service/v1/somedir/bundle.tar.gz</span><br><span class="line">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">services[0].url                resource</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If the <code>bundles[_].resource</code> field is <em>not defined</em>, the value defaults to <code>bundles/&lt;name&gt;</code> where the <code>name</code> is the <em>key</em> value in the configuration.<br>For the example above this is <code>authz</code> and would default to <code>bundles/authz</code>.</p>
</blockquote>
<blockquote>
<p><em>Bundle names</em> can have any valid YAML characters in them, including <code>/</code>.<br>This can be useful when relying on default <code>resource</code> behavior with a name like <code>authz/bundle.tar.gz</code> which results in a <code>resource</code> of <code>bundles/authz/bundle.tar.gz</code>.</p>
</blockquote>
<blockquote>
<p>OPA can optionally <em>persist activated bundles to disk</em> for <em>recovery</em> purposes.</p>
</blockquote>
<ol>
<li>To enable persistence, set the <code>bundles[_].persist</code> field to <code>true</code>.</li>
<li>When bundle persistence is enabled, OPA will attempt to <em>read the bundle from disk on startup</em>.</li>
<li>This allows OPA to <em>start with the most recently activated bundle</em> in case <em>OPA</em> cannot communicate with the <em>bundle server</em>.<ul>
<li>OPA will try to <em>load and activate persisted bundles</em> on a best-effort basis.</li>
<li>Any <em>errors</em> encountered during the process will be surfaced in the <em>bundle’s status update</em>.</li>
</ul>
</li>
<li>When communication between <em>OPA</em> and the <em>bundle server</em> is <em>restored</em>, the <em>latest bundle</em> is <em>downloaded</em>, <em>activated</em>, and <em>persisted</em>.</li>
<li>By default, bundles are persisted under the <em>current working directory</em> of the OPA process<ul>
<li>(e.g., <code>./.opa/bundles/&lt;bundle-name&gt;/bundle.tar.gz</code>).</li>
</ul>
</li>
<li>The optional <code>bundles[_].signing</code> field can be used to specify the <code>keyid</code> and <code>scope</code> that should be used for <em>verifying the signature of the bundle</em>.</li>
</ol>
<h3 id="Caching"><a href="#Caching" class="headerlink" title="Caching"></a>Caching</h3><ol>
<li>Services implementing the <em>Bundle Service API</em> should set the HTTP <code>Etag</code> header in bundle responses to identify the <em>revision of the bundle</em>.</li>
<li>OPA will include the <code>Etag</code> value in the <code>If-None-Match</code> header of bundle requests.</li>
<li>Services can check the <code>If-None-Match</code> header and reply with HTTP <code>304 Not Modified</code> if the <em>bundle has not changed</em> since the last update.</li>
</ol>
<h3 id="HTTP-Long-Polling"><a href="#HTTP-Long-Polling" class="headerlink" title="HTTP Long Polling"></a>HTTP Long Polling</h3><blockquote>
<p>short polling</p>
</blockquote>
<ol>
<li>With the <em>periodic bundle downloading</em> (ie. <code>short polling</code>) technique, OPA sends <em>regular requests</em> to the remote HTTP server to pull any available bundle. </li>
<li>If there is <em>no new bundle</em>, the server responds with a <code>304 Not Modified</code> response.</li>
<li>The <em>polling frequency</em> depends on the <em>latency</em> that the client can <em>tolerate</em> in retrieving updated information from the server.</li>
<li>A <em>drawback</em> of this method is that if the <em>acceptable latency</em> is <em>low</em>, then the polling frequency could <em>add unnecessary burden</em> on the server and&#x2F;or network.</li>
</ol>
<blockquote>
<p>long polling</p>
</blockquote>
<ol>
<li>HTTP Long Polling helps to <em>minimize server&#x2F;network resource usage</em> and also <em>reduces the delay in delivery of updates to the client</em>.</li>
<li>When OPA sends a <em>long poll request</em> to the server, it <em>defers its response</em> until <em>an update is available</em> or <em>timeout has occurred</em>.<ul>
<li>In case of a timeout, the server responds with a <code>304 Not Modified</code> response.</li>
</ul>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">acmecorp</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://example.com/service/v1</span></span><br><span class="line">    <span class="attr">credentials:</span></span><br><span class="line">      <span class="attr">bearer:</span></span><br><span class="line">        <span class="attr">token:</span> <span class="string">&quot;bGFza2RqZmxha3NkamZsa2Fqc2Rsa2ZqYWtsc2RqZmtramRmYWxkc2tm&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bundles:</span></span><br><span class="line">  <span class="attr">authz:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">acmecorp</span></span><br><span class="line">    <span class="attr">resource:</span> <span class="string">somedir/bundle.tar.gz</span></span><br><span class="line">    <span class="attr">persist:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">polling:</span></span><br><span class="line">      <span class="attr">long_polling_timeout_seconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">signing:</span></span><br><span class="line">      <span class="attr">keyid:</span> <span class="string">my_global_key</span></span><br><span class="line">      <span class="attr">scope:</span> <span class="string">read</span></span><br></pre></td></tr></table></figure>

<ol>
<li>With the above configuration, OPA sends a <em>long poll request</em> to the server with a timeout set to <code>10</code> seconds.</li>
<li>If the server supports <code>long polling</code>, OPA expects the server to set the <code>Content-Type</code> header to <code>application/vnd.openpolicyagent.bundles</code>. </li>
<li>If the server does not support <code>long polling</code>, OPA will <em>fallback</em> to the <em>regular periodic polling</em>.</li>
</ol>
<h2 id="Bundle-File-Format"><a href="#Bundle-File-Format" class="headerlink" title="Bundle File Format"></a>Bundle File Format</h2><blockquote>
<p>Bundle files are <em>gzipped tarballs</em> that contain <em>policies</em> and <em>data</em>.<br>The <em>data files</em> in the bundle must be <em>organized hierarchically into directories</em> inside the tarball.<br>The hierarchical organization indicates to OPA where to load the data files into the the <em>data</em> Document.</p>
</blockquote>
<blockquote>
<p>You can list the content of a bundle with tar.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tar tzf bundle.tar.gz</span><br><span class="line">.manifest</span><br><span class="line">roles</span><br><span class="line">roles/bindings</span><br><span class="line">roles/bindings/data.json</span><br><span class="line">roles/permissions</span><br><span class="line">roles/permissions/data.json</span><br><span class="line">http</span><br><span class="line">http/example</span><br><span class="line">http/example/authz</span><br><span class="line">http/example/authz/authz.rego</span><br></pre></td></tr></table></figure>

<ol>
<li>The bundle contains <em>one policy file</em> (<code>authz.rego</code>) and <em>two data files</em> (<code>roles/bindings/data.json</code> and <code>roles/permissions/data.json</code>).</li>
<li>Bundle files may contain an optional <code>.manifest</code> file that stores bundle <em>metadata</em>.</li>
</ol>
<blockquote>
<p>Some important details for bundle files</p>
</blockquote>
<ol>
<li>OPA will only load data files named <code>data.json</code> or <code>data.yaml</code> (which contain JSON or YAML respectively). Other JSON and YAML files will be <em>ignored</em>.</li>
<li>The <code>*.rego</code> policy files must be <em>valid Modules</em></li>
</ol>
<blockquote>
<p><em>YAML data</em> loaded into OPA is <em>converted to JSON</em>.<br>Since <em>JSON is a subset of YAML</em>, you are <em>not allowed</em> to use <em>binary</em> or <em>null keys</em> in <em>objects</em> and <em>boolean</em> and <em>number keys</em> are converted to <em>strings</em>.<br>Also, YAML !!<em>binary tags</em> are <em>not supported</em>.</p>
</blockquote>
<h2 id="Multiple-Sources-of-Policy-and-Data"><a href="#Multiple-Sources-of-Policy-and-Data" class="headerlink" title="Multiple Sources of Policy and Data"></a>Multiple Sources of Policy and Data</h2><ol>
<li>By default, when OPA is configured to download <em>policy</em> and <em>data</em> from a <em>bundle service</em>, the <em>entire content</em> of OPA’s policy and data <em>cache</em> is defined by the bundle.</li>
<li>However, if you need to load OPA with policy and data from <em>multiple sources</em><ul>
<li>you can implement your bundle service to <em>generate bundles</em> that are <em>scoped</em> to a <em>subset</em> of OPA’s policy and data cache.</li>
</ul>
</li>
</ol>
<blockquote>
<p>We recommend that whenever possible, you implement policy and data aggregation <em>centrally</em>, however, in some cases that’s not possible (e.g., due to latency requirements.).<br>When using <em>multiple sources</em> there are <em>no ordering guarantees</em> for <em>which bundle loads first and takes over some root</em>.<br>If multiple bundles <em>conflict</em>, but are <em>loaded at different times</em>, OPA may go into an <em>error state</em>.<br>It is highly recommended to use the <em>health check</em> and <em>include bundle state</em></p>
</blockquote>
<ol>
<li>To scope <em>bundles</em> to a <em>subset</em> of OPA’s policy and data cache</li>
<li>include a top-level <code>roots</code> key in the <em>bundle</em> that defines the <em>roots</em> of the <code>data</code> namespace that are <em>owned by the bundle</em>.</li>
</ol>
<blockquote>
<p>For example, the following <em>manifest</em> would declare two roots (<code>acmecorp/policy</code> and <code>acmecorp/oncall</code>):</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;acmecorp/policy&quot;</span><span class="punctuation">,</span> <span class="string">&quot;acmecorp/oncall&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>If OPA was loaded with a bundle containing this <em>manifest</em> it would <em>only erase and overwrite</em> policy and data <em>under</em> these roots.</li>
<li>Policy and data loaded <em>under other roots</em> is <em>left intact</em>.</li>
</ol>
<blockquote>
<p>When OPA loads <em>scoped bundles</em>, it <em>validates</em> that</p>
</blockquote>
<ol>
<li>The <em>roots</em> are <em>not overlapping</em> (e.g., <code>a/b/c</code> and <code>a/b</code> are overlapped and will result in an error.)<ul>
<li>Note: This is <em>not</em> enforced <em>across multiple bundles</em>. Only <em>within the same bundle manifest</em>.</li>
</ul>
</li>
<li>The policies in the bundle are <em>contained under the roots</em>.<ul>
<li>This is determined by inspecting the <code>package</code> statement in each of the <em>policy</em> files.</li>
<li>For example, given the <em>manifest</em> above<ul>
<li>it would be an error to include a policy file containing <code>package acmecorp.other</code> because <code>acmecorp.other</code> is not contained in either of the roots.</li>
</ul>
</li>
</ul>
</li>
<li>The <em>data</em> in the bundle is <em>contained under the roots</em>.</li>
</ol>
<blockquote>
<p>If <em>bundle validation fails</em>, OPA will report the <em>validation error</em> via the <em>Status API</em>.</p>
</blockquote>
<h2 id="Debugging-Your-Bundles"><a href="#Debugging-Your-Bundles" class="headerlink" title="Debugging Your Bundles"></a>Debugging Your Bundles</h2><blockquote>
<p>When you run OPA, you can provide bundle files over the command line.<br>This allows you to <em>manually check</em> that your bundles include all of the files that you intended and that they are <em>structured correctly</em>.</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>foo/example.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package httpapi.authz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bob is alice<span class="string">&#x27;s manager, and betty is charlie&#x27;</span>s.</span></span><br><span class="line">subordinates := &#123;&quot;alice&quot;: [], &quot;charlie&quot;: [], &quot;bob&quot;: [&quot;alice&quot;], &quot;betty&quot;: [&quot;charlie&quot;]&#125;</span><br><span class="line"></span><br><span class="line">default allow := false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow <span class="built_in">users</span> to get their own salaries.</span></span><br><span class="line">allow &#123;</span><br><span class="line">    input.method == &quot;GET&quot;</span><br><span class="line">    input.path == [&quot;finance&quot;, &quot;salary&quot;, input.user]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow managers to get their subordinates<span class="string">&#x27; salaries.</span></span></span><br><span class="line">allow &#123;</span><br><span class="line">    some username</span><br><span class="line">    input.method == &quot;GET&quot;</span><br><span class="line">    input.path = [&quot;finance&quot;, &quot;salary&quot;, username]</span><br><span class="line">    subordinates[input.user][_] == username</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ ls foo</span><br><span class="line">example.rego</span><br><span class="line"></span><br><span class="line">$ opa build -b foo</span><br><span class="line"></span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── bundle.tar.gz</span><br><span class="line">└── foo</span><br><span class="line">    └── example.rego</span><br><span class="line">    </span><br><span class="line">$ opa run bundle.tar.gz</span><br><span class="line">&gt; input</span><br><span class="line">undefined</span><br><span class="line">&gt;</span><br><span class="line">&gt; data</span><br><span class="line">&#123;</span><br><span class="line">  &quot;httpapi&quot;: &#123;</span><br><span class="line">    &quot;authz&quot;: &#123;</span><br><span class="line">      &quot;allow&quot;: false,</span><br><span class="line">      &quot;subordinates&quot;: &#123;</span><br><span class="line">        &quot;alice&quot;: [],</span><br><span class="line">        &quot;betty&quot;: [</span><br><span class="line">          &quot;charlie&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;bob&quot;: [</span><br><span class="line">          &quot;alice&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;charlie&quot;: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<h2 id="Signing"><a href="#Signing" class="headerlink" title="Signing"></a>Signing</h2><ol>
<li>To ensure the <em>integrity</em> of <em>policies</em> (ie. the policies are coming from a <em>trusted source</em>)<ul>
<li>policy bundles may be <em>digitally signed</em> so that industry-standard cryptographic primitives can <em>verify</em> their <em>authenticity</em>.</li>
</ul>
</li>
<li>OPA supports <em>digital signatures</em> for <em>policy bundles</em>.<ul>
<li>Specifically, a <em>signed bundle</em> is a normal OPA bundle that includes a file named <code>.signatures.json</code> that dictates <em>which files should be included in the bundle</em>, what their <em>SHA</em> hashes are, and of course is <em>cryptographically secure</em>.</li>
</ul>
</li>
<li>When <em>OPA receives a new bundle</em>, it checks that it has been <em>properly signed</em> using <em>a (public) key</em> that OPA has been configured with <em>out-of-band</em>.<ul>
<li>Only if that <em>verification succeeds</em> does OPA <em>activate</em> the <em>new bundle</em></li>
<li>otherwise, OPA <em>continues using its existing bundle</em> and reports an <em>activation failure</em> via the <em>status API</em> and <em>error logging</em>.</li>
</ul>
</li>
</ol>
<blockquote>
<p><code>opa run</code> performs <em>bundle signature verification</em> only when the <code>-b</code>&#x2F;<code>--bundle</code> flag is given or when <em>Bundle downloading is enabled</em>.<br>Sub-commands primarily used in <em>development</em> and <em>debug</em> environments (such as <code>opa eval</code>, <code>opa test</code>, etc.) <em>DO NOT verify bundle signatures</em> at this point in time.</p>
</blockquote>
<h2 id="Delta-Bundles"><a href="#Delta-Bundles" class="headerlink" title="Delta Bundles"></a>Delta Bundles</h2><blockquote>
<p><em>Snapshot</em> bundle</p>
</blockquote>
<ol>
<li>A regular <em>snapshot</em> bundle represents the <em>entirety</em> of OPA’s policy and data cache.</li>
<li>When a new <em>snapshot</em> bundle is <em>downloaded</em>, OPA will <em>erase and overwrite all the policy and data</em> in its cache before <em>activating the new bundle</em>.</li>
<li>We can optionally scope the <em>bundle</em> to <em>a subset of OPA’s policy and data cache</em> by defining the <code>roots</code> in the bundle’s <code>.manifest</code> file.</li>
</ol>
<blockquote>
<p>retransmission</p>
</blockquote>
<ol>
<li>Although OPA <em>caches snapshot bundles</em> to <em>avoid unnecessary retransmission</em>, servers must still <em>retransmit the entire snapshot</em> when <em>any change occurs</em>.</li>
<li>If you need to <em>propagate small changes to bundles</em> without waiting for polling delays, consider using <em>delta bundles</em> in conjunction with <em>HTTP Long Polling</em>.</li>
</ol>
<blockquote>
<p><em>Delta</em> bundles</p>
</blockquote>
<ol>
<li><em>Delta</em> bundles provide a <em>more efficient way</em> to make data changes by <em>containing patches to data</em> instead of <em>complete snapshots</em>.</li>
<li><em>Delta</em> bundles are <em>structured differently</em> from <em>snapshot</em> bundles. <ul>
<li>A delta bundle contains a single <code>patch.json</code> file at the <em>root</em> of the bundle which includes a <em>JSON Patch</em> (i.e., an array of one or more JSON objects).</li>
<li>The <em>operations</em> in the <em>JSON Patch</em> will be applied to OPA’s <em>in-memory</em> store <em>in order</em>.</li>
</ul>
</li>
</ol>
<blockquote>
<p><em>Delta</em> bundles currently <em>support updates to data only and not policies</em>.</p>
</blockquote>
<h2 id="Implementations"><a href="#Implementations" class="headerlink" title="Implementations"></a>Implementations</h2><blockquote>
<p>The Bundle API is simple. Most <em>HTTP servers</em> capable of <em>serving static files</em> will do.<br>While <em>not strictly required</em> in all deployments, it is also good if the implementation supports</p>
</blockquote>
<ol>
<li>HTTP caching using the <code>ETag</code> header.<ul>
<li>This keeps <em>OPA</em> from having to download a bundle unless the bundle’s content <em>have changes</em>.</li>
</ul>
</li>
<li>Authentication<ul>
<li>When exposing a bundle at a <em>remote endpoint</em>, it is often desirable to <em>protect the data</em> by requiring all requests to the endpoint to be authenticated.</li>
</ul>
</li>
</ol>
<h1 id="Decision-Logs"><a href="#Decision-Logs" class="headerlink" title="Decision Logs"></a>Decision Logs</h1><ol>
<li>OPA can <em>periodically</em> report decision logs to <em>remote HTTP servers</em>, using <em>custom plugins</em>, or to the <em>console output</em>; or any combination thereof.</li>
<li>The decision logs contain <em>events</em> that <em>describe policy queries</em>.</li>
<li>Each event includes the <em>policy</em> that was queried, the <em>input</em> to the query, <em>bundle metadata</em>, and other information that enables <em>auditing</em> and <em>offline debugging</em> of policy decisions.</li>
<li>When <em>decision logging</em> is enabled the OPA server will include a <code>decision_id</code> field in API calls that <em>return policy decisions</em>.</li>
</ol>
<h2 id="Decision-Log-Service-API"><a href="#Decision-Log-Service-API" class="headerlink" title="Decision Log Service API"></a>Decision Log Service API</h2><blockquote>
<p>OPA expects the service to <em>expose an API endpoint</em> that will <em>receive decision logs</em>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /[&lt;decision_logs.resource&gt;] HTTP/1.1</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Type: application/json</span><br></pre></td></tr></table></figure>

<ol>
<li>The <em>resource</em> field is an <em>optional</em> configuration that can be used to <em>route logs to a specific endpoint</em> in the service by defining the <em>full path</em>.<ul>
<li>If the resource path is not configured on the agent, updates will be sent to <code>/logs</code>.</li>
</ul>
</li>
<li>The message body contains a <em>gzip compressed JSON array</em>.<ul>
<li>Each <em>array element</em> (<em>event</em>) represents a <em>policy decision</em> returned by OPA.</li>
</ul>
</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my-example-app&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1780d507-aea2-45cc-ae50-fa153c8e4a5a&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v0.57.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;decision_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4ca636c1-55e4-417a-b1d8-4aceb67960d1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bundles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;authz&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;revision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;W3sibCI6InN5cy9jYXRhbG9nIiwicyI6NDA3MX1d&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http/example/authz/allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/salary/bob&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requested_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[::1]:59943&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2018-01-01T00:00:00.000000Z&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Decision log updates contain the following fields</p>
</blockquote>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>[_].labels</code></td>
<td>object</td>
<td>Set of <em>key-value</em> pairs that uniquely identify the <em>OPA instance</em>.</td>
</tr>
<tr>
<td><code>[_].decision_id</code></td>
<td>string</td>
<td>Unique identifier generated for <em>each decision</em> for <em>traceability</em>.</td>
</tr>
<tr>
<td><code>[_].trace_id</code></td>
<td>string</td>
<td>Unique identifier of a trace generated for <em>each incoming request</em> for <em>traceability</em>.<br />This is a <em>hex</em> string representation compliant with the W3C trace-context specification.</td>
</tr>
<tr>
<td><code>[_].span_id</code></td>
<td>string</td>
<td>Unique identifier of a span in a trace to assist <em>traceability</em>.<br />This is a <em>hex</em> string representation compliant with the W3C trace-context specification.</td>
</tr>
<tr>
<td><code>[_].bundles</code></td>
<td>object</td>
<td>Set of <em>key-value</em> pairs describing the bundles which <em>contained policy</em> used to <em>produce the decision</em>.</td>
</tr>
<tr>
<td><code>[_].bundles[_].revision</code></td>
<td>string</td>
<td>Revision of the bundle at the time of evaluation.</td>
</tr>
<tr>
<td><code>[_].path</code></td>
<td>string</td>
<td><em>Hierarchical policy decision path</em>, e.g., <code>/http/example/authz/allow</code>.<br />Receivers should tolerate <em>slash-prefixed</em> paths.</td>
</tr>
<tr>
<td><code>[_].query</code></td>
<td>string</td>
<td>Ad-hoc <em>Rego query</em> received by Query API.</td>
</tr>
<tr>
<td><code>[_].input</code></td>
<td>any</td>
<td>Input data provided in the <code>policy query</code>.</td>
</tr>
<tr>
<td><code>[_].result</code></td>
<td>any</td>
<td><em>Policy decision</em> returned to the client, e.g., <code>true</code> or <code>false</code>.</td>
</tr>
<tr>
<td><code>[_].requested_by</code></td>
<td>string</td>
<td>Identifier for client that executed policy query, e.g., the client address.</td>
</tr>
<tr>
<td><code>[_].timestamp</code></td>
<td>string</td>
<td>RFC3999 timestamp of policy decision.</td>
</tr>
<tr>
<td><code>[_].metrics</code></td>
<td>object</td>
<td><em>Key-value</em> pairs of <em>performance metrics</em>.</td>
</tr>
<tr>
<td><code>[_].erased</code></td>
<td>array[string]</td>
<td>Set of <em>JSON Pointers</em> specifying fields in the event that were <em>erased</em>.</td>
</tr>
<tr>
<td><code>[_].masked</code></td>
<td>array[string]</td>
<td>Set of <em>JSON Pointers</em> specifying fields in the event that were <em>masked</em>.</td>
</tr>
<tr>
<td><code>[_].nd_builtin_cache</code></td>
<td>object</td>
<td>Key-value pairs of non-deterministic builtin names, paired with objects specifying the input&#x2F;output mappings for each unique invocation of that builtin during policy evaluation.<br />Intended for use in <em>debugging</em> and <em>decision replay</em>.<br />Receivers will need to decode the JSON using Rego’s JSON decoders.</td>
</tr>
<tr>
<td><code>[_].req_id</code></td>
<td>number</td>
<td><em>Incremental</em> request identifier, and <em>unique</em> only to the <em>OPA instance</em>, for the request that started the policy query.<br />The attribute value is the <em>same</em> as the value present in others logs (<em>request</em>, <em>response</em>, and <em>print</em>) and could be used to <em>correlate</em> them all.<br />This attribute will be included just when OPA runtime is initialized in <em>server mode</em> and the log level is <em>equal to or greater than info</em>.</td>
</tr>
</tbody></table>
<ol>
<li>If the decision log was <em>successfully uploaded to the remote service</em>, it should respond with an HTTP <em>2xx</em> status.</li>
<li>If the service responds with a <em>non-2xx</em> status, OPA will <em>requeue the last chunk containing decision log events</em> and upload it during the <em>next upload event</em>.</li>
<li><em>OPA</em> also performs an <em>exponential backoff</em> to calculate the delay in <em>uploading the next chunk</em> when the remote service responds with a <em>non-2xx</em> status.</li>
<li>OPA <em>periodically</em> uploads decision logs to the remote service.<ul>
<li>In order to conserve <em>network</em> and <em>memory</em> resources<ul>
<li>OPA attempts to <em>fill up each upload chunk</em> with <em>as many events as possible</em> while respecting the user-specified <code>upload_size_limit_bytes</code> config option.</li>
</ul>
</li>
<li>OPA defines an <em>adaptive</em> (<code>soft</code>) <em>limit</em> that acts as a measure for <em>encoding as many decisions into each chunk as possible</em>.</li>
</ul>
</li>
</ol>
<h2 id="Local-Decision-Logs"><a href="#Local-Decision-Logs" class="headerlink" title="Local Decision Logs"></a>Local Decision Logs</h2><blockquote>
<p>Local console logging of decisions can be enabled via the <code>console</code> config option. This does not require any remote server.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">decision_logs:</span></span><br><span class="line">    <span class="attr">console:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>This will dump <em>all decisions</em> to the console.</p>
</blockquote>
<h2 id="Masking-Sensitive-Data"><a href="#Masking-Sensitive-Data" class="headerlink" title="Masking Sensitive Data"></a>Masking Sensitive Data</h2><blockquote>
<p>Policy queries may contain sensitive information in the <code>input</code> document that must be <em>removed</em> or <em>modified</em> before decision logs are uploaded to the remote API (e.g., usernames, passwords, etc.) Similarly, parts of the <em>policy decision itself</em> may be considered sensitive.</p>
</blockquote>
<ol>
<li>By default, OPA queries the <code>data.system.log.mask</code> path <em>prior to</em> encoding and uploading decision logs or calling custom decision log plugins.</li>
<li>OPA provides the <em>decision log event</em> as <em>input</em> to the policy query and expects the query to return a set of <em>JSON Pointers</em> that refer to <em>fields in the decision log event</em> to either <strong>erase</strong> or <strong>modify</strong>.</li>
</ol>
<h2 id="Drop-Decision-Logs"><a href="#Drop-Decision-Logs" class="headerlink" title="Drop Decision Logs"></a>Drop Decision Logs</h2><blockquote>
<p><em>Drop rules</em> filters all <em>decisions from logging</em> where the rule evaluates to <code>true</code>.</p>
</blockquote>
<h2 id="Rate-Limiting-Decision-Logs"><a href="#Rate-Limiting-Decision-Logs" class="headerlink" title="Rate Limiting Decision Logs"></a>Rate Limiting Decision Logs</h2><ol>
<li>There are scenarios where OPA may be <em>uploading</em> decisions <em>faster</em> than what the remote service is able to <em>consume</em>.</li>
<li>Although <em>OPA</em> provides a user-specified <em>buffer size limit</em> in bytes<ul>
<li>it may be <em>difficult to determine</em> the ideal buffer size that will allow the service to consume logs without being overwhelmed.</li>
</ul>
</li>
<li>The <code>max_decisions_per_second</code> config option allows users to set the <em>maximum number of decision log events</em> to buffer per <em>second</em>.<ul>
<li>OPA will <em>drop events</em> if the rate limit is exceeded.</li>
</ul>
</li>
<li>This option provides users more control over <em>how OPA buffers log events</em> and is an effective mechanism to make sure the service can successfully process incoming log events.</li>
</ol>
<h1 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h1><ol>
<li>OPA can <em>periodically</em> report <em>status updates</em> to <em>remote HTTP servers</em>.<ul>
<li>The updates contain status information for <em>OPA itself</em> as well as the <em>Bundles that have been downloaded and activated</em>.</li>
</ul>
</li>
<li>OPA <em>sends status reports</em> whenever one of the following happens<ul>
<li><em>Bundles</em> are <em>downloaded</em> and <em>activated</em><ul>
<li>If the bundle <em>download</em> or <em>activation fails</em> for any reason, the status update will include error information describing the <em>failure</em>. This includes <em>Discovery bundles</em>.</li>
</ul>
</li>
<li>A <em>plugin state</em> has changed<ul>
<li><em>All plugin status</em> is reported, and an update to <em>any plugin</em> will trigger a Status API report which contains the <em>latest state</em>.</li>
</ul>
</li>
</ul>
</li>
<li>The status updates will include a set of <em>labels</em> that uniquely identify the <em>OPA instance</em>.<ul>
<li>OPA automatically includes an <code>id</code> value in the <em>label set</em> that provides a <em>globally unique identifier</em> or the running OPA instance and a <code>version</code> value that provides the version of OPA.</li>
</ul>
</li>
</ol>
<h2 id="Status-Service-API"><a href="#Status-Service-API" class="headerlink" title="Status Service API"></a>Status Service API</h2><blockquote>
<p>OPA expects the service to <em>expose an API endpoint</em> that will <em>receive status updates</em>.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /status[/&lt;partition_name&gt;] HTTP/1.1</span><br><span class="line">Content-Type: application/json</span><br></pre></td></tr></table></figure>

<ol>
<li>The <em>partition name</em> is an <em>optional</em> path segment that can be used to <em>route status updates to different backends</em>.</li>
<li>If the partition name is not configured on the agent, updates will be sent to <code>/status</code>.</li>
</ol>
<blockquote>
<p>Status updates contain the following fields:</p>
</blockquote>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>labels</code></td>
<td>object</td>
<td>Set of <em>key-value</em> pairs that uniquely identify the <em>OPA instance</em>.</td>
</tr>
<tr>
<td><code>bundles</code></td>
<td>object</td>
<td>Set of objects describing the <em>status</em> for each bundle configured with OPA.</td>
</tr>
<tr>
<td><code>bundles[_].name</code></td>
<td>string</td>
<td>Name of bundle that the OPA instance is configured to download.</td>
</tr>
<tr>
<td><code>bundles[_].active_revision</code></td>
<td>string</td>
<td>Opaque revision identifier of the <em>last successful activation</em>.</td>
</tr>
<tr>
<td><code>bundles[_].last_request</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last bundle request</em>.<br />This timestamp should be &gt;&#x3D; to the <em>successful request timestamp</em> in normal operation.</td>
</tr>
<tr>
<td><code>bundles[_].last_successful_request</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last successful bundle request</em>.<br />This timestamp should be &gt;&#x3D; to the <em>successful download timestamp</em> in normal operation.</td>
</tr>
<tr>
<td><code>bundles[_].last_successful_download</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last successful bundle download</em>.</td>
</tr>
<tr>
<td><code>bundles[_].last_successful_activation</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last successful bundle activation</em>.</td>
</tr>
<tr>
<td><code>bundles[_].metrics</code></td>
<td>object</td>
<td><em>Metrics from the last update of the bundle</em>.</td>
</tr>
<tr>
<td><code>bundles[_].code</code></td>
<td>string</td>
<td>If present, indicates <em>error</em>(s) occurred <em>activating</em> this bundle.</td>
</tr>
<tr>
<td><code>bundles[_].message</code></td>
<td>string</td>
<td>Human readable messages describing the <em>error</em>(s).</td>
</tr>
<tr>
<td><code>bundles[_].http_code</code></td>
<td>number</td>
<td>If present, indicates an <em>erroneous HTTP status code</em> that OPA received <em>downloading</em> this bundle.</td>
</tr>
<tr>
<td><code>bundles[_].errors</code></td>
<td>array</td>
<td>Collection of detailed <em>parse</em> or <em>compile</em> errors that occurred during <em>activation</em> of this bundle.</td>
</tr>
<tr>
<td><code>bundles[_].size</code></td>
<td>number</td>
<td>Bundle size, in bytes</td>
</tr>
<tr>
<td><code>bundles[_].type</code></td>
<td>string</td>
<td>Bundle type, either <code>snapshot</code> or <code>delta</code></td>
</tr>
<tr>
<td><code>discovery.name</code></td>
<td>string</td>
<td>Name of <em>discovery bundle</em> that the OPA instance is configured to <em>download</em>.</td>
</tr>
<tr>
<td><code>discovery.active_revision</code></td>
<td>string</td>
<td>Opaque revision identifier of the <em>last successful discovery activation</em>.</td>
</tr>
<tr>
<td><code>discovery.last_request</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last discovery bundle request</em>.<br />This timestamp should be &gt;&#x3D; to the <em>successful request timestamp</em> in normal operation.</td>
</tr>
<tr>
<td><code>discovery.last_successful_request</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last successful discovery bundle request</em>.<br />This timestamp should be &gt;&#x3D; to the <em>successful download timestamp</em> in normal operation.</td>
</tr>
<tr>
<td><code>discovery.last_successful_download</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last successful discovery bundle download</em>.</td>
</tr>
<tr>
<td><code>discovery.last_successful_activation</code></td>
<td>string</td>
<td>RFC3339 timestamp of <em>last successful discovery bundle activation</em>.</td>
</tr>
<tr>
<td><code>decision_logs.code</code></td>
<td>string</td>
<td>If present, indicates <em>error</em>(s) occurred during <em>decision log upload event</em>.</td>
</tr>
<tr>
<td><code>decision_logs.message</code></td>
<td>string</td>
<td>Human readable messages describing the <em>error</em>(s).</td>
</tr>
<tr>
<td><code>decision_logs.http_code</code></td>
<td>number</td>
<td>If present, indicates an <em>erroneous HTTP status code</em> that OPA received during <em>a decision log upload event</em>.</td>
</tr>
<tr>
<td><code>decision_logs.metrics</code></td>
<td>object</td>
<td><em>Metrics from the last decision log upload event</em>.</td>
</tr>
<tr>
<td><code>plugins</code></td>
<td>object</td>
<td>A set of objects describing the state of <em>configured plugins</em> in OPA’s runtime.</td>
</tr>
<tr>
<td><code>plugins[_].state</code></td>
<td>string</td>
<td>The state of each plugin.</td>
</tr>
<tr>
<td><code>metrics.prometheus</code></td>
<td>object</td>
<td><em>Global performance metrics for the OPA instance</em>.</td>
</tr>
</tbody></table>
<blockquote>
<p>If the <em>discovery bundle download or activation failed</em>, the status update will contain the following additional fields.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>discovery.code</code></td>
<td>string</td>
<td>If present, indicates <em>error</em>(s) occurred.</td>
</tr>
<tr>
<td><code>discovery.message</code></td>
<td>string</td>
<td>Human readable messages describing the <em>error</em>(s).</td>
</tr>
<tr>
<td><code>discovery.errors</code></td>
<td>array</td>
<td>Collection of detailed <em>parse</em> or <em>compile</em> errors that occurred during <em>activation</em>.</td>
</tr>
</tbody></table>
<blockquote>
<p>Services should reply with a <code>2xx</code> HTTP status if the status update is <em>processed successfully</em>.</p>
</blockquote>
<h2 id="Local-Status-Logs"><a href="#Local-Status-Logs" class="headerlink" title="Local Status Logs"></a>Local Status Logs</h2><blockquote>
<p>Local console logging of <em>status updates</em> can be enabled via the <code>console</code> config option. This does not require any <em>remote server</em>.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">    <span class="attr">console:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>This will dump all <em>status updates</em> to the console.</p>
</blockquote>
<blockquote>
<p>Warning: Status update messages are somewhat infrequent but can be <em>very verbose</em>!<br>The <code>metrics.prometheus</code> portion of the <em>status update</em> in particular can create <em>a considerable amount of log text at info level</em>.</p>
</blockquote>
<h2 id="Prometheus-Status-Metrics"><a href="#Prometheus-Status-Metrics" class="headerlink" title="Prometheus Status Metrics"></a>Prometheus Status Metrics</h2><blockquote>
<p>Prometheus status metrics can be enabled via the prometheus config option.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h1 id="Discovery"><a href="#Discovery" class="headerlink" title="Discovery"></a>Discovery</h1><ol>
<li>OPA can be configured to <em>download bundles of policy and data</em>, <em>report status</em>, and <em>upload decision logs</em> to <em>remote endpoints</em>.<ul>
<li>The discovery feature helps you <em>centrally</em> manage the OPA configuration for these features.</li>
<li>You should use the discovery feature if you want to avoid managing OPA configuration updates in a number of different locations.</li>
</ul>
</li>
<li>When the discovery feature is enabled, OPA will <em>periodically</em> download a <em>discovery bundle</em>.<ul>
<li>Like regular bundles, the <em>discovery bundle</em> may contain <em>JSON</em> and <em>Rego files</em>.</li>
<li>OPA will evaluate the data and policies contained in the <em>discovery bundle</em> to <em>generate the rest of the configuration</em>.</li>
</ul>
</li>
<li>There are two main ways to <em>structure</em> the discovery bundle<ul>
<li>Include <em>static JSON configuration files</em> that <em>define</em> the OPA configuration.</li>
<li>Include <em>Rego files</em> that can be evaluated to <em>produce</em> the OPA configuration.<ul>
<li>If you need OPA to select which policy to <em>download dynamically</em> (e.g., based on environment variables like the region where OPA is running), use the second option.</li>
</ul>
</li>
</ul>
</li>
<li>If discovery is enabled, other features like <em>bundle downloading</em> and <em>status reporting</em> <strong>cannot</strong> be configured <em>manually</em>.<ul>
<li>Similarly, <em>discovered configuration</em> cannot <em>override</em> the <em>original discovery settings</em> in the configuration file that OPA was booted with.</li>
</ul>
</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/26/cloud-native-foundation-security-opa-management/">https://blog.zhongmingmao.top/2022/12/26/cloud-native-foundation-security-opa-management/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a><a class="post-meta__tags" href="/tags/opa/">OPA</a></div><div class="post-share"><div class="social-share" data-image="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-management-7474053.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/12/27/cloud-native-foundation-security-opa-ops/" title="Security - OPA Operation"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-ops.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Security - OPA Operation</div></div><div class="info-2"><div class="info-item-1">ConfigurationExample1$ opa run -s -c config.yaml  12345678910111213$ opa run --server \--log-format=json-pretty \--set=decision_logs.console=true \--set=services.A.url=http://my-bundles:8080/api/opa/bundle/ \--set=bundles.A.service=A \--set=bundles.A.polling.long_polling_timeout_seconds=45 \--set=bundles.A.resource=A.tar.gz \--set=services.B.url=http://my-bundles:8080/api/opa/bundle/ \--set=bundles.B.service=B \--set=bundles.B.polling.long_polling_timeout_seconds=45 \--set=bundles.B.resource=B.tar.gz \  ...</div></div></div></a><a class="pagination-related" href="/2022/12/25/cloud-native-foundation-security-opa-gatekeeper/" title="Security - OPA Gatekeeper"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-gatekeeper.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Security - OPA Gatekeeper</div></div><div class="info-2"><div class="info-item-1">Overview &amp; Architecture In Kubernetes, Admission Controllers enforce policies on objects during create, update, and delete operations.Admission control is fundamental to policy enforcement in Kubernetes.   For example, by deploying OPA as an admission controller you can   Require specific labels on all resources. Require container images come from the corporate image registry. Require all Pods specify resource requests and limits. Prevent conflicting Ingress objects from being created.     Admission ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2022/12/27/cloud-native-foundation-security-opa-ops/" title="Security - OPA Operation"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-ops.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="info-item-2">Security - OPA Operation</div></div><div class="info-2"><div class="info-item-1">ConfigurationExample1$ opa run -s -c config.yaml  12345678910111213$ opa run --server \--log-format=json-pretty \--set=decision_logs.console=true \--set=services.A.url=http://my-bundles:8080/api/opa/bundle/ \--set=bundles.A.service=A \--set=bundles.A.polling.long_polling_timeout_seconds=45 \--set=bundles.A.resource=A.tar.gz \--set=services.B.url=http://my-bundles:8080/api/opa/bundle/ \--set=bundles.B.service=B \--set=bundles.B.polling.long_polling_timeout_seconds=45 \--set=bundles.B.resource=B.tar.gz \  ...</div></div></div></a><a class="pagination-related" href="/2022/12/25/cloud-native-foundation-security-opa-gatekeeper/" title="Security - OPA Gatekeeper"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-gatekeeper.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-25</div><div class="info-item-2">Security - OPA Gatekeeper</div></div><div class="info-2"><div class="info-item-1">Overview &amp; Architecture In Kubernetes, Admission Controllers enforce policies on objects during create, update, and delete operations.Admission control is fundamental to policy enforcement in Kubernetes.   For example, by deploying OPA as an admission controller you can   Require specific labels on all resources. Require container images come from the corporate image registry. Require all Pods specify resource requests and limits. Prevent conflicting Ingress objects from being created.     Admission ...</div></div></div></a><a class="pagination-related" href="/2022/12/24/cloud-native-foundation-security-opa-core/" title="Security - OPA Core"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-7255236.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-24</div><div class="info-item-2">Security - OPA Core</div></div><div class="info-2"><div class="info-item-1">Glance Use OPA for a unified toolset and framework for policy across the cloud native stack. Use OPA to decouple policy from the service’s code so you can release, analyze, and review policies without sacrificing availability or performance. Declarative Express policy in a high-level, declarative language that promotes safe, performant, fine-grained controls. Use a language purpose-built for policy in a world where JSON is pervasive. Iterate, traverse hierarchies, and apply 150+ built-ins like string man...</div></div></div></a><a class="pagination-related" href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-11</div><div class="info-item-2">Kubernetes - Helm Doc</div></div><div class="info-2"><div class="info-item-1">基本概念 Chart 包含在 Kubernetes 集群内部运行的应用程序、工具和服务所需的所有资源定义   Repository 用于存放和共享 Chart   Release 运行在 Kubernetes 集群中的 Chart 实例 一个 Chart 可以在同一个集群中被安装多次，每次安装都会创建一个 Release      基本使用Search   Source Desc    hub 从 Artifact Hub 中搜索   repo 基于本地 repo 搜索，无需联网   hub123456$ h search hub wordpressURL                                                   CHART VERSION	APP VERSION        	DESCRIPTIONhttps://artifacthub.io/packages/helm/kube-wordp...    0.1.0        	1.1                	this is my wordpress packagehttps://artifact...</div></div></div></a><a class="pagination-related" href="/2023/02/02/cloud-native-foundation-k8s-security/" title="Kubernetes - Security"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-security.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-02</div><div class="info-item-2">Kubernetes - Security</div></div><div class="info-2"><div class="info-item-1">层次模型   开发 分发 部署 运行时 容器运行时Non-root 在 Dockerfile 中通过 USER 命令切换成非 root 用户   防止某些镜像窃取宿主的 root 权限并造成危害 在某些容器运行时，容器内部的 root 用户与宿主上的 root 用户是同一个用户 宿主上的重要文件被 mount 到容器内，并被容器修改配置   即使在容器内部也应该权限隔离  123FROM ubuntuRUN user add AUSER A  User namespace 依赖 User namespace，任何容器内部的用户都会映射为宿主上的非 root 用户 默认关闭，因为会引入配置复杂性 系统不知道宿主用户与容器用户的映射关系，在 mount 文件时无法设置适当的权限    Rootless container 容器运行时以非 root 身份启动 即使容器被攻破，在宿主层面获得的用户权限也是非 root 用户 Docker 和其它容器运行时本身的后台 Daemon 需要以 root 身份运行，其它的用户容器才能以 rootless 身份运行 某些运行时，如 Podman，没有 Daemon 进程，...</div></div></div></a><a class="pagination-related" href="/2023/02/01/cloud-native-foundation-k8s-federation/" title="Kubernetes - Federation"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/federation.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="info-item-2">Kubernetes - Federation</div></div><div class="info-2"><div class="info-item-1">跨地域 使用单一集群，可以管控多个地域的机器，底层网络需要打通    Service 优先级：zone &gt; region &gt; other    集群联邦必要性 单一集群的管理规模有上限 数据库存储 etcd 作为 Kubernetes 集群的后端存储数据库，对空间大小（8G）的要求比较苛刻   内存占用 Kubernetes 的 API Server 作为 API 网关，会缓存该集群的所有对象 其它的 Kubernetes Controller 也需要对监听的对象构建客户端缓存   控制器复杂度 Kubernetes 的一个业务流程由多个对象和控制器联动完成 随着对象数量的增长，控制器的处理耗时也会增长     单一计算节点的资源有上限 可量化资源：CPU、Memory 等 不可量化资源：端口数量（限制 Service NodePort）、进程数量等   故障域控制 集群规模越大，控制面组件出现故障时的影响范围越大 方案：将大规模的数据中心切成多个规模相对较小的集群，每个集群控制在一定规模   应用 HA 多数据中心部署来保障跨地域高可用   混合云 私有云 + 公有云    职责 跨集群同...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">641</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Overview-Architecture"><span class="toc-number">1.</span> <span class="toc-text">Overview &amp; Architecture</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bundles"><span class="toc-number">2.</span> <span class="toc-text">Bundles</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bundle-build"><span class="toc-number">2.1.</span> <span class="toc-text">Bundle build</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bundle-Service-API"><span class="toc-number">2.2.</span> <span class="toc-text">Bundle Service API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Caching"><span class="toc-number">2.2.1.</span> <span class="toc-text">Caching</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Long-Polling"><span class="toc-number">2.2.2.</span> <span class="toc-text">HTTP Long Polling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bundle-File-Format"><span class="toc-number">2.3.</span> <span class="toc-text">Bundle File Format</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multiple-Sources-of-Policy-and-Data"><span class="toc-number">2.4.</span> <span class="toc-text">Multiple Sources of Policy and Data</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debugging-Your-Bundles"><span class="toc-number">2.5.</span> <span class="toc-text">Debugging Your Bundles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Signing"><span class="toc-number">2.6.</span> <span class="toc-text">Signing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Delta-Bundles"><span class="toc-number">2.7.</span> <span class="toc-text">Delta Bundles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementations"><span class="toc-number">2.8.</span> <span class="toc-text">Implementations</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Decision-Logs"><span class="toc-number">3.</span> <span class="toc-text">Decision Logs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Decision-Log-Service-API"><span class="toc-number">3.1.</span> <span class="toc-text">Decision Log Service API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Local-Decision-Logs"><span class="toc-number">3.2.</span> <span class="toc-text">Local Decision Logs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Masking-Sensitive-Data"><span class="toc-number">3.3.</span> <span class="toc-text">Masking Sensitive Data</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Drop-Decision-Logs"><span class="toc-number">3.4.</span> <span class="toc-text">Drop Decision Logs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rate-Limiting-Decision-Logs"><span class="toc-number">3.5.</span> <span class="toc-text">Rate Limiting Decision Logs</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Status"><span class="toc-number">4.</span> <span class="toc-text">Status</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Status-Service-API"><span class="toc-number">4.1.</span> <span class="toc-text">Status Service API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Local-Status-Logs"><span class="toc-number">4.2.</span> <span class="toc-text">Local Status Logs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-Status-Metrics"><span class="toc-number">4.3.</span> <span class="toc-text">Prometheus Status Metrics</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Discovery"><span class="toc-number">5.</span> <span class="toc-text">Discovery</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
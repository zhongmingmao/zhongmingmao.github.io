<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - Production Ops | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="镜像仓库">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Production Ops">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/14/cloud-native-foundation-k8s-production-ops/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="镜像仓库">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-ops.jpeg">
<meta property="article:published_time" content="2022-12-13T16:06:25.000Z">
<meta property="article:modified_time" content="2023-10-06T13:12:52.156Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Cloud Native Foundation">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-ops.jpeg"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/14/cloud-native-foundation-k8s-production-ops/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - Production Ops',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-06 21:12:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">496</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">127</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">65</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-ops.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - Production Ops</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-12-13T16:06:25.000Z" title="Created 2022-12-14 00:06:25">2022-12-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">3.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>19min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="镜像仓库"><a href="#镜像仓库" class="headerlink" title="镜像仓库"></a>镜像仓库</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231004222139459.png" alt="image-20231004222139459"></p>
<span id="more"></span>

<ol>
<li>镜像仓库（<code>Registry</code>）负责<code>存储</code>、<code>管理</code>和<code>分发</code>镜像</li>
<li><code>Registry</code> 管理多个 <code>Repository</code>（通过<code>命名</code>区分）</li>
<li>每个 <code>Repository</code> 包含一个或多个镜像（通过<code>镜像名</code>和<code>标签</code>区分）</li>
<li>客户端拉取镜像：<code>Registry/Repository/Image:Tag</code></li>
</ol>
<h2 id="分发规范"><a href="#分发规范" class="headerlink" title="分发规范"></a>分发规范</h2><blockquote>
<p>镜像仓库应遵循 <code>OCI Distribution Spec</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>HTTP Verb</th>
<th>URL</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>&#x2F;v2&#x2F;</td>
<td>检查 <code>Registry</code> 实现的规范和版本</td>
</tr>
<tr>
<td>GET</td>
<td>&#x2F;v2&#x2F;_catalog</td>
<td>获取 <code>Repository</code> 列表</td>
</tr>
<tr>
<td>GET</td>
<td>&#x2F;v2&#x2F;<name>&#x2F;tags&#x2F;list</td>
<td>获取某个 <code>Repository</code> 下所有的标签</td>
</tr>
<tr>
<td>PUT</td>
<td>&#x2F;v2&#x2F;<name>&#x2F;manifests&#x2F;<reference></td>
<td>上传 <code>Image</code> 的 manifest 信息</td>
</tr>
<tr>
<td>DELETE</td>
<td>&#x2F;v2&#x2F;<name>&#x2F;manifests&#x2F;<reference></td>
<td>删除 <code>Image</code></td>
</tr>
<tr>
<td>GET</td>
<td>&#x2F;v2&#x2F;<name>&#x2F;manifests&#x2F;<reference></td>
<td>获取某个  <code>Image</code> 的 manifest 信息</td>
</tr>
<tr>
<td>GET</td>
<td>&#x2F;v2&#x2F;<name>&#x2F;blobs&#x2F;<digest></td>
<td>获取某个  <code>Image</code> 的文件层</td>
</tr>
<tr>
<td>POST</td>
<td>&#x2F;v2&#x2F;<name>&#x2F;blobs&#x2F;uploads&#x2F;</td>
<td>启动某个  <code>Image</code> 的上传</td>
</tr>
<tr>
<td>PUT</td>
<td>&#x2F;v2&#x2F;<name>&#x2F;blobs&#x2F;uploads&#x2F;<session_id></td>
<td>结束文件层上传</td>
</tr>
</tbody></table>
<blockquote>
<p>curl -s -u name:pass ${Registry}&#x2F;v2&#x2F;${Repository}&#x2F;manifests&#x2F;${Tag} | jq</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.container.image.v1+json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">7501</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:999361eb9282b13cf4752b48e81fb6cb9680e49267c764d42a0d826895676240&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;layers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">73358335</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:840caab23da4da8d08d9e3ba17d613cdb42ae4dd0679cbb9ff4ff457155701e2&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">152902661</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:d882a31913c4087426ead7002410e53890b4b84fb42288d1136fc84c204b3110&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">972</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:eac713f6fddb8734b2307fa515f73cb25a33e529e674c25ac541dee3f91f80f3&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2923</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:a951ea919797eb7d65588ba8d3d86647a637f5ad9bd972be2171b7a2a1b3af21&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:4f4fb700ef54461cfa02571ae0db9a0dc1e0cdb5577484a6d75e68dc38e8acc1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">19527096</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:3afdd7c08756f2583fa3697f844f558a2f49ae9d3d34ca4b1fa15f52e8c8c7b1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">92879932</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:aad1b2728107315a8465f01631fab1276b5ce0eda95603e163c192023ac498cf&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="元数据-vs-块文件"><a href="#元数据-vs-块文件" class="headerlink" title="元数据 vs 块文件"></a>元数据 vs 块文件</h2><blockquote>
<p>镜像由元数据（<code>manifests</code>）和块文件（<code>blobs</code>）组成</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231004225259420.png" alt="image-20231004225259420"></p>
<ol>
<li>元数据<ul>
<li>元数据用于描述一个<code>镜像的核心信息</code><ul>
<li>Registry &#x2F; Repository &#x2F; Image &#x2F; Checksum &#x2F; 文件层 &#x2F; 镜像构建描述</li>
</ul>
</li>
<li>从抽象层面完整地描述一个镜像<ul>
<li>镜像是如何构建出来的</li>
<li>运行过什么构建命令</li>
<li>构建的每一个文件层的校验码</li>
<li>镜像标签</li>
<li>镜像的校验码</li>
</ul>
</li>
<li><code>docker image inspect</code> 查看的是镜像的元数据信息</li>
</ul>
</li>
<li>块文件<ul>
<li>块文件是<code>组成镜像的联合文件层的实体</code></li>
<li>每个块文件是一个<code>文件层</code>，内部包含对应文件层的<code>变更</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>docker image inspect nginx:1.25.2</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:ab73c7fd672341e41ec600081253d0b99ea31d0c1acdfb46a1485004472da7ac&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;nginx:1.25.2&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RepoDigests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;nginx@sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Comment&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-08-15T23:58:26.480051949Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Container&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c24a3de5b0d9fe94394b335bfcd832035f985151a4d3e8e8dcfc684fa82a9fed&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ContainerConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c24a3de5b0d9&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Domainname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;User&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AttachStdin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AttachStdout&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AttachStderr&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ExposedPorts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;80/tcp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Tty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;OpenStdin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;StdinOnce&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Env&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;NGINX_VERSION=1.25.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;NJS_VERSION=0.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;PKG_RELEASE=1~bookworm&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Cmd&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;/bin/sh&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;#(nop) &quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;CMD [\&quot;nginx\&quot; \&quot;-g\&quot; \&quot;daemon off;\&quot;]&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:a90fccfd0da73d83dde8f65485e6385ae687eda3bc92a430bc952b990f8a331b&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;WorkingDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Entrypoint&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;/docker-entrypoint.sh&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;OnBuild&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;maintainer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;StopSignal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SIGQUIT&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;DockerVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20.10.23&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Domainname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;User&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AttachStdin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AttachStdout&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AttachStderr&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ExposedPorts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;80/tcp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Tty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;OpenStdin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;StdinOnce&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Env&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;NGINX_VERSION=1.25.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;NJS_VERSION=0.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;PKG_RELEASE=1~bookworm&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Cmd&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;nginx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-g&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:a90fccfd0da73d83dde8f65485e6385ae687eda3bc92a430bc952b990f8a331b&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;WorkingDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Entrypoint&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;/docker-entrypoint.sh&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;OnBuild&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;maintainer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;StopSignal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SIGQUIT&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Variant&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Size&quot;</span><span class="punctuation">:</span> <span class="number">192063326</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;VirtualSize&quot;</span><span class="punctuation">:</span> <span class="number">192063326</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;GraphDriver&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;LowerDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/overlay2/2b3338c595a735d306d5a3d6ef526b785d61242d6e6601e4ba1eb91fea212ae4/diff:/var/lib/docker/overlay2/6f583281737256bda0ab291b2e16243458e09d76c234b6044fac442cf37e949c/diff:/var/lib/docker/overlay2/0bab1cfc61d232958d69e9eb5623421d5869b8085060c4f9d33e32323c8d1c96/diff:/var/lib/docker/overlay2/ceb0576a280c2350f4359bba9687991e7a1e6afc8fe3b212269e2591e1e213f5/diff:/var/lib/docker/overlay2/b1dfbb1cbfda3b344da3a15c74522e46465a0e67b7220cea4a4d1aa1cd5144c2/diff:/var/lib/docker/overlay2/af1748caeab3243da786f13878790cd3a0a10f25e97898adb7af19de55dde62b/diff&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;MergedDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8/merged&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;UpperDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8/diff&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;WorkDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8/work&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RootFS&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;layers&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Layers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;sha256:1c3daa06574284614db07a23682ab6d1c344f09f8093ee10e5de4152a51677a1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sha256:dcb816d1345ed4a429dec632c0933e2af8887b808259985bfc555d155d8c615d&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sha256:8cc0ce26d320f5a342eda516e03ae2bd1ddaa82826b1eed977e3dd484995c2c0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sha256:78cdcd2ba4bbe6067ab5976dd4c38b3a3ad4b8d41c38972a037c9ebd4731988c&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sha256:def14911cf6a8e011b5ba8f39441a22097170c433a4905b60ec69e84a9df78fd&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sha256:3ccc534e961ca62536dc8629a756fa921e989ba9cc8a5fca617d8ff5e40e7d92&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sha256:e005f3c090e08bbf9eb7dd8a289f07124c08556cb959b8aa17dd6e6c8840e4c7&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;LastTagTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ docker history nginx:1.25.2</span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">ab73c7fd6723   13 days ago   /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  STOPSIGNAL SIGQUIT           0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  EXPOSE 80                    0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  ENTRYPOINT [&quot;/docker-entr…   0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop) COPY file:9e3b2b63db9f8fc7…   4.62kB</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop) COPY file:57846632accc8975…   3.02kB</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop) COPY file:3b1b9915b7dd898a…   298B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop) COPY file:caec368f5a54f70a…   2.12kB</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop) COPY file:01e75c6dd0ce317d…   1.62kB</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c set -x     &amp;&amp; groupadd --system -…   94.9MB</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  ENV PKG_RELEASE=1~bookworm   0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  ENV NJS_VERSION=0.8.0        0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  ENV NGINX_VERSION=1.25.2     0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B</span><br><span class="line">&lt;missing&gt;      13 days ago   /bin/sh -c #(nop) ADD file:bc58956fa3d1aff2e…   97.1MB</span><br></pre></td></tr></table></figure>

<h2 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h2><blockquote>
<p>Harbor 是 VMware 开源的企业级 Registry，已 CNCF 毕业</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005100705415.png" alt="image-20231005100705415"></p>
<h3 id="核心模块"><a href="#核心模块" class="headerlink" title="核心模块"></a>核心模块</h3><table>
<thead>
<tr>
<th>Module</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>Harbor Core</td>
<td>仓库管理、认证管理、授权管理、配置管理、项目管理、配额管理、签名管理、副本管理等</td>
</tr>
<tr>
<td>Harbor Portal</td>
<td>Web 界面</td>
</tr>
<tr>
<td>Registry</td>
<td>负责接收客户端的 <code>Pull / Push</code> 请求</td>
</tr>
<tr>
<td>Replication Job Service</td>
<td>可以以<code>主从模式</code>部署 Registry，将镜像从主 Registry 分发到从 Registry</td>
</tr>
<tr>
<td>Log Collector</td>
<td>收集各模块的日志</td>
</tr>
<tr>
<td>GC Controller</td>
<td>回收<code>删除镜像</code>（默认只删除元数据）记录后遗留在<code>块存储</code>中的<code>孤立块文件</code></td>
</tr>
</tbody></table>
<h3 id="核心架构"><a href="#核心架构" class="headerlink" title="核心架构"></a>核心架构</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005102126241.png" alt="image-20231005102126241"></p>
<h3 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h3><blockquote>
<p>完成安装</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ h list -n harbor</span><br><span class="line">NAME      NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART        	APP VERSION</span><br><span class="line">harbor    harbor   	1       	2022-10-05 14:23:03.129780366 +0800 CST	deployed	harbor-1.13.0	2.9.0</span><br><span class="line"></span><br><span class="line">$ k get po -n harbor -owide</span><br><span class="line">NAME                                 READY   STATUS    RESTARTS      AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">harbor-core-68bdc76b5d-8lnzt         1/1     Running   5 (17m ago)   27m   192.168.185.12   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">harbor-database-0                    1/1     Running   0             27m   192.168.185.17   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">harbor-jobservice-6698b45576-nfbxk   1/1     Running   1 (15m ago)   27m   192.168.185.19   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">harbor-nginx-67965c8dc-tgr9j         1/1     Running   0             27m   192.168.185.16   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">harbor-portal-6947675598-brq5g       1/1     Running   0             27m   192.168.185.14   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">harbor-redis-0                       1/1     Running   0             27m   192.168.185.13   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">harbor-registry-869779cf47-clpll     2/2     Running   0             27m   192.168.185.18   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">harbor-trivy-0                       1/1     Running   0             27m   192.168.185.15   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get service -n harbor -owide</span><br><span class="line">NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE   SELECTOR</span><br><span class="line">harbor              NodePort    10.106.237.84    &lt;none&gt;        80:30002/TCP,443:30003/TCP   27m   app=harbor,component=nginx,release=harbor</span><br><span class="line">harbor-core         ClusterIP   10.100.49.21     &lt;none&gt;        80/TCP                       27m   app=harbor,component=core,release=harbor</span><br><span class="line">harbor-database     ClusterIP   10.98.161.143    &lt;none&gt;        5432/TCP                     27m   app=harbor,component=database,release=harbor</span><br><span class="line">harbor-jobservice   ClusterIP   10.107.0.117     &lt;none&gt;        80/TCP                       27m   app=harbor,component=jobservice,release=harbor</span><br><span class="line">harbor-portal       ClusterIP   10.104.103.27    &lt;none&gt;        80/TCP                       27m   app=harbor,component=portal,release=harbor</span><br><span class="line">harbor-redis        ClusterIP   10.101.101.122   &lt;none&gt;        6379/TCP                     27m   app=harbor,component=redis,release=harbor</span><br><span class="line">harbor-registry     ClusterIP   10.103.237.253   &lt;none&gt;        5000/TCP,8080/TCP            27m   app=harbor,component=registry,release=harbor</span><br><span class="line">harbor-trivy        ClusterIP   10.101.223.125   &lt;none&gt;        8080/TCP                     27m   app=harbor,component=trivy,release=harbor</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Portal</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005154353843.png" alt="image-20231005154353843"></p>
<blockquote>
<p>浏览器导出 cer，通过 openssl 转换成 crt</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -inform PEM -in core.harbor.domain.cer -out ca.crt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为 Docker 配置证书并重启 Docker</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /etc/docker/certs.d/core.harbor.domain</span><br><span class="line">$ sudo cp ca.crt /etc/docker/certs.d/core.harbor.domain/</span><br><span class="line">$ sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置域名解析（IP 为 harbor svc vip）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.106.237.84 core.harbor.domain</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登录</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker login -u admin -p Harbor12345 core.harbor.domain</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /home/zhongmingmao/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为镜像打标签并推送到 Harbor</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag nginx:1.25.2 core.harbor.domain/library/nginx:1.25.2</span><br><span class="line"></span><br><span class="line">$ docker push core.harbor.domain/library/nginx:1.25.2</span><br><span class="line">The push refers to repository [core.harbor.domain/library/nginx]</span><br><span class="line">e005f3c090e0: Pushed</span><br><span class="line">3ccc534e961c: Pushed</span><br><span class="line">def14911cf6a: Pushed</span><br><span class="line">78cdcd2ba4bb: Pushed</span><br><span class="line">8cc0ce26d320: Pushed</span><br><span class="line">dcb816d1345e: Pushed</span><br><span class="line">1c3daa065742: Pushed</span><br><span class="line">1.25.2: digest: sha256:d204087971390839f077afcaa4f5a771c1694610f0f7cb13a2d2a3aa520b053f size: 1778</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005154326115.png" alt="image-20231005154326115"></p>
<blockquote>
<p>查询 <code>repositories</code> 和 <code>blobs</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it -n harbor harbor-registry-869779cf47-clpll -- bash</span><br><span class="line">Defaulted container &quot;registry&quot; out of: registry, registryctl</span><br><span class="line">harbor [ / ]$ ls /storage/docker/registry/v2/</span><br><span class="line">blobs  repositories</span><br><span class="line">harbor [ / ]$</span><br><span class="line">harbor [ / ]$ cd /storage/docker/registry/v2/</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls blobs/</span><br><span class="line">sha256</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls repositories/</span><br><span class="line">library</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls repositories/library/</span><br><span class="line">nginx</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls repositories/library/nginx/</span><br><span class="line">_layers  _manifests  _uploads</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls repositories/library/nginx/_manifests/</span><br><span class="line">revisions  tags</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls repositories/library/nginx/_manifests/tags/</span><br><span class="line">1.25.2</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls repositories/library/nginx/_manifests/tags/1.25.2/</span><br><span class="line">current  index</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ ls repositories/library/nginx/_layers/</span><br><span class="line">sha256</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$</span><br><span class="line">harbor [ /storage/docker/registry/v2 ]$ du -sh *</span><br><span class="line">64M    blobs</span><br><span class="line">140K    repositories</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it -n harbor harbor-database-0 -- bash</span><br><span class="line">Defaulted container &quot;database&quot; out of: database, data-migrator (init), data-permissions-ensurer (init)</span><br><span class="line">postgres [ / ]$</span><br><span class="line">postgres [ / ]$ psql -U postgres -d postgres -h 127.0.0.1 -p 5432</span><br><span class="line">psql (14.9)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres=# \c registry</span><br><span class="line">You are now connected to database &quot;registry&quot; as user &quot;postgres&quot;.</span><br><span class="line">registry=#</span><br><span class="line">registry=# select * from harbor_user;</span><br><span class="line"> user_id | username  | email |             password             |    realname    |    comment     | deleted | reset_uuid |               salt               | sysadmin_flag |       creation_time        |        update_time         | password_version</span><br><span class="line">---------+-----------+-------+----------------------------------+----------------+----------------+---------+------------+----------------------------------+---------------+----------------------------+----------------------------+------------------</span><br><span class="line">       2 | anonymous |       |                                  | anonymous user | anonymous user | t       |            |                                  | f             | 2022-10-05 06:34:25.687982 | 2022-10-05 06:34:25.766607 | sha1</span><br><span class="line">       1 | admin     |       | e3f34d1d678a8c1adda9047536c1feb4 | system admin   | admin user     | f       |            | wPKuaGBudkmjRWNR7Q0CUD34z3eTInXZ | t             | 2022-10-05 06:34:25.687982 | 2022-10-05 06:34:25.872904 | sha256</span><br><span class="line">(2 rows)</span><br><span class="line"></span><br><span class="line">registry=#</span><br><span class="line">registry=# exit</span><br><span class="line">postgres [ / ]$ exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<h3 id="HA"><a href="#HA" class="headerlink" title="HA"></a>HA</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005151928881.png" alt="image-20231005151928881"></p>
<h3 id="User"><a href="#User" class="headerlink" title="User"></a>User</h3><blockquote>
<p>public 仓库可以直接 pull</p>
</blockquote>
<table>
<thead>
<tr>
<th>Role</th>
<th>ACL</th>
</tr>
</thead>
<tbody><tr>
<td>Guest</td>
<td>docker pull</td>
</tr>
<tr>
<td>Developer</td>
<td>docker pull&#x2F;push</td>
</tr>
<tr>
<td>Admin</td>
<td>all</td>
</tr>
</tbody></table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005154502872.png" alt="image-20231005154502872"></p>
<h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><blockquote>
<p>镜像删除时，blob 文件不会被删除（因为分层，减少磁盘占用），需要 GC 来删除没有被引用的 blob，进而回收存储空间</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005154529168.png" alt="image-20231005154529168"></p>
<blockquote>
<p>删除 core.harbor.domain&#x2F;library&#x2F;nginx:1.25.2</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005154603666.png" alt="image-20231005154603666"></p>
<blockquote>
<p>再次推送 - Layer already exists</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ docker push core.harbor.domain/library/nginx:1.25.2</span><br><span class="line">The push refers to repository [core.harbor.domain/library/nginx]</span><br><span class="line">e005f3c090e0: Preparing</span><br><span class="line">e005f3c090e0: Layer already exists</span><br><span class="line">3ccc534e961c: Layer already exists</span><br><span class="line">def14911cf6a: Layer already exists</span><br><span class="line">78cdcd2ba4bb: Layer already exists</span><br><span class="line">8cc0ce26d320: Layer already exists</span><br><span class="line">dcb816d1345e: Layer already exists</span><br><span class="line">1c3daa065742: Layer already exists</span><br><span class="line">1.25.2: digest: sha256:d204087971390839f077afcaa4f5a771c1694610f0f7cb13a2d2a3aa520b053f size: 1778</span><br></pre></td></tr></table></figure>

<h2 id="Dragonfly"><a href="#Dragonfly" class="headerlink" title="Dragonfly"></a>Dragonfly</h2><blockquote>
<p>基于 <code>P2P</code> 的智能镜像和文件分发工具，提高文件传输效率，最大化利用网络带宽</p>
</blockquote>
<blockquote>
<p><code>非侵入</code>性支持<code>所有类型的容器技术</code><br>dfget proxy <code>拦截</code>来自于 <code>docker pull/push</code> 的 HTTP 请求，然后使用 dfget 来处理那些与镜像分层相关的请求</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005160223151.png" alt="image-20231005160223151"></p>
<blockquote>
<p>每个文件会被分成多个 Block，这些 Block 会在 Peer 之间传输</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005160534218.png" alt="image-20231005160534218"></p>
<h1 id="镜像安全"><a href="#镜像安全" class="headerlink" title="镜像安全"></a>镜像安全</h1><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><table>
<thead>
<tr>
<th>Scope</th>
<th>Action</th>
</tr>
</thead>
<tbody><tr>
<td>构建指令</td>
<td><code>配置与代码分离</code>，避免在构建镜像时添加<code>敏感信息</code></td>
</tr>
<tr>
<td>应用依赖</td>
<td>避免安装<code>不必要</code>的依赖，确保依赖无安全风险</td>
</tr>
<tr>
<td>文件分层</td>
<td>如果敏感信息位于 lower，即便 upper 屏蔽删除（逻辑删除），依然可以获得原文件</td>
</tr>
</tbody></table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005162905453.png" alt="image-20231005162905453"></p>
<h2 id="镜像扫描"><a href="#镜像扫描" class="headerlink" title="镜像扫描"></a>镜像扫描</h2><blockquote>
<p>CVE - Common Vulnerabilities and Exposures</p>
</blockquote>
<ol>
<li>分析构建指令、应用、文件、依赖包</li>
<li>查询 CVE 库和安全策略</li>
<li>检查镜像是否安全，是否符合企业的安全标准</li>
</ol>
<blockquote>
<p>扫描过程 - 静态分析</p>
</blockquote>
<ol>
<li>镜像扫描服务从镜像仓库拉取镜像</li>
<li><code>解析</code>镜像的<code>元数据</code></li>
<li><code>解压</code>镜像的<code>每一个文件层</code><ul>
<li>提取每一层所包含的依赖包、可运行程序、文件列表、扫描文件内容</li>
</ul>
</li>
<li>将扫描结果与 <code>CVE 字典</code>、<code>安全策略字典</code>进行匹配，以最终确定镜像是否安全</li>
</ol>
<blockquote>
<p>Harbor provides <code>static analysis of vulnerabilities in images</code> through the open source projects <code>Trivy</code> and <code>Clair</code>.</p>
</blockquote>
<h2 id="镜像准入"><a href="#镜像准入" class="headerlink" title="镜像准入"></a>镜像准入</h2><blockquote>
<p> ImagePolicyWebhook admission controller</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231005163533870.png" alt="image-20231005163533870"></p>
<h1 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h1><h2 id="Loki"><a href="#Loki" class="headerlink" title="Loki"></a>Loki</h2><blockquote>
<p><code>低成本</code> - 标签 + 压缩<br>借鉴了 <code>Prometheus</code> 的思想，不做<code>全文索引</code></p>
</blockquote>
<ol>
<li><code>标签</code> - 基于<code>仅索引日志的元数据</code>而构建的</li>
<li>日志数据本身被<code>压缩</code>并存储在 OSS 或者 Local FileSystem</li>
</ol>
<blockquote>
<p>Prometheus -&gt; Grafana -&gt; Grafana Loki</p>
</blockquote>
<h3 id="日志采集"><a href="#日志采集" class="headerlink" title="日志采集"></a>日志采集</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231006170725713.png" alt="image-20231006170725713"></p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>Promtail</td>
<td>发现采集目标以及给日志流添加上 <code>Label</code> 后发送给 Loki<br /><code>服务发现</code>是基于 <code>Prometheus</code> 的服务发现机制实现的（一脉相承）</td>
</tr>
<tr>
<td>Loki</td>
<td>可以<code>水平扩展</code>，支持 <code>HA</code> 和<code>多租户</code><br />使用与 <code>Prometheus</code> 相同的<code>服务发现机制</code>，将 <code>Label</code> 添加到日志流中，而不是建立<code>全文索引</code><br />Promtail 接收到的 <code>Log</code> 和应用的 <code>Metrics</code> 具有<code>相同的 Label 集合</code></td>
</tr>
<tr>
<td>Grafana</td>
<td>一个用于<code>监控</code>和<code>可视化观测</code>的开源平台，支持非常丰富的<code>数据源</code><br />在 Loki 技术栈中，Grafana 专门用来展示来自于 <code>Prometheus</code> 和 <code>Loki</code> 的<code>时间序列数据</code></td>
</tr>
</tbody></table>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231006172507431.png" alt="image-20231006172507431"></p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>Distributor</td>
<td>负责处理 <code>Promtail</code> 写入的日志<br />一旦 Distributor 接收到日志数据，会将它们<code>分批</code>（先聚合），然后<code>并行</code>地发送到多个 Ingester<br />Distributor 与 Ingester 通过 <code>gRpc</code> 进行通信<br />Distributor 是<code>无状态</code>的，基于<code>一致性哈希</code></td>
</tr>
<tr>
<td>Ingester</td>
<td>Ingester 负责将日志数据写入<code>持久化存储</code>（S3 等）<br />Ingester 会校验采集的日志<code>是否乱序</code>（日志行是否按<code>时间戳递增</code>）</td>
</tr>
<tr>
<td>Querier</td>
<td>处理 <code>LogQL</code>（类似于 PromQL）</td>
</tr>
</tbody></table>
<h3 id="Hello-Loki"><a href="#Hello-Loki" class="headerlink" title="Hello Loki"></a>Hello Loki</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k get po</span><br><span class="line">NAME                                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">loki-0                                          1/1     Running   0          27m</span><br><span class="line">loki-grafana-7c48d88cd7-q49kk                   2/2     Running   0          4m39s</span><br><span class="line">loki-kube-state-metrics-5d666fbb55-tgr9j        1/1     Running   0          27m</span><br><span class="line">loki-prometheus-alertmanager-649cc4f455-8jfpx   2/2     Running   0          27m</span><br><span class="line">loki-prometheus-node-exporter-8lnzt             1/1     Running   0          27m</span><br><span class="line">loki-prometheus-pushgateway-575b7f6bfd-pjq9r    1/1     Running   0          27m</span><br><span class="line">loki-prometheus-server-b4c6f96bd-tv2hx          2/2     Running   0          27m</span><br><span class="line">loki-promtail-clpll                             1/1     Running   0          27m</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">admin-password:</span> <span class="string">ZGJpTm1ZSTk1ZG0wSTUycW9Denc1Tk9vNHhKQzJSUDM1aHJyZXhCaA==</span></span><br><span class="line">  <span class="attr">admin-user:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">ldap-toml:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">meta.helm.sh/release-name:</span> <span class="string">loki</span></span><br><span class="line">    <span class="attr">meta.helm.sh/release-namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-10-06T09:41:40Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">loki</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">8.3</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">grafana-6.43.5</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;9844&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">cdd4e229-233f-4a5b-8a5b-d64734c2ca29</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo -n &#x27;YWRtaW4=&#x27; | base64 -d</span><br><span class="line">admin</span><br><span class="line"></span><br><span class="line">$ echo -n &#x27;ZGJpTm1ZSTk1ZG0wSTUycW9Denc1Tk9vNHhKQzJSUDM1aHJyZXhCaA==&#x27; | base64 -d</span><br><span class="line">dbiNmYI95dm0I52qoCzw5NOo4xJC2RP35hrrexBh</span><br><span class="line"></span><br><span class="line">$ k get svc</span><br><span class="line">NAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes                      ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        39d</span><br><span class="line">loki                            ClusterIP   10.107.0.117     &lt;none&gt;        3100/TCP       28m</span><br><span class="line">loki-grafana                    NodePort    10.106.237.84    &lt;none&gt;        80:31195/TCP   28m</span><br><span class="line">loki-headless                   ClusterIP   None             &lt;none&gt;        3100/TCP       28m</span><br><span class="line">loki-kube-state-metrics         ClusterIP   10.98.161.143    &lt;none&gt;        8080/TCP       28m</span><br><span class="line">loki-memberlist                 ClusterIP   None             &lt;none&gt;        7946/TCP       28m</span><br><span class="line">loki-prometheus-alertmanager    ClusterIP   10.104.103.27    &lt;none&gt;        80/TCP         28m</span><br><span class="line">loki-prometheus-node-exporter   ClusterIP   None             &lt;none&gt;        9100/TCP       28m</span><br><span class="line">loki-prometheus-pushgateway     ClusterIP   10.101.101.122   &lt;none&gt;        9091/TCP       28m</span><br><span class="line">loki-prometheus-server          ClusterIP   10.100.49.21     &lt;none&gt;        80/TCP         28m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Loki - Log</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231006181952222.png" alt="image-20231006181952222"></p>
<blockquote>
<p>Prometheus - Metrics</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231006182132733.png" alt="image-20231006182132733"></p>
<h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><blockquote>
<p>Prometheus 需要较多的<code>内存</code>和<code>存储</code>，数据是<code>不汇聚</code>的</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231006183011110.png" alt="image-20231006183011110"></p>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><blockquote>
<p><code>kubelet</code>（集成 <code>cAdvisor</code>）会收集当前 Node 上的所有信息，信息来源为 <code>CGroup</code>，Prometheus 会拉取这些信息</p>
</blockquote>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><blockquote>
<p>Pod 通过 <code>Annotation</code> 声明上报端口，Prometheus 会服务发现这些 Endpoint</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">http-metrics</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-0</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3100</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>App 要暴露 Prometheus Metrics</p>
</blockquote>
<h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h3><table>
<thead>
<tr>
<th>Type</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>Counter</td>
<td>单调递增</td>
</tr>
<tr>
<td>Guage</td>
<td>可增可减</td>
</tr>
<tr>
<td>Histogram</td>
<td>划分 Bucket：<code>均等</code> &#x2F; <code>指数</code></td>
</tr>
<tr>
<td>Summary</td>
<td>与 Histogram 类似，但直接<code>存储分位值</code>，而不是通过 Bucket 计算</td>
</tr>
</tbody></table>
<h3 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h3><h4 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231006195335235.png" alt="image-20231006195335235"></p>
<h4 id="Targets"><a href="#Targets" class="headerlink" title="Targets"></a>Targets</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231006195552915.png" alt="image-20231006195552915"></p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/14/cloud-native-foundation-k8s-production-ops/">https://blog.zhongmingmao.top/2022/12/14/cloud-native-foundation-k8s-production-ops/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/15/cloud-native-foundation-k8s-devops/" title="Kubernetes - DevOps"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/devops.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes - DevOps</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/13/cloud-native-foundation-k8s-manage-production-clusters/" title="Kubernetes - Manage Production Clusters"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/2bc58949d451b7e5f8f8759c44d962d01b2ed48d-1108x1108.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Kubernetes - Manage Production Clusters</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/01/31/cloud-native-foundation-k8s-istio/" title="Kubernetes - Istio"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-31</div><div class="title">Kubernetes - Istio</div></div></a></div><div><a href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/go-envoy.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-30</div><div class="title">Kubernetes - Envoy</div></div></a></div><div><a href="/2023/01/29/cloud-native-foundation-k8s-scaling/" title="Kubernetes - Scaling"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231223144041516.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-29</div><div class="title">Kubernetes - Scaling</div></div></a></div><div><a href="/2023/01/28/cloud-native-foundation-k8s-helm/" title="Kubernetes - Helm"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-helm.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-28</div><div class="title">Kubernetes - Helm</div></div></a></div><div><a href="/2023/01/27/cloud-native-foundation-k8s-operator/" title="Kubernetes - Operator"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-operators.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-27</div><div class="title">Kubernetes - Operator</div></div></a></div><div><a href="/2022/12/15/cloud-native-foundation-k8s-devops/" title="Kubernetes - DevOps"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/devops.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-15</div><div class="title">Kubernetes - DevOps</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">496</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">127</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">65</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">镜像仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%8F%91%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.</span> <span class="toc-text">分发规范</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE-vs-%E5%9D%97%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">元数据 vs 块文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Harbor"><span class="toc-number">1.3.</span> <span class="toc-text">Harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.1.</span> <span class="toc-text">核心模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">核心架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Helm"><span class="toc-number">1.3.3.</span> <span class="toc-text">Helm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HA"><span class="toc-number">1.3.4.</span> <span class="toc-text">HA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User"><span class="toc-number">1.3.5.</span> <span class="toc-text">User</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GC"><span class="toc-number">1.3.6.</span> <span class="toc-text">GC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dragonfly"><span class="toc-number">1.4.</span> <span class="toc-text">Dragonfly</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%AE%89%E5%85%A8"><span class="toc-number">2.</span> <span class="toc-text">镜像安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.1.</span> <span class="toc-text">最佳实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E6%89%AB%E6%8F%8F"><span class="toc-number">2.2.</span> <span class="toc-text">镜像扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%87%86%E5%85%A5"><span class="toc-number">2.3.</span> <span class="toc-text">镜像准入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">可观测性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Loki"><span class="toc-number">3.1.</span> <span class="toc-text">Loki</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86"><span class="toc-number">3.1.1.</span> <span class="toc-text">日志采集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">3.1.2.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hello-Loki"><span class="toc-number">3.1.3.</span> <span class="toc-text">Hello Loki</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus"><span class="toc-number">3.2.</span> <span class="toc-text">Prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Node"><span class="toc-number">3.2.1.</span> <span class="toc-text">Node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod"><span class="toc-number">3.2.2.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metrics"><span class="toc-number">3.2.3.</span> <span class="toc-text">Metrics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Status"><span class="toc-number">3.2.4.</span> <span class="toc-text">Status</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Service-Discovery"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">Service Discovery</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Targets"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">Targets</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/31/cloud-native-foundation-k8s-istio/" title="Kubernetes - Istio"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - Istio"/></a><div class="content"><a class="title" href="/2023/01/31/cloud-native-foundation-k8s-istio/" title="Kubernetes - Istio">Kubernetes - Istio</a><time datetime="2023-01-30T16:06:25.000Z" title="Created 2023-01-31 00:06:25">2023-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/go-envoy.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - Envoy"/></a><div class="content"><a class="title" href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy">Kubernetes - Envoy</a><time datetime="2023-01-29T16:06:25.000Z" title="Created 2023-01-30 00:06:25">2023-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/29/cloud-native-foundation-k8s-scaling/" title="Kubernetes - Scaling"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231223144041516.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - Scaling"/></a><div class="content"><a class="title" href="/2023/01/29/cloud-native-foundation-k8s-scaling/" title="Kubernetes - Scaling">Kubernetes - Scaling</a><time datetime="2023-01-28T16:06:25.000Z" title="Created 2023-01-29 00:06:25">2023-01-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/28/cloud-native-foundation-k8s-helm/" title="Kubernetes - Helm"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-helm.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - Helm"/></a><div class="content"><a class="title" href="/2023/01/28/cloud-native-foundation-k8s-helm/" title="Kubernetes - Helm">Kubernetes - Helm</a><time datetime="2023-01-27T16:06:25.000Z" title="Created 2023-01-28 00:06:25">2023-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/27/cloud-native-foundation-k8s-operator/" title="Kubernetes - Operator"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-operators.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - Operator"/></a><div class="content"><a class="title" href="/2023/01/27/cloud-native-foundation-k8s-operator/" title="Kubernetes - Operator">Kubernetes - Operator</a><time datetime="2023-01-26T16:06:25.000Z" title="Created 2023-01-27 00:06:25">2023-01-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2024 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
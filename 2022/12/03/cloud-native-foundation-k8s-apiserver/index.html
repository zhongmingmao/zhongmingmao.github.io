<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - API Server | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="概述 API Server   提供集群管理的 REST API 提供其它模块之间数据交互和通信的枢纽 其它模块通过 API Server 查询或者修改数据，只有 API Server 才能直接操作 etcd">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - API Server">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/03/cloud-native-foundation-k8s-apiserver/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="概述 API Server   提供集群管理的 REST API 提供其它模块之间数据交互和通信的枢纽 其它模块通过 API Server 查询或者修改数据，只有 API Server 才能直接操作 etcd">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/Screen-Shot-2022-01-22-at-10.52.54-AM.png">
<meta property="article:published_time" content="2022-12-02T16:06:25.000Z">
<meta property="article:modified_time" content="2023-07-22T09:58:42.328Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cloud Native Foundation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/Screen-Shot-2022-01-22-at-10.52.54-AM.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/03/cloud-native-foundation-k8s-apiserver/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - API Server',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-22 17:58:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">639</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/Screen-Shot-2022-01-22-at-10.52.54-AM.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - API Server</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-12-02T16:06:25.000Z" title="Created 2022-12-03 00:06:25">2022-12-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">25.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>150min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><blockquote>
<p>API Server</p>
</blockquote>
<ol>
<li>提供<code>集群管理</code>的 <code>REST API</code></li>
<li>提供其它模块之间数据交互和通信的<code>枢纽</code><ul>
<li>其它模块通过 API Server 查询或者修改数据，只有 API Server 才能直接操作 <code>etcd</code></li>
</ul>
</li>
</ol>
<span id="more"></span>

<blockquote>
<p>访问控制：<code>认证</code> + <code>鉴权</code> + <code>准入</code></p>
</blockquote>
<blockquote>
<p><code>Mutating Admission</code> 可以修改对象，而 <code>Validating Admission</code> 不可以修改对象</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230703213421651.png" alt="image-20230703213421651"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230703213444656.png" alt="image-20230703213444656"></p>
<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><ol>
<li>开启 <code>TLS</code> 时，<code>所有请求</code>都需要首先<code>认证</code></li>
<li>Kubernetes 支持多种认证机制，并支持<code>同时开启</code>多个认证插件（只需要有 <code>1</code> 个认证通过即可）</li>
<li>如果认证成功，进入鉴权模块，如果认证失败，则返回 401</li>
</ol>
<blockquote>
<p>认证插件</p>
</blockquote>
<ol>
<li>X509 证书<ul>
<li>在 API Server <code>启动</code>时配置 <code>--client-ca-file</code></li>
<li><code>CN 域</code>（CommonName）用作<code>用户名</code>，而<code>O 域</code>（Organization）则用作 <code>Group 名</code></li>
</ul>
</li>
<li>静态 Token 文件<ul>
<li>在 API Server <code>启动</code>时配置 <code>--token-auth-file</code></li>
<li>采用 <code>csv</code> 格式：<code>token,user,uid,[group...]</code></li>
</ul>
</li>
<li>引导 Token<ul>
<li>目的：为了支持<code>平滑</code>地<code>启动引导新集群</code></li>
<li>以 <code>Secret</code> 的形式保存在 <code>kube-system</code> 命名空间中，可以被<code>动态</code>管理和创建</li>
<li><code>TokenCleaner</code> 能够在引导 Token <code>过期</code>时将其删除</li>
<li>使用 kubeadm 部署 Kubernetes 时，可通过 <code>kubeadm token list</code> 查询</li>
</ul>
</li>
<li>静态密码文件<ul>
<li>在 API Server <code>启动</code>时配置 <code>--basic-auth-file</code></li>
<li>采用 <code>csv</code> 格式：<code>password,user,uid,[group...]</code></li>
</ul>
</li>
<li>ServiceAccount<ul>
<li>ServiceAccount 是由 Kubernetes <code>自动生成</code>的</li>
<li><code>自动挂载</code>在容器的 <code>/var/run/secrets/kubernetes.io/serviceaccount</code> 目录</li>
</ul>
</li>
<li>OpenID<ul>
<li>OAuth 2.0 的认证机制</li>
</ul>
</li>
<li>Webhook<ul>
<li><code>--authentication-token-webhook-config-file</code><ul>
<li>描述如何访问远程的 Webhook 服务</li>
</ul>
</li>
<li><code>--authentication-token-webhook-cache-ttl</code><ul>
<li>设定认证的缓存时间，默认为 2 分钟</li>
</ul>
</li>
</ul>
</li>
<li>匿名请求（一般禁止）<ul>
<li><code>--anonymous-auth</code></li>
</ul>
</li>
</ol>
<h2 id="X509"><a href="#X509" class="headerlink" title="X509"></a>X509</h2><blockquote>
<p>API Server 本身是一个 <code>CA</code>（颁发证书，双向认证）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ tree /etc/kubernetes/pki/</span><br><span class="line">/etc/kubernetes/pki/</span><br><span class="line">|-- apiserver.crt</span><br><span class="line">|-- apiserver-etcd-client.crt</span><br><span class="line">|-- apiserver-etcd-client.key</span><br><span class="line">|-- apiserver.key</span><br><span class="line">|-- apiserver-kubelet-client.crt</span><br><span class="line">|-- apiserver-kubelet-client.key</span><br><span class="line">|-- ca.crt</span><br><span class="line">|-- ca.key</span><br><span class="line">|-- etcd</span><br><span class="line">|   |-- ca.crt</span><br><span class="line">|   |-- ca.key</span><br><span class="line">|   |-- healthcheck-client.crt</span><br><span class="line">|   |-- healthcheck-client.key</span><br><span class="line">|   |-- peer.crt</span><br><span class="line">|   |-- peer.key</span><br><span class="line">|   |-- server.crt</span><br><span class="line">|   `-- server.key</span><br><span class="line">|-- front-proxy-ca.crt</span><br><span class="line">|-- front-proxy-ca.key</span><br><span class="line">|-- front-proxy-client.crt</span><br><span class="line">|-- front-proxy-client.key</span><br><span class="line">|-- sa.key</span><br><span class="line">`-- sa.pub</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成私钥和 CSR</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out zhongmingmao.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">..............................+++++</span><br><span class="line">..+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line">$ openssl req -new -key zhongmingmao.key -out zhongmingmao.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:CN</span><br><span class="line">State or Province Name (full name) [Some-State]:GuangDong</span><br><span class="line">Locality Name (eg, city) []:ZhongShan</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:Wechat</span><br><span class="line">Organizational Unit Name (eg, section) []:IT</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:zhongmingmao</span><br><span class="line">Email Address []:zhongmingmao@163.com</span><br><span class="line"></span><br><span class="line">Please enter the following &#x27;extra&#x27; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br></pre></td></tr></table></figure>

<blockquote>
<p>编码 CSR</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat zhongmingmao.csr | base64 | tr -d &quot;\n&quot;</span><br><span class="line">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQzFUQ0NBYjBDQVFBd2dZOHhDekFKQmdOVkJBWVRBa05PTVJJd0VBWURWUVFJREFsSGRXRnVaMFJ2Ym1jeApFakFRQmdOVkJBY01DVnBvYjI1blUyaGhiakVQTUEwR0ExVUVDZ3dHVjJWamFHRjBNUXN3Q1FZRFZRUUxEQUpKClZERVZNQk1HQTFVRUF3d01lbWh2Ym1kdGFXNW5iV0Z2TVNNd0lRWUpLb1pJaHZjTkFRa0JGaFI2YUc5dVoyMXAKYm1kdFlXOUFNVFl6TG1OdmJUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU9OVgpHaWZvKzBwMTJ5Z2RNQ2dnREFIVW5SN2JGTG01Mkp6Qnd3Mkp0YXNSUkNnMm1qZTRSamRzMVdhN1JvdHZKQ0l0CmlLeXMzRlNES1ZmZ0pvcWdsbXJhaVVJeDl0YVgyODU0S1h4Q3RBakdpUDRURzhjdVBEMWxtNFA0bW5VelBnVWoKRGw3N0R0NzU4MTA0Sjl0S1k4WWM0TGV0ellZYmJlSTRFUGJNUzAwdmVLS1Y2UytKNjhack1BOU9mb1lid01RYgp0dmlXam1nUjhMUVBGUWo1VWIrMVdYeFBGOERWUWVOZEZacjJQMVI3WG83d2FlLzI5WlJzLzFVRUpORW9tbnpCClgrbnJxQlVSOUxjbjdxN2s4b1greHhCeEFVUW13a1BQZGMzL1R0VCtnNVF3K1dHcWt2ZG9RVy96aGFsY2pwbEoKYjJRc3hKZW1rcDJoVm1tZzZGTUNBd0VBQWFBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ1JsNXU1QjE3TwpFZ2Rxbk84NnVxVWNCcVJGSjhUTE9MVW9PQm1RMHdIWDR0RHo3WEhIdzVwTXZpTWo4WDdkczlQSkRHWEdJYjFsCmQ4Z3pzd00wVlZCdFFUUXdzTXRwaXJnSXhZWG1FckV1NzJPYmJONjBJK250YjZSKzV2czBLd0grQWN6YytWZE8KTHN6MHluaDBUSVNjaW5mQmFuckgwOE9aWWdISGlZQjdMeks4VGQyUWJQR1FMR204UUxLeHh4UGpPc2tZajJjbApLWm9JYlJ5QTNxd3ppZE5qdTg0dmxGeDdTVkZDNXU2YXhmdVVDMGJlRkErNEVpRVBqMlFkSlBIcmJJajdNVkQxClRVbm1OZ0hzRmdNUUhPekora3A2cDM3Z2pwQVp6RUQ3RVd2UVE1QnFtNDRMWGdoYS81ODFIbGFSeGFwVjIxSmEKU1NOS1NFUDdiWmliCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=</span><br></pre></td></tr></table></figure>

<blockquote>
<p>向 API Server 提交 CSR</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: certificates.k8s.io/v1</span><br><span class="line">kind: CertificateSigningRequest</span><br><span class="line">metadata:</span><br><span class="line">  name: zhongmingmao</span><br><span class="line">spec:</span><br><span class="line">  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQzFUQ0NBYjBDQVFBd2dZOHhDekFKQmdOVkJBWVRBa05PTVJJd0VBWURWUVFJREFsSGRXRnVaMFJ2Ym1jeApFakFRQmdOVkJBY01DVnBvYjI1blUyaGhiakVQTUEwR0ExVUVDZ3dHVjJWamFHRjBNUXN3Q1FZRFZRUUxEQUpKClZERVZNQk1HQTFVRUF3d01lbWh2Ym1kdGFXNW5iV0Z2TVNNd0lRWUpLb1pJaHZjTkFRa0JGaFI2YUc5dVoyMXAKYm1kdFlXOUFNVFl6TG1OdmJUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU9OVgpHaWZvKzBwMTJ5Z2RNQ2dnREFIVW5SN2JGTG01Mkp6Qnd3Mkp0YXNSUkNnMm1qZTRSamRzMVdhN1JvdHZKQ0l0CmlLeXMzRlNES1ZmZ0pvcWdsbXJhaVVJeDl0YVgyODU0S1h4Q3RBakdpUDRURzhjdVBEMWxtNFA0bW5VelBnVWoKRGw3N0R0NzU4MTA0Sjl0S1k4WWM0TGV0ellZYmJlSTRFUGJNUzAwdmVLS1Y2UytKNjhack1BOU9mb1lid01RYgp0dmlXam1nUjhMUVBGUWo1VWIrMVdYeFBGOERWUWVOZEZacjJQMVI3WG83d2FlLzI5WlJzLzFVRUpORW9tbnpCClgrbnJxQlVSOUxjbjdxN2s4b1greHhCeEFVUW13a1BQZGMzL1R0VCtnNVF3K1dHcWt2ZG9RVy96aGFsY2pwbEoKYjJRc3hKZW1rcDJoVm1tZzZGTUNBd0VBQWFBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ1JsNXU1QjE3TwpFZ2Rxbk84NnVxVWNCcVJGSjhUTE9MVW9PQm1RMHdIWDR0RHo3WEhIdzVwTXZpTWo4WDdkczlQSkRHWEdJYjFsCmQ4Z3pzd00wVlZCdFFUUXdzTXRwaXJnSXhZWG1FckV1NzJPYmJONjBJK250YjZSKzV2czBLd0grQWN6YytWZE8KTHN6MHluaDBUSVNjaW5mQmFuckgwOE9aWWdISGlZQjdMeks4VGQyUWJQR1FMR204UUxLeHh4UGpPc2tZajJjbApLWm9JYlJ5QTNxd3ppZE5qdTg0dmxGeDdTVkZDNXU2YXhmdVVDMGJlRkErNEVpRVBqMlFkSlBIcmJJajdNVkQxClRVbm1OZ0hzRmdNUUhPekora3A2cDM3Z2pwQVp6RUQ3RVd2UVE1QnFtNDRMWGdoYS81ODFIbGFSeGFwVjIxSmEKU1NOS1NFUDdiWmliCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=</span><br><span class="line">  signerName: kubernetes.io/kube-apiserver-client</span><br><span class="line">  expirationSeconds: 8640000</span><br><span class="line">  usages:</span><br><span class="line">  - client auth</span><br><span class="line">EOF</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/zhongmingmao created</span><br><span class="line"></span><br><span class="line">$ k get csr</span><br><span class="line">NAME           AGE   SIGNERNAME                                    REQUESTOR             REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-fr7gf      48m   kubernetes.io/kube-apiserver-client-kubelet   system:node:mac-k8s   &lt;none&gt;              Approved,Issued</span><br><span class="line">zhongmingmao   39s   kubernetes.io/kube-apiserver-client           kubernetes-admin      100d                Pending</span><br></pre></td></tr></table></figure>

<blockquote>
<p>审批 CSR</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k certificate approve zhongmingmao</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/zhongmingmao approved</span><br><span class="line"></span><br><span class="line">$ k get csr</span><br><span class="line">NAME           AGE   SIGNERNAME                                    REQUESTOR             REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-fr7gf      49m   kubernetes.io/kube-apiserver-client-kubelet   system:node:mac-k8s   &lt;none&gt;              Approved,Issued</span><br><span class="line">zhongmingmao   89s   kubernetes.io/kube-apiserver-client           kubernetes-admin      100d                Approved,Issued</span><br></pre></td></tr></table></figure>

<blockquote>
<p>API Server 已颁发证书：<code>status.certificate</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ k get csr zhongmingmao -oyaml</span><br><span class="line">apiVersion: certificates.k8s.io/v1</span><br><span class="line">kind: CertificateSigningRequest</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">      &#123;&quot;apiVersion&quot;:&quot;certificates.k8s.io/v1&quot;,&quot;kind&quot;:&quot;CertificateSigningRequest&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;zhongmingmao&quot;&#125;,&quot;spec&quot;:&#123;&quot;expirationSeconds&quot;:8640000,&quot;request&quot;:&quot;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQzFUQ0NBYjBDQVFBd2dZOHhDekFKQmdOVkJBWVRBa05PTVJJd0VBWURWUVFJREFsSGRXRnVaMFJ2Ym1jeApFakFRQmdOVkJBY01DVnBvYjI1blUyaGhiakVQTUEwR0ExVUVDZ3dHVjJWamFHRjBNUXN3Q1FZRFZRUUxEQUpKClZERVZNQk1HQTFVRUF3d01lbWh2Ym1kdGFXNW5iV0Z2TVNNd0lRWUpLb1pJaHZjTkFRa0JGaFI2YUc5dVoyMXAKYm1kdFlXOUFNVFl6TG1OdmJUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU9OVgpHaWZvKzBwMTJ5Z2RNQ2dnREFIVW5SN2JGTG01Mkp6Qnd3Mkp0YXNSUkNnMm1qZTRSamRzMVdhN1JvdHZKQ0l0CmlLeXMzRlNES1ZmZ0pvcWdsbXJhaVVJeDl0YVgyODU0S1h4Q3RBakdpUDRURzhjdVBEMWxtNFA0bW5VelBnVWoKRGw3N0R0NzU4MTA0Sjl0S1k4WWM0TGV0ellZYmJlSTRFUGJNUzAwdmVLS1Y2UytKNjhack1BOU9mb1lid01RYgp0dmlXam1nUjhMUVBGUWo1VWIrMVdYeFBGOERWUWVOZEZacjJQMVI3WG83d2FlLzI5WlJzLzFVRUpORW9tbnpCClgrbnJxQlVSOUxjbjdxN2s4b1greHhCeEFVUW13a1BQZGMzL1R0VCtnNVF3K1dHcWt2ZG9RVy96aGFsY2pwbEoKYjJRc3hKZW1rcDJoVm1tZzZGTUNBd0VBQWFBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ1JsNXU1QjE3TwpFZ2Rxbk84NnVxVWNCcVJGSjhUTE9MVW9PQm1RMHdIWDR0RHo3WEhIdzVwTXZpTWo4WDdkczlQSkRHWEdJYjFsCmQ4Z3pzd00wVlZCdFFUUXdzTXRwaXJnSXhZWG1FckV1NzJPYmJONjBJK250YjZSKzV2czBLd0grQWN6YytWZE8KTHN6MHluaDBUSVNjaW5mQmFuckgwOE9aWWdISGlZQjdMeks4VGQyUWJQR1FMR204UUxLeHh4UGpPc2tZajJjbApLWm9JYlJ5QTNxd3ppZE5qdTg0dmxGeDdTVkZDNXU2YXhmdVVDMGJlRkErNEVpRVBqMlFkSlBIcmJJajdNVkQxClRVbm1OZ0hzRmdNUUhPekora3A2cDM3Z2pwQVp6RUQ3RVd2UVE1QnFtNDRMWGdoYS81ODFIbGFSeGFwVjIxSmEKU1NOS1NFUDdiWmliCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=&quot;,&quot;signerName&quot;:&quot;kubernetes.io/kube-apiserver-client&quot;,&quot;usages&quot;:[&quot;client auth&quot;]&#125;&#125;</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T02:36:47Z&quot;</span><br><span class="line">  name: zhongmingmao</span><br><span class="line">  resourceVersion: &quot;5832&quot;</span><br><span class="line">  uid: 88626338-2881-4f98-8570-64b3e47404e2</span><br><span class="line">spec:</span><br><span class="line">  expirationSeconds: 8640000</span><br><span class="line">  groups:</span><br><span class="line">  - system:masters</span><br><span class="line">  - system:authenticated</span><br><span class="line">  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQzFUQ0NBYjBDQVFBd2dZOHhDekFKQmdOVkJBWVRBa05PTVJJd0VBWURWUVFJREFsSGRXRnVaMFJ2Ym1jeApFakFRQmdOVkJBY01DVnBvYjI1blUyaGhiakVQTUEwR0ExVUVDZ3dHVjJWamFHRjBNUXN3Q1FZRFZRUUxEQUpKClZERVZNQk1HQTFVRUF3d01lbWh2Ym1kdGFXNW5iV0Z2TVNNd0lRWUpLb1pJaHZjTkFRa0JGaFI2YUc5dVoyMXAKYm1kdFlXOUFNVFl6TG1OdmJUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU9OVgpHaWZvKzBwMTJ5Z2RNQ2dnREFIVW5SN2JGTG01Mkp6Qnd3Mkp0YXNSUkNnMm1qZTRSamRzMVdhN1JvdHZKQ0l0CmlLeXMzRlNES1ZmZ0pvcWdsbXJhaVVJeDl0YVgyODU0S1h4Q3RBakdpUDRURzhjdVBEMWxtNFA0bW5VelBnVWoKRGw3N0R0NzU4MTA0Sjl0S1k4WWM0TGV0ellZYmJlSTRFUGJNUzAwdmVLS1Y2UytKNjhack1BOU9mb1lid01RYgp0dmlXam1nUjhMUVBGUWo1VWIrMVdYeFBGOERWUWVOZEZacjJQMVI3WG83d2FlLzI5WlJzLzFVRUpORW9tbnpCClgrbnJxQlVSOUxjbjdxN2s4b1greHhCeEFVUW13a1BQZGMzL1R0VCtnNVF3K1dHcWt2ZG9RVy96aGFsY2pwbEoKYjJRc3hKZW1rcDJoVm1tZzZGTUNBd0VBQWFBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ1JsNXU1QjE3TwpFZ2Rxbk84NnVxVWNCcVJGSjhUTE9MVW9PQm1RMHdIWDR0RHo3WEhIdzVwTXZpTWo4WDdkczlQSkRHWEdJYjFsCmQ4Z3pzd00wVlZCdFFUUXdzTXRwaXJnSXhZWG1FckV1NzJPYmJONjBJK250YjZSKzV2czBLd0grQWN6YytWZE8KTHN6MHluaDBUSVNjaW5mQmFuckgwOE9aWWdISGlZQjdMeks4VGQyUWJQR1FMR204UUxLeHh4UGpPc2tZajJjbApLWm9JYlJ5QTNxd3ppZE5qdTg0dmxGeDdTVkZDNXU2YXhmdVVDMGJlRkErNEVpRVBqMlFkSlBIcmJJajdNVkQxClRVbm1OZ0hzRmdNUUhPekora3A2cDM3Z2pwQVp6RUQ3RVd2UVE1QnFtNDRMWGdoYS81ODFIbGFSeGFwVjIxSmEKU1NOS1NFUDdiWmliCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=</span><br><span class="line">  signerName: kubernetes.io/kube-apiserver-client</span><br><span class="line">  usages:</span><br><span class="line">  - client auth</span><br><span class="line">  username: kubernetes-admin</span><br><span class="line">status:</span><br><span class="line">  certificate: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURVRENDQWppZ0F3SUJBZ0lSQVBOVmpTczBzaFFyL3YzQjZRa21GWkF3RFFZSktvWklodmNOQVFFTEJRQXcKRlRFVE1CRUdBMVVFQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBMU16QXdNak16TURaYUZ3MHlNekE1TURjdwpNak16TURaYU1Hb3hDekFKQmdOVkJBWVRBa05PTVJJd0VBWURWUVFJRXdsSGRXRnVaMFJ2Ym1jeEVqQVFCZ05WCkJBY1RDVnBvYjI1blUyaGhiakVQTUEwR0ExVUVDaE1HVjJWamFHRjBNUXN3Q1FZRFZRUUxFd0pKVkRFVk1CTUcKQTFVRUF4TU1lbWh2Ym1kdGFXNW5iV0Z2TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQwpBUUVBNDFVYUorajdTblhiS0Iwd0tDQU1BZFNkSHRzVXViblluTUhERFltMXF4RkVLRGFhTjdoR04yelZacnRHCmkyOGtJaTJJckt6Y1ZJTXBWK0FtaXFDV2F0cUpRakgyMXBmYnpuZ3BmRUswQ01hSS9oTWJ4eTQ4UFdXYmcvaWEKZFRNK0JTTU9YdnNPM3ZuelhUZ24yMHBqeGh6Z3Q2M05oaHR0NGpnUTlzeExUUzk0b3BYcEw0bnJ4bXN3RDA1KwpoaHZBeEJ1MitKYU9hQkh3dEE4VkNQbFJ2N1ZaZkU4WHdOVkI0MTBWbXZZL1ZIdGVqdkJwNy9iMWxHei9WUVFrCjBTaWFmTUZmNmV1b0ZSSDB0eWZ1cnVUeWhmN0hFSEVCUkNiQ1E4OTF6ZjlPMVA2RGxERDVZYXFTOTJoQmIvT0YKcVZ5T21VbHZaQ3pFbDZhU25hRldhYURvVXdJREFRQUJvMFl3UkRBVEJnTlZIU1VFRERBS0JnZ3JCZ0VGQlFjRApBakFNQmdOVkhSTUJBZjhFQWpBQU1COEdBMVVkSXdRWU1CYUFGRGUraDNqKzdQQ3JGV0g2Y1JxOUFRRnB6bzE2Ck1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQUJzL1R2dUhOQ0RNNDNqL21LQmlVSUNDWDhIdmYyejdYKzJyUW4KQjJjTmFSK0VHd091aTdVK3VlbDJacFgxZk1xcDB5bUg5RE43bmhrNnpEdThUVVp2YTdVT3lxQmpKejUxQnptMApBRmp0RVhxVkt1QnhtdVdpbSs4WnY5T2IwTnd6TWpKZm9qL1l5eU5aM1BhN0NrVTJuMFdYb2lxZTJRdU9rWmtqCjMrdXg5MFJjeDdxb2R1MnVKa3Q5QmJyS285UEk3cjRWQ0oxRVJVbXNUV01ydGoxWDF5V3g5RWRoTGdVbW51REQKMHFkTVVBa3cyTnNQeXRscytjY1dtZGxVMEdJRjJvNXozaEZkSHA1SE16aGM4aVhmSGRkSDFmelVuNkFTL3FIWgpaVXV0R0UrbWRzR2FNNzNlTk1yNXU3ZFVwWEpwdFhCLzJrb3NRczNWeSswaUpTVTkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: &quot;2022-05-30T02:38:06Z&quot;</span><br><span class="line">    lastUpdateTime: &quot;2022-05-30T02:38:06Z&quot;</span><br><span class="line">    message: This CSR was approved by kubectl certificate approve.</span><br><span class="line">    reason: KubectlApprove</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: Approved</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提取证书</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ k get csr zhongmingmao -o jsonpath=&#x27;&#123;.status.certificate&#125;&#x27; | base64 -d &gt; zhongmingmao.crt</span><br><span class="line"></span><br><span class="line">$ cat zhongmingmao.crt</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDUDCCAjigAwIBAgIRAPNVjSs0shQr/v3B6QkmFZAwDQYJKoZIhvcNAQELBQAw</span><br><span class="line">FTETMBEGA1UEAxMKa3ViZXJuZXRlczAeFw0yMzA1MzAwMjMzMDZaFw0yMzA5MDcw</span><br><span class="line">MjMzMDZaMGoxCzAJBgNVBAYTAkNOMRIwEAYDVQQIEwlHdWFuZ0RvbmcxEjAQBgNV</span><br><span class="line">BAcTCVpob25nU2hhbjEPMA0GA1UEChMGV2VjaGF0MQswCQYDVQQLEwJJVDEVMBMG</span><br><span class="line">A1UEAxMMemhvbmdtaW5nbWFvMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC</span><br><span class="line">AQEA41UaJ+j7SnXbKB0wKCAMAdSdHtsUubnYnMHDDYm1qxFEKDaaN7hGN2zVZrtG</span><br><span class="line">i28kIi2IrKzcVIMpV+AmiqCWatqJQjH21pfbzngpfEK0CMaI/hMbxy48PWWbg/ia</span><br><span class="line">dTM+BSMOXvsO3vnzXTgn20pjxhzgt63Nhhtt4jgQ9sxLTS94opXpL4nrxmswD05+</span><br><span class="line">hhvAxBu2+JaOaBHwtA8VCPlRv7VZfE8XwNVB410VmvY/VHtejvBp7/b1lGz/VQQk</span><br><span class="line">0SiafMFf6euoFRH0tyfuruTyhf7HEHEBRCbCQ891zf9O1P6DlDD5YaqS92hBb/OF</span><br><span class="line">qVyOmUlvZCzEl6aSnaFWaaDoUwIDAQABo0YwRDATBgNVHSUEDDAKBggrBgEFBQcD</span><br><span class="line">AjAMBgNVHRMBAf8EAjAAMB8GA1UdIwQYMBaAFDe+h3j+7PCrFWH6cRq9AQFpzo16</span><br><span class="line">MA0GCSqGSIb3DQEBCwUAA4IBAQABs/TvuHNCDM43j/mKBiUICCX8Hvf2z7X+2rQn</span><br><span class="line">B2cNaR+EGwOui7U+uel2ZpX1fMqp0ymH9DN7nhk6zDu8TUZva7UOyqBjJz51Bzm0</span><br><span class="line">AFjtEXqVKuBxmuWim+8Zv9Ob0NwzMjJfoj/YyyNZ3Pa7CkU2n0WXoiqe2QuOkZkj</span><br><span class="line">3+ux90Rcx7qodu2uJkt9BbrKo9PI7r4VCJ1ERUmsTWMrtj1X1yWx9EdhLgUmnuDD</span><br><span class="line">0qdMUAkw2NsPytls+ccWmdlU0GIF2o5z3hFdHp5HMzhc8iXfHddH1fzUn6AS/qHZ</span><br><span class="line">ZUutGE+mdsGaM73eNMr5u7dUpXJptXB/2kosQs3Vy+0iJSU9</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>

<blockquote>
<p>设置 Credential</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ k config set-credentials zhongmingmao --client-key=zhongmingmao.key --client-certificate=zhongmingmao.crt --embed-certs=true</span><br><span class="line">User &quot;zhongmingmao&quot; set.</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>~/.kube/config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EVXpNREF4TkRnME9Wb1hEVE16TURVeU56QXhORGcwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnRrCjIvRERGSXpuNmhoOVl6RFVmRzJDcXRlSzBzbTVGVkIyK0lXaXpCWk5ZVnNQbFpuN3NLL0NVYm4wdGJpUGpmUEoKUUJpUkxJZ3FCS1AydWRJanhjbUhqQ0hlSVFnOGswT3RnYXRCUTNzOEkwVVdhWW1QSXNQZWxwMllrZlkxK3Q3KwpQdUVsaHl1cE13eHJlSGFLQThTMG9Dd2NRT2g1L3piN290aXNrTDFlZzNZTWZaWjU1MWJKenBsc3hRdGdsdGp3CnBmcUU3UDBoQ2VTQkpwVmNGb1BXd3RNd2wvOVRvc1lKSC9TWU9kNnV0ZUllWFlEa1F6U3czZ2lkMHBkTitoS2EKemE2MEcvN2Q2a01aamUrQmRLMVFjenZpcE9zZWUvSHVDZklUNERtLzRiOFZuS1EwVU94QWZHRVg3UUdHcUlEMApOR0xSbXhXbVU4SnUraXFaaDkwQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZEZStoM2orN1BDckZXSDZjUnE5QVFGcHpvMTZNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRXZsWEJGRHRpQzJyK2VqSFBERgozeUxzbjA4Sjd1bENnN0xwMGJRaUxPZzIzZStjTTRzRnN0UVJadnFNYW1MU3l0U2hlZHAvVExFMnR0RlZOYnAvCkJlNVJiRGtuNWRFdFg5ejRva09IVTJ3ekFlaWZ5NnhCZEloYUdGZC9WT3B1SldBZ040aU9DVkRUQTA1OWNuTDMKSmJvVHJCNkRBdUo0a2JWNis5NGZkK001RXY1TVhiWXA2L2ExYTliMmVpWnNxbjM3djUvOWZlWU51Q3JYS0xGagprKzhvUWV0UGNEbW5TdkRrdUlteUZ0TGxjRjN1MGw1RmdwU2FQQnlWekJUckZQb25jTlcyV1ZkWWxLZ3ArWWFqCithT3JkRFNzbEVTY055R0hxTEkyS0RsTHIwWlBDQWtYSjFyRDcrenI5cFVEZC9LL1B5VFBlM3JaVWd3cjh2NjIKdFlJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.191.138:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJVWVlRlYzZjRCdjR3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBMU16QXdNVFE0TkRsYUZ3MHlOREExTWprd01UUTROVEZhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXZQOVpSS09yMWE5YjhKV2wKeWVtVzNKZVp6MGtKTXc1ZjN6UFN5dkdzbDZod3FLaDNKNXNKTTJrWXJMWUtKK25vbldmTjBCekwwclF5QTdScQpPSkJFKytsa0E2d3B4bzhOSnVITyttRHBwMnhhdHFmTWpFSEhseGV4UnlmTUUveDlDZmZsVHhPV1BUcFRqbGllCkZDQlhROTBPZmZwV3RENnM2Z2JVZXZMQzJTMStyMFJyMmhRWmE2bkxpQW9RdWhmZnJtTGJ2ZVJmblp0ZDVlS08KOUQ5SXAybmhjRE5PeWlIQWNoRlU3OW5id3JzRS9XRks5SVVtL3g1cU52WUFjS2pSUmpKSFJseUNENVdFTzBldgpYUGJjSXRZcnlHSDBBTWNkcXU5ZTc0WEFCTUNYa3VjbGs0UndkUEl1UHBMTHFJNnFTQWwvek0vdFJyQm1kL1V1ClRKbXE2d0lEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JRM3ZvZDQvdXp3cXhWaCtuRWF2UUVCYWM2TgplakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBdm1zQ3VXcWJ1ZlI2UHVFTUlrRXg5TDZFeU1zY2NhZzlqWER2CmNTY1hXNUVUSkllcW5ISmtzRVY4NEdCdDhlcGx0aGhUM1pFVUZvSURvR3FHNk1CVDFJdG5jaVlKRG5NUHZ5djAKWFBpVno4MFM3RFZhQjhwVjJvK3JjaFRmMHdSYVUvQWF4dWdtUWwzZHVUcEtYbU1DTThGQ3FpTVJYbm1veGJVUgpqTklsTGcwbjJzMXF0Tk1LVGRCSlB3dUVqdFJZMWVpU09GRGgwclFhYmZUc2dHa25SOGxCcHdDd28rWVdaMGs0CmlZaWtrT21ERnZsakZ6Z1VpcWpTRGdjRnNnUjlFWXZ1TGdtSHlJVnpxZG1NZURMandwL2NWM1VubGNoa3hsZEsKVDcyYWs5cnhzTGwrUFVGajlFZE92Y2tKanI0VFhZcWFJR2FwNWhyTDg1bEdNcTgyVXc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdlA5WlJLT3IxYTliOEpXbHllbVczSmVaejBrSk13NWYzelBTeXZHc2w2aHdxS2gzCko1c0pNMmtZckxZS0orbm9uV2ZOMEJ6TDByUXlBN1JxT0pCRSsrbGtBNndweG84Tkp1SE8rbURwcDJ4YXRxZk0KakVISGx4ZXhSeWZNRS94OUNmZmxUeE9XUFRwVGpsaWVGQ0JYUTkwT2ZmcFd0RDZzNmdiVWV2TEMyUzErcjBScgoyaFFaYTZuTGlBb1F1aGZmcm1MYnZlUmZuWnRkNWVLTzlEOUlwMm5oY0ROT3lpSEFjaEZVNzluYndyc0UvV0ZLCjlJVW0veDVxTnZZQWNLalJSakpIUmx5Q0Q1V0VPMGV2WFBiY0l0WXJ5R0gwQU1jZHF1OWU3NFhBQk1DWGt1Y2wKazRSd2RQSXVQcExMcUk2cVNBbC96TS90UnJCbWQvVXVUSm1xNndJREFRQUJBb0lCQURGR3BrQ21KOFFqMzJXLwpycVVST1JzMGo0Nmk3VG9aa2xlQWpJSUxOc09uMEErNU5LL24xU05KVUh5ZlRkQ1FST3pkUnFUdkRSbFhqLzYxClNFaU5ITjlOUDUxUmd1YlpIMFcyOUI4RnE0WFNVMmh5SVh1a0h1Uys4YUtxdHFPelhlcCticFFLZUU1b2FhYWcKWmo2N0crVit1aXVRWEpETUVvdEYwcHBudHZPbVhEUXBueE9EVHhwNkhmREdodERtdEkxb0FlSng3aXJlNFQ5Rwp3MWR1SHJDZWpuQWp5QTkwbmtnVEhNWWVSZHoxcmE4bVZqNzE5VnpYbWxyRFFYTkhDZzJFMFZ5b29GNGc4R29CCm1rTldLVTh6NUxqN05sVFEwbElsazlrbVZTZTE2V2g0MWR6dkRIbGxtdFZyVHdPWXZjNjdWY3UzVFE4Ly84bDcKbldwME9CRUNnWUVBKzlEL09nSmxoSnoyNnBTNG5mbWt3YTVUZ3NHVWJhSEttV1ZDeVBwUFNGZzRSeXNDc2U3NwpnaXV4UkxVK2F4aU9MTm5Jc1pmb1hZUzlVbXpacWFQRzRhVHhiT2RXY2RMUTdweThHZmJranVHcmlKb0FqRDZDCmFWYXRGN3k4VU5SNXg4eXZNcjgxWGRTYmdONUFuSUJ6QkZQVzFOV3VDcjVtQnE3c2tEUVpBZmtDZ1lFQXdDTXQKQW9xMmYyTGFtdWtYNUpnK3FHc3NoMG5rZzVrZ213ODVYSEJzcHFGT3B2TWhIa0RhWUtuZHBXTkVubXF3REY2UQp4Yi9aNVBWU3hGMElFS1ZhTVZ6N1N1ekk4MnBXeVlEWnNrelpwUU80d2x4a1F5Q0lwWHQzL1R4UUV3aGd6Y3A0ClJ1SDFmUVhiUURkSVpQV0FnSVY2U2lLTWwxUW0yZFp2eVVJZERRTUNnWUVBdGxxejZPdEJYdFpZVEtua1E2bzcKOEhId1Vka2pSbjBLZlNrQ1F3NVpDWmV4TVlCcEZEZHU5T1gxR2o5eDh4WTJKeTZURW1CaVNnN05GdnB5YVZHTAp2VzIzMDFoM2xqZkhTM1EvRjBKZVkwWHk5Um9vMldhUEEvOWJtN3YyVjBaMjVnUkl2eVFPWG1PUE5MUTk3OWRvCjh6SlBlWk0vMU5IcWlsNTBPejB1K3VrQ2dZQjVKM1VoVGpDSG9PRHhuNXVtVkczbUt6WjMxSnRZYy8xQWFWZ2wKTnVyOEkya0NFdnRHSldUT1lTNVhOSUkzVmxUT1orN29FdktsMGgrdm5HNFNlUUduY05jd1JxRHNCSmpYRlAydwoxWTdENDlYa0VQaFQ3N2JhaWtGK0dFTHh6VzJsTmsramVxWWVnTXZnOFRzZ0ZrSkNTR2gxU05YWU1vTVJCNHVUCm43SEwyd0tCZ1FDQlhCUWRlbWhhMmxMbDhhbEZ5Umd1dmJyOHJsbmVIc29RUEdOeEgwSVZNVVZPaWNnM1Y5bEoKZUNGdVl0dGxpRm5yRXppeHBsRTBzU1JZMzYxdkJtMzN3eXU5RXlmN2hBTy9TUTlsYWpUdDVMR0FZdkx3TDNvcgpGeFNEaFd1cVVTZGhqSGRLb0JTWXpjOEFXUkd2S2xrU0UyTjV0M2JRSFNZL2NBOUtsSDdSbEE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zhongmingmao</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURVRENDQWppZ0F3SUJBZ0lSQVBOVmpTczBzaFFyL3YzQjZRa21GWkF3RFFZSktvWklodmNOQVFFTEJRQXcKRlRFVE1CRUdBMVVFQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBMU16QXdNak16TURaYUZ3MHlNekE1TURjdwpNak16TURaYU1Hb3hDekFKQmdOVkJBWVRBa05PTVJJd0VBWURWUVFJRXdsSGRXRnVaMFJ2Ym1jeEVqQVFCZ05WCkJBY1RDVnBvYjI1blUyaGhiakVQTUEwR0ExVUVDaE1HVjJWamFHRjBNUXN3Q1FZRFZRUUxFd0pKVkRFVk1CTUcKQTFVRUF4TU1lbWh2Ym1kdGFXNW5iV0Z2TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQwpBUUVBNDFVYUorajdTblhiS0Iwd0tDQU1BZFNkSHRzVXViblluTUhERFltMXF4RkVLRGFhTjdoR04yelZacnRHCmkyOGtJaTJJckt6Y1ZJTXBWK0FtaXFDV2F0cUpRakgyMXBmYnpuZ3BmRUswQ01hSS9oTWJ4eTQ4UFdXYmcvaWEKZFRNK0JTTU9YdnNPM3ZuelhUZ24yMHBqeGh6Z3Q2M05oaHR0NGpnUTlzeExUUzk0b3BYcEw0bnJ4bXN3RDA1KwpoaHZBeEJ1MitKYU9hQkh3dEE4VkNQbFJ2N1ZaZkU4WHdOVkI0MTBWbXZZL1ZIdGVqdkJwNy9iMWxHei9WUVFrCjBTaWFmTUZmNmV1b0ZSSDB0eWZ1cnVUeWhmN0hFSEVCUkNiQ1E4OTF6ZjlPMVA2RGxERDVZYXFTOTJoQmIvT0YKcVZ5T21VbHZaQ3pFbDZhU25hRldhYURvVXdJREFRQUJvMFl3UkRBVEJnTlZIU1VFRERBS0JnZ3JCZ0VGQlFjRApBakFNQmdOVkhSTUJBZjhFQWpBQU1COEdBMVVkSXdRWU1CYUFGRGUraDNqKzdQQ3JGV0g2Y1JxOUFRRnB6bzE2Ck1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQUJzL1R2dUhOQ0RNNDNqL21LQmlVSUNDWDhIdmYyejdYKzJyUW4KQjJjTmFSK0VHd091aTdVK3VlbDJacFgxZk1xcDB5bUg5RE43bmhrNnpEdThUVVp2YTdVT3lxQmpKejUxQnptMApBRmp0RVhxVkt1QnhtdVdpbSs4WnY5T2IwTnd6TWpKZm9qL1l5eU5aM1BhN0NrVTJuMFdYb2lxZTJRdU9rWmtqCjMrdXg5MFJjeDdxb2R1MnVKa3Q5QmJyS285UEk3cjRWQ0oxRVJVbXNUV01ydGoxWDF5V3g5RWRoTGdVbW51REQKMHFkTVVBa3cyTnNQeXRscytjY1dtZGxVMEdJRjJvNXozaEZkSHA1SE16aGM4aVhmSGRkSDFmelVuNkFTL3FIWgpaVXV0R0UrbWRzR2FNNzNlTk1yNXU3ZFVwWEpwdFhCLzJrb3NRczNWeSswaUpTVTkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBNDFVYUorajdTblhiS0Iwd0tDQU1BZFNkSHRzVXViblluTUhERFltMXF4RkVLRGFhCk43aEdOMnpWWnJ0R2kyOGtJaTJJckt6Y1ZJTXBWK0FtaXFDV2F0cUpRakgyMXBmYnpuZ3BmRUswQ01hSS9oTWIKeHk0OFBXV2JnL2lhZFRNK0JTTU9YdnNPM3ZuelhUZ24yMHBqeGh6Z3Q2M05oaHR0NGpnUTlzeExUUzk0b3BYcApMNG5yeG1zd0QwNStoaHZBeEJ1MitKYU9hQkh3dEE4VkNQbFJ2N1ZaZkU4WHdOVkI0MTBWbXZZL1ZIdGVqdkJwCjcvYjFsR3ovVlFRazBTaWFmTUZmNmV1b0ZSSDB0eWZ1cnVUeWhmN0hFSEVCUkNiQ1E4OTF6ZjlPMVA2RGxERDUKWWFxUzkyaEJiL09GcVZ5T21VbHZaQ3pFbDZhU25hRldhYURvVXdJREFRQUJBb0lCQVFEQlY0MnBSOU1BM3YrSApQRnZLcEliUnY3dnBsRFlxUjA5YzhzWXJhMldnbWt5M1Rza1dmcGpwWnB5UWhOSllvQ3ZCRGF6aC94cGNuamk1ClRpQTVZcDdMUGhYaXdJL0lydHI0M09XYmt6ZC9CeXRYdTNTeWtEWVhtYVVNTnBGWEFEL05LcVY4VGxXMWVpdHEKcXVucTdYZXg5TG1DUGtVL3UzQlhKNHYxK29aSW0yN0tXNk5vYmlqTmF6bkdWSmMrdUZSdUE4T25pbHdCc1d0dAoxa2Z1RCtSbmM3Rm1EL29jTER4OVNPN3NzaHJrekNRa2ZxR1kxeXdlOW1HTVhNUjNWdlM4MUg1TE5IbmhEK2xpCkt0QWxCVVZLR3ZIRTF1b21RLy9jM09vSlI0WTIvU0dJY01QYVVaaUFCUitFUy9vWXdvMlZnUXNZcGl0U3V0QU8KWC9qWmhXc1JBb0dCQVBJVWtPekNrNGtwS1M0Nld4ekhLMHRlWEFjZW9PZnBtWjJYd3Qwc3YyaHZXSkI4Ti8yeApGQndyT1A4UjJtcGNrNTR1SXJQZjdpeThZYnFEUURZTW16ZGxJbStiQUViQVkwRnIxdGx2SFoxdlZLRW9raUt4CldWaTVKNXdlZjRTMTVmK2p3Wjg2SVBGcGt0bnpBVDhGaUxKYldiNld2RUJWR01nRTVpeFVLSVB0QW9HQkFQQm4KY2ptY3RsOW1zL3JBYU5WMmhTZFErRE1ld3V0SlYzK2VpNFRUcUJvOW5Sd1JxQXRXQVpMZ2MzaVdQVjhMc2l6bAppMk9ZT3FqQjF1ejBGMlF3bHV2dlF3ZCtwVUFrL1pPN043Z3dMd3hXNzlVVyswa3R4cUh0ODNJVDMvTDhwSWhjCkM2ODg0MVlPdEJJc051UnVTaUJZYno0TG1DQkcrTDBLdzVCVmJoVS9Bb0dBT3FoUkZZMXdRbVArM255MVp4dTcKbWQrYlhQNUc3dXJqbGhRWDI0L2tNV0lKaTdrTnVDTVlSRnNVekhsKyt4YkRqaWlQc0JZcW1CeHRjY3dyMnV6agpEMkVxSHZEbitEelYwQnhaU3dacG5xUkRWV21IUDNESnZYM2Y0eXhncWIrSm81QUNjcHFiTU9QcitYT3djWnpkCnFwb0gvTzU1WHYwL3EvZkQ3aW5XUjJFQ2dZQWYvWlFNcUpiNE1RR0lQNnh6bzNicW1YSzkwcjBiZEVJSmdINk8KYVYvNFJmU3ZOSVpKSStQSHVNaUU1bkU2UWFNdktFaVpNenV6RTBCWGZjL1RERWc1RXppM09ab2g1QW8rYTI1cAp1emUzaTZZVWxCOVNTSjRqRkRnT0dTajIrN21sVDZKYWFsN1NKOWk4aGxlenBCMkhHbDJMUXgyMlJkdDV4SUhyCnBnS2xId0tCZ0ZLaXhhdlBJL0dQeXN1bFcxd0ZoYnZ3Z1hxTDQwQXllK2hJNytRNmUzUC9PZldDOHBBQUJuYmoKU09ZRFhRVmYrM09VM2MzTkJEZDYrTCt5b3Uzdk10WWpJdkExT281UEhVQVpSdkZKQVBIK3dxWmNLYlJTb3FFVQoxR1JxOXNVMnJoYmZpSDRkVFZkVFR3T2pSdmFJU0ZqSE1kT20wdmVzVGc3K1lUbDBDWWVRCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>授权</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k create role developer --verb=create --verb=get --verb=list --verb=update --verb=delete --resource=pods</span><br><span class="line">role.rbac.authorization.k8s.io/developer created</span><br><span class="line"></span><br><span class="line">$ k create rolebinding developer-binding-zhongmingmao --role=developer --user=zhongmingmao</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/developer-binding-zhongmingmao created</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k get po --user zhongmingmao</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-6799fc88d8-4ppnm   1/1     Running   0          40d</span><br><span class="line">nginx-deployment-6799fc88d8-j5rnt   1/1     Running   0          40d</span><br><span class="line">nginx-deployment-6799fc88d8-ltc2g   1/1     Running   0          40d</span><br></pre></td></tr></table></figure>

<h2 id="静态-Token-文件"><a href="#静态-Token-文件" class="headerlink" title="静态 Token 文件"></a>静态 Token 文件</h2><blockquote>
<p>static-token.csv</p>
</blockquote>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob-token,bob,1000,&quot;group1,group2,group3&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>备份 API Server</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp /etc/kubernetes/manifests/kube-apiserver.yaml ~/kube-apiserver.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改 kube-apiserver.yaml</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>kube-apiserver-static-token.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--token-auth-file=/etc/kubernetes/auth/static-token.csv</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver:v1.22.2</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/auth</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">auth-files</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/home/zhongmingmao/api-server/basic-auth/static-token</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-files</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>API Server 重新启动</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp ~/kube-apiserver-static-token.yaml /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">$ k get po -n kube-system -owide</span><br><span class="line">NAME                              READY   STATUS    RESTARTS        AGE   IP                NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">...</span><br><span class="line">kube-apiserver-mac-k8s            1/1     Running   0               31s   192.168.191.138   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>HTTP 请求，认证成功，但鉴权失败</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ k get ns -v 9</span><br><span class="line">I0709 14:48:36.258397  190678 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0709 14:48:36.261775  190678 round_trippers.go:435] curl -v -XGET  -H &quot;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces?limit=500&#x27;</span><br><span class="line">I0709 14:48:36.268819  190678 round_trippers.go:454] GET https://192.168.191.138:6443/api/v1/namespaces?limit=500 200 OK in 7 milliseconds</span><br><span class="line">I0709 14:48:36.268840  190678 round_trippers.go:460] Response Headers:</span><br><span class="line">I0709 14:48:36.268844  190678 round_trippers.go:463]     Audit-Id: f1f1160e-abf2-4a53-ab29-c90afc02bd41</span><br><span class="line">I0709 14:48:36.268848  190678 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0709 14:48:36.268850  190678 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0709 14:48:36.268852  190678 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0709 14:48:36.268855  190678 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0709 14:48:36.268857  190678 round_trippers.go:463]     Date: Sun, 09 Jul 2022 14:48:36 GMT</span><br><span class="line">I0709 14:48:36.268909  190678 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;Table&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;resourceVersion&quot;:&quot;11118&quot;&#125;,&quot;columnDefinitions&quot;:[&#123;&quot;name&quot;:&quot;Name&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;name&quot;,&quot;description&quot;:&quot;Name must be unique within a namespace. Is required when creating resources, although some resources may allow a client to request the generation of an appropriate name automatically. Name is primarily intended for creation idempotence and configuration definition. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/identifiers#names&quot;,&quot;priority&quot;:0&#125;,&#123;&quot;name&quot;:&quot;Status&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;&quot;,&quot;description&quot;:&quot;The status of the namespace&quot;,&quot;priority&quot;:0&#125;,&#123;&quot;name&quot;:&quot;Age&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;&quot;,&quot;description&quot;:&quot;CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.\n\nPopulated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&quot;,&quot;priority&quot;:0&#125;],&quot;rows&quot;:[&#123;&quot;cells&quot;:[&quot;calico-apiserver&quot;,&quot;Active&quot;,&quot;40d&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;calico-apiserver&quot;,&quot;uid&quot;:&quot;33a910d7-092f-4e78-9e1f-c50b68859197&quot;,&quot;resourceVersion&quot;:&quot;1714&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:58:40Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;calico-apiserver&quot;,&quot;name&quot;:&quot;calico-apiserver&quot;,&quot;pod-security.kubernetes.io/enforce&quot;:&quot;privileged&quot;,&quot;pod-security.kubernetes.io/enforce-version&quot;:&quot;latest&quot;&#125;,&quot;ownerReferences&quot;:[&#123;&quot;apiVersion&quot;:&quot;operator.tigera.io/v1&quot;,&quot;kind&quot;:&quot;APIServer&quot;,&quot;name&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;c76efece-7a9b-4a53-a6cd-84e4ca42a86b&quot;,&quot;controller&quot;:true,&quot;blockOwnerDeletion&quot;:true&#125;],&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;operator&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:58:40Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;,&quot;f:name&quot;:&#123;&#125;,&quot;f:pod-security.kubernetes.io/enforce&quot;:&#123;&#125;,&quot;f:pod-security.kubernetes.io/enforce-version&quot;:&#123;&#125;&#125;,&quot;f:ownerReferences&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;k:&#123;\&quot;uid\&quot;:\&quot;c76efece-7a9b-4a53-a6cd-84e4ca42a86b\&quot;&#125;&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;,&#123;&quot;cells&quot;:[&quot;calico-system&quot;,&quot;Active&quot;,&quot;40d&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;calico-system&quot;,&quot;uid&quot;:&quot;02b13986-afdf-479e-8feb-476f57aee42b&quot;,&quot;resourceVersion&quot;:&quot;606&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:50:02Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;calico-system&quot;,&quot;name&quot;:&quot;calico-system&quot;,&quot;pod-security.kubernetes.io/enforce&quot;:&quot;privileged&quot;,&quot;pod-security.kubernetes.io/enforce-version&quot;:&quot;latest&quot;&#125;,&quot;ownerReferences&quot;:[&#123;&quot;apiVersion&quot;:&quot;operator.tigera.io/v1&quot;,&quot;kind&quot;:&quot;Installation&quot;,&quot;name&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;0d76a67f-5bf6-4a8e-8964-0ac1e31aa4b9&quot;,&quot;controller&quot;:true,&quot;blockOwnerDeletion&quot;:true&#125;],&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;operator&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:50:02Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;,&quot;f:name&quot;:&#123;&#125;,&quot;f:pod-security.kubernetes.io/enforce&quot;:&#123;&#125;,&quot;f:pod-security.kubernetes.io/enforce-version&quot;:&#123;&#125;&#125;,&quot;f:ownerReferences&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;k:&#123;\&quot;uid\&quot;:\&quot;0d76a67f-5bf6-4a8e-8964-0ac1e31aa4b9\&quot;&#125;&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;,&#123;&quot;cells&quot;:[&quot;default&quot;,&quot;Active&quot;,&quot;40d&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;c3b0eddd-c1de-4ea6-87ac-079b96ea14a5&quot;,&quot;resourceVersion&quot;:&quot;192&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:48:56Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;default&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-apiserver&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:48:56Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;,&#123;&quot;cells&quot;:[&quot;kube-node-lease&quot;,&quot;Active&quot;,&quot;40d&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;kube-node-lease&quot;,&quot;uid&quot;:&quot;c803e423-a003-466d-a55f-9e6d6e0e2218&quot;,&quot;resourceVersion&quot;:&quot;12&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:48:55Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;kube-node-lease&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-apiserver&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:48:55Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;,&#123;&quot;cells&quot;:[&quot;kube-public&quot;,&quot;Active&quot;,&quot;40d&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;kube-public&quot;,&quot;uid&quot;:&quot;864f84bb-b97a-4a75-9204-09e3b023bd45&quot;,&quot;resourceVersion&quot;:&quot;10&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:48:55Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;kube-public&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-apiserver&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:48:55Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;,&#123;&quot;cells&quot;:[&quot;kube-system&quot;,&quot;Active&quot;,&quot;40d&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;kube-system&quot;,&quot;uid&quot;:&quot;fbc10fd8-1985-4be0-9684-2ddca0ae3e27&quot;,&quot;resourceVersion&quot;:&quot;8&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:48:54Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;kube-system&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-apiserver&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:48:54Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;,&#123;&quot;cells&quot;:[&quot;tigera-operator&quot;,&quot;Active&quot;,&quot;40d&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;tigera-operator&quot;,&quot;uid&quot;:&quot;5353e7cf-440d-493c-893d-1bea5eba3fdc&quot;,&quot;resourceVersion&quot;:&quot;455&quot;,&quot;creationTimestamp&quot;:&quot;2022-05-30T01:49:22Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;tigera-operator&quot;,&quot;name&quot;:&quot;tigera-operator&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kubectl-create&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-05-30T01:49:22Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;,&quot;f:name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;]&#125;</span><br><span class="line">NAME               STATUS   AGE</span><br><span class="line">calico-apiserver   Active   40d</span><br><span class="line">calico-system      Active   40d</span><br><span class="line">default            Active   40d</span><br><span class="line">kube-node-lease    Active   40d</span><br><span class="line">kube-public        Active   40d</span><br><span class="line">kube-system        Active   40d</span><br><span class="line">tigera-operator    Active   40d</span><br><span class="line"></span><br><span class="line">$ curl -k -XGET -H &#x27;Authorization: Bearer bob-token&#x27; &#x27;https://192.168.191.138:6443/api/v1/namespaces?limit=500&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;namespaces is forbidden: User \&quot;bob\&quot; cannot list resource \&quot;namespaces\&quot; in API group \&quot;\&quot; at the cluster scope&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;kind&quot;: &quot;namespaces&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>kubeconfig</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>~/.kube/config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EVXpNREF4TkRnME9Wb1hEVE16TURVeU56QXhORGcwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnRrCjIvRERGSXpuNmhoOVl6RFVmRzJDcXRlSzBzbTVGVkIyK0lXaXpCWk5ZVnNQbFpuN3NLL0NVYm4wdGJpUGpmUEoKUUJpUkxJZ3FCS1AydWRJanhjbUhqQ0hlSVFnOGswT3RnYXRCUTNzOEkwVVdhWW1QSXNQZWxwMllrZlkxK3Q3KwpQdUVsaHl1cE13eHJlSGFLQThTMG9Dd2NRT2g1L3piN290aXNrTDFlZzNZTWZaWjU1MWJKenBsc3hRdGdsdGp3CnBmcUU3UDBoQ2VTQkpwVmNGb1BXd3RNd2wvOVRvc1lKSC9TWU9kNnV0ZUllWFlEa1F6U3czZ2lkMHBkTitoS2EKemE2MEcvN2Q2a01aamUrQmRLMVFjenZpcE9zZWUvSHVDZklUNERtLzRiOFZuS1EwVU94QWZHRVg3UUdHcUlEMApOR0xSbXhXbVU4SnUraXFaaDkwQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZEZStoM2orN1BDckZXSDZjUnE5QVFGcHpvMTZNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRXZsWEJGRHRpQzJyK2VqSFBERgozeUxzbjA4Sjd1bENnN0xwMGJRaUxPZzIzZStjTTRzRnN0UVJadnFNYW1MU3l0U2hlZHAvVExFMnR0RlZOYnAvCkJlNVJiRGtuNWRFdFg5ejRva09IVTJ3ekFlaWZ5NnhCZEloYUdGZC9WT3B1SldBZ040aU9DVkRUQTA1OWNuTDMKSmJvVHJCNkRBdUo0a2JWNis5NGZkK001RXY1TVhiWXA2L2ExYTliMmVpWnNxbjM3djUvOWZlWU51Q3JYS0xGagprKzhvUWV0UGNEbW5TdkRrdUlteUZ0TGxjRjN1MGw1RmdwU2FQQnlWekJUckZQb25jTlcyV1ZkWWxLZ3ArWWFqCithT3JkRFNzbEVTY055R0hxTEkyS0RsTHIwWlBDQWtYSjFyRDcrenI5cFVEZC9LL1B5VFBlM3JaVWd3cjh2NjIKdFlJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.191.138:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">zhongmingmao</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhongmingmao@kubernetes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">bob</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bob@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJVWVlRlYzZjRCdjR3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBMU16QXdNVFE0TkRsYUZ3MHlOREExTWprd01UUTROVEZhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXZQOVpSS09yMWE5YjhKV2wKeWVtVzNKZVp6MGtKTXc1ZjN6UFN5dkdzbDZod3FLaDNKNXNKTTJrWXJMWUtKK25vbldmTjBCekwwclF5QTdScQpPSkJFKytsa0E2d3B4bzhOSnVITyttRHBwMnhhdHFmTWpFSEhseGV4UnlmTUUveDlDZmZsVHhPV1BUcFRqbGllCkZDQlhROTBPZmZwV3RENnM2Z2JVZXZMQzJTMStyMFJyMmhRWmE2bkxpQW9RdWhmZnJtTGJ2ZVJmblp0ZDVlS08KOUQ5SXAybmhjRE5PeWlIQWNoRlU3OW5id3JzRS9XRks5SVVtL3g1cU52WUFjS2pSUmpKSFJseUNENVdFTzBldgpYUGJjSXRZcnlHSDBBTWNkcXU5ZTc0WEFCTUNYa3VjbGs0UndkUEl1UHBMTHFJNnFTQWwvek0vdFJyQm1kL1V1ClRKbXE2d0lEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JRM3ZvZDQvdXp3cXhWaCtuRWF2UUVCYWM2TgplakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBdm1zQ3VXcWJ1ZlI2UHVFTUlrRXg5TDZFeU1zY2NhZzlqWER2CmNTY1hXNUVUSkllcW5ISmtzRVY4NEdCdDhlcGx0aGhUM1pFVUZvSURvR3FHNk1CVDFJdG5jaVlKRG5NUHZ5djAKWFBpVno4MFM3RFZhQjhwVjJvK3JjaFRmMHdSYVUvQWF4dWdtUWwzZHVUcEtYbU1DTThGQ3FpTVJYbm1veGJVUgpqTklsTGcwbjJzMXF0Tk1LVGRCSlB3dUVqdFJZMWVpU09GRGgwclFhYmZUc2dHa25SOGxCcHdDd28rWVdaMGs0CmlZaWtrT21ERnZsakZ6Z1VpcWpTRGdjRnNnUjlFWXZ1TGdtSHlJVnpxZG1NZURMandwL2NWM1VubGNoa3hsZEsKVDcyYWs5cnhzTGwrUFVGajlFZE92Y2tKanI0VFhZcWFJR2FwNWhyTDg1bEdNcTgyVXc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdlA5WlJLT3IxYTliOEpXbHllbVczSmVaejBrSk13NWYzelBTeXZHc2w2aHdxS2gzCko1c0pNMmtZckxZS0orbm9uV2ZOMEJ6TDByUXlBN1JxT0pCRSsrbGtBNndweG84Tkp1SE8rbURwcDJ4YXRxZk0KakVISGx4ZXhSeWZNRS94OUNmZmxUeE9XUFRwVGpsaWVGQ0JYUTkwT2ZmcFd0RDZzNmdiVWV2TEMyUzErcjBScgoyaFFaYTZuTGlBb1F1aGZmcm1MYnZlUmZuWnRkNWVLTzlEOUlwMm5oY0ROT3lpSEFjaEZVNzluYndyc0UvV0ZLCjlJVW0veDVxTnZZQWNLalJSakpIUmx5Q0Q1V0VPMGV2WFBiY0l0WXJ5R0gwQU1jZHF1OWU3NFhBQk1DWGt1Y2wKazRSd2RQSXVQcExMcUk2cVNBbC96TS90UnJCbWQvVXVUSm1xNndJREFRQUJBb0lCQURGR3BrQ21KOFFqMzJXLwpycVVST1JzMGo0Nmk3VG9aa2xlQWpJSUxOc09uMEErNU5LL24xU05KVUh5ZlRkQ1FST3pkUnFUdkRSbFhqLzYxClNFaU5ITjlOUDUxUmd1YlpIMFcyOUI4RnE0WFNVMmh5SVh1a0h1Uys4YUtxdHFPelhlcCticFFLZUU1b2FhYWcKWmo2N0crVit1aXVRWEpETUVvdEYwcHBudHZPbVhEUXBueE9EVHhwNkhmREdodERtdEkxb0FlSng3aXJlNFQ5Rwp3MWR1SHJDZWpuQWp5QTkwbmtnVEhNWWVSZHoxcmE4bVZqNzE5VnpYbWxyRFFYTkhDZzJFMFZ5b29GNGc4R29CCm1rTldLVTh6NUxqN05sVFEwbElsazlrbVZTZTE2V2g0MWR6dkRIbGxtdFZyVHdPWXZjNjdWY3UzVFE4Ly84bDcKbldwME9CRUNnWUVBKzlEL09nSmxoSnoyNnBTNG5mbWt3YTVUZ3NHVWJhSEttV1ZDeVBwUFNGZzRSeXNDc2U3NwpnaXV4UkxVK2F4aU9MTm5Jc1pmb1hZUzlVbXpacWFQRzRhVHhiT2RXY2RMUTdweThHZmJranVHcmlKb0FqRDZDCmFWYXRGN3k4VU5SNXg4eXZNcjgxWGRTYmdONUFuSUJ6QkZQVzFOV3VDcjVtQnE3c2tEUVpBZmtDZ1lFQXdDTXQKQW9xMmYyTGFtdWtYNUpnK3FHc3NoMG5rZzVrZ213ODVYSEJzcHFGT3B2TWhIa0RhWUtuZHBXTkVubXF3REY2UQp4Yi9aNVBWU3hGMElFS1ZhTVZ6N1N1ekk4MnBXeVlEWnNrelpwUU80d2x4a1F5Q0lwWHQzL1R4UUV3aGd6Y3A0ClJ1SDFmUVhiUURkSVpQV0FnSVY2U2lLTWwxUW0yZFp2eVVJZERRTUNnWUVBdGxxejZPdEJYdFpZVEtua1E2bzcKOEhId1Vka2pSbjBLZlNrQ1F3NVpDWmV4TVlCcEZEZHU5T1gxR2o5eDh4WTJKeTZURW1CaVNnN05GdnB5YVZHTAp2VzIzMDFoM2xqZkhTM1EvRjBKZVkwWHk5Um9vMldhUEEvOWJtN3YyVjBaMjVnUkl2eVFPWG1PUE5MUTk3OWRvCjh6SlBlWk0vMU5IcWlsNTBPejB1K3VrQ2dZQjVKM1VoVGpDSG9PRHhuNXVtVkczbUt6WjMxSnRZYy8xQWFWZ2wKTnVyOEkya0NFdnRHSldUT1lTNVhOSUkzVmxUT1orN29FdktsMGgrdm5HNFNlUUduY05jd1JxRHNCSmpYRlAydwoxWTdENDlYa0VQaFQ3N2JhaWtGK0dFTHh6VzJsTmsramVxWWVnTXZnOFRzZ0ZrSkNTR2gxU05YWU1vTVJCNHVUCm43SEwyd0tCZ1FDQlhCUWRlbWhhMmxMbDhhbEZ5Umd1dmJyOHJsbmVIc29RUEdOeEgwSVZNVVZPaWNnM1Y5bEoKZUNGdVl0dGxpRm5yRXppeHBsRTBzU1JZMzYxdkJtMzN3eXU5RXlmN2hBTy9TUTlsYWpUdDVMR0FZdkx3TDNvcgpGeFNEaFd1cVVTZGhqSGRLb0JTWXpjOEFXUkd2S2xrU0UyTjV0M2JRSFNZL2NBOUtsSDdSbEE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zhongmingmao</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURSekNDQWkrZ0F3SUJBZ0lSQUp4QWk4UkwvLzhWb0FVdVphUHpmcXN3RFFZSktvWklodmNOQVFFTEJRQXcKRlRFVE1CRUdBMVVFQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBMU16QXdNak0zTkRKYUZ3MHlNekEyTURrdwpNak0zTkRKYU1HRXhDekFKQmdOVkJBWVRBa05PTVJJd0VBWURWUVFJRXdsSGRXRnVaMFJ2Ym1jeEVqQVFCZ05WCkJBY1RDVWQxWVc1bldtaHZkVEVQTUEwR0ExVUVDaE1HVjJWamFHRjBNUXN3Q1FZRFZRUUxFd0pKVkRFTU1Bb0cKQTFVRUF4TURTemhUTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUE4akJ1eU5ZTApBdHlzMStzM3N4TWxWSXpTVWFkZkhvY1poSVRXbE1rTGNpbnpWTjdmNThzRGwxays5ZmIyTHVXU3A5U0xSWDBoCko5KzAyVDNLYlRDTmcycVQ3bzRoZkJzTzBISGdVUXZDck95ZlhNQTAwOExNU0d5QVNvR3RiczEzQ3NLbWV3eXQKMFdnbHJCVFRudUJuS25JYzZTeldOcXVmREhrdlZ0K3lTWS9GTmtkZzZaK1ViQWhzcHhramsrRE5IRmxGZndQdApYQ3N6Q1prUmJIeTFyVU5RMmlPQzEwSzZPY2puSEQ1cWhSN3B3N1pvRHQ4cjNHUlFTeXFFajVjWUlqS2lYYk1ZCkl4MWNLb3pvTGw4djJ3Tms2QzB0UHZZS3Zoa0VxYnl1Lzl1Qmc5Y2ZTWjJOZkcrZG9rb3l1QTRXdlNXTnZ5algKVXlPVkYyaGdsOVF5aXdJREFRQUJvMFl3UkRBVEJnTlZIU1VFRERBS0JnZ3JCZ0VGQlFjREFqQU1CZ05WSFJNQgpBZjhFQWpBQU1COEdBMVVkSXdRWU1CYUFGRGUraDNqKzdQQ3JGV0g2Y1JxOUFRRnB6bzE2TUEwR0NTcUdTSWIzCkRRRUJDd1VBQTRJQkFRQ2tjUnhIZFQ4TTIxcmsvN1EyM1AraUZzSG9OeGdBSlROV29ZUUJZK3lyeFBWT2dOR1kKZkE2anlreVRUQ0cxN2gxbnEwYmw5L1BkM041VEo1OWRhN0hHc0I5TDBCaVBTclhpbHhuejZyVFZQZmJNS0svTQpocFVmbnY1eWUvR1AvWG1uQnN0SkFKYW1qb25pd0V6Ymk4N0g5dFZ6SEtNRGVFMmc2QWh4bzlzOVA0MW51bDY1ClQrdEw3UFJXbmdBTmIwMkFhZE5TanBpK1BWNHdkVkVUeG9vdVlBT1RGTFVXMzV0WTExbkpOY1FhQjFUVEQ4SGYKRS85aGppRFpuM3cwVFQ5M01MMmdoWXU0UzRibjVhOXdWVW9jU2pwbUdFMkVoL3UxOGJpWjNRSERhMmZSdzM2VQpBVGtEOWs2aGhudHZ1cXhSZUx6eFRBbGYyaVRSN0NWOGx6M1QKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBOGpCdXlOWUxBdHlzMStzM3N4TWxWSXpTVWFkZkhvY1poSVRXbE1rTGNpbnpWTjdmCjU4c0RsMWsrOWZiMkx1V1NwOVNMUlgwaEo5KzAyVDNLYlRDTmcycVQ3bzRoZkJzTzBISGdVUXZDck95ZlhNQTAKMDhMTVNHeUFTb0d0YnMxM0NzS21ld3l0MFdnbHJCVFRudUJuS25JYzZTeldOcXVmREhrdlZ0K3lTWS9GTmtkZwo2WitVYkFoc3B4a2prK0ROSEZsRmZ3UHRYQ3N6Q1prUmJIeTFyVU5RMmlPQzEwSzZPY2puSEQ1cWhSN3B3N1pvCkR0OHIzR1JRU3lxRWo1Y1lJaktpWGJNWUl4MWNLb3pvTGw4djJ3Tms2QzB0UHZZS3Zoa0VxYnl1Lzl1Qmc5Y2YKU1oyTmZHK2Rva295dUE0V3ZTV052eWpYVXlPVkYyaGdsOVF5aXdJREFRQUJBb0lCQUZ5TG0xbk5TTW5nTDRBVwpsdU1yOXNEWFN1cit6UDhxV3RyanMrZUk1NEhKZS8wN2FVMzJxcm1qMWNaQmg1TW1FS05uT1l6bElzMU0wNXVMCjNCVmJUMGdmYXNYbXMrN3JtLzZVOVVXaSs5SCtYV3NnMjA3c0Nnbkd4RU0wU0dTbHlNNW8wUnNHSGtsOXhaOTcKR2Q2Rkc0Y0JzZ0I4TEtNWmM1NWRsSFJhNkpMb3lmNFZQSnhtWXNBSVpDL0I0N2pWNTVpZ0ZJc1lQQ3BkRkRMaQo5WmZNQUl3aW1IYk1jR0dBbnhCemlaTCswWFZFenFxV1ZIM3NDc2cvTnM3S2thZUJKYlpGdUZBTW1UVjdOMk8yCm1YZDJwN3h0TWJqWmJoOVcwZFBrcmZ4aWdQTEo5WmRVWVFnamVPUk1SQXlJcjlseDAwWGdzR3VKUDA1eWxKQ3gKYnlyT05oa0NnWUVBL1BBNjZ6YVZadS9aVHJkWmR3eWZPTFdUZXBXWFkxUk92djcxbDVKVzNtNFJIUzBhZVhvUQp3SVhPSlFldXU2cW9pdXVKTHhXOStPdEZCWWsvMndSR1AzSXpab2lzRGlOWFBobmhwVzc5bm00dlEzcGxUclEwCjFOOFFTTG43SDd5RmJTN0FPelhmQnRTTzY4bGhWUUpRQjA5b0trdGFhbDRPZEhSaVk1N0JPSGNDZ1lFQTlSN2sKKytIdUZiNk9oOTZ5YTdpVlNXSkp6WjUwZlZRT2VkNWlWWFo3dnhtZ2s5QlFXS2p4ZkpIWE9ZaTI3clpBZW9NeQpub0tHRTZzbVd1dEliWTd0SlIzQUxRV3Y1b2xuZUNxTllQYmpPaWZPdmVuRVVvbkRoTnpmTzNzaVBXWWZ3NHFxCldIbDQrNHFPNXMvTFAyOVZiOHhtVjNCUVRaUGc4NzlVU3hjWDc0MENnWUVBamxKdUZLT2w5VUhJT0s2YVBJNXgKbU9zeWpLdFhmNkNVbm91L2pRWGVzMUdqZDVORmJrenMyQ2R5RXd2N21jVXhDTm4zV3ZNVTdkY1VBMFZ6RkwyVworV1E4MzlqUFZ6VXpoZEh5VWEvZUxTTTZuUEZseDU5R2l2RG9yTU5aTmtaUm5Wbk0rSVFiZGpCc0t1Z3BTRGdBCjU5d2FkSkhwMGlnU1loeUtzQnRJQllrQ2dZQmRuQUxPdnFWeDRHZ0dNMkhvQ1lIWm1KT2UxdGlkMURBREVvNXoKSE9COVJvZ3dhdW1FTW1DbXRmdC9tVnBqSjI3UVdySkdIb3Fka0VzQmhjRVBOZm9TcHAzeGs2NXRXQ1FQbkJDSgo2ejh6d21nTjF1eUdxTjNtSzRPRTc2MVB6V1JzQk5TeEhSSzYzVnRkZ2hXWWtDZ01uZjZuZmRqdEI0QnRGYkJYClRPWnpNUUtCZ1FDY2x3Szc2Q1FNd0dnMUI5QThtVzF3T0JkL0thZnFwVjM3ZmJTWnpTclNEWS9JL1dVVUY2cEEKUlYxZW9QZGJXWkhFbGJDa1I1WUFmZ0NtMGlDU2k5cVo1Qk9GYXZSR2pZUjV2TmpncVYrOTFPNXJrNS9ZaDdQego4RDg3bFYrSXgxZDJGYzRWQUhwbmFKYU8vNUpPbDc4VHRZTUxlSXF3WHFaMndOQUxjbENUL1E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bob</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">token:</span> <span class="string">bob-token</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ k --context bob@kubernetes get ns -v 9</span><br><span class="line">I0709 14:57:16.719670  200344 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0709 14:57:16.724036  200344 round_trippers.go:435] curl -v -XGET  -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; -H &quot;Authorization: Bearer &lt;masked&gt;&quot; -H &quot;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces?limit=500&#x27;</span><br><span class="line">I0709 14:57:16.733048  200344 round_trippers.go:454] GET https://192.168.191.138:6443/api/v1/namespaces?limit=500 403 Forbidden in 8 milliseconds</span><br><span class="line">I0709 14:57:16.733063  200344 round_trippers.go:460] Response Headers:</span><br><span class="line">I0709 14:57:16.733067  200344 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0709 14:57:16.733069  200344 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0709 14:57:16.733071  200344 round_trippers.go:463]     X-Content-Type-Options: nosniff</span><br><span class="line">I0709 14:57:16.733076  200344 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 84f57e61-82e8-4f42-8861-47bb3567f5a5</span><br><span class="line">I0709 14:57:16.733078  200344 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: 1cbf0b91-b742-402a-bcac-abf19ff1ed1a</span><br><span class="line">I0709 14:57:16.733080  200344 round_trippers.go:463]     Content-Length: 258</span><br><span class="line">I0709 14:57:16.733085  200344 round_trippers.go:463]     Date: Sun, 09 Jul 2022 14:57:16 GMT</span><br><span class="line">I0709 14:57:16.733087  200344 round_trippers.go:463]     Audit-Id: 737c4916-1c0e-456a-a91c-1e8b0a69fe31</span><br><span class="line">I0709 14:57:16.733103  200344 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;Status&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&#125;,&quot;status&quot;:&quot;Failure&quot;,&quot;message&quot;:&quot;namespaces is forbidden: User \&quot;bob\&quot; cannot list resource \&quot;namespaces\&quot; in API group \&quot;\&quot; at the cluster scope&quot;,&quot;reason&quot;:&quot;Forbidden&quot;,&quot;details&quot;:&#123;&quot;kind&quot;:&quot;namespaces&quot;&#125;,&quot;code&quot;:403&#125;</span><br><span class="line">I0709 14:57:16.733298  200344 helpers.go:217] server response object: [&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;&#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;namespaces is forbidden: User \&quot;bob\&quot; cannot list resource \&quot;namespaces\&quot; in API group \&quot;\&quot; at the cluster scope&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;kind&quot;: &quot;namespaces&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;]</span><br><span class="line">F0709 14:57:16.733324  200344 helpers.go:116] Error from server (Forbidden): namespaces is forbidden: User &quot;bob&quot; cannot list resource &quot;namespaces&quot; in API group &quot;&quot; at the cluster scope</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ k get serviceaccounts -owide</span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         40d</span><br><span class="line"></span><br><span class="line">$ k describe serviceaccounts default</span><br><span class="line">Name:                default</span><br><span class="line">Namespace:           default</span><br><span class="line">Labels:              &lt;none&gt;</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   default-token-tcwxj</span><br><span class="line">Tokens:              default-token-tcwxj</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get secrets</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-tcwxj   kubernetes.io/service-account-token   3      40d</span><br><span class="line"></span><br><span class="line">$ k get secrets default-token-tcwxj -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EVXpNREF4TkRnME9Wb1hEVE16TURVeU56QXhORGcwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnRrCjIvRERGSXpuNmhoOVl6RFVmRzJDcXRlSzBzbTVGVkIyK0lXaXpCWk5ZVnNQbFpuN3NLL0NVYm4wdGJpUGpmUEoKUUJpUkxJZ3FCS1AydWRJanhjbUhqQ0hlSVFnOGswT3RnYXRCUTNzOEkwVVdhWW1QSXNQZWxwMllrZlkxK3Q3KwpQdUVsaHl1cE13eHJlSGFLQThTMG9Dd2NRT2g1L3piN290aXNrTDFlZzNZTWZaWjU1MWJKenBsc3hRdGdsdGp3CnBmcUU3UDBoQ2VTQkpwVmNGb1BXd3RNd2wvOVRvc1lKSC9TWU9kNnV0ZUllWFlEa1F6U3czZ2lkMHBkTitoS2EKemE2MEcvN2Q2a01aamUrQmRLMVFjenZpcE9zZWUvSHVDZklUNERtLzRiOFZuS1EwVU94QWZHRVg3UUdHcUlEMApOR0xSbXhXbVU4SnUraXFaaDkwQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZEZStoM2orN1BDckZXSDZjUnE5QVFGcHpvMTZNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRXZsWEJGRHRpQzJyK2VqSFBERgozeUxzbjA4Sjd1bENnN0xwMGJRaUxPZzIzZStjTTRzRnN0UVJadnFNYW1MU3l0U2hlZHAvVExFMnR0RlZOYnAvCkJlNVJiRGtuNWRFdFg5ejRva09IVTJ3ekFlaWZ5NnhCZEloYUdGZC9WT3B1SldBZ040aU9DVkRUQTA1OWNuTDMKSmJvVHJCNkRBdUo0a2JWNis5NGZkK001RXY1TVhiWXA2L2ExYTliMmVpWnNxbjM3djUvOWZlWU51Q3JYS0xGagprKzhvUWV0UGNEbW5TdkRrdUlteUZ0TGxjRjN1MGw1RmdwU2FQQnlWekJUckZQb25jTlcyV1ZkWWxLZ3ArWWFqCithT3JkRFNzbEVTY055R0hxTEkyS0RsTHIwWlBDQWtYSjFyRDcrenI5cFVEZC9LL1B5VFBlM3JaVWd3cjh2NjIKdFlJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">  namespace: ZGVmYXVsdA==</span><br><span class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkluSjNTRXcwUm1GUlExSXlVVVZFWjFKa1VqZFJkelYyV1hCU1h6VjFWVTFyVTFaVWNtVTBkblJQVGtVaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRHTjNlR29pTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU15TWpobU1tTXdMVFpsTjJFdE5HVmtNQzA1WkdSakxUQTROR05tWVRaalpqUm1ZaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZzJwX2xYVURHYTNPOGxPenNRb19OTS1GN0FtREtrQ1A2bG96TDAyR081QzR1R1RoM0UyMTZLRExNZWZpUzVlV3p6b2lKZGs3LVZrczdyUFBvN0RjQkp5VUxJOEVqVko3UTlyZEl6MV83WU1tTkZSWUFjZkJWYks2RnhpME5yZlR6a0FMSWlaeTNQSS1KTVg3OGpNMFFoQktOTDh0YWdPY3YwRkJLR2R0ZnV4QlZIa3VpdW51b3NFNHprVml1anFxOG52WDNEaXJwZ1EtT2lQREZLckZCaHkzcDhhelE2ZUpaSUlFZjRQUm84cUdOaVp6WERNOGw3VEtYUmhCUU5hR2pERFJ2LXRjQ3dFelpMd3ZzcFVJeVR6WWZKZWZWaHU2d3VLN0NXR0FuY2hadHhfOGp0LVpUbzh3V2lmWG85UzUyLXlSY2d2QlNWb2g3dFpJUmlaZFJn</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/service-account.name: default</span><br><span class="line">    kubernetes.io/service-account.uid: c228f2c0-6e7a-4ed0-9ddc-084cfa6cf4fb</span><br><span class="line">  creationTimestamp: &quot;2022-05-30T01:49:12Z&quot;</span><br><span class="line">  name: default-token-tcwxj</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;409&quot;</span><br><span class="line">  uid: d08bd61f-4cbb-4060-bbec-9f3c902e9890</span><br><span class="line">type: kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">$ echo ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkluSjNTRXcwUm1GUlExSXlVVVZFWjFKa1VqZFJkelYyV1hCU1h6VjFWVTFyVTFaVWNtVTBkblJQVGtVaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRHTjNlR29pTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU15TWpobU1tTXdMVFpsTjJFdE5HVmtNQzA1WkdSakxUQTROR05tWVRaalpqUm1ZaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZzJwX2xYVURHYTNPOGxPenNRb19OTS1GN0FtREtrQ1A2bG96TDAyR081QzR1R1RoM0UyMTZLRExNZWZpUzVlV3p6b2lKZGs3LVZrczdyUFBvN0RjQkp5VUxJOEVqVko3UTlyZEl6MV83WU1tTkZSWUFjZkJWYks2RnhpME5yZlR6a0FMSWlaeTNQSS1KTVg3OGpNMFFoQktOTDh0YWdPY3YwRkJLR2R0ZnV4QlZIa3VpdW51b3NFNHprVml1anFxOG52WDNEaXJwZ1EtT2lQREZLckZCaHkzcDhhelE2ZUpaSUlFZjRQUm84cUdOaVp6WERNOGw3VEtYUmhCUU5hR2pERFJ2LXRjQ3dFelpMd3ZzcFVJeVR6WWZKZWZWaHU2d3VLN0NXR0FuY2hadHhfOGp0LVpUbzh3V2lmWG85UzUyLXlSY2d2QlNWb2g3dFpJUmlaZFJn | base64 -d</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6InJ3SEw0RmFRQ1IyUUVEZ1JkUjdRdzV2WXBSXzV1VU1rU1ZUcmU0dnRPTkUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tdGN3eGoiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImMyMjhmMmMwLTZlN2EtNGVkMC05ZGRjLTA4NGNmYTZjZjRmYiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.g2p_lXUDGa3O8lOzsQo_NM-F7AmDKkCP6lozL02GO5C4uGTh3E216KDLMefiS5eWzzoiJdk7-Vks7rPPo7DcBJyULI8EjVJ7Q9rdIz1_7YMmNFRYAcfBVbK6Fxi0NrfTzkALIiZy3PI-JMX78jM0QhBKNL8tagOcv0FBKGdtfuxBVHkuiunuosE4zkViujqq8nvX3DirpgQ-OiPDFKrFBhy3p8azQ6eJZIIEf4PRo8qGNiZzXDM8l7TKXRhBQNaGjDDRv-tcCwEzZLwvspUIyTzYfJefVhu6wuK7CWGAnchZtx_8jt-ZTo8wWifXo9S52-yRcgvBSVoh7tZIRiZdRg</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该 Token 由 Kubernetes 颁发，Kubernetes 本身能<code>验签</code>，即可以识别身份</p>
</blockquote>
<blockquote>
<p>JWT 对应的 Header</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rwHL4FaQCR2QEDgRdR7Qw5vYpR_5uUMkSVTre4vtONE&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>JWT 对应的 Payload</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;iss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kubernetes/serviceaccount&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kubernetes.io/serviceaccount/namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kubernetes.io/serviceaccount/secret.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default-token-tcwxj&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kubernetes.io/serviceaccount/service-account.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kubernetes.io/serviceaccount/service-account.uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c228f2c0-6e7a-4ed0-9ddc-084cfa6cf4fb&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:serviceaccount:default:default&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ k get po nginx-deployment-6799fc88d8-4ppnm -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br><span class="line">  name: nginx-deployment-6799fc88d8-4ppnm</span><br><span class="line">  namespace: default</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    name: nginx</span><br><span class="line">    ...</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">      name: kube-api-access-b47dm</span><br><span class="line">      readOnly: true</span><br><span class="line">  ...</span><br><span class="line">  volumes:</span><br><span class="line">  - name: kube-api-access-b47dm</span><br><span class="line">    projected:</span><br><span class="line">      defaultMode: 420</span><br><span class="line">      sources:</span><br><span class="line">      - serviceAccountToken:</span><br><span class="line">          expirationSeconds: 3607</span><br><span class="line">          path: token</span><br><span class="line">      - configMap:</span><br><span class="line">          items:</span><br><span class="line">          - key: ca.crt</span><br><span class="line">            path: ca.crt</span><br><span class="line">          name: kube-root-ca.crt</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">            path: namespace</span><br><span class="line"></span><br><span class="line">$ k exec -it nginx-deployment-6799fc88d8-4ppnm -- ls /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">ca.crt    namespace  token</span><br><span class="line"></span><br><span class="line">$ k exec -it nginx-deployment-6799fc88d8-4ppnm -- cat /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6InJ3SEw0RmFRQ1IyUUVEZ1JkUjdRdzV2WXBSXzV1VU1rU1ZUcmU0dnRPTkUifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzIwNDQyMTY1LCJpYXQiOjE2ODg5MDYxNjUsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0IiwicG9kIjp7Im5hbWUiOiJuZ2lueC1kZXBsb3ltZW50LTY3OTlmYzg4ZDgtNHBwbm0iLCJ1aWQiOiI3MjY3N2NiZC1lMmUxLTQ5MWItODllNS1iMzliYThjMTY0NjQifSwic2VydmljZWFjY291bnQiOnsibmFtZSI6ImRlZmF1bHQiLCJ1aWQiOiJjMjI4ZjJjMC02ZTdhLTRlZDAtOWRkYy0wODRjZmE2Y2Y0ZmIifSwid2FybmFmdGVyIjoxNjg4OTA5NzcyfSwibmJmIjoxNjg4OTA2MTY1LCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDpkZWZhdWx0In0.hnH_AhovNOL7nOppNowTebOkmsCFXITfZvwhvTjoSL9tPuRNMUTfJrMmfOjLevs18pKNR_bDSRJrXNFTaNtzqVclLkPPC1m21_p6lsAXlOufVHuqANP97nEOfNGs8B7iL0_EIkQPsy0H1yh0850meAdNJqyoy0HpwxeKGC1-GhXYwTWIACbKUdb7yZ5o9sautdykkNU0zbTwWagdtjBjXZE1TI68KsoZrd-RGbRxBz_el6C4cbZ1z3S63Id8wB7k06IV7QRjxvG0jBip79yV32qvshdUvo4c4atHhT4tXO10kzualTPUh-dvYs0CwDuGswD6Ms1JVGiJ4donOhdggQ</span><br></pre></td></tr></table></figure>

<h2 id="Webhook"><a href="#Webhook" class="headerlink" title="Webhook"></a>Webhook</h2><blockquote>
<p>构建认证服务，用于认证 <code>TokenReview</code> Request</p>
</blockquote>
<blockquote>
<p>Input - spec</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authentication.k8s.io/v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TokenReview&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(BEARERTOKEN)&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Output - status</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authentication.k8s.io/v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TokenReview&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;authenticated&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx@qq.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;groups&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;developer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;qa&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>webhook</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/google/go-github/github&quot;</span></span><br><span class="line">    <span class="string">&quot;golang.org/x/oauth2&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">    authentication <span class="string">&quot;k8s.io/api/authentication/v1beta1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/authenticate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        <span class="comment">// decoder fail</span></span><br><span class="line">        decoder := json.NewDecoder(r.Body)</span><br><span class="line">        <span class="keyword">var</span> tr authentication.TokenReview</span><br><span class="line">        err := decoder.Decode(&amp;tr)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Println(<span class="string">&quot;[Error]&quot;</span>, err.Error())</span><br><span class="line">            w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">            json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">                <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;kind&quot;</span>:       <span class="string">&quot;TokenReview&quot;</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: authentication.TokenReviewStatus&#123;</span><br><span class="line">                    Authenticated: <span class="literal">false</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        log.Print(<span class="string">&quot;receiving request&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// oauth2 fail</span></span><br><span class="line">        client := github.NewClient(</span><br><span class="line">            oauth2.NewClient(context.Background(),</span><br><span class="line">                oauth2.StaticTokenSource(&amp;oauth2.Token&#123;</span><br><span class="line">                    AccessToken: tr.Spec.Token,</span><br><span class="line">                &#125;)))</span><br><span class="line">        user, _, err := client.Users.Get(context.Background(), <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Println(<span class="string">&quot;[Error]&quot;</span>, err.Error())</span><br><span class="line">            w.WriteHeader(http.StatusUnauthorized)</span><br><span class="line">            json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">                <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;kind&quot;</span>:       <span class="string">&quot;TokenReview&quot;</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: authentication.TokenReviewStatus&#123;</span><br><span class="line">                    Authenticated: <span class="literal">false</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// oauth2 success</span></span><br><span class="line">        log.Printf(<span class="string">&quot;[Success] login as %s&quot;</span>, *user.Login)</span><br><span class="line">        w.WriteHeader(http.StatusOK)</span><br><span class="line">        json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;kind&quot;</span>:       <span class="string">&quot;TokenReview&quot;</span>,</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: authentication.TokenReviewStatus&#123;</span><br><span class="line">                Authenticated: <span class="literal">true</span>,</span><br><span class="line">                User: authentication.UserInfo&#123;</span><br><span class="line">                    Username: *user.Login,</span><br><span class="line">                    UID:      *user.Login,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    log.Println(http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">build:</span></span><br><span class="line">    echo <span class="string">&quot;building authn-webhook&quot;</span></span><br><span class="line">    mkdir -p <span class="string">&quot;bin/arm64&quot;</span></span><br><span class="line">    CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o bin/arm64 .</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http://127.1:3000/authenticate | jq</span><br><span class="line">&#123;</span><br><span class="line">  &quot;apiVersion&quot;: &quot;authentication.k8s.io/v1&quot;,</span><br><span class="line">  &quot;kind&quot;: &quot;TokenReview&quot;,</span><br><span class="line">  &quot;status&quot;: &#123;</span><br><span class="line">    &quot;user&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>webhook-config.json</p>
</blockquote>
<figure class="highlight json"><figcaption><span>webhook-config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Config&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;preferences&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;github-authn&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.191.138:3000/authenticate&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authn-apiserver&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;secret&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contexts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webhook&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;context&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;github-authn&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authn-apiserver&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;current-context&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webhook&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>kube-apiserver.yaml - <code>--authentication-token-webhook-config-file</code></p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>/etc/kubernetes/manifests/kube-apiserver.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authentication-token-webhook-config-file=/etc/config/webhook-config.json</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">authn-webhook</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/home/zhongmingmao/apiserver/auth/webhook</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">authn-webhook</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">k get po -n kube-system</span><br><span class="line">NAME                              READY   STATUS    RESTARTS       AGE</span><br><span class="line">...</span><br><span class="line">kube-apiserver-mac-k8s            1/1     Running   0              59s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>~&#x2F;.kube&#x2F;config</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>~/.kube/config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">github_token</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">token:</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k get po --user github_token</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-6799fc88d8-4ppnm   1/1     Running   0          41d</span><br><span class="line">nginx-deployment-6799fc88d8-j5rnt   1/1     Running   0          41d</span><br><span class="line">nginx-deployment-6799fc88d8-ltc2g   1/1     Running   0          41d</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/arm64/authn-webhook</span><br><span class="line">2022/07/10 16:09:48 receiving request</span><br><span class="line">2022/07/10 16:09:49 [Success] login as zhongmingmao</span><br></pre></td></tr></table></figure>

<h1 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h1><ol>
<li>授权主要用于对<code>集群资源</code>的<code>访问控制</code></li>
<li>检查请求包含的相关<code>属性值</code>，与相对应的<code>访问策略</code>相比较，API 请求必须满足某些策略才能被处理</li>
<li>Kubernetes 支持<code>同时开启</code>多个授权插件，只要有 <code>1</code> 个验证通过即可</li>
<li>授权成功，则请求进入<code>准入模块</code>做进一步的请求验证，否则返回 HTTP 403</li>
<li>支持的授权插件：ABAC、<code>RBAC</code>、Webhook、Node</li>
</ol>
<h2 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h2><ol>
<li>RBAC 的授权策略可以利用 <code>kubectl</code> 或者 <code>Kubernetes API</code> 直接进行配置</li>
<li>RBAC 可以授权给用户，让用户有权进行<code>授权管理</code></li>
<li>RBAC 在 Kubernetes 中被映射为 <code>API</code> 资源和操作</li>
</ol>
<blockquote>
<p>RBAC</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230711224415204.png" alt="image-20230711224415204"></p>
<blockquote>
<p>Kubernetes - <code>RoleBinding</code> 可以绑定 <code>ClusterRole</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-rbac.png" alt="k8s-rbac"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&quot;rbac.authorization.k8s.io&quot;</span><br><span class="line">NAME                  SHORTNAMES   APIVERSION                     NAMESPACED   KIND</span><br><span class="line">clusterrolebindings                rbac.authorization.k8s.io/v1   false        ClusterRoleBinding</span><br><span class="line">clusterroles                       rbac.authorization.k8s.io/v1   false        ClusterRole</span><br><span class="line">rolebindings                       rbac.authorization.k8s.io/v1   true         RoleBinding</span><br><span class="line">roles                              rbac.authorization.k8s.io/v1   true         Role</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Role 是<code>权限集合</code>，Role 只能用来给某个特定的 <code>Namespace</code> 中的资源做鉴权</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>role.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ClusterRole 适用于<code>多 Namespace 的资源</code>、<code>集群级别的资源</code>、<code>非资源类的 API</code></p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>cluster-role.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Binding - RoleBinding 是与 Namespace 挂钩的，因此用户只有 default 下的权限</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>role-binding.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line"></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bob</span></span><br><span class="line"></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230712001210433.png" alt="image-20230712001210433"></p>
<blockquote>
<p>Group</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230712001835088.png" alt="image-20230712001835088"></p>
<ol>
<li>与<code>外部认证系统</code>对接时，用户信息（<code>UserInfo</code>）可以包含 <code>Group</code> 信息，授权可以针对<code>用户群组</code></li>
<li>对 <code>ServiceAccount</code> 授权时，Group 代表某个 <code>Namespace</code> 下的所有 ServiceAccount</li>
</ol>
<figure class="highlight yaml"><figcaption><span>cluster-role-binding-user.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-golobal-user</span></span><br><span class="line"></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span> <span class="comment"># User</span></span><br><span class="line"></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>cluster-role-binding-sa.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-global-sa</span></span><br><span class="line"></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:serviceaccounts:default</span> <span class="comment"># ServiceAccount</span></span><br><span class="line"></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br></pre></td></tr></table></figure>

<h2 id="多租户"><a href="#多租户" class="headerlink" title="多租户"></a>多租户</h2><blockquote>
<p>规划系统角色</p>
</blockquote>
<ol>
<li>User<ul>
<li>管理员<ul>
<li>所有资源的所有权限？ - <code>应用的 Secret</code> 不应该被管理员访问</li>
</ul>
</li>
<li>普通用户<ul>
<li>是否有该用户创建的 Namespace 下所有的 Object 的操作权限？</li>
<li>对其它用户的 Namespace 资源是否可读？是否可写？</li>
</ul>
</li>
</ul>
</li>
<li>SystemAccount<ul>
<li>SystemAccount 是开发者创建应用后，应用与 <code>API Server</code> 进行<code>通信</code>所需要的<code>身份</code></li>
<li>Kubernetes 会为每个 Namespace 创建 <code>Default SystemAccount</code><ul>
<li>Default SystemAccount 需要授予给定权限后才能对 API Server 进行写操作</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>实现方案（自动化）：用户创建了某个 Namespace，则该用户拥有了该 Namespace 的所有权限</p>
</blockquote>
<ol>
<li>在创建 Cluster 时，创建了一个 ClusterRole（名为 namespace-creator），该 ClusterRole 拥有集群的所有权限</li>
<li>创建自定义的 namespace <code>admission webhook</code><ul>
<li>当 <code>Namespace 创建请求</code>被处理时，获取<code>当前用户信息</code>并 <code>annotate</code> 到 namespace – <code>mutating admission</code></li>
<li><code>Admission</code> 在 <code>Authentication</code> 和 <code>Authorization</code> 之后，所以能获取到创建者的信息</li>
</ul>
</li>
<li>创建 RBAC Controller<ul>
<li>监听 Namespace 的创建事件</li>
<li>获取当前 Namespace 的创建者信息 – 从上面 <code>mutating admission</code> 注入的 <code>Annotation</code> 来获取</li>
<li>在当前 Namespace 创建 <code>RoleBinding</code>，并将 namespace-creator 与创建者绑定<ul>
<li>创建者拥有了该 Namespace 的所有权限</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>最佳实践</p>
</blockquote>
<ol>
<li>ClusterRole 是针对<code>整个集群</code>生效的</li>
<li>创建一个<code>管理员角色</code>，并且绑定给<code>开发运营团队</code>成员</li>
<li><code>ThirdPartyResource</code> 和 <code>CustomResourceDefinition</code> 是<code>全局资源 </code><ul>
<li><code>普通用户</code>创建 ThirdPartyResource 后，需要管理员授权后才能真正操作该对象</li>
</ul>
</li>
<li>创建 <code>spec</code>，用<code>源码驱动</code>来进行<code>角色管理</code></li>
<li>权限是可以<code>传递</code>的<ul>
<li>用户 A 可以将其对某对象的某操作，抽取成一个权限，然后赋给用户 B</li>
</ul>
</li>
<li>防止<code>海量</code>的 Role 和 RoleBinding 对象，否则会导致<code>鉴权效率低下</code>，造成 API Server 的负担</li>
<li>ServiceAccount 也需要授权</li>
</ol>
<blockquote>
<p>POST vs PUT vs PATCH</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>quota.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">object-counts</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>create - POST</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">$ k create -f quota.yaml -v 9</span><br><span class="line">I0715 13:19:57.134787  450767 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0715 13:19:57.135531  450767 round_trippers.go:435] curl -v -XGET  -H &quot;Accept: application/com.github.proto-openapi.spec.v2@v1.0+protobuf&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/openapi/v2?timeout=32s&#x27;</span><br><span class="line">I0715 13:19:57.154717  450767 round_trippers.go:454] GET https://192.168.191.138:6443/openapi/v2?timeout=32s 200 OK in 19 milliseconds</span><br><span class="line">I0715 13:19:57.154736  450767 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:19:57.154739  450767 round_trippers.go:463]     Last-Modified: Tue, 30 May 2022 02:00:47 GMT</span><br><span class="line">I0715 13:19:57.154741  450767 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:19:57.154743  450767 round_trippers.go:463]     Audit-Id: edc1e0fc-2f1f-427f-af08-95d9b8b5ce20</span><br><span class="line">I0715 13:19:57.154745  450767 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:19:57 GMT</span><br><span class="line">I0715 13:19:57.154747  450767 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:19:57.154749  450767 round_trippers.go:463]     Etag: &quot;16EDF837BE1F7591619543929575D12CB44EF9CA045DD612D1C78212BD9DD25D2E838683496297E3C87779ED322106670C9D598130BA223857EB7BD925CB8D61&quot;</span><br><span class="line">I0715 13:19:57.154755  450767 round_trippers.go:463]     Vary: Accept-Encoding</span><br><span class="line">I0715 13:19:57.154757  450767 round_trippers.go:463]     Vary: Accept</span><br><span class="line">I0715 13:19:57.154761  450767 round_trippers.go:463]     X-Varied-Accept: application/com.github.proto-openapi.spec.v2@v1.0+protobuf</span><br><span class="line">I0715 13:19:57.154763  450767 round_trippers.go:463]     Accept-Ranges: bytes</span><br><span class="line">I0715 13:19:57.154767  450767 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:19:57.154769  450767 round_trippers.go:463]     Content-Type: application/octet-stream</span><br><span class="line">I0715 13:19:57.154773  450767 round_trippers.go:463]     X-From-Cache: 1</span><br><span class="line">I0715 13:19:57.222672  450767 request.go:1179] Response Body:</span><br><span class="line">00000000  0a 03 32 2e 30 12 15 0a  0a 4b 75 62 65 72 6e 65  |..2.0....Kuberne|</span><br><span class="line">00000010  74 65 73 12 07 76 31 2e  32 32 2e 32 42 95 f8 b3  |tes..v1.22.2B...|</span><br><span class="line">00000020  01 12 8c 02 0a 22 2f 2e  77 65 6c 6c 2d 6b 6e 6f  |.....&quot;/.well-kno|</span><br><span class="line">00000030  77 6e 2f 6f 70 65 6e 69  64 2d 63 6f 6e 66 69 67  |wn/openid-config|</span><br><span class="line">00000040  75 72 61 74 69 6f 6e 2f  12 e5 01 12 e2 01 0a 09  |uration/........|</span><br><span class="line">00000050  57 65 6c 6c 4b 6e 6f 77  6e 1a 57 67 65 74 20 73  |WellKnown.Wget s|</span><br><span class="line">00000060  65 72 76 69 63 65 20 61  63 63 6f 75 6e 74 20 69  |ervice account i|</span><br><span class="line">00000070  73 73 75 65 72 20 4f 70  65 6e 49 44 20 63 6f 6e  |ssuer OpenID con|</span><br><span class="line">00000080  66 69 67 75 72 61 74 69  6f 6e 2c 20 61 6c 73 6f  |figuration, also|</span><br><span class="line">00000090  20 6b 6e 6f 77 6e 20 61  73 20 74 68 65 20 27 4f  | known as the &#x27;O|</span><br><span class="line">000000a0  49 44 43 20 64 69 73 63  6f 76 65 72 79 20 64 6f  |IDC discovery do|</span><br><span class="line">000000b0  63 27 2a 2a 67 65 74 53  65 72 76 69 63 65 41 63  |c&#x27;**getServiceAc|</span><br><span class="line">000000c0  63 6f 75 6e 74 49 73 73  75 65 72 4f 70 65 6e 49  |countIssuerOpenI|</span><br><span class="line">000000d0  44 43 6f 6e 66 69 67 75  72 61 74 69 6f 6e 32 10  |DConfiguration2.|</span><br><span class="line">000000e0  61 70 70 6c 69 63 61 74  69 6f 6e 2f 6a 73 6f 6e  |application/json|</span><br><span class="line">000000f0  4a 37 0a 1c 0a 03 32 30  30 12 15 0a 13 0a 02 4f  |J7....200......O|</span><br><span class="line">00000100  4b 12 0d 0a 0b b2 01 08  0a 06 73 74 72 69 6e 67  |K.........string|</span><br><span class="line">00000110  0a 17 0a 03 34 30 31 12  10 0a 0e 0a 0c 55 6e 61  |....401......Una|</span><br><span class="line">00000120  75 74 68 6f 72 69 7a 65  64 52 05 68 74 74 70 73  |uthorizedR.https|</span><br><span class="line">00000130  12 ca 02 0a 05 2f 61 70  69 2f 12 c0 02 12 bd 02  |...../api/......|</span><br><span class="line">00000140  0a 04 63 6f 72 65 1a 1a  67 65 74 20 61 76 61 69  |..core..get avai|</span><br><span class="line">00000150  6c 61 62 6c 65 20 41 50  49 20 76 65 72 73 69 6f  |lable API versio|</span><br><span class="line">00000160  6e 73 2a 12 67 65 74 43  6f 72 65 41 50 49 56 65  |ns*.getCoreAPIVe|</span><br><span class="line">00000170  72 73 69 6f 6e 73 32 10  61 70 70 6c 69 63 61 74  |rsions2.applicat|</span><br><span class="line">00000180  69 6f 6e 2f 6a 73 6f 6e  32 10 61 70 70 6c 69 63  |ion/json2.applic|</span><br><span class="line">00000190  61 74 69 6f 6e 2f 79 61  6d 6c 32 23 61 70 70 6c  |ation/yaml2#appl|</span><br><span class="line">000001a0  69 63 61 74 69 6f 6e 2f  76 6e 64 2e 6b 75 62 65  |ication/vnd.kube|</span><br><span class="line">000001b0  72 6e 65 74 65 73 2e 70  72 6f 74 6f 62 75 66 3a  |rnetes.protobuf:|</span><br><span class="line">000001c0  10 61 70 70 6c 69 63 61  74 69 6f 6e 2f 6a 73 6f  |.application/jso|</span><br><span class="line">000001d0  6e 3a 10 61 70 70 6c 69  63 61 74 69 6f 6e 2f 79  |n:.application/y|</span><br><span class="line">000001e0  61 6d 6c 3a 23 61 70 70  6c 69 63 61 74 69 6f 6e  |aml:#application|</span><br><span class="line">000001f0  2f 76 6e 64 2e 6b 75 62  65 72 6e 65 74 65 73 2e  |/vnd.kubernetes.|</span><br><span class="line">00000200  70 72 6f 74 6f 62 75 66  4a 6c 0a 51 0a 03 32 30  |protobufJl.Q..20|</span><br><span class="line">00000210  30 12 4a 0a 48 0a 02 4f  4b 12 42 0a 40 0a 3e 23  |0.J.H..OK.B.@.&gt;#|</span><br><span class="line">00000220  2f 64 65 66 69 6e 69 74  69 6f 6e 73 2f 69 6f 2e  |/definitions/io.|</span><br><span class="line">00000230  6b 38 73 2e 61 70 69 6d  61 63 68 69 6e 65 72 79  |k8s.apimachinery|</span><br><span class="line">00000240  2e 70 6b 67 2e 61 70 69  73 2e 6d 65 74 61 2e 76  |.pkg.apis.meta.v|</span><br><span class="line">00000250  31 2e 41 50 49 56 65 72  73 69 6f 6e 73 0a 17 0a  |1.APIVersions...|</span><br><span class="line">00000260  03 34 30 31 12 10 0a 0e  0a 0c 55 6e 61 75 74 68  |.401......Unauth|</span><br><span class="line">00000270  6f 72 69 7a 65 64 52 05  68 74 74 70 73 12 d4 02  |orizedR.https...|</span><br><span class="line">00000280  0a 08 2f 61 70 69 2f 76  31 2f 12 c7 02 12 c4 02  |../api/v1/......|</span><br><span class="line">00000290  0a 07 63 6f 72 65 5f 76  31 1a 17 67 65 74 20 61  |..core_v1..get a|</span><br><span class="line">000002a0  76 61 69 6c 61 62 6c 65  20 72 65 73 6f 75 72 63  |vailable resourc|</span><br><span class="line">000002b0  65 73 2a 15 67 65 74 43  6f 72 65 56 31 41 50 49  |es*.getCoreV1API|</span><br><span class="line">000002c0  52 65 73 6f 75 72 63 65  73 32 10 61 70 70 6c 69  |Resources2.appli|</span><br><span class="line">000002d0  63 61 74 69 6f 6e 2f 6a  73 6f 6e 32 10 61 70 70  |cation/json2.app|</span><br><span class="line">000002e0  6c 69 63 61 74 69 6f 6e  2f 79 61 6d 6c 32 23 61  |lication/yaml2#a|</span><br><span class="line">000002f0  70 70 6c 69 63 61 74 69  6f 6e 2f 76 6e 64 2e 6b  |pplication/vnd.k|</span><br><span class="line">00000300  75 62 65 72 6e 65 74 65  73 2e 70 72 6f 74 6f 62  |ubernetes.protob|</span><br><span class="line">00000310  75 66 3a 10 61 70 70 6c  69 63 61 74 69 6f 6e 2f  |uf:.application/|</span><br><span class="line">00000320  6a 73 6f 6e 3a 10 61 70  70 6c 69 63 61 74 69 6f  |json:.applicatio|</span><br><span class="line">00000330  6e 2f 79 61 6d 6c 3a 23  61 70 70 6c 69 63 61 74  |n/yaml:#applicat|</span><br><span class="line">00000340  69 6f 6e 2f 76 6e 64 2e  6b 75 62 65 72 6e 65 74  |ion/vnd.kubernet|</span><br><span class="line">00000350  65 73 2e 70 72 6f 74 6f  62 75 66 4a 70 0a 55 0a  |es.protobufJp.U.|</span><br><span class="line">00000360  03 32 30 30 12 4e 0a 4c  0a 02 4f 4b 12 46 0a 44  |.200.N.L..OK.F.D|</span><br><span class="line">00000370  0a 42 23 2f 64 65 66 69  6e 69 74 69 6f 6e 73 2f  |.B#/definitions/|</span><br><span class="line">00000380  69 6f 2e 6b 38 73 2e 61  70 69 6d 61 63 68 69 6e  |io.k8s.apimachin|</span><br><span class="line">00000390  65 72 79 2e 70 6b 67 2e  61 70 69 73 2e 6d 65 74  |ery.pkg.apis.met|</span><br><span class="line">000003a0  61 2e 76 31 2e 41 50 49  52 65 73 6f 75 72 63 65  |a.v1.APIResource|</span><br><span class="line">000003b0  4c 69 73 74 0a 17 0a 03  34 30 31 12 10 0a 0e 0a  |List....401.....|</span><br><span class="line">000003c0  0c 55 6e 61 75 74 68 6f  72 69 7a 65 64 52 05 68  |.UnauthorizedR.h|</span><br><span class="line">000003d0  74 74 70 73 12 9a 26 0a  19 2f 61 70 69 2f 76 31  |ttps..&amp;../api/v1|</span><br><span class="line">000003e0  2f 63 6f 6d 70 6f 6e 65  6e 74 73 74 61 74 75 73  |/componentstatus|</span><br><span class="line">000003f0  65 73 12 fc 25 12 c7 03  0a 07 63 6f 72 65 5f 76  |es..%.....core_v|</span><br><span class="line">00000400  31 1a 24 6c 69 73 74 20  6f 62 6a 65 63 74 73 20  |1.$list objects |</span><br><span class="line">00000410  6f 66 20 6b 69 6e 64 20  43 6f 6d 70 6f 6e 65 6e  |of kind Componen|</span><br><span class="line">00000420  74 53 74 61 74 75 73 2a  19 6c 69 73 74 43 6f 72  |tStatus*.listCor|</span><br><span class="line">00000430  65 56 31 43 6f 6d 70 6f  6e 65 6e 74 53 74 61 74  |eV1ComponentStat|</span><br><span class="line">00000440  75 73 32 10 61 70 70 6c  69 63 61 74 69 6f 6e 2f  |us2.application/|</span><br><span class="line">00000450  6a 73 6f 6e 32 10 61 70  70 6c 69 63 61 74 69 6f  |json2.applicatio|</span><br><span class="line">00000460  6e 2f 79 61 6d 6c 32 23  61 70 70 6c 69 63 61 74  |n/yaml2#applicat|</span><br><span class="line">00000470  69 6f 6e 2f 76 6e 64 2e  6b 75 62 65 72 6e 65 74  |ion/vnd.kubernet|</span><br><span class="line">00000480  65 73 2e 70 72 6f 74 6f  62 75 66 32 1d 61 70 70  |es.protobuf2.app|</span><br><span class="line">00000490  6c 69 63 61 74 69 6f 6e  2f 6a 73 6f 6e 3b 73 74  |lication/json;st|</span><br><span class="line">000004a0  72 65 61 6d 3d 77 61 74  63 68 32 30 61 70 70 6c  |ream=watch20appl|</span><br><span class="line">000004b0  69 63 61 74 69 6f 6e 2f  76 6e 64 2e 6b 75 62 65  |ication/vnd.kube|</span><br><span class="line">000004c0  72 6e 65 74 65 73 2e 70  72 6f 74 6f 62 75 66 3b  |rnetes.protobuf;|</span><br><span class="line">000004d0  73 74 72 65 61 6d 3d 77  61 74 63 68 3a 03 2a 2f  |stream=watch:.*/|</span><br><span class="line">000004e0  2a 4a 62 0a 47 0a 03 32  30 30 12 40 0a 3e 0a 02  |*Jb.G..200.@.&gt;..|</span><br><span class="line">000004f0  4f 4b 12 38 0a 36 0a 34  23 2f 64 65 66 69 6e 69  |OK.8.6.4#/defini|</span><br><span class="line">00000500  74 69 6f 6e 73 2f 69 6f  2e 6b 38 73 2e 61 70 69  |tions/io.k8s.api|</span><br><span class="line">00000510  2e 63 6f 72 65 2e 76 31  2e 43 6f 6d 70 6f 6e 65  |.core.v1.Compone|</span><br><span class="line">00000520  6e 74 53 74 61 74 75 73  4c 69 73 74 0a 17 0a 03  |ntStatusList....|</span><br><span class="line">00000530  34 30 31 12 10 0a 0e 0a  0c 55 6e 61 75 74 68 6f  |401......Unautho|</span><br><span class="line">00000540  72 69 7a 65 64 52 05 68  74 74 70 73 6a 1e 0a 13  |rizedR.httpsj...|</span><br><span class="line">00000550  78 2d 6b 75 62 65 72 6e  65 74 65 73 2d 61 63 74  |x-kubernetes-act|</span><br><span class="line">00000560  69 6f 6e 12 07 12 05 6c  69 73 74 0a 6a 51 0a 1f  |ion....list.jQ..|</span><br><span class="line">00000570  78 2d 6b 75 62 65 72 6e  65 74 65 73 2d 67 72 6f  |x-kubernetes-gro|</span><br><span class="line">00000580  75 70 2d 76 65 72 73 69  6f 6e 2d 6b 69 6e 64 12  |up-version-kind.|</span><br><span class="line">00000590  2e 12 2c 67 72 6f 75 70  3a 20 22 22 0a 6b 69 6e  |..,group: &quot;&quot;.kin|</span><br><span class="line">000005a0  64 3a 20 43 6f 6d 70 6f  6e 65 6e 74 53 74 61 74  |d: ComponentStat|</span><br><span class="line">000005b0  75 73 0a 76 65 72 73 69  6f 6e 3a 20 76 31 0a 4a  |us.version: v1.J|</span><br><span class="line">000005c0  ab 03 0a a8 03 12 a5 03  1a a2 03 12 05 71 75 65  |.............que|</span><br><span class="line">000005d0  72 79 1a f7 02 61 6c 6c  6f 77 57 61 74 63 68 42  |ry...allowWatchB|</span><br><span class="line">000005e0  6f 6f 6b 6d 61 72 6b 73  20 72 65 71 75 65 73 74  |ookmarks request|</span><br><span class="line">000005f0  73 20 77 61 74 63 68 20  65 76 65 6e 74 73 20 77  |s watch events w|</span><br><span class="line">00000600  69 74 68 20 74 79 70 65  20 22 42 4f 4f 4b 4d 41  |ith type &quot;BOOKMA|</span><br><span class="line">00000610  52 4b 22 2e 20 53 65 72  76 65 72 73 20 74 68 61  |RK&quot;. Servers tha|</span><br><span class="line">00000620  74 20 64 6f 20 6e 6f 74  20 69 6d 70 6c 65 6d 65  |t do not impleme|</span><br><span class="line">00000630  6e 74 20 62 6f 6f 6b 6d  61 72 6b 73 20 6d 61 79  |nt bookmarks may|</span><br><span class="line">00000640  20 69 67 6e 6f 72 65 20  74 68 69 73 20 66 6c 61  | ignore this fla|</span><br><span class="line">00000650  67 20 61 6e 64 20 62 6f  6f 6b 6d 61 72 6b 73 20  |g and bookmarks |</span><br><span class="line">00000660  61 72 65 20 73 65 6e 74  20 61 74 20 74 68 65 20  |are sent at the |</span><br><span class="line">00000670  73 65 72 76 65 72 27 73  20 64 69 73 63 72 65 74  |server&#x27;s discret|</span><br><span class="line">00000680  69 6f 6e 2e 20 43 6c 69  65 6e 74 73 20 73 68 6f  |ion. Clients sho|</span><br><span class="line">00000690  75 6c 64 20 6e 6f 74 20  61 73 73 75 6d 65 20 62  |uld not assume b|</span><br><span class="line">000006a0  6f 6f 6b 6d 61 72 6b 73  20 61 72 65 20 72 65 74  |ookmarks are ret|</span><br><span class="line">000006b0  75 72 6e 65 64 20 61 74  20 61 6e 79 20 73 70 65  |urned at any spe|</span><br><span class="line">000006c0  63 69 66 69 63 20 69 6e  74 65 72 76 61 6c 2c 20  |cific interval, |</span><br><span class="line">000006d0  6e 6f 72 20 6d 61 79 20  74 68 65 79 20 61 73 73  |nor may they ass|</span><br><span class="line">000006e0  75 6d 65 20 74 68 65 20  73 65 72 76 65 72 20 77  |ume the server w|</span><br><span class="line">000006f0  69 6c 6c 20 73 65 6e 64  20 61 6e 79 20 42 4f 4f  |ill send any BOO|</span><br><span class="line">00000700  4b 4d 41 52 4b 20 65 76  65 6e 74 20 64 75 72 69  |KMARK event duri|</span><br><span class="line">00000710  6e 67 20 61 20 73 65 73  73 69 6f 6e 2e 20 49 66  |ng a session. If|</span><br><span class="line">00000720  20 74 68 69 73 20 69 73  20 6e 6f 74 20 61 20 77  | this is not a w|</span><br><span class="line">00000730  61 74 63 68 2c 20 74 68  69 73 20 66 69 65 6c 64  |atch, this field|</span><br><span class="line">00000740  20 69 73 20 69 67 6e 6f  72 65 64 2e 22 13 61 6c  | is ignored.&quot;.al|</span><br><span class="line">00000750  6c 6f 77 57 61 74 63 68  42 6f 6f 6b 6d 61 72 6b  |lowWatchBookmark|</span><br><span class="line">00000760  73 32 07 62 6f 6f 6c 65  61 6e a0 01 01 4a ef 09  |s2.boolean...J..|</span><br><span class="line">00000770  0a ec 09 12 e9 09 1a e6  09 12 05 71 75 65 72 79  |...........query|</span><br><span class="line">00000780  1a c7 09 54 68 65 20 63  6f 6e 74 69 6e 75 65 20  |...The continue |</span><br><span class="line">00000790  6f 70 74 69 6f 6e 20 73  68 6f 75 6c 64 20 62 65  |option should be|</span><br><span class="line">000007a0  20 73 65 74 20 77 68 65  6e 20 72 65 74 72 69 65  | set when retrie|</span><br><span class="line">000007b0  76 69 6e 67 20 6d 6f 72  65 20 72 65 73 75 6c 74  |ving more result|</span><br><span class="line">000007c0  73 20 66 72 6f 6d 20 74  68 65 20 73 65 72 76 65  |s from the serve|</span><br><span class="line">000007d0  72 2e 20 53 69 6e 63 65  20 74 68 69 73 20 76 61  |r. Since this va|</span><br><span class="line">000007e0  6c 75 65 20 69 73 20 73  65 72 76 65 72 20 64 65  |lue is server de|</span><br><span class="line">000007f0  66 69 6e 65 64 2c 20 63  6c 69 65 6e 74 73 20 6d  |fined, clients m|</span><br><span class="line">00000800  61 79 20 6f 6e 6c 79 20  75 73 65 20 74 68 65 20  |ay only use the |</span><br><span class="line">00000810  63 6f 6e 74 69 6e 75 65  20 76 61 6c 75 [truncated 20865904 chars]</span><br><span class="line">I0715 13:19:57.253243  450767 request.go:1181] Request Body: &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;ResourceQuota&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;object-counts&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;&#125;&#125;</span><br><span class="line">I0715 13:19:57.253294  450767 round_trippers.go:435] curl -v -XPOST  -H &quot;Accept: application/json&quot; -H &quot;Content-Type: application/json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas?fieldManager=kubectl-create&#x27;</span><br><span class="line">I0715 13:19:57.256150  450767 round_trippers.go:454] POST https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas?fieldManager=kubectl-create 201 Created in 2 milliseconds</span><br><span class="line">I0715 13:19:57.256168  450767 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:19:57.256171  450767 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:19:57.256173  450767 round_trippers.go:463]     Content-Length: 462</span><br><span class="line">I0715 13:19:57.256175  450767 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:19:57 GMT</span><br><span class="line">I0715 13:19:57.256177  450767 round_trippers.go:463]     Audit-Id: e8031f78-e9dd-409f-9a1e-6b3b9efed506</span><br><span class="line">I0715 13:19:57.256239  450767 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:19:57.256241  450767 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0715 13:19:57.256243  450767 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:19:57.256260  450767 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;ResourceQuota&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;object-counts&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;4cf2c318-6287-4836-b4ff-aa656a9e7a83&quot;,&quot;resourceVersion&quot;:&quot;34451&quot;,&quot;creationTimestamp&quot;:&quot;2022-07-15T13:19:57Z&quot;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kubectl-create&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:19:57Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;&#125;,&quot;status&quot;:&#123;&#125;&#125;</span><br><span class="line">resourcequota/object-counts created</span><br></pre></td></tr></table></figure>

<blockquote>
<p>replace - PUT -All</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">$ k replace -f quota.yaml -v 9</span><br><span class="line">I0715 13:22:49.205898  453970 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0715 13:22:49.207053  453970 round_trippers.go:435] curl -v -XGET  -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; -H &quot;Accept: application/com.github.proto-openapi.spec.v2@v1.0+protobuf&quot; &#x27;https://192.168.191.138:6443/openapi/v2?timeout=32s&#x27;</span><br><span class="line">I0715 13:22:49.224987  453970 round_trippers.go:454] GET https://192.168.191.138:6443/openapi/v2?timeout=32s 200 OK in 17 milliseconds</span><br><span class="line">I0715 13:22:49.225007  453970 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:22:49.225010  453970 round_trippers.go:463]     Content-Type: application/octet-stream</span><br><span class="line">I0715 13:22:49.225013  453970 round_trippers.go:463]     X-Varied-Accept: application/com.github.proto-openapi.spec.v2@v1.0+protobuf</span><br><span class="line">I0715 13:22:49.225015  453970 round_trippers.go:463]     Accept-Ranges: bytes</span><br><span class="line">I0715 13:22:49.225017  453970 round_trippers.go:463]     Vary: Accept-Encoding</span><br><span class="line">I0715 13:22:49.225019  453970 round_trippers.go:463]     Vary: Accept</span><br><span class="line">I0715 13:22:49.225021  453970 round_trippers.go:463]     X-From-Cache: 1</span><br><span class="line">I0715 13:22:49.225027  453970 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:22:49.225032  453970 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:22:49 GMT</span><br><span class="line">I0715 13:22:49.225034  453970 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:22:49.225039  453970 round_trippers.go:463]     Audit-Id: 3d83bf57-b770-469c-a6dd-1c6e6ed16c94</span><br><span class="line">I0715 13:22:49.225044  453970 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:22:49.225047  453970 round_trippers.go:463]     Etag: &quot;16EDF837BE1F7591619543929575D12CB44EF9CA045DD612D1C78212BD9DD25D2E838683496297E3C87779ED322106670C9D598130BA223857EB7BD925CB8D61&quot;</span><br><span class="line">I0715 13:22:49.225049  453970 round_trippers.go:463]     Last-Modified: Tue, 30 May 2022 02:00:47 GMT</span><br><span class="line">I0715 13:22:49.289318  453970 request.go:1179] Response Body:</span><br><span class="line">00000000  0a 03 32 2e 30 12 15 0a  0a 4b 75 62 65 72 6e 65  |..2.0....Kuberne|</span><br><span class="line">00000010  74 65 73 12 07 76 31 2e  32 32 2e 32 42 95 f8 b3  |tes..v1.22.2B...|</span><br><span class="line">00000020  01 12 8c 02 0a 22 2f 2e  77 65 6c 6c 2d 6b 6e 6f  |.....&quot;/.well-kno|</span><br><span class="line">00000030  77 6e 2f 6f 70 65 6e 69  64 2d 63 6f 6e 66 69 67  |wn/openid-config|</span><br><span class="line">00000040  75 72 61 74 69 6f 6e 2f  12 e5 01 12 e2 01 0a 09  |uration/........|</span><br><span class="line">00000050  57 65 6c 6c 4b 6e 6f 77  6e 1a 57 67 65 74 20 73  |WellKnown.Wget s|</span><br><span class="line">00000060  65 72 76 69 63 65 20 61  63 63 6f 75 6e 74 20 69  |ervice account i|</span><br><span class="line">00000070  73 73 75 65 72 20 4f 70  65 6e 49 44 20 63 6f 6e  |ssuer OpenID con|</span><br><span class="line">00000080  66 69 67 75 72 61 74 69  6f 6e 2c 20 61 6c 73 6f  |figuration, also|</span><br><span class="line">00000090  20 6b 6e 6f 77 6e 20 61  73 20 74 68 65 20 27 4f  | known as the &#x27;O|</span><br><span class="line">000000a0  49 44 43 20 64 69 73 63  6f 76 65 72 79 20 64 6f  |IDC discovery do|</span><br><span class="line">000000b0  63 27 2a 2a 67 65 74 53  65 72 76 69 63 65 41 63  |c&#x27;**getServiceAc|</span><br><span class="line">000000c0  63 6f 75 6e 74 49 73 73  75 65 72 4f 70 65 6e 49  |countIssuerOpenI|</span><br><span class="line">000000d0  44 43 6f 6e 66 69 67 75  72 61 74 69 6f 6e 32 10  |DConfiguration2.|</span><br><span class="line">000000e0  61 70 70 6c 69 63 61 74  69 6f 6e 2f 6a 73 6f 6e  |application/json|</span><br><span class="line">000000f0  4a 37 0a 1c 0a 03 32 30  30 12 15 0a 13 0a 02 4f  |J7....200......O|</span><br><span class="line">00000100  4b 12 0d 0a 0b b2 01 08  0a 06 73 74 72 69 6e 67  |K.........string|</span><br><span class="line">00000110  0a 17 0a 03 34 30 31 12  10 0a 0e 0a 0c 55 6e 61  |....401......Una|</span><br><span class="line">00000120  75 74 68 6f 72 69 7a 65  64 52 05 68 74 74 70 73  |uthorizedR.https|</span><br><span class="line">00000130  12 ca 02 0a 05 2f 61 70  69 2f 12 c0 02 12 bd 02  |...../api/......|</span><br><span class="line">00000140  0a 04 63 6f 72 65 1a 1a  67 65 74 20 61 76 61 69  |..core..get avai|</span><br><span class="line">00000150  6c 61 62 6c 65 20 41 50  49 20 76 65 72 73 69 6f  |lable API versio|</span><br><span class="line">00000160  6e 73 2a 12 67 65 74 43  6f 72 65 41 50 49 56 65  |ns*.getCoreAPIVe|</span><br><span class="line">00000170  72 73 69 6f 6e 73 32 10  61 70 70 6c 69 63 61 74  |rsions2.applicat|</span><br><span class="line">00000180  69 6f 6e 2f 6a 73 6f 6e  32 10 61 70 70 6c 69 63  |ion/json2.applic|</span><br><span class="line">00000190  61 74 69 6f 6e 2f 79 61  6d 6c 32 23 61 70 70 6c  |ation/yaml2#appl|</span><br><span class="line">000001a0  69 63 61 74 69 6f 6e 2f  76 6e 64 2e 6b 75 62 65  |ication/vnd.kube|</span><br><span class="line">000001b0  72 6e 65 74 65 73 2e 70  72 6f 74 6f 62 75 66 3a  |rnetes.protobuf:|</span><br><span class="line">000001c0  10 61 70 70 6c 69 63 61  74 69 6f 6e 2f 6a 73 6f  |.application/jso|</span><br><span class="line">000001d0  6e 3a 10 61 70 70 6c 69  63 61 74 69 6f 6e 2f 79  |n:.application/y|</span><br><span class="line">000001e0  61 6d 6c 3a 23 61 70 70  6c 69 63 61 74 69 6f 6e  |aml:#application|</span><br><span class="line">000001f0  2f 76 6e 64 2e 6b 75 62  65 72 6e 65 74 65 73 2e  |/vnd.kubernetes.|</span><br><span class="line">00000200  70 72 6f 74 6f 62 75 66  4a 6c 0a 51 0a 03 32 30  |protobufJl.Q..20|</span><br><span class="line">00000210  30 12 4a 0a 48 0a 02 4f  4b 12 42 0a 40 0a 3e 23  |0.J.H..OK.B.@.&gt;#|</span><br><span class="line">00000220  2f 64 65 66 69 6e 69 74  69 6f 6e 73 2f 69 6f 2e  |/definitions/io.|</span><br><span class="line">00000230  6b 38 73 2e 61 70 69 6d  61 63 68 69 6e 65 72 79  |k8s.apimachinery|</span><br><span class="line">00000240  2e 70 6b 67 2e 61 70 69  73 2e 6d 65 74 61 2e 76  |.pkg.apis.meta.v|</span><br><span class="line">00000250  31 2e 41 50 49 56 65 72  73 69 6f 6e 73 0a 17 0a  |1.APIVersions...|</span><br><span class="line">00000260  03 34 30 31 12 10 0a 0e  0a 0c 55 6e 61 75 74 68  |.401......Unauth|</span><br><span class="line">00000270  6f 72 69 7a 65 64 52 05  68 74 74 70 73 12 d4 02  |orizedR.https...|</span><br><span class="line">00000280  0a 08 2f 61 70 69 2f 76  31 2f 12 c7 02 12 c4 02  |../api/v1/......|</span><br><span class="line">00000290  0a 07 63 6f 72 65 5f 76  31 1a 17 67 65 74 20 61  |..core_v1..get a|</span><br><span class="line">000002a0  76 61 69 6c 61 62 6c 65  20 72 65 73 6f 75 72 63  |vailable resourc|</span><br><span class="line">000002b0  65 73 2a 15 67 65 74 43  6f 72 65 56 31 41 50 49  |es*.getCoreV1API|</span><br><span class="line">000002c0  52 65 73 6f 75 72 63 65  73 32 10 61 70 70 6c 69  |Resources2.appli|</span><br><span class="line">000002d0  63 61 74 69 6f 6e 2f 6a  73 6f 6e 32 10 61 70 70  |cation/json2.app|</span><br><span class="line">000002e0  6c 69 63 61 74 69 6f 6e  2f 79 61 6d 6c 32 23 61  |lication/yaml2#a|</span><br><span class="line">000002f0  70 70 6c 69 63 61 74 69  6f 6e 2f 76 6e 64 2e 6b  |pplication/vnd.k|</span><br><span class="line">00000300  75 62 65 72 6e 65 74 65  73 2e 70 72 6f 74 6f 62  |ubernetes.protob|</span><br><span class="line">00000310  75 66 3a 10 61 70 70 6c  69 63 61 74 69 6f 6e 2f  |uf:.application/|</span><br><span class="line">00000320  6a 73 6f 6e 3a 10 61 70  70 6c 69 63 61 74 69 6f  |json:.applicatio|</span><br><span class="line">00000330  6e 2f 79 61 6d 6c 3a 23  61 70 70 6c 69 63 61 74  |n/yaml:#applicat|</span><br><span class="line">00000340  69 6f 6e 2f 76 6e 64 2e  6b 75 62 65 72 6e 65 74  |ion/vnd.kubernet|</span><br><span class="line">00000350  65 73 2e 70 72 6f 74 6f  62 75 66 4a 70 0a 55 0a  |es.protobufJp.U.|</span><br><span class="line">00000360  03 32 30 30 12 4e 0a 4c  0a 02 4f 4b 12 46 0a 44  |.200.N.L..OK.F.D|</span><br><span class="line">00000370  0a 42 23 2f 64 65 66 69  6e 69 74 69 6f 6e 73 2f  |.B#/definitions/|</span><br><span class="line">00000380  69 6f 2e 6b 38 73 2e 61  70 69 6d 61 63 68 69 6e  |io.k8s.apimachin|</span><br><span class="line">00000390  65 72 79 2e 70 6b 67 2e  61 70 69 73 2e 6d 65 74  |ery.pkg.apis.met|</span><br><span class="line">000003a0  61 2e 76 31 2e 41 50 49  52 65 73 6f 75 72 63 65  |a.v1.APIResource|</span><br><span class="line">000003b0  4c 69 73 74 0a 17 0a 03  34 30 31 12 10 0a 0e 0a  |List....401.....|</span><br><span class="line">000003c0  0c 55 6e 61 75 74 68 6f  72 69 7a 65 64 52 05 68  |.UnauthorizedR.h|</span><br><span class="line">000003d0  74 74 70 73 12 9a 26 0a  19 2f 61 70 69 2f 76 31  |ttps..&amp;../api/v1|</span><br><span class="line">000003e0  2f 63 6f 6d 70 6f 6e 65  6e 74 73 74 61 74 75 73  |/componentstatus|</span><br><span class="line">000003f0  65 73 12 fc 25 12 c7 03  0a 07 63 6f 72 65 5f 76  |es..%.....core_v|</span><br><span class="line">00000400  31 1a 24 6c 69 73 74 20  6f 62 6a 65 63 74 73 20  |1.$list objects |</span><br><span class="line">00000410  6f 66 20 6b 69 6e 64 20  43 6f 6d 70 6f 6e 65 6e  |of kind Componen|</span><br><span class="line">00000420  74 53 74 61 74 75 73 2a  19 6c 69 73 74 43 6f 72  |tStatus*.listCor|</span><br><span class="line">00000430  65 56 31 43 6f 6d 70 6f  6e 65 6e 74 53 74 61 74  |eV1ComponentStat|</span><br><span class="line">00000440  75 73 32 10 61 70 70 6c  69 63 61 74 69 6f 6e 2f  |us2.application/|</span><br><span class="line">00000450  6a 73 6f 6e 32 10 61 70  70 6c 69 63 61 74 69 6f  |json2.applicatio|</span><br><span class="line">00000460  6e 2f 79 61 6d 6c 32 23  61 70 70 6c 69 63 61 74  |n/yaml2#applicat|</span><br><span class="line">00000470  69 6f 6e 2f 76 6e 64 2e  6b 75 62 65 72 6e 65 74  |ion/vnd.kubernet|</span><br><span class="line">00000480  65 73 2e 70 72 6f 74 6f  62 75 66 32 1d 61 70 70  |es.protobuf2.app|</span><br><span class="line">00000490  6c 69 63 61 74 69 6f 6e  2f 6a 73 6f 6e 3b 73 74  |lication/json;st|</span><br><span class="line">000004a0  72 65 61 6d 3d 77 61 74  63 68 32 30 61 70 70 6c  |ream=watch20appl|</span><br><span class="line">000004b0  69 63 61 74 69 6f 6e 2f  76 6e 64 2e 6b 75 62 65  |ication/vnd.kube|</span><br><span class="line">000004c0  72 6e 65 74 65 73 2e 70  72 6f 74 6f 62 75 66 3b  |rnetes.protobuf;|</span><br><span class="line">000004d0  73 74 72 65 61 6d 3d 77  61 74 63 68 3a 03 2a 2f  |stream=watch:.*/|</span><br><span class="line">000004e0  2a 4a 62 0a 47 0a 03 32  30 30 12 40 0a 3e 0a 02  |*Jb.G..200.@.&gt;..|</span><br><span class="line">000004f0  4f 4b 12 38 0a 36 0a 34  23 2f 64 65 66 69 6e 69  |OK.8.6.4#/defini|</span><br><span class="line">00000500  74 69 6f 6e 73 2f 69 6f  2e 6b 38 73 2e 61 70 69  |tions/io.k8s.api|</span><br><span class="line">00000510  2e 63 6f 72 65 2e 76 31  2e 43 6f 6d 70 6f 6e 65  |.core.v1.Compone|</span><br><span class="line">00000520  6e 74 53 74 61 74 75 73  4c 69 73 74 0a 17 0a 03  |ntStatusList....|</span><br><span class="line">00000530  34 30 31 12 10 0a 0e 0a  0c 55 6e 61 75 74 68 6f  |401......Unautho|</span><br><span class="line">00000540  72 69 7a 65 64 52 05 68  74 74 70 73 6a 1e 0a 13  |rizedR.httpsj...|</span><br><span class="line">00000550  78 2d 6b 75 62 65 72 6e  65 74 65 73 2d 61 63 74  |x-kubernetes-act|</span><br><span class="line">00000560  69 6f 6e 12 07 12 05 6c  69 73 74 0a 6a 51 0a 1f  |ion....list.jQ..|</span><br><span class="line">00000570  78 2d 6b 75 62 65 72 6e  65 74 65 73 2d 67 72 6f  |x-kubernetes-gro|</span><br><span class="line">00000580  75 70 2d 76 65 72 73 69  6f 6e 2d 6b 69 6e 64 12  |up-version-kind.|</span><br><span class="line">00000590  2e 12 2c 67 72 6f 75 70  3a 20 22 22 0a 6b 69 6e  |..,group: &quot;&quot;.kin|</span><br><span class="line">000005a0  64 3a 20 43 6f 6d 70 6f  6e 65 6e 74 53 74 61 74  |d: ComponentStat|</span><br><span class="line">000005b0  75 73 0a 76 65 72 73 69  6f 6e 3a 20 76 31 0a 4a  |us.version: v1.J|</span><br><span class="line">000005c0  ab 03 0a a8 03 12 a5 03  1a a2 03 12 05 71 75 65  |.............que|</span><br><span class="line">000005d0  72 79 1a f7 02 61 6c 6c  6f 77 57 61 74 63 68 42  |ry...allowWatchB|</span><br><span class="line">000005e0  6f 6f 6b 6d 61 72 6b 73  20 72 65 71 75 65 73 74  |ookmarks request|</span><br><span class="line">000005f0  73 20 77 61 74 63 68 20  65 76 65 6e 74 73 20 77  |s watch events w|</span><br><span class="line">00000600  69 74 68 20 74 79 70 65  20 22 42 4f 4f 4b 4d 41  |ith type &quot;BOOKMA|</span><br><span class="line">00000610  52 4b 22 2e 20 53 65 72  76 65 72 73 20 74 68 61  |RK&quot;. Servers tha|</span><br><span class="line">00000620  74 20 64 6f 20 6e 6f 74  20 69 6d 70 6c 65 6d 65  |t do not impleme|</span><br><span class="line">00000630  6e 74 20 62 6f 6f 6b 6d  61 72 6b 73 20 6d 61 79  |nt bookmarks may|</span><br><span class="line">00000640  20 69 67 6e 6f 72 65 20  74 68 69 73 20 66 6c 61  | ignore this fla|</span><br><span class="line">00000650  67 20 61 6e 64 20 62 6f  6f 6b 6d 61 72 6b 73 20  |g and bookmarks |</span><br><span class="line">00000660  61 72 65 20 73 65 6e 74  20 61 74 20 74 68 65 20  |are sent at the |</span><br><span class="line">00000670  73 65 72 76 65 72 27 73  20 64 69 73 63 72 65 74  |server&#x27;s discret|</span><br><span class="line">00000680  69 6f 6e 2e 20 43 6c 69  65 6e 74 73 20 73 68 6f  |ion. Clients sho|</span><br><span class="line">00000690  75 6c 64 20 6e 6f 74 20  61 73 73 75 6d 65 20 62  |uld not assume b|</span><br><span class="line">000006a0  6f 6f 6b 6d 61 72 6b 73  20 61 72 65 20 72 65 74  |ookmarks are ret|</span><br><span class="line">000006b0  75 72 6e 65 64 20 61 74  20 61 6e 79 20 73 70 65  |urned at any spe|</span><br><span class="line">000006c0  63 69 66 69 63 20 69 6e  74 65 72 76 61 6c 2c 20  |cific interval, |</span><br><span class="line">000006d0  6e 6f 72 20 6d 61 79 20  74 68 65 79 20 61 73 73  |nor may they ass|</span><br><span class="line">000006e0  75 6d 65 20 74 68 65 20  73 65 72 76 65 72 20 77  |ume the server w|</span><br><span class="line">000006f0  69 6c 6c 20 73 65 6e 64  20 61 6e 79 20 42 4f 4f  |ill send any BOO|</span><br><span class="line">00000700  4b 4d 41 52 4b 20 65 76  65 6e 74 20 64 75 72 69  |KMARK event duri|</span><br><span class="line">00000710  6e 67 20 61 20 73 65 73  73 69 6f 6e 2e 20 49 66  |ng a session. If|</span><br><span class="line">00000720  20 74 68 69 73 20 69 73  20 6e 6f 74 20 61 20 77  | this is not a w|</span><br><span class="line">00000730  61 74 63 68 2c 20 74 68  69 73 20 66 69 65 6c 64  |atch, this field|</span><br><span class="line">00000740  20 69 73 20 69 67 6e 6f  72 65 64 2e 22 13 61 6c  | is ignored.&quot;.al|</span><br><span class="line">00000750  6c 6f 77 57 61 74 63 68  42 6f 6f 6b 6d 61 72 6b  |lowWatchBookmark|</span><br><span class="line">00000760  73 32 07 62 6f 6f 6c 65  61 6e a0 01 01 4a ef 09  |s2.boolean...J..|</span><br><span class="line">00000770  0a ec 09 12 e9 09 1a e6  09 12 05 71 75 65 72 79  |...........query|</span><br><span class="line">00000780  1a c7 09 54 68 65 20 63  6f 6e 74 69 6e 75 65 20  |...The continue |</span><br><span class="line">00000790  6f 70 74 69 6f 6e 20 73  68 6f 75 6c 64 20 62 65  |option should be|</span><br><span class="line">000007a0  20 73 65 74 20 77 68 65  6e 20 72 65 74 72 69 65  | set when retrie|</span><br><span class="line">000007b0  76 69 6e 67 20 6d 6f 72  65 20 72 65 73 75 6c 74  |ving more result|</span><br><span class="line">000007c0  73 20 66 72 6f 6d 20 74  68 65 20 73 65 72 76 65  |s from the serve|</span><br><span class="line">000007d0  72 2e 20 53 69 6e 63 65  20 74 68 69 73 20 76 61  |r. Since this va|</span><br><span class="line">000007e0  6c 75 65 20 69 73 20 73  65 72 76 65 72 20 64 65  |lue is server de|</span><br><span class="line">000007f0  66 69 6e 65 64 2c 20 63  6c 69 65 6e 74 73 20 6d  |fined, clients m|</span><br><span class="line">00000800  61 79 20 6f 6e 6c 79 20  75 73 65 20 74 68 65 20  |ay only use the |</span><br><span class="line">00000810  63 6f 6e 74 69 6e 75 65  20 76 61 6c 75 [truncated 20865904 chars]</span><br><span class="line">I0715 13:22:49.323719  453970 round_trippers.go:435] curl -v -XGET  -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; -H &quot;Accept: application/json&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts&#x27;</span><br><span class="line">I0715 13:22:49.325046  453970 round_trippers.go:454] GET https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts 200 OK in 1 milliseconds</span><br><span class="line">I0715 13:22:49.325087  453970 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:22:49.325094  453970 round_trippers.go:463]     Audit-Id: 6e820860-b22a-4d73-99c9-286e6992378b</span><br><span class="line">I0715 13:22:49.325098  453970 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:22:49.325101  453970 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0715 13:22:49.325104  453970 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:22:49.325109  453970 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:22:49.325112  453970 round_trippers.go:463]     Content-Length: 765</span><br><span class="line">I0715 13:22:49.325115  453970 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:22:49 GMT</span><br><span class="line">I0715 13:22:49.325131  453970 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;ResourceQuota&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;object-counts&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;1ea31ccc-7d3f-4098-bfb2-a93180e83e49&quot;,&quot;resourceVersion&quot;:&quot;34719&quot;,&quot;creationTimestamp&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-controller-manager&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:status&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;,&quot;f:used&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;,&quot;subresource&quot;:&quot;status&quot;&#125;,&#123;&quot;manager&quot;:&quot;kubectl-create&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;&#125;,&quot;status&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;,&quot;used&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;&#125;&#125;</span><br><span class="line">I0715 13:22:49.325242  453970 request.go:1181] Request Body: &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;ResourceQuota&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;object-counts&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;resourceVersion&quot;:&quot;34719&quot;&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;2&quot;&#125;&#125;&#125;</span><br><span class="line">I0715 13:22:49.325278  453970 round_trippers.go:435] curl -v -XPUT  -H &quot;Accept: application/json&quot; -H &quot;Content-Type: application/json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts?fieldManager=kubectl-replace&#x27;</span><br><span class="line">I0715 13:22:49.326666  453970 round_trippers.go:454] PUT https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts?fieldManager=kubectl-replace 200 OK in 1 milliseconds</span><br><span class="line">I0715 13:22:49.326697  453970 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:22:49.326700  453970 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0715 13:22:49.326702  453970 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:22:49.326704  453970 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:22:49.326706  453970 round_trippers.go:463]     Content-Length: 917</span><br><span class="line">I0715 13:22:49.326708  453970 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:22:49 GMT</span><br><span class="line">I0715 13:22:49.326709  453970 round_trippers.go:463]     Audit-Id: 9a81b774-c4fe-4f91-b50b-0a081bb99bdb</span><br><span class="line">I0715 13:22:49.326711  453970 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:22:49.326721  453970 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;ResourceQuota&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;object-counts&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;1ea31ccc-7d3f-4098-bfb2-a93180e83e49&quot;,&quot;resourceVersion&quot;:&quot;34748&quot;,&quot;creationTimestamp&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-controller-manager&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:status&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;,&quot;f:used&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;,&quot;subresource&quot;:&quot;status&quot;&#125;,&#123;&quot;manager&quot;:&quot;kubectl-create&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&#125;&#125;&#125;&#125;,&#123;&quot;manager&quot;:&quot;kubectl-replace&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:49Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;2&quot;&#125;&#125;,&quot;status&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;,&quot;used&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;&#125;&#125;</span><br><span class="line">resourcequota/object-counts replaced</span><br></pre></td></tr></table></figure>

<blockquote>
<p>apply - PATCH - Diff</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f quota.yaml -v 9</span><br><span class="line">I0715 13:24:45.122395  456063 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0715 13:24:45.123172  456063 round_trippers.go:435] curl -v -XGET  -H &quot;Accept: application/com.github.proto-openapi.spec.v2@v1.0+protobuf&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/openapi/v2?timeout=32s&#x27;</span><br><span class="line">I0715 13:24:45.146630  456063 round_trippers.go:454] GET https://192.168.191.138:6443/openapi/v2?timeout=32s 200 OK in 23 milliseconds</span><br><span class="line">I0715 13:24:45.146650  456063 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:24:45.146652  456063 round_trippers.go:463]     Accept-Ranges: bytes</span><br><span class="line">I0715 13:24:45.146654  456063 round_trippers.go:463]     Audit-Id: 6ab405f3-8dd1-4ad3-ac3f-e36efab99f74</span><br><span class="line">I0715 13:24:45.146656  456063 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:24:45.146658  456063 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:24:45 GMT</span><br><span class="line">I0715 13:24:45.146660  456063 round_trippers.go:463]     Last-Modified: Tue, 30 May 2022 02:00:47 GMT</span><br><span class="line">I0715 13:24:45.146661  456063 round_trippers.go:463]     Vary: Accept-Encoding</span><br><span class="line">I0715 13:24:45.146663  456063 round_trippers.go:463]     Vary: Accept</span><br><span class="line">I0715 13:24:45.146665  456063 round_trippers.go:463]     X-Varied-Accept: application/com.github.proto-openapi.spec.v2@v1.0+protobuf</span><br><span class="line">I0715 13:24:45.146673  456063 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:24:45.146678  456063 round_trippers.go:463]     Content-Type: application/octet-stream</span><br><span class="line">I0715 13:24:45.146679  456063 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:24:45.146681  456063 round_trippers.go:463]     Etag: &quot;16EDF837BE1F7591619543929575D12CB44EF9CA045DD612D1C78212BD9DD25D2E838683496297E3C87779ED322106670C9D598130BA223857EB7BD925CB8D61&quot;</span><br><span class="line">I0715 13:24:45.146686  456063 round_trippers.go:463]     X-From-Cache: 1</span><br><span class="line">I0715 13:24:45.210494  456063 request.go:1179] Response Body:</span><br><span class="line">00000000  0a 03 32 2e 30 12 15 0a  0a 4b 75 62 65 72 6e 65  |..2.0....Kuberne|</span><br><span class="line">00000010  74 65 73 12 07 76 31 2e  32 32 2e 32 42 95 f8 b3  |tes..v1.22.2B...|</span><br><span class="line">00000020  01 12 8c 02 0a 22 2f 2e  77 65 6c 6c 2d 6b 6e 6f  |.....&quot;/.well-kno|</span><br><span class="line">00000030  77 6e 2f 6f 70 65 6e 69  64 2d 63 6f 6e 66 69 67  |wn/openid-config|</span><br><span class="line">00000040  75 72 61 74 69 6f 6e 2f  12 e5 01 12 e2 01 0a 09  |uration/........|</span><br><span class="line">00000050  57 65 6c 6c 4b 6e 6f 77  6e 1a 57 67 65 74 20 73  |WellKnown.Wget s|</span><br><span class="line">00000060  65 72 76 69 63 65 20 61  63 63 6f 75 6e 74 20 69  |ervice account i|</span><br><span class="line">00000070  73 73 75 65 72 20 4f 70  65 6e 49 44 20 63 6f 6e  |ssuer OpenID con|</span><br><span class="line">00000080  66 69 67 75 72 61 74 69  6f 6e 2c 20 61 6c 73 6f  |figuration, also|</span><br><span class="line">00000090  20 6b 6e 6f 77 6e 20 61  73 20 74 68 65 20 27 4f  | known as the &#x27;O|</span><br><span class="line">000000a0  49 44 43 20 64 69 73 63  6f 76 65 72 79 20 64 6f  |IDC discovery do|</span><br><span class="line">000000b0  63 27 2a 2a 67 65 74 53  65 72 76 69 63 65 41 63  |c&#x27;**getServiceAc|</span><br><span class="line">000000c0  63 6f 75 6e 74 49 73 73  75 65 72 4f 70 65 6e 49  |countIssuerOpenI|</span><br><span class="line">000000d0  44 43 6f 6e 66 69 67 75  72 61 74 69 6f 6e 32 10  |DConfiguration2.|</span><br><span class="line">000000e0  61 70 70 6c 69 63 61 74  69 6f 6e 2f 6a 73 6f 6e  |application/json|</span><br><span class="line">000000f0  4a 37 0a 1c 0a 03 32 30  30 12 15 0a 13 0a 02 4f  |J7....200......O|</span><br><span class="line">00000100  4b 12 0d 0a 0b b2 01 08  0a 06 73 74 72 69 6e 67  |K.........string|</span><br><span class="line">00000110  0a 17 0a 03 34 30 31 12  10 0a 0e 0a 0c 55 6e 61  |....401......Una|</span><br><span class="line">00000120  75 74 68 6f 72 69 7a 65  64 52 05 68 74 74 70 73  |uthorizedR.https|</span><br><span class="line">00000130  12 ca 02 0a 05 2f 61 70  69 2f 12 c0 02 12 bd 02  |...../api/......|</span><br><span class="line">00000140  0a 04 63 6f 72 65 1a 1a  67 65 74 20 61 76 61 69  |..core..get avai|</span><br><span class="line">00000150  6c 61 62 6c 65 20 41 50  49 20 76 65 72 73 69 6f  |lable API versio|</span><br><span class="line">00000160  6e 73 2a 12 67 65 74 43  6f 72 65 41 50 49 56 65  |ns*.getCoreAPIVe|</span><br><span class="line">00000170  72 73 69 6f 6e 73 32 10  61 70 70 6c 69 63 61 74  |rsions2.applicat|</span><br><span class="line">00000180  69 6f 6e 2f 6a 73 6f 6e  32 10 61 70 70 6c 69 63  |ion/json2.applic|</span><br><span class="line">00000190  61 74 69 6f 6e 2f 79 61  6d 6c 32 23 61 70 70 6c  |ation/yaml2#appl|</span><br><span class="line">000001a0  69 63 61 74 69 6f 6e 2f  76 6e 64 2e 6b 75 62 65  |ication/vnd.kube|</span><br><span class="line">000001b0  72 6e 65 74 65 73 2e 70  72 6f 74 6f 62 75 66 3a  |rnetes.protobuf:|</span><br><span class="line">000001c0  10 61 70 70 6c 69 63 61  74 69 6f 6e 2f 6a 73 6f  |.application/jso|</span><br><span class="line">000001d0  6e 3a 10 61 70 70 6c 69  63 61 74 69 6f 6e 2f 79  |n:.application/y|</span><br><span class="line">000001e0  61 6d 6c 3a 23 61 70 70  6c 69 63 61 74 69 6f 6e  |aml:#application|</span><br><span class="line">000001f0  2f 76 6e 64 2e 6b 75 62  65 72 6e 65 74 65 73 2e  |/vnd.kubernetes.|</span><br><span class="line">00000200  70 72 6f 74 6f 62 75 66  4a 6c 0a 51 0a 03 32 30  |protobufJl.Q..20|</span><br><span class="line">00000210  30 12 4a 0a 48 0a 02 4f  4b 12 42 0a 40 0a 3e 23  |0.J.H..OK.B.@.&gt;#|</span><br><span class="line">00000220  2f 64 65 66 69 6e 69 74  69 6f 6e 73 2f 69 6f 2e  |/definitions/io.|</span><br><span class="line">00000230  6b 38 73 2e 61 70 69 6d  61 63 68 69 6e 65 72 79  |k8s.apimachinery|</span><br><span class="line">00000240  2e 70 6b 67 2e 61 70 69  73 2e 6d 65 74 61 2e 76  |.pkg.apis.meta.v|</span><br><span class="line">00000250  31 2e 41 50 49 56 65 72  73 69 6f 6e 73 0a 17 0a  |1.APIVersions...|</span><br><span class="line">00000260  03 34 30 31 12 10 0a 0e  0a 0c 55 6e 61 75 74 68  |.401......Unauth|</span><br><span class="line">00000270  6f 72 69 7a 65 64 52 05  68 74 74 70 73 12 d4 02  |orizedR.https...|</span><br><span class="line">00000280  0a 08 2f 61 70 69 2f 76  31 2f 12 c7 02 12 c4 02  |../api/v1/......|</span><br><span class="line">00000290  0a 07 63 6f 72 65 5f 76  31 1a 17 67 65 74 20 61  |..core_v1..get a|</span><br><span class="line">000002a0  76 61 69 6c 61 62 6c 65  20 72 65 73 6f 75 72 63  |vailable resourc|</span><br><span class="line">000002b0  65 73 2a 15 67 65 74 43  6f 72 65 56 31 41 50 49  |es*.getCoreV1API|</span><br><span class="line">000002c0  52 65 73 6f 75 72 63 65  73 32 10 61 70 70 6c 69  |Resources2.appli|</span><br><span class="line">000002d0  63 61 74 69 6f 6e 2f 6a  73 6f 6e 32 10 61 70 70  |cation/json2.app|</span><br><span class="line">000002e0  6c 69 63 61 74 69 6f 6e  2f 79 61 6d 6c 32 23 61  |lication/yaml2#a|</span><br><span class="line">000002f0  70 70 6c 69 63 61 74 69  6f 6e 2f 76 6e 64 2e 6b  |pplication/vnd.k|</span><br><span class="line">00000300  75 62 65 72 6e 65 74 65  73 2e 70 72 6f 74 6f 62  |ubernetes.protob|</span><br><span class="line">00000310  75 66 3a 10 61 70 70 6c  69 63 61 74 69 6f 6e 2f  |uf:.application/|</span><br><span class="line">00000320  6a 73 6f 6e 3a 10 61 70  70 6c 69 63 61 74 69 6f  |json:.applicatio|</span><br><span class="line">00000330  6e 2f 79 61 6d 6c 3a 23  61 70 70 6c 69 63 61 74  |n/yaml:#applicat|</span><br><span class="line">00000340  69 6f 6e 2f 76 6e 64 2e  6b 75 62 65 72 6e 65 74  |ion/vnd.kubernet|</span><br><span class="line">00000350  65 73 2e 70 72 6f 74 6f  62 75 66 4a 70 0a 55 0a  |es.protobufJp.U.|</span><br><span class="line">00000360  03 32 30 30 12 4e 0a 4c  0a 02 4f 4b 12 46 0a 44  |.200.N.L..OK.F.D|</span><br><span class="line">00000370  0a 42 23 2f 64 65 66 69  6e 69 74 69 6f 6e 73 2f  |.B#/definitions/|</span><br><span class="line">00000380  69 6f 2e 6b 38 73 2e 61  70 69 6d 61 63 68 69 6e  |io.k8s.apimachin|</span><br><span class="line">00000390  65 72 79 2e 70 6b 67 2e  61 70 69 73 2e 6d 65 74  |ery.pkg.apis.met|</span><br><span class="line">000003a0  61 2e 76 31 2e 41 50 49  52 65 73 6f 75 72 63 65  |a.v1.APIResource|</span><br><span class="line">000003b0  4c 69 73 74 0a 17 0a 03  34 30 31 12 10 0a 0e 0a  |List....401.....|</span><br><span class="line">000003c0  0c 55 6e 61 75 74 68 6f  72 69 7a 65 64 52 05 68  |.UnauthorizedR.h|</span><br><span class="line">000003d0  74 74 70 73 12 9a 26 0a  19 2f 61 70 69 2f 76 31  |ttps..&amp;../api/v1|</span><br><span class="line">000003e0  2f 63 6f 6d 70 6f 6e 65  6e 74 73 74 61 74 75 73  |/componentstatus|</span><br><span class="line">000003f0  65 73 12 fc 25 12 c7 03  0a 07 63 6f 72 65 5f 76  |es..%.....core_v|</span><br><span class="line">00000400  31 1a 24 6c 69 73 74 20  6f 62 6a 65 63 74 73 20  |1.$list objects |</span><br><span class="line">00000410  6f 66 20 6b 69 6e 64 20  43 6f 6d 70 6f 6e 65 6e  |of kind Componen|</span><br><span class="line">00000420  74 53 74 61 74 75 73 2a  19 6c 69 73 74 43 6f 72  |tStatus*.listCor|</span><br><span class="line">00000430  65 56 31 43 6f 6d 70 6f  6e 65 6e 74 53 74 61 74  |eV1ComponentStat|</span><br><span class="line">00000440  75 73 32 10 61 70 70 6c  69 63 61 74 69 6f 6e 2f  |us2.application/|</span><br><span class="line">00000450  6a 73 6f 6e 32 10 61 70  70 6c 69 63 61 74 69 6f  |json2.applicatio|</span><br><span class="line">00000460  6e 2f 79 61 6d 6c 32 23  61 70 70 6c 69 63 61 74  |n/yaml2#applicat|</span><br><span class="line">00000470  69 6f 6e 2f 76 6e 64 2e  6b 75 62 65 72 6e 65 74  |ion/vnd.kubernet|</span><br><span class="line">00000480  65 73 2e 70 72 6f 74 6f  62 75 66 32 1d 61 70 70  |es.protobuf2.app|</span><br><span class="line">00000490  6c 69 63 61 74 69 6f 6e  2f 6a 73 6f 6e 3b 73 74  |lication/json;st|</span><br><span class="line">000004a0  72 65 61 6d 3d 77 61 74  63 68 32 30 61 70 70 6c  |ream=watch20appl|</span><br><span class="line">000004b0  69 63 61 74 69 6f 6e 2f  76 6e 64 2e 6b 75 62 65  |ication/vnd.kube|</span><br><span class="line">000004c0  72 6e 65 74 65 73 2e 70  72 6f 74 6f 62 75 66 3b  |rnetes.protobuf;|</span><br><span class="line">000004d0  73 74 72 65 61 6d 3d 77  61 74 63 68 3a 03 2a 2f  |stream=watch:.*/|</span><br><span class="line">000004e0  2a 4a 62 0a 47 0a 03 32  30 30 12 40 0a 3e 0a 02  |*Jb.G..200.@.&gt;..|</span><br><span class="line">000004f0  4f 4b 12 38 0a 36 0a 34  23 2f 64 65 66 69 6e 69  |OK.8.6.4#/defini|</span><br><span class="line">00000500  74 69 6f 6e 73 2f 69 6f  2e 6b 38 73 2e 61 70 69  |tions/io.k8s.api|</span><br><span class="line">00000510  2e 63 6f 72 65 2e 76 31  2e 43 6f 6d 70 6f 6e 65  |.core.v1.Compone|</span><br><span class="line">00000520  6e 74 53 74 61 74 75 73  4c 69 73 74 0a 17 0a 03  |ntStatusList....|</span><br><span class="line">00000530  34 30 31 12 10 0a 0e 0a  0c 55 6e 61 75 74 68 6f  |401......Unautho|</span><br><span class="line">00000540  72 69 7a 65 64 52 05 68  74 74 70 73 6a 1e 0a 13  |rizedR.httpsj...|</span><br><span class="line">00000550  78 2d 6b 75 62 65 72 6e  65 74 65 73 2d 61 63 74  |x-kubernetes-act|</span><br><span class="line">00000560  69 6f 6e 12 07 12 05 6c  69 73 74 0a 6a 51 0a 1f  |ion....list.jQ..|</span><br><span class="line">00000570  78 2d 6b 75 62 65 72 6e  65 74 65 73 2d 67 72 6f  |x-kubernetes-gro|</span><br><span class="line">00000580  75 70 2d 76 65 72 73 69  6f 6e 2d 6b 69 6e 64 12  |up-version-kind.|</span><br><span class="line">00000590  2e 12 2c 67 72 6f 75 70  3a 20 22 22 0a 6b 69 6e  |..,group: &quot;&quot;.kin|</span><br><span class="line">000005a0  64 3a 20 43 6f 6d 70 6f  6e 65 6e 74 53 74 61 74  |d: ComponentStat|</span><br><span class="line">000005b0  75 73 0a 76 65 72 73 69  6f 6e 3a 20 76 31 0a 4a  |us.version: v1.J|</span><br><span class="line">000005c0  ab 03 0a a8 03 12 a5 03  1a a2 03 12 05 71 75 65  |.............que|</span><br><span class="line">000005d0  72 79 1a f7 02 61 6c 6c  6f 77 57 61 74 63 68 42  |ry...allowWatchB|</span><br><span class="line">000005e0  6f 6f 6b 6d 61 72 6b 73  20 72 65 71 75 65 73 74  |ookmarks request|</span><br><span class="line">000005f0  73 20 77 61 74 63 68 20  65 76 65 6e 74 73 20 77  |s watch events w|</span><br><span class="line">00000600  69 74 68 20 74 79 70 65  20 22 42 4f 4f 4b 4d 41  |ith type &quot;BOOKMA|</span><br><span class="line">00000610  52 4b 22 2e 20 53 65 72  76 65 72 73 20 74 68 61  |RK&quot;. Servers tha|</span><br><span class="line">00000620  74 20 64 6f 20 6e 6f 74  20 69 6d 70 6c 65 6d 65  |t do not impleme|</span><br><span class="line">00000630  6e 74 20 62 6f 6f 6b 6d  61 72 6b 73 20 6d 61 79  |nt bookmarks may|</span><br><span class="line">00000640  20 69 67 6e 6f 72 65 20  74 68 69 73 20 66 6c 61  | ignore this fla|</span><br><span class="line">00000650  67 20 61 6e 64 20 62 6f  6f 6b 6d 61 72 6b 73 20  |g and bookmarks |</span><br><span class="line">00000660  61 72 65 20 73 65 6e 74  20 61 74 20 74 68 65 20  |are sent at the |</span><br><span class="line">00000670  73 65 72 76 65 72 27 73  20 64 69 73 63 72 65 74  |server&#x27;s discret|</span><br><span class="line">00000680  69 6f 6e 2e 20 43 6c 69  65 6e 74 73 20 73 68 6f  |ion. Clients sho|</span><br><span class="line">00000690  75 6c 64 20 6e 6f 74 20  61 73 73 75 6d 65 20 62  |uld not assume b|</span><br><span class="line">000006a0  6f 6f 6b 6d 61 72 6b 73  20 61 72 65 20 72 65 74  |ookmarks are ret|</span><br><span class="line">000006b0  75 72 6e 65 64 20 61 74  20 61 6e 79 20 73 70 65  |urned at any spe|</span><br><span class="line">000006c0  63 69 66 69 63 20 69 6e  74 65 72 76 61 6c 2c 20  |cific interval, |</span><br><span class="line">000006d0  6e 6f 72 20 6d 61 79 20  74 68 65 79 20 61 73 73  |nor may they ass|</span><br><span class="line">000006e0  75 6d 65 20 74 68 65 20  73 65 72 76 65 72 20 77  |ume the server w|</span><br><span class="line">000006f0  69 6c 6c 20 73 65 6e 64  20 61 6e 79 20 42 4f 4f  |ill send any BOO|</span><br><span class="line">00000700  4b 4d 41 52 4b 20 65 76  65 6e 74 20 64 75 72 69  |KMARK event duri|</span><br><span class="line">00000710  6e 67 20 61 20 73 65 73  73 69 6f 6e 2e 20 49 66  |ng a session. If|</span><br><span class="line">00000720  20 74 68 69 73 20 69 73  20 6e 6f 74 20 61 20 77  | this is not a w|</span><br><span class="line">00000730  61 74 63 68 2c 20 74 68  69 73 20 66 69 65 6c 64  |atch, this field|</span><br><span class="line">00000740  20 69 73 20 69 67 6e 6f  72 65 64 2e 22 13 61 6c  | is ignored.&quot;.al|</span><br><span class="line">00000750  6c 6f 77 57 61 74 63 68  42 6f 6f 6b 6d 61 72 6b  |lowWatchBookmark|</span><br><span class="line">00000760  73 32 07 62 6f 6f 6c 65  61 6e a0 01 01 4a ef 09  |s2.boolean...J..|</span><br><span class="line">00000770  0a ec 09 12 e9 09 1a e6  09 12 05 71 75 65 72 79  |...........query|</span><br><span class="line">00000780  1a c7 09 54 68 65 20 63  6f 6e 74 69 6e 75 65 20  |...The continue |</span><br><span class="line">00000790  6f 70 74 69 6f 6e 20 73  68 6f 75 6c 64 20 62 65  |option should be|</span><br><span class="line">000007a0  20 73 65 74 20 77 68 65  6e 20 72 65 74 72 69 65  | set when retrie|</span><br><span class="line">000007b0  76 69 6e 67 20 6d 6f 72  65 20 72 65 73 75 6c 74  |ving more result|</span><br><span class="line">000007c0  73 20 66 72 6f 6d 20 74  68 65 20 73 65 72 76 65  |s from the serve|</span><br><span class="line">000007d0  72 2e 20 53 69 6e 63 65  20 74 68 69 73 20 76 61  |r. Since this va|</span><br><span class="line">000007e0  6c 75 65 20 69 73 20 73  65 72 76 65 72 20 64 65  |lue is server de|</span><br><span class="line">000007f0  66 69 6e 65 64 2c 20 63  6c 69 65 6e 74 73 20 6d  |fined, clients m|</span><br><span class="line">00000800  61 79 20 6f 6e 6c 79 20  75 73 65 20 74 68 65 20  |ay only use the |</span><br><span class="line">00000810  63 6f 6e 74 69 6e 75 65  20 76 61 6c 75 [truncated 20865904 chars]</span><br><span class="line">I0715 13:24:45.245653  456063 round_trippers.go:435] curl -v -XGET  -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; -H &quot;Accept: application/json&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts&#x27;</span><br><span class="line">I0715 13:24:45.246945  456063 round_trippers.go:454] GET https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts 200 OK in 1 milliseconds</span><br><span class="line">I0715 13:24:45.246957  456063 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:24:45.246961  456063 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:24:45.246968  456063 round_trippers.go:463]     Content-Length: 917</span><br><span class="line">I0715 13:24:45.246971  456063 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:24:45 GMT</span><br><span class="line">I0715 13:24:45.246975  456063 round_trippers.go:463]     Audit-Id: b97c38df-701a-4ec4-bf0b-66a1a3c88179</span><br><span class="line">I0715 13:24:45.246979  456063 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:24:45.246982  456063 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0715 13:24:45.246985  456063 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:24:45.246998  456063 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;ResourceQuota&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;object-counts&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;1ea31ccc-7d3f-4098-bfb2-a93180e83e49&quot;,&quot;resourceVersion&quot;:&quot;34749&quot;,&quot;creationTimestamp&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-controller-manager&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:status&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;,&quot;f:used&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;,&quot;subresource&quot;:&quot;status&quot;&#125;,&#123;&quot;manager&quot;:&quot;kubectl-create&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&#125;&#125;&#125;&#125;,&#123;&quot;manager&quot;:&quot;kubectl-replace&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:49Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;2&quot;&#125;&#125;,&quot;status&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;2&quot;&#125;,&quot;used&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;&#125;&#125;</span><br><span class="line">Warning: resource resourcequotas/object-counts is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span><br><span class="line">I0715 13:24:45.247163  456063 request.go:1181] Request Body: &#123;&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;kubectl.kubernetes.io/last-applied-configuration&quot;:&quot;&#123;\&quot;apiVersion\&quot;:\&quot;v1\&quot;,\&quot;kind\&quot;:\&quot;ResourceQuota\&quot;,\&quot;metadata\&quot;:&#123;\&quot;annotations\&quot;:&#123;&#125;,\&quot;name\&quot;:\&quot;object-counts\&quot;,\&quot;namespace\&quot;:\&quot;default\&quot;&#125;,\&quot;spec\&quot;:&#123;\&quot;hard\&quot;:&#123;\&quot;configmaps\&quot;:\&quot;3\&quot;&#125;&#125;&#125;\n&quot;&#125;&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;3&quot;&#125;&#125;&#125;</span><br><span class="line">I0715 13:24:45.247209  456063 round_trippers.go:435] curl -v -XPATCH  -H &quot;Accept: application/json&quot; -H &quot;Content-Type: application/strategic-merge-patch+json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts?fieldManager=kubectl-client-side-apply&#x27;</span><br><span class="line">I0715 13:24:45.249495  456063 round_trippers.go:454] PATCH https://192.168.191.138:6443/api/v1/namespaces/default/resourcequotas/object-counts?fieldManager=kubectl-client-side-apply 200 OK in 2 milliseconds</span><br><span class="line">I0715 13:24:45.249521  456063 round_trippers.go:460] Response Headers:</span><br><span class="line">I0715 13:24:45.249525  456063 round_trippers.go:463]     Content-Length: 1275</span><br><span class="line">I0715 13:24:45.249527  456063 round_trippers.go:463]     Date: Sat, 15 Jul 2022 13:24:45 GMT</span><br><span class="line">I0715 13:24:45.249530  456063 round_trippers.go:463]     Audit-Id: b1ce0e53-68aa-4e61-a6e0-97ebda77e53c</span><br><span class="line">I0715 13:24:45.249533  456063 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0715 13:24:45.249537  456063 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0715 13:24:45.249538  456063 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 2f005305-d15e-4252-bad1-edba0045f54d</span><br><span class="line">I0715 13:24:45.249540  456063 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: e2605faa-93d6-4d86-9ed5-dfd861e777f6</span><br><span class="line">I0715 13:24:45.249552  456063 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;ResourceQuota&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;object-counts&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;1ea31ccc-7d3f-4098-bfb2-a93180e83e49&quot;,&quot;resourceVersion&quot;:&quot;34945&quot;,&quot;creationTimestamp&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;annotations&quot;:&#123;&quot;kubectl.kubernetes.io/last-applied-configuration&quot;:&quot;&#123;\&quot;apiVersion\&quot;:\&quot;v1\&quot;,\&quot;kind\&quot;:\&quot;ResourceQuota\&quot;,\&quot;metadata\&quot;:&#123;\&quot;annotations\&quot;:&#123;&#125;,\&quot;name\&quot;:\&quot;object-counts\&quot;,\&quot;namespace\&quot;:\&quot;default\&quot;&#125;,\&quot;spec\&quot;:&#123;\&quot;hard\&quot;:&#123;\&quot;configmaps\&quot;:\&quot;3\&quot;&#125;&#125;&#125;\n&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-controller-manager&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:status&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;,&quot;f:used&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;,&quot;subresource&quot;:&quot;status&quot;&#125;,&#123;&quot;manager&quot;:&quot;kubectl-create&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:22:34Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&#125;&#125;&#125;&#125;,&#123;&quot;manager&quot;:&quot;kubectl-client-side-apply&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-15T13:24:45Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:annotations&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubectl.kubernetes.io/last-applied-configuration&quot;:&#123;&#125;&#125;&#125;,&quot;f:spec&quot;:&#123;&quot;f:hard&quot;:&#123;&quot;f:configmaps&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;,&quot;spec&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;3&quot;&#125;&#125;,&quot;status&quot;:&#123;&quot;hard&quot;:&#123;&quot;configmaps&quot;:&quot;2&quot;&#125;,&quot;used&quot;:&#123;&quot;configmaps&quot;:&quot;1&quot;&#125;&#125;&#125;</span><br><span class="line">resourcequota/object-counts configured</span><br><span class="line">I0715 13:24:45.249665  456063 apply.go:392] Running apply post-processor function</span><br></pre></td></tr></table></figure>

<h1 id="准入"><a href="#准入" class="headerlink" title="准入"></a>准入</h1><blockquote>
<p>场景</p>
</blockquote>
<ol>
<li><code>mutating admission</code> – 为资源增加<code>自定义属性</code>，如在上述<code>多租户</code>方案中<ul>
<li>需要在 Namespace 的准入控制中，获取用户信息，并将用户信息更新到 Namespace 的 Annotation 中</li>
</ul>
</li>
<li>配额管理 – 资源有限，如何限定某个用户有多少资源<ul>
<li>预定义每个 Namespace 的 <code>ResourceQuota</code>，并把 spec 保存为 configmap<ul>
<li>用户可以创建多少个 Pod：<code>BestEffortPod</code> &#x2F; <code>QoSPod</code></li>
<li>用户可以创建多少个 Service</li>
<li>用户可以创建多少个 Ingress</li>
<li>用户可以创建多少个 Service VIP</li>
</ul>
</li>
<li>创建 <code>ResourceQuota Controller</code><ul>
<li>监听 Namespace 创建事件，当 Namespace 创建时，在该 Namespace 创建对应的 <code>ResourceQuota</code> 对象</li>
</ul>
</li>
<li><code>API Server</code> 开启 ResourceQuota 的 <code>admission plugin</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>概述</p>
</blockquote>
<ol>
<li><code>Admission</code> 是在 <code>Authentication</code> 和 <code>Authorization</code> 之<code>后</code>，对请求做<code>进一步验证</code>或者<code>添加默认参数</code></li>
<li>区别<ul>
<li><code>Authentication</code> 和 <code>Authorization</code> 只关心请求的<code>用户</code>和<code>操作</code></li>
<li><code>Admission</code> 还处理请求的<code>内容</code>（创建、更新、删除、连接）</li>
</ul>
</li>
<li><code>Admission</code> 支持<code>同时开启</code>多个插件，<code>依次调用</code>，只有<code>全部插件都通过</code>的请求才可以放进入系统</li>
</ol>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><table>
<thead>
<tr>
<th>Plugin</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>AlwaysAdmit</code></td>
<td>接受<code>所有请求</code></td>
</tr>
<tr>
<td><code>AlwaysPullImages</code></td>
<td>总是拉取<code>最新镜像</code> - 多租户</td>
</tr>
<tr>
<td><code>DenyEscalatingExec</code></td>
<td>禁止特权容器的 <code>exec</code> 和 <code>attach</code> 操作</td>
</tr>
<tr>
<td><code>ImagePolicyWebhook</code></td>
<td>通过 Webhook 决定 image 策略，需要同时配置 <code>--admission-control-config-file</code></td>
</tr>
<tr>
<td><code>ServiceAccount</code></td>
<td>自动创建默认的 ServiceAccount，并确保 Pod 引用的 ServiceAccount 已经存在</td>
</tr>
<tr>
<td><code>SecurityContextDeny</code></td>
<td>拒绝包含非法 SecurityContext 配置的容器</td>
</tr>
<tr>
<td><code>ResourceQuota</code></td>
<td>限制 Pod 的请求不会超过<code>配额</code>，需要在 <code>Namespace</code> 下创建一个 ResourceQuota 对象</td>
</tr>
<tr>
<td><code>LimitRanger</code></td>
<td>为 Pod 设置<code>默认</code>资源请求和限制，需要在 <code>Namespace</code> 中创建一个 LimitRanger 对象</td>
</tr>
<tr>
<td><code>InitialResources</code></td>
<td>根据<code>镜像的历史使用记录</code>，为容器设置默认的资源请求和限制</td>
</tr>
<tr>
<td><code>NamespaceLifecycle</code></td>
<td>确保处于 <code>termination</code> 状态的 Namespace 不再接收新的对象创建请求，并拒绝请求不存在的 Namespace</td>
</tr>
<tr>
<td><code>DefaultStorageClass</code></td>
<td>为 PVC 设置默认的 StorageClass</td>
</tr>
<tr>
<td><code>DefaultTolerationSeconds</code></td>
<td>设置 Pod 的默认 <code>forgiveness toleration</code> 为 5 分钟</td>
</tr>
<tr>
<td><code>PodSecurityPolicy</code></td>
<td>使用 Pod Security Policies 时必须开启</td>
</tr>
<tr>
<td><code>NodeRestriction</code></td>
<td>限制 kubelet 仅可访问 node、endpoint、pod、service、secret、configmap、pv、pvc 等相关资源</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ k exec -it -n kube-system kube-apiserver-mac-k8s -- kube-apiserver --help</span><br><span class="line">...</span><br><span class="line">      --disable-admission-plugins strings</span><br><span class="line">                admission plugins that should be disabled although they are in the default enabled plugins list</span><br><span class="line">                (NamespaceLifecycle, LimitRanger, ServiceAccount, TaintNodesByCondition, PodSecurity, Priority,</span><br><span class="line">                DefaultTolerationSeconds, DefaultStorageClass, StorageObjectInUseProtection,</span><br><span class="line">                PersistentVolumeClaimResize, RuntimeClass, CertificateApproval, CertificateSigning,</span><br><span class="line">                CertificateSubjectRestriction, DefaultIngressClass, MutatingAdmissionWebhook,</span><br><span class="line">                ValidatingAdmissionWebhook, ResourceQuota). Comma-delimited list of admission plugins:</span><br><span class="line">                AlwaysAdmit, AlwaysDeny, AlwaysPullImages, CertificateApproval, CertificateSigning,</span><br><span class="line">                CertificateSubjectRestriction, DefaultIngressClass, DefaultStorageClass,</span><br><span class="line">                DefaultTolerationSeconds, DenyServiceExternalIPs, EventRateLimit, ExtendedResourceToleration,</span><br><span class="line">                ImagePolicyWebhook, LimitPodHardAntiAffinityTopology, LimitRanger, MutatingAdmissionWebhook,</span><br><span class="line">                NamespaceAutoProvision, NamespaceExists, NamespaceLifecycle, NodeRestriction,</span><br><span class="line">                OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize, PersistentVolumeLabel,</span><br><span class="line">                PodNodeSelector, PodSecurity, PodSecurityPolicy, PodTolerationRestriction, Priority,</span><br><span class="line">                ResourceQuota, RuntimeClass, SecurityContextDeny, ServiceAccount, StorageObjectInUseProtection,</span><br><span class="line">                TaintNodesByCondition, ValidatingAdmissionWebhook. The order of plugins in this flag does not matter.</span><br><span class="line">      --enable-admission-plugins strings</span><br><span class="line">                admission plugins that should be enabled in addition to default enabled ones</span><br><span class="line">                (NamespaceLifecycle, LimitRanger, ServiceAccount, TaintNodesByCondition, PodSecurity, Priority,</span><br><span class="line">                DefaultTolerationSeconds, DefaultStorageClass, StorageObjectInUseProtection,</span><br><span class="line">                PersistentVolumeClaimResize, RuntimeClass, CertificateApproval, CertificateSigning,</span><br><span class="line">                CertificateSubjectRestriction, DefaultIngressClass, MutatingAdmissionWebhook,</span><br><span class="line">                ValidatingAdmissionWebhook, ResourceQuota). Comma-delimited list of admission plugins:</span><br><span class="line">                AlwaysAdmit, AlwaysDeny, AlwaysPullImages, CertificateApproval, CertificateSigning,</span><br><span class="line">                CertificateSubjectRestriction, DefaultIngressClass, DefaultStorageClass,</span><br><span class="line">                DefaultTolerationSeconds, DenyServiceExternalIPs, EventRateLimit, ExtendedResourceToleration,</span><br><span class="line">                ImagePolicyWebhook, LimitPodHardAntiAffinityTopology, LimitRanger, MutatingAdmissionWebhook,</span><br><span class="line">                NamespaceAutoProvision, NamespaceExists, NamespaceLifecycle, NodeRestriction,</span><br><span class="line">                OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize, PersistentVolumeLabel,</span><br><span class="line">                PodNodeSelector, PodSecurity, PodSecurityPolicy, PodTolerationRestriction, Priority,</span><br><span class="line">                ResourceQuota, RuntimeClass, SecurityContextDeny, ServiceAccount, StorageObjectInUseProtection,</span><br><span class="line">                TaintNodesByCondition, ValidatingAdmissionWebhook. The order of plugins in this flag does not matter.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&#x27;admissionregistration.k8s.io&#x27;</span><br><span class="line">NAME                              SHORTNAMES   APIVERSION                        NAMESPACED   KIND</span><br><span class="line">mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1   false        MutatingWebhookConfiguration</span><br><span class="line">validatingwebhookconfigurations                admissionregistration.k8s.io/v1   false        ValidatingWebhookConfiguration</span><br><span class="line"></span><br><span class="line">$ k get mutatingwebhookconfigurations.admissionregistration.k8s.io</span><br><span class="line">No resources found</span><br><span class="line"></span><br><span class="line">$ k get validatingwebhookconfigurations.admissionregistration.k8s.io</span><br><span class="line">No resources found</span><br></pre></td></tr></table></figure>

<h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><blockquote>
<p>Kubernetes 预留了 Admission Plugin 的扩展点</p>
</blockquote>
<table>
<thead>
<tr>
<th>Plugin</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>MutatingWebhookConfiguration</code></td>
<td><code>变形</code>插件，支持对准入对象的<code>修改</code></td>
</tr>
<tr>
<td><code>ValidatingWebhookConfiguration</code></td>
<td><code>校验</code>插件，只能对准入对象合法性进行校验，不能修改（忽略修改）</td>
</tr>
</tbody></table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230716102922317.png" alt="image-20230716102922317"></p>
<h3 id="Webhook-Server"><a href="#Webhook-Server" class="headerlink" title="Webhook Server"></a>Webhook Server</h3><blockquote>
<p>Go</p>
</blockquote>
<figure class="highlight go"><figcaption><span>admission_controller.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">    admission <span class="string">&quot;k8s.io/api/admission/v1beta1&quot;</span></span><br><span class="line">    metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/runtime/serializer&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    jsonContentType = <span class="string">`application/json`</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    universalDeserializer = serializer.NewCodecFactory(runtime.NewScheme()).UniversalDeserializer()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// patchOperation is an operation of a JSON patch, see https://tools.ietf.org/html/rfc6902 .</span></span><br><span class="line"><span class="keyword">type</span> patchOperation <span class="keyword">struct</span> &#123;</span><br><span class="line">    Op    <span class="type">string</span>      <span class="string">`json:&quot;op&quot;`</span></span><br><span class="line">    Path  <span class="type">string</span>      <span class="string">`json:&quot;path&quot;`</span></span><br><span class="line">    Value <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;value,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// admitFunc is a callback for admission controller logic. Given an AdmissionRequest, it returns the sequence of patch</span></span><br><span class="line"><span class="comment">// operations to be applied in case of success, or the error that will be shown when the operation is rejected.</span></span><br><span class="line"><span class="keyword">type</span> admitFunc <span class="function"><span class="keyword">func</span><span class="params">(*admission.AdmissionRequest)</span></span> ([]patchOperation, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// isKubeNamespace checks if the given namespace is a Kubernetes-owned namespace.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isKubeNamespace</span><span class="params">(ns <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ns == metav1.NamespacePublic || ns == metav1.NamespaceSystem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// doServeAdmitFunc parses the HTTP request for an admission controller webhook, and -- in case of a well-formed</span></span><br><span class="line"><span class="comment">// request -- delegates the admission control logic to the given admitFunc. The response body is then returned as raw</span></span><br><span class="line"><span class="comment">// bytes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doServeAdmitFunc</span><span class="params">(w http.ResponseWriter, r *http.Request, admit admitFunc)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// Step 1: Request validation. Only handle POST requests with a body and json content type.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> r.Method != http.MethodPost &#123;</span><br><span class="line">        w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;invalid method %s, only POST requests are allowed&quot;</span>, r.Method)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    body, err := ioutil.ReadAll(r.Body)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;could not read request body: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> contentType := r.Header.Get(<span class="string">&quot;Content-Type&quot;</span>); contentType != jsonContentType &#123;</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unsupported content type %s, only %s is supported&quot;</span>, contentType, jsonContentType)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: Parse the AdmissionReview request.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> admissionReviewReq admission.AdmissionReview</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, _, err := universalDeserializer.Decode(body, <span class="literal">nil</span>, &amp;admissionReviewReq); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;could not deserialize request: %v&quot;</span>, err)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> admissionReviewReq.Request == <span class="literal">nil</span> &#123;</span><br><span class="line">        w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;malformed admission review: request is nil&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3: Construct the AdmissionReview response.</span></span><br><span class="line"></span><br><span class="line">    admissionReviewResponse := admission.AdmissionReview&#123;</span><br><span class="line">        <span class="comment">// Since the admission webhook now supports multiple API versions, we need</span></span><br><span class="line">        <span class="comment">// to explicitly include the API version in the response.</span></span><br><span class="line">        <span class="comment">// This API version needs to match the version from the request exactly, otherwise</span></span><br><span class="line">        <span class="comment">// the API server will be unable to process the response.</span></span><br><span class="line">        <span class="comment">// Note: a v1beta1 AdmissionReview is JSON-compatible with the v1 version, that&#x27;s why</span></span><br><span class="line">        <span class="comment">// we do not need to differentiate during unmarshaling or in the actual logic.</span></span><br><span class="line">        TypeMeta: metav1.TypeMeta&#123;</span><br><span class="line">            Kind:       <span class="string">&quot;AdmissionReview&quot;</span>,</span><br><span class="line">            APIVersion: <span class="string">&quot;admission.k8s.io/v1&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        Response: &amp;admission.AdmissionResponse&#123;</span><br><span class="line">            UID: admissionReviewReq.Request.UID,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> patchOps []patchOperation</span><br><span class="line">    <span class="comment">// Apply the admit() function only for non-Kubernetes namespaces. For objects in Kubernetes namespaces, return</span></span><br><span class="line">    <span class="comment">// an empty set of patch operations.</span></span><br><span class="line">    <span class="keyword">if</span> !isKubeNamespace(admissionReviewReq.Request.Namespace) &#123;</span><br><span class="line">        patchOps, err = admit(admissionReviewReq.Request)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// If the handler returned an error, incorporate the error message into the response and deny the object</span></span><br><span class="line">        <span class="comment">// creation.</span></span><br><span class="line">        admissionReviewResponse.Response.Allowed = <span class="literal">false</span></span><br><span class="line">        admissionReviewResponse.Response.Result = &amp;metav1.Status&#123;</span><br><span class="line">            Message: err.Error(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Otherwise, encode the patch operations to JSON and return a positive response.</span></span><br><span class="line">        patchBytes, err := json.Marshal(patchOps)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;could not marshal JSON patch: %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">        admissionReviewResponse.Response.Allowed = <span class="literal">true</span></span><br><span class="line">        admissionReviewResponse.Response.Patch = patchBytes</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Announce that we are returning a JSON patch (note: this is the only</span></span><br><span class="line">        <span class="comment">// patch type currently supported, but we have to explicitly announce</span></span><br><span class="line">        <span class="comment">// it nonetheless).</span></span><br><span class="line">        admissionReviewResponse.Response.PatchType = <span class="built_in">new</span>(admission.PatchType)</span><br><span class="line">        *admissionReviewResponse.Response.PatchType = admission.PatchTypeJSONPatch</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the AdmissionReview with a response as JSON.</span></span><br><span class="line">    bytes, err := json.Marshal(&amp;admissionReviewResponse)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;marshaling response: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bytes, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// serveAdmitFunc is a wrapper around doServeAdmitFunc that adds error handling and logging.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serveAdmitFunc</span><span class="params">(w http.ResponseWriter, r *http.Request, admit admitFunc)</span></span> &#123;</span><br><span class="line">    log.Print(<span class="string">&quot;Handling webhook request ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> writeErr <span class="type">error</span></span><br><span class="line">    <span class="keyword">if</span> bytes, err := doServeAdmitFunc(w, r, admit); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Error handling webhook request: %v&quot;</span>, err)</span><br><span class="line">        w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">        _, writeErr = w.Write([]<span class="type">byte</span>(err.Error()))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.Print(<span class="string">&quot;Webhook request handled successfully&quot;</span>)</span><br><span class="line">        _, writeErr = w.Write(bytes)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> writeErr != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Could not write response: %v&quot;</span>, writeErr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// admitFuncHandler takes an admitFunc and wraps it into a http.Handler by means of calling serveAdmitFunc.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">admitFuncHandler</span><span class="params">(admit admitFunc)</span></span> http.Handler &#123;</span><br><span class="line">    <span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        serveAdmitFunc(w, r, admit)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line"></span><br><span class="line">    admission <span class="string">&quot;k8s.io/api/admission/v1beta1&quot;</span></span><br><span class="line">    corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    tlsDir      = <span class="string">`/run/secrets/tls`</span></span><br><span class="line">    tlsCertFile = <span class="string">`tls.crt`</span></span><br><span class="line">    tlsKeyFile  = <span class="string">`tls.key`</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    podResource = metav1.GroupVersionResource&#123;Version: <span class="string">&quot;v1&quot;</span>, Resource: <span class="string">&quot;pods&quot;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// applySecurityDefaults implements the logic of our example admission controller webhook. For every pod that is created</span></span><br><span class="line"><span class="comment">// (outside of Kubernetes namespaces), it first checks if `runAsNonRoot` is set. If it is not, it is set to a default</span></span><br><span class="line"><span class="comment">// value of `false`. Furthermore, if `runAsUser` is not set (and `runAsNonRoot` was not initially set), it defaults</span></span><br><span class="line"><span class="comment">// `runAsUser` to a value of 1234.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// To demonstrate how requests can be rejected, this webhook further validates that the `runAsNonRoot` setting does</span></span><br><span class="line"><span class="comment">// not conflict with the `runAsUser` setting - i.e., if the former is set to `true`, the latter must not be `0`.</span></span><br><span class="line"><span class="comment">// Note that we combine both the setting of defaults and the check for potential conflicts in one webhook; ideally,</span></span><br><span class="line"><span class="comment">// the latter would be performed in a validating webhook admission controller.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">applySecurityDefaults</span><span class="params">(req *admission.AdmissionRequest)</span></span> ([]patchOperation, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// This handler should only get called on Pod objects as per the MutatingWebhookConfiguration in the YAML file.</span></span><br><span class="line">    <span class="comment">// However, if (for whatever reason) this gets invoked on an object of a different kind, issue a log message but</span></span><br><span class="line">    <span class="comment">// let the object request pass through otherwise.</span></span><br><span class="line">    <span class="keyword">if</span> req.Resource != podResource &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;expect resource to be %s&quot;</span>, podResource)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse the Pod object.</span></span><br><span class="line">    raw := req.Object.Raw</span><br><span class="line">    pod := corev1.Pod&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> _, _, err := universalDeserializer.Decode(raw, <span class="literal">nil</span>, &amp;pod); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;could not deserialize pod object: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Retrieve the `runAsNonRoot` and `runAsUser` values.</span></span><br><span class="line">    <span class="keyword">var</span> runAsNonRoot *<span class="type">bool</span></span><br><span class="line">    <span class="keyword">var</span> runAsUser *<span class="type">int64</span></span><br><span class="line">    <span class="keyword">if</span> pod.Spec.SecurityContext != <span class="literal">nil</span> &#123;</span><br><span class="line">        runAsNonRoot = pod.Spec.SecurityContext.RunAsNonRoot</span><br><span class="line">        runAsUser = pod.Spec.SecurityContext.RunAsUser</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create patch operations to apply sensible defaults, if those options are not set explicitly.</span></span><br><span class="line">    <span class="keyword">var</span> patches []patchOperation</span><br><span class="line">    <span class="keyword">if</span> runAsNonRoot == <span class="literal">nil</span> &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, patchOperation&#123;</span><br><span class="line">            Op:   <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            Path: <span class="string">&quot;/spec/securityContext/runAsNonRoot&quot;</span>,</span><br><span class="line">            <span class="comment">// The value must not be true if runAsUser is set to 0, as otherwise we would create a conflicting</span></span><br><span class="line">            <span class="comment">// configuration ourselves.</span></span><br><span class="line">            Value: runAsUser == <span class="literal">nil</span> || *runAsUser != <span class="number">0</span>,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> runAsUser == <span class="literal">nil</span> &#123;</span><br><span class="line">            patches = <span class="built_in">append</span>(patches, patchOperation&#123;</span><br><span class="line">                Op:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">                Path:  <span class="string">&quot;/spec/securityContext/runAsUser&quot;</span>,</span><br><span class="line">                Value: <span class="number">1234</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> *runAsNonRoot == <span class="literal">true</span> &amp;&amp; (runAsUser != <span class="literal">nil</span> &amp;&amp; *runAsUser == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Make sure that the settings are not contradictory, and fail the object creation if they are.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;runAsNonRoot specified, but runAsUser set to 0 (the root user)&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> patches, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    certPath := filepath.Join(tlsDir, tlsCertFile)</span><br><span class="line">    keyPath := filepath.Join(tlsDir, tlsKeyFile)</span><br><span class="line"></span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.Handle(<span class="string">&quot;/mutate&quot;</span>, admitFuncHandler(applySecurityDefaults))</span><br><span class="line">    server := &amp;http.Server&#123;</span><br><span class="line">        <span class="comment">// We listen on port 8443 such that we do not need root privileges or extra capabilities for this server.</span></span><br><span class="line">        <span class="comment">// The Service object will take care of mapping this port to the HTTPS port 443.</span></span><br><span class="line">        Addr:    <span class="string">&quot;:8443&quot;</span>,</span><br><span class="line">        Handler: mux,</span><br><span class="line">    &#125;</span><br><span class="line">    log.Fatal(server.ListenAndServeTLS(certPath, keyPath))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Dockerfile</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./webhook-server /</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/webhook-server&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Makefile</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.DEFAULT_GOAL := docker-image</span><br><span class="line"></span><br><span class="line">IMAGE ?= zhongmingmao/admission-webhook:latest</span><br><span class="line"></span><br><span class="line"><span class="section">image/webhook-server: $(shell find . -name &#x27;*.go&#x27;)</span></span><br><span class="line">    CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags=<span class="string">&quot;-s -w&quot;</span> -o <span class="variable">$@</span> ./cmd/webhook-server</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: docker-image</span></span><br><span class="line"><span class="section">docker-image: image/webhook-server</span></span><br><span class="line">    docker build -t <span class="variable">$(IMAGE)</span> image/</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: push-image</span></span><br><span class="line"><span class="section">push-image: docker-image</span></span><br><span class="line">    docker push <span class="variable">$(IMAGE)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>构建</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── cmd</span><br><span class="line">│   └── webhook-server</span><br><span class="line">│       ├── admission_controller.go</span><br><span class="line">│       └── main.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── image</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">└── Makefile</span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags=&quot;-s -w&quot; -o image/webhook-server ./cmd/webhook-server</span><br><span class="line">docker build -t zhongmingmao/admission-webhook:latest image/</span><br><span class="line">Sending build context to Docker daemon  13.63MB</span><br><span class="line">Step 1/3 : FROM scratch</span><br><span class="line"> ---&gt;</span><br><span class="line">Step 2/3 : COPY ./webhook-server /</span><br><span class="line"> ---&gt; 7b9e9470035b</span><br><span class="line">Step 3/3 : ENTRYPOINT [&quot;/webhook-server&quot;]</span><br><span class="line"> ---&gt; Running in a6b690959e11</span><br><span class="line">Removing intermediate container a6b690959e11</span><br><span class="line"> ---&gt; 9fd632e6c175</span><br><span class="line">Successfully built 9fd632e6c175</span><br><span class="line">Successfully tagged zhongmingmao/admission-webhook:latest</span><br><span class="line"></span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── cmd</span><br><span class="line">│   └── webhook-server</span><br><span class="line">│       ├── admission_controller.go</span><br><span class="line">│       └── main.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── image</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   └── webhook-server</span><br><span class="line">└── Makefile</span><br><span class="line"> </span><br><span class="line">$ dils</span><br><span class="line">REPOSITORY                                                        TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">zhongmingmao/admission-webhook                                    latest    9fd632e6c175   33 seconds ago   13.6MB</span><br></pre></td></tr></table></figure>

<h3 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h3><figure class="highlight bash"><figcaption><span>deploy.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line">basedir=<span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>/deployment&quot;</span></span><br><span class="line">keydir=<span class="string">&quot;<span class="subst">$(mktemp -d)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate keys into a temporary directory.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Generating TLS keys ...&quot;</span></span><br><span class="line"><span class="string">&quot;<span class="variable">$&#123;basedir&#125;</span>/generate-keys.sh&quot;</span> <span class="string">&quot;<span class="variable">$keydir</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the `webhook-demo` namespace. This cannot be part of the YAML file as we first need to create the TLS secret,</span></span><br><span class="line"><span class="comment"># which would fail otherwise.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating Kubernetes objects ...&quot;</span></span><br><span class="line">kubectl create namespace webhook-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the TLS secret for the generated keys.</span></span><br><span class="line">kubectl -n webhook-demo create secret tls webhook-server-tls \</span><br><span class="line">    --cert <span class="string">&quot;<span class="variable">$&#123;keydir&#125;</span>/webhook-server-tls.crt&quot;</span> \</span><br><span class="line">    --key <span class="string">&quot;<span class="variable">$&#123;keydir&#125;</span>/webhook-server-tls.key&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read the PEM-encoded CA certificate, base64 encode it, and replace the `$&#123;CA_PEM_B64&#125;` placeholder in the YAML</span></span><br><span class="line"><span class="comment"># template with it. Then, create the Kubernetes resources.</span></span><br><span class="line">ca_pem_b64=<span class="string">&quot;<span class="subst">$(openssl base64 -A &lt;<span class="string">&quot;<span class="variable">$&#123;keydir&#125;</span>/ca.crt&quot;</span>)</span>&quot;</span></span><br><span class="line">sed -e <span class="string">&#x27;s@$&#123;CA_PEM_B64&#125;@&#x27;</span><span class="string">&quot;<span class="variable">$ca_pem_b64</span>&quot;</span><span class="string">&#x27;@g&#x27;</span> &lt;<span class="string">&quot;<span class="variable">$&#123;basedir&#125;</span>/deployment.yaml.template&quot;</span> \</span><br><span class="line">    | kubectl create -f -</span><br><span class="line"></span><br><span class="line"><span class="comment"># Delete the key directory to prevent abuse (DO NOT USE THESE KEYS ANYWHERE ELSE).</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="string">&quot;<span class="variable">$keydir</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The webhook server has been deployed and configured!&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><figcaption><span>generate-keys.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;1?&#x27;missing key directory&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">key_dir=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 0700 <span class="string">&quot;<span class="variable">$key_dir</span>&quot;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$key_dir</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;server.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">req_extensions = v3_req</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">CN = webhook-server.webhook-demo.svc</span></span><br><span class="line"><span class="string">[ v3_req ]</span></span><br><span class="line"><span class="string">basicConstraints = CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = clientAuth, serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1 = webhook-server.webhook-demo.svc</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate the CA cert and private key</span></span><br><span class="line">openssl req -nodes -new -x509 -keyout ca.key -out ca.crt -subj <span class="string">&quot;/CN=Admission Webhook CA&quot;</span></span><br><span class="line"><span class="comment"># Generate the private key for the webhook server</span></span><br><span class="line">openssl genrsa -out webhook-server-tls.key 2048</span><br><span class="line"><span class="comment"># Generate a Certificate Signing Request (CSR) for the private key, and sign it with the private key of the CA.</span></span><br><span class="line">openssl req -new -key webhook-server-tls.key -subj <span class="string">&quot;/CN=webhook-server.webhook-demo.svc&quot;</span> -config server.conf \</span><br><span class="line">    | openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -out webhook-server-tls.crt -extensions v3_req -extfile server.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><figcaption><span>deployment.yaml.template</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1234</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">zhongmingmao/admission-webhook:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">webhook-api</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-tls-certs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/secrets/tls</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-tls-certs</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">webhook-server-tls</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webhook-server</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">webhook-api</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MutatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admission-webhook</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-server.webhook-demo.svc</span></span><br><span class="line">    <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">admissionReviewVersions:</span> [<span class="string">&quot;v1&quot;</span>, <span class="string">&quot;v1beta1&quot;</span>]</span><br><span class="line">    <span class="attr">clientConfig:</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">webhook-server</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">webhook-demo</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/mutate&quot;</span></span><br><span class="line">      <span class="attr">caBundle:</span> <span class="string">$&#123;CA_PEM_B64&#125;</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operations:</span> [ <span class="string">&quot;CREATE&quot;</span> ]</span><br><span class="line">        <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">        <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">        <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>caBundle</code> 是为了让 API Server 信任 Webhook Server 的自签证书</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── deployment</span><br><span class="line">│   ├── deployment.yaml.template</span><br><span class="line">│   └── generate-keys.sh</span><br><span class="line">└── deploy.sh</span><br><span class="line"></span><br><span class="line">$ ./deploy.sh</span><br><span class="line">Generating TLS keys ...</span><br><span class="line">.........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.......+.....+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*....+.+......+.....+..........+..+............+.....................+....+.....................+...+..............+.+...............+..+.......+...+...+......+.....+...+.+..+...+.+.....+......+...+.+.....................+..+.......+.....+......+.............+.........+.....+.....................+......+...+...+.............+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">......+......+...+........+.........+.+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.+........+.+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.........+..+.+............+.........+........+..........+..+.+........+.+...+......+.....+......+...+.+..+.......+..+...+.+..+...................+...+..+...+.+.....+......+.........+.+...+........+...+.......+..............+.+...+..+.......+..+.............+.....................+.....+.......+.....+....+........+......+....+........+..............................+...+.........+.......+...+.....+............+.+...+..+...+............+...+..........+..............+...+.........+..........+......+...+.........+..+.........+.+........+.......+...+...+..+.............+.....+..........+..+.+..+.............+.....+.+........+...............+.+.....+.+........+...+..........+.........+...+...+.....+.........+......+............+.+..+...+.+...+...+.....+...+.+........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">-----</span><br><span class="line">Certificate request self-signature ok</span><br><span class="line">subject=CN = webhook-server.webhook-demo.svc</span><br><span class="line">Creating Kubernetes objects ...</span><br><span class="line">namespace/webhook-demo created</span><br><span class="line">secret/webhook-server-tls created</span><br><span class="line">deployment.apps/webhook-server created</span><br><span class="line">service/webhook-server created</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.io/admission-webhook created</span><br><span class="line">The webhook server has been deployed and configured!</span><br><span class="line"></span><br><span class="line">$ k get mutatingwebhookconfigurations.admissionregistration.k8s.io</span><br><span class="line">NAME                WEBHOOKS   AGE</span><br><span class="line">admission-webhook   1          19s</span><br><span class="line"></span><br><span class="line">$ k get mutatingwebhookconfigurations.admissionregistration.k8s.io admission-webhook -oyaml</span><br><span class="line">apiVersion: admissionregistration.k8s.io/v1</span><br><span class="line">kind: MutatingWebhookConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T10:41:49Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: admission-webhook</span><br><span class="line">  resourceVersion: &quot;5981&quot;</span><br><span class="line">  uid: 73f11fce-be11-4324-aada-7775dcc1c3d9</span><br><span class="line">webhooks:</span><br><span class="line">- admissionReviewVersions:</span><br><span class="line">  - v1</span><br><span class="line">  - v1beta1</span><br><span class="line">  clientConfig:</span><br><span class="line">    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIekNDQWdlZ0F3SUJBZ0lVTnFyNWFTaGhHTzI1SUlGbWFwS1BkL2tVcTJvd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0h6RWRNQnNHQTFVRUF3d1VRV1J0YVhOemFXOXVJRmRsWW1odmIyc2dRMEV3SGhjTk1qTXdOekUyTVRBMApNVFE0V2hjTk1qTXdPREUxTVRBME1UUTRXakFmTVIwd0d3WURWUVFEREJSQlpHMXBjM05wYjI0Z1YyVmlhRzl2CmF5QkRRVENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFNTGdpTWRLcnJDVzJWaEoKd0t0WEtDKzJIRXprT2tGbnpqMFp3aWcwRnJlVmxyeFdQYnpyS2Z4RytRT1paTHorakdINmZqb25McjY4MDZYagpZRTBQbU5kUlBXdUluaVp6Qm4xVitRb3pocDhJUGtsZVBGcktNTnVPNEgzc3hwbXIwZVhyWFhqbmhuRVNheDZTCkFXS1ZUWEhlYkxxa0REZnkyMHFCYlFKUEszVExEQmpSL0VTOE1WRzZ0UWRVMTFENGZaZERMMThTallzd050dEQKRS9sTEhlTy9nSVBORjZ2bXlIb1ptQnlCbnhSbkZPMytUQzA4RVRGcmE5SElqcFRKQVZkMXhOT3pGRGVVejFXWQpxaERCRjhmL1VzZ0NlZVNia1hzVzF4a3BIckdML1hLeHBnenFpRjRHRSsxUTNPSHNzVjc3aDVON0FKOE5IS1VoCjlRZVlnN1VDQXdFQUFhTlRNRkV3SFFZRFZSME9CQllFRktCVmVlTzBsdmlZZVVoM3NPWWVDWGpCcmc1WU1COEcKQTFVZEl3UVlNQmFBRktCVmVlTzBsdmlZZVVoM3NPWWVDWGpCcmc1WU1BOEdBMVVkRXdFQi93UUZNQU1CQWY4dwpEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBTFJ3NktCL1A5QWdOV0l4Qk1CV1N6WUlrQWVqZUxkb2s2K1pmRWg3Ci9TWVljSk5PbzN2eVZ4ai9DMmg0RkkxQVZoVXpZTk5hbmFWdVIydUp2R1pFWHk5dzFYYlFKYXB0U2ZZdytaTVUKbkFnWDFUcEpCK0FuQUZZUndXZEVNR2tzRkZJRkt2dmRaMUpHWU5jeUF6V0VJbUpJUG5rWXpHNVN0Y29NU291RwpLVHR3SmYyOVZ4ekhkRVlwRks4VWRvb1lwZE10bDc1dU1KMytMYXNDWk9KU0VwUWdHNVB6bWV1UFNDVHdFZEtXCnBsK0VXL3VTaEZORG1NRVRNcFZxRExKSUpvSGw0aFBYT1NvbnVtWXlEbkpGcTE3VHJEK04walBpVG44S1pxSXAKdlN1Uk9yWm5aWTZTSE5ER3RjU0c5L3A2SE14aFUrV0YzaEcyaUtZNzh0SnpXdlE9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><br><span class="line">    service:</span><br><span class="line">      name: webhook-server</span><br><span class="line">      namespace: webhook-demo</span><br><span class="line">      path: /mutate</span><br><span class="line">      port: 443</span><br><span class="line">  failurePolicy: Fail</span><br><span class="line">  matchPolicy: Equivalent</span><br><span class="line">  name: webhook-server.webhook-demo.svc</span><br><span class="line">  namespaceSelector: &#123;&#125;</span><br><span class="line">  objectSelector: &#123;&#125;</span><br><span class="line">  reinvocationPolicy: Never</span><br><span class="line">  rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">    - &quot;&quot;</span><br><span class="line">    apiVersions:</span><br><span class="line">    - v1</span><br><span class="line">    operations:</span><br><span class="line">    - CREATE</span><br><span class="line">    resources:</span><br><span class="line">    - pods</span><br><span class="line">    scope: &#x27;*&#x27;</span><br><span class="line">  sideEffects: None</span><br><span class="line">  timeoutSeconds: 10</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k get deployments.apps -n webhook-demo -owide</span><br><span class="line">NAME             READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                                  SELECTOR</span><br><span class="line">webhook-server   1/1     1            1           10m   server       zhongmingmao/admission-webhook:latest   app=webhook-server</span><br><span class="line"></span><br><span class="line">$ k get po -n webhook-demo -owide</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE   IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">webhook-server-554576df6f-w5l9k   1/1     Running   0          80s   192.168.185.9   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ k run --image=nginx nginx</span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME    READY   STATUS             RESTARTS     AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   0/1     CrashLoopBackOff   1 (3s ago)   7s    192.168.185.11   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k logs nginx</span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: can not modify /etc/nginx/conf.d/default.conf (read-only file system?)</span><br><span class="line">/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready for start up</span><br><span class="line">2022/07/16 10:56:16 [warn] 1#1: the &quot;user&quot; directive makes sense only if the master process runs with super-user privileges, ignored in /etc/nginx/nginx.conf:2</span><br><span class="line">nginx: [warn] the &quot;user&quot; directive makes sense only if the master process runs with super-user privileges, ignored in /etc/nginx/nginx.conf:2</span><br><span class="line">2022/07/16 10:56:16 [emerg] 1#1: mkdir() &quot;/var/cache/nginx/client_temp&quot; failed (13: Permission denied)</span><br><span class="line">nginx: [emerg] mkdir() &quot;/var/cache/nginx/client_temp&quot; failed (13: Permission denied)</span><br><span class="line"></span><br><span class="line">$ k logs -n webhook-demo webhook-server-554576df6f-w5l9k</span><br><span class="line">2023/07/16 10:55:55 Handling webhook request ...</span><br><span class="line">2023/07/16 10:55:55 Webhook request handled successfully</span><br><span class="line"></span><br><span class="line">$ k get po nginx -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    ...</span><br><span class="line">  ...</span><br><span class="line">  securityContext:</span><br><span class="line">    runAsNonRoot: true</span><br><span class="line">    runAsUser: 1234</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h1 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h1><h2 id="传统算法"><a href="#传统算法" class="headerlink" title="传统算法"></a>传统算法</h2><h3 id="计数器-固定窗口"><a href="#计数器-固定窗口" class="headerlink" title="计数器 + 固定窗口"></a>计数器 + 固定窗口</h3><blockquote>
<p>突发流量的上限为窗口阈值的 <code>2 倍</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230716163122310.png" alt="image-20230716163122310"></p>
<h3 id="计数器-滑动窗口"><a href="#计数器-滑动窗口" class="headerlink" title="计数器 + 滑动窗口"></a>计数器 + 滑动窗口</h3><blockquote>
<p>相对于固定窗口，更平滑</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230716175724319.png" alt="image-20230716175724319"></p>
<h3 id="漏桶"><a href="#漏桶" class="headerlink" title="漏桶"></a>漏桶</h3><blockquote>
<p>恒定的输出速度，不适合突发流量</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230716180913686.png" alt="image-20230716180913686"></p>
<h3 id="令牌桶"><a href="#令牌桶" class="headerlink" title="令牌桶"></a>令牌桶</h3><blockquote>
<p>恒定的令牌产生速度，支持一定的突发流量</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230716181535708.png" alt="image-20230716181535708"></p>
<h2 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h2><table>
<thead>
<tr>
<th>Parameter</th>
<th>Desc</th>
<th>Default</th>
</tr>
</thead>
<tbody><tr>
<td><code>max-requests-inflight</code></td>
<td>在给定时间内最大的 <code>non-mutating</code> 的请求数</td>
<td>400</td>
</tr>
<tr>
<td><code>max-mutating-requests-inflight</code></td>
<td>在给定时间内最大的 <code>mutating</code> 的请求数</td>
<td>200</td>
</tr>
</tbody></table>
<blockquote>
<p>传统限流算法的局限性</p>
</blockquote>
<table>
<thead>
<tr>
<th>Disadvantage</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>粗粒度</code></td>
<td>无法为不同用户、不同场景设置不同的限流</td>
</tr>
<tr>
<td><code>单队列</code></td>
<td>共享限流窗口、可能会引起系统阻塞</td>
</tr>
<tr>
<td><code>不公平</code></td>
<td>正常用户的请求会被排在队尾，无法及时处理而饿死</td>
</tr>
<tr>
<td><code>无优先级</code></td>
<td>重要的系统指令会被一并限流，系统故障难以恢复</td>
</tr>
</tbody></table>
<h2 id="APF"><a href="#APF" class="headerlink" title="APF"></a>APF</h2><blockquote>
<p>API <code>Priority</code> and <code>Fairness</code></p>
</blockquote>
<ol>
<li>以<code>更细粒度</code>对请求进行<code>分类</code>和<code>隔离</code></li>
<li>引入了<code>空间有限</code>的排队机制，在非常<code>短暂</code>的<code>突发</code>情况下，API Server <code>不会拒绝</code>任何请求</li>
<li>使用<code>公平排队</code>技术从队列中分发请求，即便一个行为不佳的控制器也不会饿死其他控制器</li>
<li>核心思想：<code>多等级</code> + <code>多队列</code></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230716191502545.png" alt="image-20230716191502545"></p>
<blockquote>
<p>实现原理</p>
</blockquote>
<ol>
<li>APF 的实现依赖于两个重要的资源：<code>FlowSchema</code> 和 <code>PriorityLevelConfiguration</code></li>
<li>APF 对请求进行更细粒度的<code>分类</code>，每一个<code>请求分类</code>对应一个 <code>FlowSchema</code></li>
<li>FlowSchema 内的请求会根据 <code>distinguisher</code> 进一步划分为不同的 Flow</li>
<li><code>FlowSchema</code> 会设置一个 <code>Priority Level</code>，不同 <code>Priority Level</code> 的<code>并发资源</code>是<code>隔离</code>的</li>
<li><code>一个 Priority Level</code> 对应<code>多个 FlowSchema</code>（一个 FlowSchema 又对应多个 Flow）<ul>
<li><code>Priority Level</code> 中维护一个 <code>QueueSet</code>，用于<code>缓存</code>不能及时处理的请求</li>
<li>请求不会因为超出 Priority Level 的并发限制而被丢弃</li>
</ul>
</li>
<li>FlowSchema 的每个 <code>Flow</code> 通过 <code>shuffle sharding</code> 算法从 QueueSet 中<code>选取</code>特定的 Queues 缓存请求</li>
<li>每次从 QueueSet 中取请求执行时<ul>
<li>会先应用 <code>fair queuing</code> 算法从 QueueSet 中选择一个 <code>Queue</code>，然后从这个 Queue 中取出 <code>oldest</code> 请求执行</li>
</ul>
</li>
</ol>
<blockquote>
<p>FlowSchema 匹配一些入站请求，并将它们分配给 Priority Level</p>
</blockquote>
<blockquote>
<p>每个<code>入站请求</code>都会<code>按照 matchingPrecedence 从小到大</code>对所有的 FlowSchema 测试是否匹配，直到<code>首个匹配</code>出现</p>
</blockquote>
<blockquote>
<p><code>FlowSchema + Distinguisher ==&gt; Flow</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>distinguisherMethod</td>
<td>Distinguisher</td>
</tr>
<tr>
<td>matchingPrecedence</td>
<td>规则优先级</td>
</tr>
<tr>
<td>priorityLevelConfiguration</td>
<td>PriorityLevelConfiguration</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&#x27;flowcontrol.apiserver.k8s.io&#x27;</span><br><span class="line">NAME                          SHORTNAMES   APIVERSION                             NAMESPACED   KIND</span><br><span class="line">flowschemas                                flowcontrol.apiserver.k8s.io/v1beta1   false        FlowSchema</span><br><span class="line">prioritylevelconfigurations                flowcontrol.apiserver.k8s.io/v1beta1   false        PriorityLevelConfiguration</span><br><span class="line"></span><br><span class="line">$ k get flowschemas.flowcontrol.apiserver.k8s.io</span><br><span class="line">NAME                           PRIORITYLEVEL     MATCHINGPRECEDENCE   DISTINGUISHERMETHOD   AGE    MISSINGPL</span><br><span class="line">exempt                         exempt            1                    &lt;none&gt;                106m   False</span><br><span class="line">probes                         exempt            2                    &lt;none&gt;                106m   False</span><br><span class="line">system-leader-election         leader-election   100                  ByUser                106m   False</span><br><span class="line">workload-leader-election       leader-election   200                  ByUser                106m   False</span><br><span class="line">system-node-high               node-high         400                  ByUser                106m   False</span><br><span class="line">system-nodes                   system            500                  ByUser                106m   False</span><br><span class="line">kube-controller-manager        workload-high     800                  ByNamespace           106m   False</span><br><span class="line">kube-scheduler                 workload-high     800                  ByNamespace           106m   False</span><br><span class="line">kube-system-service-accounts   workload-high     900                  ByNamespace           106m   False</span><br><span class="line">service-accounts               workload-low      9000                 ByUser                106m   False</span><br><span class="line">global-default                 global-default    9900                 ByUser                106m   False</span><br><span class="line">catch-all                      catch-all         10000                ByUser                106m   False</span><br><span class="line"></span><br><span class="line">$ k get flowschemas.flowcontrol.apiserver.k8s.io service-accounts -oyaml</span><br><span class="line">apiVersion: flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">kind: FlowSchema</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    apf.kubernetes.io/autoupdate-spec: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: service-accounts</span><br><span class="line">  resourceVersion: &quot;73&quot;</span><br><span class="line">  uid: da4cb058-17cf-4ed7-a1a2-38d2dca035d5</span><br><span class="line">spec:</span><br><span class="line">  distinguisherMethod:</span><br><span class="line">    type: ByUser</span><br><span class="line">  matchingPrecedence: 9000</span><br><span class="line">  priorityLevelConfiguration:</span><br><span class="line">    name: workload-low</span><br><span class="line">  rules:</span><br><span class="line">  - nonResourceRules:</span><br><span class="line">    - nonResourceURLs:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      verbs:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">    resourceRules:</span><br><span class="line">    - apiGroups:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      clusterScope: true</span><br><span class="line">      namespaces:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      resources:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      verbs:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">    subjects:</span><br><span class="line">    - group:</span><br><span class="line">        name: system:serviceaccounts</span><br><span class="line">      kind: Group</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">    message: This FlowSchema references the PriorityLevelConfiguration object named</span><br><span class="line">      &quot;workload-low&quot; and it exists</span><br><span class="line">    reason: Found</span><br><span class="line">    status: &quot;False&quot;</span><br><span class="line">    type: Dangling</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nonResourceURL - &#x2F;api&#x2F;v1&#x2F;namespaces</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ k get ns default -v 9</span><br><span class="line">I0716 11:43:39.587424  113402 loader.go:372] Config loaded from file:  /home/zhongmingmao/.kube/config</span><br><span class="line">I0716 11:43:39.591060  113402 round_trippers.go:435] curl -v -XGET  -H &quot;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json&quot; -H &quot;User-Agent: kubectl/v1.22.2 (linux/arm64) kubernetes/8b5a191&quot; &#x27;https://192.168.191.153:6443/api/v1/namespaces/default&#x27;</span><br><span class="line">I0716 11:43:39.597307  113402 round_trippers.go:454] GET https://192.168.191.153:6443/api/v1/namespaces/default 200 OK in 6 milliseconds</span><br><span class="line">I0716 11:43:39.597324  113402 round_trippers.go:460] Response Headers:</span><br><span class="line">I0716 11:43:39.597327  113402 round_trippers.go:463]     Audit-Id: 994464d1-7b35-414e-819d-9f4a96618024</span><br><span class="line">I0716 11:43:39.597329  113402 round_trippers.go:463]     Cache-Control: no-cache, private</span><br><span class="line">I0716 11:43:39.597331  113402 round_trippers.go:463]     Content-Type: application/json</span><br><span class="line">I0716 11:43:39.597333  113402 round_trippers.go:463]     X-Kubernetes-Pf-Flowschema-Uid: 4957b2cd-8c3d-4284-af18-011105e6d997</span><br><span class="line">I0716 11:43:39.597335  113402 round_trippers.go:463]     X-Kubernetes-Pf-Prioritylevel-Uid: f07b49a7-f33b-4415-932b-276e640f8407</span><br><span class="line">I0716 11:43:39.597337  113402 round_trippers.go:463]     Content-Length: 1659</span><br><span class="line">I0716 11:43:39.597339  113402 round_trippers.go:463]     Date: Sun, 16 Jul 2022 11:43:39 GMT</span><br><span class="line">I0716 11:43:39.597360  113402 request.go:1181] Response Body: &#123;&quot;kind&quot;:&quot;Table&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;resourceVersion&quot;:&quot;204&quot;&#125;,&quot;columnDefinitions&quot;:[&#123;&quot;name&quot;:&quot;Name&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;name&quot;,&quot;description&quot;:&quot;Name must be unique within a namespace. Is required when creating resources, although some resources may allow a client to request the generation of an appropriate name automatically. Name is primarily intended for creation idempotence and configuration definition. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/identifiers#names&quot;,&quot;priority&quot;:0&#125;,&#123;&quot;name&quot;:&quot;Status&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;&quot;,&quot;description&quot;:&quot;The status of the namespace&quot;,&quot;priority&quot;:0&#125;,&#123;&quot;name&quot;:&quot;Age&quot;,&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;&quot;,&quot;description&quot;:&quot;CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.\n\nPopulated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&quot;,&quot;priority&quot;:0&#125;],&quot;rows&quot;:[&#123;&quot;cells&quot;:[&quot;default&quot;,&quot;Active&quot;,&quot;112m&quot;],&quot;object&quot;:&#123;&quot;kind&quot;:&quot;PartialObjectMetadata&quot;,&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;2287c1e6-4dec-4772-9b21-730f7c537ea9&quot;,&quot;resourceVersion&quot;:&quot;204&quot;,&quot;creationTimestamp&quot;:&quot;2022-07-16T09:51:22Z&quot;,&quot;labels&quot;:&#123;&quot;kubernetes.io/metadata.name&quot;:&quot;default&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kube-apiserver&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-07-16T09:51:22Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:kubernetes.io/metadata.name&quot;:&#123;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&#125;]&#125;</span><br><span class="line">NAME      STATUS   AGE</span><br><span class="line">default   Active   112m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PriorityLevelConfiguration 表示单个<code>隔离类型</code><br>限制<code>未完成的请求数</code>（assuredConcurrencyShares）和<code>排队中的请求数</code>（Queue）</p>
</blockquote>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td><code>assuredConcurrencyShares</code></td>
<td>允许的并发请求 - <code>Flow</code> 的维度 - <code>限制某个 Flow 占用过多资</code></td>
</tr>
<tr>
<td>queues</td>
<td>当前 Priority Level 的队列总数</td>
</tr>
<tr>
<td>queueLengthLimit</td>
<td>每个队列中的对象数量</td>
</tr>
<tr>
<td><code>handSize</code></td>
<td><code>shuffle sharding</code> 的配置<br />每个 <code>flowschema + distinguisher</code> 的请求会被 <code>enqueue</code> 到多少个队列</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ k get prioritylevelconfigurations.flowcontrol.apiserver.k8s.io</span><br><span class="line">NAME              TYPE      ASSUREDCONCURRENCYSHARES   QUEUES   HANDSIZE   QUEUELENGTHLIMIT   AGE</span><br><span class="line">catch-all         Limited   5                          &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             117m</span><br><span class="line">exempt            Exempt    &lt;none&gt;                     &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             117m</span><br><span class="line">global-default    Limited   20                         128      6          50                 117m</span><br><span class="line">leader-election   Limited   10                         16       4          50                 117m</span><br><span class="line">node-high         Limited   40                         64       6          50                 117m</span><br><span class="line">system            Limited   30                         64       6          50                 117m</span><br><span class="line">workload-high     Limited   40                         128      6          50                 117m</span><br><span class="line">workload-low      Limited   100                        128      6          50                 117m</span><br><span class="line"></span><br><span class="line">$ k get prioritylevelconfigurations.flowcontrol.apiserver.k8s.io workload-low -oyaml</span><br><span class="line">apiVersion: flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">kind: PriorityLevelConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    apf.kubernetes.io/autoupdate-spec: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: workload-low</span><br><span class="line">  resourceVersion: &quot;66&quot;</span><br><span class="line">  uid: 8f6fa0cb-a367-4664-b0d9-2327c3b29539</span><br><span class="line">spec:</span><br><span class="line">  limited:</span><br><span class="line">    assuredConcurrencyShares: 100</span><br><span class="line">    limitResponse:</span><br><span class="line">      queuing:</span><br><span class="line">        handSize: 6</span><br><span class="line">        queueLengthLimit: 50</span><br><span class="line">        queues: 128</span><br><span class="line">      type: Queue</span><br><span class="line">  type: Limited</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>概念：<code>FlowSchema - 分类规则</code> + <code>PriorityLevel - 并发规则</code></p>
</blockquote>
<ol>
<li>传入的请求通过 FlowSchema 按照其属性<code>分类</code>，并分配<code>优先级</code></li>
<li>每个<code>优先级</code>维护自定义的<code>并发规则</code>，不同优先级的请求，不会相互饿死</li>
<li>在同一个优先级内，<code>公平排队</code>算法可以防止来自不同 Flow 的请求相互饿死</li>
<li>将请求排队，通过排队机制，防止在平均负载较低时，因通信量徒增而导致请求失败</li>
</ol>
<blockquote>
<p>优先级</p>
</blockquote>
<ol>
<li>如果未启用 APF<ul>
<li>API Server 的整体并发量将受到 <code>max-requests-inflight</code> 和 <code>max-mutating-requests-inflight</code> 的限制</li>
</ul>
</li>
<li>如果启用了 APF<ul>
<li>将 <code>max-requests-inflight</code> 和 <code>max-mutating-requests-inflight</code> 求和</li>
<li>将总和<code>分配</code>到<code>一组</code>可配置的<code>优先级</code>中，每个传入的请求都会分配一个优先级</li>
</ul>
</li>
<li>每个优先级都有各自的配置，设定分发的并发请求数</li>
</ol>
<blockquote>
<p>排队</p>
</blockquote>
<ol>
<li>在过载情况下，防止一个 Flow 饿死其它 Flow 是非常有价值的</li>
<li>每个请求被分配到某个 <code>Flow</code> 中，该 <code>Flow</code> 由对应的 <code>FlowSchema</code> 和 <code>Distinguisher</code> 来标识确定</li>
<li>系统尝试为具有<code>相同 PriorityLevel</code> 的<code>不同 Flow</code> 中的请求赋予<code>近似相等的权重</code></li>
<li>将请求分配到 <code>Flow</code> 之后，通过 <code>shuffle sharding</code> 将请求分配到 <code>Priority Level</code> 的 <code>Queue</code> 中<ul>
<li><code>shuffle sharding</code> - 可以<code>相对有效</code>地<code>隔离</code>低强度 Flow 和高强度 Flow</li>
</ul>
</li>
<li>排队算法的细节可以针对每个 <code>Priority Level</code> 进行调整</li>
</ol>
<blockquote>
<p> 豁免请求（Exempt）</p>
</blockquote>
<ol>
<li>某些特别重要的请求<code>不受制</code>于此特性施加的任何限制</li>
<li>可以防止不当的流控配置<code>完全禁用</code> API Server</li>
</ol>
<blockquote>
<p>默认配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ k get flowschemas.flowcontrol.apiserver.k8s.io</span><br><span class="line">NAME                           PRIORITYLEVEL     MATCHINGPRECEDENCE   DISTINGUISHERMETHOD   AGE    MISSINGPL</span><br><span class="line">exempt                         exempt            1                    &lt;none&gt;                173m   False</span><br><span class="line">probes                         exempt            2                    &lt;none&gt;                173m   False</span><br><span class="line">system-leader-election         leader-election   100                  ByUser                173m   False</span><br><span class="line">workload-leader-election       leader-election   200                  ByUser                173m   False</span><br><span class="line">system-node-high               node-high         400                  ByUser                173m   False</span><br><span class="line">system-nodes                   system            500                  ByUser                173m   False</span><br><span class="line">kube-controller-manager        workload-high     800                  ByNamespace           173m   False</span><br><span class="line">kube-scheduler                 workload-high     800                  ByNamespace           173m   False</span><br><span class="line">kube-system-service-accounts   workload-high     900                  ByNamespace           173m   False</span><br><span class="line">service-accounts               workload-low      9000                 ByUser                173m   False</span><br><span class="line">global-default                 global-default    9900                 ByUser                173m   False</span><br><span class="line">catch-all                      catch-all         10000                ByUser                173m   False</span><br><span class="line"></span><br><span class="line">$ k get prioritylevelconfigurations.flowcontrol.apiserver.k8s.io</span><br><span class="line">NAME              TYPE      ASSUREDCONCURRENCYSHARES   QUEUES   HANDSIZE   QUEUELENGTHLIMIT   AGE</span><br><span class="line">catch-all         Limited   5                          &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             173m</span><br><span class="line">exempt            Exempt    &lt;none&gt;                     &lt;none&gt;   &lt;none&gt;     &lt;none&gt;             173m</span><br><span class="line">global-default    Limited   20                         128      6          50                 173m</span><br><span class="line">leader-election   Limited   10                         16       4          50                 173m</span><br><span class="line">node-high         Limited   40                         64       6          50                 173m</span><br><span class="line">system            Limited   30                         64       6          50                 173m</span><br><span class="line">workload-high     Limited   40                         128      6          50                 173m</span><br><span class="line">workload-low      Limited   100                        128      6          50                 173m</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Priority Level</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>exempt</td>
<td>请求<code>完全不受流控限制</code>，总是被<code>立即分发</code>，将 <code>system:masters</code> 组的所有请求都纳入该 Priority Level</td>
</tr>
<tr>
<td>system</td>
<td>用于 <code>system:nodes</code> 的请求（即 <code>kubelets</code>）<br />kubelets 必须要连上 API Server，以便工作负载能调度到到其上</td>
</tr>
<tr>
<td>leader-election</td>
<td>用于<code>内置控制器</code>的选举请求（<code>system:kube-controller-manager</code> + <code>system:kube-scheduler</code>）</td>
</tr>
<tr>
<td>workload-high</td>
<td>用于<code>内置控制器</code>的请求</td>
</tr>
<tr>
<td>workload-low</td>
<td>用于来自于任何 <code>ServiceAccount</code> 的请求（包括来自于 <code>Pod</code> 中运行的<code>控制器</code>的所有请求）</td>
</tr>
<tr>
<td>global-default</td>
<td>所有其它流量，如<code>非特权用户</code>运行的交互式 <code>kubectl</code> 命令</td>
</tr>
<tr>
<td>catch-all</td>
<td>确保每个请求都有分类，<code>一般不依赖</code>默认的 catch-all 配置<br />仅与 catch-all FlowSchema 匹配的流量<code>更容易被拒绝</code>（HTTP 429）</td>
</tr>
</tbody></table>
<blockquote>
<p>exempt</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ k get flowschemas.flowcontrol.apiserver.k8s.io exempt -oyaml</span><br><span class="line">apiVersion: flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">kind: FlowSchema</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    apf.kubernetes.io/autoupdate-spec: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: exempt</span><br><span class="line">  resourceVersion: &quot;79&quot;</span><br><span class="line">  uid: 4957b2cd-8c3d-4284-af18-011105e6d997</span><br><span class="line">spec:</span><br><span class="line">  matchingPrecedence: 1</span><br><span class="line">  priorityLevelConfiguration:</span><br><span class="line">    name: exempt</span><br><span class="line">  rules:</span><br><span class="line">  - nonResourceRules:</span><br><span class="line">    - nonResourceURLs:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      verbs:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">    resourceRules:</span><br><span class="line">    - apiGroups:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      clusterScope: true</span><br><span class="line">      namespaces:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      resources:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      verbs:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">    subjects:</span><br><span class="line">    - group:</span><br><span class="line">        name: system:masters</span><br><span class="line">      kind: Group</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">    message: This FlowSchema references the PriorityLevelConfiguration object named</span><br><span class="line">      &quot;exempt&quot; and it exists</span><br><span class="line">    reason: Found</span><br><span class="line">    status: &quot;False&quot;</span><br><span class="line">    type: Dangling</span><br><span class="line"></span><br><span class="line">$ k get prioritylevelconfigurations.flowcontrol.apiserver.k8s.io exempt -oyaml</span><br><span class="line">apiVersion: flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">kind: PriorityLevelConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    apf.kubernetes.io/autoupdate-spec: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: exempt</span><br><span class="line">  resourceVersion: &quot;77&quot;</span><br><span class="line">  uid: f07b49a7-f33b-4415-932b-276e640f8407</span><br><span class="line">spec:</span><br><span class="line">  type: Exempt</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>probes</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ k get flowschemas.flowcontrol.apiserver.k8s.io probes -oyaml</span><br><span class="line">apiVersion: flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">kind: FlowSchema</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    apf.kubernetes.io/autoupdate-spec: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: probes</span><br><span class="line">  resourceVersion: &quot;80&quot;</span><br><span class="line">  uid: 5620074f-ddb8-4cb9-9d76-6e6b7206cdc1</span><br><span class="line">spec:</span><br><span class="line">  matchingPrecedence: 2</span><br><span class="line">  priorityLevelConfiguration:</span><br><span class="line">    name: exempt</span><br><span class="line">  rules:</span><br><span class="line">  - nonResourceRules:</span><br><span class="line">    - nonResourceURLs:</span><br><span class="line">      - /healthz</span><br><span class="line">      - /readyz</span><br><span class="line">      - /livez</span><br><span class="line">      verbs:</span><br><span class="line">      - get</span><br><span class="line">    subjects:</span><br><span class="line">    - group:</span><br><span class="line">        name: system:unauthenticated</span><br><span class="line">      kind: Group</span><br><span class="line">    - group:</span><br><span class="line">        name: system:authenticated</span><br><span class="line">      kind: Group</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">    message: This FlowSchema references the PriorityLevelConfiguration object named</span><br><span class="line">      &quot;exempt&quot; and it exists</span><br><span class="line">    reason: Found</span><br><span class="line">    status: &quot;False&quot;</span><br><span class="line">    type: Dangling</span><br></pre></td></tr></table></figure>

<blockquote>
<p>system-leader-election</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">$ k get flowschemas.flowcontrol.apiserver.k8s.io system-leader-election -oyaml</span><br><span class="line">apiVersion: flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">kind: FlowSchema</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    apf.kubernetes.io/autoupdate-spec: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: system-leader-election</span><br><span class="line">  resourceVersion: &quot;63&quot;</span><br><span class="line">  uid: c4152002-0863-41b9-90af-a86617e27289</span><br><span class="line">spec:</span><br><span class="line">  distinguisherMethod:</span><br><span class="line">    type: ByUser</span><br><span class="line">  matchingPrecedence: 100</span><br><span class="line">  priorityLevelConfiguration:</span><br><span class="line">    name: leader-election</span><br><span class="line">  rules:</span><br><span class="line">  - resourceRules:</span><br><span class="line">    - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">      namespaces:</span><br><span class="line">      - kube-system</span><br><span class="line">      resources:</span><br><span class="line">      - endpoints</span><br><span class="line">      - configmaps</span><br><span class="line">      verbs:</span><br><span class="line">      - get</span><br><span class="line">      - create</span><br><span class="line">      - update</span><br><span class="line">    - apiGroups:</span><br><span class="line">      - coordination.k8s.io</span><br><span class="line">      namespaces:</span><br><span class="line">      - &#x27;*&#x27;</span><br><span class="line">      resources:</span><br><span class="line">      - leases</span><br><span class="line">      verbs:</span><br><span class="line">      - get</span><br><span class="line">      - create</span><br><span class="line">      - update</span><br><span class="line">    subjects:</span><br><span class="line">    - kind: User</span><br><span class="line">      user:</span><br><span class="line">        name: system:kube-controller-manager</span><br><span class="line">    - kind: User</span><br><span class="line">      user:</span><br><span class="line">        name: system:kube-scheduler</span><br><span class="line">    - kind: ServiceAccount</span><br><span class="line">      serviceAccount:</span><br><span class="line">        name: &#x27;*&#x27;</span><br><span class="line">        namespace: kube-system</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">    message: This FlowSchema references the PriorityLevelConfiguration object named</span><br><span class="line">      &quot;leader-election&quot; and it exists</span><br><span class="line">    reason: Found</span><br><span class="line">    status: &quot;False&quot;</span><br><span class="line">    type: Dangling</span><br><span class="line">    </span><br><span class="line">$ k get prioritylevelconfigurations.flowcontrol.apiserver.k8s.io leader-election -oyaml</span><br><span class="line">apiVersion: flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">kind: PriorityLevelConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    apf.kubernetes.io/autoupdate-spec: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  generation: 1</span><br><span class="line">  name: leader-election</span><br><span class="line">  resourceVersion: &quot;62&quot;</span><br><span class="line">  uid: 6cf63c57-6199-4511-bc3e-336b8776e373</span><br><span class="line">spec:</span><br><span class="line">  limited:</span><br><span class="line">    assuredConcurrencyShares: 10</span><br><span class="line">    limitResponse:</span><br><span class="line">      queuing:</span><br><span class="line">        handSize: 4</span><br><span class="line">        queueLengthLimit: 50</span><br><span class="line">        queues: 16</span><br><span class="line">      type: Queue</span><br><span class="line">  type: Limited</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>调试</p>
</blockquote>
<table>
<thead>
<tr>
<th>URI</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;dump_priority_levels</td>
<td>所有 <code>Priority Level</code> 及其当前状态</td>
</tr>
<tr>
<td>&#x2F;dump_queues</td>
<td>所有 <code>Queue</code> 及其当前状态</td>
</tr>
<tr>
<td>&#x2F;dump_requests</td>
<td>当前<code>正在队列中等待</code>的所有<code>请求</code></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ k get --raw /debug/api_priority_and_fairness/dump_priority_levels</span><br><span class="line">PriorityLevelName, ActiveQueues, IsIdle, IsQuiescing, WaitingRequests, ExecutingRequests</span><br><span class="line">global-default,    0,            true,   false,       0,               0</span><br><span class="line">catch-all,         0,            true,   false,       0,               0</span><br><span class="line">exempt,            &lt;none&gt;,       &lt;none&gt;, &lt;none&gt;,      &lt;none&gt;,          &lt;none&gt;</span><br><span class="line">system,            0,            true,   false,       0,               0</span><br><span class="line">node-high,         0,            true,   false,       0,               0</span><br><span class="line">leader-election,   0,            true,   false,       0,               0</span><br><span class="line">workload-high,     0,            false,  false,       0,               17</span><br><span class="line">workload-low,      0,            true,   false,       0,               0</span><br><span class="line"></span><br><span class="line">$ k get --raw /debug/api_priority_and_fairness/dump_queues | grep &#x27;workload-high&#x27; | sort -k4 -nr | head -n 10</span><br><span class="line">PriorityLevelName, Index,  PendingRequests, ExecutingRequests, VirtualStart</span><br><span class="line">workload-high,     57,     0,               17,                147156.7636</span><br><span class="line">workload-high,     99,     0,               0,                 0.0000</span><br><span class="line">workload-high,     98,     0,               0,                 0.0000</span><br><span class="line">workload-high,     97,     0,               0,                 0.0000</span><br><span class="line">workload-high,     96,     0,               0,                 11.4672</span><br><span class="line">workload-high,     95,     0,               0,                 0.0000</span><br><span class="line">workload-high,     94,     0,               0,                 0.5345</span><br><span class="line">workload-high,     93,     0,               0,                 0.0000</span><br><span class="line">workload-high,     92,     0,               0,                 11.7450</span><br><span class="line">workload-high,     91,     0,               0,                 0.0000</span><br><span class="line"></span><br><span class="line">$ k get --raw /debug/api_priority_and_fairness/dump_requests</span><br><span class="line">PriorityLevelName, FlowSchemaName, QueueIndex, RequestIndexInQueue, FlowDistingsher, ArriveTime</span><br></pre></td></tr></table></figure>

<h1 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h1><blockquote>
<p>无状态 + 多副本</p>
</blockquote>
<ol>
<li>API Server 是<code>无状态</code>的 Rest Server，方便执行 <code>Scale Up/down</code></li>
<li>负载均衡<ul>
<li>在多个 API Server 实例之上，配置负载均衡（如 <code>haproxy</code>）</li>
<li><code>证书</code>可能需要加上 <code>Loadbalancer VIP</code> 重新生成</li>
</ul>
</li>
</ol>
<blockquote>
<p>CPU + Memory</p>
</blockquote>
<ol>
<li>随着集群中 Node 不断增多，API Server 对 CPU 和 Memory 的开销会不断增大</li>
<li>过少的 CPU 资源会降低其处理效率，过少的内存资源会导致 Pod 被 OOMKilled</li>
</ol>
<blockquote>
<p>RateLimit</p>
</blockquote>
<ol>
<li><code>max-requests-inflight</code> + <code>max-mutating-requests-inflight</code></li>
<li><code>APF</code></li>
</ol>
<blockquote>
<p>Cache</p>
</blockquote>
<ol>
<li><code>API Server</code> 与 <code>etcd</code> 之间是基于 <code>gRPC</code> 协议进行通信的（gRPC 协议保证了在<code>大规模集群</code>中的<code>数据高速传输</code>）<ul>
<li>gRPC 是基于<code>连接复用</code>的 <code>HTTP/2</code><ul>
<li>针对<code>相同分组</code>的对象，API Server 和 etcd 之间共享<code>相同的 TCP 连接</code>，不同请求使用不同的 Stream</li>
</ul>
</li>
<li>一个 <code>HTTP/2 连接</code>是有 <code>Stream 配额</code>的，配额大小会限制其能支持的<code>并发请求</code></li>
</ul>
</li>
<li>API Server 提供了<code>集群对象</code>的<code>缓存</code>机制<ul>
<li>当客户端发起查询请求时<ul>
<li>API Server 默认会将其<code>缓存</code>直接返回给客户端，缓存区大小由参数 <code>--watch-cache-sizes</code> 控制</li>
</ul>
</li>
<li>针对访问比较多的对象，设置适当大小的缓存，可以极大降低对 etcd 的访问频率，降低对 etcd 集群的读写压力</li>
<li>API Server 也允许客户端<code>忽略缓存</code>，API Server 直接从 etcd 中拉取最新数据返回给客户端</li>
</ul>
</li>
</ol>
<blockquote>
<p>长连接</p>
</blockquote>
<ol>
<li>当查询请求的返回<code>数据量</code>比较大且此类请求<code>并发量</code>较大时，容易引起 TCP 链路的阻塞，导致其它查询的操作超时</li>
<li>客户端应尽量通过<code>长连接</code>来 <code>List &amp; Watch</code>，避免<code>全量</code>从 API Server 获取数据，降低 API Server 的压力</li>
</ol>
<blockquote>
<p>访问方式</p>
</blockquote>
<ol>
<li><code>外部用户</code>，永远只通过 <code>Loadbalancer VIP</code> 访问</li>
<li>只有当<code>负载均衡</code>（一般为 Service）出现故障时，管理员才切换到 <code>apiserver IP</code> 进行管理</li>
<li><code>内部组件</code>，应使用<code>统一的入口</code>访问 API Server，确保看到<code>一致视图</code></li>
</ol>
<table>
<thead>
<tr>
<th>Client type</th>
<th>外部 LB VIP</th>
<th>Service Cluster IP</th>
<th>apiserver IP</th>
</tr>
</thead>
<tbody><tr>
<td>Internal</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>External</td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ k get svc -owide</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   4h32m   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get svc kubernetes -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:22Z&quot;</span><br><span class="line">  labels:</span><br><span class="line">    component: apiserver</span><br><span class="line">    provider: kubernetes</span><br><span class="line">  name: kubernetes</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;206&quot;</span><br><span class="line">  uid: 5b0d88ce-3736-44e8-b06f-395d0ab457ad</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.96.0.1</span><br><span class="line">  clusterIPs:</span><br><span class="line">  - 10.96.0.1</span><br><span class="line">  internalTrafficPolicy: Cluster</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv4</span><br><span class="line">  ipFamilyPolicy: SingleStack</span><br><span class="line">  ports:</span><br><span class="line">  - name: https</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 6443</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br><span class="line">  </span><br><span class="line">$ curl -k https://10.96.0.1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;forbidden: User \&quot;system:anonymous\&quot; cannot get path \&quot;/\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h1><h2 id="APIService"><a href="#APIService" class="headerlink" title="APIService"></a>APIService</h2><blockquote>
<p>任何<code>对象</code>都有对应的 <code>APIService</code>（对象应该由哪个 <code>API Server</code> 来处理，<code>kube-aggregator</code>）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&#x27;apiregistration.k8s.io&#x27;</span><br><span class="line">NAME          SHORTNAMES   APIVERSION                  NAMESPACED   KIND</span><br><span class="line">apiservices                apiregistration.k8s.io/v1   false        APIService</span><br><span class="line"></span><br><span class="line">$ k get apiservices.apiregistration.k8s.io</span><br><span class="line">NAME                                   SERVICE                       AVAILABLE   AGE</span><br><span class="line">v1.                                    Local                         True        4h46m</span><br><span class="line">v1.admissionregistration.k8s.io        Local                         True        4h46m</span><br><span class="line">v1.apiextensions.k8s.io                Local                         True        4h46m</span><br><span class="line">v1.apps                                Local                         True        4h46m</span><br><span class="line">v1.authentication.k8s.io               Local                         True        4h46m</span><br><span class="line">v1.authorization.k8s.io                Local                         True        4h46m</span><br><span class="line">v1.autoscaling                         Local                         True        4h46m</span><br><span class="line">v1.batch                               Local                         True        4h46m</span><br><span class="line">v1.certificates.k8s.io                 Local                         True        4h46m</span><br><span class="line">v1.coordination.k8s.io                 Local                         True        4h46m</span><br><span class="line">v1.crd.projectcalico.org               Local                         True        4h44m</span><br><span class="line">v1.discovery.k8s.io                    Local                         True        4h46m</span><br><span class="line">v1.events.k8s.io                       Local                         True        4h46m</span><br><span class="line">v1.networking.k8s.io                   Local                         True        4h46m</span><br><span class="line">v1.node.k8s.io                         Local                         True        4h46m</span><br><span class="line">v1.operator.tigera.io                  Local                         True        4h44m</span><br><span class="line">v1.policy                              Local                         True        4h46m</span><br><span class="line">v1.rbac.authorization.k8s.io           Local                         True        4h46m</span><br><span class="line">v1.scheduling.k8s.io                   Local                         True        4h46m</span><br><span class="line">v1.storage.k8s.io                      Local                         True        4h46m</span><br><span class="line">v1beta1.batch                          Local                         True        4h46m</span><br><span class="line">v1beta1.discovery.k8s.io               Local                         True        4h46m</span><br><span class="line">v1beta1.events.k8s.io                  Local                         True        4h46m</span><br><span class="line">v1beta1.flowcontrol.apiserver.k8s.io   Local                         True        4h46m</span><br><span class="line">v1beta1.node.k8s.io                    Local                         True        4h46m</span><br><span class="line">v1beta1.policy                         Local                         True        4h46m</span><br><span class="line">v1beta1.storage.k8s.io                 Local                         True        4h46m</span><br><span class="line">v2beta1.autoscaling                    Local                         True        4h46m</span><br><span class="line">v2beta2.autoscaling                    Local                         True        4h46m</span><br><span class="line">v3.projectcalico.org                   calico-apiserver/calico-api   True        4h38m</span><br><span class="line"></span><br><span class="line">$ k get apiservices.apiregistration.k8s.io v1. -oyaml</span><br><span class="line">apiVersion: apiregistration.k8s.io/v1</span><br><span class="line">kind: APIService</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kube-aggregator.kubernetes.io/automanaged: onstart</span><br><span class="line">  name: v1.</span><br><span class="line">  resourceVersion: &quot;7&quot;</span><br><span class="line">  uid: b2e42b10-1da8-46ba-81d1-7262c4fbfb6e</span><br><span class="line">spec:</span><br><span class="line">  groupPriorityMinimum: 18000</span><br><span class="line">  version: v1</span><br><span class="line">  versionPriority: 1</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: &quot;2022-07-16T09:51:21Z&quot;</span><br><span class="line">    message: Local APIServices are always available</span><br><span class="line">    reason: Local</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: Available</span><br></pre></td></tr></table></figure>

<h2 id="apimachinery"><a href="#apimachinery" class="headerlink" title="apimachinery"></a>apimachinery</h2><blockquote>
<p>Scheme, typing, encoding, decoding, and conversion packages for Kubernetes and Kubernetes-like API objects.</p>
</blockquote>
<h3 id="GKV"><a href="#GKV" class="headerlink" title="GKV"></a>GKV</h3><table>
<thead>
<tr>
<th>Version</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>External version</td>
<td>面向用户</td>
</tr>
<tr>
<td>Internel version</td>
<td>内部版本</td>
</tr>
<tr>
<td>Storage version</td>
<td>etcd</td>
</tr>
</tbody></table>
<h3 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h3><blockquote>
<p>pkg&#x2F;apis&#x2F;core&#x2F;register.go</p>
</blockquote>
<blockquote>
<p>定义 GroupVersion</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SchemeGroupVersion is group version used to register these objects</span></span><br><span class="line"><span class="keyword">var</span> SchemeGroupVersion = schema.GroupVersion&#123;Group: GroupName, Version: runtime.APIVersionInternal&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>定义 SchemeBuilder</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    <span class="comment">// SchemeBuilder object to register various known types</span></span><br><span class="line">    SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AddToScheme represents a func that can be used to apply all the registered</span></span><br><span class="line">    <span class="comment">// funcs in a scheme</span></span><br><span class="line">    AddToScheme = SchemeBuilder.AddToScheme</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将对象加入 SchemeBuilder</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addKnownTypes</span><span class="params">(scheme *runtime.Scheme)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := scheme.AddIgnoredConversionType(&amp;metav1.TypeMeta&#123;&#125;, &amp;metav1.TypeMeta&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    scheme.AddKnownTypes(SchemeGroupVersion,</span><br><span class="line">        &amp;Pod&#123;&#125;,</span><br><span class="line">        &amp;PodList&#123;&#125;,</span><br><span class="line">        &amp;PodStatusResult&#123;&#125;,</span><br><span class="line">        &amp;PodTemplate&#123;&#125;,</span><br><span class="line">        &amp;PodTemplateList&#123;&#125;,</span><br><span class="line">        &amp;ReplicationControllerList&#123;&#125;,</span><br><span class="line">        &amp;ReplicationController&#123;&#125;,</span><br><span class="line">        &amp;ServiceList&#123;&#125;,</span><br><span class="line">        &amp;Service&#123;&#125;,</span><br><span class="line">        &amp;ServiceProxyOptions&#123;&#125;,</span><br><span class="line">        &amp;NodeList&#123;&#125;,</span><br><span class="line">        &amp;Node&#123;&#125;,</span><br><span class="line">        &amp;NodeProxyOptions&#123;&#125;,</span><br><span class="line">        &amp;Endpoints&#123;&#125;,</span><br><span class="line">        &amp;EndpointsList&#123;&#125;,</span><br><span class="line">        &amp;Binding&#123;&#125;,</span><br><span class="line">        &amp;Event&#123;&#125;,</span><br><span class="line">        &amp;EventList&#123;&#125;,</span><br><span class="line">        &amp;List&#123;&#125;,</span><br><span class="line">        &amp;LimitRange&#123;&#125;,</span><br><span class="line">        &amp;LimitRangeList&#123;&#125;,</span><br><span class="line">        &amp;ResourceQuota&#123;&#125;,</span><br><span class="line">        &amp;ResourceQuotaList&#123;&#125;,</span><br><span class="line">        &amp;Namespace&#123;&#125;,</span><br><span class="line">        &amp;NamespaceList&#123;&#125;,</span><br><span class="line">        &amp;ServiceAccount&#123;&#125;,</span><br><span class="line">        &amp;ServiceAccountList&#123;&#125;,</span><br><span class="line">        &amp;Secret&#123;&#125;,</span><br><span class="line">        &amp;SecretList&#123;&#125;,</span><br><span class="line">        &amp;PersistentVolume&#123;&#125;,</span><br><span class="line">        &amp;PersistentVolumeList&#123;&#125;,</span><br><span class="line">        &amp;PersistentVolumeClaim&#123;&#125;,</span><br><span class="line">        &amp;PersistentVolumeClaimList&#123;&#125;,</span><br><span class="line">        &amp;PodAttachOptions&#123;&#125;,</span><br><span class="line">        &amp;PodLogOptions&#123;&#125;,</span><br><span class="line">        &amp;PodExecOptions&#123;&#125;,</span><br><span class="line">        &amp;PodPortForwardOptions&#123;&#125;,</span><br><span class="line">        &amp;PodProxyOptions&#123;&#125;,</span><br><span class="line">        &amp;ComponentStatus&#123;&#125;,</span><br><span class="line">        &amp;ComponentStatusList&#123;&#125;,</span><br><span class="line">        &amp;SerializedReference&#123;&#125;,</span><br><span class="line">        &amp;RangeAllocation&#123;&#125;,</span><br><span class="line">        &amp;ConfigMap&#123;&#125;,</span><br><span class="line">        &amp;ConfigMapList&#123;&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="对象定义"><a href="#对象定义" class="headerlink" title="对象定义"></a>对象定义</h3><blockquote>
<p>单一对象的数据结构：<code>TypeMeta</code>、<code>ObjectMeta</code>、<code>Spec</code>、<code>Status</code></p>
</blockquote>
<blockquote>
<p>Internel version</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717004738888.png" alt="image-20230717004738888"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717004842094.png" alt="image-20230717004842094"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pod is a collection of containers, used as either input (create, update) or as output (list, get).</span></span><br><span class="line"><span class="keyword">type</span> Pod <span class="keyword">struct</span> &#123;</span><br><span class="line">    metav1.TypeMeta</span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    metav1.ObjectMeta</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Spec defines the behavior of a pod.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Spec PodSpec</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status represents the current information about a pod. This data may not be up</span></span><br><span class="line">    <span class="comment">// to date.</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Status PodStatus</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TypeMeta describes an individual object in an API response or request</span></span><br><span class="line"><span class="comment">// with strings representing the type of the object and its API schema version.</span></span><br><span class="line"><span class="comment">// Structures that are versioned or persisted should inline TypeMeta.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen=false</span></span><br><span class="line"><span class="keyword">type</span> TypeMeta <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Kind is a string value representing the REST resource this object represents.</span></span><br><span class="line">    <span class="comment">// Servers may infer this from the endpoint the client submits requests to.</span></span><br><span class="line">    <span class="comment">// Cannot be updated.</span></span><br><span class="line">    <span class="comment">// In CamelCase.</span></span><br><span class="line">    <span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    Kind <span class="type">string</span> <span class="string">`json:&quot;kind,omitempty&quot; protobuf:&quot;bytes,1,opt,name=kind&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// APIVersion defines the versioned schema of this representation of an object.</span></span><br><span class="line">    <span class="comment">// Servers should convert recognized schemas to the latest internal value, and</span></span><br><span class="line">    <span class="comment">// may reject unrecognized values.</span></span><br><span class="line">    <span class="comment">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class="line">    <span class="comment">// +optional</span></span><br><span class="line">    APIVersion <span class="type">string</span> <span class="string">`json:&quot;apiVersion,omitempty&quot; protobuf:&quot;bytes,2,opt,name=apiVersion&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>External version - 多了一些 <code>json tag</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717005023530.png" alt="image-20230717005023530"></p>
<h3 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/code-generator">https://github.com/kubernetes/code-generator</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>Tags</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>Global Tags</code></td>
<td>定义在 <code>doc.go</code></td>
</tr>
<tr>
<td><code>Local Tags</code></td>
<td>定义在 <code>types.go</code> 中的每个对象里</td>
</tr>
</tbody></table>
<blockquote>
<p>Global Tags</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717010256614.png" alt="image-20230717010256614"></p>
<blockquote>
<p>Local Tags</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717010549365.png" alt="image-20230717010549365"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717010805823.png" alt="image-20230717010805823"></p>
<table>
<thead>
<tr>
<th>Tags</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>deepcopy-gen</code></td>
<td>为对象生成 DeepCopy 方法，用于创建对象副本</td>
</tr>
<tr>
<td><code>client-gen</code></td>
<td>创建 Clientset，用于操作对象的 CRUD</td>
</tr>
<tr>
<td><code>informer-gen</code></td>
<td>为对象创建 <code>Informer</code> 框架，用于<code>监听对象变化</code></td>
</tr>
<tr>
<td><code>lister-gen</code></td>
<td>为对象构建 <code>Lister</code> 框架，用于为 <code>Get</code> 和 <code>List</code> 操作，构建<code>客户端缓存</code></td>
</tr>
<tr>
<td><code>coversion-gen</code></td>
<td>为对象构建 <code>Conversion</code> 方法，用于<code>内外版本转换</code>以及<code>不同版本号的转换</code></td>
</tr>
</tbody></table>
<h3 id="etcd-storage"><a href="#etcd-storage" class="headerlink" title="etcd storage"></a>etcd storage</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717011032867.png" alt="image-20230717011032867"></p>
<blockquote>
<p>Strategy - PrepareForCreate、PrepareForUpdate 等都属于 API Server 的框架层</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717011313999.png" alt="image-20230717011313999"></p>
<h3 id="subresource"><a href="#subresource" class="headerlink" title="subresource"></a>subresource</h3><blockquote>
<p><code>内嵌</code>在 Kubernetes 对象中，有<code>独立的操作逻辑</code>的属性集合，如 <code>PodStatus</code> 是 Pod 的 subresource</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717012609744.png" alt="image-20230717012609744"></p>
<blockquote>
<p>要更新 Pod Status 时，请求（New）里面的 Pod Spec、Pod OwnerReferences 都会被 <code>etcd</code> 里面（Old）的版本<code>覆盖</code></p>
</blockquote>
<blockquote>
<p>即当更新 Status 时，所有请求里面的非 Status 信息都会丢掉，采用与 etcd 一致的版本，反之，更新 Spec 亦然</p>
</blockquote>
<blockquote>
<p>背景：Status 的更新<code>非常频繁</code></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230717012242569.png" alt="image-20230717012242569"></p>
<h3 id="APIGroup"><a href="#APIGroup" class="headerlink" title="APIGroup"></a>APIGroup</h3><blockquote>
<p>定义 Storage</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configMapStorage, err := configmapstore.NewREST(restOptionsGetter)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>定义对象的 StorageMap</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">storage := map[string]rest.Storage&#123;&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">if resource := &quot;configmaps&quot;; apiResourceConfigSource.ResourceEnabled(corev1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">  storage[resource] = configMapStorage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将对象注册到 API Server（即挂载 Handler）</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(groupName) == <span class="number">0</span> &#123;</span><br><span class="line">  <span class="comment">// the legacy group for core APIs is special that it is installed into /api via this special install method.</span></span><br><span class="line">  <span class="keyword">if</span> err := m.GenericAPIServer.InstallLegacyAPIGroup(genericapiserver.DefaultLegacyAPIPrefix, &amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering legacy API: %w&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// everything else goes to /apis</span></span><br><span class="line">  nonLegacy = <span class="built_in">append</span>(nonLegacy, &amp;apiGroupInfo)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Static-Pod"><a href="#Static-Pod" class="headerlink" title="Static Pod"></a>Static Pod</h1><blockquote>
<p>kubelet 在创建完 <code>Static Pod</code> 后，会在 <code>API Server</code> 补一个 Pod 对象，称为 <code>Mirror Pod</code></p>
</blockquote>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/03/cloud-native-foundation-k8s-apiserver/">https://blog.zhongmingmao.top/2022/12/03/cloud-native-foundation-k8s-apiserver/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/04/cloud-native-foundation-k8s-scheduler/" title="Kubernetes - Scheduler"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/rebalancing-8_qgh6ro.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes - Scheduler</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/02/cloud-native-foundation-k8s-etcd/" title="Kubernetes - etcd"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/etcd-5874937.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Kubernetes - etcd</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/05/11/cloud-native-foundation-k8s-helm-doc/" title="Kubernetes - Helm Doc"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/helm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-11</div><div class="title">Kubernetes - Helm Doc</div></div></a></div><div><a href="/2023/02/02/cloud-native-foundation-k8s-security/" title="Kubernetes - Security"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-security.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-02</div><div class="title">Kubernetes - Security</div></div></a></div><div><a href="/2023/02/01/cloud-native-foundation-k8s-federation/" title="Kubernetes - Federation"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/federation.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">Kubernetes - Federation</div></div></a></div><div><a href="/2023/01/31/cloud-native-foundation-k8s-istio/" title="Kubernetes - Istio"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-istio.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-31</div><div class="title">Kubernetes - Istio</div></div></a></div><div><a href="/2023/01/30/cloud-native-foundation-k8s-envoy/" title="Kubernetes - Envoy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/go-envoy.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-30</div><div class="title">Kubernetes - Envoy</div></div></a></div><div><a href="/2023/01/29/cloud-native-foundation-k8s-scaling/" title="Kubernetes - Scaling"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231223144041516.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-29</div><div class="title">Kubernetes - Scaling</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">639</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">2.</span> <span class="toc-text">认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#X509"><span class="toc-number">2.1.</span> <span class="toc-text">X509</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81-Token-%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">静态 Token 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceAccount"><span class="toc-number">2.3.</span> <span class="toc-text">ServiceAccount</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Webhook"><span class="toc-number">2.4.</span> <span class="toc-text">Webhook</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%89%B4%E6%9D%83"><span class="toc-number">3.</span> <span class="toc-text">鉴权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RBAC"><span class="toc-number">3.1.</span> <span class="toc-text">RBAC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%A7%9F%E6%88%B7"><span class="toc-number">3.2.</span> <span class="toc-text">多租户</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">准入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6"><span class="toc-number">4.1.</span> <span class="toc-text">插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91"><span class="toc-number">4.2.</span> <span class="toc-text">开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Webhook-Server"><span class="toc-number">4.2.1.</span> <span class="toc-text">Webhook Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS"><span class="toc-number">4.2.2.</span> <span class="toc-text">TLS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%90%E6%B5%81"><span class="toc-number">5.</span> <span class="toc-text">限流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%AE%97%E6%B3%95"><span class="toc-number">5.1.</span> <span class="toc-text">传统算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E6%95%B0%E5%99%A8-%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3"><span class="toc-number">5.1.1.</span> <span class="toc-text">计数器 + 固定窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E6%95%B0%E5%99%A8-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="toc-number">5.1.2.</span> <span class="toc-text">计数器 + 滑动窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%A1%B6"><span class="toc-number">5.1.3.</span> <span class="toc-text">漏桶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A4%E7%89%8C%E6%A1%B6"><span class="toc-number">5.1.4.</span> <span class="toc-text">令牌桶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-Server"><span class="toc-number">5.2.</span> <span class="toc-text">API Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#APF"><span class="toc-number">5.3.</span> <span class="toc-text">APF</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">高可用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.</span> <span class="toc-text">对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#APIService"><span class="toc-number">7.1.</span> <span class="toc-text">APIService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#apimachinery"><span class="toc-number">7.2.</span> <span class="toc-text">apimachinery</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GKV"><span class="toc-number">7.2.1.</span> <span class="toc-text">GKV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Group"><span class="toc-number">7.2.2.</span> <span class="toc-text">Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%AE%9A%E4%B9%89"><span class="toc-number">7.2.3.</span> <span class="toc-text">对象定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-number">7.2.4.</span> <span class="toc-text">代码生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etcd-storage"><span class="toc-number">7.2.5.</span> <span class="toc-text">etcd storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subresource"><span class="toc-number">7.2.6.</span> <span class="toc-text">subresource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APIGroup"><span class="toc-number">7.2.7.</span> <span class="toc-text">APIGroup</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Static-Pod"><span class="toc-number">8.</span> <span class="toc-text">Static Pod</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/ai-agent.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - Overview"/></a><div class="content"><a class="title" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview">AI Agent - Overview</a><time datetime="2025-01-17T16:06:25.000Z" title="Created 2025-01-18 00:06:25">2025-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/17/new-java-feature-foreign-function-api/" title="New Java Feature - Foreign Function API"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-feature-1253868755.cos.ap-guangzhou.myqcloud.com/Java-Foreign-Function-API.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="New Java Feature - Foreign Function API"/></a><div class="content"><a class="title" href="/2025/01/17/new-java-feature-foreign-function-api/" title="New Java Feature - Foreign Function API">New Java Feature - Foreign Function API</a><time datetime="2025-01-16T16:06:25.000Z" title="Created 2025-01-17 00:06:25">2025-01-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2025 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - Pod Life Cycle | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="生命周期 Pending - 调度尚未成功，ContainerCreating - 完成调度">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Pod Life Cycle">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="生命周期 Pending - 调度尚未成功，ContainerCreating - 完成调度">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/pod-life-cycle.png">
<meta property="article:published_time" content="2022-12-09T16:06:25.000Z">
<meta property="article:modified_time" content="2023-08-29T17:17:38.077Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cloud Native Foundation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/pod-life-cycle.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - Pod Life Cycle',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-30 01:17:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">438</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">123</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">64</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/pod-life-cycle.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - Pod Life Cycle</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-12-09T16:06:25.000Z" title="Created 2022-12-10 00:06:25">2022-12-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">3.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>20min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h1><blockquote>
<p>Pending - 调度尚未成功，ContainerCreating - 完成调度</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230827193539631.png" alt="image-20230827193539631"></p>
<span id="more"></span>

<h1 id="Pod-状态机"><a href="#Pod-状态机" class="headerlink" title="Pod 状态机"></a>Pod 状态机</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230827205507924.png" alt="image-20230827205507924"></p>
<h1 id="Pod-Phase"><a href="#Pod-Phase" class="headerlink" title="Pod Phase"></a>Pod Phase</h1><blockquote>
<p>Pod Phase: <code>Pending</code> &#x2F; <code>Running</code> &#x2F; <code>Succeeded</code> &#x2F; <code>Failed</code> &#x2F; <code>Unknown</code></p>
</blockquote>
<blockquote>
<p><code>k get pod</code> 显示的 <code>STATUS</code> 是由 <code>pod.status.phase</code> 和 <code>pod.status.conditions</code> 计算得出</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get po nginx</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          35s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get po nginx -oyaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T07:00:45Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T07:00:46Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T07:00:46Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T07:00:45Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://7610adb2b5874ac1de274a2839679fd9d45d7c2f4046203b12725e6f53c1f220</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-08-28T07:00:46Z&quot;</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Pod Status 的计算细节</p>
</blockquote>
<table>
<thead>
<tr>
<th>Status</th>
<th>Phase</th>
<th>Conditions</th>
</tr>
</thead>
<tbody><tr>
<td>Completed</td>
<td>Succeeded</td>
<td></td>
</tr>
<tr>
<td>ContainerCreating</td>
<td>Pending</td>
<td></td>
</tr>
<tr>
<td>CrashLoopBackOff</td>
<td>Running</td>
<td>container exits</td>
</tr>
<tr>
<td>CreateContainerConfigError</td>
<td>Pending</td>
<td>configmap or secret not found</td>
</tr>
<tr>
<td>ErrImagePull<br />ImagePullBackOff<br />Init:ImagePullBackOff<br />InvalidImageName</td>
<td>Pending</td>
<td>back-off pulling image</td>
</tr>
<tr>
<td>Error</td>
<td>Error</td>
<td>restartPolicy: Never<br/>container exits with Error (not 0)</td>
</tr>
<tr>
<td>Evicted</td>
<td>Failed</td>
<td>message: ‘Usage of Empty Dir volume<br/>“myworkdir” exceeds the limit “40Gi”. “<br/>reason: Evicted</td>
</tr>
<tr>
<td>Init:0&#x2F;1</td>
<td>Pending</td>
<td>Init containers don’t exit</td>
</tr>
<tr>
<td>Init:CrashLoopBackOff &#x2F;<br/>Init:Error</td>
<td>Pending</td>
<td>Init container crashed (exit with not 1)</td>
</tr>
<tr>
<td>OOMKilled</td>
<td>Running</td>
<td>Containers are OOMKilled</td>
</tr>
<tr>
<td>StartError</td>
<td>Running</td>
<td>Containers cannot be started</td>
</tr>
<tr>
<td>Unknown</td>
<td>Running</td>
<td>Node NotReady</td>
</tr>
<tr>
<td>OutOfCpu&#x2F;OutOfMemory</td>
<td>Failed</td>
<td>Scheduled, but it cannot pass kubelet admit</td>
</tr>
</tbody></table>
<h1 id="Pod-HA"><a href="#Pod-HA" class="headerlink" title="Pod HA"></a>Pod HA</h1><blockquote>
<p>避免<code>容器进程</code>被<code>终止</code> + 避免 <code>Pod</code> 被<code>驱逐</code></p>
</blockquote>
<blockquote>
<p><code>kubelet</code> 会监控<code>不可压缩资源</code>（内存、磁盘等）的使用情况，会<code>驱逐</code>相关的 Pod</p>
</blockquote>
<ol>
<li>设置合理的 <code>resources.memory.limit</code>，防止<code>容器进程</code>被 <code>OOMKill</code></li>
<li>设置合理的 <code>emptydir.sizeLimit</code> 并确保数据写入不超过 emptyDir 的限制，防止 <code>Pod</code> 被<code>驱逐</code></li>
</ol>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><blockquote>
<p>多容器之间共享存储，最简单的方案是 emptyDir</p>
</blockquote>
<ol>
<li>emptyDir 需要控制 size limit<ul>
<li>无限扩张的应用会撑爆主机磁盘导致主机不可用，导致大规模集群故障</li>
</ul>
</li>
<li>emptyDir size limit 生效后<ul>
<li><code>kubelet</code> 会<code>定期</code>对<code>容器目录</code>执行 <code>du</code> 操作，会产生性能影响 - 前期版本的方案</li>
</ul>
</li>
<li>到达 size limit 后<ul>
<li>Pod 会被<code>驱逐</code>，原 Pod 的日志配置等信息会消失</li>
</ul>
</li>
</ol>
<h2 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h2><blockquote>
<p>当 <code>Configmap</code> 以 <code>Volume</code> 的形式挂载到 Pod 后，<code>变更会有延迟</code>（一般为 1 分钟）</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230829215605183.png" alt="image-20230829215605183"></p>
<blockquote>
<p>除了 <code>rootFS</code>（不可变基础设施），容器重启后数据还在（没有调度到其它 Node）<br>除了 <code>Network volume</code>，Pod 重建后，数据不在了</p>
</blockquote>
<blockquote>
<p>控制日志写入速度，防止 OS 在配置<code>日志滚动窗口期内</code>将硬盘<code>写满</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>存储卷类型</th>
<th>容器重启后<br />数据是否存在</th>
<th>Pod 重建后<br />数据是否存在</th>
<th>大小控制</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>emptyDir</code></td>
<td></td>
<td>N</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>hostPath - 不常用</code></td>
<td></td>
<td>N（调度到别的 Node）</td>
<td>N</td>
<td>需要额外权限控制</td>
</tr>
<tr>
<td><code>Local volume</code></td>
<td></td>
<td>N</td>
<td></td>
<td>无备份</td>
</tr>
<tr>
<td><code>Network volume</code></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>rootFS</code></td>
<td>N</td>
<td>N</td>
<td>N</td>
<td><code>不要写任何数据</code></td>
</tr>
</tbody></table>
<h2 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h2><blockquote>
<p>kubelet 升级</p>
</blockquote>
<ol>
<li>大部分情况下，不会重建 Pod</li>
<li>某些版本因为修改了<code>哈希算法</code>所以会重建 Pod<ul>
<li>冗余部署 &#x2F; 跨故障域部署</li>
</ul>
</li>
</ol>
<blockquote>
<p>OS 升级 &#x2F; Node 重启</p>
</blockquote>
<ol>
<li>Pod 进程会被终止数分钟（≈ 10 分钟）<ul>
<li>跨故障域部署</li>
<li>修改 <code>livenesProbe</code> 和 <code>readinessProbe</code>，加速应用启动</li>
<li>增加 <code>Node NotReady</code> 的 <code>Toleration</code> 时间（例如 15 分钟），避免被驱逐</li>
</ul>
</li>
</ol>
<blockquote>
<p>Node 计划下架</p>
</blockquote>
<ol>
<li><code>drain</code> Node（优雅驱逐 Pod），Pod 进程会被终止数分钟（≈ 10 分钟）<ul>
<li>跨故障域部署</li>
<li>利用 <code>Pod distruption budget</code> 避免 Node 被 <code>drain</code> 而导致 Pod 被意外删除<ul>
<li>应用<code>最多容忍有几个 Pod 不 Ready</code>，避免因为 drain Node  而导致 Pod <code>一下子被驱逐过多</code></li>
</ul>
</li>
<li>利用 pre-stop 做数据备份等操作</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources --api-group=&#x27;policy&#x27;</span><br><span class="line">NAME                   SHORTNAMES   APIVERSION       NAMESPACED   KIND</span><br><span class="line">poddisruptionbudgets   pdb          policy/v1        true         PodDisruptionBudget</span><br><span class="line">podsecuritypolicies    psp          policy/v1beta1   false        PodSecurityPolicy</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">calico-typha</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">calico-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">calico-typha</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">currentHealthy:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">desiredHealthy:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">disruptionsAllowed:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">expectedPods:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Node Crashed</p>
</blockquote>
<ol>
<li>Pod 进程会被终止超过 15 分钟<ul>
<li>跨故障域部署</li>
</ul>
</li>
</ol>
<h2 id="冗余"><a href="#冗余" class="headerlink" title="冗余"></a>冗余</h2><ol>
<li>副本数</li>
<li>更新策略 - <code>maxSurge</code> + <code>maxUnavailable</code></li>
<li><code>PodTemplateHash</code> 的易变形</li>
</ol>
<h1 id="Pod-QoS"><a href="#Pod-QoS" class="headerlink" title="Pod QoS"></a>Pod QoS</h1><blockquote>
<p>当<code>内存承压</code>时，按照 <code>BestEffort</code> -&gt; <code>Burstable</code> -&gt; <code>Guaranteed</code> 的顺序依次<code>驱逐</code> Pod</p>
</blockquote>
<table>
<thead>
<tr>
<th>Level</th>
<th>QoS</th>
<th>Desc</th>
<th>Scene</th>
</tr>
</thead>
<tbody><tr>
<td>High</td>
<td><code>Guaranteed</code></td>
<td><code>每个容器</code>都<code>设置</code>了 CPU 和 Memory 需求<br />Limit 和 Request <code>完全一致</code></td>
<td>重要业务</td>
</tr>
<tr>
<td></td>
<td><code>Burstable</code></td>
<td><code>至少1个</code>容器<code>设置</code>了 CPU 和 Memory 需求<br />Limit 和 Request <code>不一致</code></td>
<td>大多数场景</td>
</tr>
<tr>
<td>Low</td>
<td><code>BestEffort</code></td>
<td><code>每个容器</code>都<code>没有设置</code>了 CPU 和 Memory 需求</td>
<td>生产尽量避免</td>
</tr>
</tbody></table>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">                <span class="attr">cpu:</span> <span class="string">700m</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">                <span class="string">cpu:700m</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">    <span class="attr">qosClass:</span> <span class="string">Guaranteed</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">    <span class="attr">qosClass:</span> <span class="string">Burstable</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Concept</th>
<th>Key points</th>
</tr>
</thead>
<tbody><tr>
<td><code>priorityClass</code></td>
<td>关注<code>调度</code>（抢占<code>低优</code> Pod）</td>
</tr>
<tr>
<td><code>qosClass</code></td>
<td>关注<code>驱逐</code>（资源<code>承压</code>时的质量保证）</td>
</tr>
</tbody></table>
<h1 id="Toleration-Eviction"><a href="#Toleration-Eviction" class="headerlink" title="Toleration + Eviction"></a>Toleration + Eviction</h1><ol>
<li>节点<code>临时不可达</code> <ul>
<li>网络分区</li>
<li>kubelet、containerd 不工作</li>
<li>节点重启超过 15 分钟</li>
</ul>
</li>
<li>增加 <code>tolerationSeconds</code> 以避免被<code>驱逐</code><ul>
<li>尤其是依赖<code>本地存储状态</code>的<code>有状态</code>应用</li>
</ul>
</li>
</ol>
<blockquote>
<p>NotReady Node</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">taints:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">  <span class="attr">timeAdded:</span> <span class="string">&quot;2020-07-09T11:25:10Z&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">  <span class="attr">timeAdded:</span> <span class="string">&quot;2020-07-09T11:25:21Z&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">  <span class="attr">timeAdded:</span> <span class="string">&quot;2020-07-09T11:24:28Z&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">  <span class="attr">timeAdded:</span> <span class="string">&quot;2020-07-09T11:24:32Z&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加 <code>tolerationSeconds</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">900</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">900</span></span><br></pre></td></tr></table></figure>

<h1 id="Probe"><a href="#Probe" class="headerlink" title="Probe"></a>Probe</h1><blockquote>
<p>探针类型 - <code>startupProbe</code> 通过后，<code>livenessProbe</code> 和 <code>readinessProbe</code> 才会介入</p>
</blockquote>
<table>
<thead>
<tr>
<th>Probe</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>startupProbe</code></td>
<td>在<code>初始化</code>阶段（<code>Ready 之前</code>）进行的健康检查<br />通常用来避免过于频繁的监测影响应用启动 - <code>延迟探测</code></td>
</tr>
<tr>
<td><code>livenessProbe</code></td>
<td><code>探活</code>，当检查失败时，意味着应用进程已经<code>无法正常提供服务</code><br /><code>kubelet</code> 会<code>终止</code>该容器进程并按照 <code>restartPolicy</code> 决定是否重启</td>
</tr>
<tr>
<td><code>readinessProbe</code></td>
<td><code>就绪状态检查</code>，当检查失败时，意味着应用进程<code>正在运行</code>，但<code>不能提供服务</code><br />Pod 状态会被标记为 <code>NotReady</code>，不接受<code>流量</code></td>
</tr>
</tbody></table>
<blockquote>
<p>探测方法</p>
</blockquote>
<table>
<thead>
<tr>
<th>Method</th>
<th>Type</th>
</tr>
</thead>
<tbody><tr>
<td><code>ExecAction</code></td>
<td>在<code>容器内部</code>运行指定命令，当返回码为 <code>0</code> 时，探测成功</td>
</tr>
<tr>
<td><code>TCPSocketAction</code></td>
<td>由 <code>kubelet</code> 发起，通过 <code>TCP</code> 协议检查容器 IP 和 Port，当<code>端口可达</code>时，探测成功</td>
</tr>
<tr>
<td><code>HTTPGetAction</code></td>
<td>由 <code>kubelet</code> 发起，对 Pod 进行 <code>GET</code> 请求，当返回码为 <code>200 ~ 400</code>，探测成功</td>
</tr>
</tbody></table>
<blockquote>
<p>探针属性 - <code>livenesProbe.successThreshold</code> 必须为 <code>1</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>Params</th>
<th>Default</th>
<th>Min</th>
</tr>
</thead>
<tbody><tr>
<td><code>initialDelaySeconds</code></td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>period Seconds</td>
<td>10</td>
<td>1</td>
</tr>
<tr>
<td><code>timeoutSeconds</code></td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>successThreshold</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>failureThreshold</td>
<td>3</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenesProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span> <span class="string">s</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">httpHeaders:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">X-Custom-Header</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">Awesome</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>30 秒后开始探测，5 秒为周期，35 秒就绪，40 秒删除文件，连续 3 次探测失败，55 秒恢复未就绪，但不会终止 Pod</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">initial-delay</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">initial-delay</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">centos</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">40</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">600</span></span><br><span class="line">      <span class="attr">readinessProbe:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ k describe po initial-delay</span><br><span class="line">Name:         initial-delay</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         mac-k8s/192.168.191.153</span><br><span class="line">Start Time:   Tue, 29 Aug 2022 08:25:42 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  cni.projectcalico.org/containerID: 65b75a148cab67864c4ef204299083bcd73ad3028037142f6be2810e42d3157f</span><br><span class="line">              cni.projectcalico.org/podIP: 192.168.185.10/32</span><br><span class="line">              cni.projectcalico.org/podIPs: 192.168.185.10/32</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           192.168.185.10</span><br><span class="line">IPs:</span><br><span class="line">  IP:  192.168.185.10</span><br><span class="line">Containers:</span><br><span class="line">  initial-delay:</span><br><span class="line">    Container ID:  docker://c9246e77914de66df7d961a08e9594c60990c8bfc7b91b18a5323fcaedc7a388</span><br><span class="line">    Image:         centos</span><br><span class="line">    Image ID:      docker-pullable://centos@sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Args:</span><br><span class="line">      /bin/sh</span><br><span class="line">      -c</span><br><span class="line">      touch /tmp/healthy; sleep 40; rm -rf /tmp/healthy; sleep 600</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Tue, 29 Aug 2022 08:25:44 +0800</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Readiness:      exec [cat /tmp/healthy] delay=30s timeout=1s period=5s #success=1 #failure=3</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-ppn52 (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             False</span><br><span class="line">  ContainersReady   False</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-ppn52:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                  From               Message</span><br><span class="line">  ----     ------     ----                 ----               -------</span><br><span class="line">  Normal   Scheduled  3m51s                default-scheduler  Successfully assigned default/initial-delay to mac-k8s</span><br><span class="line">  Normal   Pulling    3m50s                kubelet            Pulling image &quot;centos&quot;</span><br><span class="line">  Normal   Pulled     3m49s                kubelet            Successfully pulled image &quot;centos&quot; in 1.331745551s</span><br><span class="line">  Normal   Created    3m49s                kubelet            Created container initial-delay</span><br><span class="line">  Normal   Started    3m49s                kubelet            Started container initial-delay</span><br><span class="line">  Warning  Unhealthy  96s (x21 over 3m6s)  kubelet            Readiness probe failed: cat: /tmp/healthy: No such file or directory</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ k get po -w</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">initial-delay   0/1     Pending   0          0s</span><br><span class="line">initial-delay   0/1     Pending   0          0s</span><br><span class="line">initial-delay   0/1     ContainerCreating   0          0s</span><br><span class="line">initial-delay   0/1     ContainerCreating   0          1s</span><br><span class="line">initial-delay   0/1     Running             0          2s</span><br><span class="line">initial-delay   1/1     Running             0          35s</span><br><span class="line">initial-delay   0/1     Running             0          55s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>3 秒就是 Ready，<code>默认为存活</code>，10 秒后开始探活，周期为 5 秒，45 秒会探活失败（累计 3 次），<code>原地重启</code> Pod<br><code>SIGKILL</code> - Exit Code 137</p>
</blockquote>
<blockquote>
<p>探活 ≈ <code>探死</code>，livenessProbe <code>不会重建</code> Pod</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">centos</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">600</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">$ k describe po liveness</span><br><span class="line">Name:         liveness</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         mac-k8s/192.168.191.153</span><br><span class="line">Start Time:   Tue, 29 Aug 2022 08:38:02 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  cni.projectcalico.org/containerID: d1d42cce5270ebc8c5f92277d69ada4a6d640c43b0da7a1a8380897f290a9a19</span><br><span class="line">              cni.projectcalico.org/podIP: 192.168.185.11/32</span><br><span class="line">              cni.projectcalico.org/podIPs: 192.168.185.11/32</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           192.168.185.11</span><br><span class="line">IPs:</span><br><span class="line">  IP:  192.168.185.11</span><br><span class="line">Containers:</span><br><span class="line">  liveness:</span><br><span class="line">    Container ID:  docker://c22a7dc92cd082ea82dbf7f3f2604458080ea3a059dcff5307b308a393f3ce26</span><br><span class="line">    Image:         centos</span><br><span class="line">    Image ID:      docker-pullable://centos@sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Args:</span><br><span class="line">      /bin/sh</span><br><span class="line">      -c</span><br><span class="line">      touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Tue, 29 Aug 2022 08:39:19 +0800</span><br><span class="line">    Last State:     Terminated</span><br><span class="line">      Reason:       Error</span><br><span class="line">      Exit Code:    137</span><br><span class="line">      Started:      Tue, 29 Aug 2022 08:38:04 +0800</span><br><span class="line">      Finished:     Tue, 29 Aug 2022 08:39:17 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  1</span><br><span class="line">    Liveness:       exec [cat /tmp/healthy] delay=10s timeout=1s period=5s #success=1 #failure=3</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-8ms2w (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-8ms2w:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                From               Message</span><br><span class="line">  ----     ------     ----               ----               -------</span><br><span class="line">  Normal   Scheduled  87s                default-scheduler  Successfully assigned default/liveness to mac-k8s</span><br><span class="line">  Normal   Pulled     85s                kubelet            Successfully pulled image &quot;centos&quot; in 1.649042848s</span><br><span class="line">  Warning  Unhealthy  42s (x3 over 52s)  kubelet            Liveness probe failed: cat: /tmp/healthy: No such file or directory</span><br><span class="line">  Normal   Killing    42s                kubelet            Container liveness failed liveness probe, will be restarted</span><br><span class="line">  Normal   Pulling    12s (x2 over 87s)  kubelet            Pulling image &quot;centos&quot;</span><br><span class="line">  Normal   Created    10s (x2 over 85s)  kubelet            Created container liveness</span><br><span class="line">  Normal   Started    10s (x2 over 85s)  kubelet            Started container liveness</span><br><span class="line">  Normal   Pulled     10s                kubelet            Successfully pulled image &quot;centos&quot; in 1.933447781s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ k get po -w</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness   0/1     Pending   0          0s</span><br><span class="line">liveness   0/1     Pending   0          0s</span><br><span class="line">liveness   0/1     ContainerCreating   0          0s</span><br><span class="line">liveness   0/1     ContainerCreating   0          0s</span><br><span class="line">liveness   1/1     Running             0          3s</span><br><span class="line">liveness   1/1     Running             1 (2s ago)   77s</span><br><span class="line">liveness   1/1     Running             2 (3s ago)   2m33s</span><br><span class="line">liveness   1/1     Running             3 (4s ago)   3m49s</span><br><span class="line">liveness   1/1     Running             4 (3s ago)   5m3s</span><br><span class="line">liveness   1/1     Running             5 (2s ago)   6m17s</span><br><span class="line">liveness   0/1     CrashLoopBackOff    5 (0s ago)   7m30s</span><br><span class="line">liveness   1/1     Running             6 (85s ago)   8m55s</span><br><span class="line">liveness   0/1     CrashLoopBackOff    6 (0s ago)    10m</span><br><span class="line">liveness   1/1     Running             7 (2m51s ago)   12m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ReadinessGates - 在自带的 Pod Conditions 之外引入<code>自定义</code>的就绪条件</p>
</blockquote>
<blockquote>
<p>新引入的 ReadinessGates 的 <code>Condition</code> 为 <code>True</code> 后（由 <code>Controller</code> 修改）<br>加上内置的 Conditions，Pod 才可以为就绪状态</p>
</blockquote>
<blockquote>
<p>ReadinessGates 不就绪，不会<code>接收流量</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">readiness-gate</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-gate</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">readinessGates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">conditionType:</span> <span class="string">&quot;www.example.com/feature-1&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readiness-gate</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-gate</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">readiness-gate</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f readiness-gate.yaml</span><br><span class="line">pod/readiness-gate created</span><br><span class="line">service/readiness-gate created</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">readiness-gate   1/1     Running   0          16s   192.168.185.12   mac-k8s   &lt;none&gt;           0/1</span><br><span class="line"></span><br><span class="line">$ k get svc -owide</span><br><span class="line">NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes       ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   22h   &lt;none&gt;</span><br><span class="line">readiness-gate   ClusterIP   10.100.49.21   &lt;none&gt;        80/TCP    38s   app=readiness-gate</span><br><span class="line"></span><br><span class="line">$ k describe svc readiness-gate</span><br><span class="line">Name:              readiness-gate</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app=readiness-gate</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Family Policy:  SingleStack</span><br><span class="line">IP Families:       IPv4</span><br><span class="line">IP:                10.100.49.21</span><br><span class="line">IPs:               10.100.49.21</span><br><span class="line">Port:              &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ curl -sI 192.168.185.12</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.2</span><br><span class="line">Date: Tue, 29 Aug 2023 04:56:25 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 15 Aug 2023 17:03:04 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;64dbafc8-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">$ curl -v 10.100.49.21</span><br><span class="line">*   Trying 10.100.49.21:80...</span><br><span class="line">* connect to 10.100.49.21 port 80 failed: Connection refused</span><br><span class="line">* Failed to connect to 10.100.49.21 port 80 after 1001 ms: Connection refused</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (7) Failed to connect to 10.100.49.21 port 80 after 1001 ms: Connection refused</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ k describe po readiness-gate</span><br><span class="line">Name:         readiness-gate</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         mac-k8s/192.168.191.153</span><br><span class="line">Start Time:   Tue, 29 Aug 2022 12:52:01 +0800</span><br><span class="line">Labels:       app=readiness-gate</span><br><span class="line">Annotations:  cni.projectcalico.org/containerID: f7e1476b14d527d84dd05d97d99e95e4321f4e16c67c491a231a828d39742400</span><br><span class="line">              cni.projectcalico.org/podIP: 192.168.185.12/32</span><br><span class="line">              cni.projectcalico.org/podIPs: 192.168.185.12/32</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           192.168.185.12</span><br><span class="line">IPs:</span><br><span class="line">  IP:  192.168.185.12</span><br><span class="line">Containers:</span><br><span class="line">  readiness-gate:</span><br><span class="line">    Container ID:   docker://d715bf00071ee8dd886f64944c798d3abddb847bebca120565d9e1ac79c458bf</span><br><span class="line">    Image:          nginx:1.25.2</span><br><span class="line">    Image ID:       docker-pullable://nginx@sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Tue, 29 Aug 2022 12:52:02 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-wd97x (ro)</span><br><span class="line">Readiness Gates:</span><br><span class="line">  Type                        Status</span><br><span class="line">  www.example.com/feature-1   &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             False</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-wd97x:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  2m12s  default-scheduler  Successfully assigned default/readiness-gate to mac-k8s</span><br><span class="line">  Normal  Pulled     2m12s  kubelet            Container image &quot;nginx:1.25.2&quot; already present on machine</span><br><span class="line">  Normal  Created    2m12s  kubelet            Created container readiness-gate</span><br><span class="line">  Normal  Started    2m11s  kubelet            Started container readiness-gate</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cni.projectcalico.org/containerID:</span> <span class="string">f7e1476b14d527d84dd05d97d99e95e4321f4e16c67c491a231a828d39742400</span></span><br><span class="line">    <span class="attr">cni.projectcalico.org/podIP:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.12</span><span class="string">/32</span></span><br><span class="line">    <span class="attr">cni.projectcalico.org/podIPs:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.12</span><span class="string">/32</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;app&quot;:&quot;readiness-gate&quot;&#125;,&quot;name&quot;:&quot;readiness-gate&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;image&quot;:&quot;nginx:1.25.2&quot;,&quot;name&quot;:&quot;readiness-gate&quot;&#125;],&quot;readinessGates&quot;:[&#123;&quot;conditionType&quot;:&quot;www.example.com/feature-1&quot;&#125;]&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-08-29T04:52:01Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">readiness-gate</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-gate</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;9147&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">7cdf038f-80c5-4c15-9507-f20d41b6c0ea</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">readiness-gate</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-wd97x</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">mac-k8s</span></span><br><span class="line">  <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">readinessGates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">conditionType:</span> <span class="string">www.example.com/feature-1</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-wd97x</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-29T04:52:01Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-29T04:52:01Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">corresponding</span> <span class="string">condition</span> <span class="string">of</span> <span class="string">pod</span> <span class="string">readiness</span> <span class="string">gate</span> <span class="string">&quot;www.example.com/feature-1&quot;</span></span><br><span class="line">      <span class="string">does</span> <span class="string">not</span> <span class="string">exist.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">ReadinessGatesNotReady</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-29T04:52:02Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-29T04:52:01Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://d715bf00071ee8dd886f64944c798d3abddb847bebca120565d9e1ac79c458bf</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">readiness-gate</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-08-29T04:52:02Z&quot;</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">192.168</span><span class="number">.191</span><span class="number">.153</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.12</span></span><br><span class="line">  <span class="attr">podIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.12</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2022-08-29T04:52:01Z&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h1><h2 id="post-start"><a href="#post-start" class="headerlink" title="post-start"></a>post-start</h2><blockquote>
<p>post-start <code>结束之前</code>，不会被标记为 <code>Running</code> 状态</p>
</blockquote>
<blockquote>
<p><code>无法保证</code> post-start 脚本和 Entrypoint 哪个先执行</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230829204750645.png" alt="image-20230829204750645"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">poststart</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">      <span class="attr">lifecycle:</span></span><br><span class="line">        <span class="attr">postStart:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the postStart handler &gt; /usr/share/message&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f poststart.yaml</span><br><span class="line">pod/poststart created</span><br><span class="line"></span><br><span class="line">$ k exec poststart -- cat /usr/share/message</span><br><span class="line">Hello from the postStart handler</span><br></pre></td></tr></table></figure>

<h2 id="pre-stop"><a href="#pre-stop" class="headerlink" title="pre-stop"></a>pre-stop</h2><blockquote>
<p>只有当 Pod <code>被终止</code>时，Kubernetes 才会执行 pre-stop 脚本，而当 Pod 完成或者容器退出时，pre-stop 脚本不会被执行</p>
</blockquote>
<blockquote>
<p>kubelet 会先发送 <code>SIGTERM</code> 信号，然后过一会才会发送 <code>SIGKILL</code> 信号（前提是容器进程还存活）</p>
</blockquote>
<blockquote>
<p><code>pre-stop + SIGTERM = terminationGracePeriodSeconds</code> &#x3D; 40 + 20 &#x3D; 60</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230829205232608.png" alt="image-20230829205232608"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">120</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">readinessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">lifecycle:</span></span><br><span class="line">        <span class="attr">preStop:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;-c&#x27;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/home/xxx/shell/sleep_40s.sh</span></span><br><span class="line">      <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">      <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>bash</code>和<code>sh</code> 会忽略 <code>SIGTERM</code> 信号 - 因此 <code>SIGTERM</code>  会<code>永远超时</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="literal">no</span><span class="string">-sigterm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="literal">no</span><span class="string">-sigterm</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">centos</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo hello; sleep 10;done&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f no-sigterm.yaml</span><br><span class="line">pod/no-sigterm created</span><br><span class="line"></span><br><span class="line">$ k delete po no-sigterm</span><br><span class="line">pod &quot;no-sigterm&quot; deleted</span><br><span class="line"></span><br><span class="line">$ k get po -w</span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">no-sigterm   0/1     Pending   0          0s</span><br><span class="line">no-sigterm   0/1     Pending   0          0s</span><br><span class="line">no-sigterm   0/1     ContainerCreating   0          0s</span><br><span class="line">no-sigterm   0/1     ContainerCreating   0          0s</span><br><span class="line">no-sigterm   1/1     Running             0          3s</span><br><span class="line">no-sigterm   1/1     Terminating         0          10s</span><br><span class="line">no-sigterm   1/1     Terminating         0          70s</span><br><span class="line">no-sigterm   0/1     Terminating         0          71s</span><br><span class="line">no-sigterm   0/1     Terminating         0          71s</span><br><span class="line">no-sigterm   0/1     Terminating         0          71s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>terminationGracePeriodSeconds</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20230829213248234.png" alt="image-20230829213248234"></p>
<blockquote>
<p>最佳实践</p>
</blockquote>
<ol>
<li>如果想<code>快速终止</code> Pod<ul>
<li>可以在 <code>pre-stop</code> 或者 <code>SIGTERM</code> 中<code>主动退出</code>进程</li>
</ul>
</li>
<li>优雅初始化（子进程）<ul>
<li>正确处理系统信号量，<code>将信号量转发给子进程</code></li>
<li>在主进程退出之前，需要<code>等待并确保所有子进程退出</code></li>
<li><code>监控并清理孤儿子进程</code></li>
</ul>
</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/">https://blog.zhongmingmao.top/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/11/go-foundation-design-philosophy/" title="Go - Design Philosophy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Go - Design Philosophy</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/09/cloud-native-foundation-k8s-csi/" title="Kubernetes - CSI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-csi.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Kubernetes - CSI</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/12/09/cloud-native-foundation-k8s-csi/" title="Kubernetes - CSI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-csi.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-09</div><div class="title">Kubernetes - CSI</div></div></a></div><div><a href="/2022/12/08/cloud-native-foundation-k8s-cni-v2/" title="Kubernetes - CNI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/cni-logo-card.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-08</div><div class="title">Kubernetes - CNI</div></div></a></div><div><a href="/2022/12/07/cloud-native-foundation-k8s-cri/" title="Kubernetes - CRI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-trends_k8s_container_runtime_popularity.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-07</div><div class="title">Kubernetes - CRI</div></div></a></div><div><a href="/2022/12/06/cloud-native-foundation-k8s-kubelet/" title="Kubernetes - Kubelet"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-architecture.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-06</div><div class="title">Kubernetes - Kubelet</div></div></a></div><div><a href="/2022/12/05/cloud-native-foundation-k8s-controller-manager/" title="Kubernetes - Controller Manager"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kdpv.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-05</div><div class="title">Kubernetes - Controller Manager</div></div></a></div><div><a href="/2022/12/04/cloud-native-foundation-k8s-scheduler/" title="Kubernetes - Scheduler"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/rebalancing-8_qgh6ro.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-04</div><div class="title">Kubernetes - Scheduler</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">438</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">123</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">64</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.</span> <span class="toc-text">生命周期</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod-%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">2.</span> <span class="toc-text">Pod 状态机</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod-Phase"><span class="toc-number">3.</span> <span class="toc-text">Pod Phase</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod-HA"><span class="toc-number">4.</span> <span class="toc-text">Pod HA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">4.1.</span> <span class="toc-text">存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE"><span class="toc-number">4.2.</span> <span class="toc-text">数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD"><span class="toc-number">4.3.</span> <span class="toc-text">中断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%97%E4%BD%99"><span class="toc-number">4.4.</span> <span class="toc-text">冗余</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod-QoS"><span class="toc-number">5.</span> <span class="toc-text">Pod QoS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Toleration-Eviction"><span class="toc-number">6.</span> <span class="toc-text">Toleration + Eviction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Probe"><span class="toc-number">7.</span> <span class="toc-text">Probe</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook"><span class="toc-number">8.</span> <span class="toc-text">Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#post-start"><span class="toc-number">8.1.</span> <span class="toc-text">post-start</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pre-stop"><span class="toc-number">8.2.</span> <span class="toc-text">pre-stop</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/12/11/go-foundation-design-philosophy/" title="Go - Design Philosophy"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Design Philosophy"/></a><div class="content"><a class="title" href="/2022/12/11/go-foundation-design-philosophy/" title="Go - Design Philosophy">Go - Design Philosophy</a><time datetime="2022-12-10T16:06:25.000Z" title="Created 2022-12-11 00:06:25">2022-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/" title="Kubernetes - Pod Life Cycle"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/pod-life-cycle.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - Pod Life Cycle"/></a><div class="content"><a class="title" href="/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/" title="Kubernetes - Pod Life Cycle">Kubernetes - Pod Life Cycle</a><time datetime="2022-12-09T16:06:25.000Z" title="Created 2022-12-10 00:06:25">2022-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/09/cloud-native-foundation-k8s-csi/" title="Kubernetes - CSI"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-csi.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - CSI"/></a><div class="content"><a class="title" href="/2022/12/09/cloud-native-foundation-k8s-csi/" title="Kubernetes - CSI">Kubernetes - CSI</a><time datetime="2022-12-08T16:06:25.000Z" title="Created 2022-12-09 00:06:25">2022-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/08/cloud-native-foundation-k8s-cni-v2/" title="Kubernetes - CNI"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/cni-logo-card.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - CNI"/></a><div class="content"><a class="title" href="/2022/12/08/cloud-native-foundation-k8s-cni-v2/" title="Kubernetes - CNI">Kubernetes - CNI</a><time datetime="2022-12-07T16:06:25.000Z" title="Created 2022-12-08 00:06:25">2022-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/07/cloud-native-foundation-k8s-cri/" title="Kubernetes - CRI"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-trends_k8s_container_runtime_popularity.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes - CRI"/></a><div class="content"><a class="title" href="/2022/12/07/cloud-native-foundation-k8s-cri/" title="Kubernetes - CRI">Kubernetes - CRI</a><time datetime="2022-12-06T16:06:25.000Z" title="Created 2022-12-07 00:06:25">2022-12-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2023 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
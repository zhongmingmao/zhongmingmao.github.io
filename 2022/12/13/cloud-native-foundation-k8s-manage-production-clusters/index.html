<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Kubernetes - Manage Production Clusters | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="操作系统 通用操作系统 - 成熟   Ubuntu CentOS Fedora">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Manage Production Clusters">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/12/13/cloud-native-foundation-k8s-manage-production-clusters/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="操作系统 通用操作系统 - 成熟   Ubuntu CentOS Fedora">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/2bc58949d451b7e5f8f8759c44d962d01b2ed48d-1108x1108.webp">
<meta property="article:published_time" content="2022-12-12T16:06:25.000Z">
<meta property="article:modified_time" content="2023-10-04T13:54:48.035Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Cloud Native Foundation">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/2bc58949d451b7e5f8f8759c44d962d01b2ed48d-1108x1108.webp"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/12/13/cloud-native-foundation-k8s-manage-production-clusters/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes - Manage Production Clusters',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-04 21:54:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">485</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">125</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">65</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/2bc58949d451b7e5f8f8759c44d962d01b2ed48d-1108x1108.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes - Manage Production Clusters</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-12-12T16:06:25.000Z" title="Created 2022-12-13 00:06:25">2022-12-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">13.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>65min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h1><blockquote>
<p>通用操作系统 - 成熟</p>
</blockquote>
<ol>
<li>Ubuntu</li>
<li>CentOS</li>
<li>Fedora</li>
</ol>
<span id="more"></span>

<blockquote>
<p>专为容器优化的操作系统 - 最小化主机操作系统</p>
</blockquote>
<ol>
<li>CoreOS<ul>
<li>最早的容器化操作系统，已被收购</li>
</ul>
</li>
<li><code>RedHat Atomic</code><ul>
<li>将 <code>RPM Repository</code> 转换成 <code>ostree</code>，可以被 <code>bootloader</code> 直接加载</li>
</ul>
</li>
<li>Snappy Ubuntu Core<ul>
<li>Canonical 出品，最初为<code>移动设备</code>设计</li>
</ul>
</li>
<li>RancherOS<ul>
<li>相对较新，RancherOS 中运行的所有服务都是 <code>Docker</code> 容器</li>
</ul>
</li>
</ol>
<blockquote>
<p>评估选型的标准</p>
</blockquote>
<ol>
<li>是否有生态系统</li>
<li>成熟度</li>
<li>内核版本</li>
<li>对运行时的支持</li>
<li>Init System</li>
<li>包管理和系统升级</li>
<li>安全</li>
</ol>
<blockquote>
<p>不可变基础设施</p>
</blockquote>
<ol>
<li>不可变的<code>容器镜像</code></li>
<li>不可变的<code>主机操作系统</code></li>
</ol>
<blockquote>
<p>Atomic - 打包成一个经过<code>裁剪</code>后的操作系统</p>
</blockquote>
<ol>
<li>由 Red Hat 支持的<code>软件包安装系统</code></li>
<li>多种发行版：Fedora &#x2F; CentOS &#x2F; RHEL</li>
<li>优势<ul>
<li><code>不可变操作系统</code>，面向<code>容器</code>优化的基础设施<ul>
<li>只有 <code>/etc</code> 和 <code>/var</code> 可以修改，其它目录均为<code>只读</code></li>
</ul>
</li>
<li>基于 <code>rpm-ostree</code> 管理系统包<ul>
<li><code>IaC</code>：输入 <code>rpm 源</code>，生成一个 <code>ostree</code>，ostree 可以被 <code>bootloader</code> 加载为一个 <code>OS</code></li>
<li>支持操作系统升级和回滚的<code>原子</code>操作</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>最小化主机操作系统</p>
</blockquote>
<ol>
<li>只安装<code>必要</code>（支持系统运行的最小工具集）的工具<ul>
<li>任何<code>调试工具</code>（性能排查、网络排查工具），均可以后期以<code>容器</code>形式运行</li>
</ul>
</li>
<li>优势：<code>性能</code> &#x2F; <code>稳定性</code> &#x2F; <code>安全保障</code></li>
</ol>
<blockquote>
<p>操作系统的构建流程</p>
</blockquote>
<blockquote>
<p>rpm-ostree 构建最小化主机系统，buildah 构建调试工具（K8S Node 按需拉取）</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/build-os.png" alt="build-os"></p>
<blockquote>
<p>提供将 <code>ostree</code> 部署进 <code>bootloader</code> 的机制<br><a target="_blank" rel="noopener" href="https://github.com/ostreedev/ostree/blob/main/src/boot/dracut/module-setup.sh">https://github.com/ostreedev/ostree/blob/main/src/boot/dracut/module-setup.sh</a></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">install</span></span>() &#123;</span><br><span class="line">    dracut_install /usr/lib/ostree/ostree-prepare-root</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> /usr/lib /etc; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">test</span> -f <span class="string">&quot;<span class="variable">$r</span>/ostree/prepare-root.conf&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            inst_simple <span class="string">&quot;<span class="variable">$r</span>/ostree/prepare-root.conf&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> -f <span class="string">&quot;/etc/ostree/initramfs-root-binding.key&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        inst_simple <span class="string">&quot;/etc/ostree/initramfs-root-binding.key&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    inst_simple <span class="string">&quot;<span class="variable">$&#123;systemdsystemunitdir&#125;</span>/ostree-prepare-root.service&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;initdir&#125;</span><span class="variable">$&#123;systemdsystemconfdir&#125;</span>/initrd-root-fs.target.wants&quot;</span></span><br><span class="line">    ln_r <span class="string">&quot;<span class="variable">$&#123;systemdsystemunitdir&#125;</span>/ostree-prepare-root.service&quot;</span> \</span><br><span class="line">        <span class="string">&quot;<span class="variable">$&#123;systemdsystemconfdir&#125;</span>/initrd-root-fs.target.wants/ostree-prepare-root.service&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据 <code>treefile</code> 构建 <code>ostree</code> - 类似于 docker 根据 Dockerfile 构建 image	</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231002141928497.png" alt="image-20231002141928497"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rpm-ostree compose tree --unified-core --cachedir=cache --repo=./build-repo/path/to/treefile.json</span><br></pre></td></tr></table></figure>

<blockquote>
<p>bootloader 加载 ostree</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231002142557498.png" alt="image-20231002142557498"></p>
<ol>
<li>初始化项目<ul>
<li>ostree admin os-init centos-atomic-host</li>
</ul>
</li>
<li>导入 ostree repo - 见上图<ul>
<li>ostree remote add atomic <a target="_blank" rel="noopener" href="http://ostree.svr/ostree">http://ostree.svr/ostree</a></li>
</ul>
</li>
<li>拉取 ostree<ul>
<li>ostree pull atomic centos-atomic-host&#x2F;8&#x2F;x86_64&#x2F;standard</li>
</ul>
</li>
<li>部署 OS<ul>
<li>ostree admin deploy –os&#x3D;centos-atomic-host centos-atomic-host&#x2F;8&#x2F;x86_64&#x2F;standard –karg&#x3D;’root&#x3D;&#x2F;dev&#x2F;atomicos&#x2F;root’</li>
</ul>
</li>
</ol>
<blockquote>
<p>操作系统加载</p>
</blockquote>
<ol>
<li>物理机<ul>
<li>物理机通常需要通过 <code>foreman</code> 启动，foreman 通过 <code>pxe boot</code> 并加载 <code>kickstart</code></li>
<li><code>kickstart</code> 通过 <code>ostree deploy</code> 即可完成操作系统的部署</li>
</ul>
</li>
<li>虚拟机<ul>
<li>需要通过镜像工具将 ostree 构建成对应格式</li>
</ul>
</li>
</ol>
<h1 id="节点资源"><a href="#节点资源" class="headerlink" title="节点资源"></a>节点资源</h1><h2 id="NUMA"><a href="#NUMA" class="headerlink" title="NUMA"></a>NUMA</h2><blockquote>
<p><code>Non-Uniform Memory Access</code> 是一种内存访问方式，是为多处理器计算机设计的内存架构</p>
</blockquote>
<blockquote>
<p><code>FSB</code> - Front Side Bus; <code>QPI</code> - QuickPath Interconnect</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231002151509749.png" alt="image-20231002151509749"></p>
<h2 id="状态上报"><a href="#状态上报" class="headerlink" title="状态上报"></a>状态上报</h2><blockquote>
<p>kubelet 周期性地向 <code>API Server</code> 进行汇报，并更新 <code>Node</code> 的<code>健康</code>和<code>资源</code>使用信息</p>
</blockquote>
<ol>
<li>Node 基础信息<ul>
<li>IP 地址、操作系统、内核、CRI、kubelet、kube-proxy 版本信息</li>
</ul>
</li>
<li>Node 资源信息<ul>
<li>CPU、内存、HugePage、临时存储、GPU 等，以及这些资源中可以分配给容器使用的部分</li>
</ul>
</li>
<li><code>kube-scheduler</code> 在为 Pod 选择 Node 时会将 Node 的状态信息作为依据</li>
</ol>
<table>
<thead>
<tr>
<th>Status</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>Ready</code></td>
<td>Node 是否健康</td>
</tr>
<tr>
<td><code>MemoryPressure</code></td>
<td>Node 是否存在内存压力</td>
</tr>
<tr>
<td><code>PIDPressure</code></td>
<td>Node 是否存在比较多的进程</td>
</tr>
<tr>
<td><code>DiskPressure</code></td>
<td>Node 是否存在磁盘压力</td>
</tr>
<tr>
<td><code>NetworkUnavailable</code></td>
<td>Node 网络配置是否正确</td>
</tr>
</tbody></table>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">csi.volume.kubernetes.io/nodeid:</span> <span class="string">&#x27;&#123;&quot;csi.tigera.io&quot;:&quot;mac-k8s&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">kubeadm.alpha.kubernetes.io/cri-socket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">    <span class="attr">node.alpha.kubernetes.io/ttl:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">projectcalico.org/IPv4Address:</span> <span class="number">192.168</span><span class="number">.191</span><span class="number">.153</span><span class="string">/24</span></span><br><span class="line">    <span class="attr">projectcalico.org/IPv4VXLANTunnelAddr:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">volumes.kubernetes.io/controller-managed-attach-detach:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-08-28T06:45:49Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">arm64</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">kubernetes.io/arch:</span> <span class="string">arm64</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/control-plane:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/master:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node.kubernetes.io/exclude-from-external-load-balancers:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mac-k8s</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;6775&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">b5720267-7927-4b62-8184-d3371f7c76ff</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podCIDR:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="attr">podCIDRs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.191</span><span class="number">.153</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InternalIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Hostname</span></span><br><span class="line">  <span class="attr">allocatable:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">&quot;28819139742&quot;</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12134168Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">31270768Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12236568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-08-29T00:53:17Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-29T00:53:17Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Calico</span> <span class="string">is</span> <span class="string">running</span> <span class="string">on</span> <span class="string">this</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">CalicoIsUp</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">NetworkUnavailable</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-08-29T00:51:36Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:45:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="string">sufficient</span> <span class="string">memory</span> <span class="string">available</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasSufficientMemory</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">MemoryPressure</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-08-29T00:51:36Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:45:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="literal">no</span> <span class="string">disk</span> <span class="string">pressure</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasNoDiskPressure</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DiskPressure</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-08-29T00:51:36Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:45:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="string">sufficient</span> <span class="string">PID</span> <span class="string">available</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasSufficientPID</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PIDPressure</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-08-29T00:51:36Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:49:06Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">is</span> <span class="string">posting</span> <span class="string">ready</span> <span class="string">status.</span> <span class="string">AppArmor</span> <span class="string">enabled</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletReady</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="attr">daemonEndpoints:</span></span><br><span class="line">    <span class="attr">kubeletEndpoint:</span></span><br><span class="line">      <span class="attr">Port:</span> <span class="number">10250</span></span><br><span class="line">  <span class="attr">images:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">centos@sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">centos:latest</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">271506418</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node@sha256:8e34517775f319917a0be516ed3a373dbfca650d1ee8e72158087c24356f47fb</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">257943189</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/cni@sha256:3be3c67ddba17004c292eafec98cc49368ac273b40b27c8a6621be4471d348d6</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/cni:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">199481277</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx@sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">192063326</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver@sha256:b8eba88862bab7d3d7cdddad669ff1ece006baa10d3a3df119683434497a0949</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">132450723</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/etcd@sha256:64b9ea357325d5db9f8a723dcf503b5a449177b17ac87d69481e126bb724c263</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/etcd:3.5.1-0</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">132115484</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-controller-manager@sha256:b721871d9a9c55836cbcbb2bf375e02696260628f73620b267be9a9a50c97f5a</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">122423990</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-proxy@sha256:def87f007b49d50693aed83d4703d0e56c69ae286154b1c7a20cd1b3a320cf7c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-proxy:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">109183127</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/apiserver@sha256:8040d37d7038ec4a24b5d670526c7a1da432f825e6aad1cb4ea1fc24cb13fc1e</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/apiserver:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">87865689</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/kube-controllers@sha256:01ce29ea8f2b34b6cef904f526baed98db4c0581102f194e36f2cd97943f77aa</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/kube-controllers:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">68842373</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">quay.io/tigera/operator@sha256:780eeab342e62bd200e533a960b548216b23b8bde7a672c4527f29eec9ce2d79</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">quay.io/tigera/operator:v1.30.4</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">64946658</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/typha@sha256:54ec33e1e6a6f2a7694b29e7101934ba75752e0c4543ee988a4015ce0caa7b99</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/typha:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">61869924</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-scheduler@sha256:32308abe86f7415611ca86ee79dd0a73e74ebecb2f9e3eb85fc3a8e62f03d0e7</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">52955871</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/coredns@sha256:5b6ec0d6de9baaf3e92d0f66cd96a25b9edbce8716f5f15dcd1a616b3abd590e</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/coredns:v1.8.6</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">46808803</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node-driver-registrar@sha256:fb4dc4863c20b7fe1e9dd5e52dcf004b74e1af07d783860a08ddc5c50560f753</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node-driver-registrar:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">23206723</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/csi@sha256:4e05036f8ad1c884ab52cae0f1874839c27c407beaa8f008d7a28d113ad9e5ed</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/csi:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">18731350</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/pod2daemon-flexvol@sha256:2aefd77a4f8289c88cfe24c0db38822de3132292d1ea4ac9192abc9583e4b54c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/pod2daemon-flexvol:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">10707389</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/pause@sha256:3d380ca8864549e74af4b29c10f9cb0956236dfb01c40ca076fb6c37253234db</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/pause:3.6</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">483864</span></span><br><span class="line">  <span class="attr">nodeInfo:</span></span><br><span class="line">    <span class="attr">architecture:</span> <span class="string">arm64</span></span><br><span class="line">    <span class="attr">bootID:</span> <span class="string">99afea12-0e3a-44a8-b226-085479b8ab7f</span></span><br><span class="line">    <span class="attr">containerRuntimeVersion:</span> <span class="string">docker://20.10.24</span></span><br><span class="line">    <span class="attr">kernelVersion:</span> <span class="number">5.4</span><span class="number">.0</span><span class="number">-156</span><span class="string">-generic</span></span><br><span class="line">    <span class="attr">kubeProxyVersion:</span> <span class="string">v1.23.3</span></span><br><span class="line">    <span class="attr">kubeletVersion:</span> <span class="string">v1.23.3</span></span><br><span class="line">    <span class="attr">machineID:</span> <span class="string">3bbd7f943eb34ff39f80a87bfa2037de</span></span><br><span class="line">    <span class="attr">operatingSystem:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">osImage:</span> <span class="string">Ubuntu</span> <span class="number">20.04</span><span class="number">.5</span> <span class="string">LTS</span></span><br><span class="line">    <span class="attr">systemUUID:</span> <span class="string">598a4d56-54c5-9aff-c38f-732f7662da29</span></span><br></pre></td></tr></table></figure>

<h3 id="Lease-心跳"><a href="#Lease-心跳" class="headerlink" title="Lease - 心跳"></a>Lease - 心跳</h3><blockquote>
<p><code>分离</code>健康信息和资源信息，两者<code>变更频率</code>不一样，降低 <code>API Server</code> 和 <code>etcd</code> 的访问压力</p>
</blockquote>
<blockquote>
<p>Lease 主要用于 <code>Leader Election</code></p>
</blockquote>
<ol>
<li>早期的 kubelet 的状态上报会包含<code>健康信息</code>和<code>资源信息</code><ul>
<li>直接更新 Node 对象，<code>传输的数据包较大</code>，给 API Server 和 etcd 造成压力</li>
</ul>
</li>
<li>后来引入 <code>Lease</code> 对象来保存<code>健康信息</code><ul>
<li>在 <code>leaseDurationSeconds</code> （40 秒）周期内，如果 Lease 对象没有被更新，则对应的 Node 会被判定为<code>不健康</code></li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k get leases.coordination.k8s.io -A</span><br><span class="line">NAMESPACE         NAME                      HOLDER                                         AGE</span><br><span class="line">kube-node-lease   mac-k8s                   mac-k8s                                        35d</span><br><span class="line">kube-system       kube-controller-manager   mac-k8s_99a2c279-255d-4852-9726-df6765860ee3   35d</span><br><span class="line">kube-system       kube-scheduler            mac-k8s_f0363af9-296c-413a-9f8f-a109c7514424   35d</span><br><span class="line">tigera-operator   operator-lock             mac-k8s_70e03794-d7bb-4aef-8a09-da07a5e233be   35d</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">coordination.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Lease</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-08-28T06:45:52Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mac-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-node-lease</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">b5720267-7927-4b62-8184-d3371f7c76ff</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;8703&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">4b7e1699-c3bb-4a91-a549-d53cb08720aa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">holderIdentity:</span> <span class="string">mac-k8s</span></span><br><span class="line">  <span class="attr">leaseDurationSeconds:</span> <span class="number">40</span></span><br><span class="line">  <span class="attr">renewTime:</span> <span class="string">&quot;2022-10-02T07:53:01.455032Z&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="资源预留"><a href="#资源预留" class="headerlink" title="资源预留"></a>资源预留</h2><ol>
<li>Node 除了用户容器外，还存在很多支撑系统运行的基础服务（未被容器化），需要为这些基础服务预留资源<ul>
<li>如 systemd、journald、sshd、dockerd、containerd、kubelet 等</li>
</ul>
</li>
<li>kubelet 可以通过启动参数为系统预留 <code>CPU</code>、<code>内存</code>、<code>PID</code> 等资源，如 <code>SystemdReserved</code> &#x2F; <code>KubeReserved</code> 等</li>
</ol>
<h3 id="Capacity-x2F-Allocatable"><a href="#Capacity-x2F-Allocatable" class="headerlink" title="Capacity &#x2F; Allocatable"></a>Capacity &#x2F; Allocatable</h3><blockquote>
<p>capacity &#x3D; kube-reserved + systemd-reserved + <code>eviction-threshold</code> + allocatable</p>
</blockquote>
<ol>
<li>Capacity - <code>kubelet</code> 获取的 Node 当前的资源信息</li>
<li>Allocatable - Pod 可用的资源</li>
</ol>
<blockquote>
<p>The proc filesystem is a <code>pseudo-filesystem</code> which provides an interface to <code>kernel data structures</code>.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Capacity</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>cpu</code></td>
<td>从 <code>/proc/cpuinfo</code> 文件中获取的 Node CPU 核数</td>
</tr>
<tr>
<td><code>memory</code></td>
<td>从 <code>/proc/meminfo</code> 文件中获取的 Node 内存大小</td>
</tr>
<tr>
<td><code>ephemeral-storage</code></td>
<td>Node <code>根分区</code>的大小</td>
</tr>
</tbody></table>
<blockquote>
<p>cpu - 4</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/cpuinfo</span><br><span class="line">processor    : 0</span><br><span class="line">BogoMIPS    : 48.00</span><br><span class="line">Features    : fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma lrcpc dcpop sha3 asimddp sha512 asimdfhm dit uscat ilrcpc flagm ssbs sb paca pacg dcpodp flagm2 frint</span><br><span class="line">CPU implementer    : 0x61</span><br><span class="line">CPU architecture: 8</span><br><span class="line">CPU variant    : 0x0</span><br><span class="line">CPU part    : 0x000</span><br><span class="line">CPU revision    : 0</span><br><span class="line"></span><br><span class="line">processor    : 1</span><br><span class="line">BogoMIPS    : 48.00</span><br><span class="line">Features    : fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma lrcpc dcpop sha3 asimddp sha512 asimdfhm dit uscat ilrcpc flagm ssbs sb paca pacg dcpodp flagm2 frint</span><br><span class="line">CPU implementer    : 0x61</span><br><span class="line">CPU architecture: 8</span><br><span class="line">CPU variant    : 0x0</span><br><span class="line">CPU part    : 0x000</span><br><span class="line">CPU revision    : 0</span><br><span class="line"></span><br><span class="line">processor    : 2</span><br><span class="line">BogoMIPS    : 48.00</span><br><span class="line">Features    : fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma lrcpc dcpop sha3 asimddp sha512 asimdfhm dit uscat ilrcpc flagm ssbs sb paca pacg dcpodp flagm2 frint</span><br><span class="line">CPU implementer    : 0x61</span><br><span class="line">CPU architecture: 8</span><br><span class="line">CPU variant    : 0x0</span><br><span class="line">CPU part    : 0x000</span><br><span class="line">CPU revision    : 0</span><br><span class="line"></span><br><span class="line">processor    : 3</span><br><span class="line">BogoMIPS    : 48.00</span><br><span class="line">Features    : fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma lrcpc dcpop sha3 asimddp sha512 asimdfhm dit uscat ilrcpc flagm ssbs sb paca pacg dcpodp flagm2 frint</span><br><span class="line">CPU implementer    : 0x61</span><br><span class="line">CPU architecture: 8</span><br><span class="line">CPU variant    : 0x0</span><br><span class="line">CPU part    : 0x000</span><br><span class="line">CPU revision    : 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>memory - 12236568 KB</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/meminfo</span><br><span class="line">MemTotal:       12236568 kB</span><br><span class="line">MemFree:         6943060 kB</span><br><span class="line">MemAvailable:   10735672 kB</span><br><span class="line">Buffers:          120596 kB</span><br><span class="line">Cached:          3660396 kB</span><br><span class="line">SwapCached:            0 kB</span><br><span class="line">Active:          2161224 kB</span><br><span class="line">Inactive:        2646200 kB</span><br><span class="line">Active(anon):    1024828 kB</span><br><span class="line">Inactive(anon):     1396 kB</span><br><span class="line">Active(file):    1136396 kB</span><br><span class="line">Inactive(file):  2644804 kB</span><br><span class="line">Unevictable:       16860 kB</span><br><span class="line">Mlocked:           16860 kB</span><br><span class="line">SwapTotal:             0 kB</span><br><span class="line">SwapFree:              0 kB</span><br><span class="line">Dirty:               308 kB</span><br><span class="line">Writeback:             0 kB</span><br><span class="line">AnonPages:       1021448 kB</span><br><span class="line">Mapped:           714368 kB</span><br><span class="line">Shmem:              4096 kB</span><br><span class="line">KReclaimable:     234800 kB</span><br><span class="line">Slab:             395716 kB</span><br><span class="line">SReclaimable:     234800 kB</span><br><span class="line">SUnreclaim:       160916 kB</span><br><span class="line">KernelStack:       15360 kB</span><br><span class="line">PageTables:        12640 kB</span><br><span class="line">NFS_Unstable:          0 kB</span><br><span class="line">Bounce:                0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line">CommitLimit:     6118284 kB</span><br><span class="line">Committed_AS:    4699004 kB</span><br><span class="line">VmallocTotal:   135290159040 kB</span><br><span class="line">VmallocUsed:       27128 kB</span><br><span class="line">VmallocChunk:          0 kB</span><br><span class="line">Percpu:             4880 kB</span><br><span class="line">HardwareCorrupted:     0 kB</span><br><span class="line">AnonHugePages:     30720 kB</span><br><span class="line">ShmemHugePages:        0 kB</span><br><span class="line">ShmemPmdMapped:        0 kB</span><br><span class="line">FileHugePages:         0 kB</span><br><span class="line">FilePmdMapped:         0 kB</span><br><span class="line">CmaTotal:          32768 kB</span><br><span class="line">CmaFree:           29552 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">Hugetlb:               0 kB</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ephemeral-storage - 31270768 KB</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ df</span><br><span class="line">Filesystem                        1K-blocks     Used Available Use% Mounted on</span><br><span class="line">udev                                6056668        0   6056668   0% /dev</span><br><span class="line">tmpfs                               1223660     3928   1219732   1% /run</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv  31270768 10061512  19595228  34% /</span><br><span class="line">tmpfs                               6118284        0   6118284   0% /dev/shm</span><br><span class="line">tmpfs                                  5120        0      5120   0% /run/lock</span><br><span class="line">tmpfs                               6118284        0   6118284   0% /sys/fs/cgroup</span><br><span class="line">/dev/nvme0n1p2                      1992552   109200   1762112   6% /boot</span><br><span class="line">/dev/nvme0n1p1                      1098632     6452   1092180   1% /boot/efi</span><br><span class="line">/dev/loop0                            59264    59264         0 100% /snap/core20/1614</span><br><span class="line">/dev/loop1                            62592    62592         0 100% /snap/lxd/22761</span><br><span class="line">/dev/loop3                            94208    94208         0 100% /snap/lxd/24065</span><br><span class="line">/dev/loop2                            41728    41728         0 100% /snap/snapd/16299</span><br><span class="line">tmpfs                               1223656        0   1223656   0% /run/user/1000</span><br><span class="line">/dev/loop4                            60800    60800         0 100% /snap/core20/2019</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Kubernetes 认为 CPU 是<code>可压缩</code>资源，<code>无需预留</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">allocatable:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">&quot;28819139742&quot;</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12134168Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">31270768Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12236568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="磁盘管理"><a href="#磁盘管理" class="headerlink" title="磁盘管理"></a>磁盘管理</h2><table>
<thead>
<tr>
<th>Type</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>nodefs</code><br />系统分区（Pod DataDir）</td>
<td><code>工作目录</code> + <code>容器日志</code></td>
</tr>
<tr>
<td><code>imagefs</code><br />容器运行时分区（可选，取决于 CRI 实现，可以合并到 nodefs ）</td>
<td><code>镜像只读层</code> + <code>容器可写层</code></td>
</tr>
</tbody></table>
<blockquote>
<p>nodefs - Pod DataDir - <code>/var/lib/kubelet/pods</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">$ k get po -owide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   1/1     Running   0          4m44s   192.168.185.13   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ docker ps -a | grep nginx</span><br><span class="line">9b4c6b0c1f95   ab73c7fd6723                                        &quot;/docker-entrypoint.…&quot;   5 minutes ago   Up 5 minutes                         k8s_nginx_nginx_default_1fb6d802-64a8-41a4-b1a2-83f12578a097_0</span><br><span class="line">e2b0bace9857   registry.aliyuncs.com/google_containers/pause:3.6   &quot;/pause&quot;                 5 minutes ago   Up 5 minutes                         k8s_POD_nginx_default_1fb6d802-64a8-41a4-b1a2-83f12578a097_0</span><br><span class="line"></span><br><span class="line">$ docker inspect 9b4c6b0c1f95</span><br><span class="line">...</span><br><span class="line">        &quot;HostsPath&quot;: &quot;/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097/etc-hosts&quot;,</span><br><span class="line">...</span><br><span class="line">        &quot;HostConfig&quot;: &#123;</span><br><span class="line">            &quot;Binds&quot;: [</span><br><span class="line">                &quot;/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097/volumes/kubernetes.io~projected/kube-api-access-htqj4:/var/run/secrets/kubernetes.io/serviceaccount:ro&quot;,</span><br><span class="line">                &quot;/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097/etc-hosts:/etc/hosts&quot;,</span><br><span class="line">                &quot;/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097/containers/nginx/807edcc4:/dev/termination-log&quot;</span><br><span class="line">            ],</span><br><span class="line">...</span><br><span class="line">        &quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097/volumes/kubernetes.io~projected/kube-api-access-htqj4&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;/var/run/secrets/kubernetes.io/serviceaccount&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;ro&quot;,</span><br><span class="line">                &quot;RW&quot;: false,</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097/etc-hosts&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;/etc/hosts&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097/containers/nginx/807edcc4&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;/dev/termination-log&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],         </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ tree /var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097</span><br><span class="line">/var/lib/kubelet/pods/1fb6d802-64a8-41a4-b1a2-83f12578a097</span><br><span class="line">├── containers</span><br><span class="line">│   └── nginx</span><br><span class="line">│       └── 807edcc4</span><br><span class="line">├── etc-hosts</span><br><span class="line">├── plugins</span><br><span class="line">│   └── kubernetes.io~empty-dir</span><br><span class="line">│       └── wrapped_kube-api-access-htqj4</span><br><span class="line">│           └── ready</span><br><span class="line">└── volumes</span><br><span class="line">    └── kubernetes.io~projected</span><br><span class="line">        └── kube-api-access-htqj4</span><br><span class="line">            ├── ca.crt -&gt; ..data/ca.crt</span><br><span class="line">            ├── namespace -&gt; ..data/namespace</span><br><span class="line">            └── token -&gt; ..data/token</span><br></pre></td></tr></table></figure>

<blockquote>
<p>imagefs(CRI) - <code>/var/lib/docker/overlay2</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect nginx:1.25.2</span><br><span class="line">...</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/2b3338c595a735d306d5a3d6ef526b785d61242d6e6601e4ba1eb91fea212ae4/diff:/var/lib/docker/overlay2/6f583281737256bda0ab291b2e16243458e09d76c234b6044fac442cf37e949c/diff:/var/lib/docker/overlay2/0bab1cfc61d232958d69e9eb5623421d5869b8085060c4f9d33e32323c8d1c96/diff:/var/lib/docker/overlay2/ceb0576a280c2350f4359bba9687991e7a1e6afc8fe3b212269e2591e1e213f5/diff:/var/lib/docker/overlay2/b1dfbb1cbfda3b344da3a15c74522e46465a0e67b7220cea4a4d1aa1cd5144c2/diff:/var/lib/docker/overlay2/af1748caeab3243da786f13878790cd3a0a10f25e97898adb7af19de55dde62b/diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8/merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8/diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8/work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ sudo ls /var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8</span><br><span class="line">committed  diff  link  lower  work</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>容器可写层</code>依然是基于 <code>Overlay2</code>，性能较差</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ k get po</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          13m</span><br><span class="line"></span><br><span class="line">$ k exec -it nginx -- sh</span><br><span class="line"># pwd</span><br><span class="line">/</span><br><span class="line">#</span><br><span class="line"># touch a.txt</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">$ docker ps -a | grep nginx</span><br><span class="line">9b4c6b0c1f95   ab73c7fd6723                                        &quot;/docker-entrypoint.…&quot;   16 minutes ago   Up 16 minutes                         k8s_nginx_nginx_default_1fb6d802-64a8-41a4-b1a2-83f12578a097_0</span><br><span class="line">e2b0bace9857   registry.aliyuncs.com/google_containers/pause:3.6   &quot;/pause&quot;                 16 minutes ago   Up 16 minutes                         k8s_POD_nginx_default_1fb6d802-64a8-41a4-b1a2-83f12578a097_0</span><br><span class="line"></span><br><span class="line">$ docker inspect 9b4c6b0c1f95</span><br><span class="line">...</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065-init/diff:/var/lib/docker/overlay2/53b48d720d0899c1da2ab07d970b2a633b04cba0f56cfbfc9ba71d4427b57da8/diff:/var/lib/docker/overlay2/2b3338c595a735d306d5a3d6ef526b785d61242d6e6601e4ba1eb91fea212ae4/diff:/var/lib/docker/overlay2/6f583281737256bda0ab291b2e16243458e09d76c234b6044fac442cf37e949c/diff:/var/lib/docker/overlay2/0bab1cfc61d232958d69e9eb5623421d5869b8085060c4f9d33e32323c8d1c96/diff:/var/lib/docker/overlay2/ceb0576a280c2350f4359bba9687991e7a1e6afc8fe3b212269e2591e1e213f5/diff:/var/lib/docker/overlay2/b1dfbb1cbfda3b344da3a15c74522e46465a0e67b7220cea4a4d1aa1cd5144c2/diff:/var/lib/docker/overlay2/af1748caeab3243da786f13878790cd3a0a10f25e97898adb7af19de55dde62b/diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065/merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065/diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065/work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ find /var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065 -name &#x27;a.txt&#x27;</span><br><span class="line">/var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065/diff/a.txt</span><br><span class="line">/var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065/merged/a.txt</span><br><span class="line"></span><br><span class="line">$ tree /var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065-init</span><br><span class="line">/var/lib/docker/overlay2/00cbfdd33b861e0d380de1ec5533ec5990cf93144fd7dd53f27b1160d93d8065-init</span><br><span class="line">├── committed</span><br><span class="line">├── diff</span><br><span class="line">│   ├── dev</span><br><span class="line">│   │   ├── console</span><br><span class="line">│   │   ├── pts</span><br><span class="line">│   │   └── shm</span><br><span class="line">│   └── etc</span><br><span class="line">│       ├── hostname</span><br><span class="line">│       ├── hosts</span><br><span class="line">│       ├── mtab -&gt; /proc/mounts</span><br><span class="line">│       └── resolv.conf</span><br><span class="line">├── link</span><br><span class="line">├── lower</span><br><span class="line">└── work</span><br><span class="line">    └── work</span><br></pre></td></tr></table></figure>

<h2 id="驱逐管理"><a href="#驱逐管理" class="headerlink" title="驱逐管理"></a>驱逐管理</h2><ol>
<li>kubelet 会在<code>系统资源不够</code>时终止一些容器进程，来空出一些系统资源，保证 Node 的稳定性</li>
<li>由 <code>kubelet</code> 发起的驱逐<code>只停止 Pod 的所有容器进程</code>，并<code>不会删除 Pod</code> – 保留部分<code>现场</code>信息，<code>不占用系统资源</code></li>
</ol>
<table>
<thead>
<tr>
<th>Pod Status</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>phase</td>
<td><code>Failed</code></td>
</tr>
<tr>
<td>reason</td>
<td><code>Evicted</code></td>
</tr>
<tr>
<td>message</td>
<td>Evicted Reason</td>
</tr>
</tbody></table>
<h2 id="资源监控"><a href="#资源监控" class="headerlink" title="资源监控"></a>资源监控</h2><blockquote>
<p>新版本的 <code>kubelet</code> 将不再依赖 <code>cAdvisor</code></p>
</blockquote>
<ol>
<li>kubelet 依赖内嵌的开源软件 <code>cAdvisor</code>，周期性地检查资源使用情况<ul>
<li>Analyzes <code>resource usage</code> and <code>performance characteristics</code> of <code>running containers</code>.</li>
<li>Metrics from <code>cgroups</code></li>
</ul>
</li>
<li><code>CPU</code>  为<code>可压缩资源</code>，根据不同进程分配时间配额和权重，CPU 可被多个进程竞相使用<ul>
<li>因此，Pod 不会因为使用过多的 CPU 而被 kubelet 驱逐</li>
</ul>
</li>
<li><code>驱逐策略</code>是基于<code>不可压缩资源</code>进行的，即<code>内存</code>和<code>磁盘</code></li>
</ol>
<blockquote>
<p>Node 如果没有运行时分区，不会有相应的资源监控</p>
</blockquote>
<table>
<thead>
<tr>
<th>Metrics</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>memory.available</td>
<td>Node 当前的可用内存</td>
</tr>
<tr>
<td>nodefs.available</td>
<td>Node <code>根分区</code>的可使用磁盘大小</td>
</tr>
<tr>
<td>nodefs.inodesFree</td>
<td>Node <code>根分区</code>的可使用 inode</td>
</tr>
<tr>
<td>imagefs.available</td>
<td>Node <code>运行时（CRI）分区</code>的可使用磁盘大小</td>
</tr>
<tr>
<td>imagefs.inodesFree</td>
<td>Node <code>运行时（CRI）分区</code>的可使用 inode</td>
</tr>
</tbody></table>
<h2 id="驱逐策略"><a href="#驱逐策略" class="headerlink" title="驱逐策略"></a>驱逐策略</h2><ol>
<li>kubelet 获得 Node 的<code>可用资源信息</code>后，会结合 Node 的 <code>Capacity</code> 来判断当前 Node 运行的 Pod 是否满足驱逐条件</li>
<li>当监控资源的<code>可用额</code>少于设定的<code>绝对值</code>或者<code>百分比</code>，kubelet 会发起<code>驱逐</code>操作</li>
<li>kubelet 可以设置  <code>evictionMinimumReclaim</code> 来限制<code>每次回收资源的最小值</code>，以防止小资源的多次回收</li>
</ol>
<blockquote>
<p>evictionSoft - 优雅终止</p>
</blockquote>
<table>
<thead>
<tr>
<th>kubelet 参数</th>
<th>分类</th>
<th>驱逐方式</th>
</tr>
</thead>
<tbody><tr>
<td>evictionSoft</td>
<td>软驱逐</td>
<td>当检测到当前资源达到软驱逐的阈值时，不会立马驱逐，而是等待一个<code>宽限期</code><br /> <code>min(EvictionSoftGracePeriod, Pod.TerminationGracePeriodSeconds)</code></td>
</tr>
<tr>
<td>evictionHard</td>
<td>硬驱逐</td>
<td>一旦检测到满足硬驱逐的条件，<code>直接终止</code>容器进程来释放资源</td>
</tr>
</tbody></table>
<blockquote>
<p><code>严重性：磁盘承压 &gt; 内存承压</code></p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>内存承压</th>
<th>磁盘承压</th>
</tr>
</thead>
<tbody><tr>
<td>不会调度</td>
<td><code>BestEffort</code> Pod</td>
<td><code>任何</code> Pod</td>
</tr>
<tr>
<td>不会驱逐</td>
<td><code>Guaranteed</code> Pod</td>
<td>-</td>
</tr>
</tbody></table>
<h3 id="内存承压"><a href="#内存承压" class="headerlink" title="内存承压"></a>内存承压</h3><blockquote>
<p>内存承压时，不会调度 <code>BestEffort</code> Pod，不会驱逐 <code>Guaranteed</code> Pod</p>
</blockquote>
<ol>
<li>kubelet 默认设置了 <code>memory.available &lt; 100Mi</code> 的<code>硬驱逐</code>条件</li>
<li>当 kubelet 检测到当前 Node 的可用内存资源紧张并满足驱逐条件时<ul>
<li><code>kubelet</code> 会将 Node 的 <code>MemoryPressure</code> 设置为 <code>True</code></li>
<li><code>kube-scheduler</code> 会阻止 <code>BestEffort Pod</code> 调度到内存承压的 Node<ul>
<li>因为 BestEffort Pod 是会被<code>首先驱逐</code>的，所以调度到内存承压的 Node 意义不大</li>
</ul>
</li>
</ul>
</li>
<li>kubelet 启动对内存承压的驱逐时，会按下列<code>顺序</code>选取目标 Pod（<code>PriorityClass -&gt; Diff</code>）<ul>
<li>判断 Pod 的<code>所有容器的内存使用量总和</code>是否<code>超出请求的内存量</code>，超出请求资源的 Pod 将成为<code>备选 Pod</code><ul>
<li>只能是 <code>BestEffort</code> or <code>Burstable</code></li>
<li>而 <code>Guaranteed</code> 的 Used 不可能大于 Request &#x3D; Limit，因此 <code>不会被驱逐</code></li>
</ul>
</li>
<li>查询 Pod 的<code>调度优先级</code>，优先驱逐低优 Pod</li>
<li>计算 Pod 所有容器的内存使用量和 Pod 请求的内存量的差值（<code>Used-Request</code>），<code>差值越大，越容易被驱逐</code></li>
</ul>
</li>
</ol>
<h3 id="磁盘承压"><a href="#磁盘承压" class="headerlink" title="磁盘承压"></a>磁盘承压</h3><blockquote>
<p>磁盘承压时，不会调度<code>任何</code> Pod，可能会驱逐<code>任何</code> Pod（驱逐前会先尝试<code>清理磁盘空间</code>）</p>
</blockquote>
<ol>
<li>kubelet 将 Node 的 <code>DiskPressure</code> 设置为 True，kube-scheduler 不会再调度<code>任何 Pod</code> 到该 Node 上<ul>
<li>任何一项满足驱逐条件即可 - nodefs.available &#x2F; nodefs.inodesFree &#x2F; imagefs.available &#x2F; imagefs.inodesFree</li>
</ul>
</li>
<li>驱逐行为<ul>
<li>有<code>容器运行时（CRI）分区</code><ul>
<li><code>nodefs</code> 达到驱逐阈值，kubelet 删除<code>已经退出的容器</code></li>
<li><code>imagefs</code> 达到驱逐阈值，kubelet 删除所有<code>未使用的镜像</code></li>
</ul>
</li>
<li>无容器运行时（CRI）分区<ul>
<li>kubelet <code>同时删除</code>已经退出的容器和未使用的镜像</li>
</ul>
</li>
</ul>
</li>
<li>回收已经退出的容器和未使用的镜像后，如果 Node 依然满足驱逐条件，kubelet 会开始<code>驱逐正在运行的 Pod</code><ul>
<li>判断 Pod 的<code>磁盘使用量</code>是否查过了请求的大小，如果超过请求资源的 Pod 将会成为<code>备选目标</code><ul>
<li>不管是否为 <code>Guaranteed</code> Pod</li>
</ul>
</li>
<li>查询 Pod 的<code>调度优先级</code>，优先驱逐低优 Pod</li>
<li>根据磁盘使用超过请求的数量进行排序，<code>差值越大，越容易被驱逐</code></li>
</ul>
</li>
</ol>
<h2 id="资源配置"><a href="#资源配置" class="headerlink" title="资源配置"></a>资源配置</h2><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><blockquote>
<p>针对不同的 <code>QoS</code> Class 的 Pod，Kubernetes 按照继承组织 cgroup 中的 CPU 子系统</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231002190956993.png" alt="image-20231002190956993"></p>
<blockquote>
<p>CPU CGroup 配置</p>
</blockquote>
<blockquote>
<p><code>cpu.shares - request</code>; <code>cpu.cfs_quota_us - limit</code></p>
</blockquote>
<blockquote>
<p><code>BestEffort</code> - 竞争<code>权重很低</code>，但<code>没有上限</code>，能抢到多少就是多少</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231002195948833.png" alt="image-20231002195948833"></p>
<blockquote>
<p>暂时没有 Guaranteed Pod</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls /sys/fs/cgroup/cpu/kubepods.slice</span><br><span class="line">cgroup.clone_children  cpu.cfs_quota_us  cpu.uclamp.max  cpuacct.usage         cpuacct.usage_percpu_sys   cpuacct.usage_user         notify_on_release</span><br><span class="line">cgroup.procs           cpu.shares        cpu.uclamp.min  cpuacct.usage_all     cpuacct.usage_percpu_user  kubepods-besteffort.slice  tasks</span><br><span class="line">cpu.cfs_period_us      cpu.stat          cpuacct.stat    cpuacct.usage_percpu  cpuacct.usage_sys          kubepods-burstable.slice</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f 1.nginx-with-resource.yaml</span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line"></span><br><span class="line">$ ls /sys/fs/cgroup/cpu/kubepods.slice</span><br><span class="line">cgroup.clone_children  cpu.shares      cpuacct.stat          cpuacct.usage_percpu_sys   kubepods-besteffort.slice                               tasks</span><br><span class="line">cgroup.procs           cpu.stat        cpuacct.usage         cpuacct.usage_percpu_user  kubepods-burstable.slice</span><br><span class="line">cpu.cfs_period_us      cpu.uclamp.max  cpuacct.usage_all     cpuacct.usage_sys          kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice</span><br><span class="line">cpu.cfs_quota_us       cpu.uclamp.min  cpuacct.usage_percpu  cpuacct.usage_user         notify_on_release</span><br><span class="line"></span><br><span class="line">$ k get po</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-76fcddd6b-brq5g   1/1     Running   0          49s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps | grep nginx</span><br><span class="line">de7df277bcda   2a4fbb36e966                                        &quot;/docker-entrypoint.…&quot;   2 minutes ago    Up 2 minutes              k8s_nginx_nginx-deployment-76fcddd6b-brq5g_default_cae7c6e1-1551-4cea-a630-6e2ba31d7be1_0</span><br><span class="line">974d0b774670   registry.aliyuncs.com/google_containers/pause:3.6   &quot;/pause&quot;                 2 minutes ago    Up 2 minutes              k8s_POD_nginx-deployment-76fcddd6b-brq5g_default_cae7c6e1-1551-4cea-a630-6e2ba31d7be1_0</span><br><span class="line"></span><br><span class="line">$ tree -L 1 /sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice</span><br><span class="line">/sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice</span><br><span class="line">|-- cgroup.clone_children</span><br><span class="line">|-- cgroup.procs</span><br><span class="line">|-- cpuacct.stat</span><br><span class="line">|-- cpuacct.usage</span><br><span class="line">|-- cpuacct.usage_all</span><br><span class="line">|-- cpuacct.usage_percpu</span><br><span class="line">|-- cpuacct.usage_percpu_sys</span><br><span class="line">|-- cpuacct.usage_percpu_user</span><br><span class="line">|-- cpuacct.usage_sys</span><br><span class="line">|-- cpuacct.usage_user</span><br><span class="line">|-- cpu.cfs_period_us</span><br><span class="line">|-- cpu.cfs_quota_us</span><br><span class="line">|-- cpu.shares</span><br><span class="line">|-- cpu.stat</span><br><span class="line">|-- cpu.uclamp.max</span><br><span class="line">|-- cpu.uclamp.min</span><br><span class="line">|-- docker-974d0b7746709fb86d2a33a6c85b0946d25b84e3f68b86043b447723f2960eaa.scope</span><br><span class="line">|-- docker-de7df277bcda5901461338198f57726ecb4577f3e02c196939c7ce69abc9ce78.scope</span><br><span class="line">|-- notify_on_release</span><br><span class="line">`-- tasks</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Pod</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/cpu.shares</span><br><span class="line">102</span><br><span class="line"></span><br><span class="line">$ cat /sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line"></span><br><span class="line">$ cat /sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/cpu.cfs_quota_us</span><br><span class="line">10000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Container</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/docker-de7df277bcda5901461338198f57726ecb4577f3e02c196939c7ce69abc9ce78.scope/cpu.shares</span><br><span class="line">102</span><br><span class="line"></span><br><span class="line">$ cat /sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/docker-de7df277bcda5901461338198f57726ecb4577f3e02c196939c7ce69abc9ce78.scope/cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line"></span><br><span class="line">$ cat /sys/fs/cgroup/cpu/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/docker-de7df277bcda5901461338198f57726ecb4577f3e02c196939c7ce69abc9ce78.scope/cpu.cfs_quota_us</span><br><span class="line">10000</span><br></pre></td></tr></table></figure>

<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><blockquote>
<p>针对不同的 <code>QoS</code> Class 的 Pod，Kubernetes 按照继承组织 cgroup 中的 Memory 子系统</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231002192701162.png" alt="image-20231002192701162"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231002195847783.png" alt="image-20231002195847783"></p>
<blockquote>
<p>Pod</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/fs/cgroup/memory/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/memory.limit_in_bytes</span><br><span class="line">209715200</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Container</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/fs/cgroup/memory/kubepods.slice/kubepods-podcae7c6e1_1551_4cea_a630_6e2ba31d7be1.slice/docker-de7df277bcda5901461338198f57726ecb4577f3e02c196939c7ce69abc9ce78.scope/memory.limit_in_bytes</span><br><span class="line">209715200</span><br></pre></td></tr></table></figure>

<h2 id="OOM-Killer"><a href="#OOM-Killer" class="headerlink" title="OOM Killer"></a>OOM Killer</h2><ol>
<li>操作系统根据 <code>oom_score</code> 来进行优先级排序，选择待终止的进程，<code>oom_score 越高，越容易被终止</code></li>
<li>进程的 oom_score 根据当前进程使用的内存<code>占 Node 总内存的比例 × 10</code>，再加上 <code>oom_score_adj</code> 得到</li>
<li>容器进程的 <code>oom_score_adj</code> 由 <code>kubelet</code> 进行设置的</li>
</ol>
<blockquote>
<p>BestEffort &gt; Burstable &gt; Guaranteed </p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">Pod QoS</th>
<th>oom_score_adj</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Guaranteed</code><br />＜3</td>
<td><code>-997</code><br />即便使用 99.9 % 的内存，oom_score 为 999 - 997 &#x3D; 2 依然很小，<code>基本不是被 Kill</code></td>
</tr>
<tr>
<td align="left"><code>Burstable</code><br />[2,999]</td>
<td>min(max(2,1000-(1000x<code>memoryRequestBytes</code>)&#x2F;<code>machineMemoryCapacityBytes</code>), 999)<br /><code>申请少，但使用多</code>的 Pod 会<code>优先被 Kill</code></td>
</tr>
<tr>
<td align="left"><code>BestEffort</code><br />&gt; 1000</td>
<td><code>1000</code><br />即便使用 1% 的内存，oom_score 为 1 + 1000 &#x3D; 1001，依然很大，<code>优先被Kill</code></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps | grep nginx</span><br><span class="line">de7df277bcda   2a4fbb36e966                                        &quot;/docker-entrypoint.…&quot;   41 minutes ago      Up 41 minutes                k8s_nginx_nginx-deployment-76fcddd6b-brq5g_default_cae7c6e1-1551-4cea-a630-6e2ba31d7be1_0</span><br><span class="line">974d0b774670   registry.aliyuncs.com/google_containers/pause:3.6   &quot;/pause&quot;                 41 minutes ago      Up 41 minutes                k8s_POD_nginx-deployment-76fcddd6b-brq5g_default_cae7c6e1-1551-4cea-a630-6e2ba31d7be1_0</span><br><span class="line"></span><br><span class="line">$ docker inspect --format=&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27; de7df277bcda</span><br><span class="line">360332</span><br><span class="line"></span><br><span class="line">$ cat /proc/360332/oom_score</span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">$ cat /proc/360332/oom_score_adj</span><br><span class="line">-997</span><br></pre></td></tr></table></figure>

<h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><blockquote>
<p>Node 上需要运行 <code>logrotate</code> 的定时任务对系统服务日志进行 <code>rotate</code> 清理</p>
</blockquote>
<blockquote>
<p><code>Docker</code> - 自带日志功能，<code>写入前检查</code><br><code>Containerd</code> - 依赖 <code>kubelet 定时执行 du</code></p>
</blockquote>
<ol>
<li>logrotate 的<code>执行周期不能过长</code>，防止日志短时间内大量增长</li>
<li>配置日志的 rotate 条件，在日志不占用太多空间的情况下，保证有足够的日志可供查看</li>
<li>Docker<ul>
<li>Docker 有 <code>Log Driver</code>，将<code>容器的标准输出</code>转存到<code>文件</code></li>
<li>除了基于系统 logrotate 管理日志<ul>
<li>还可以依赖 Docker自带的日志管理功能来设置<code>容器日志的数量</code>和<code>每个日志文件的大小</code></li>
</ul>
</li>
<li><code>Docker 写入数据之前</code>会对日志大小进行<code>检查</code>和 <code>rotate</code> 操作，确保日志文件不会超过配置的<code>数量</code>和<code>大小</code></li>
</ul>
</li>
<li>Containerd<ul>
<li>日志的管理是通过 <code>kubelet</code> 定期（10 秒）执行 <code>du</code> 命令，来检查容器日志的<code>数量</code>和文件的<code>大小</code></li>
<li>可以通过 <code>kubelet</code> 的配置参数进行调整：<code>container-log-max-size</code> &#x2F; <code>container-log-max-files</code></li>
</ul>
</li>
</ol>
<h2 id="Docker-卷管理"><a href="#Docker-卷管理" class="headerlink" title="Docker 卷管理"></a>Docker 卷管理</h2><blockquote>
<p>不建议使用 Docker Volume</p>
</blockquote>
<ol>
<li>在构建容器镜像时，可以在 <code>Dockerfile</code> 中通过 <code>VOLUME</code> 指令声明一个<code>存储卷</code><ul>
<li>目前 Kubernetes 尚未将其纳入管控范围，<code>不建议使用</code></li>
</ul>
</li>
<li>如果容器进程（取决于 CRI 实现）在<code>容器可写层</code>或者 <code>emptyDir</code> 卷进行大量读写操作，会导致<code>磁盘 IO 过高</code><ul>
<li><code>容器可写层</code> - 使用 <code>imagefs</code>，基于 <code>OverlayFS</code>，性能很差</li>
<li><code>emptyDir</code> - 使用 <code>nodefs</code>，<code>共享</code>同一块磁盘，相互影响</li>
</ul>
</li>
<li><code>Docker</code> 和 <code>Containerd</code> 运行时都是基于 <code>CGroup V1</code><ul>
<li>对<code>块设备</code>，只支持对 <code>Direct IO</code> 限速，而对于 <code>Buffer IO</code> 还不具备有效的支持</li>
<li>因此，针对<code>设备限速</code>的问题，目前还没有完美的解决方案，对于有特殊 IO 需求的容器，建议使用<code>独立的磁盘空间</code></li>
<li>寄希望于 CGroup V2</li>
</ul>
</li>
</ol>
<h2 id="网络资源"><a href="#网络资源" class="headerlink" title="网络资源"></a>网络资源</h2><blockquote>
<p>由<code>网络插件</code>（如CNI 社区提供的 bandwidth ）通过 <code>Linux Traffic Control</code> 为 Pod 限制带宽</p>
</blockquote>
<blockquote>
<p>每个容器有对应的虚拟网卡，但<code>共享物理网卡</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">kubernetes.io/ingress-bandwidth:</span> <span class="string">10MB</span></span><br><span class="line">        <span class="attr">kubernetes.io/egress-bandwidth:</span> <span class="string">10MB</span></span><br></pre></td></tr></table></figure>

<h2 id="进程数"><a href="#进程数" class="headerlink" title="进程数"></a>进程数</h2><blockquote>
<p>kubelet <code>默认不限制</code> Pod 可以创建的<code>子进程数量</code><br>可以通过启动参数 <code>podPidsLimit</code> 开启限制，可以通过 <code>reserved</code> 参数为<code>系统进程</code>预留进程数</p>
</blockquote>
<ol>
<li><code>kubelet</code> 通过<code>系统调用</code>周期性地获取当前系统的 PID 的使用量<ul>
<li>并读取 <code>/proc/sys/kernel/pid_max</code> 获取系统支持的 PID 上限（<code>2^22</code>）</li>
</ul>
</li>
<li>当前的可用进程数少于设定阈值，kubelet 会将 Node 对象的 <code>PIDPressure</code> 标记为 True</li>
<li>kube-scheduler 在进行调度时，会从备选节点中对处于 <code>NodeUnderPIDPressure</code> 状态的 Node 进行<code>过滤</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/sys/kernel/pid_max</span><br><span class="line">4194304</span><br></pre></td></tr></table></figure>

<h1 id="节点检测"><a href="#节点检测" class="headerlink" title="节点检测"></a>节点检测</h1><blockquote>
<p>Kubernetes 不会感知所有问题，会导致 Pod 仍然会被调度到有问题的 Node 上</p>
</blockquote>
<ol>
<li>基础架构守护程序问题：NTP 服务关闭</li>
<li>硬件问题：CPU、内存、磁盘损坏</li>
<li>内核问题：内核死锁、文件系统损坏</li>
<li>容器运行时问题：运行时守护程序无响应</li>
</ol>
<blockquote>
<p>引入守护进程 <code>node-problem-detector</code>，从<code>各个守护进程</code>收集 Node 问题，并<code>主动上报</code>给 Kubernetes</p>
</blockquote>
<blockquote>
<p>Kubernetes Node 诊断</p>
</blockquote>
<ol>
<li>Container Runtime 无响应</li>
<li>Linux Kernel 无响应</li>
<li>网络异常</li>
<li>文件描述符异常</li>
<li>硬件问题：CPU、内存、磁盘等</li>
</ol>
<h2 id="故障分类"><a href="#故障分类" class="headerlink" title="故障分类"></a>故障分类</h2><table>
<thead>
<tr>
<th>Problem Types</th>
<th>NodeCondition</th>
<th>Desc</th>
<th>Configs</th>
</tr>
</thead>
<tbody><tr>
<td><code>系统日志监控</code></td>
<td>KernelDeadlock<br />ReadonlyFilesystem<br />FrequentKubeletRestart<br />FrequentDockerRestart<br />FrequentContainerdRestart</td>
<td>通过监控系统日志来汇报问题并输出系统指标数据</td>
<td>filelog<br />kmsg<br />systemd</td>
</tr>
<tr>
<td>CustomPluginMonitor</td>
<td>按需定义</td>
<td>允许用户自定义监控脚本，并运行这些脚本来进行监控</td>
<td>-</td>
</tr>
<tr>
<td><code>HealthChecker</code></td>
<td>KubeletUnhealthy<br />ContainerRuntimeUnhealthy</td>
<td>针对 <code>kubelet</code> 和<code>容器运行时</code>的检查</td>
<td>kubelet docker</td>
</tr>
</tbody></table>
<h2 id="汇报方式"><a href="#汇报方式" class="headerlink" title="汇报方式"></a>汇报方式</h2><blockquote>
<p>NPD 通过<code>设置 NodeCondition</code> 或者<code>创建 Event 对象</code>来汇报问题</p>
</blockquote>
<table>
<thead>
<tr>
<th>Method</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><code>NodeCondition</code></td>
<td>针对<code>永久性故障</code>，会通过设置 NodeCondition 来改变 Node 状态</td>
</tr>
<tr>
<td><code>Event</code></td>
<td><code>临时故障</code>可以通过 Event 来提醒相关对象</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add deliveryhero https://charts.deliveryhero.io/ </span><br><span class="line"></span><br><span class="line">$ helm install npd deliveryhero/node-problem-detector --set image.repository=kubeoperator/node-problem-detector --set image.tag=v0.8.1</span><br><span class="line"></span><br><span class="line">$ k get po -owide</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">npd-node-problem-detector-982xh   1/1     Running   0          2m19s   192.168.185.13   mac-k8s   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ k get ds -owide</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE     CONTAINERS              IMAGES                                      SELECTOR</span><br><span class="line">npd-node-problem-detector   1         1         1       1            1           &lt;none&gt;          2m37s   node-problem-detector   kubeoperator/node-problem-detector:v0.8.1   app=node-problem-detector,app.kubernetes.io/instance=npd,app.kubernetes.io/name=node-problem-detector</span><br></pre></td></tr></table></figure>

<blockquote>
<p>KernelDeadlock &#x2F; ReadonlyFilesystem &#x2F; CorruptDockerOverlay2 &#x2F; KubeletReady</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">csi.volume.kubernetes.io/nodeid:</span> <span class="string">&#x27;&#123;&quot;csi.tigera.io&quot;:&quot;mac-k8s&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">kubeadm.alpha.kubernetes.io/cri-socket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">    <span class="attr">node.alpha.kubernetes.io/ttl:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">projectcalico.org/IPv4Address:</span> <span class="number">192.168</span><span class="number">.191</span><span class="number">.153</span><span class="string">/24</span></span><br><span class="line">    <span class="attr">projectcalico.org/IPv4VXLANTunnelAddr:</span> <span class="number">192.168</span><span class="number">.185</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">volumes.kubernetes.io/controller-managed-attach-detach:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-08-28T06:45:49Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">arm64</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">kubernetes.io/arch:</span> <span class="string">arm64</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/control-plane:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/master:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node.kubernetes.io/exclude-from-external-load-balancers:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mac-k8s</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;8843&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">b5720267-7927-4b62-8184-d3371f7c76ff</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podCIDR:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="attr">podCIDRs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.191</span><span class="number">.153</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InternalIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">mac-k8s</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Hostname</span></span><br><span class="line">  <span class="attr">allocatable:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">&quot;28819139742&quot;</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12134168Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">31270768Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12236568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:27:06Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-02T14:22:04Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kernel</span> <span class="string">has</span> <span class="literal">no</span> <span class="string">deadlock</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KernelHasNoDeadlock</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">KernelDeadlock</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:27:06Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-02T14:22:04Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Filesystem</span> <span class="string">is</span> <span class="string">not</span> <span class="string">read-only</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">FilesystemIsNotReadOnly</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ReadonlyFilesystem</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:27:06Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-02T14:22:04Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">docker</span> <span class="string">overlay2</span> <span class="string">is</span> <span class="string">functioning</span> <span class="string">properly</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">NoCorruptDockerOverlay2</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">CorruptDockerOverlay2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:21:53Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-02T14:21:53Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Calico</span> <span class="string">is</span> <span class="string">running</span> <span class="string">on</span> <span class="string">this</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">CalicoIsUp</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">NetworkUnavailable</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:26:24Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:45:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="string">sufficient</span> <span class="string">memory</span> <span class="string">available</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasSufficientMemory</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">MemoryPressure</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:26:24Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:45:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="literal">no</span> <span class="string">disk</span> <span class="string">pressure</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasNoDiskPressure</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DiskPressure</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:26:24Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:45:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="string">sufficient</span> <span class="string">PID</span> <span class="string">available</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasSufficientPID</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PIDPressure</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-10-02T14:26:24Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-08-28T06:49:06Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">is</span> <span class="string">posting</span> <span class="string">ready</span> <span class="string">status.</span> <span class="string">AppArmor</span> <span class="string">enabled</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletReady</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="attr">daemonEndpoints:</span></span><br><span class="line">    <span class="attr">kubeletEndpoint:</span></span><br><span class="line">      <span class="attr">Port:</span> <span class="number">10250</span></span><br><span class="line">  <span class="attr">images:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">centos@sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">centos:latest</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">271506418</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node@sha256:8e34517775f319917a0be516ed3a373dbfca650d1ee8e72158087c24356f47fb</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">257943189</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/cni@sha256:3be3c67ddba17004c292eafec98cc49368ac273b40b27c8a6621be4471d348d6</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/cni:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">199481277</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx@sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">192063326</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver@sha256:b8eba88862bab7d3d7cdddad669ff1ece006baa10d3a3df119683434497a0949</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">132450723</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/etcd@sha256:64b9ea357325d5db9f8a723dcf503b5a449177b17ac87d69481e126bb724c263</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/etcd:3.5.1-0</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">132115484</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-controller-manager@sha256:b721871d9a9c55836cbcbb2bf375e02696260628f73620b267be9a9a50c97f5a</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">122423990</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-proxy@sha256:def87f007b49d50693aed83d4703d0e56c69ae286154b1c7a20cd1b3a320cf7c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-proxy:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">109183127</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubeoperator/node-problem-detector@sha256:aa214dca443915fba3d2f97a35fee078b588de17021c01c011f7247ab056f439</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubeoperator/node-problem-detector:v0.8.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">104273686</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/apiserver@sha256:8040d37d7038ec4a24b5d670526c7a1da432f825e6aad1cb4ea1fc24cb13fc1e</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/apiserver:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">87865689</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/kube-controllers@sha256:01ce29ea8f2b34b6cef904f526baed98db4c0581102f194e36f2cd97943f77aa</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/kube-controllers:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">68842373</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">quay.io/tigera/operator@sha256:780eeab342e62bd200e533a960b548216b23b8bde7a672c4527f29eec9ce2d79</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">quay.io/tigera/operator:v1.30.4</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">64946658</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/typha@sha256:54ec33e1e6a6f2a7694b29e7101934ba75752e0c4543ee988a4015ce0caa7b99</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/typha:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">61869924</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-scheduler@sha256:32308abe86f7415611ca86ee79dd0a73e74ebecb2f9e3eb85fc3a8e62f03d0e7</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.3</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">52955871</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/coredns@sha256:5b6ec0d6de9baaf3e92d0f66cd96a25b9edbce8716f5f15dcd1a616b3abd590e</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/coredns:v1.8.6</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">46808803</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node-driver-registrar@sha256:fb4dc4863c20b7fe1e9dd5e52dcf004b74e1af07d783860a08ddc5c50560f753</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/node-driver-registrar:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">23206723</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/csi@sha256:4e05036f8ad1c884ab52cae0f1874839c27c407beaa8f008d7a28d113ad9e5ed</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/csi:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">18731350</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/pod2daemon-flexvol@sha256:2aefd77a4f8289c88cfe24c0db38822de3132292d1ea4ac9192abc9583e4b54c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">calico/pod2daemon-flexvol:v3.26.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">10707389</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/pause@sha256:3d380ca8864549e74af4b29c10f9cb0956236dfb01c40ca076fb6c37253234db</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">registry.aliyuncs.com/google_containers/pause:3.6</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">483864</span></span><br><span class="line">  <span class="attr">nodeInfo:</span></span><br><span class="line">    <span class="attr">architecture:</span> <span class="string">arm64</span></span><br><span class="line">    <span class="attr">bootID:</span> <span class="string">99afea12-0e3a-44a8-b226-085479b8ab7f</span></span><br><span class="line">    <span class="attr">containerRuntimeVersion:</span> <span class="string">docker://20.10.24</span></span><br><span class="line">    <span class="attr">kernelVersion:</span> <span class="number">5.4</span><span class="number">.0</span><span class="number">-156</span><span class="string">-generic</span></span><br><span class="line">    <span class="attr">kubeProxyVersion:</span> <span class="string">v1.23.3</span></span><br><span class="line">    <span class="attr">kubeletVersion:</span> <span class="string">v1.23.3</span></span><br><span class="line">    <span class="attr">machineID:</span> <span class="string">3bbd7f943eb34ff39f80a87bfa2037de</span></span><br><span class="line">    <span class="attr">operatingSystem:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">osImage:</span> <span class="string">Ubuntu</span> <span class="number">20.04</span><span class="number">.5</span> <span class="string">LTS</span></span><br><span class="line">    <span class="attr">systemUUID:</span> <span class="string">598a4d56-54c5-9aff-c38f-732f7662da29</span></span><br></pre></td></tr></table></figure>

<h2 id="Addon"><a href="#Addon" class="headerlink" title="Addon"></a>Addon</h2><blockquote>
<p>在控制平面的 <code>Node</code> 上保存配置到插件 Pod 的目录：<code>/etc/kubernetes/addons/node-problem-detector</code></p>
</blockquote>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><blockquote>
<p>可以结合 <code>Cluster API</code> 的 <code>MachineHealthCheck</code> 一起使用</p>
</blockquote>
<ol>
<li>NPD 只负责获取异常事件，并修改 NodeCondition，<code>不会对 Node 状态和调度产生影响</code></li>
<li>需要<code>自定义控制器</code>，监听 NPD 汇报的 NodeCondition，给 Node 打上 <code>Taint</code>，阻止 Pod 调度到故障 Node 上</li>
<li>问题修复后，<code>重启 NPD Pod</code> 来清理错误事件 - 因为一般无恢复事件，需要人肉操作</li>
</ol>
<h1 id="诊断方式"><a href="#诊断方式" class="headerlink" title="诊断方式"></a>诊断方式</h1><h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><ol>
<li>直接 SSH 到 Node</li>
<li>创建一个支持 SSH 的 Pod，并通过负载均衡转发 SSH 请求到该 Pod</li>
<li>kubectl exec pod</li>
</ol>
<h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><blockquote>
<p>针对使用 <code>systemd</code> 拉起的服务，使用 <code>journalctl</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ journalctl -help</span><br><span class="line">...</span><br><span class="line">  -u --unit=UNIT             Show logs from the specified unit</span><br><span class="line">  -f --follow                Follow the journal</span><br><span class="line">  -a --all                   Show all fields, including long and unprintable</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ journalctl -afu kubelet.service</span><br><span class="line">-- Logs begin at Sun 2022-08-27 22:17:42 CST. --</span><br><span class="line">Oct 02 22:22:04 mac-k8s kubelet[16022]: 2022-10-02 22:22:04.237 [INFO][109529] k8s.go 411: Added Mac, interface name, and active container ID to endpoint ContainerID=&quot;101095b6a9fe9d9c809ae5b0ab1476e16017ed08be831f8800310d78c7e73f5c&quot; Namespace=&quot;default&quot; Pod=&quot;npd-node-problem-detector-982xh&quot; WorkloadEndpoint=&quot;mac--k8s-k8s-npd--node--problem--detector--982xh-eth0&quot; endpoint=&amp;v3.WorkloadEndpoint&#123;TypeMeta:v1.TypeMeta&#123;Kind:&quot;WorkloadEndpoint&quot;, APIVersion:&quot;projectcalico.org/v3&quot;&#125;, ObjectMeta:v1.ObjectMeta&#123;Name:&quot;mac--k8s-k8s-npd--node--problem--detector--982xh-eth0&quot;, GenerateName:&quot;npd-node-problem-detector-&quot;, Namespace:&quot;default&quot;, SelfLink:&quot;&quot;, UID:&quot;b073d98e-01dd-41c5-950f-a8e50da9ec9e&quot;, ResourceVersion:&quot;8323&quot;, Generation:0, CreationTimestamp:time.Date(2022, time.October, 2, 22, 21, 25, 0, time.Local), DeletionTimestamp:&lt;nil&gt;, DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string&#123;&quot;app&quot;:&quot;node-problem-detector&quot;, &quot;app.kubernetes.io/instance&quot;:&quot;npd&quot;, &quot;app.kubernetes.io/name&quot;:&quot;node-problem-detector&quot;, &quot;controller-revision-hash&quot;:&quot;6b889c5f4d&quot;, &quot;pod-template-generation&quot;:&quot;1&quot;, &quot;projectcalico.org/namespace&quot;:&quot;default&quot;, &quot;projectcalico.org/orchestrator&quot;:&quot;k8s&quot;, &quot;projectcalico.org/serviceaccount&quot;:&quot;npd-node-problem-detector&quot;&#125;, Annotations:map[string]string(nil), OwnerReferences:[]v1.OwnerReference(nil), Finalizers:[]string(nil), ManagedFields:[]v1.ManagedFieldsEntry(nil)&#125;, Spec:v3.WorkloadEndpointSpec&#123;Orchestrator:&quot;k8s&quot;, Workload:&quot;&quot;, Node:&quot;mac-k8s&quot;, ContainerID:&quot;101095b6a9fe9d9c809ae5b0ab1476e16017ed08be831f8800310d78c7e73f5c&quot;, Pod:&quot;npd-node-problem-detector-982xh&quot;, Endpoint:&quot;eth0&quot;, ServiceAccountName:&quot;npd-node-problem-detector&quot;, IPNetworks:[]string&#123;&quot;192.168.185.13/32&quot;&#125;, IPNATs:[]v3.IPNAT(nil), IPv4Gateway:&quot;&quot;, IPv6Gateway:&quot;&quot;, Profiles:[]string&#123;&quot;kns.default&quot;, &quot;ksa.default.npd-node-problem-detector&quot;&#125;, InterfaceName:&quot;cali4285310fc49&quot;, MAC:&quot;7a:42:d7:66:27:cc&quot;, Ports:[]v3.WorkloadEndpointPort&#123;v3.WorkloadEndpointPort&#123;Name:&quot;exporter&quot;, Protocol:numorstring.Protocol&#123;Type:1, NumVal:0x0, StrVal:&quot;TCP&quot;&#125;, Port:0x4f21, HostPort:0x0, HostIP:&quot;&quot;&#125;&#125;, AllowSpoofedSourcePrefixes:[]string(nil)&#125;&#125;</span><br><span class="line">Oct 02 22:22:04 mac-k8s kubelet[16022]: 2022-10-02 22:22:04.246 [INFO][109529] k8s.go 489: Wrote updated endpoint to datastore ContainerID=&quot;101095b6a9fe9d9c809ae5b0ab1476e16017ed08be831f8800310d78c7e73f5c&quot; Namespace=&quot;default&quot; Pod=&quot;npd-node-problem-detector-982xh&quot; WorkloadEndpoint=&quot;mac--k8s-k8s-npd--node--problem--detector--982xh-eth0&quot;</span><br><span class="line">Oct 02 22:26:18 mac-k8s kubelet[16022]: W1002 22:26:18.023886   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br><span class="line">Oct 02 22:31:18 mac-k8s kubelet[16022]: W1002 22:31:18.024072   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br><span class="line">Oct 02 22:36:18 mac-k8s kubelet[16022]: W1002 22:36:18.024740   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br><span class="line">Oct 02 22:41:18 mac-k8s kubelet[16022]: W1002 22:41:18.029467   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br><span class="line">Oct 02 22:46:18 mac-k8s kubelet[16022]: W1002 22:46:18.027979   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br><span class="line">Oct 02 22:51:18 mac-k8s kubelet[16022]: W1002 22:51:18.025850   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br><span class="line">Oct 02 22:56:18 mac-k8s kubelet[16022]: W1002 22:56:18.024433   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br><span class="line">Oct 02 23:01:18 mac-k8s kubelet[16022]: W1002 23:01:18.026880   16022 machine.go:65] Cannot read vendor id correctly, set empty.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>针对标准的容器日志</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f -c &lt;container_name&gt; &lt;pod_name&gt;</span><br><span class="line">$ kubectl logs -f --all-containers &lt;pod_name&gt;</span><br><span class="line">$ kubectl logs -f &lt;pod_name&gt; --previous</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ k get po -A</span><br><span class="line">NAMESPACE          NAME                                       READY   STATUS    RESTARTS      AGE</span><br><span class="line">calico-apiserver   calico-apiserver-68c95b9ff6-jfbl9          1/1     Running   0             35d</span><br><span class="line">calico-apiserver   calico-apiserver-68c95b9ff6-tn6nm          1/1     Running   0             35d</span><br><span class="line">calico-system      calico-kube-controllers-7f768b4484-tnzph   1/1     Running   0             35d</span><br><span class="line">calico-system      calico-node-htqj4                          1/1     Running   0             47m</span><br><span class="line">calico-system      calico-typha-f9d9fdd6c-xql5f               1/1     Running   0             35d</span><br><span class="line">calico-system      csi-node-driver-v644v                      2/2     Running   0             35d</span><br><span class="line">default            npd-node-problem-detector-982xh            1/1     Running   0             47m</span><br><span class="line">kube-system        coredns-6d8c4cb4d-jmk8s                    1/1     Running   0             35d</span><br><span class="line">kube-system        coredns-6d8c4cb4d-vxcs8                    1/1     Running   0             35d</span><br><span class="line">kube-system        etcd-mac-k8s                               1/1     Running   0             35d</span><br><span class="line">kube-system        kube-apiserver-mac-k8s                     1/1     Running   0             35d</span><br><span class="line">kube-system        kube-controller-manager-mac-k8s            1/1     Running   2 (34d ago)   35d</span><br><span class="line">kube-system        kube-proxy-vz9p8                           1/1     Running   0             35d</span><br><span class="line">kube-system        kube-scheduler-mac-k8s                     1/1     Running   2 (34d ago)   35d</span><br><span class="line">tigera-operator    tigera-operator-59b69c49dc-flrrb           1/1     Running   2 (34d ago)   35d</span><br><span class="line"></span><br><span class="line">$ k logs -n kube-system kube-controller-manager-mac-k8s --previous --tail=5</span><br><span class="line">    /workspace/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/vendor/k8s.io/client-go/rest/watch/decoder.go:49 +0x60</span><br><span class="line">k8s.io/kubernetes/vendor/k8s.io/apimachinery/pkg/watch.(*StreamWatcher).receive(0x40025dd880)</span><br><span class="line">    /workspace/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/vendor/k8s.io/apimachinery/pkg/watch/streamwatcher.go:105 +0xb4</span><br><span class="line">created by k8s.io/kubernetes/vendor/k8s.io/apimachinery/pkg/watch.NewStreamWatcher</span><br><span class="line">    /workspace/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/vendor/k8s.io/apimachinery/pkg/watch/streamwatcher.go:76 +0x110</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果容器日志被转存到文件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it xxx -- tail -f /path/to/log</span><br></pre></td></tr></table></figure>

<h1 id="扩展资源"><a href="#扩展资源" class="headerlink" title="扩展资源"></a>扩展资源</h1><ol>
<li>扩展资源是 <code>kubernetes.io</code> 域名之外的标准资源名称<ul>
<li>使得集群管理员能够颁布<code>非 Kubernetes 内置资源</code>，而用户可以使用它们</li>
</ul>
</li>
<li>自定义扩展资源无法使用 kubernetes.io 作为资源域名</li>
<li>管理<ul>
<li><code>Node</code> 级扩展资源 - 绑定到 Node 上</li>
<li><code>设备插件</code>管理的资源 - 发布在各 Node 上由设备插件所管理的资源，如 GPU</li>
</ul>
</li>
</ol>
<h2 id="配置资源"><a href="#配置资源" class="headerlink" title="配置资源"></a>配置资源</h2><ol>
<li>集群管理员向 <code>API Server</code> 提交 <code>PATCH</code> HTTP 请求，在集群 Node 的 <code>status.capacity</code> 中为其配置可用数量<ul>
<li>完成该操作后，Node 的 <code>status.capacity</code> 会包含新资源</li>
<li><code>kubelet</code> 会<code>异步</code>地对 <code>status.allocatable</code> 执行<code>自动更新</code>操作，包含新资源</li>
</ul>
</li>
<li><code>kube-scheduler</code> 在评估 Pod 是否适合在某个 Node 上执行时会使用 Node 的 <code>status.allocatable</code> 值<ul>
<li>在更新 <code>status.capacity</code> 之后和请求该资源的第一个 Pod 被调度到该 Node 之间，可能会有<code>短暂的延迟</code></li>
<li>因为 <code>status.allocatable</code> 是被 <code>kubelet 异步更新</code>的</li>
</ul>
</li>
</ol>
<figure class="highlight yaml"><figcaption><span>~/.kube/config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1EZ3lPREEyTkRVME5Gb1hEVE16TURneU5UQTJORFUwTkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDNaCndHQldmN0VkWUF5bzc4anp4YXpwUm1BZ3c3Mi9XbnhpdWppSlBndDBrb3kvbHdjMnROc0FLM1ZjM3AvVThhd3MKVDhjRnJCMk56bUJBcW03QjNIK3hCajhWelVwc3dtT0pTeE1uNmRmQmZENXhKa3FzeDdEYVQ1MjVBbmwxbkh6Sgp6VXlNQ2h0NkFTdmJ0ZE9SZGU0aHpKblBCaVpxenpEcmJYK0EvRXB6R0RPT2xTc3RoRm9BVlJJSVhIcUJCV1lwClZPK2VITUI5ZW5TNGw2T2tOQzVSaU11Q1VtSlloV0NjVkVNdDVVNzJKaUVaMko2bWFjOTlvUkVZejhWd1dMUEUKS25iU0FXTDFlem1EVStJUlh0bXZjVDZ2NERzS1huNjJvSjRzZnpEaXd2L2k3dkczeG1YUTAxQktKWk0vSWF5dgpocVlOQWZJQVJQL2ZkaDZkc08wQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZPLzdtOW9SNUdrd0FmWjFEVW9OUythNEJvN0RNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBQjRHd1hVam9Rb2RSWS9nbmV3SApJQWxGTkpFOU5ka015WFl2dVN4Tnl5akd6SUJGTmY3d0FacXJVaGlack5qTGRGUGNuckJTSC9IQWVJV0hYeGJBCmVXSHV3bGk0dC85ekNockYybEtHUkszaW5WSnlpZGFldXFPTUF5R1JhK3d4Y0dNR1JKM001WXBMUXE0TjJlQU0KS3BJQmZ3aHlJL2tDSFQ2VDVRbEJlQ0VpaGNCVTk5cU55eDQ4NCtydzNBcGRWM2FrQ0lrOXhxVGhjM0hubDJkYQpmU2ZIcXYzSmMzUTQ1bVJNenVqQTZacWY3emcrekFFemM4SWg3bTVXdFdtdG1valBtQ3QveURFRkVkYWRpWGRLCjIyVzh4elc5VDJUbFFubUhNM2Z6aVNlQVFFQ3ZtU0NUTlNnYmxhRkkvTzBveGRNOWdyRWJPaW03VUZkblRyYm4KRWtrPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.191.153:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJRzV1c0M3ZitQeUF3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBNE1qZ3dOalExTkRSYUZ3MHlOREE0TWpjd05qUTFORFZhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQThlc1c2U3VicXRrcW5mcHMKdjBzeEdteEdJTGZjaFhuWU5pWkhIR0t1OFN2aGZUUDByOUhtNXM2MFptYUVCQXcySzJvV1RqZXg3ZEhHeXg0MAowdWZYbTZOcG5PU2orMzBHOWRSMk1FZGZGbmdPNWMxNmRWV0ZRS210cmpmUW1pS3RoVWQwUE5oWmhUcHgwZWliCmpnTW01OHNUMHNtcjlvazdqTVdUZVI2cUlLQ3RjeEg1S2QwYTVzVk95TWNPVXBZNDRlZk5qSXZCanpDdmFCZmkKOWtpL1dkMEdnT2hLVUh2R3pmZ1VSMVBKYjE0dWdiZDdYMnNTWmh0Tlgzb0ZQWGNUMHNkNUp0eGtUVjhnTUxOZQpkeWNQWDZESFBSNzBiemNxaG1iTW44TnFkNnNGQVRLSU5LSmRiL1pZM0tGZy92WG1aM1JNNW1vVS9STnVrQ2sxCjZXWFNkUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JUdis1dmFFZVJwTUFIMmRRMUtEVXZtdUFhTwp3ekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbEpUR0RkZlhvU3dyTTgxSjR4RWNTTE5QVUFsQ1V0b014eWZhCnpsMlRMeUxnc1ZOMGVjK0hKWml1SXhHZHBYZnBzR3BSNUk0N1V6TEVxTmc0ZjE1WWVqaXpuMGRmeVBmVkt3bmcKSm80amFrOGlZR2JqYUlwUy9nM2ZXcmRGdTF0MTdwZEVRc0dQbmR3blQyTHBFR2xjOXZ6b21Xc3NhRG1oRXMrdQprQThiejNFZE9lektmS3N3VXBzSWNLVU0xRUdaVmZpQXBRSnBvQmtkU2lwWDgyN3F2a3pYdks5NTZaQitDYksyCjJJWDZZbzJDVDE1Und4enFBeEphOE5VZGhFdStGY3lQNnRqWXV3QWxCaTJpOG5tTkpVVjk1clF5REJIRTdJOUIKNE45SnA0aVVoakdVTkFJcHIzV1FjYzlDRVVJL1ByTGVSUHlZc2c5NWcrYTRkTTFld1E9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBOGVzVzZTdWJxdGtxbmZwc3Ywc3hHbXhHSUxmY2hYbllOaVpISEdLdThTdmhmVFAwCnI5SG01czYwWm1hRUJBdzJLMm9XVGpleDdkSEd5eDQwMHVmWG02TnBuT1NqKzMwRzlkUjJNRWRmRm5nTzVjMTYKZFZXRlFLbXRyamZRbWlLdGhVZDBQTmhaaFRweDBlaWJqZ01tNThzVDBzbXI5b2s3ak1XVGVSNnFJS0N0Y3hINQpLZDBhNXNWT3lNY09VcFk0NGVmTmpJdkJqekN2YUJmaTlraS9XZDBHZ09oS1VIdkd6ZmdVUjFQSmIxNHVnYmQ3Clgyc1NaaHROWDNvRlBYY1Qwc2Q1SnR4a1RWOGdNTE5lZHljUFg2REhQUjcwYnpjcWhtYk1uOE5xZDZzRkFUS0kKTktKZGIvWlkzS0ZnL3ZYbVozUk01bW9VL1JOdWtDazE2V1hTZFFJREFRQUJBb0lCQUdZem9rYzVwQmNtamVtVgp6WEYzYTdRMC85OThyWTQ2TG95WjJUcjF1ZUNyWUNUTDJWaVovY21PbEFvYXp6VUNqN1FCcXBDNjJOR1c2VHdRCmM5S1NIYlZqOFE5V1RLekhZalJpNE5kK24zNVhsRHVqZGxPeG9Jeno0aXNTNjI3aXJabjcyUENIbWpJOXdhNGoKYmV3dUNyYXNSYUNza0ppajIyT2FhTFluclVvQXBWMER0ZzI2dzlJaTl0aEltRzJwZlJFUndFZ010WEZnUXd5MwpYb3ZMRHRtZGx3VFNsZ1VCekZCZ3U3NXZJM09hdk9FQlhIY0ZZY3RDOHhEN21zU0xoMG5temF0V0NTQTdSRE01Cnc5QjhCaDVmbENHcms3RjRpOGtjbzNlbmpFdTRzYzNNUU1yYnB1Y25EUzhqYVVUN2RWclBTMm5TNjZyN2JnRTEKUGJQZ1oyRUNnWUVBKzljZDh0bGxlQkpUUkM1YnpxaWxtZkZ2bWhQQTJhSjNXME8wbmlhUStLV1dHVnlFakk1UwovaXhTQUYwNktLL3BmY0hyN2hkeFRiU3cwV0tMWEhzYnMraFRFTjkzOERaRlUzaU13azMzQ0lMcWFkZWVFVUdyCkE3cHo0M2hndDNVRWsxQS9DT05ndjVPZTBxUTFWcU5tYVhudjIzK25mTTMybzVSNnphS0w0aGtDZ1lFQTllb0UKc2VrcE9SbXNnOEVMcWZsMVNiK3dMS1psSU5mNENyVjV2Qk9zQncwNHVqOUZveFBlckIxT3BQb1BaeFRqbk9HbgpEWDZ5T1FxZDJCSmIyWi9EbTlybTE2ME9xYTNJWWZ4WGpNTjliampSRk93Zk1FTmdKWHlqNE1QTFhleVd1dHg0CitzRGRBR1BrVURZa1YyNDBFVXBFOXpQS3VnSHhuUG93dTh2MzFyMENnWUVBMCtCQ3lRclBqSHBXWlhsZk1mbS8KQVVvWDY1Z00yczBOLzlGeGh0REpqUGU2MVhGNTdzcmExZzZ4bXE3VWZHQ3JYMnNrTkRheTAzNWVlSHFnNXRpSQpFUTgzdTIxVytkaWU4TC91SkpiMWE4ckFydldCZmVFeW9MdGdQcE1MUTYyR2dPMjFhcVBweEtQTXJra0t1dTVUCi9nOWhsZGpMTDN3VXNjRDhwRDdKMHhrQ2dZQlJrRW40WEhaZ3l3UXVPeFJNVDBJNHNNeVZNcWR1S2xQSjhZRXMKQVhaWWJHazVWUTBhMXRkUFRQVXR3UWJrME1maDIvSlZob1ZFYUNJTWJhSnJYeE01R1hUaGFqUG4wWTBaK3VGcQovZGdYZTk3VlNxL1ppUzlWbjY2WE9UbTFzR2dhR0ZCRUV6MzZDQ2ZNOXZnOHkzK1hrSU9wWGxOS09LVFR4U1B1CjFlc2hIUUtCZ0E2Mk5HcFlCVkdMakdvWWVReWw5NEVEL1pEb1BBdHBDK2VXTFJMMkdaVjZRbGhLVnR3TnZsTmEKR0x0MG5FQVNCa3RSc3pIanZmT0U5RitMbWo1ZC9KZ29hTFo3SU1xQTZHVHZ2R09LcURDZ0pmc1VlMUF2MFhCNQpKL0FVVFoxVHNMeGQvN2N5aEQxZ3A0SVFHYThnVEFqdkhzWHJVaUp3YTVaR0ZqY3FaMmIvCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ echo LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJRzV1c0M3ZitQeUF3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpBNE1qZ3dOalExTkRSYUZ3MHlOREE0TWpjd05qUTFORFZhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQThlc1c2U3VicXRrcW5mcHMKdjBzeEdteEdJTGZjaFhuWU5pWkhIR0t1OFN2aGZUUDByOUhtNXM2MFptYUVCQXcySzJvV1RqZXg3ZEhHeXg0MAowdWZYbTZOcG5PU2orMzBHOWRSMk1FZGZGbmdPNWMxNmRWV0ZRS210cmpmUW1pS3RoVWQwUE5oWmhUcHgwZWliCmpnTW01OHNUMHNtcjlvazdqTVdUZVI2cUlLQ3RjeEg1S2QwYTVzVk95TWNPVXBZNDRlZk5qSXZCanpDdmFCZmkKOWtpL1dkMEdnT2hLVUh2R3pmZ1VSMVBKYjE0dWdiZDdYMnNTWmh0Tlgzb0ZQWGNUMHNkNUp0eGtUVjhnTUxOZQpkeWNQWDZESFBSNzBiemNxaG1iTW44TnFkNnNGQVRLSU5LSmRiL1pZM0tGZy92WG1aM1JNNW1vVS9STnVrQ2sxCjZXWFNkUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JUdis1dmFFZVJwTUFIMmRRMUtEVXZtdUFhTwp3ekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbEpUR0RkZlhvU3dyTTgxSjR4RWNTTE5QVUFsQ1V0b014eWZhCnpsMlRMeUxnc1ZOMGVjK0hKWml1SXhHZHBYZnBzR3BSNUk0N1V6TEVxTmc0ZjE1WWVqaXpuMGRmeVBmVkt3bmcKSm80amFrOGlZR2JqYUlwUy9nM2ZXcmRGdTF0MTdwZEVRc0dQbmR3blQyTHBFR2xjOXZ6b21Xc3NhRG1oRXMrdQprQThiejNFZE9lektmS3N3VXBzSWNLVU0xRUdaVmZpQXBRSnBvQmtkU2lwWDgyN3F2a3pYdks5NTZaQitDYksyCjJJWDZZbzJDVDE1Und4enFBeEphOE5VZGhFdStGY3lQNnRqWXV3QWxCaTJpOG5tTkpVVjk1clF5REJIRTdJOUIKNE45SnA0aVVoakdVTkFJcHIzV1FjYzlDRVVJL1ByTGVSUHlZc2c5NWcrYTRkTTFld1E9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== | base64 -d &gt; admin.crt</span><br><span class="line"></span><br><span class="line">$ cat admin.crt</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDITCCAgmgAwIBAgIIG5usC7f+PyAwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE</span><br><span class="line">AxMKa3ViZXJuZXRlczAeFw0yMzA4MjgwNjQ1NDRaFw0yNDA4MjcwNjQ1NDVaMDQx</span><br><span class="line">FzAVBgNVBAoTDnN5c3RlbTptYXN0ZXJzMRkwFwYDVQQDExBrdWJlcm5ldGVzLWFk</span><br><span class="line">bWluMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8esW6Subqtkqnfps</span><br><span class="line">v0sxGmxGILfchXnYNiZHHGKu8SvhfTP0r9Hm5s60ZmaEBAw2K2oWTjex7dHGyx40</span><br><span class="line">0ufXm6NpnOSj+30G9dR2MEdfFngO5c16dVWFQKmtrjfQmiKthUd0PNhZhTpx0eib</span><br><span class="line">jgMm58sT0smr9ok7jMWTeR6qIKCtcxH5Kd0a5sVOyMcOUpY44efNjIvBjzCvaBfi</span><br><span class="line">9ki/Wd0GgOhKUHvGzfgUR1PJb14ugbd7X2sSZhtNX3oFPXcT0sd5JtxkTV8gMLNe</span><br><span class="line">dycPX6DHPR70bzcqhmbMn8Nqd6sFATKINKJdb/ZY3KFg/vXmZ3RM5moU/RNukCk1</span><br><span class="line">6WXSdQIDAQABo1YwVDAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUH</span><br><span class="line">AwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBTv+5vaEeRpMAH2dQ1KDUvmuAaO</span><br><span class="line">wzANBgkqhkiG9w0BAQsFAAOCAQEAlJTGDdfXoSwrM81J4xEcSLNPUAlCUtoMxyfa</span><br><span class="line">zl2TLyLgsVN0ec+HJZiuIxGdpXfpsGpR5I47UzLEqNg4f15Yejizn0dfyPfVKwng</span><br><span class="line">Jo4jak8iYGbjaIpS/g3fWrdFu1t17pdEQsGPndwnT2LpEGlc9vzomWssaDmhEs+u</span><br><span class="line">kA8bz3EdOezKfKswUpsIcKUM1EGZVfiApQJpoBkdSipX827qvkzXvK956ZB+CbK2</span><br><span class="line">2IX6Yo2CT15RwxzqAxJa8NUdhEu+FcyP6tjYuwAlBi2i8nmNJUV95rQyDBHE7I9B</span><br><span class="line">4N9Jp4iUhjGUNAIpr3WQcc9CEUI/PrLeRPyYsg95g+a4dM1ewQ==</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line"></span><br><span class="line">$ echo LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBOGVzVzZTdWJxdGtxbmZwc3Ywc3hHbXhHSUxmY2hYbllOaVpISEdLdThTdmhmVFAwCnI5SG01czYwWm1hRUJBdzJLMm9XVGpleDdkSEd5eDQwMHVmWG02TnBuT1NqKzMwRzlkUjJNRWRmRm5nTzVjMTYKZFZXRlFLbXRyamZRbWlLdGhVZDBQTmhaaFRweDBlaWJqZ01tNThzVDBzbXI5b2s3ak1XVGVSNnFJS0N0Y3hINQpLZDBhNXNWT3lNY09VcFk0NGVmTmpJdkJqekN2YUJmaTlraS9XZDBHZ09oS1VIdkd6ZmdVUjFQSmIxNHVnYmQ3Clgyc1NaaHROWDNvRlBYY1Qwc2Q1SnR4a1RWOGdNTE5lZHljUFg2REhQUjcwYnpjcWhtYk1uOE5xZDZzRkFUS0kKTktKZGIvWlkzS0ZnL3ZYbVozUk01bW9VL1JOdWtDazE2V1hTZFFJREFRQUJBb0lCQUdZem9rYzVwQmNtamVtVgp6WEYzYTdRMC85OThyWTQ2TG95WjJUcjF1ZUNyWUNUTDJWaVovY21PbEFvYXp6VUNqN1FCcXBDNjJOR1c2VHdRCmM5S1NIYlZqOFE5V1RLekhZalJpNE5kK24zNVhsRHVqZGxPeG9Jeno0aXNTNjI3aXJabjcyUENIbWpJOXdhNGoKYmV3dUNyYXNSYUNza0ppajIyT2FhTFluclVvQXBWMER0ZzI2dzlJaTl0aEltRzJwZlJFUndFZ010WEZnUXd5MwpYb3ZMRHRtZGx3VFNsZ1VCekZCZ3U3NXZJM09hdk9FQlhIY0ZZY3RDOHhEN21zU0xoMG5temF0V0NTQTdSRE01Cnc5QjhCaDVmbENHcms3RjRpOGtjbzNlbmpFdTRzYzNNUU1yYnB1Y25EUzhqYVVUN2RWclBTMm5TNjZyN2JnRTEKUGJQZ1oyRUNnWUVBKzljZDh0bGxlQkpUUkM1YnpxaWxtZkZ2bWhQQTJhSjNXME8wbmlhUStLV1dHVnlFakk1UwovaXhTQUYwNktLL3BmY0hyN2hkeFRiU3cwV0tMWEhzYnMraFRFTjkzOERaRlUzaU13azMzQ0lMcWFkZWVFVUdyCkE3cHo0M2hndDNVRWsxQS9DT05ndjVPZTBxUTFWcU5tYVhudjIzK25mTTMybzVSNnphS0w0aGtDZ1lFQTllb0UKc2VrcE9SbXNnOEVMcWZsMVNiK3dMS1psSU5mNENyVjV2Qk9zQncwNHVqOUZveFBlckIxT3BQb1BaeFRqbk9HbgpEWDZ5T1FxZDJCSmIyWi9EbTlybTE2ME9xYTNJWWZ4WGpNTjliampSRk93Zk1FTmdKWHlqNE1QTFhleVd1dHg0CitzRGRBR1BrVURZa1YyNDBFVXBFOXpQS3VnSHhuUG93dTh2MzFyMENnWUVBMCtCQ3lRclBqSHBXWlhsZk1mbS8KQVVvWDY1Z00yczBOLzlGeGh0REpqUGU2MVhGNTdzcmExZzZ4bXE3VWZHQ3JYMnNrTkRheTAzNWVlSHFnNXRpSQpFUTgzdTIxVytkaWU4TC91SkpiMWE4ckFydldCZmVFeW9MdGdQcE1MUTYyR2dPMjFhcVBweEtQTXJra0t1dTVUCi9nOWhsZGpMTDN3VXNjRDhwRDdKMHhrQ2dZQlJrRW40WEhaZ3l3UXVPeFJNVDBJNHNNeVZNcWR1S2xQSjhZRXMKQVhaWWJHazVWUTBhMXRkUFRQVXR3UWJrME1maDIvSlZob1ZFYUNJTWJhSnJYeE01R1hUaGFqUG4wWTBaK3VGcQovZGdYZTk3VlNxL1ppUzlWbjY2WE9UbTFzR2dhR0ZCRUV6MzZDQ2ZNOXZnOHkzK1hrSU9wWGxOS09LVFR4U1B1CjFlc2hIUUtCZ0E2Mk5HcFlCVkdMakdvWWVReWw5NEVEL1pEb1BBdHBDK2VXTFJMMkdaVjZRbGhLVnR3TnZsTmEKR0x0MG5FQVNCa3RSc3pIanZmT0U5RitMbWo1ZC9KZ29hTFo3SU1xQTZHVHZ2R09LcURDZ0pmc1VlMUF2MFhCNQpKL0FVVFoxVHNMeGQvN2N5aEQxZ3A0SVFHYThnVEFqdkhzWHJVaUp3YTVaR0ZqY3FaMmIvCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg== | base64 -d &gt; admin.key</span><br><span class="line"></span><br><span class="line">$ cat admin.key</span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEowIBAAKCAQEA8esW6Subqtkqnfpsv0sxGmxGILfchXnYNiZHHGKu8SvhfTP0</span><br><span class="line">r9Hm5s60ZmaEBAw2K2oWTjex7dHGyx400ufXm6NpnOSj+30G9dR2MEdfFngO5c16</span><br><span class="line">dVWFQKmtrjfQmiKthUd0PNhZhTpx0eibjgMm58sT0smr9ok7jMWTeR6qIKCtcxH5</span><br><span class="line">Kd0a5sVOyMcOUpY44efNjIvBjzCvaBfi9ki/Wd0GgOhKUHvGzfgUR1PJb14ugbd7</span><br><span class="line">X2sSZhtNX3oFPXcT0sd5JtxkTV8gMLNedycPX6DHPR70bzcqhmbMn8Nqd6sFATKI</span><br><span class="line">NKJdb/ZY3KFg/vXmZ3RM5moU/RNukCk16WXSdQIDAQABAoIBAGYzokc5pBcmjemV</span><br><span class="line">zXF3a7Q0/998rY46LoyZ2Tr1ueCrYCTL2ViZ/cmOlAoazzUCj7QBqpC62NGW6TwQ</span><br><span class="line">c9KSHbVj8Q9WTKzHYjRi4Nd+n35XlDujdlOxoIzz4isS627irZn72PCHmjI9wa4j</span><br><span class="line">bewuCrasRaCskJij22OaaLYnrUoApV0Dtg26w9Ii9thImG2pfRERwEgMtXFgQwy3</span><br><span class="line">XovLDtmdlwTSlgUBzFBgu75vI3OavOEBXHcFYctC8xD7msSLh0nmzatWCSA7RDM5</span><br><span class="line">w9B8Bh5flCGrk7F4i8kco3enjEu4sc3MQMrbpucnDS8jaUT7dVrPS2nS66r7bgE1</span><br><span class="line">PbPgZ2ECgYEA+9cd8tlleBJTRC5bzqilmfFvmhPA2aJ3W0O0niaQ+KWWGVyEjI5S</span><br><span class="line">/ixSAF06KK/pfcHr7hdxTbSw0WKLXHsbs+hTEN938DZFU3iMwk33CILqadeeEUGr</span><br><span class="line">A7pz43hgt3UEk1A/CONgv5Oe0qQ1VqNmaXnv23+nfM32o5R6zaKL4hkCgYEA9eoE</span><br><span class="line">sekpORmsg8ELqfl1Sb+wLKZlINf4CrV5vBOsBw04uj9FoxPerB1OpPoPZxTjnOGn</span><br><span class="line">DX6yOQqd2BJb2Z/Dm9rm160Oqa3IYfxXjMN9bjjRFOwfMENgJXyj4MPLXeyWutx4</span><br><span class="line">+sDdAGPkUDYkV240EUpE9zPKugHxnPowu8v31r0CgYEA0+BCyQrPjHpWZXlfMfm/</span><br><span class="line">AUoX65gM2s0N/9FxhtDJjPe61XF57sra1g6xmq7UfGCrX2skNDay035eeHqg5tiI</span><br><span class="line">EQ83u21W+die8L/uJJb1a8rArvWBfeEyoLtgPpMLQ62GgO21aqPpxKPMrkkKuu5T</span><br><span class="line">/g9hldjLL3wUscD8pD7J0xkCgYBRkEn4XHZgywQuOxRMT0I4sMyVMqduKlPJ8YEs</span><br><span class="line">AXZYbGk5VQ0a1tdPTPUtwQbk0Mfh2/JVhoVEaCIMbaJrXxM5GXThajPn0Y0Z+uFq</span><br><span class="line">/dgXe97VSq/ZiS9Vn66XOTm1sGgaGFBEEz36CCfM9vg8y3+XkIOpXlNKOKTTxSPu</span><br><span class="line">1eshHQKBgA62NGpYBVGLjGoYeQyl94ED/ZDoPAtpC+eWLRL2GZV6QlhKVtwNvlNa</span><br><span class="line">GLt0nEASBktRszHjvfOE9F+Lmj5d/JgoaLZ7IMqA6GTvvGOKqDCgJfsUe1Av0XB5</span><br><span class="line">J/AUTZ1TsLxd/7cyhD1gp4IQGa8gTAjvHsXrUiJwa5ZGFjcqZ2b/</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl --key admin.key --cert admin.crt --header &quot;Content-Type: application/json-patch+json&quot; \</span><br><span class="line">--request PATCH -k \</span><br><span class="line">--data &#x27;[&#123;&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/status/capacity/blog.zhongmingmao.top~1reclaimed-cpu&quot;, &quot;value&quot;: &quot;2&quot;&#125;]&#x27; \</span><br><span class="line">https://192.168.191.153:6443/api/v1/nodes/mac-k8s/status</span><br><span class="line">...</span><br><span class="line">  &quot;status&quot;: &#123;</span><br><span class="line">    &quot;capacity&quot;: &#123;</span><br><span class="line">      &quot;blog.zhongmingmao.top/reclaimed-cpu&quot;: &quot;2&quot;,</span><br><span class="line">      &quot;cpu&quot;: &quot;4&quot;,</span><br><span class="line">      &quot;ephemeral-storage&quot;: &quot;31270768Ki&quot;,</span><br><span class="line">      &quot;hugepages-1Gi&quot;: &quot;0&quot;,</span><br><span class="line">      &quot;hugepages-2Mi&quot;: &quot;0&quot;,</span><br><span class="line">      &quot;hugepages-32Mi&quot;: &quot;0&quot;,</span><br><span class="line">      &quot;hugepages-64Ki&quot;: &quot;0&quot;,</span><br><span class="line">      &quot;memory&quot;: &quot;12236568Ki&quot;,</span><br><span class="line">      &quot;pods&quot;: &quot;110&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">allocatable:</span></span><br><span class="line">    <span class="attr">blog.zhongmingmao.top/reclaimed-cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">&quot;28819139742&quot;</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12134168Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">blog.zhongmingmao.top/reclaimed-cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">31270768Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12236568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h2 id="使用资源"><a href="#使用资源" class="headerlink" title="使用资源"></a>使用资源</h2><blockquote>
<p><code>requests</code> 必须等于 <code>limits</code>，因为 Kubernetes 无法处理扩展资源的<code>超售</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.25.2</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">blog.zhongmingmao.top/reclaimed-cpu:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">blog.zhongmingmao.top/reclaimed-cpu:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k get po</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-55fc4589c4-tmpl8   0/1     Pending   0          12s</span><br><span class="line"></span><br><span class="line">$ k describe po nginx-deployment-55fc4589c4-tmpl8</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  29s   default-scheduler  0/1 nodes are available: 1 Insufficient blog.zhongmingmao.top/reclaimed-cpu.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将 requests 和 limits 修改为 2</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get po</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-7dc5566646-nfbxk   1/1     Running   0          25s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>扩展资源的<code>扣除</code>需要对应的 <code>Runtime</code> 来支持，目前暂时没有实现<br>因此  <code>blog.zhongmingmao.top/reclaimed-cpu</code> 依然为 2</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">allocatable:</span></span><br><span class="line">    <span class="attr">blog.zhongmingmao.top/reclaimed-cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">&quot;28819139742&quot;</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12134168Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">blog.zhongmingmao.top/reclaimed-cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">31270768Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-32Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-64Ki:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">12236568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><ol>
<li>可以选择由<code>默认调度器</code>来管理资源<ul>
<li><code>Request 和 Limit 必须一致</code>，因为 Kubernetes 无法确保扩展资源的<code>超售</code></li>
</ul>
</li>
<li>更常见的场景是使用调度器扩展程序（<code>Scheduler Extenders</code>）管理，这些程序处理资源消耗和资源配额</li>
</ol>
<blockquote>
<p>修改调度器策略，配置 <code>ignoredByScheduler</code> 可配置调度器<code>不要检查自定义资源</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extenders&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;urlPrefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;extender-endpoint&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bindVerb&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bind&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;managedResources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blog.zhongmingmao.top/reclaimed-cpu&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ignoredByScheduler&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="高可用集群"><a href="#高可用集群" class="headerlink" title="高可用集群"></a>高可用集群</h1><h2 id="高可用层级"><a href="#高可用层级" class="headerlink" title="高可用层级"></a>高可用层级</h2><blockquote>
<p>核心组件（Static Pod）：etcd &#x2F; api-server &#x2F; scheduler &#x2F; controller-manager &#x2F; kubelet &#x2F; kube-proxy<br>插件（用户 Pod）：CNI &#x2F; CoreDNS</p>
</blockquote>
<blockquote>
<p>镜像仓库：Docker Hub 会限流或者不可用</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231003102132552.png" alt="image-20231003102132552"></p>
<h2 id="IDC"><a href="#IDC" class="headerlink" title="IDC"></a>IDC</h2><blockquote>
<p><code>跨可用区</code>的硬件迁移属于<code>物理迁移</code>，需要一定的时间</p>
</blockquote>
<ol>
<li>多地部署（私有云 &#x2F; 公有云）</li>
<li>每个 IDC 需要划分成具有<code>独立</code>供电、制冷、网络设备的<code>高可用区</code></li>
<li>每个高可用区管理<code>独立的硬件资产</code>（机架、计算节点、存储、负载均衡、防火墙等）</li>
</ol>
<h2 id="Node-Lifecycle"><a href="#Node-Lifecycle" class="headerlink" title="Node Lifecycle"></a>Node Lifecycle</h2><blockquote>
<p><code>集群搭建</code>和<code>集群扩缩容</code>，核心都是 <code>Node 的生命周期管理</code></p>
</blockquote>
<ol>
<li>Onboard<ul>
<li>物理资产上架</li>
<li>操作系统安装</li>
<li>网络配置</li>
<li>Kubernetes 组件安装</li>
<li>创建 Node 对象</li>
</ul>
</li>
<li>故障处理<ul>
<li>临时故障 - 重启</li>
<li>永久故障 - 下架</li>
</ul>
</li>
<li>Offboard<ul>
<li>删除 Node 对象</li>
<li>物理资产下架，送修 &#x2F; 报废</li>
</ul>
</li>
</ol>
<h2 id="主机管理"><a href="#主机管理" class="headerlink" title="主机管理"></a>主机管理</h2><blockquote>
<p>社区推崇<code>不可变基础设施</code>，即<code>完全替换</code>，而非 OTA</p>
</blockquote>
<ol>
<li>选定<code>内核版本</code>、<code>发行版</code>、安装的<code>工具集</code>、规划<code>主机网络</code></li>
<li>日常的<code>主机镜像升级</code>可能会导致服务不可用<ul>
<li>可以通过 <code>A/B</code>  系统 OTA 的升级方式</li>
<li>分别使用 A 和 B 两个存储空间，<code>共享一份用户数据</code></li>
<li>在升级过程中，OTA 更新即<code>往其中一个存储空间写入升级包，同时保证另一个系统可以正常运行</code>，而不会打断用户</li>
<li>如果 OTA 失败，那么设备启动到 OTA 之前的磁盘分区，仍然可以使用</li>
</ul>
</li>
</ol>
<h2 id="控制平面"><a href="#控制平面" class="headerlink" title="控制平面"></a>控制平面</h2><ol>
<li>针对大规模的集群，应该为控制平面组件划分<code>单独节点</code>，减少业务容器对控制平面容器或守护进程的干扰和资源抢占</li>
<li>控制平面所在的节点，应确保在<code>不同机架</code>上<ul>
<li>防止因为某些机架的交换机或者电源出问题，造成所有的控制平面的节点都无法工作</li>
</ul>
</li>
<li>保证控制平面的每个组件有足够的 <code>CPU</code>、<code>内存</code>和<code>磁盘</code>资源，过于严苛的资源限制会降低<code>集群可用性</code></li>
<li>尽可能地减少或者消除外部依赖</li>
<li>尽可能地将<code>控制平面和数据平面解耦</code>，确保控制平面出现故障时，将业务影响降到最低</li>
<li>Kubernetes 还有些<code>核心插件</code>，以<code>普通 Pod</code> 的形式加载运行，可能会被调度到<code>任意工作节点</code>，与普通应用竞争资源<ul>
<li>这些插件是否正常运行也决定了集群的可用性</li>
</ul>
</li>
</ol>
<h2 id="高可用集群-1"><a href="#高可用集群-1" class="headerlink" title="高可用集群"></a>高可用集群</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231003133943024.png" alt="image-20231003133943024"></p>
<h2 id="集群安装"><a href="#集群安装" class="headerlink" title="集群安装"></a>集群安装</h2><blockquote>
<p>Kubeadm &#x3D; 关注<code>控制平面</code><br>Kubespray &#x3D; Kubeadm + 通过 <code>Ansible Playbook</code> 实现操作系统配置自动化<br><code>kOps</code> ≈ Kubespray + <code>声明式 API</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>安装工具</th>
<th>方法</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>二进制</td>
<td>下载二进制文件，并通过 <code>systemd</code> 来管理</td>
<td>灵活度高</td>
<td>复杂，需要关心每个组件的配置<br />对系统服务的依赖性过多</td>
</tr>
<tr>
<td>Kubeadm<br />半自动化</td>
<td>搭建集群的<code>命令行工具</code><br />管理节点通过 kubeadm init 初始化<br />计算节点通过 kubeadm join 加入</td>
<td>封装<code>控制平面组件</code>的安装和配置<br />管理集群的生命周期（升级、证书）</td>
<td><code>操作系统</code>层面的配置没有自动化<br />运行时安装配置依然复杂<br />CNI 插件等需要手工安装</td>
</tr>
<tr>
<td>Kubespray<br />全自动化</td>
<td>通过 <code>Ansible Playbook</code> 完成集群搭建</td>
<td>自动完成<code>操作系统</code>层面的配置<br />利用 <code>kubeadm</code> 作为集群管理工具</td>
<td>只是一个集群安装工具<br /> 缺少 <code>声明式 API</code></td>
</tr>
<tr>
<td>kOps<br />全自动化</td>
<td>基于<code>声明式 API</code> 的<code>集群管理</code>工具</td>
<td>基于 <code>Cluster API</code> 集群管理<br /></td>
<td>与云环境<code>深度集成</code><br />灵活性差</td>
</tr>
</tbody></table>
<h3 id="Kubespray"><a href="#Kubespray" class="headerlink" title="Kubespray"></a>Kubespray</h3><blockquote>
<p>只是一个集群安装工具，并非集群<code>持续运维</code>工具</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231003142220404.png" alt="image-20231003142220404"></p>
<h3 id="Cluster-API"><a href="#Cluster-API" class="headerlink" title="Cluster API"></a>Cluster API</h3><blockquote>
<p>集群搭建只是 Day 0 的事项，<code>集群管理</code>应该建立在<code>声明式 API</code> 的基础上，使得集群<code>可持续运维</code></p>
</blockquote>
<ol>
<li>集群搭建</li>
<li>集群扩缩容</li>
<li>节点健康检查和自动修复</li>
<li>Kubernetes 升级</li>
<li>操作系统升级</li>
</ol>
<blockquote>
<p>社区主流 - Kubernetes on Kubernetes</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231003155051688.png" alt="image-20231003155051688"></p>
<h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><table>
<thead>
<tr>
<th>Role</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>管理集群</td>
<td>管理 Workload 集群的集群，用来存放 Cluster API 的地方</td>
</tr>
<tr>
<td>Workload 集群</td>
<td>真正开放给用户用来运行应用的集群，由管理集群管理</td>
</tr>
<tr>
<td>Infrastructure Provider</td>
<td>提供不同云的基础架构管理，包括计算节点、网络等<br />目前流行的公有云都与 Cluster API 完成了集成</td>
</tr>
<tr>
<td>Control Plane Provider</td>
<td>通过什么方式安装 Kubernetes 的控制面组件</td>
</tr>
<tr>
<td>Bootstrap Provider</td>
<td>证书生成<br />控制面组件的安装和初始化，监听 Machine 的创建事件<br />将 Master 节点和 Worker 节点加入集群</td>
</tr>
</tbody></table>
<h4 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h4><blockquote>
<p>由 <code>Infrastructure Provider</code>  来提供 <code>Machine</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>Model</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>Machine</td>
<td>计算节点，用来描述可以运行 Kubernetes 组件的机器对象<br />一个 Machine 被创建后，Infrastructure Provider 会创建一个计算节点并安装好操作系统<br />一个 Machine 被删除后，Infrastructure Provider 会删除掉该计算节点并回收计算资源<br />当 Machine 属性被变更后，Infrastructure Provider 会<code>删除</code>旧计算节点并创建新计算节点</td>
</tr>
<tr>
<td>Machine Immutability</td>
<td>不可变基础架构（<code>Replace</code>）</td>
</tr>
<tr>
<td>MachineSet</td>
<td>维护一个稳定的机器集合，类似于 Kubernetes ReplicaSet</td>
</tr>
<tr>
<td>MachineDeployment</td>
<td>提供 Machine 和 MachineSet 的声明式更新，类似于 Kubernetes Deployment</td>
</tr>
<tr>
<td>MachineHealthCheck</td>
<td>定义应该被标记为不可用的条件</td>
</tr>
</tbody></table>
<blockquote>
<p><code>MachineHealthCheck</code> 可以结合 <code>NPD</code> 一起使用</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231004144342140.png" alt="image-20231004144342140"></p>
<h4 id="Kind"><a href="#Kind" class="headerlink" title="Kind"></a>Kind</h4><blockquote>
<p>启动管理集群</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>kind.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="attr">nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">extraMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostPath:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line">      <span class="attr">containerPath:</span> <span class="string">/var/run/docker.sock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ env KIND_EXPERIMENTAL_DOCKER_NETWORK=bridge</span><br><span class="line"></span><br><span class="line">$ kind create cluster --config ./kind.conf</span><br><span class="line">Creating cluster &quot;kind&quot; ...</span><br><span class="line"> ✓ Ensuring node image (kindest/node:v1.27.3) 🖼</span><br><span class="line"> ✓ Preparing nodes 📦</span><br><span class="line"> ✓ Writing configuration 📜</span><br><span class="line"> ✓ Starting control-plane 🕹️</span><br><span class="line"> ✓ Installing CNI 🔌</span><br><span class="line"> ✓ Installing StorageClass 💾</span><br><span class="line">Set kubectl context to &quot;kind-kind&quot;</span><br><span class="line">You can now use your cluster with:</span><br><span class="line"></span><br><span class="line">kubectl cluster-info --context kind-kind</span><br><span class="line"></span><br><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                       NAMES</span><br><span class="line">f5ffa0c472eb   kindest/node:v1.27.3   &quot;/usr/local/bin/entr…&quot;   15 minutes ago   Up 15 minutes   127.0.0.1:49383-&gt;6443/tcp   kind-control-plane</span><br><span class="line"></span><br><span class="line">$ k get po -A</span><br><span class="line">NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system          coredns-5d78c9869d-482md                     1/1     Running   0          37s</span><br><span class="line">kube-system          coredns-5d78c9869d-w64mb                     1/1     Running   0          37s</span><br><span class="line">kube-system          etcd-kind-control-plane                      1/1     Running   0          51s</span><br><span class="line">kube-system          kindnet-ng9n6                                1/1     Running   0          37s</span><br><span class="line">kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          51s</span><br><span class="line">kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          51s</span><br><span class="line">kube-system          kube-proxy-zdffj                             1/1     Running   0          37s</span><br><span class="line">kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          51s</span><br><span class="line">local-path-storage   local-path-provisioner-6bc4bddd6b-wxwvm      1/1     Running   0          37s</span><br><span class="line"></span><br><span class="line">$ kubecm l</span><br><span class="line">+------------+--------------+--------------+--------------+----------------------------+--------------+</span><br><span class="line">|   CURRENT  |     NAME     |    CLUSTER   |     USER     |           SERVER           |   Namespace  |</span><br><span class="line">+============+==============+==============+==============+============================+==============+</span><br><span class="line">|      *     |   kind-kind  |   kind-kind  |   kind-kind  |   https://127.0.0.1:49383  |    default   |</span><br><span class="line">+------------+--------------+--------------+--------------+----------------------------+--------------+</span><br><span class="line"></span><br><span class="line">Cluster check succeeded!</span><br><span class="line">Kubernetes version v1.27.3</span><br><span class="line">Kubernetes master is running at https://127.0.0.1:49383</span><br><span class="line">[Summary] Namespace: 5 Node: 1 Pod: 9</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在管理集群上安装 <code>Cluster API</code>，并使用 <code>Docker</code> 作为 <code>Infrastructure Provider</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ clusterctl init --infrastructure docker --config dockercluster.yaml</span><br><span class="line">Fetching providers</span><br><span class="line">Installing cert-manager Version=&quot;v1.13.0&quot;</span><br><span class="line">Waiting for cert-manager to be available...</span><br><span class="line">Installing Provider=&quot;cluster-api&quot; Version=&quot;v1.5.2&quot; TargetNamespace=&quot;capi-system&quot;</span><br><span class="line">Installing Provider=&quot;bootstrap-kubeadm&quot; Version=&quot;v1.5.2&quot; TargetNamespace=&quot;capi-kubeadm-bootstrap-system&quot;</span><br><span class="line">Installing Provider=&quot;control-plane-kubeadm&quot; Version=&quot;v1.5.2&quot; TargetNamespace=&quot;capi-kubeadm-control-plane-system&quot;</span><br><span class="line">Installing Provider=&quot;infrastructure-docker&quot; Version=&quot;v1.5.2&quot; TargetNamespace=&quot;capd-system&quot;</span><br><span class="line"></span><br><span class="line">Your management cluster has been initialized successfully!</span><br><span class="line"></span><br><span class="line">You can now create your first workload cluster by running the following:</span><br><span class="line"></span><br><span class="line">  clusterctl generate cluster [name] --kubernetes-version [version] | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Bootstrap Provider</code> 和 <code>Control Plane Provider</code> 均通过 <code>Kubeadm</code> 来实现</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ k get ns</span><br><span class="line">NAME                                STATUS   AGE</span><br><span class="line">capd-system                         Active   6m56s</span><br><span class="line">capi-kubeadm-bootstrap-system       Active   6m57s</span><br><span class="line">capi-kubeadm-control-plane-system   Active   6m57s</span><br><span class="line">capi-system                         Active   6m58s</span><br><span class="line">cert-manager                        Active   8m24s</span><br><span class="line">default                             Active   11m</span><br><span class="line">kube-node-lease                     Active   11m</span><br><span class="line">kube-public                         Active   11m</span><br><span class="line">kube-system                         Active   11m</span><br><span class="line">local-path-storage                  Active   11m</span><br><span class="line"></span><br><span class="line">$ k get po -A</span><br><span class="line">NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">capd-system                         capd-controller-manager-987df6999-9qmq7                          1/1     Running   0          7m14s</span><br><span class="line">capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-565c858799-q69vx       1/1     Running   0          7m15s</span><br><span class="line">capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857f6cc8f4-jf77m   1/1     Running   0          7m14s</span><br><span class="line">capi-system                         capi-controller-manager-56846fbb5b-zvt2g                         1/1     Running   0          7m15s</span><br><span class="line">cert-manager                        cert-manager-5f9cb7f4c9-x2nv8                                    1/1     Running   0          8m42s</span><br><span class="line">cert-manager                        cert-manager-cainjector-cbdcd8858-slhxl                          1/1     Running   0          8m42s</span><br><span class="line">cert-manager                        cert-manager-webhook-bb9f4dd8-drqfk                              1/1     Running   0          8m42s</span><br><span class="line">kube-system                         coredns-5d78c9869d-482md                                         1/1     Running   0          11m</span><br><span class="line">kube-system                         coredns-5d78c9869d-w64mb                                         1/1     Running   0          11m</span><br><span class="line">kube-system                         etcd-kind-control-plane                                          1/1     Running   0          11m</span><br><span class="line">kube-system                         kindnet-ng9n6                                                    1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-apiserver-kind-control-plane                                1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-controller-manager-kind-control-plane                       1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-proxy-zdffj                                                 1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-scheduler-kind-control-plane                                1/1     Running   0          11m</span><br><span class="line">local-path-storage                  local-path-provisioner-6bc4bddd6b-wxwvm                          1/1     Running   0          11m</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ k get crd</span><br><span class="line">NAME                                                         CREATED AT</span><br><span class="line">certificaterequests.cert-manager.io                          2022-10-04T04:56:05Z</span><br><span class="line">certificates.cert-manager.io                                 2022-10-04T04:56:05Z</span><br><span class="line">challenges.acme.cert-manager.io                              2022-10-04T04:56:05Z</span><br><span class="line">clusterclasses.cluster.x-k8s.io                              2022-10-04T04:57:31Z</span><br><span class="line">clusterissuers.cert-manager.io                               2022-10-04T04:56:05Z</span><br><span class="line">clusterresourcesetbindings.addons.cluster.x-k8s.io           2022-10-04T04:57:31Z</span><br><span class="line">clusterresourcesets.addons.cluster.x-k8s.io                  2022-10-04T04:57:31Z</span><br><span class="line">clusters.cluster.x-k8s.io                                    2022-10-04T04:57:32Z</span><br><span class="line">dockerclusters.infrastructure.cluster.x-k8s.io               2022-10-04T04:57:33Z</span><br><span class="line">dockerclustertemplates.infrastructure.cluster.x-k8s.io       2022-10-04T04:57:33Z</span><br><span class="line">dockermachinepools.infrastructure.cluster.x-k8s.io           2022-10-04T04:57:33Z</span><br><span class="line">dockermachines.infrastructure.cluster.x-k8s.io               2022-10-04T04:57:33Z</span><br><span class="line">dockermachinetemplates.infrastructure.cluster.x-k8s.io       2022-10-04T04:57:33Z</span><br><span class="line">extensionconfigs.runtime.cluster.x-k8s.io                    2022-10-04T04:57:32Z</span><br><span class="line">ipaddressclaims.ipam.cluster.x-k8s.io                        2022-10-04T04:57:32Z</span><br><span class="line">ipaddresses.ipam.cluster.x-k8s.io                            2022-10-04T04:57:32Z</span><br><span class="line">issuers.cert-manager.io                                      2022-10-04T04:56:05Z</span><br><span class="line">kubeadmconfigs.bootstrap.cluster.x-k8s.io                    2022-10-04T04:57:32Z</span><br><span class="line">kubeadmconfigtemplates.bootstrap.cluster.x-k8s.io            2022-10-04T04:57:32Z</span><br><span class="line">kubeadmcontrolplanes.controlplane.cluster.x-k8s.io           2022-10-04T04:57:32Z</span><br><span class="line">kubeadmcontrolplanetemplates.controlplane.cluster.x-k8s.io   2022-10-04T04:57:33Z</span><br><span class="line">machinedeployments.cluster.x-k8s.io                          2022-10-04T04:57:32Z</span><br><span class="line">machinehealthchecks.cluster.x-k8s.io                         2022-10-04T04:57:32Z</span><br><span class="line">machinepools.cluster.x-k8s.io                                2022-10-04T04:57:32Z</span><br><span class="line">machines.cluster.x-k8s.io                                    2022-10-04T04:57:32Z</span><br><span class="line">machinesets.cluster.x-k8s.io                                 2022-10-04T04:57:32Z</span><br><span class="line">orders.acme.cert-manager.io                                  2022-10-04T04:56:05Z</span><br><span class="line">providers.clusterctl.cluster.x-k8s.io                        2022-10-04T04:55:56Z</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ k api-resources | grep &#x27;cluster.x-k8s.io/v1beta1&#x27;</span><br><span class="line">clusterresourcesetbindings                     addons.cluster.x-k8s.io/v1beta1           true         ClusterResourceSetBinding</span><br><span class="line">clusterresourcesets                            addons.cluster.x-k8s.io/v1beta1           true         ClusterResourceSet</span><br><span class="line">kubeadmconfigs                                 bootstrap.cluster.x-k8s.io/v1beta1        true         KubeadmConfig</span><br><span class="line">kubeadmconfigtemplates                         bootstrap.cluster.x-k8s.io/v1beta1        true         KubeadmConfigTemplate</span><br><span class="line">clusterclasses                    cc           cluster.x-k8s.io/v1beta1                  true         ClusterClass</span><br><span class="line">clusters                          cl           cluster.x-k8s.io/v1beta1                  true         Cluster</span><br><span class="line">machinedeployments                md           cluster.x-k8s.io/v1beta1                  true         MachineDeployment</span><br><span class="line">machinehealthchecks               mhc,mhcs     cluster.x-k8s.io/v1beta1                  true         MachineHealthCheck</span><br><span class="line">machinepools                      mp           cluster.x-k8s.io/v1beta1                  true         MachinePool</span><br><span class="line">machines                          ma           cluster.x-k8s.io/v1beta1                  true         Machine</span><br><span class="line">machinesets                       ms           cluster.x-k8s.io/v1beta1                  true         MachineSet</span><br><span class="line">kubeadmcontrolplanes              kcp          controlplane.cluster.x-k8s.io/v1beta1     true         KubeadmControlPlane</span><br><span class="line">kubeadmcontrolplanetemplates                   controlplane.cluster.x-k8s.io/v1beta1     true         KubeadmControlPlaneTemplate</span><br><span class="line">dockerclusters                                 infrastructure.cluster.x-k8s.io/v1beta1   true         DockerCluster</span><br><span class="line">dockerclustertemplates                         infrastructure.cluster.x-k8s.io/v1beta1   true         DockerClusterTemplate</span><br><span class="line">dockermachinepools                             infrastructure.cluster.x-k8s.io/v1beta1   true         DockerMachinePool</span><br><span class="line">dockermachines                                 infrastructure.cluster.x-k8s.io/v1beta1   true         DockerMachine</span><br><span class="line">dockermachinetemplates                         infrastructure.cluster.x-k8s.io/v1beta1   true         DockerMachineTemplate</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成Workload 集群的配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ clusterctl generate cluster capi-first --flavor development \</span><br><span class="line">  --kubernetes-version v1.22.2 \</span><br><span class="line">  --control-plane-machine-count=1 \</span><br><span class="line">  --worker-machine-count=1 \</span><br><span class="line">  &gt; capi-first.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 <code>Kubeadm</code> 搭建<code>控制面</code>，使用 <code>Docker</code> 作为 <code>Infrastructure Provider</code></p>
</blockquote>
<blockquote>
<p><code>KubeadmControlPlane</code> 为 <code>Master</code> 节点，指定了 kubeadm 配置以及 Infrastructure 的配置<br><code>MachineDeployment</code> 为 <code>Worker</code> 节点，指定了 bootstrap 逻辑（即如何 kubeadm join）和 Infrastructure 的配置</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>capi-first.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterNetwork:</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">      <span class="attr">cidrBlocks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">    <span class="attr">serviceDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">      <span class="attr">cidrBlocks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.128</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line">  <span class="attr">controlPlaneRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">controlplane.cluster.x-k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KubeadmControlPlane</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">capi-first-control-plane</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">infrastructureRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">infrastructure.cluster.x-k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">DockerCluster</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">capi-first</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">infrastructure.cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DockerCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">infrastructure.cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DockerMachineTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first-control-plane</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">extraMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPath:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line">        <span class="attr">hostPath:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">controlplane.cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeadmControlPlane</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first-control-plane</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">kubeadmConfigSpec:</span></span><br><span class="line">    <span class="attr">clusterConfiguration:</span></span><br><span class="line">      <span class="attr">apiServer:</span></span><br><span class="line">        <span class="attr">certSANs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">controllerManager:</span></span><br><span class="line">        <span class="attr">extraArgs:</span></span><br><span class="line">          <span class="attr">enable-hostpath-provisioner:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">initConfiguration:</span></span><br><span class="line">      <span class="attr">nodeRegistration:</span></span><br><span class="line">        <span class="attr">criSocket:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line">        <span class="attr">kubeletExtraArgs:</span></span><br><span class="line">          <span class="attr">cgroup-driver:</span> <span class="string">cgroupfs</span></span><br><span class="line">          <span class="attr">eviction-hard:</span> <span class="string">nodefs.available&lt;0%,nodefs.inodesFree&lt;0%,imagefs.available&lt;0%</span></span><br><span class="line">    <span class="attr">joinConfiguration:</span></span><br><span class="line">      <span class="attr">nodeRegistration:</span></span><br><span class="line">        <span class="attr">criSocket:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line">        <span class="attr">kubeletExtraArgs:</span></span><br><span class="line">          <span class="attr">cgroup-driver:</span> <span class="string">cgroupfs</span></span><br><span class="line">          <span class="attr">eviction-hard:</span> <span class="string">nodefs.available&lt;0%,nodefs.inodesFree&lt;0%,imagefs.available&lt;0%</span></span><br><span class="line">  <span class="attr">machineTemplate:</span></span><br><span class="line">    <span class="attr">infrastructureRef:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">infrastructure.cluster.x-k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">DockerMachineTemplate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">capi-first-control-plane</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1.22.2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">infrastructure.cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DockerMachineTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first-md-0</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span> &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">bootstrap.cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeadmConfigTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first-md-0</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">joinConfiguration:</span></span><br><span class="line">        <span class="attr">nodeRegistration:</span></span><br><span class="line">          <span class="attr">kubeletExtraArgs:</span></span><br><span class="line">            <span class="attr">cgroup-driver:</span> <span class="string">cgroupfs</span></span><br><span class="line">            <span class="attr">eviction-hard:</span> <span class="string">nodefs.available&lt;0%,nodefs.inodesFree&lt;0%,imagefs.available&lt;0%</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MachineDeployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first-md-0</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterName:</span> <span class="string">capi-first</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">bootstrap:</span></span><br><span class="line">        <span class="attr">configRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">bootstrap.cluster.x-k8s.io/v1beta1</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">KubeadmConfigTemplate</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">capi-first-md-0</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">clusterName:</span> <span class="string">capi-first</span></span><br><span class="line">      <span class="attr">infrastructureRef:</span></span><br><span class="line">        <span class="attr">apiVersion:</span> <span class="string">infrastructure.cluster.x-k8s.io/v1beta1</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">DockerMachineTemplate</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">capi-first-md-0</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1.22.2</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>应用Workload 集群的配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f capi-first.yaml</span><br><span class="line">cluster.cluster.x-k8s.io/capi-first created</span><br><span class="line">dockercluster.infrastructure.cluster.x-k8s.io/capi-first created</span><br><span class="line">dockermachinetemplate.infrastructure.cluster.x-k8s.io/capi-first-control-plane created</span><br><span class="line">kubeadmcontrolplane.controlplane.cluster.x-k8s.io/capi-first-control-plane created</span><br><span class="line">dockermachinetemplate.infrastructure.cluster.x-k8s.io/capi-first-md-0 created</span><br><span class="line">kubeadmconfigtemplate.bootstrap.cluster.x-k8s.io/capi-first-md-0 created</span><br><span class="line">machinedeployment.cluster.x-k8s.io/capi-first-md-0 created</span><br><span class="line"></span><br><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE                                COMMAND                  CREATED             STATUS             PORTS                              NAMES</span><br><span class="line">4ef170681e3c   kindest/node:v1.22.2                 &quot;/usr/local/bin/entr…&quot;   27 minutes ago      Up 27 minutes      0/tcp, 127.0.0.1:32769-&gt;6443/tcp   capi-first-control-plane-jcgts</span><br><span class="line">25e97478c24e   kindest/haproxy:v20230510-486859a6   &quot;haproxy -W -db -f /…&quot;   30 minutes ago      Up 30 minutes      0/tcp, 0.0.0.0:32768-&gt;6443/tcp     capi-first-lb</span><br><span class="line">f5ffa0c472eb   kindest/node:v1.27.3                 &quot;/usr/local/bin/entr…&quot;   About an hour ago   Up About an hour   127.0.0.1:49383-&gt;6443/tcp          kind-control-plane</span><br><span class="line"></span><br><span class="line">$ k get cluster -A</span><br><span class="line">NAMESPACE   NAME         PHASE         AGE   VERSION</span><br><span class="line">default     capi-first   Provisioned   32s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>k get cluster capi-first -oyaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cluster.x-k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;cluster.x-k8s.io/v1beta1&quot;,&quot;kind&quot;:&quot;Cluster&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;capi-first&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;clusterNetwork&quot;:&#123;&quot;pods&quot;:&#123;&quot;cidrBlocks&quot;:[&quot;192.168.0.0/16&quot;]&#125;,&quot;serviceDomain&quot;:&quot;cluster.local&quot;,&quot;services&quot;:&#123;&quot;cidrBlocks&quot;:[&quot;10.128.0.0/12&quot;]&#125;&#125;,&quot;controlPlaneRef&quot;:&#123;&quot;apiVersion&quot;:&quot;controlplane.cluster.x-k8s.io/v1beta1&quot;,&quot;kind&quot;:&quot;KubeadmControlPlane&quot;,&quot;name&quot;:&quot;capi-first-control-plane&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;infrastructureRef&quot;:&#123;&quot;apiVersion&quot;:&quot;infrastructure.cluster.x-k8s.io/v1beta1&quot;,&quot;kind&quot;:&quot;DockerCluster&quot;,&quot;name&quot;:&quot;capi-first&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-10-04T05:36:42Z&quot;</span></span><br><span class="line">  <span class="attr">finalizers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cluster.cluster.x-k8s.io</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">capi-first</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;8666&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">6bcadc49-13ec-4fff-b0b2-cc64d3515ec0</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterNetwork:</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">      <span class="attr">cidrBlocks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">    <span class="attr">serviceDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">      <span class="attr">cidrBlocks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.128</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line">  <span class="attr">controlPlaneEndpoint:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">  <span class="attr">controlPlaneRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">controlplane.cluster.x-k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">KubeadmControlPlane</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">capi-first-control-plane</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">infrastructureRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">infrastructure.cluster.x-k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">DockerCluster</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">capi-first</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-04T05:36:42Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Scaling</span> <span class="string">up</span> <span class="string">control</span> <span class="string">plane</span> <span class="string">to</span> <span class="number">1</span> <span class="string">replicas</span> <span class="string">(actual</span> <span class="number">0</span><span class="string">)</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">ScalingUp</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">Warning</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-04T05:36:42Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">control</span> <span class="string">plane</span> <span class="string">provider</span> <span class="string">to</span> <span class="string">indicate</span> <span class="string">the</span> <span class="string">control</span> <span class="string">plane</span> <span class="string">has</span></span><br><span class="line">      <span class="string">been</span> <span class="string">initialized</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">WaitingForControlPlaneProviderInitialized</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">Info</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ControlPlaneInitialized</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-04T05:36:42Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Scaling</span> <span class="string">up</span> <span class="string">control</span> <span class="string">plane</span> <span class="string">to</span> <span class="number">1</span> <span class="string">replicas</span> <span class="string">(actual</span> <span class="number">0</span><span class="string">)</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">ScalingUp</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">Warning</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ControlPlaneReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-04T05:36:59Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InfrastructureReady</span></span><br><span class="line">  <span class="attr">infrastructureReady:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Provisioned</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ k get kubeadmcontrolplanes.controlplane.cluster.x-k8s.io -owide</span><br><span class="line">NAME                       CLUSTER      INITIALIZED   API SERVER AVAILABLE   DESIRED   REPLICAS   READY   UPDATED   UNAVAILABLE   AGE   VERSION</span><br><span class="line">capi-first-control-plane   capi-first                                        1         1                  1         1             36m   v1.22.2</span><br><span class="line"></span><br><span class="line">$ k get machinedeployments.cluster.x-k8s.io -owide</span><br><span class="line">NAME              CLUSTER      DESIRED   REPLICAS   READY   UPDATED   UNAVAILABLE   PHASE       AGE   VERSION</span><br><span class="line">capi-first-md-0   capi-first   1         1                  1         1             ScalingUp   35m   v1.22.2</span><br><span class="line"></span><br><span class="line">$ k get machinesets.cluster.x-k8s.io -owide</span><br><span class="line">NAME                    CLUSTER      DESIRED   REPLICAS   READY   AVAILABLE   AGE   VERSION</span><br><span class="line">capi-first-md-0-v8fnv   capi-first   1         1                              35m   v1.22.2</span><br><span class="line"></span><br><span class="line">$ k get machines.cluster.x-k8s.io -owide</span><br><span class="line">NAME                             CLUSTER      NODENAME   PROVIDERID   PHASE          AGE   VERSION</span><br><span class="line">capi-first-control-plane-jcgts   capi-first                           Provisioning   35m   v1.22.2</span><br><span class="line">capi-first-md-0-v8fnv-d5pxc      capi-first                           Pending        36m   v1.22.2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取 Workload 集群的 kubeconfig</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clusterctl get kubeconfig capi-first &gt; ~/.kube/capi-first</span><br></pre></td></tr></table></figure>

<blockquote>
<p>扩容 Worker 节点</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ k scale machinedeployments.cluster.x-k8s.io capi-first-md-0 --replicas=2</span><br><span class="line">machinedeployment.cluster.x-k8s.io/capi-first-md-0 scaled</span><br><span class="line"></span><br><span class="line">$ k get machinedeployments.cluster.x-k8s.io -owide</span><br><span class="line">NAME              CLUSTER      DESIRED   REPLICAS   READY   UPDATED   UNAVAILABLE   PHASE       AGE   VERSION</span><br><span class="line">capi-first-md-0   capi-first   2         2                  2         2             ScalingUp   46m   v1.22.2</span><br><span class="line"></span><br><span class="line">$ k get machinesets.cluster.x-k8s.io -owide</span><br><span class="line">NAME                    CLUSTER      DESIRED   REPLICAS   READY   AVAILABLE   AGE   VERSION</span><br><span class="line">capi-first-md-0-v8fnv   capi-first   2         2                              46m   v1.22.2</span><br><span class="line"></span><br><span class="line">$ k get machines.cluster.x-k8s.io -owide</span><br><span class="line">NAME                             CLUSTER      NODENAME   PROVIDERID   PHASE          AGE   VERSION</span><br><span class="line">capi-first-control-plane-jcgts   capi-first                           Provisioning   46m   v1.22.2</span><br><span class="line">capi-first-md-0-v8fnv-d5pxc      capi-first                           Pending        46m   v1.22.2</span><br><span class="line">capi-first-md-0-v8fnv-z4d24      capi-first                           Pending        75s   v1.22.2</span><br></pre></td></tr></table></figure>

<h1 id="Cluster-Autoscaler"><a href="#Cluster-Autoscaler" class="headerlink" title="Cluster Autoscaler"></a>Cluster Autoscaler</h1><blockquote>
<p><code>CA</code> 针对 <code>Node</code>，而 <code>HPA</code> 和 <code>VPA</code> 针对的是 <code>Pod</code></p>
</blockquote>
<h2 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h2><blockquote>
<p><code>Pending</code> 必须是由于<code>资源不足</code>造成的，才会<code>扩容</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>Action</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>扩容</td>
<td>由于<code>资源不足</code>，Pod 调度失败，即 <code>Pod</code> 一直处于 <code>Pending</code> 状态</td>
</tr>
<tr>
<td>缩容</td>
<td>Node 的<code>资源利用率较低</code>，持续 10 分钟低于 50 %<br />且此 Node 上<code>存在的 Pod 都能被重新调度</code>到其它 Node 上运行</td>
</tr>
</tbody></table>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><blockquote>
<p><code>Estimator</code> 关注<code>弹出</code>怎样的 Node，<code>Simulator</code> 关注如何将 Pod <code>调度</code>到其它 Node</p>
</blockquote>
<table>
<thead>
<tr>
<th>Module</th>
<th>Role</th>
</tr>
</thead>
<tbody><tr>
<td><code>Autoscaler</code></td>
<td>核心模块，负责整体扩缩容功能</td>
</tr>
<tr>
<td><code>Estimator</code></td>
<td>负责<code>评估</code>计算<code>扩容节点</code>（需要扣除 <code>DaemonSet</code> 占用的资源）</td>
</tr>
<tr>
<td><code>Simulator</code></td>
<td>负责模拟<code>调度</code>，计算<code>缩容节点</code></td>
</tr>
<tr>
<td><code>Cloud-Provider</code></td>
<td>与云交互进行节点的增删操作，每个支持 CA 的主流厂商都实现自己的 Plugin 实现动态缩放</td>
</tr>
</tbody></table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/image-20231004150335712.png" alt="image-20231004150335712"></p>
<h2 id="扩展机制"><a href="#扩展机制" class="headerlink" title="扩展机制"></a>扩展机制</h2><ol>
<li>为了<code>自动创建和初始化 Node</code>，Cluster Autoscaler 要求 Node <code>必须属于</code>某个 <code>Node Group</code>（每个云厂商实现不一）</li>
<li>当集群中有<code>多个 Node Group</code>，可以通过 <code>--expander</code> 来配置选择 Node Group 的策略</li>
</ol>
<table>
<thead>
<tr>
<th>Expander</th>
<th>Strategy</th>
</tr>
</thead>
<tbody><tr>
<td><code>random</code></td>
<td>随机选择</td>
</tr>
<tr>
<td><code>most-pods</code></td>
<td>选择容量最大（可以创建最多 Pod）的 Node Group</td>
</tr>
<tr>
<td><code>least-waste</code></td>
<td>以最少浪费原则选择</td>
</tr>
<tr>
<td><code>price</code></td>
<td>选择最便宜的 Node Group</td>
</tr>
</tbody></table>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/12/13/cloud-native-foundation-k8s-manage-production-clusters/">https://blog.zhongmingmao.top/2022/12/13/cloud-native-foundation-k8s-manage-production-clusters/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/cloud-native-foundation/">Cloud Native Foundation</a><a class="post-meta__tags" href="/tags/kubernetes/">Kubernetes</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/12/14/cloud-native-foundation-k8s-production-ops/" title="Kubernetes - Production Ops"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-ops.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes - Production Ops</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/12/cloud-native-foundation-k8s-service-discovery/" title="Kubernetes - Service Discovery"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-service-discovery.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Kubernetes - Service Discovery</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/12/15/cloud-native-foundation-k8s-devops/" title="Kubernetes - DevOps"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/devops.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-15</div><div class="title">Kubernetes - DevOps</div></div></a></div><div><a href="/2022/12/14/cloud-native-foundation-k8s-production-ops/" title="Kubernetes - Production Ops"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-ops.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-14</div><div class="title">Kubernetes - Production Ops</div></div></a></div><div><a href="/2022/12/12/cloud-native-foundation-k8s-service-discovery/" title="Kubernetes - Service Discovery"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/kubernetes-service-discovery.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">Kubernetes - Service Discovery</div></div></a></div><div><a href="/2022/12/10/cloud-native-foundation-k8s-pod-life-cycle/" title="Kubernetes - Pod Life Cycle"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/pod-life-cycle.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-10</div><div class="title">Kubernetes - Pod Life Cycle</div></div></a></div><div><a href="/2022/12/09/cloud-native-foundation-k8s-csi/" title="Kubernetes - CSI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/k8s-csi.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-09</div><div class="title">Kubernetes - CSI</div></div></a></div><div><a href="/2022/12/08/cloud-native-foundation-k8s-cni-v2/" title="Kubernetes - CNI"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/k8s/cni-logo-card.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-08</div><div class="title">Kubernetes - CNI</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">485</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">125</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">65</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.</span> <span class="toc-text">操作系统</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E8%B5%84%E6%BA%90"><span class="toc-number">2.</span> <span class="toc-text">节点资源</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NUMA"><span class="toc-number">2.1.</span> <span class="toc-text">NUMA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E4%B8%8A%E6%8A%A5"><span class="toc-number">2.2.</span> <span class="toc-text">状态上报</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lease-%E5%BF%83%E8%B7%B3"><span class="toc-number">2.2.1.</span> <span class="toc-text">Lease - 心跳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%A2%84%E7%95%99"><span class="toc-number">2.3.</span> <span class="toc-text">资源预留</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Capacity-x2F-Allocatable"><span class="toc-number">2.3.1.</span> <span class="toc-text">Capacity &#x2F; Allocatable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86"><span class="toc-number">2.4.</span> <span class="toc-text">磁盘管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E9%80%90%E7%AE%A1%E7%90%86"><span class="toc-number">2.5.</span> <span class="toc-text">驱逐管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7"><span class="toc-number">2.6.</span> <span class="toc-text">资源监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E9%80%90%E7%AD%96%E7%95%A5"><span class="toc-number">2.7.</span> <span class="toc-text">驱逐策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%89%BF%E5%8E%8B"><span class="toc-number">2.7.1.</span> <span class="toc-text">内存承压</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E6%89%BF%E5%8E%8B"><span class="toc-number">2.7.2.</span> <span class="toc-text">磁盘承压</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="toc-number">2.8.</span> <span class="toc-text">资源配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU"><span class="toc-number">2.8.1.</span> <span class="toc-text">CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory"><span class="toc-number">2.8.2.</span> <span class="toc-text">Memory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OOM-Killer"><span class="toc-number">2.9.</span> <span class="toc-text">OOM Killer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86"><span class="toc-number">2.10.</span> <span class="toc-text">日志管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E5%8D%B7%E7%AE%A1%E7%90%86"><span class="toc-number">2.11.</span> <span class="toc-text">Docker 卷管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%B5%84%E6%BA%90"><span class="toc-number">2.12.</span> <span class="toc-text">网络资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%95%B0"><span class="toc-number">2.13.</span> <span class="toc-text">进程数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%A3%80%E6%B5%8B"><span class="toc-number">3.</span> <span class="toc-text">节点检测</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E5%88%86%E7%B1%BB"><span class="toc-number">3.1.</span> <span class="toc-text">故障分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%87%E6%8A%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">汇报方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Addon"><span class="toc-number">3.3.</span> <span class="toc-text">Addon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.4.</span> <span class="toc-text">异常处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%8A%E6%96%AD%E6%96%B9%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">诊断方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SSH"><span class="toc-number">4.1.</span> <span class="toc-text">SSH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="toc-number">4.2.</span> <span class="toc-text">查看日志</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E8%B5%84%E6%BA%90"><span class="toc-number">5.</span> <span class="toc-text">扩展资源</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B5%84%E6%BA%90"><span class="toc-number">5.1.</span> <span class="toc-text">配置资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B5%84%E6%BA%90"><span class="toc-number">5.2.</span> <span class="toc-text">使用资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">5.3.</span> <span class="toc-text">集群</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">6.</span> <span class="toc-text">高可用集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%B1%82%E7%BA%A7"><span class="toc-number">6.1.</span> <span class="toc-text">高可用层级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDC"><span class="toc-number">6.2.</span> <span class="toc-text">IDC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Node-Lifecycle"><span class="toc-number">6.3.</span> <span class="toc-text">Node Lifecycle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E7%AE%A1%E7%90%86"><span class="toc-number">6.4.</span> <span class="toc-text">主机管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2"><span class="toc-number">6.5.</span> <span class="toc-text">控制平面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4-1"><span class="toc-number">6.6.</span> <span class="toc-text">高可用集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85"><span class="toc-number">6.7.</span> <span class="toc-text">集群安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubespray"><span class="toc-number">6.7.1.</span> <span class="toc-text">Kubespray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cluster-API"><span class="toc-number">6.7.2.</span> <span class="toc-text">Cluster API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2"><span class="toc-number">6.7.2.1.</span> <span class="toc-text">角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B"><span class="toc-number">6.7.2.2.</span> <span class="toc-text">模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kind"><span class="toc-number">6.7.2.3.</span> <span class="toc-text">Kind</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cluster-Autoscaler"><span class="toc-number">7.</span> <span class="toc-text">Cluster Autoscaler</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="toc-number">7.1.</span> <span class="toc-text">工作机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">7.2.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6"><span class="toc-number">7.3.</span> <span class="toc-text">扩展机制</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/27/go-paradigm-functional-options/" title="Go Paradigm - Functional Options"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/paradigm/functional-options-in-go.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go Paradigm - Functional Options"/></a><div class="content"><a class="title" href="/2023/01/27/go-paradigm-functional-options/" title="Go Paradigm - Functional Options">Go Paradigm - Functional Options</a><time datetime="2023-01-26T16:06:25.000Z" title="Created 2023-01-27 00:06:25">2023-01-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/26/go-foundation-pointer/" title="Go - Pointer"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-pointer.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Pointer"/></a><div class="content"><a class="title" href="/2023/01/26/go-foundation-pointer/" title="Go - Pointer">Go - Pointer</a><time datetime="2023-01-25T16:06:25.000Z" title="Created 2023-01-26 00:06:25">2023-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/25/go-foundation-type-constraint/" title="Go - Type Constraint"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-constraint.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Type Constraint"/></a><div class="content"><a class="title" href="/2023/01/25/go-foundation-type-constraint/" title="Go - Type Constraint">Go - Type Constraint</a><time datetime="2023-01-24T16:06:25.000Z" title="Created 2023-01-25 00:06:25">2023-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/24/go-foundation-type-parameter/" title="Go - Type Parameter"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-generics-01.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - Type Parameter"/></a><div class="content"><a class="title" href="/2023/01/24/go-foundation-type-parameter/" title="Go - Type Parameter">Go - Type Parameter</a><time datetime="2023-01-23T16:06:25.000Z" title="Created 2023-01-24 00:06:25">2023-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/23/go-foundation-gc/" title="Go - GC"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-1253868755.cos.ap-guangzhou.myqcloud.com/foundation/go-gc-1533114.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go - GC"/></a><div class="content"><a class="title" href="/2023/01/23/go-foundation-gc/" title="Go - GC">Go - GC</a><time datetime="2023-01-22T16:06:25.000Z" title="Created 2023-01-23 00:06:25">2023-01-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2023 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
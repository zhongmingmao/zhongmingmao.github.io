<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Cloud Native - Security &amp; Compliance - OPA - Introduction | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Overview The Open Policy Agent is an general-purpose policy engine that unifies policy enforcement across the stack. OPA provides a high-level declarative language that lets you specify policy as code">
<meta property="og:type" content="article">
<meta property="og:title" content="Cloud Native - Security &amp; Compliance - OPA - Introduction">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/03/31/cloud-native-security-compliance-opa-introduction/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="Overview The Open Policy Agent is an general-purpose policy engine that unifies policy enforcement across the stack. OPA provides a high-level declarative language that lets you specify policy as code">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png">
<meta property="article:published_time" content="2022-03-30T16:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.571Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="OPA">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="Compliance">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Cloud Native - Security & Compliance - OPA - Introduction",
  "url": "https://blog.zhongmingmao.top/2022/03/31/cloud-native-security-compliance-opa-introduction/",
  "image": "https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png",
  "datePublished": "2022-03-30T16:06:25.000Z",
  "dateModified": "2023-04-03T10:04:59.571Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/03/31/cloud-native-security-compliance-opa-introduction/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Cloud Native - Security & Compliance - OPA - Introduction',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">640</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Cloud Native - Security &amp; Compliance - OPA - Introduction</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Cloud Native - Security &amp; Compliance - OPA - Introduction</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-03-30T16:06:25.000Z" title="Created 2022-03-31 00:06:25">2022-03-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/security-compliance/">Security &amp; Compliance</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">3.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>19mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-04-03 18:04:59&quot;}" hidden></div><h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><ol>
<li>The Open Policy Agent is an <strong>general-purpose policy engine</strong> that <strong>unifies policy enforcement across the stack</strong>.</li>
<li>OPA provides a <strong>high-level declarative language</strong><ul>
<li>that lets you <strong>specify policy as code and simple APIs</strong> to <strong>offload policy decision-making</strong> from your software.</li>
</ul>
</li>
<li>OPA <strong>decouples</strong> policy <strong>decision-making</strong> from policy <strong>enforcement</strong>.</li>
<li>When your software needs to make policy decisions it <strong>queries</strong> OPA and supplies structured data (e.g., JSON) as input.<ul>
<li>OPA accepts <strong>arbitrary structured data</strong> as <strong>input</strong>.</li>
</ul>
</li>
<li>OPA generates policy decisions by evaluating the <strong>query input</strong> against <strong>policies</strong> and <strong>data</strong>.</li>
<li>OPA and Rego are <strong>domain-agnostic</strong> so you can describe almost any kind of invariant in your policies.</li>
<li>Policy decisions are not limited to simple yes&#x2F;no or allow&#x2F;deny answers.<ul>
<li>Like query inputs, your policies can generate <strong>arbitrary structured data</strong> as <strong>output</strong>.</li>
</ul>
</li>
</ol>
<span id="more"></span>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cn-security-1253868755.cos.ap-guangzhou.myqcloud.com/opa-service.svg" alt="opa-service"></p>
<h1 id="System"><a href="#System" class="headerlink" title="System"></a>System</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cn-security-1253868755.cos.ap-guangzhou.myqcloud.com/system.svg"></p>
<p>The script receives a <strong>JSON</strong> representation of the system as <strong>input</strong></p>
<figure class="highlight json"><figcaption><span>input.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="Rego"><a href="#Rego" class="headerlink" title="Rego"></a>Rego</h1><blockquote>
<p>Rego is <strong>purpose-built</strong> for <strong>expressing policies</strong> over <strong>complex hierarchical data structures</strong>.</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>When OPA evaluates policies it binds data <strong>provided in the query</strong> to a global variable called <strong>input</strong>.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;input.ports&#x27;                              </span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.protocols<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span>&#x27;</span><br><span class="line"><span class="string">&quot;ssh&quot;</span></span><br></pre></td></tr></table></figure>

<p>You can use the same square bracket syntax if keys contain <strong>other than</strong> <code>[a-zA-Z0-9_]</code>. E.g., <code>input[&quot;real~name&quot;]</code>.</p>
<figure class="highlight json"><figcaption><span>input-name.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;real~name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhongmingmao&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input-name.json &#x27;input.real~name&#x27;</span><br><span class="line">1 error occurred: 1:11: rego_parse_error: illegal token</span><br><span class="line">        input.real~name</span><br><span class="line">                  ^</span><br><span class="line"></span><br><span class="line">❯ opa eval -f pretty -i input-name.json &#x27;input[&quot;real~name&quot;]&#x27;</span><br><span class="line">&quot;zhongmingmao&quot;</span><br></pre></td></tr></table></figure>

<p>If you refer to a value that <strong>does not exist</strong>, OPA returns <strong>undefined</strong>. Undefined means that OPA was <strong>not able to find any results</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;input.dead&#x27;</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<h2 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h2><p>To <strong>produce policy decisions</strong> in Rego you write expressions against <strong>input</strong> and <strong>other data</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;input.servers[0].id == &quot;app&quot;&#x27;</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>OPA includes <strong>a set of built-in functions</strong> you can use to perform <strong>common operations</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;count(input.servers[0].protocols) == 2&#x27;</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p><strong>Multiple</strong> expressions are joined together with the <code>;</code> (<strong>AND</strong>) operator.<br>For queries to <strong>produce</strong> results, <strong>all</strong> of the expressions in the query must be <strong>true</strong> or <strong>defined</strong>. The <strong>order</strong> of expressions <strong>does not matter</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;input.servers[0].id == &quot;app&quot;; input.servers[0].protocols[1] == &quot;ssh&quot;&#x27;</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f json -i input.json &#x27;input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.id == <span class="string">&quot;app&quot;</span>; input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.protocols<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> == <span class="string">&quot;ssh&quot;</span>&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expressions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;input.servers[0].id == \&quot;app\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;input.servers[0].protocols[1] == \&quot;ssh\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">31</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>You can <strong>omit</strong> the <code>;</code> (<strong>AND</strong>) operator by splitting expressions across <strong>multiple lines</strong>. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">input.servers[0].id == &quot;app&quot;</span><br><span class="line">input.servers[0].protocols[0] == &quot;https&quot;</span><br><span class="line">&#x27;</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>If <strong>any</strong> of the expressions in the query are <strong>not true</strong> (or <strong>not defined</strong>) the result is <strong>undefined</strong> (<strong>not false</strong>).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">input.servers[0].id == &quot;app&quot;</span><br><span class="line">input.servers[0].protocols[0] == &quot;telnet&quot;</span><br><span class="line">&#x27;</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<h2 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h2><p>You can <strong>store values</strong> in <strong>intermediate variables</strong> using the <code>:=</code> (<strong>assignment</strong>) operator.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">s := input.servers[0]</span><br><span class="line">s.id == &quot;app&quot;</span><br><span class="line">p := s.protocols[0]</span><br><span class="line">p == &quot;https&quot;</span><br><span class="line">&#x27;</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">|    p    |                                 s                                 |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">| &quot;https&quot; | &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f bindings -i input.json &#x27;</span><br><span class="line">s <span class="punctuation">:</span>= input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">s.id == <span class="string">&quot;app&quot;</span></span><br><span class="line">p <span class="punctuation">:</span>= s.protocols<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">p == <span class="string">&quot;https&quot;</span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;s&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p3&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;ssh&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f values -i input.json &#x27;</span><br><span class="line">s <span class="punctuation">:</span>= input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">s.id == <span class="string">&quot;app&quot;</span></span><br><span class="line">p <span class="punctuation">:</span>= s.protocols<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">p == <span class="string">&quot;https&quot;</span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>When OPA evaluates expressions, it <strong>finds values for the variables</strong> that make <strong>all</strong> of the expressions <strong>true</strong>.<br>If there are <strong>no variable assignments</strong> that make <strong>all</strong> of the expressions <strong>true</strong>, the result is <strong>undefined</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">s := input.servers[0]</span><br><span class="line">s.id == &quot;app&quot;</span><br><span class="line">s.protocols[1] == &quot;telent&quot;</span><br><span class="line">&#x27;</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f json -i input.json &#x27;</span><br><span class="line">s <span class="punctuation">:</span>= input.servers<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">s.id == <span class="string">&quot;app&quot;</span></span><br><span class="line">s.protocols<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> == <span class="string">&quot;telent&quot;</span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Variables are <strong>immutable</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f bindings -i input.json &#x27;</span><br><span class="line">s := input.servers[0]</span><br><span class="line">s := input.servers[0]</span><br><span class="line">&#x27;</span><br><span class="line">1 error occurred: 3:1: rego_compile_error: var s assigned above</span><br></pre></td></tr></table></figure>

<p>OPA must be able to <strong>enumerate the values for all variables</strong> in all expressions.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f bindings -i input.json &#x27;</span><br><span class="line">x := 1</span><br><span class="line">x != y</span><br><span class="line">&#x27;</span><br><span class="line">2 errors occurred:</span><br><span class="line">3:1: rego_unsafe_var_error: var y is unsafe</span><br><span class="line">3:1: rego_unsafe_var_error: var _ is unsafe</span><br></pre></td></tr></table></figure>

<h2 id="Iteration"><a href="#Iteration" class="headerlink" title="Iteration"></a>Iteration</h2><p>Iteration in Rego happens <strong>implicitly</strong> when you <strong>inject variables into expressions</strong>.</p>
<h3 id="Implicitly"><a href="#Implicitly" class="headerlink" title="Implicitly"></a>Implicitly</h3><p>Substitute the <strong>array index</strong> with a <strong>variable</strong>. Now the query asks for <strong>values of <code>i</code></strong> that make the <strong>overall</strong> expression <strong>true</strong>.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f json -i input.json &#x27;</span><br><span class="line">some i</span><br><span class="line">input.networks<span class="punctuation">[</span>i<span class="punctuation">]</span>.public = <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expressions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;input.networks[i].public = true&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bindings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;i&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expressions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;input.networks[i].public = true&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bindings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;i&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f bindings -i input.json &#x27;</span><br><span class="line">some i</span><br><span class="line">input.networks<span class="punctuation">[</span>i<span class="punctuation">]</span>.public = <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;i&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;i&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f values -i input.json &#x27;</span><br><span class="line">some i</span><br><span class="line">input.networks<span class="punctuation">[</span>i<span class="punctuation">]</span>.public = <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">some i</span><br><span class="line">input.networks[i].public = true</span><br><span class="line">&#x27;</span><br><span class="line">+---+</span><br><span class="line">| i |</span><br><span class="line">+---+</span><br><span class="line">| 2 |</span><br><span class="line">| 3 |</span><br><span class="line">+---+</span><br></pre></td></tr></table></figure>

<p>You can substitute as <strong>many</strong> variables as you want.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">some i, j</span><br><span class="line">input.servers[i].protocols[j] == &quot;http&quot;</span><br><span class="line">&#x27;</span><br><span class="line">+---+---+</span><br><span class="line">| i | j |</span><br><span class="line">+---+---+</span><br><span class="line">| 3 | 0 |</span><br><span class="line">+---+---+</span><br></pre></td></tr></table></figure>

<p>If variables appear <strong>multiple times</strong> the assignments satisfy <strong>all</strong> of the expressions.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">some i, j</span><br><span class="line">port_id := input.ports[i].id</span><br><span class="line">input.ports[i].network == input.networks[j].id</span><br><span class="line">input.networks[j].public == true</span><br><span class="line">&#x27;</span><br><span class="line">+---+---+---------+</span><br><span class="line">| i | j | port_id |</span><br><span class="line">+---+---+---------+</span><br><span class="line">| 1 | 2 | &quot;p2&quot;    |</span><br><span class="line">+---+---+---------+</span><br></pre></td></tr></table></figure>

<p>If you only <strong>refer to the variable once</strong>, you can replace it with the special <code>_</code> (<strong>wildcard</strong> variable) operator. <strong>no bindings !</strong><br>Conceptually, <strong>each instance</strong> of <code>_</code> is a <strong>unique variable</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;  </span><br><span class="line">input.servers[_].protocols[_] == &quot;http&quot;</span><br><span class="line">&#x27;</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f json -i input.json &#x27;  </span><br><span class="line">input.servers<span class="punctuation">[</span>_<span class="punctuation">]</span>.protocols<span class="punctuation">[</span>_<span class="punctuation">]</span> == <span class="string">&quot;http&quot;</span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expressions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;input.servers[_].protocols[_] == \&quot;http\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f bindings -i input.json &#x27;</span><br><span class="line">input.servers<span class="punctuation">[</span>_<span class="punctuation">]</span>.protocols<span class="punctuation">[</span>_<span class="punctuation">]</span> == <span class="string">&quot;http&quot;</span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>If OPA is <strong>unable</strong> to find <strong>any variable assignments</strong> that <strong>satisfy all of the expressions</strong>, the result is <strong>undefined</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json &#x27;</span><br><span class="line">some i</span><br><span class="line">input.servers[i].protocols[i] == &quot;ssh&quot;</span><br><span class="line">&#x27;</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f json -i input.json &#x27;  </span><br><span class="line">some i</span><br><span class="line">input.servers[i].protocols[i] == &quot;ssh&quot;</span><br><span class="line">&#x27;</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explicitly"><a href="#Explicitly" class="headerlink" title="Explicitly"></a>Explicitly</h3><h4 id="some"><a href="#some" class="headerlink" title="some"></a>some</h4><p><code>some ... in ...</code> is used to iterate over the <strong>collection</strong>, and will bind its <strong>variables</strong> to the <strong>collection items</strong>.</p>
<figure class="highlight go"><figcaption><span>public_network.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.in</span><br><span class="line"></span><br><span class="line">public_network[net.id] &#123;</span><br><span class="line">    some net in input.networks</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f json -i input.json -d public_network.rego &#x27;data.example.public_network&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expressions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;net4&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data.example.public_network&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="every"><a href="#every" class="headerlink" title="every"></a>every</h4><p>Importing <code>every</code> means also importing <code>in</code> without an extra <code>import</code> statement.<br><code>every</code> allows us to succinctly express that <strong>a condition holds</strong> for <strong>all elements</strong> of a domain.</p>
<figure class="highlight json"><figcaption><span>exposed.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ftp&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>every.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.every</span><br><span class="line"></span><br><span class="line">no_telnet_exposed_every &#123;</span><br><span class="line">    every server in input.servers &#123;</span><br><span class="line">        every protocol in server.protocols &#123;</span><br><span class="line">            <span class="string">&quot;telnet&quot;</span> != protocol</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">no_telnet_exposed_every_not_in &#123;</span><br><span class="line">    every server in input.servers &#123;</span><br><span class="line">        not <span class="string">&quot;telnet&quot;</span> in server.protocols</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">no_telnet_exposed_not_some_in &#123;</span><br><span class="line">    not any_telnet_exposed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">any_telnet_exposed &#123;</span><br><span class="line">    some server in input.servers</span><br><span class="line">    <span class="string">&quot;telnet&quot;</span> in server.protocols</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i exposed.json -d every.rego &#x27;data.example&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;no_telnet_exposed_every&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;no_telnet_exposed_every_not_in&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;no_telnet_exposed_not_some_in&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">❯ opa eval -f json -i exposed.json -d every.rego &#x27;data.example.any_telnet_exposed&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h2><p>Rego lets you <strong>encapsulate</strong> and <strong>re-use</strong> logic with rules. Rules are just <strong>if-then logic statements</strong>. </p>
<h3 id="Complete"><a href="#Complete" class="headerlink" title="Complete"></a>Complete</h3><p>Complete rules are <strong>if-then statements</strong> that <strong>assign a single value to a variable</strong>.</p>
<figure class="highlight go"><figcaption><span>complete.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords.every</span><br><span class="line"></span><br><span class="line">any_public_networks_1 = <span class="literal">true</span> &#123;</span><br><span class="line">    some i</span><br><span class="line">    input.networks[i].public</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">any_public_networks_2 = <span class="literal">true</span> &#123;</span><br><span class="line">    input.networks[_].public</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">any_public_networks_3 = <span class="literal">true</span> &#123;</span><br><span class="line">    net := input.networks[_]</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">any_public_networks_4 = <span class="literal">true</span> &#123;</span><br><span class="line">    some net in input.networks</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">any_public_networks_5 = <span class="literal">true</span> &#123;</span><br><span class="line">    not all_private_network</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">all_private_network = <span class="literal">true</span> &#123;</span><br><span class="line">    every net in input.networks &#123;</span><br><span class="line">        not net.public</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>All values generated by rules</strong> can be queried via the global <strong>data</strong> variable. <code>data.&lt;package-path&gt;.&lt;rule-name&gt;</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json -d complete.rego &#x27;data.example&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;any_public_networks_1&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;any_public_networks_2&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;any_public_networks_3&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;any_public_networks_4&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;any_public_networks_5&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Every rule consists of a <strong>head</strong> and a <strong>body</strong>. rule <strong>head is true</strong> if the rule <strong>body is true</strong></p>
<blockquote>
<p>head: <code>any_public_networks = true</code>; body: <code>input.networks[_].public</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks = <span class="literal">true</span> &#123;</span><br><span class="line">    input.networks[_].public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you <strong>omit</strong> the <code>= &lt;value&gt;</code> part of the <strong>rule head</strong> the value defaults to <strong>true</strong>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks &#123;</span><br><span class="line">    input.networks[_].public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To define <strong>constants</strong>, <strong>omit</strong> the <strong>rule body</strong>.</p>
<figure class="highlight go"><figcaption><span>constant.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line">pi = <span class="number">3.14</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json -d constant.rego &#x27;data.example.pi &gt; 3&#x27;</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>If OPA cannot find <strong>variable assignments</strong> that <strong>satisfy the rule body</strong>, we say that the <strong>rule is undefined</strong>.</p>
<figure class="highlight json"><figcaption><span>private.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;n1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;n2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>undefined.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line">any_public_network &#123;</span><br><span class="line">    input.networks[_].public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i private.json -d undefined.rego &#x27;data.example.any_public_network&#x27;</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<h3 id="Partial"><a href="#Partial" class="headerlink" title="Partial"></a>Partial</h3><p>Partial rules are <strong>if-then statements</strong> that <strong>generate a set of values</strong> and <strong>assign that set to a variable</strong>.</p>
<blockquote>
<p>head: <code>public_network[net.id]</code>; body: <code>net := input.networks[_]; net.public</code></p>
</blockquote>
<figure class="highlight go"><figcaption><span>partial.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line">public_network[net.id] &#123;</span><br><span class="line">    net := input.networks[_]</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can <strong>iterate over the set of values</strong> by referencing the set elements with a variable</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json -d partial.rego &#x27;data.example.public_network[x]&#x27;</span><br><span class="line">+--------+--------------------------------+</span><br><span class="line">|   x    | data.example.public_network[x] |</span><br><span class="line">+--------+--------------------------------+</span><br><span class="line">| &quot;net3&quot; | &quot;net3&quot;                         |</span><br><span class="line">| &quot;net4&quot; | &quot;net4&quot;                         |</span><br><span class="line">+--------+--------------------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f values -i input.json -d partial.rego &#x27;data.example.public_network<span class="punctuation">[</span>x<span class="punctuation">]</span>&#x27;</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="string">&quot;net3&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="string">&quot;net4&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f bindings -i input.json -d partial.rego &#x27;data.example.public_network<span class="punctuation">[</span>x<span class="punctuation">]</span>&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f json -i input.json -d partial.rego &#x27;data.example.public_network<span class="punctuation">[</span>x<span class="punctuation">]</span>&#x27;</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expressions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data.example.public_network[x]&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bindings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expressions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data.example.public_network[x]&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;col&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bindings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>no bindings !</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json -d partial.rego &#x27;data.example.public_network[_]&#x27;</span><br><span class="line">+--------------------------------+</span><br><span class="line">| data.example.public_network[_] |</span><br><span class="line">+--------------------------------+</span><br><span class="line">| &quot;net3&quot;                         |</span><br><span class="line">| &quot;net4&quot;                         |</span><br><span class="line">+--------------------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json -d partial.rego &#x27;data.example.public_network[&quot;net3&quot;]&#x27;</span><br><span class="line">&quot;net3&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json -d partial.rego &#x27;data.example.public_network[&quot;unknown_net&quot;]&#x27;</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<h3 id="Logic-OR"><a href="#Logic-OR" class="headerlink" title="Logic OR"></a>Logic OR</h3><p>When you <strong>join multiple expressions together</strong> in a query you are expressing logical <strong>AND</strong>.<br>To express logical <strong>OR</strong> in Rego you <strong>define multiple rules with the same name</strong>.</p>
<figure class="highlight json"><figcaption><span>or.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">,</span> <span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p> <code>default</code> : assign a <strong>default value</strong> to the variable if <strong>all</strong> of the other rules with the <strong>same name</strong> are <strong>undefined</strong>.</p>
<figure class="highlight go"><figcaption><span>or.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> shell_accessible_default = <span class="literal">false</span> <span class="comment">// not undefined !</span></span><br><span class="line"></span><br><span class="line">shell_accessible_or &#123;</span><br><span class="line">    input.servers[_].protocols[_] == <span class="string">&quot;telnet&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible_or &#123;</span><br><span class="line">    input.servers[_].protocols[_] == <span class="string">&quot;ssh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible_default &#123;</span><br><span class="line">    input.servers[_].protocols[_] == <span class="string">&quot;telnet_x&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible_no_default &#123;</span><br><span class="line">    input.servers[_].protocols[_] == <span class="string">&quot;ssh_x&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i or.json -d or.rego &#x27;data.example&#x27;                            </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;shell_accessible_default&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shell_accessible_or&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i or.json -d or.rego &#x27;data.example.shell_accessible_no_default&#x27;</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>

<p>When you use <strong>logical OR</strong> with <strong>partial rules</strong>, each rule definition <strong>contributes</strong> to the set of values assigned to the variable.</p>
<figure class="highlight json"><figcaption><span>partial_or.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">,</span> <span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>partial_or.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;telnet&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;ssh&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i partial_or.json -d partial_or.rego &#x27;data.example.shell_accessible&#x27;</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="string">&quot;db&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h2 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. Servers reachable from the Internet must not expose the insecure &#x27;http&#x27; protocol.</span><br><span class="line">2. Servers are not allowed to expose the &#x27;telnet&#x27; protocol.</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>practice_1.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> practice_1</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> allow = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">public_servers[server] &#123;</span><br><span class="line">    some server in input.servers</span><br><span class="line"></span><br><span class="line">    some port in server.ports</span><br><span class="line">    some input_port in input.ports</span><br><span class="line">    port == input_port.id</span><br><span class="line"></span><br><span class="line">    some net in input.networks</span><br><span class="line">    input_port.network == net.id</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;</span><br><span class="line">    some server in input.servers</span><br><span class="line">    <span class="string">&quot;telnet&quot;</span> in server.protocols</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;</span><br><span class="line">    some server in public_servers</span><br><span class="line">    <span class="string">&quot;http&quot;</span> in server.protocols</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">    count(violation) == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><figcaption><span>practice_2.rego</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> practice_2</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> future.keywords</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> allow = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">public_servers[server] &#123;</span><br><span class="line">    some i, j</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.ports[_] == input.ports[i].id</span><br><span class="line">    input.ports[i].network == input.networks[j].id</span><br><span class="line">    input.networks[j].public</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;telnet&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;</span><br><span class="line">    server := public_servers[_]</span><br><span class="line">    server.protocols[_] == <span class="string">&quot;http&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">    count(violation) == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">❯ opa eval -f pretty -i input.json -d practice_1.rego -d practice_2.rego &#x27;x = data.practice_1.violation; y = data.practice_2.violation&#x27;</span><br><span class="line">+------------------+------------------+</span><br><span class="line">|        x         |        y         |</span><br><span class="line">+------------------+------------------+</span><br><span class="line">| [&quot;busybox&quot;,&quot;ci&quot;] | [&quot;busybox&quot;,&quot;ci&quot;] |</span><br><span class="line">+------------------+------------------+</span><br></pre></td></tr></table></figure>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/03/31/cloud-native-security-compliance-opa-introduction/">https://blog.zhongmingmao.top/2022/03/31/cloud-native-security-compliance-opa-introduction/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/opa/">OPA</a><a class="post-meta__tags" href="/tags/security/">Security</a><a class="post-meta__tags" href="/tags/compliance/">Compliance</a></div><div class="post-share"><div class="social-share" data-image="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/04/01/cloud-native-security-compliance-opa-philosophy/" title="Cloud Native - Security &amp; Compliance - OPA - Philosophy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Cloud Native - Security & Compliance - OPA - Philosophy</div></div><div class="info-2"><div class="info-item-1">Overview A policy is a set of rules that governs the behavior of a software service. Authorization is a special kind of policy. difference Authentication: how people or machines prove they are who they say they are. Authorization: which people or machines can run which actions on which resources.   Authorization and more generally policy often utilize the results of authentication (the username, user attributes, groups, claims), but makes decisions based on far more information than just who the user is....</div></div></div></a><a class="pagination-related" href="/2022/03/30/cloud-native-security-compliance-opa-glance/" title="Cloud Native - Security &amp; Compliance - OPA - Glance"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-24.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Cloud Native - Security & Compliance - OPA - Glance</div></div><div class="info-2"><div class="info-item-1">Overview Policy-based control for cloud native environments Flexible, fine-grained control for administrators across the stack Use OPA for a unified toolset and framework for policy across the cloud native stack.   Decouple policy from the service’s code, so you can release, analyze, and review policies without sacrificing availability or performance.  Declarative Policy Declarative Express policy in a high-level, declarative language that promotes safe, performant, fine-grained controls. DSL : Use a lan...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2022/04/01/cloud-native-security-compliance-opa-philosophy/" title="Cloud Native - Security &amp; Compliance - OPA - Philosophy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-01</div><div class="info-item-2">Cloud Native - Security &amp; Compliance - OPA - Philosophy</div></div><div class="info-2"><div class="info-item-1">Overview A policy is a set of rules that governs the behavior of a software service. Authorization is a special kind of policy. difference Authentication: how people or machines prove they are who they say they are. Authorization: which people or machines can run which actions on which resources.   Authorization and more generally policy often utilize the results of authentication (the username, user attributes, groups, claims), but makes decisions based on far more information than just who the user is....</div></div></div></a><a class="pagination-related" href="/2022/03/30/cloud-native-security-compliance-opa-glance/" title="Cloud Native - Security &amp; Compliance - OPA - Glance"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-24.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-30</div><div class="info-item-2">Cloud Native - Security &amp; Compliance - OPA - Glance</div></div><div class="info-2"><div class="info-item-1">Overview Policy-based control for cloud native environments Flexible, fine-grained control for administrators across the stack Use OPA for a unified toolset and framework for policy across the cloud native stack.   Decouple policy from the service’s code, so you can release, analyze, and review policies without sacrificing availability or performance.  Declarative Policy Declarative Express policy in a high-level, declarative language that promotes safe, performant, fine-grained controls. DSL : Use a lan...</div></div></div></a><a class="pagination-related" href="/2022/12/27/cloud-native-foundation-security-opa-ops/" title="Security - OPA Operation"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-ops.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="info-item-2">Security - OPA Operation</div></div><div class="info-2"><div class="info-item-1">ConfigurationExample1$ opa run -s -c config.yaml  12345678910111213$ opa run --server \--log-format=json-pretty \--set=decision_logs.console=true \--set=services.A.url=http://my-bundles:8080/api/opa/bundle/ \--set=bundles.A.service=A \--set=bundles.A.polling.long_polling_timeout_seconds=45 \--set=bundles.A.resource=A.tar.gz \--set=services.B.url=http://my-bundles:8080/api/opa/bundle/ \--set=bundles.B.service=B \--set=bundles.B.polling.long_polling_timeout_seconds=45 \--set=bundles.B.resource=B.tar.gz \  ...</div></div></div></a><a class="pagination-related" href="/2022/12/26/cloud-native-foundation-security-opa-management/" title="Security - OPA Management"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-management-7474053.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-26</div><div class="info-item-2">Security - OPA Management</div></div><div class="info-2"><div class="info-item-1">Overview &amp; Architecture OPA exposes a set of APIs that enable unified, logically centralized policy management. Read this page if you are interested in how to build a control plane around OPA that enables policy distribution and collection of important telemetry data like decision logs.     OPA enables low-latency, highly-available policy enforcement by providing a lightweight engine for distributed architectures.By default, all of the policy and data that OPA uses to make decisions is kept in-memory...</div></div></div></a><a class="pagination-related" href="/2022/12/25/cloud-native-foundation-security-opa-gatekeeper/" title="Security - OPA Gatekeeper"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-gatekeeper.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-25</div><div class="info-item-2">Security - OPA Gatekeeper</div></div><div class="info-2"><div class="info-item-1">Overview &amp; Architecture In Kubernetes, Admission Controllers enforce policies on objects during create, update, and delete operations.Admission control is fundamental to policy enforcement in Kubernetes.   For example, by deploying OPA as an admission controller you can   Require specific labels on all resources. Require container images come from the corporate image registry. Require all Pods specify resource requests and limits. Prevent conflicting Ingress objects from being created.     Admission ...</div></div></div></a><a class="pagination-related" href="/2022/12/24/cloud-native-foundation-security-opa-core/" title="Security - OPA Core"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/opa/opa-7255236.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-24</div><div class="info-item-2">Security - OPA Core</div></div><div class="info-2"><div class="info-item-1">Glance Use OPA for a unified toolset and framework for policy across the cloud native stack. Use OPA to decouple policy from the service’s code so you can release, analyze, and review policies without sacrificing availability or performance. Declarative Express policy in a high-level, declarative language that promotes safe, performant, fine-grained controls. Use a language purpose-built for policy in a world where JSON is pervasive. Iterate, traverse hierarchies, and apply 150+ built-ins like string man...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">640</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#System"><span class="toc-number">2.</span> <span class="toc-text">System</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Rego"><span class="toc-number">3.</span> <span class="toc-text">Rego</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">3.1.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Expression"><span class="toc-number">3.2.</span> <span class="toc-text">Expression</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Variable"><span class="toc-number">3.3.</span> <span class="toc-text">Variable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iteration"><span class="toc-number">3.4.</span> <span class="toc-text">Iteration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Implicitly"><span class="toc-number">3.4.1.</span> <span class="toc-text">Implicitly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Explicitly"><span class="toc-number">3.4.2.</span> <span class="toc-text">Explicitly</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#some"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">some</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#every"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">every</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rule"><span class="toc-number">3.5.</span> <span class="toc-text">Rule</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Complete"><span class="toc-number">3.5.1.</span> <span class="toc-text">Complete</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partial"><span class="toc-number">3.5.2.</span> <span class="toc-text">Partial</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logic-OR"><span class="toc-number">3.5.3.</span> <span class="toc-text">Logic OR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Practice"><span class="toc-number">3.6.</span> <span class="toc-text">Practice</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/ai-agent.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - Overview"/></a><div class="content"><a class="title" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview">AI Agent - Overview</a><time datetime="2025-01-17T16:06:25.000Z" title="Created 2025-01-18 00:06:25">2025-01-18</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
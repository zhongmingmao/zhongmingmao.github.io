<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Cloud Native Foundation - Go Memory Management | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="堆内存管理Linux 进程">
<meta property="og:type" content="article">
<meta property="og:title" content="Cloud Native Foundation - Go Memory Management">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/02/12/cloud-native-foundation-go-memory-management/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="堆内存管理Linux 进程">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png">
<meta property="article:published_time" content="2022-02-11T16:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.569Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Cloud Native Foundation - Go Memory Management",
  "url": "https://blog.zhongmingmao.top/2022/02/12/cloud-native-foundation-go-memory-management/",
  "image": "https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png",
  "datePublished": "2022-02-11T16:06:25.000Z",
  "dateModified": "2023-04-03T10:04:59.569Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/02/12/cloud-native-foundation-go-memory-management/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Cloud Native Foundation - Go Memory Management',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">641</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Cloud Native Foundation - Go Memory Management</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Cloud Native Foundation - Go Memory Management</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-02-11T16:06:25.000Z" title="Created 2022-02-12 00:06:25">2022-02-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/go/">Go</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">1.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>5mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-04-03 18:04:59&quot;}" hidden></div><h1 id="堆内存管理"><a href="#堆内存管理" class="headerlink" title="堆内存管理"></a>堆内存管理</h1><h2 id="Linux-进程"><a href="#Linux-进程" class="headerlink" title="Linux 进程"></a>Linux 进程</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220207221016045.png" alt="image-20220207221016045"></p>
<span id="more"></span>

<h2 id="管理过程"><a href="#管理过程" class="headerlink" title="管理过程"></a>管理过程</h2><ol>
<li>Allocator 的职责：通过<strong>系统调用</strong>向 <strong>OS</strong> 申请内存（<strong>MB&#x2F;GB</strong>）；响应 Mutator（即应用） 的内存申请（<strong>KB</strong>）</li>
<li>Collector：交还给 Allocator，再由 Allocator 决定是否释放并归还给 OS</li>
</ol>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220209233237928.png" alt="image-20220209233237928"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220209233405928.png" alt="image-20220209233405928"></p>
<ol>
<li>初始化<strong>连续内存块</strong>为<strong>堆</strong></li>
<li>在内存申请的时候，Allocator 从堆内存的<strong>未分配区域</strong>分割小内存块</li>
<li>用<strong>链表</strong>将<strong>已分配内存</strong>连接起来</li>
<li>需要信息描述每个内存块的<strong>元数据</strong>（<strong>对象头</strong>）：大小、是否使用、下一个内存块的地址</li>
</ol>
<blockquote>
<p>Example: <em>Ruby allocates memory from the memory allocator, which in turn allocates from the kernel</em></p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/ruby_memory_alloc_interactions.png" alt="ruby_memory_alloc_interactions"></p>
<h2 id="面临挑战"><a href="#面临挑战" class="headerlink" title="面临挑战"></a>面临挑战</h2><ol>
<li>内存分配需要<strong>系统调用</strong>，在频繁分配内存的时候，系统性能较低<ul>
<li>C 的每次 <code>malloc</code> 是需要<strong>系统调用</strong>的</li>
<li>Java 的 Allocator 可以直接一次性申请大内存，然后在<strong>用户态</strong>再慢慢分配</li>
</ul>
</li>
<li><strong>多线程</strong>共享相同的内存空间，同时申请内存，需要<strong>加锁</strong>，或者采用类似 JVM 中的 <strong>TLAB</strong> 来缓解竞争</li>
<li>经过不断地内存分配和回收，<strong>内存碎片</strong>会比较严重，<strong>内存使用率低</strong></li>
</ol>
<h1 id="TCMalloc"><a href="#TCMalloc" class="headerlink" title="TCMalloc"></a>TCMalloc</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220212153356342.png" alt="image-20220212153356342"></p>
<ol>
<li><strong>Thread Cache ≈ JVM TLAB</strong></li>
<li>Go <strong>预先申请</strong>的大内存，会先放在 <strong>PageHeap</strong></li>
<li>下一级向上一级别申请内存的时候，上一级都是按<strong>一定规格</strong>分配，<strong>减少加锁的频率</strong></li>
<li>Page：内存页，<strong>8K</strong>；Go 与 OS 之间的内存申请和释放，都是以 Page 为单位</li>
<li>Span：<strong>连续</strong>内存块，<strong>Span N &#x3D; Page × N</strong></li>
<li><strong>Size Class</strong><ul>
<li>应用申请内存的大小规格，单位 Byte<ul>
<li>每个 Span 都有属性 Size Class，Span 内部的的 Page 会按照 Size Class 被<strong>预先格式化</strong></li>
</ul>
</li>
<li>举例<ul>
<li>如针对 Size Class &#x3D; 8，对应的 Page 会被切分成1024份</li>
<li>如果此时应用申请 <strong>≤</strong> 8（<strong>最佳适配</strong>原则）的内存空间，会分配上面被切分的1024份之一</li>
</ul>
</li>
</ul>
</li>
<li>Object：对象，用来存储一个变量数据的内存空间<ul>
<li>分配流程<ul>
<li>小对象：<strong>0 ~ 256KB</strong><ul>
<li><strong>ThreadCache -&gt; CentralCache -&gt; HeapPage</strong>，大部分情况下 ThreadCache 是足够的，不需要加锁</li>
</ul>
</li>
<li>中对象：<strong>258KB ~ 1MB</strong><ul>
<li>直接在 <strong>HeapPage</strong> 中选择适当大小即可</li>
</ul>
</li>
<li>大对象：<strong>＞ 1MB</strong><ul>
<li>从 <strong>Large Span Set</strong> 中<strong>选择合适数量的 Page 来组成 Span</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h1><blockquote>
<p>与 Java 不同的是，Go 在大部分情况，不需要 GC 调优，相对于 Java，在 GC 方面比较省心</p>
</blockquote>
<h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220212162357641.png" alt="image-20220212162357641"></p>
<ol>
<li>Go 的内存分配机制是从 TCMalloc 衍生，两者都是来自于 Google</li>
<li>增强 1（加快 <strong>GC 效率</strong>，利用<strong>栈上分配</strong>）：<strong>Span Class</strong> 为 <strong>134</strong> 个，<strong>Size Class</strong> 为 <strong>67</strong> 个<ul>
<li>一个 Size Class 对应两个 Span Class，一个存<strong>指针</strong>，一个存<strong>直接引用</strong><ul>
<li>存<strong>直接引用</strong>的 Span 无需 <strong>GC 扫描</strong> – 栈上分配</li>
<li>指针：指针本质上是存放变量地址的一个<strong>变量</strong>，逻辑上是<strong>独立</strong>的，可以被改变，分配在<strong>堆</strong>上，<strong>GC 是针对堆的</strong></li>
<li>直接引用：是一个<strong>别名</strong>，逻辑上是<strong>不独立</strong>的，具有依附性，分配在<strong>栈</strong>上</li>
</ul>
</li>
</ul>
</li>
<li>增强 2（加快<strong>分配效率</strong>）：Span Class 也维护了两个 <strong>Span 列表</strong>，<strong>Empty</strong> 和 <strong>Non Empty</strong><ul>
<li>Empty 语义：是否有<strong>可分配</strong>空间，true &#x3D; 没有</li>
<li>Empty：Span 双向链表，包括<strong>没有空闲对象</strong>的 Span 和 mcache 中的 Span<ul>
<li>当 Empty 中的 Span 被释放时，Span 将被移动到 Non Empty</li>
</ul>
</li>
<li>Non Empty：<strong>有空闲对象</strong>的 Span 双向链表<ul>
<li>从 mcentral 请求新 Span，先尝试从 Non Empty 获取 Span 并移动到 Empty</li>
<li>如果 mcentral 没有可用的 Span，则 mcentral 向 mheap 申请新页</li>
</ul>
</li>
</ul>
</li>
<li>增强 3：mheap 中的 Span 是按<strong>树</strong>来组织的（TCMalloc#PageHeap是按<strong>链表</strong>来组织的）<ul>
<li><strong>free</strong>：空闲 + 不是来自于 GC</li>
<li><strong>scav</strong>：来自于 GC</li>
</ul>
</li>
</ol>
<h2 id="内存回收"><a href="#内存回收" class="headerlink" title="内存回收"></a>内存回收</h2><blockquote>
<p>Go 使用的 GC 算法是 <strong>Mark-Sweep</strong>，会存在 <strong>STW</strong></p>
</blockquote>
<h3 id="mspan"><a href="#mspan" class="headerlink" title="mspan"></a>mspan</h3><ol>
<li><strong>bitmap</strong><ul>
<li><strong>allocBits</strong>：记录每块内存的<strong>分配</strong>情况</li>
<li><strong>gcmarkBits</strong>：记录每块内存的<strong>引用</strong>情况</li>
</ul>
</li>
<li>标记结束后进行回收，回收时，<strong>将 allocBits 指向 gcmarkBits</strong><ul>
<li>标记阶段：活跃标记为1，不活跃标记为0</li>
<li>标记过则继续存在，未进行标记则进行回收</li>
</ul>
</li>
<li><strong>回收对象：Span 中的元素</strong></li>
</ol>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220212184724384.png" alt="image-20220212184724384"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220212184734842.png" alt="image-20220212184734842"></p>
<h3 id="GC-过程"><a href="#GC-过程" class="headerlink" title="GC 过程"></a>GC 过程</h3><blockquote>
<p>类似于 JVM 的 <strong>CMS</strong></p>
</blockquote>
<h4 id="三色标记"><a href="#三色标记" class="headerlink" title="三色标记"></a>三色标记</h4><blockquote>
<p>白色：垃圾<br>黑色：存活 + 所有孩子已经扫描<br><strong>灰色</strong>：存活 + 还有孩子未扫描</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220212200920341.png" alt="image-20220212200920341"></p>
<ol>
<li><strong>图遍历</strong><ul>
<li>GC 开始时，认为所有 Object 都是白色（即垃圾）</li>
<li>从 Root 区开始遍历，被触达的 Object 置为灰色</li>
<li>遍历所有灰色 Object， 将他们内部引用的变量置为灰色（加入<strong>灰色队列</strong>），然后将自己置为黑色（已经完成扫描工作）</li>
<li>最终只会剩下两种颜色，<strong>黑色（存活）或白色（垃圾）</strong></li>
</ul>
</li>
<li><strong>并发</strong>标记<ul>
<li>对于<strong>黑色</strong> Object，如果在标记期间发生了<strong>写</strong>操作，<strong>写屏障</strong>会在真正赋值前将新对象标记为<strong>灰色</strong>（重新入队，再次扫描确认）</li>
<li><strong>新分配</strong>的 Object，会先标记为<strong>黑色</strong>再返回</li>
</ul>
</li>
</ol>
<h4 id="详细过程"><a href="#详细过程" class="headerlink" title="详细过程"></a>详细过程</h4><blockquote>
<p>Go GC 的大部分处理是和<strong>用户代码</strong>是<strong>并发</strong>的</p>
</blockquote>
<ol>
<li><strong>Mark</strong><ul>
<li><strong>Mark Prepare</strong><ul>
<li>STW：初始化 GC 任务，包括开启写屏障、<strong>统计 Root 对象的数量</strong></li>
</ul>
</li>
<li><strong>GC Drains</strong><ul>
<li>并发：扫描所有 Root 对象（全局指针和 G 栈上的指针），将其加入到<strong>灰色队列</strong>，并循环处理灰色队列的对象，直到灰色队列为空 – <strong>图遍历</strong></li>
</ul>
</li>
</ul>
</li>
<li><strong>Mark Termination</strong><ul>
<li>STW：完成标记工作，<strong>重新扫描</strong>全局指针和 G 栈</li>
</ul>
</li>
<li><strong>Sweep</strong><ul>
<li>并发：按照标记结果回收所有白色 Object</li>
</ul>
</li>
<li><strong>Sweep Termination</strong><ul>
<li>对未清扫的 Span 进行清扫，只有完成上一轮 GC 的清理工作后才可以开始新一轮的 GC</li>
</ul>
</li>
</ol>
<p>简单类比</p>
<table>
<thead>
<tr>
<th></th>
<th>Go</th>
<th>Java CMS</th>
</tr>
</thead>
<tbody><tr>
<td>STW</td>
<td><strong>Mark Prepare</strong></td>
<td>Initial Mark</td>
</tr>
<tr>
<td></td>
<td>GC Drains</td>
<td>Concurrent Mark</td>
</tr>
<tr>
<td>STW</td>
<td><strong>Mark Termination</strong></td>
<td>Final Remark</td>
</tr>
<tr>
<td></td>
<td>Sweep</td>
<td>Concurrent Sweep</td>
</tr>
<tr>
<td></td>
<td>Sweep Termination</td>
<td>Concurrent Reset</td>
</tr>
</tbody></table>
<h3 id="触发机制"><a href="#触发机制" class="headerlink" title="触发机制"></a>触发机制</h3><ol>
<li>内存分配量达到<strong>阈值</strong><ul>
<li><strong>每次内存分配</strong>都会检查当前内存分配量是否已经达到阈值，达到则启动 GC</li>
<li>阈值 &#x3D; <strong>上次 GC 内存分配量 * 内存增长率</strong>（默认是100%，由 <code>GOGC</code> 控制） – 类似于 Ruby GC</li>
</ul>
</li>
<li><strong>定期</strong>触发：默认<strong>2分钟</strong></li>
<li><strong>手动</strong>触发：<code>runtime.GC()</code> – 类似于 Java <code>System.gc()</code></li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/02/12/cloud-native-foundation-go-memory-management/">https://blog.zhongmingmao.top/2022/02/12/cloud-native-foundation-go-memory-management/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/go/">Go</a></div><div class="post-share"><div class="social-share" data-image="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-2.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/02/13/cloud-native-foundation-go-engineering/" title="Cloud Native Foundation - Go Engineering"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Cloud Native Foundation - Go Engineering</div></div><div class="info-2"><div class="info-item-1">IO 模型 阻塞：等待数据报文就绪；同步：等待内核拷贝数据  阻塞 + 同步   非阻塞 + 同步轮询 轮询不是一个好的检查状态变更的方式，很难支撑高并发的场景   IO 多路复用 Go select channel 也是借鉴于此  select &#x2F; poll 在用户态将关心的 fd 列表（限制为 1024）发送给 kernel    epoll 不需要传递 fd 列表：通过 mmap，将用户态和内核态的内存共享 事件驱动 epoll_create：初始化 wq(wait queue)、rdlist(ready list)、rbr(red-black root) epoll_ctl：一个 socket 创建后会加入到红黑树进行管理 epoll_wait：当 socket 尚未就绪时，用户线程会阻塞 当收到数据报文后，触发中断处理程序 然后将对应的 epitem（对应一个 socket）移动到 rdlist，并且唤醒阻塞在该 socket 上的用户进程     支持高并发   非阻塞 + 异步 HTTP G 与 socket fd 绑定 当 socket fd 尚未就绪时，将对应的 G 设置为 ...</div></div></div></a><a class="pagination-related" href="/2022/02/11/jvm-bytecode-manipulation-javassist/" title="Bytecode Manipulation - Javassist"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-1.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Bytecode Manipulation - Javassist</div></div><div class="info-2"><div class="info-item-1">概要 Unlike other similar bytecode editors, Javassist provides two levels of API: source level and bytecode level.  生成字节码1234567891011121314151617package me.zhongmingmao.javassist;public class Point &#123;  private int x;  private int y;  public Point(int x, int y) &#123;    this.x = x;    this.y = y;  &#125;  public void move(int x, int y) &#123;    this.x = x;    this.y = y;  &#125;&#125;  12$ javac me/zhongmingmao/javassist/Point.java$ javap -v me.zhongmingmao.javassist.Point    123456789101112131415161...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="info-item-2">Go Engineering - CLI</div></div><div class="info-2"><div class="info-item-1">应用框架 命令行参数解析 - Pflag 配置文件解析 - Viper 应用的命令行框架 - Cobra 命令需要具备 help 功能 命令需要能够解析命令行参数和配置文件 命令需要能够初始化业务代码，并最终启动业务进程      Pflag 命令行参数解析工具 - Kubernetes &#x2F; Istio &#x2F; Helm &#x2F; Docker &#x2F; Etcd &#x2F; …  Flag 一个命令行参数会被解析成一个 Flag 类型的变量  1234567891011121314// A Flag represents the state of a flag.type Flag struct &#123;    Name                string              // name as it appears on command line    Shorthand           string              // one-letter abbreviated flag    Usage               string   ...</div></div></div></a><a class="pagination-related" href="/2023/05/09/cloud-native-foundation-go-engineering-log/" title="Go Engineering - Log"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-log.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="info-item-2">Go Engineering - Log</div></div><div class="info-2"><div class="info-item-1">功能设计基础功能 支持基本的日志信息 - 时间戳、文件名、行号、日志级别、日志信息 支持不同的日志级别 - Debug &#x2F; Info &#x2F; Warn &#x2F; Error &#x2F; Panic &#x2F; Fatal logrus 支持 Trace 日志级别，Trace 不是必须的 Trace 和 Panic 是可选的级别   支持自定义配置 - 不同的环境采用不同的配置 开发环境的日志级别为 Debug，而生产环境的日志级别为 Info 通过配置，可以在不重新编译代码的情况下，改变记录日志的行为   支持输出到标准输出和文件     至少实现 6 个日志级别    日志调用时的属性   输出级别 glog.Info(“This is info message”)   开关级别 启动程序时，期望哪些输出级别的日志会被打印 glog -v=L - 只有输出级别 ≥L 的日志才会被打印     高级功能 支持多种日志格式 - TEXT &#x2F; JSON &#x2F; … 开发环境采用 TEXT 格式，生产环境采用 JSON 格式   按日志级别分类输出 - Error 级别...</div></div></div></a><a class="pagination-related" href="/2023/05/08/cloud-native-foundation-go-engineering-err-code/" title="Go Engineering - Error Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-error-handling.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="info-item-2">Go Engineering - Error Code</div></div><div class="info-2"><div class="info-item-1">预期功能 有业务 Code 码标识 - HTTP Code 码有限 安全 - 对内对外展示不同的错误信息    设计方式 无论请求成功与否，都返回 200，在 HTTP Body 中包含错误信息 HTTP Code 通常代表 HTTP Transport 层的状态信息 缺点：性能不佳（需解析 Body） + 对客户端不友好   返回 4xx or 5xx，并在 Body 中返回简单的错误信息 返回 4xx or 5xx，并在 Body 中返回详细的错误信息 - 推荐  设计思路 区别于 http status code，业务码需要有一定的规则，可以通过业务码判断出是哪类错误 请求出错时，可以通过 http status code，直接感知到请求出错 需要在请求出错时，返回详细的信息：Code + Message + Reference（Optional） 返回的错误信息，需要是可以直接展示给用户的安全信息，不能包含敏感信息 但同时也要有内部更详细的错误信息，方便 Debug   返回的数据格式应该是固定的，规范的 错误信息要保持简洁，并提供有用的信息  Biz Code 纯数字表示，不同部位代表不同的服...</div></div></div></a><a class="pagination-related" href="/2023/05/07/cloud-native-foundation-go-engineering-doc/" title="Go Engineering - Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-doc.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="info-item-2">Go Engineering - Doc</div></div><div class="info-2"><div class="info-item-1">Swagger Swagger 是一套围绕 OpenAPI 规范构建的开源工具     Component Desc    Swagger Editor 基于浏览器的编辑器，可以编写 OpenAPI 规范，并实时预览   Swagger UI 将 OpenAPI 规范呈现为交互式 API 文档   Swagger Codegen 根据 OpenAPI 规范，生成服务器存根和客户端代码库，涵盖 40 多种语言     OpenAPI OpenAPI 是一个 API 规范，其前身为 Swagger 规范 通过定义一种用来描述 API 格式或者 API 定义的 DSL，来规范 RESTful API 的开发过程 OpenAPI 3.0 ≈ Swagger 2.0   API 基本信息 对 API 的描述，介绍 API 可以实现的功能 每个 API 上可用的 Path 和 Method 每个 API 的输入和返回参数 验证方法 联系信息、许可证、使用条款和其它信息   OpenAPI 是一个 API 规范，而 Swagger 是实现该 API 规范的工具  go-swagger特性 功能强大、高性能、可以根据代...</div></div></div></a><a class="pagination-related" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-lint.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="info-item-2">Go Engineering - Lint</div></div><div class="info-2"><div class="info-item-1">golangci-lint 使用最多    优点   Advantage Desc    速度快 基于 gometalinter 开发，但比 gometalinter 快 5 倍原因：并行检查 + 复用 go build 缓存 + 缓存分析结果   可配置 支持 YAML 格式的配置文件   IDE 集成 Goland &#x2F; VS Code   linter 聚合器 不需要单独安装   最少误报数 调整了所集成 linter 的默认配置，大幅度减少误报   良好的输出 颜色、行号等   迭代快 不断有新的 linter 被集成到 golangci-lint 中   选项 配置 同时出现 - 命令行选项 &#x2F; 配置文件   bool&#x2F;string&#x2F;int - 命令行选项 slice - 合并  命令行选项 golangci-lint run -h     Flag Desc    –print-issued-lines Print lines of code with issue (default true)   –print-linter-name Print lin...</div></div></div></a><a class="pagination-related" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-makefile.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="info-item-2">Go Engineering - Makefile</div></div><div class="info-2"><div class="info-item-1">基础语法 https://github.com/seisman/how-to-write-makefile   规则语法 伪目标 变量赋值 特殊变量 自动化变量  功能设计Target   Target Desc    gen Generate all necessary files, such as error code files.   format Gofmt (reformat) package sources (exclude vendor dir if existed).   lint Check syntax and styling of go sources.   test Run unit test.   cover Run unit test and get test coverage.   build Build source code for host platform.   build.multiarch Build source code for multiple platforms. See option PLATFORMS.   image Build docker im...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">641</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">堆内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">Linux 进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">管理过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E4%B8%B4%E6%8C%91%E6%88%98"><span class="toc-number">1.3.</span> <span class="toc-text">面临挑战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TCMalloc"><span class="toc-number">2.</span> <span class="toc-text">TCMalloc</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Go"><span class="toc-number">3.</span> <span class="toc-text">Go</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="toc-number">3.1.</span> <span class="toc-text">内存分配</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6"><span class="toc-number">3.2.</span> <span class="toc-text">内存回收</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mspan"><span class="toc-number">3.2.1.</span> <span class="toc-text">mspan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GC-%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">GC 过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">三色标记</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">详细过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6"><span class="toc-number">3.2.3.</span> <span class="toc-text">触发机制</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
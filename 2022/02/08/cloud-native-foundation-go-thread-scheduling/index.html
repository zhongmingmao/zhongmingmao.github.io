<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Cloud Native Foundation - Go Thread Scheduling | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="进程 &amp; 线程 进程：资源分配的基本单位 线程：调度的基本单位 在内核视角，线程与进程无本质差别，在 Linux 中都是以**task_struct**进行描述 glibc 中的 pthread 库提供了 Native POSIX Thread Library 支持 Native POSIX Thread Library (NPTL) is an implementation of the">
<meta property="og:type" content="article">
<meta property="og:title" content="Cloud Native Foundation - Go Thread Scheduling">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/02/08/cloud-native-foundation-go-thread-scheduling/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="进程 &amp; 线程 进程：资源分配的基本单位 线程：调度的基本单位 在内核视角，线程与进程无本质差别，在 Linux 中都是以**task_struct**进行描述 glibc 中的 pthread 库提供了 Native POSIX Thread Library 支持 Native POSIX Thread Library (NPTL) is an implementation of the">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-13.png">
<meta property="article:published_time" content="2022-02-07T16:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.569Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-13.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Cloud Native Foundation - Go Thread Scheduling",
  "url": "https://blog.zhongmingmao.top/2022/02/08/cloud-native-foundation-go-thread-scheduling/",
  "image": "https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-13.png",
  "datePublished": "2022-02-07T16:06:25.000Z",
  "dateModified": "2023-04-03T10:04:59.569Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/02/08/cloud-native-foundation-go-thread-scheduling/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Cloud Native Foundation - Go Thread Scheduling',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-13.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Cloud Native Foundation - Go Thread Scheduling</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Cloud Native Foundation - Go Thread Scheduling</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-02-07T16:06:25.000Z" title="Created 2022-02-08 00:06:25">2022-02-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/go/">Go</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>7mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-04-03 18:04:59&quot;}" hidden></div><h1 id="进程-线程"><a href="#进程-线程" class="headerlink" title="进程 &amp; 线程"></a>进程 &amp; 线程</h1><ol>
<li><strong>进程</strong>：<strong>资源分配</strong>的基本单位</li>
<li><strong>线程</strong>：<strong>调度</strong>的基本单位</li>
<li>在<strong>内核</strong>视角，<strong>线程与进程无本质差别</strong>，在 Linux 中都是以**<code>task_struct</code>**进行描述<ul>
<li>glibc 中的 pthread 库提供了 <code>Native POSIX Thread Library</code> 支持</li>
<li><strong>Native POSIX Thread Library</strong> (<strong>NPTL</strong>)<ul>
<li>is an <strong>implementation</strong> of the <strong>POSIX Threads specification</strong> for the <strong>Linux</strong> operating system.</li>
</ul>
</li>
</ul>
</li>
<li>子进程通过 <code>fork</code> 的方式产生，基于<strong>父子关系</strong>形成<strong>进程树</strong>，Linux 中的初始进程一般为<code>systemd</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pmap 1</span><br><span class="line">1:   /lib/systemd/systemd --system --deserialize 37</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220207213038762.png" alt="image-20220207213038762"></p>
<span id="more"></span>

<h1 id="Linux-进程内存"><a href="#Linux-进程内存" class="headerlink" title="Linux 进程内存"></a>Linux 进程内存</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220207221016045.png" alt="image-20220207221016045"></p>
<h2 id="虚拟地址"><a href="#虚拟地址" class="headerlink" title="虚拟地址"></a>虚拟地址</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://ggirjau.com/text-data-bss-heap-stack-and-where-in-memory-are-stored-variables-of-c-program/">https://ggirjau.com/text-data-bss-heap-stack-and-where-in-memory-are-stored-variables-of-c-program/</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>Segment</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><strong>.text</strong></td>
<td>contains <strong>executable instructions</strong></td>
</tr>
<tr>
<td><strong>.data</strong></td>
<td>contains any <strong>global</strong> or <strong>static</strong> variables which have a <strong>pre-defined value</strong> and can be modified</td>
</tr>
<tr>
<td></td>
<td>The values for these variables are <strong>initially stored</strong> within the <strong>read-only</strong> memory (typically within <em>.text</em>) and are <strong>copied into</strong> the <em>.data</em> segment during the <strong>start-up</strong> routine of the program</td>
</tr>
<tr>
<td><strong>.bss</strong></td>
<td>Named after an ancient assembler operator that stood for “block started by symbol”</td>
</tr>
<tr>
<td></td>
<td>Data in this segment is <strong>initialized by the kernel to arithmetic 0 before the program starts executing</strong></td>
</tr>
<tr>
<td></td>
<td>Uninitialized data starts at the end of the data segment and contains all <strong>global</strong> variables and <strong>static</strong> variables that are <strong>initialized to zero</strong> or <strong>do not have explicit initialization in source code</strong>.</td>
</tr>
<tr>
<td><strong>Heap</strong></td>
<td>Heap is the segment where <strong>dynamic memory allocation</strong> usually takes place.</td>
</tr>
<tr>
<td></td>
<td>The heap area begins at the end of the BSS segment and <strong>grows to larger addresses</strong> from there.</td>
</tr>
<tr>
<td></td>
<td>The Heap area is <strong>shared by all shared libraries and dynamically loaded modules in a process</strong>.</td>
</tr>
<tr>
<td><strong>Stack</strong></td>
<td>The stack area contains the program stack, a <strong>LIFO</strong> structure, typically located in the higher parts of memory.</td>
</tr>
<tr>
<td></td>
<td>A “<strong>stack pointer</strong>“ register tracks the top of the stack; it is adjusted each time a value is “pushed” onto the stack.</td>
</tr>
<tr>
<td></td>
<td>The set of values pushed for one <strong>function call</strong> is termed a “<strong>stack frame</strong>“. A stack frame consists at minimum of a <strong>return address</strong>. <strong>Automatic variables</strong> are also allocated on the stack.<br />方法中的<strong>本地变量</strong>会分配到<strong>栈</strong>上</td>
</tr>
<tr>
<td></td>
<td>The stack area traditionally adjoined the heap area and they <strong>grew towards each other</strong>; when the stack pointer met the heap pointer, free memory was exhausted.</td>
</tr>
<tr>
<td></td>
<td>On the standard PC <strong>x86</strong> architecture the <strong>stack grows toward address zero</strong>, meaning that more recent items, deeper in the call chain, are at numerically lower addresses and closer to the heap.</td>
</tr>
</tbody></table>
<figure class="highlight c"><figcaption><span>.data initialized data</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> debug_sesion = <span class="number">1</span>;</span><br><span class="line"><span class="type">char</span> <span class="built_in">string</span>[] = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> reset_cnt = <span class="number">5</span>;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><figcaption><span>.bss uninitialized data</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> i;</span><br></pre></td></tr></table></figure>

<h3 id="Go-样例"><a href="#Go-样例" class="headerlink" title="Go 样例"></a>Go 样例</h3><blockquote>
<p>Go 不支持静态变量，Go 代码本身编译后在 <em>.data</em> 和 <em>.bss</em> 没有值（里面实际存储的是 Go Runtime 的值）</p>
</blockquote>
<figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> name = <span class="string">&quot;zhongmingmao&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ go build main.go </span><br><span class="line"></span><br><span class="line">$ size main</span><br><span class="line">   text    data     bss     dec     hex filename</span><br><span class="line"> 785799   10904  121752  918455   e03b7 main</span><br><span class="line"> </span><br><span class="line">$ objdump -x main</span><br><span class="line">...</span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  0 .text         000515b0  0000000000401000  0000000000401000  00001000  2**4</span><br><span class="line">...</span><br><span class="line">  8 .data         00001e90  00000000004c2c20  00000000004c2c20  000c2c20  2**5</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  9 .bss          0001b470  00000000004c4ac0  00000000004c4ac0  000c4ac0  2**5</span><br><span class="line">                  ALLOC</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<h2 id="多级页表"><a href="#多级页表" class="headerlink" title="多级页表"></a>多级页表</h2><ol>
<li>页表的作用：虚拟地址与物理地址的<strong>映射</strong>关系</li>
<li>单级页表相当于一一映射，本身就非常浪费内存，为了<strong>节省内存</strong>，发展出了多级页表（常见为<strong>4级</strong>）</li>
<li>寻址：<strong>多级索引 + 页内偏移</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ getconf PAGE_SIZE</span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<h1 id="CPU-访问内存"><a href="#CPU-访问内存" class="headerlink" title="CPU 访问内存"></a>CPU 访问内存</h1><ol>
<li>MMU: <strong>Memory Management Unit</strong></li>
<li>TLB: <strong>Translation Lookaside Buffer</strong>，用于<strong>缓存虚拟地址和物理地址的映射关系</strong><ul>
<li><strong>TLB 在 CPU 内部，比 L1 Cache 都要快</strong></li>
<li>注意区分 JVM 中的 TLAB（Thread Local Allocation Buffer）</li>
</ul>
</li>
<li>过程（缓存模式：<strong>Cache-Aside</strong>）<ul>
<li>第一次访问，CPU 把虚拟地址交给 MMU，MMU 去物理内存中查找多级页表，得到实际的物理地址</li>
<li>然后将虚拟地址与物理地址的映射关系缓存到 TLB</li>
<li>对于同一个虚拟地址的后续访问，将直接访问 TLB</li>
</ul>
</li>
</ol>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220207234249516.png" alt="image-20220207234249516"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220207235521793.png" alt="image-20220207235521793"></p>
<h1 id="切换开销"><a href="#切换开销" class="headerlink" title="切换开销"></a>切换开销</h1><table>
<thead>
<tr>
<th></th>
<th>内核参与（系统调用）</th>
<th>虚拟地址空间切换</th>
</tr>
</thead>
<tbody><tr>
<td>进程</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>线程</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>用户线程 - goroutine</td>
<td>N</td>
<td>N</td>
</tr>
</tbody></table>
<h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><ol>
<li>直接开销<ul>
<li>切换 <strong>PGD</strong></li>
<li>刷新 <strong>TLB</strong></li>
<li>切换<strong>硬件上下文</strong>（即：进程恢复前，必须装入<strong>寄存器</strong>的数据）</li>
<li>切换<strong>内核态堆栈</strong></li>
<li><strong>系统调度器</strong>的代码执行</li>
</ul>
</li>
<li>间接开销<ul>
<li>新切入的进程，由于 <strong>CPU 缓存失效</strong>，导致该进程<strong>直接访问内存</strong>的操作变多</li>
</ul>
</li>
</ol>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><ol>
<li><strong>线程本质上只是一批共享资源的进程，线程切换本质上依然需要内核（系统调用）进行进程切换</strong></li>
<li><strong>共享 &#x3D;&gt; 节省</strong><ul>
<li>进程内的所有线程共享虚拟地址空间 – 即<em>mm</em>，线程切换相比进程切换，主要<strong>节省了虚拟地址空间的切换</strong>，开销小很多</li>
</ul>
</li>
</ol>
<h2 id="用户线程"><a href="#用户线程" class="headerlink" title="用户线程"></a>用户线程</h2><blockquote>
<p>应用程序在用户空间创建的可执行单元（<strong>goroutine</strong>），创建销毁<strong>完全在用户态</strong>完成，无需切换，<strong>无需内核参与（系统调用）</strong></p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220208002033001.png" alt="image-20220208002033001"></p>
<h1 id="GMP-模型"><a href="#GMP-模型" class="headerlink" title="GMP 模型"></a>GMP 模型</h1><blockquote>
<p>Go 基于 GMP 模型实现用户态线程</p>
</blockquote>
<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220208225332764.png" alt="image-20220208225332764"></p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><strong>G : Goroutine</strong></td>
<td><strong>goroutine</strong><br />每个 goroutine 都有自己的<strong>栈空间</strong>和和<strong>定时器</strong>，初始化的栈空间在 <strong>2K</strong> 左右，后续可能增长</td>
</tr>
<tr>
<td><strong>M : Machine</strong></td>
<td>抽象化代表<strong>内核线程</strong>，记录内核线程栈信息<br />当 goroutine 调度到线程时，<strong>使用该 goroutine 自身的栈信息</strong><br />任何运行中的 goroutine 会与某个<strong>内核态</strong>的线程绑定</td>
</tr>
<tr>
<td><strong>P : Processor</strong></td>
<td>代表<strong>调度器</strong>，负责<strong>调度 goroutine</strong><br />维护一个<strong>本地 goroutine 队列</strong>，M 从 P 上获取 goroutine 并执行，同时还负责部分内存的管理</td>
</tr>
</tbody></table>
<blockquote>
<p>KSE: Kernel Scheduling Entity – 轻量级进程</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220208232451974.png" alt="image-20220208232451974"></p>
<h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/image-20220208232657730.png" alt="image-20220208232657730"></p>
<h3 id="P-状态"><a href="#P-状态" class="headerlink" title="P 状态"></a>P 状态</h3><table>
<thead>
<tr>
<th>State</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><strong>_Pidle</strong></td>
<td>没有运行用户代码或者调度逻辑，执行队列为空</td>
</tr>
<tr>
<td><strong>_Prunning</strong></td>
<td>被 M 持有，并且正在执行用户代码或者调度逻辑</td>
</tr>
<tr>
<td><strong>_Psyscall</strong></td>
<td>没有执行用户代码，当前线程<strong>陷入系统调用</strong></td>
</tr>
<tr>
<td>_Pgcstop</td>
<td>被 M 持有，当前 P 由于 GC 被停止</td>
</tr>
<tr>
<td>_Pdead</td>
<td>不再被使用</td>
</tr>
</tbody></table>
<h3 id="G-状态"><a href="#G-状态" class="headerlink" title="G 状态"></a>G 状态</h3><table>
<thead>
<tr>
<th>State</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>_Gidle</td>
<td>刚被分配还未初始化，值为0，为创建 goroutine 后的默认值</td>
</tr>
<tr>
<td><strong>_Grunnable</strong></td>
<td>没有执行代码，没有栈的所有权，存储在执行队列中（LRQ 或者 GRQ）</td>
</tr>
<tr>
<td><strong>_Grunning</strong></td>
<td>正在执行代码，拥有栈的所有权</td>
</tr>
<tr>
<td><strong>_Gsyscall</strong></td>
<td><strong>正在执行系统调用，拥有栈的所有权，与 P 脱离，与 M 绑定</strong><br /><strong>系统调用结束后会被分配到执行队列</strong></td>
</tr>
<tr>
<td><strong>_Gwaiting</strong></td>
<td>被阻塞的 goroutine，阻塞在某个 channel 的发送或者接收队列</td>
</tr>
<tr>
<td><strong>_Gdead</strong></td>
<td>当前 goroutine 未被使用，没有执行代码，分布在 gFree<br />1. 可能是一个<strong>刚初始化</strong>的 goroutine<br />2. 也可能是<strong>刚执行完</strong>的 goroutine</td>
</tr>
<tr>
<td>_Gcopystac</td>
<td>栈正在被拷贝，没有执行代码，不在执行队列上，执行权在</td>
</tr>
<tr>
<td>_Gscan</td>
<td>GC 正在扫描栈空间，没有执行代码，可以与其他状态同时存在</td>
</tr>
</tbody></table>
<h3 id="G-位置"><a href="#G-位置" class="headerlink" title="G 位置"></a>G 位置</h3><ol>
<li>进程都有一个全局的 G 队列</li>
<li>每个 P 拥有一个本地执行队列 LRQ</li>
<li>不在执行队列（LRQ 或者 GRQ）中的 G<ul>
<li>处于 channel 阻塞态的 G 被放在 sudog</li>
<li>脱离 P 绑定在 M 上的 G，例如系统调用</li>
<li>为了<strong>复用</strong>，执行结束后进入  <strong>P 的 gFree 列表</strong>中的 G</li>
</ul>
</li>
</ol>
<h3 id="创建-G"><a href="#创建-G" class="headerlink" title="创建 G"></a>创建 G</h3><ol>
<li>创建过程<ul>
<li>从 P 的 gFree 列表中查找空闲的 goroutine</li>
<li>如果不存在空闲的 goroutine，会创建一个栈大小足够的新结构体</li>
</ul>
</li>
<li>将函数传入的参数移到 goroutine 的栈上</li>
<li>更新 goroutine 调度相关的属性，更新状态为 _Grunnable</li>
<li>返回的 goroutine 会存储到全局变量 allgs 中</li>
</ol>
<h3 id="G-Q"><a href="#G-Q" class="headerlink" title="G -&gt; Q"></a>G -&gt; Q</h3><ol>
<li>首先尝试将 G 放入对应的 LRQ</li>
<li>如果 LRQ 已经满了（256），会把 LRQ 中的一部分 G 和待加入的 G 一起放到 GRQ</li>
</ol>
<h3 id="P"><a href="#P" class="headerlink" title="P"></a>P</h3><ol>
<li>为了保证公平，当 GRQ 中有 G，首先以一定的概率（1&#x2F;61）尝试从 GRQ 中获取 G，获取失败再尝试从 LRQ 中获取</li>
<li>如果还是失败，则随机从其他 P 对应的 LRQ 中获取 G</li>
</ol>
<h3 id="M-P"><a href="#M-P" class="headerlink" title="M &amp; P"></a>M &amp; P</h3><ol>
<li>默认情况下，<strong>P 的数量 &#x3D; CPU 个数</strong>，可以通过 <code>GOMAXPROCS</code> 修改，上限为<strong>256</strong></li>
<li><strong>M</strong> 的数量为<strong>内核线程数量</strong>，<strong>M ＞ P</strong>，上限为<strong>10,000</strong></li>
<li>P 的数量在调度器初始化的 procresize 中控制</li>
<li>当调度器进行调度，唤醒 P 的时候，<strong>会尝试获取 idle m</strong>，如果获取不到，则<strong>创建新的 M（内核线程）</strong><ul>
<li>因为 M 可能陷入<strong>系统调用</strong>，而系统调用可能是<strong>阻塞</strong>的，如 IO，此时 <strong>CPU 是空闲的</strong></li>
<li>创建新的 M 与 P 关联，可以让更多的 G 被调度，<strong>充分利用 CPU</strong></li>
</ul>
</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/02/08/cloud-native-foundation-go-thread-scheduling/">https://blog.zhongmingmao.top/2022/02/08/cloud-native-foundation-go-thread-scheduling/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/go/">Go</a></div><div class="post-share"><div class="social-share" data-image="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-13.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/02/10/jvm-bytecode-manipulation-java-agent-practice/" title="Bytecode Manipulation - Java Agent Practice"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-10.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Bytecode Manipulation - Java Agent Practice</div></div><div class="info-2"><div class="info-item-1">概念Instrument Instrument 是 JVM 提供的一个可以修改已加载类的类库，依赖于 JVMTI 的 Attach API 机制 要使用 Instrument 的类修改功能，需要实现 java.lang.instrument.ClassFileTransformer 接口 可以在 ClassFileTransformer#transform 中利用 ASM 或者 Byte Buddy 等工具对字节码进行操作   Instrument 通过与 Java Agent 结合来注入到 JVM 中  JVMTI &amp; Agent JPDA（Java Platform Debugger Architecture）是 JDK 标准，必须实现 如果 JVM 启动时开启了 JPDA，那么类是允许被重新加载的 已加载的旧版类信息被卸载，然后重新加载新版本的类   JVMTI 是 JVM 提供的一套对 JVM 进行操作的工具接口，Agent 是 JVMTI 的一种实现 Attach API 的作用：提供 JVM 进程间通信的能力 Attach 后，目标 JVM 在运行时走到 Agent 中定义的 age...</div></div></div></a><a class="pagination-related" href="/2022/02/06/cloud-native-foundation-go-sync/" title="Cloud Native Foundation - Go Sync"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-1.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Cloud Native Foundation - Go Sync</div></div><div class="info-2"><div class="info-item-1">线程安全   锁 Go 不仅提供了基于 CSP 的通讯模型，也支持基于共享内存的多线程数据访问 sync 包提供了锁的基本原语     同步工具 用途    sync.Mutex 互斥锁：Lock加锁，Unlock解锁   sync.RWMutex 读写分离锁：不限制并发读，只限制并发写和并发读写   sync.WaitGroup 等待一组 goroutine 返回，类似于 Java 的 CountDownLatch   sync.Once 保证某段代码只执行1次，典型场景：单例模式   sync.Cond 让一组 goroutine 在满足特定条件时被唤醒，典型场景：生产者消费者模型   Mutex12345678910111213141516171819202122232425262728293031323334353637func unsafeWrite() &#123; // fatal error: concurrent map writes    conflictMap := map[int]int&#123;&#125;    for i := 0; i &lt; 100; i++ &#1...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="info-item-2">Go Engineering - CLI</div></div><div class="info-2"><div class="info-item-1">应用框架 命令行参数解析 - Pflag 配置文件解析 - Viper 应用的命令行框架 - Cobra 命令需要具备 help 功能 命令需要能够解析命令行参数和配置文件 命令需要能够初始化业务代码，并最终启动业务进程      Pflag 命令行参数解析工具 - Kubernetes &#x2F; Istio &#x2F; Helm &#x2F; Docker &#x2F; Etcd &#x2F; …  Flag 一个命令行参数会被解析成一个 Flag 类型的变量  1234567891011121314// A Flag represents the state of a flag.type Flag struct &#123;    Name                string              // name as it appears on command line    Shorthand           string              // one-letter abbreviated flag    Usage               string   ...</div></div></div></a><a class="pagination-related" href="/2023/05/09/cloud-native-foundation-go-engineering-log/" title="Go Engineering - Log"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-log.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="info-item-2">Go Engineering - Log</div></div><div class="info-2"><div class="info-item-1">功能设计基础功能 支持基本的日志信息 - 时间戳、文件名、行号、日志级别、日志信息 支持不同的日志级别 - Debug &#x2F; Info &#x2F; Warn &#x2F; Error &#x2F; Panic &#x2F; Fatal logrus 支持 Trace 日志级别，Trace 不是必须的 Trace 和 Panic 是可选的级别   支持自定义配置 - 不同的环境采用不同的配置 开发环境的日志级别为 Debug，而生产环境的日志级别为 Info 通过配置，可以在不重新编译代码的情况下，改变记录日志的行为   支持输出到标准输出和文件     至少实现 6 个日志级别    日志调用时的属性   输出级别 glog.Info(“This is info message”)   开关级别 启动程序时，期望哪些输出级别的日志会被打印 glog -v=L - 只有输出级别 ≥L 的日志才会被打印     高级功能 支持多种日志格式 - TEXT &#x2F; JSON &#x2F; … 开发环境采用 TEXT 格式，生产环境采用 JSON 格式   按日志级别分类输出 - Error 级别...</div></div></div></a><a class="pagination-related" href="/2023/05/08/cloud-native-foundation-go-engineering-err-code/" title="Go Engineering - Error Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-error-handling.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="info-item-2">Go Engineering - Error Code</div></div><div class="info-2"><div class="info-item-1">预期功能 有业务 Code 码标识 - HTTP Code 码有限 安全 - 对内对外展示不同的错误信息    设计方式 无论请求成功与否，都返回 200，在 HTTP Body 中包含错误信息 HTTP Code 通常代表 HTTP Transport 层的状态信息 缺点：性能不佳（需解析 Body） + 对客户端不友好   返回 4xx or 5xx，并在 Body 中返回简单的错误信息 返回 4xx or 5xx，并在 Body 中返回详细的错误信息 - 推荐  设计思路 区别于 http status code，业务码需要有一定的规则，可以通过业务码判断出是哪类错误 请求出错时，可以通过 http status code，直接感知到请求出错 需要在请求出错时，返回详细的信息：Code + Message + Reference（Optional） 返回的错误信息，需要是可以直接展示给用户的安全信息，不能包含敏感信息 但同时也要有内部更详细的错误信息，方便 Debug   返回的数据格式应该是固定的，规范的 错误信息要保持简洁，并提供有用的信息  Biz Code 纯数字表示，不同部位代表不同的服...</div></div></div></a><a class="pagination-related" href="/2023/05/07/cloud-native-foundation-go-engineering-doc/" title="Go Engineering - Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-doc.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="info-item-2">Go Engineering - Doc</div></div><div class="info-2"><div class="info-item-1">Swagger Swagger 是一套围绕 OpenAPI 规范构建的开源工具     Component Desc    Swagger Editor 基于浏览器的编辑器，可以编写 OpenAPI 规范，并实时预览   Swagger UI 将 OpenAPI 规范呈现为交互式 API 文档   Swagger Codegen 根据 OpenAPI 规范，生成服务器存根和客户端代码库，涵盖 40 多种语言     OpenAPI OpenAPI 是一个 API 规范，其前身为 Swagger 规范 通过定义一种用来描述 API 格式或者 API 定义的 DSL，来规范 RESTful API 的开发过程 OpenAPI 3.0 ≈ Swagger 2.0   API 基本信息 对 API 的描述，介绍 API 可以实现的功能 每个 API 上可用的 Path 和 Method 每个 API 的输入和返回参数 验证方法 联系信息、许可证、使用条款和其它信息   OpenAPI 是一个 API 规范，而 Swagger 是实现该 API 规范的工具  go-swagger特性 功能强大、高性能、可以根据代...</div></div></div></a><a class="pagination-related" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-lint.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="info-item-2">Go Engineering - Lint</div></div><div class="info-2"><div class="info-item-1">golangci-lint 使用最多    优点   Advantage Desc    速度快 基于 gometalinter 开发，但比 gometalinter 快 5 倍原因：并行检查 + 复用 go build 缓存 + 缓存分析结果   可配置 支持 YAML 格式的配置文件   IDE 集成 Goland &#x2F; VS Code   linter 聚合器 不需要单独安装   最少误报数 调整了所集成 linter 的默认配置，大幅度减少误报   良好的输出 颜色、行号等   迭代快 不断有新的 linter 被集成到 golangci-lint 中   选项 配置 同时出现 - 命令行选项 &#x2F; 配置文件   bool&#x2F;string&#x2F;int - 命令行选项 slice - 合并  命令行选项 golangci-lint run -h     Flag Desc    –print-issued-lines Print lines of code with issue (default true)   –print-linter-name Print lin...</div></div></div></a><a class="pagination-related" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-makefile.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="info-item-2">Go Engineering - Makefile</div></div><div class="info-2"><div class="info-item-1">基础语法 https://github.com/seisman/how-to-write-makefile   规则语法 伪目标 变量赋值 特殊变量 自动化变量  功能设计Target   Target Desc    gen Generate all necessary files, such as error code files.   format Gofmt (reformat) package sources (exclude vendor dir if existed).   lint Check syntax and styling of go sources.   test Run unit test.   cover Run unit test and get test coverage.   build Build source code for host platform.   build.multiarch Build source code for multiple platforms. See option PLATFORMS.   image Build docker im...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">进程 &amp; 线程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux-%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98"><span class="toc-number">2.</span> <span class="toc-text">Linux 进程内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80"><span class="toc-number">2.1.</span> <span class="toc-text">虚拟地址</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Go-%E6%A0%B7%E4%BE%8B"><span class="toc-number">2.1.1.</span> <span class="toc-text">Go 样例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8"><span class="toc-number">2.2.</span> <span class="toc-text">多级页表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CPU-%E8%AE%BF%E9%97%AE%E5%86%85%E5%AD%98"><span class="toc-number">3.</span> <span class="toc-text">CPU 访问内存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E5%BC%80%E9%94%80"><span class="toc-number">4.</span> <span class="toc-text">切换开销</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.3.</span> <span class="toc-text">用户线程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GMP-%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">GMP 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%A6%81"><span class="toc-number">5.1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%86%E8%8A%82"><span class="toc-number">5.2.</span> <span class="toc-text">细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#P-%E7%8A%B6%E6%80%81"><span class="toc-number">5.2.1.</span> <span class="toc-text">P 状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#G-%E7%8A%B6%E6%80%81"><span class="toc-number">5.2.2.</span> <span class="toc-text">G 状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#G-%E4%BD%8D%E7%BD%AE"><span class="toc-number">5.2.3.</span> <span class="toc-text">G 位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-G"><span class="toc-number">5.2.4.</span> <span class="toc-text">创建 G</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#G-Q"><span class="toc-number">5.2.5.</span> <span class="toc-text">G -&gt; Q</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P"><span class="toc-number">5.2.6.</span> <span class="toc-text">P</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#M-P"><span class="toc-number">5.2.7.</span> <span class="toc-text">M &amp; P</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Server V1"/></a><div class="content"><a class="title" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1">Observability - Prometheus Server V1</a><time datetime="2025-01-23T16:06:25.000Z" title="Created 2025-01-24 00:06:25">2025-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
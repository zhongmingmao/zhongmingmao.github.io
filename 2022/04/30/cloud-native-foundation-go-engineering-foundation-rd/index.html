<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Go Engineering - Foundation - RD | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="功能需求 为 iamctl 新增 helloworld 命令，该命令向终端打印 hello world  开发阶段代码开发 选择 Git Flow：适用于大型非开源项目">
<meta property="og:type" content="article">
<meta property="og:title" content="Go Engineering - Foundation - RD">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/04/30/cloud-native-foundation-go-engineering-foundation-rd/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="功能需求 为 iamctl 新增 helloworld 命令，该命令向终端打印 hello world  开发阶段代码开发 选择 Git Flow：适用于大型非开源项目">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-16.png">
<meta property="article:published_time" content="2022-04-29T16:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.568Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Go Engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-16.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go Engineering - Foundation - RD",
  "url": "https://blog.zhongmingmao.top/2022/04/30/cloud-native-foundation-go-engineering-foundation-rd/",
  "image": "https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-16.png",
  "datePublished": "2022-04-29T16:06:25.000Z",
  "dateModified": "2023-04-03T10:04:59.568Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/04/30/cloud-native-foundation-go-engineering-foundation-rd/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go Engineering - Foundation - RD',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-16.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Go Engineering - Foundation - RD</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Go Engineering - Foundation - RD</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-04-29T16:06:25.000Z" title="Created 2022-04-30 00:06:25">2022-04-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/go-engineering/">Go Engineering</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>11mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-04-03 18:04:59&quot;}" hidden></div><h1 id="功能需求"><a href="#功能需求" class="headerlink" title="功能需求"></a>功能需求</h1><blockquote>
<p>为 iamctl 新增 helloworld 命令，该命令向终端打印 hello world</p>
</blockquote>
<h1 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h1><h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><blockquote>
<p>选择 <strong>Git Flow</strong>：适用于<strong>大型非开源项目</strong></p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/gitflow.webp"></p>
<span id="more"></span>

<h3 id="创建分支"><a href="#创建分支" class="headerlink" title="创建分支"></a>创建分支</h3><blockquote>
<p>基于 develop 分支，新建一个功能分支 feature&#x2F;helloworld</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b feature/helloworld develop</span><br></pre></td></tr></table></figure>

<p>branch 名要符合 Git Flow 的分支命名规范，会通过 <code>pre-commit</code> 的 githook 来确保分支名符合规范</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ md5 ./githooks/pre-commit ./.git/hooks/pre-commit</span><br><span class="line">MD5 (./githooks/pre-commit) = 3324d20a738461f3b6347f9ce7dae6b6</span><br><span class="line">MD5 (./.git/hooks/pre-commit) = 3324d20a738461f3b6347f9ce7dae6b6</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><figcaption><span>./.git/hooks/pre-commit</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">LC_ALL=C</span><br><span class="line"></span><br><span class="line">local_branch=<span class="string">&quot;<span class="subst">$(git rev-parse --abbrev-ref HEAD)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">valid_branch_regex=<span class="string">&quot;^(master|develop)$|(feature|release|hotfix)\/[a-z0-9._-]+$|^HEAD$&quot;</span></span><br><span class="line"></span><br><span class="line">message=<span class="string">&quot;There is something wrong with your branch name. Branch names in this project must adhere to this contract: <span class="variable">$valid_branch_regex</span>. </span></span><br><span class="line"><span class="string">Your commit will be rejected. You should rename your branch to a valid name and try again.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="variable">$local_branch</span> =~ <span class="variable">$valid_branch_regex</span> ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$message</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$&#123;local_branch&#125;</span> 1111</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/15bb43219269273baf70a27ea94e1279.webp" alt="15bb43219269273baf70a27ea94e1279"></p>
<blockquote>
<p>git 默认不会提交 .git&#x2F;hooks 下的 githooks 脚本，可以借助 Makefile 来同步 – 每次执行 make 命令时都会执行</p>
</blockquote>
<figure class="highlight makefile"><figcaption><span>scripts/make-rules/common.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copy githook scripts when execute makefile</span></span><br><span class="line">COPY_GITHOOK:=<span class="variable">$(<span class="built_in">shell</span> cp -f githooks/* .git/hooks/)</span></span><br></pre></td></tr></table></figure>

<h3 id="生成模板"><a href="#生成模板" class="headerlink" title="生成模板"></a>生成模板</h3><blockquote>
<p>创建 helloworld 命令模板，包含 <code>low code</code> 思想 – <strong>代码自动生成</strong>（提高开发效率 + 保证代码规范）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iamctl new helloworld -d internal/iamctl/cmd/helloworld</span><br><span class="line">Command file generated: internal/iamctl/cmd/helloworld/helloworld.go</span><br></pre></td></tr></table></figure>

<blockquote>
<p>编辑 internal&#x2F;iamctl&#x2F;cmd&#x2F;cmd.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  ...</span><br><span class="line">    <span class="string">&quot;github.com/marmotedu/iam/internal/iamctl/cmd/helloworld&quot;</span></span><br><span class="line">)</span><br><span class="line">    ...</span><br><span class="line">  &#123;</span><br><span class="line">    Message: <span class="string">&quot;Troubleshooting and Debugging Commands:&quot;</span>,</span><br><span class="line">    Commands: []*cobra.Command&#123;</span><br><span class="line">      validate.NewCmdValidate(f, ioStreams),</span><br><span class="line">      helloworld.NewCmdHelloworld(f, ioStreams), <span class="comment">// 加载 helloworld 命令</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="生成代码"><a href="#生成代码" class="headerlink" title="生成代码"></a>生成代码</h3><blockquote>
<p>通过 make gen 生成的存量代码要具有<strong>幂等性</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ make gen</span><br><span class="line">===========&gt; Installing codegen</span><br><span class="line">===========&gt; Generating iam error code go source files</span><br><span class="line">===========&gt; Generating error code markdown documentation</span><br><span class="line">===========&gt; Generating missing doc.go for go packages</span><br><span class="line">pkg/rollinglog/doc.go</span><br><span class="line">pkg/rollinglog/distribution/doc.go</span><br><span class="line">pkg/rollinglog/example/doc.go</span><br><span class="line">pkg/rollinglog/klog/doc.go</span><br><span class="line">pkg/rollinglog/logrus/doc.go</span><br><span class="line">pkg/rollinglog/rolling/doc.go</span><br><span class="line">pkg/validator/example/doc.go</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## gen: Generate all necessary files, such as error code files.</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: gen</span></span><br><span class="line"><span class="section">gen:</span></span><br><span class="line">    @<span class="variable">$(MAKE)</span> gen.run</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>scripts/make-rules/gen.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: gen.run</span></span><br><span class="line"><span class="section">gen.run: gen.clean gen.errcode gen.docgo.doc</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: gen.clean</span></span><br><span class="line"><span class="section">gen.clean:</span></span><br><span class="line">    @rm -rf ./api/client/&#123;clientset,informers,listers&#125;</span><br><span class="line">    @<span class="variable">$(FIND)</span> -type f -name &#x27;*_generated.go&#x27; -delete</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: gen.errcode</span></span><br><span class="line"><span class="section">gen.errcode: gen.errcode.code gen.errcode.doc</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: gen.errcode.code</span></span><br><span class="line"><span class="section">gen.errcode.code: tools.verify.codegen</span></span><br><span class="line">    @echo <span class="string">&quot;===========&gt; Generating iam error code go source files&quot;</span></span><br><span class="line">    @codegen -type=int $&#123;ROOT_DIR&#125;/internal/pkg/code</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: gen.errcode.doc</span></span><br><span class="line"><span class="section">gen.errcode.doc: tools.verify.codegen</span></span><br><span class="line">    @echo <span class="string">&quot;===========&gt; Generating error code markdown documentation&quot;</span></span><br><span class="line">    @codegen -type=int -doc \</span><br><span class="line">        -output $&#123;ROOT_DIR&#125;/docs/guide/zh-CN/api/error_code_generated.md $&#123;ROOT_DIR&#125;/internal/pkg/code</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: gen.docgo.doc</span></span><br><span class="line"><span class="section">gen.docgo.doc:</span></span><br><span class="line">    @echo <span class="string">&quot;===========&gt; Generating missing doc.go for go packages&quot;</span></span><br><span class="line">    @$&#123;ROOT_DIR&#125;/scripts/gendoc.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>scripts/make-rules/tools.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: tools.verify.%</span></span><br><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">    @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br></pre></td></tr></table></figure>

<h3 id="版权检查（开源软件）"><a href="#版权检查（开源软件）" class="headerlink" title="版权检查（开源软件）"></a>版权检查（开源软件）</h3><blockquote>
<p>如果有新文件添加，需要检查新文件有没有添加版权头信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make verify-copyright</span><br><span class="line">===========&gt; Verifying the boilerplate headers for all files</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## verify-copyright: Verify the boilerplate headers for all files.</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: verify-copyright</span></span><br><span class="line"><span class="section">verify-copyright:</span></span><br><span class="line">    @<span class="variable">$(MAKE)</span> copyright.verify</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>scripts/make-rules/copyright.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: copyright.verify</span></span><br><span class="line"><span class="section">copyright.verify: tools.verify.addlicense</span></span><br><span class="line">    @echo <span class="string">&quot;===========&gt; Verifying the boilerplate headers for all files&quot;</span></span><br><span class="line">    @addlicense --check -f <span class="variable">$(ROOT_DIR)</span>/scripts/boilerplate.txt <span class="variable">$(ROOT_DIR)</span> --skip-dirs=third_party,vendor,_output</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: copyright.add</span></span><br><span class="line"><span class="section">copyright.add: tools.verify.addlicense</span></span><br><span class="line">    @addlicense -v -f <span class="variable">$(ROOT_DIR)</span>/scripts/boilerplate.txt <span class="variable">$(ROOT_DIR)</span> --skip-dirs=third_party,vendor,_output</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>scripts/make-rules/tools.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: tools.verify.%</span></span><br><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">    @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br></pre></td></tr></table></figure>

<blockquote>
<p>自动添加版权头</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make add-copyright</span><br></pre></td></tr></table></figure>

<h3 id="代码格式化"><a href="#代码格式化" class="headerlink" title="代码格式化"></a>代码格式化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make format          </span><br><span class="line">===========&gt; Installing golines</span><br><span class="line">go: downloading github.com/segmentio/golines v0.9.0</span><br><span class="line">...</span><br><span class="line">===========&gt; Formating codes</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## format: Gofmt (reformat) package sources (exclude vendor dir if existed).</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: format</span></span><br><span class="line"><span class="section">format: tools.verify.golines tools.verify.goimports</span></span><br><span class="line">    @echo <span class="string">&quot;===========&gt; Formating codes&quot;</span></span><br><span class="line">    @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> gofmt -s -w</span><br><span class="line">    @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> goimports -w -local <span class="variable">$(ROOT_PACKAGE)</span></span><br><span class="line">    @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> golines -w --max-len=120 --reformat-tags --shorten-comments --ignore-generated .</span><br><span class="line">    @<span class="variable">$(GO)</span> mod edit -fmt</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Package</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>gofmt</code></strong></td>
<td>格式化 go 代码</td>
</tr>
<tr>
<td><strong><code>goimports</code></strong></td>
<td>自动增删依赖包，并将依赖包按照字母序排序并分类</td>
</tr>
<tr>
<td><strong><code>golines</code></strong></td>
<td>把超过 120 行的代码按照 golines 规则，格式化成 &lt; 120 行的代码</td>
</tr>
<tr>
<td><strong><code>go mod edit -fmt</code></strong></td>
<td>格式化 go.mod</td>
</tr>
</tbody></table>
<h3 id="静态代码检查"><a href="#静态代码检查" class="headerlink" title="静态代码检查"></a>静态代码检查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make lint</span><br><span class="line">===========&gt; Run golangci to lint source codes</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make test</span><br><span class="line">===========&gt; Run unit test</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## test: Run unit test.</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: test</span></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">    @<span class="variable">$(MAKE)</span> go.test</span><br></pre></td></tr></table></figure>

<blockquote>
<p>并非所有包都需要单元测试；mock_.*.go 文件中的函数是不需要单元测试的</p>
</blockquote>
<figure class="highlight makefile"><figcaption><span>scripts/make-rules/golang.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: go.test</span></span><br><span class="line"><span class="section">go.test: tools.verify.go-junit-report</span></span><br><span class="line">    @echo <span class="string">&quot;===========&gt; Run unit test&quot;</span></span><br><span class="line">    @set -o pipefail;<span class="variable">$(GO)</span> test -race -cover -coverprofile=<span class="variable">$(OUTPUT_DIR)</span>/coverage.out \</span><br><span class="line">        -timeout=10m -shuffle=on -short -v `go list ./...|\</span><br><span class="line">        egrep -v <span class="variable">$(<span class="built_in">subst</span> <span class="variable">$(SPACE)</span>,&#x27;|&#x27;,$(<span class="built_in">sort</span> <span class="variable">$(EXCLUDE_TESTS)</span>)</span>)` 2&gt;&amp;1 | \</span><br><span class="line">        tee &gt;(go-junit-report --set-exit-code &gt;<span class="variable">$(OUTPUT_DIR)</span>/report.xml)</span><br><span class="line">    @sed -i &#x27;/mock_.*.go/d&#x27; <span class="variable">$(OUTPUT_DIR)</span>/coverage.out <span class="comment"># remove mock_.*.go files from test coverage</span></span><br><span class="line">    @<span class="variable">$(GO)</span> tool cover -html=<span class="variable">$(OUTPUT_DIR)</span>/coverage.out -o <span class="variable">$(OUTPUT_DIR)</span>/coverage.html</span><br></pre></td></tr></table></figure>

<blockquote>
<p>检查单元测试覆盖率，如果单元测试覆盖率不达标，禁止合并到 develop 和 master 分支 – CI Pipeline</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make cover # 默认测试覆盖率至少为60%</span><br><span class="line"></span><br><span class="line">$ make cover COVERAGE=90</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## cover: Run unit test and get test coverage.</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: cover </span></span><br><span class="line"><span class="section">cover:</span></span><br><span class="line">    @<span class="variable">$(MAKE)</span> go.test.cover</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>scripts/make-rules/golang.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: go.test.cover</span></span><br><span class="line"><span class="section">go.test.cover: go.test</span></span><br><span class="line">    @<span class="variable">$(GO)</span> tool cover -func=<span class="variable">$(OUTPUT_DIR)</span>/coverage.out | \</span><br><span class="line">        awk -v target=<span class="variable">$(COVERAGE)</span> -f <span class="variable">$(ROOT_DIR)</span>/scripts/coverage.awk</span><br></pre></td></tr></table></figure>

<h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make build</span><br><span class="line"></span><br><span class="line">$ make build BINS=&quot;iam-apiserver iamctl&quot;</span><br></pre></td></tr></table></figure>

<h3 id="默认操作"><a href="#默认操作" class="headerlink" title="默认操作"></a>默认操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Build all by default, even if it&#x27;s not first</span></span><br><span class="line">.DEFAULT_GOAL := all</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all</span></span><br><span class="line"><span class="section">all: tidy gen add-copyright format lint cover build</span></span><br></pre></td></tr></table></figure>

<h2 id="代码提交"><a href="#代码提交" class="headerlink" title="代码提交"></a>代码提交</h2><h3 id="commit-push"><a href="#commit-push" class="headerlink" title="commit + push"></a>commit + push</h3><blockquote>
<p>只添加与 feature&#x2F;helloworld 相关的改动，而非 <code>git add .</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git add internal/iamctl/cmd/helloworld internal/iamctl/cmd/cmd.go</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>.git/hooks/commit-msg</code> 会检查 commit message 是否符合 Angular Commit Message 规范</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git commit -m &quot;feat: add new iamctl command &#x27;helloworld&#x27;&quot;</span><br><span class="line">$ git push origin feature/helloworld</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><figcaption><span>.git/hooks/commit-msg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">go-gitlint --msg-file=<span class="string">&quot;<span class="variable">$1</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>.gitlint</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--subject-regex=^((Merge branch.*of.*)|((revert: )?(feat|fix|perf|style|refactor|test|ci|docs|chore)(\(.+\))?: [^A-Z].*[^.]$))</span><br><span class="line">--subject-maxlen=72</span><br><span class="line">--body-regex=^([^\r\n]&#123;0,72&#125;(\r?\n|$))*$</span><br></pre></td></tr></table></figure>

<h3 id="Github-Actions"><a href="#Github-Actions" class="headerlink" title="Github Actions"></a>Github Actions</h3><blockquote>
<p>配置 Github Actions，当有代码被 Push 后，会触发 CI Pipeline，Pipeline 会执行 <code>make all</code></p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/6819f96bda8dcb214c3b7eeba2f37022.webp" alt="6819f96bda8dcb214c3b7eeba2f37022"></p>
<blockquote>
<p>线上 CI 流程与本地 CI 流程要完全保持一致</p>
</blockquote>
<figure class="highlight yaml"><figcaption><span>.github/workflows/iamci.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">IamCI</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branchs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">types:</span> [ <span class="string">opened</span>, <span class="string">reopened</span> ]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">iamci:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Test</span> <span class="string">with</span> <span class="string">go</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.go_version</span> <span class="string">&#125;&#125;</span> <span class="string">on</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">iamci</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">go_version:</span> [ <span class="number">1.16</span> ]</span><br><span class="line">        <span class="attr">os:</span> [ <span class="string">ubuntu-latest</span> ]</span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Go</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.go_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-go@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">go-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.go_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">go</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">out</span> <span class="string">code</span> <span class="string">into</span> <span class="string">the</span> <span class="string">Go</span> <span class="string">module</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">go</span> <span class="string">modules</span> <span class="string">tidy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          make tidy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Generate</span> <span class="string">all</span> <span class="string">necessary</span> <span class="string">files,</span> <span class="string">such</span> <span class="string">as</span> <span class="string">error</span> <span class="string">code</span> <span class="string">files</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          make gen</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">syntax</span> <span class="string">and</span> <span class="string">styling</span> <span class="string">of</span> <span class="string">go</span> <span class="string">sources</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          make lint</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">unit</span> <span class="string">test</span> <span class="string">and</span> <span class="string">get</span> <span class="string">test</span> <span class="string">coverage</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          make cover</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">source</span> <span class="string">code</span> <span class="string">for</span> <span class="string">host</span> <span class="string">platform</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          make build</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Collect</span> <span class="string">Test</span> <span class="string">Coverage</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v1.0.0</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">main-output</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">_output/coverage.out</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Login</span> <span class="string">to</span> <span class="string">DockerHub</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/login-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DOCKERHUB_USERNAME</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DOCKERHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">docker</span> <span class="string">images</span> <span class="string">for</span> <span class="string">host</span> <span class="string">arch</span> <span class="string">and</span> <span class="string">push</span> <span class="string">images</span> <span class="string">to</span> <span class="string">registry</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">make</span> <span class="string">push</span></span><br></pre></td></tr></table></figure>

<h3 id="提交-PR"><a href="#提交-PR" class="headerlink" title="提交 PR"></a>提交 PR</h3><blockquote>
<p>新 PR 被创建后，会触发 CI Pipeline</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/53f4103f5c8cabb76ef2fddaec3a54ab.webp" alt="53f4103f5c8cabb76ef2fddaec3a54ab"></p>
<h3 id="Code-Review"><a href="#Code-Review" class="headerlink" title="Code Review"></a>Code Review</h3><blockquote>
<p>如果 Review 不通过，开发者可以直接在 <code>feature/helloworld</code> 上修正代码，并再次 push（会触发 CI Pipeline）</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/39d992c7bdb35848706bce792877e8ce.webp" alt="39d992c7bdb35848706bce792877e8ce"></p>
<h3 id="接受-PR"><a href="#接受-PR" class="headerlink" title="接受 PR"></a>接受 PR</h3><blockquote>
<p>使用 <strong>Create a merge commit</strong>，底层操作为 <code>git merge --no-ff</code>，<strong>方便回溯</strong></p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/30de6bb6c8ff431ec56debbc0f5b667d.webp" alt="30de6bb6c8ff431ec56debbc0f5b667d"></p>
<h3 id="关闭-PR"><a href="#关闭-PR" class="headerlink" title="关闭 PR"></a>关闭 PR</h3><blockquote>
<p>合并到 develop 后，会触发 CI Pipeline，关闭 PR</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/444b0701f8866b50a49bd0138488c873.webp" alt="444b0701f8866b50a49bd0138488c873"></p>
<h1 id="测试阶段"><a href="#测试阶段" class="headerlink" title="测试阶段"></a>测试阶段</h1><h2 id="创建分支-1"><a href="#创建分支-1" class="headerlink" title="创建分支"></a>创建分支</h2><blockquote>
<p>基于 develop 分支，创建 release 分支</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b release/1.0.0 develop</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<h2 id="Bug-Fix"><a href="#Bug-Fix" class="headerlink" title="Bug Fix"></a>Bug Fix</h2><blockquote>
<p>直接在 <code>release/1.0.0</code> 分支上修改代码，本地构建并 push 代码，线上 CI 成功后，则将代码提交给测试同学</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">$ git add internal/iamctl/cmd/helloworld/</span><br><span class="line">$ git commit -m &quot;fix: fix helloworld print bug&quot;</span><br><span class="line">$ git push origin release/1.0.0</span><br></pre></td></tr></table></figure>

<h2 id="代码合并"><a href="#代码合并" class="headerlink" title="代码合并"></a>代码合并</h2><blockquote>
<p>测试通过后，将 feature 分支合并到 master 分支和 develop 分支 – <strong>测试阶段的产物</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout develop</span><br><span class="line">$ git merge --no-ff release/1.0.0</span><br><span class="line"></span><br><span class="line">$ git checkout master</span><br><span class="line">$ git merge --no-ff release/1.0.0</span><br><span class="line">$ git tag -a v1.0.0 -m &quot;add print hello world&quot;</span><br></pre></td></tr></table></figure>

<h2 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h2><blockquote>
<p>删除 feature 分支，选择性地删除 release 分支</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git branch -d feature/helloworld</span><br></pre></td></tr></table></figure>

<h1 id="Makefile-技巧"><a href="#Makefile-技巧" class="headerlink" title="Makefile 技巧"></a>Makefile 技巧</h1><h2 id="help-自动解析"><a href="#help-自动解析" class="headerlink" title="help 自动解析"></a>help 自动解析</h2><blockquote>
<p>通过 sed 命令，自动解析 Makefile 中以 <code>##</code> 开头的注释行，自动生成 make help 输出</p>
</blockquote>
<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## help: Show this help info.</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: help</span></span><br><span class="line"><span class="section">help: Makefile</span></span><br><span class="line">    @echo -e <span class="string">&quot;\nUsage: make &lt;TARGETS&gt; &lt;OPTIONS&gt; ...\n\nTargets:&quot;</span></span><br><span class="line">    @sed -n &#x27;s/^<span class="comment">##//p&#x27; $&lt; | column -t -s &#x27;:&#x27; | sed -e &#x27;s/^/ /&#x27;</span></span><br><span class="line">    @echo <span class="string">&quot;$$USAGE_OPTIONS&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h2><figure class="highlight makefile"><figcaption><span>scripts/make-rules/common.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Minimum test coverage</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">origin</span> COVERAGE)</span>,undefined)</span><br><span class="line">COVERAGE := 60</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">$ make COVERAGE=90</span><br></pre></td></tr></table></figure>

<h2 id="CHANGELOG"><a href="#CHANGELOG" class="headerlink" title="CHANGELOG"></a>CHANGELOG</h2><blockquote>
<p>CHANGELOG 用来展示每个版本之间的变更内容，作为 <strong>Release Note</strong> 的一部分，借助 git-chglog 自动生成</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tree .chglog</span><br><span class="line">.chglog</span><br><span class="line">├── CHANGELOG.tpl.md</span><br><span class="line">└── config.yml</span><br></pre></td></tr></table></figure>

<h2 id="语义化版本号"><a href="#语义化版本号" class="headerlink" title="语义化版本号"></a>语义化版本号</h2><blockquote>
<p>借助 <code>gsemve</code> 工具，gsemver 会根据 Commit Message 自动生成版本号</p>
</blockquote>
<figure class="highlight bash"><figcaption><span>scripts/ensure_tag.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">version=v`gsemver bump`</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;`git tag -l <span class="variable">$version</span>`&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">  git tag -a -m <span class="string">&quot;release version <span class="variable">$version</span>&quot;</span> <span class="variable">$version</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>后续的 Makefile 和 Shell 都会用到 scripts&#x2F;make-rules&#x2F;common.mk 中的 VERSION 变量</p>
</blockquote>
<figure class="highlight makefile"><figcaption><span>scripts/make-rules/common.mk</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">origin</span> VERSION)</span>, undefined)</span><br><span class="line">VERSION := <span class="variable">$(<span class="built_in">shell</span> git describe --tags --always --match=&#x27;v*&#x27;)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果符合条件的 tag 指向最新提交，则只显示 tag 名字，否则会显示：<strong>该 tag 后有多少次提交</strong> + <strong>最新的 commit id</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git describe --tags --always --match=&#x27;v*&#x27;</span><br><span class="line">v1.0.0-3-g1909e47</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>--tags</code></td>
<td>不仅仅使用带有注释的 tag，而是使用 <code>refs/tags</code> 名称空间下的任何 tag</td>
</tr>
<tr>
<td><code>--always</code></td>
<td>显示唯一<strong>缩写</strong>的提交对象作为<strong>后备</strong></td>
</tr>
<tr>
<td><code>--match</code></td>
<td>只考虑与给定模式相匹配的 tag</td>
</tr>
</tbody></table>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/04/30/cloud-native-foundation-go-engineering-foundation-rd/">https://blog.zhongmingmao.top/2022/04/30/cloud-native-foundation-go-engineering-foundation-rd/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/go/">Go</a><a class="post-meta__tags" href="/tags/go-engineering/">Go Engineering</a></div><div class="post-share"><div class="social-share" data-image="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-16.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/04/30/cloud-native-foundation-go-engineering-foundation-linting/" title="Go Engineering - Foundation - Linting"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-10.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Go Engineering - Foundation - Linting</div></div><div class="info-2"><div class="info-item-1">golangci-lint 优点 速度快 基于 gometalinter 开发，平均速度比 gometalinter 快 5 倍 并行检查代码 + 复用 go build 缓存 + 缓存分析结果   可配置 支持 YAML 格式的配置文件   IDE 集成 VS Code + Goland   Linter 聚合器 集成了很多 Linter，无需单独安装，并且支持自定义 Linter   最小误报数 调整了所集成的 Linter 的默认设置，大幅减少误报   良好的输出 检查出问题的源码文件、行号和错误行内容 不符合检查规则的原因 报错的 Linter   更迭速度快 不断有新的 Linter 被集成进来 使用者：Google、Facebook、Istio、Red Hat OpenShift 等       golangci-lint 命令 cache123456789$ golangci-lint cache statusDir: /Users/zhongmingmao/Library/Caches/golangci-lintSize: 1.9MiB$ golangci-lint cache clea...</div></div></div></a><a class="pagination-related" href="/2022/04/23/cloud-native-foundation-go-engineering-foundation-makefile/" title="Go Engineering - Foundation - Makefile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Go Engineering - Foundation - Makefile</div></div><div class="info-2"><div class="info-item-1">使用 先编写 Makefile 文件，指定整个项目的编译规则，然后通过 Linux make 命令来解析该 Makefile 文件，实现自动化 默认情况下，make 命令会在当前目录下，按照 GNUmakefile、makefile、Makefile（推荐）的顺序查找 make -f golang.mk 或者 make --file golang.mk    规则 规则一般由目标、依赖和命令组成，用来指定源文件编译的先后顺序 Makefile 规则可以自动判断是否需要重新编译某个目标，从而确保目标仅在需要时编译  规则语法 主要包括：target、prerequisites 和 command  1234target ...: prerequisites ...    command      ...      ...     target 可以是一个 object file，也可以是一个执行文件，还可以是一个标签 可以使用通配符，当有多个目标时，使用空格分隔   prerequisites：代表生成该 target 所需要的依赖项，当有多个依赖项时，使用空格分隔 command：代表该 target ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="info-item-2">Go Engineering - CLI</div></div><div class="info-2"><div class="info-item-1">应用框架 命令行参数解析 - Pflag 配置文件解析 - Viper 应用的命令行框架 - Cobra 命令需要具备 help 功能 命令需要能够解析命令行参数和配置文件 命令需要能够初始化业务代码，并最终启动业务进程      Pflag 命令行参数解析工具 - Kubernetes &#x2F; Istio &#x2F; Helm &#x2F; Docker &#x2F; Etcd &#x2F; …  Flag 一个命令行参数会被解析成一个 Flag 类型的变量  1234567891011121314// A Flag represents the state of a flag.type Flag struct &#123;    Name                string              // name as it appears on command line    Shorthand           string              // one-letter abbreviated flag    Usage               string   ...</div></div></div></a><a class="pagination-related" href="/2023/05/09/cloud-native-foundation-go-engineering-log/" title="Go Engineering - Log"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-log.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="info-item-2">Go Engineering - Log</div></div><div class="info-2"><div class="info-item-1">功能设计基础功能 支持基本的日志信息 - 时间戳、文件名、行号、日志级别、日志信息 支持不同的日志级别 - Debug &#x2F; Info &#x2F; Warn &#x2F; Error &#x2F; Panic &#x2F; Fatal logrus 支持 Trace 日志级别，Trace 不是必须的 Trace 和 Panic 是可选的级别   支持自定义配置 - 不同的环境采用不同的配置 开发环境的日志级别为 Debug，而生产环境的日志级别为 Info 通过配置，可以在不重新编译代码的情况下，改变记录日志的行为   支持输出到标准输出和文件     至少实现 6 个日志级别    日志调用时的属性   输出级别 glog.Info(“This is info message”)   开关级别 启动程序时，期望哪些输出级别的日志会被打印 glog -v=L - 只有输出级别 ≥L 的日志才会被打印     高级功能 支持多种日志格式 - TEXT &#x2F; JSON &#x2F; … 开发环境采用 TEXT 格式，生产环境采用 JSON 格式   按日志级别分类输出 - Error 级别...</div></div></div></a><a class="pagination-related" href="/2023/05/08/cloud-native-foundation-go-engineering-err-code/" title="Go Engineering - Error Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-error-handling.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="info-item-2">Go Engineering - Error Code</div></div><div class="info-2"><div class="info-item-1">预期功能 有业务 Code 码标识 - HTTP Code 码有限 安全 - 对内对外展示不同的错误信息    设计方式 无论请求成功与否，都返回 200，在 HTTP Body 中包含错误信息 HTTP Code 通常代表 HTTP Transport 层的状态信息 缺点：性能不佳（需解析 Body） + 对客户端不友好   返回 4xx or 5xx，并在 Body 中返回简单的错误信息 返回 4xx or 5xx，并在 Body 中返回详细的错误信息 - 推荐  设计思路 区别于 http status code，业务码需要有一定的规则，可以通过业务码判断出是哪类错误 请求出错时，可以通过 http status code，直接感知到请求出错 需要在请求出错时，返回详细的信息：Code + Message + Reference（Optional） 返回的错误信息，需要是可以直接展示给用户的安全信息，不能包含敏感信息 但同时也要有内部更详细的错误信息，方便 Debug   返回的数据格式应该是固定的，规范的 错误信息要保持简洁，并提供有用的信息  Biz Code 纯数字表示，不同部位代表不同的服...</div></div></div></a><a class="pagination-related" href="/2023/05/07/cloud-native-foundation-go-engineering-doc/" title="Go Engineering - Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-doc.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="info-item-2">Go Engineering - Doc</div></div><div class="info-2"><div class="info-item-1">Swagger Swagger 是一套围绕 OpenAPI 规范构建的开源工具     Component Desc    Swagger Editor 基于浏览器的编辑器，可以编写 OpenAPI 规范，并实时预览   Swagger UI 将 OpenAPI 规范呈现为交互式 API 文档   Swagger Codegen 根据 OpenAPI 规范，生成服务器存根和客户端代码库，涵盖 40 多种语言     OpenAPI OpenAPI 是一个 API 规范，其前身为 Swagger 规范 通过定义一种用来描述 API 格式或者 API 定义的 DSL，来规范 RESTful API 的开发过程 OpenAPI 3.0 ≈ Swagger 2.0   API 基本信息 对 API 的描述，介绍 API 可以实现的功能 每个 API 上可用的 Path 和 Method 每个 API 的输入和返回参数 验证方法 联系信息、许可证、使用条款和其它信息   OpenAPI 是一个 API 规范，而 Swagger 是实现该 API 规范的工具  go-swagger特性 功能强大、高性能、可以根据代...</div></div></div></a><a class="pagination-related" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-lint.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="info-item-2">Go Engineering - Lint</div></div><div class="info-2"><div class="info-item-1">golangci-lint 使用最多    优点   Advantage Desc    速度快 基于 gometalinter 开发，但比 gometalinter 快 5 倍原因：并行检查 + 复用 go build 缓存 + 缓存分析结果   可配置 支持 YAML 格式的配置文件   IDE 集成 Goland &#x2F; VS Code   linter 聚合器 不需要单独安装   最少误报数 调整了所集成 linter 的默认配置，大幅度减少误报   良好的输出 颜色、行号等   迭代快 不断有新的 linter 被集成到 golangci-lint 中   选项 配置 同时出现 - 命令行选项 &#x2F; 配置文件   bool&#x2F;string&#x2F;int - 命令行选项 slice - 合并  命令行选项 golangci-lint run -h     Flag Desc    –print-issued-lines Print lines of code with issue (default true)   –print-linter-name Print lin...</div></div></div></a><a class="pagination-related" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-makefile.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="info-item-2">Go Engineering - Makefile</div></div><div class="info-2"><div class="info-item-1">基础语法 https://github.com/seisman/how-to-write-makefile   规则语法 伪目标 变量赋值 特殊变量 自动化变量  功能设计Target   Target Desc    gen Generate all necessary files, such as error code files.   format Gofmt (reformat) package sources (exclude vendor dir if existed).   lint Check syntax and styling of go sources.   test Run unit test.   cover Run unit test and get test coverage.   build Build source code for host platform.   build.multiarch Build source code for multiple platforms. See option PLATFORMS.   image Build docker im...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">功能需求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5"><span class="toc-number">2.</span> <span class="toc-text">开发阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91"><span class="toc-number">2.1.</span> <span class="toc-text">代码开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%86%E6%94%AF"><span class="toc-number">2.1.1.</span> <span class="toc-text">创建分支</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.1.2.</span> <span class="toc-text">生成模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.1.3.</span> <span class="toc-text">生成代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9D%83%E6%A3%80%E6%9F%A5%EF%BC%88%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6%EF%BC%89"><span class="toc-number">2.1.4.</span> <span class="toc-text">版权检查（开源软件）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-number">2.1.5.</span> <span class="toc-text">代码格式化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5"><span class="toc-number">2.1.6.</span> <span class="toc-text">静态代码检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">2.1.7.</span> <span class="toc-text">单元测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">2.1.8.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">2.1.9.</span> <span class="toc-text">默认操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%8F%90%E4%BA%A4"><span class="toc-number">2.2.</span> <span class="toc-text">代码提交</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#commit-push"><span class="toc-number">2.2.1.</span> <span class="toc-text">commit + push</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Github-Actions"><span class="toc-number">2.2.2.</span> <span class="toc-text">Github Actions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4-PR"><span class="toc-number">2.2.3.</span> <span class="toc-text">提交 PR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-Review"><span class="toc-number">2.2.4.</span> <span class="toc-text">Code Review</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%97-PR"><span class="toc-number">2.2.5.</span> <span class="toc-text">接受 PR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-PR"><span class="toc-number">2.2.6.</span> <span class="toc-text">关闭 PR</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%98%B6%E6%AE%B5"><span class="toc-number">3.</span> <span class="toc-text">测试阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%86%E6%94%AF-1"><span class="toc-number">3.1.</span> <span class="toc-text">创建分支</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bug-Fix"><span class="toc-number">3.2.</span> <span class="toc-text">Bug Fix</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%90%88%E5%B9%B6"><span class="toc-number">3.3.</span> <span class="toc-text">代码合并</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%88%86%E6%94%AF"><span class="toc-number">3.4.</span> <span class="toc-text">删除分支</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Makefile-%E6%8A%80%E5%B7%A7"><span class="toc-number">4.</span> <span class="toc-text">Makefile 技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#help-%E8%87%AA%E5%8A%A8%E8%A7%A3%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">help 自动解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Options"><span class="toc-number">4.2.</span> <span class="toc-text">Options</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CHANGELOG"><span class="toc-number">4.3.</span> <span class="toc-text">CHANGELOG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%AD%E4%B9%89%E5%8C%96%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">4.4.</span> <span class="toc-text">语义化版本号</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Server V1"/></a><div class="content"><a class="title" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1">Observability - Prometheus Server V1</a><time datetime="2025-01-23T16:06:25.000Z" title="Created 2025-01-24 00:06:25">2025-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Go Engineering - Foundation - Makefile | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="使用 先编写 Makefile 文件，指定整个项目的编译规则，然后通过 Linux make 命令来解析该 Makefile 文件，实现自动化 默认情况下，make 命令会在当前目录下，按照 GNUmakefile、makefile、Makefile（推荐）的顺序查找 make -f golang.mk 或者 make --file golang.mk    规则 规则一般由目标、依赖和命令组成，">
<meta property="og:type" content="article">
<meta property="og:title" content="Go Engineering - Foundation - Makefile">
<meta property="og:url" content="https://blog.zhongmingmao.top/2022/04/23/cloud-native-foundation-go-engineering-foundation-makefile/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="使用 先编写 Makefile 文件，指定整个项目的编译规则，然后通过 Linux make 命令来解析该 Makefile 文件，实现自动化 默认情况下，make 命令会在当前目录下，按照 GNUmakefile、makefile、Makefile（推荐）的顺序查找 make -f golang.mk 或者 make --file golang.mk    规则 规则一般由目标、依赖和命令组成，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png">
<meta property="article:published_time" content="2022-04-22T16:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.568Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Go Engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go Engineering - Foundation - Makefile",
  "url": "https://blog.zhongmingmao.top/2022/04/23/cloud-native-foundation-go-engineering-foundation-makefile/",
  "image": "https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png",
  "datePublished": "2022-04-22T16:06:25.000Z",
  "dateModified": "2023-04-03T10:04:59.568Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2022/04/23/cloud-native-foundation-go-engineering-foundation-makefile/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go Engineering - Foundation - Makefile',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">639</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Go Engineering - Foundation - Makefile</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Go Engineering - Foundation - Makefile</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2022-04-22T16:06:25.000Z" title="Created 2022-04-23 00:06:25">2022-04-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/">Cloud Native Foundation</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/cloud-native-foundation/go-engineering/">Go Engineering</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>12mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-04-03 18:04:59&quot;}" hidden></div><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><ol>
<li>先编写 Makefile 文件，指定整个项目的<strong>编译规则</strong>，然后通过 Linux <strong>make</strong> 命令来解析该 Makefile 文件，实现<strong>自动化</strong></li>
<li>默认情况下，make 命令会在当前目录下，按照 GNUmakefile、makefile、<strong>Makefile</strong>（推荐）的顺序查找<ul>
<li><code>make -f golang.mk</code> 或者 <code>make --file golang.mk</code></li>
</ul>
</li>
</ol>
<h1 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h1><ol>
<li>规则一般由<strong>目标</strong>、<strong>依赖</strong>和<strong>命令</strong>组成，用来指定<strong>源文件编译的先后顺序</strong></li>
<li>Makefile 规则可以自动判断是否需要<strong>重新编译</strong>某个目标，从而确保<strong>目标仅在需要时编译</strong></li>
</ol>
<h2 id="规则语法"><a href="#规则语法" class="headerlink" title="规则语法"></a>规则语法</h2><blockquote>
<p>主要包括：<strong>target</strong>、<strong>prerequisites</strong> 和 <strong>command</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target ...: prerequisites ...</span><br><span class="line">    command</span><br><span class="line">      ...</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<ol>
<li>target<ul>
<li>可以是一个 object file，也可以是一个执行文件，还可以是一个标签</li>
<li>可以使用<strong>通配符</strong>，当有多个目标时，使用<strong>空格</strong>分隔</li>
</ul>
</li>
<li>prerequisites：代表生成该 target 所需要的依赖项，当有多个依赖项时，使用<strong>空格</strong>分隔</li>
<li>command：代表该 target 要执行的命令<ul>
<li>在执行 command 之前，默认会先<strong>打印</strong>出该命令，然后再输出命令的结果</li>
<li>如果不想打印出命令，使用**<code>@command</code>**</li>
<li>command 可以为多条，也可以分行写，但每行都要以 <strong>tab</strong> 开始</li>
<li>如果后一条命令<strong>依赖</strong>前一条命令，则这两条命令需要写在<strong>同一行</strong>，并用<strong>分号</strong>进行分隔</li>
<li>如果要<strong>忽略</strong>命令的错误，使用**<code>-command</code>**</li>
</ul>
</li>
</ol>
<blockquote>
<p>只要 target <strong>不存在</strong>，或 prerequisites 中有一个以上的文件比 target 文件<strong>新</strong>，command 会被执行</p>
</blockquote>
<figure class="highlight c"><figcaption><span>hello.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">hello: hello.o</span></span><br><span class="line">    gcc -o hello hello.o</span><br><span class="line"></span><br><span class="line"><span class="section">hello.o: hello.c</span></span><br><span class="line">    gcc -c hello.c</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm hello</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">gcc -c hello.c</span><br><span class="line">gcc -o hello hello.o</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">Makefile hello    hello.c  hello.o</span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line">make: &#x27;hello&#x27; is up to date.</span><br><span class="line"></span><br><span class="line">$ touch hello.c</span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line">gcc -c hello.c</span><br><span class="line">gcc -o hello hello.o</span><br><span class="line"></span><br><span class="line">$ make clean</span><br><span class="line">rm hello</span><br></pre></td></tr></table></figure>

<h2 id="伪目标"><a href="#伪目标" class="headerlink" title="伪目标"></a>伪目标</h2><blockquote>
<p>Makefile 的管理能力基本上都是通过伪目标来实现的</p>
</blockquote>
<ol>
<li>上面的 clean 是一个伪目标，既<strong>不会为该目标生成任何文件</strong></li>
<li><strong>伪目标不是文件</strong>，make 无法生成它的<strong>依赖关系</strong>，也无法决定<strong>是否执行</strong>它</li>
<li>通常情况下，需要<strong>显式标识</strong>一个目标是伪目标，如<code>.PHONY</code></li>
<li><strong>伪目标可以有依赖文件</strong>，也可以作为默认目标</li>
<li><strong>伪目标总是会被执行</strong>，所以其依赖总是会被决议</li>
</ol>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all</span></span><br><span class="line"><span class="section">all: lint test build</span></span><br></pre></td></tr></table></figure>

<h2 id="order-only-依赖"><a href="#order-only-依赖" class="headerlink" title="order-only 依赖"></a>order-only 依赖</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">targets : normal-prerequisites | order-only-prerequisites</span><br><span class="line">    command</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<ol>
<li>只有<strong>第一次</strong>构造 targets 时，才会使用 order-only-prerequisites</li>
<li>后面即使 order-only-prerequisites 发生变化，也不会重新构造 targets</li>
<li>只有 normal-prerequisites 中的文件发生改变时，才会重新构造 targets</li>
</ol>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><blockquote>
<p>Makefile 支持 <strong>Linux 命令</strong>，默认会<strong>打印正在执行的命令</strong>，可以使用 <strong><code>@</code></strong> 来禁止 – <strong>推荐</strong></p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: test</span></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">    echo <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">echo &quot;hello world&quot;</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: test</span></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">    @echo <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<blockquote>
<p>命令执行后 make 会检查其返回码，如果成功则执行下一条指令，否则终止，可以使用 <code>-</code> 忽略出错命令</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">clean:</span></span><br><span class="line">    -@rm not_exist_file</span><br><span class="line">    @echo <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br><span class="line">rm: not_exist_file: No such file or directory</span><br><span class="line">make: [Makefile:7: clean] Error 1 (ignored)</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><blockquote>
<p>Makefile 支持<strong>变量赋值</strong>，<strong>多行变量</strong>和<strong>环境变量</strong>，还内置了<strong>特殊变量</strong>和<strong>自动化变量</strong></p>
</blockquote>
<h3 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h3><blockquote>
<p>引用变量，可以通过 <code>$&#123;&#125;</code> 或者 <strong><code>$()</code></strong> – 推荐 </p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GO=go</span><br><span class="line"><span class="section">build:</span></span><br><span class="line">    @<span class="variable">$(GO)</span> build -v .</span><br></pre></td></tr></table></figure>

<blockquote>
<p>展开后为</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GO=go</span><br><span class="line"><span class="section">build:</span></span><br><span class="line">    @go build -v .</span><br></pre></td></tr></table></figure>

<h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><h4 id=""><a href="#" class="headerlink" title="&#x3D;"></a>&#x3D;</h4><blockquote>
<p>B 最后的值为 c b，取的是<strong>最终</strong>的变量值</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A = a</span><br><span class="line">B = <span class="variable">$(A)</span> b</span><br><span class="line">A = c</span><br></pre></td></tr></table></figure>

<h4 id="-1"><a href="#-1" class="headerlink" title=":&#x3D;"></a>:&#x3D;</h4><blockquote>
<p>B 最后的值为 a b，赋予<strong>当前位置</strong>的值</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A = a</span><br><span class="line">B := $(A) b</span><br><span class="line">A = c</span><br></pre></td></tr></table></figure>

<h4 id="-2"><a href="#-2" class="headerlink" title="?&#x3D;"></a>?&#x3D;</h4><blockquote>
<p>如果该变量<strong>没有被赋值</strong>，则赋予等号后的值</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PLATFORMS ?= linux_amd64 linux_arm64</span><br><span class="line">Arch := X86</span><br><span class="line">Arch ?= ARM</span><br><span class="line"></span><br><span class="line"><span class="section">info:</span></span><br><span class="line">    @echo <span class="variable">$(PLATFORMS)</span></span><br><span class="line">    @echo <span class="variable">$(Arch)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make info </span><br><span class="line">linux_amd64 linux_arm64</span><br><span class="line">X86</span><br></pre></td></tr></table></figure>

<h4 id="-3"><a href="#-3" class="headerlink" title="+&#x3D;"></a>+&#x3D;</h4><blockquote>
<p>将等号后面的值添加到前面的变量</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Archs := X86</span><br><span class="line">Archs += ARM</span><br><span class="line"></span><br><span class="line"><span class="section">info:</span></span><br><span class="line">    @echo <span class="variable">$(Archs)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make info </span><br><span class="line">X86 ARM</span><br></pre></td></tr></table></figure>

<h4 id="多行变量"><a href="#多行变量" class="headerlink" title="多行变量"></a>多行变量</h4><blockquote>
<p>通过 <strong>define</strong> 关键字设置多行变量，变量中允许<strong>换行</strong>，变量的内容可以包含<strong>函数</strong>、<strong>命令</strong>和<strong>变量</strong></p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> USAGE_OPTIONS</span><br><span class="line"></span><br><span class="line"><span class="section">Options:</span></span><br><span class="line">  DEBUG        Whether to generate debug symbols. Default is 0.</span><br><span class="line">  BINS         The binaries to build. Default is all of cmd.</span><br><span class="line">  V            Set to 1 enable verbose build. Default is 0.</span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>

<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><blockquote>
<p>分类：<strong>预定义</strong>的环境变量 + <strong>自定义</strong>的环境变量（可<strong>覆盖</strong>预定义环境变量）<br>环境变量默认<strong>只在当前 Makefile 有效</strong>，如果要<strong>传递</strong>给另一个 Makefile，使用 <strong>export</strong> 关键字来声明</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">export</span> USAGE_OPTIONS</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="特殊变量"><a href="#特殊变量" class="headerlink" title="特殊变量"></a>特殊变量</h3><blockquote>
<p>特殊变量是 make 提前定义好的，可以在 makefile 中直接引用</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/c1cba21aaed2eb0117yyb0470byy641d.webp" alt="c1cba21aaed2eb0117yyb0470byy641d"></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">info:</span></span><br><span class="line">    @echo <span class="string">&quot;MAKE:&quot;</span> <span class="variable">$(MAKE)</span></span><br><span class="line">    @echo <span class="string">&quot;MAKECMDGOALS:&quot;</span> <span class="variable">$(MAKECMDGOALS)</span></span><br><span class="line">    @echo <span class="string">&quot;CURDIR:&quot;</span> <span class="variable">$(CURDIR)</span></span><br><span class="line">    @echo <span class="string">&quot;MAKE_VERSION:&quot;</span> <span class="variable">$(MAKE_VERSION)</span></span><br><span class="line">    @echo <span class="string">&quot;MAKEFILE_LIST:&quot;</span> <span class="variable">$(MAKEFILE_LIST)</span></span><br><span class="line">    @echo <span class="string">&quot;.DEFAULT_GOAL:&quot;</span> $(.DEFAULT_GOAL)</span><br><span class="line">    @echo <span class="string">&quot;.FEATURES:&quot;</span> $(.FEATURES)</span><br><span class="line">    @echo <span class="string">&quot;.INCLOUD_DIRS:&quot;</span> $(.INCLOUD_DIRS)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ make info</span><br><span class="line">MAKE: make</span><br><span class="line">MAKECMDGOALS: info</span><br><span class="line">CURDIR: /Users/zhongmingmao/Downloads/make_file/var</span><br><span class="line">MAKE_VERSION: 4.3</span><br><span class="line">MAKEFILE_LIST: Makefile</span><br><span class="line">.DEFAULT_GOAL: info</span><br><span class="line">.FEATURES: target-specific order-only second-expansion else-if shortest-stem undefine oneshell nocomment grouped-target extra-prereqs archives jobserver output-sync check-symlink load</span><br><span class="line">.INCLOUD_DIRS:</span><br></pre></td></tr></table></figure>

<h3 id="自动化变量"><a href="#自动化变量" class="headerlink" title="自动化变量"></a>自动化变量</h3><blockquote>
<p>作用：提高编写 Makefile 的<strong>效率</strong>和<strong>质量</strong><br>Makefile 的 <strong>targets</strong> 和 <strong>prerequisites</strong> 都是一系列<strong>文件</strong><br>自动化变量：把模式中所定义的一系列文件<strong>自动挨个取出</strong>，一直到所有<strong>符合模式</strong>的文件都取完为止<br>自动化变量只出现在规则的 <strong>command</strong> 中</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/13ec33008eaff973c0dd854a795ff712.webp" alt="13ec33008eaff973c0dd854a795ff712"></p>
<blockquote>
<p><code>$*</code> 使用最为广泛，如果目标文件的<strong>后缀</strong>能被 make 识别，那么 <code>$*</code> 就是<strong>除了后缀</strong>的那部分，如 <code>foo.c</code> -&gt; <code>foo</code></p>
</blockquote>
<h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">info:</span></span><br><span class="line">  <span class="keyword">ifeq</span> (<span class="variable">$(ROOT_PACKAGE)</span>,)</span><br><span class="line">        <span class="variable">$(<span class="built_in">error</span> the variable ROOT_PACKAGE must be set prior to including golang.mk)</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$(info the <span class="built_in">value</span> of ROOT_PACKAGE is <span class="variable">$(ROOT_PACKAGE)</span>)</span></span><br><span class="line">  <span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h3 id="ifeq"><a href="#ifeq" class="headerlink" title="ifeq"></a>ifeq</h3><blockquote>
<p>条件判断，判断是否相等，可以用 make <strong>函数</strong>或者<strong>变量</strong>代替 arg1 或者 arg2</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ifeq (&lt;arg1&gt;, &lt;arg2&gt;)</span><br><span class="line">ifeq &#x27;&lt;arg1&gt;&#x27; &#x27;&lt;arg2&gt;&#x27;</span><br><span class="line">ifeq &quot;&lt;arg1&gt;&quot; &quot;&lt;arg2&gt;&quot;</span><br><span class="line">ifeq &quot;&lt;arg1&gt;&quot; &#x27;&lt;arg2&gt;&#x27;</span><br><span class="line">ifeq &#x27;&lt;arg1&gt;&#x27; &quot;&lt;arg2&gt;&quot;</span><br><span class="line"></span><br><span class="line">ifeq ($(origin ROOT_DIR), undefined) # origin 是函数</span><br><span class="line">ifeq ($(ROOT_PACKAGE), )</span><br></pre></td></tr></table></figure>

<h3 id="ifneq"><a href="#ifneq" class="headerlink" title="ifneq"></a>ifneq</h3><blockquote>
<p>条件判断，判断是否<strong>不相等</strong>，与 <code>ifeq</code> 类似</p>
</blockquote>
<h3 id="ifdef"><a href="#ifdef" class="headerlink" title="ifdef"></a>ifdef</h3><blockquote>
<p>条件判断，判断变量是否<strong>已定义</strong>（如果值非空，则表达式为真，否则为假），也可以是<strong>函数的返回值</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifdef &lt;variable-name&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ifndef"><a href="#ifndef" class="headerlink" title="ifndef"></a>ifndef</h3><blockquote>
<p>条件判断，判断变量是否<strong>未定义</strong>，与 <code>ifdef</code> 类似</p>
</blockquote>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h3><blockquote>
<p>define 本质上是定义一个<strong>多行变量</strong>，可以在 <strong><code>call</code></strong> 的作用下<strong>当作函数</strong>来使用，其它位置只能<strong>当作多行变量</strong>来使用</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: test</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">define</span> Foo</span><br><span class="line">    @echo <span class="string">&quot;func name is $(0)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;params[1] =&gt; $(1)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;params[2] =&gt; $(2)&quot;</span></span><br><span class="line"><span class="keyword">endef</span></span><br><span class="line"></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">    @echo <span class="variable">$(<span class="built_in">call</span> Foo, hello, zhongmingmao)</span> <span class="comment"># 当作函数</span></span><br><span class="line">    @echo <span class="string">&quot;===========&quot;</span></span><br><span class="line">    @echo <span class="variable">$(Foo)</span> <span class="comment"># 当作多行变量</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">@echo func name is Foo</span><br><span class="line">params[1] =&gt;  hello</span><br><span class="line">params[2] =&gt;  zhongmingmao</span><br><span class="line">===========</span><br><span class="line">@echo func name is </span><br><span class="line">params[1] =&gt; </span><br><span class="line">params[2] =&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>自定义函数是一种<strong>过程调用</strong>，<strong>没有任何返回值</strong></p>
</blockquote>
<h3 id="预定义函数"><a href="#预定义函数" class="headerlink" title="预定义函数"></a>预定义函数</h3><blockquote>
<p>arguments 之间使用 <code>,</code> 分隔，函数的参数也可以是变量</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(&lt;function&gt; &lt;arguments&gt;)</span><br><span class="line"></span><br><span class="line">$&#123;&lt;function&gt; &lt;arguments&gt;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all</span></span><br><span class="line"></span><br><span class="line">PLATFORM := linux_amd64</span><br><span class="line">GOOS := <span class="variable">$(<span class="built_in">word</span> 2, $(<span class="built_in">subst</span> _, <span class="string">&quot;&quot;</span>, <span class="variable">$(PLATFORM)</span>)</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">    @echo <span class="variable">$(GOOS)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">amd64</span><br></pre></td></tr></table></figure>

<h2 id="复用"><a href="#复用" class="headerlink" title="复用"></a>复用</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> scripts/make-rules/common.mk</span><br><span class="line"><span class="keyword">include</span> scripts/make-rules/golang.mk</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> scripts/make-rules/*</span><br></pre></td></tr></table></figure>

<blockquote>
<p>忽略无法读取的文件，继续执行</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-include</span> &lt;filename&gt;</span><br></pre></td></tr></table></figure>

<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="功能规划"><a href="#功能规划" class="headerlink" title="功能规划"></a>功能规划</h2><blockquote>
<p>小部分功能是通过目标文件实现的，大部分功能是通过<strong>伪目标</strong>来实现的</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ make help</span><br><span class="line"></span><br><span class="line">Usage: make &lt;TARGETS&gt; &lt;OPTIONS&gt; ...</span><br><span class="line"></span><br><span class="line">Targets:</span><br><span class="line">  build              Build source code for host platform.</span><br><span class="line">  build.multiarch    Build source code for multiple platforms. See option PLATFORMS.</span><br><span class="line">  image              Build docker images for host arch.</span><br><span class="line">  image.multiarch    Build docker images for multiple platforms. See option PLATFORMS.</span><br><span class="line">  push               Build docker images for host arch and push images to registry.</span><br><span class="line">  push.multiarch     Build docker images for multiple platforms and push images to registry.</span><br><span class="line">  deploy             Deploy updated components to development env.</span><br><span class="line">  clean              Remove all files that are created by building.</span><br><span class="line">  lint               Check syntax and styling of go sources.</span><br><span class="line">  test               Run unit test.</span><br><span class="line">  cover              Run unit test and get test coverage.</span><br><span class="line">  release            Release iam</span><br><span class="line">  format             Gofmt (reformat) package sources (exclude vendor dir if existed).</span><br><span class="line">  verify-copyright   Verify the boilerplate headers for all files.</span><br><span class="line">  add-copyright      Ensures source code files have copyright license headers.</span><br><span class="line">  gen                Generate all necessary files, such as error code files.</span><br><span class="line">  ca                 Generate CA files for all iam components.</span><br><span class="line">  install            Install iam system with all its components.</span><br><span class="line">  swagger            Generate swagger document.</span><br><span class="line">  serve-swagger      Serve swagger spec and docs.</span><br><span class="line">  dependencies       Install necessary dependencies.</span><br><span class="line">  tools              install dependent tools.</span><br><span class="line">  check-updates      Check outdated dependencies of the go projects.</span><br><span class="line">  help               Show this help info.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  DEBUG            Whether to generate debug symbols. Default is 0.</span><br><span class="line">  BINS             The binaries to build. Default is all of cmd.</span><br><span class="line">                   This option is available when using: make build/build.multiarch</span><br><span class="line">                   Example: make build BINS=&quot;iam-apiserver iam-authz-server&quot;</span><br><span class="line">  IMAGES           Backend images to make. Default is all of cmd starting with iam-.</span><br><span class="line">                   This option is available when using: make image/image.multiarch/push/push.multiarch</span><br><span class="line">                   Example: make image.multiarch IMAGES=&quot;iam-apiserver iam-authz-server&quot;</span><br><span class="line">  REGISTRY_PREFIX  Docker registry prefix. Default is marmotedu. </span><br><span class="line">                   Example: make push REGISTRY_PREFIX=ccr.ccs.tencentyun.com/marmotedu VERSION=v1.6.2</span><br><span class="line">  PLATFORMS        The multiple platforms to build. Default is linux_amd64 and linux_arm64.</span><br><span class="line">                   This option is available when using: make build.multiarch/image.multiarch/push.multiarch</span><br><span class="line">                   Example: make image.multiarch IMAGES=&quot;iam-apiserver iam-pump&quot; PLATFORMS=&quot;linux_amd64 linux_arm64&quot;</span><br><span class="line">  VERSION          The version information compiled into binaries.</span><br><span class="line">                   The default is obtained from gsemver or git.</span><br><span class="line">  V                Set to 1 enable verbose build. Default is 0.</span><br></pre></td></tr></table></figure>

<h2 id="设计结构"><a href="#设计结构" class="headerlink" title="设计结构"></a>设计结构</h2><blockquote>
<p>分层设计，根目录聚合所有的 Makefile 命令，具体实现则按功能分类，放在另外的 Makefile 中<br>将复杂的 Shell 命令封装在 Shell 脚本中，供 Makefile 直接调用</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/5c524e0297b6d6e4e151643d2e1bbbf7.webp" alt="5c524e0297b6d6e4e151643d2e1bbbf7"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── Makefile</span><br><span class="line">├── scripts</span><br><span class="line">│   ├── gendoc.sh</span><br><span class="line">│   ├── make-rules</span><br><span class="line">│   │   ├── gen.mk</span><br><span class="line">│   │   ├── golang.mk</span><br><span class="line">│   │   ├── image.mk</span><br><span class="line">│   │   └── ...</span><br><span class="line">    └── ...</span><br></pre></td></tr></table></figure>

<h2 id="编写技巧"><a href="#编写技巧" class="headerlink" title="编写技巧"></a>编写技巧</h2><h3 id="通配符-自动变量"><a href="#通配符-自动变量" class="headerlink" title="通配符 + 自动变量"></a>通配符 + 自动变量</h3><blockquote>
<p>Makefile 允许对 <strong>target</strong> 进行类似正则运算的匹配，主要通配符为 <code>%</code></p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">  @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br></pre></td></tr></table></figure>

<ol>
<li>通过使用通配符，可以使<strong>不同的 target 使用相同的规则</strong>，扩展性更强</li>
<li><code>make tools.verify.swagger</code> 和 <code>make tools.verify.mockgen</code> ，<code>%</code> 分别代表 swagger 和 mockgen<ul>
<li><code>$*</code>：用来指代被匹配的值 <code>swagger</code> 和 <code>mockgen</code></li>
</ul>
</li>
<li>命名清晰：<code>tools.verify.%</code> 位于 <code>scripts/make-rules/tools.mk</code> 的 <code>verify</code> 分类</li>
</ol>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">    @echo <span class="variable">$*</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make tools.verify.swagger</span><br><span class="line">swagger</span><br><span class="line"></span><br><span class="line">$ make tools.verify.mockgen</span><br><span class="line">mockgen</span><br></pre></td></tr></table></figure>

<h3 id="依赖需要用到的工具"><a href="#依赖需要用到的工具" class="headerlink" title="依赖需要用到的工具"></a>依赖需要用到的工具</h3><ol>
<li>如果 Makefile 某个 target 的 command 用到了某个工具，可以将该工具放在 target 的 prerequisites 中</li>
<li>当执行该 target 时，可以检查系统是否安装了该工具，如果没有安装则自动安装，实现更高程度的自动化</li>
</ol>
<blockquote>
<p>format 依赖 tools.verify.golines 和 tools.verify.goimports</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: format</span></span><br><span class="line"><span class="section">format: tools.verify.golines tools.verify.goimports</span></span><br><span class="line">  @echo <span class="string">&quot;===========&gt; Formating codes&quot;</span></span><br><span class="line">  @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> gofmt -s -w</span><br><span class="line">  @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> goimports -w -local <span class="variable">$(ROOT_PACKAGE)</span></span><br><span class="line">  @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> golines -w --max-len=120 --reformat-tags --shorten-comments --ignore-generated .</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>tools.verify.%</code> 会先检查工具是否安装，如果没有安装则通过 <code>tools.install.$*</code> 来安装</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">  @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: install.golines</span></span><br><span class="line"><span class="section">install.golines:</span></span><br><span class="line">  @<span class="variable">$(GO)</span> get -u github.com/segmentio/golines</span><br></pre></td></tr></table></figure>

<h3 id="编写可扩展的-Makefile"><a href="#编写可扩展的-Makefile" class="headerlink" title="编写可扩展的 Makefile"></a>编写可扩展的 Makefile</h3><ol>
<li>可以在<strong>不改变</strong> Makefile 结构的情况下添加新功能 – 设计合理的 Makefile 结构</li>
<li>扩展项目时，新功能可以<strong>自动纳入</strong>到 Makefile 的现有逻辑中 – 利用<strong>通配符</strong>、<strong>自动变量</strong>和<strong>函数</strong>等</li>
</ol>
<blockquote>
<p>执行 make go.build 时可以构建 <code>cmd/</code> 目录下的<strong>所有组件</strong></p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">COMMANDS ?= <span class="variable">$(<span class="built_in">filter</span>-out %.md, $(<span class="built_in">wildcard</span> $&#123;ROOT_DIR&#125;/cmd/*)</span>)</span><br><span class="line">BINS ?= <span class="variable">$(<span class="built_in">foreach</span> cmd,$&#123;COMMANDS&#125;,$(<span class="built_in">notdir</span> $&#123;cmd&#125;)</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: go.build</span></span><br><span class="line"><span class="section">go.build: go.build.verify $(addprefix go.build., $(addprefix <span class="variable">$(PLATFORM)</span>., <span class="variable">$(BINS)</span>))</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: go.build.%               </span></span><br><span class="line"></span><br><span class="line"><span class="section">go.build.%:</span></span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> COMMAND := $(<span class="built_in">word</span> 2,$(<span class="built_in">subst</span> ., ,<span class="variable">$*</span>)</span>))</span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> PLATFORM := $(<span class="built_in">word</span> 1,$(<span class="built_in">subst</span> ., ,<span class="variable">$*</span>)</span>))</span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> OS := $(<span class="built_in">word</span> 1,$(<span class="built_in">subst</span> _, ,<span class="variable">$(PLATFORM)</span>)</span>))           </span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> ARCH := $(<span class="built_in">word</span> 2,$(<span class="built_in">subst</span> _, ,<span class="variable">$(PLATFORM)</span>)</span>))                         </span><br><span class="line">  @echo <span class="string">&quot;===========&gt; Building binary <span class="variable">$(COMMAND)</span> <span class="variable">$(VERSION)</span> for <span class="variable">$(OS)</span> <span class="variable">$(ARCH)</span>&quot;</span></span><br><span class="line">  @mkdir -p <span class="variable">$(OUTPUT_DIR)</span>/platforms/<span class="variable">$(OS)</span>/<span class="variable">$(ARCH)</span></span><br><span class="line">  @CGO_ENABLED=0 GOOS=<span class="variable">$(OS)</span> GOARCH=<span class="variable">$(ARCH)</span> <span class="variable">$(GO)</span> build <span class="variable">$(GO_BUILD_FLAGS)</span> -o <span class="variable">$(OUTPUT_DIR)</span>/platforms/<span class="variable">$(OS)</span>/<span class="variable">$(ARCH)</span>/<span class="variable">$(COMMAND)</span><span class="variable">$(GO_OUT_EXT)</span> <span class="variable">$(ROOT_PACKAGE)</span>/cmd/<span class="variable">$(COMMAND)</span></span><br></pre></td></tr></table></figure>

<h3 id="设置-OPTIONS"><a href="#设置-OPTIONS" class="headerlink" title="设置 OPTIONS"></a>设置 OPTIONS</h3><blockquote>
<p>是否有定义</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> USAGE_OPTIONS    </span><br><span class="line">                         </span><br><span class="line"><span class="section">Options:</span></span><br><span class="line">  ...</span><br><span class="line">  BINS         The binaries to build. Default is all of cmd.</span><br><span class="line">               ...</span><br><span class="line">  ...</span><br><span class="line">  V            Set to 1 enable verbose build. Default is 0.    </span><br><span class="line"><span class="keyword">endef</span>    </span><br><span class="line"><span class="keyword">export</span> USAGE_OPTIONS</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifndef</span> V    </span><br><span class="line">MAKEFLAGS += --no-print-directory    </span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">origin</span> V)</span>, undefined)                                </span><br><span class="line">MAKEFLAGS += --no-print-directory              </span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>是否已经被赋值</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BINS ?= <span class="variable">$(<span class="built_in">foreach</span> cmd,$&#123;COMMANDS&#125;,$(<span class="built_in">notdir</span> $&#123;cmd&#125;)</span>)</span><br><span class="line">...</span><br><span class="line"><span class="section">go.build: go.build.verify $(addprefix go.build., $(addprefix <span class="variable">$(PLATFORM)</span>., <span class="variable">$(BINS)</span>))</span></span><br></pre></td></tr></table></figure>

<h3 id="其他技巧"><a href="#其他技巧" class="headerlink" title="其他技巧"></a>其他技巧</h3><ol>
<li>善用（预定义）函数</li>
<li>把常用功能放在 <code>/Makefile</code> 中，不常用功能放在分类的 Makefile 中，并在 <code>/Makefile</code> 中 include 这些分类的 Makefile</li>
<li>将所有输出放在<strong>同一个目录</strong>下，方便清理和查找</li>
<li>使用<strong>带层级</strong>的命名方式，如 <code>tools.verify.swagger</code>，可以实现<strong>目标分组管理</strong></li>
<li>合理地拆分 target，尽量地松耦合</li>
<li>定义环境变量，与编程中的宏类似</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2022/04/23/cloud-native-foundation-go-engineering-foundation-makefile/">https://blog.zhongmingmao.top/2022/04/23/cloud-native-foundation-go-engineering-foundation-makefile/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/go/">Go</a><a class="post-meta__tags" href="/tags/go-engineering/">Go Engineering</a></div><div class="post-share"><div class="social-share" data-image="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-20.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/04/30/cloud-native-foundation-go-engineering-foundation-rd/" title="Go Engineering - Foundation - RD"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-18.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Go Engineering - Foundation - RD</div></div><div class="info-2"><div class="info-item-1">功能需求 为 iamctl 新增 helloworld 命令，该命令向终端打印 hello world  开发阶段代码开发 选择 Git Flow：适用于大型非开源项目     创建分支 基于 develop 分支，新建一个功能分支 feature&#x2F;helloworld  1$ git checkout -b feature/helloworld develop  branch 名要符合 Git Flow 的分支命名规范，会通过 pre-commit 的 githook 来确保分支名符合规范 123$ md5 ./githooks/pre-commit ./.git/hooks/pre-commitMD5 (./githooks/pre-commit) = 3324d20a738461f3b6347f9ce7dae6b6MD5 (./.git/hooks/pre-commit) = 3324d20a738461f3b6347f9ce7dae6b6  ./.git/hooks/pre-commit123456789101112131415161718#!/usr/bin/env bashLC_A...</div></div></div></a><a class="pagination-related" href="/2022/04/16/cloud-native-foundation-go-engineering-foundation-api-rpc/" title="Go Engineering - Foundation - API - RPC"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-12.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Go Engineering - Foundation - API - RPC</div></div><div class="info-2"><div class="info-item-1">RPC    Client 通过本地调用，调用 Client Stub Client Stub 将参数打包（Marshalling）成一个消息，然后发送这个消息 Client 所在的 OS 将消息发送给 Server Server 接收到消息后，将消息传递给 Server Stub（或者 Server Skeleton） Server Stub 将消息解包（Unmarshalling）后得到消息 Server Stub 调用服务端的子程序，处理完成后，将最终结果按照相反的步骤返回给 Client   gRPC概述 gRPC：google Remote Procedure Call gRPC 是由 Google 开发的高性能、开源、跨语言的通用 RPC 框架，基于 HTTP 2.0，默认使用 Protocol Buffers 序列化 gRPC 的特点 支持多语言 基于 IDL（Interface Definition Language）文件定义服务 通过 proto3 生成指定语言的数据结构、服务端接口和客户端 Stub   通信协议基于标准的 HTTP&#x2F;2，支持特性：双向流、消息头压缩、单 T...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/05/10/cloud-native-foundation-go-engineering-cli/" title="Go Engineering - CLI"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-framework.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="info-item-2">Go Engineering - CLI</div></div><div class="info-2"><div class="info-item-1">应用框架 命令行参数解析 - Pflag 配置文件解析 - Viper 应用的命令行框架 - Cobra 命令需要具备 help 功能 命令需要能够解析命令行参数和配置文件 命令需要能够初始化业务代码，并最终启动业务进程      Pflag 命令行参数解析工具 - Kubernetes &#x2F; Istio &#x2F; Helm &#x2F; Docker &#x2F; Etcd &#x2F; …  Flag 一个命令行参数会被解析成一个 Flag 类型的变量  1234567891011121314// A Flag represents the state of a flag.type Flag struct &#123;    Name                string              // name as it appears on command line    Shorthand           string              // one-letter abbreviated flag    Usage               string   ...</div></div></div></a><a class="pagination-related" href="/2023/05/09/cloud-native-foundation-go-engineering-log/" title="Go Engineering - Log"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-log.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="info-item-2">Go Engineering - Log</div></div><div class="info-2"><div class="info-item-1">功能设计基础功能 支持基本的日志信息 - 时间戳、文件名、行号、日志级别、日志信息 支持不同的日志级别 - Debug &#x2F; Info &#x2F; Warn &#x2F; Error &#x2F; Panic &#x2F; Fatal logrus 支持 Trace 日志级别，Trace 不是必须的 Trace 和 Panic 是可选的级别   支持自定义配置 - 不同的环境采用不同的配置 开发环境的日志级别为 Debug，而生产环境的日志级别为 Info 通过配置，可以在不重新编译代码的情况下，改变记录日志的行为   支持输出到标准输出和文件     至少实现 6 个日志级别    日志调用时的属性   输出级别 glog.Info(“This is info message”)   开关级别 启动程序时，期望哪些输出级别的日志会被打印 glog -v=L - 只有输出级别 ≥L 的日志才会被打印     高级功能 支持多种日志格式 - TEXT &#x2F; JSON &#x2F; … 开发环境采用 TEXT 格式，生产环境采用 JSON 格式   按日志级别分类输出 - Error 级别...</div></div></div></a><a class="pagination-related" href="/2023/05/08/cloud-native-foundation-go-engineering-err-code/" title="Go Engineering - Error Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-error-handling.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="info-item-2">Go Engineering - Error Code</div></div><div class="info-2"><div class="info-item-1">预期功能 有业务 Code 码标识 - HTTP Code 码有限 安全 - 对内对外展示不同的错误信息    设计方式 无论请求成功与否，都返回 200，在 HTTP Body 中包含错误信息 HTTP Code 通常代表 HTTP Transport 层的状态信息 缺点：性能不佳（需解析 Body） + 对客户端不友好   返回 4xx or 5xx，并在 Body 中返回简单的错误信息 返回 4xx or 5xx，并在 Body 中返回详细的错误信息 - 推荐  设计思路 区别于 http status code，业务码需要有一定的规则，可以通过业务码判断出是哪类错误 请求出错时，可以通过 http status code，直接感知到请求出错 需要在请求出错时，返回详细的信息：Code + Message + Reference（Optional） 返回的错误信息，需要是可以直接展示给用户的安全信息，不能包含敏感信息 但同时也要有内部更详细的错误信息，方便 Debug   返回的数据格式应该是固定的，规范的 错误信息要保持简洁，并提供有用的信息  Biz Code 纯数字表示，不同部位代表不同的服...</div></div></div></a><a class="pagination-related" href="/2023/05/07/cloud-native-foundation-go-engineering-doc/" title="Go Engineering - Doc"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-doc.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-07</div><div class="info-item-2">Go Engineering - Doc</div></div><div class="info-2"><div class="info-item-1">Swagger Swagger 是一套围绕 OpenAPI 规范构建的开源工具     Component Desc    Swagger Editor 基于浏览器的编辑器，可以编写 OpenAPI 规范，并实时预览   Swagger UI 将 OpenAPI 规范呈现为交互式 API 文档   Swagger Codegen 根据 OpenAPI 规范，生成服务器存根和客户端代码库，涵盖 40 多种语言     OpenAPI OpenAPI 是一个 API 规范，其前身为 Swagger 规范 通过定义一种用来描述 API 格式或者 API 定义的 DSL，来规范 RESTful API 的开发过程 OpenAPI 3.0 ≈ Swagger 2.0   API 基本信息 对 API 的描述，介绍 API 可以实现的功能 每个 API 上可用的 Path 和 Method 每个 API 的输入和返回参数 验证方法 联系信息、许可证、使用条款和其它信息   OpenAPI 是一个 API 规范，而 Swagger 是实现该 API 规范的工具  go-swagger特性 功能强大、高性能、可以根据代...</div></div></div></a><a class="pagination-related" href="/2023/05/06/cloud-native-foundation-go-engineering-lint/" title="Go Engineering - Lint"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-lint.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="info-item-2">Go Engineering - Lint</div></div><div class="info-2"><div class="info-item-1">golangci-lint 使用最多    优点   Advantage Desc    速度快 基于 gometalinter 开发，但比 gometalinter 快 5 倍原因：并行检查 + 复用 go build 缓存 + 缓存分析结果   可配置 支持 YAML 格式的配置文件   IDE 集成 Goland &#x2F; VS Code   linter 聚合器 不需要单独安装   最少误报数 调整了所集成 linter 的默认配置，大幅度减少误报   良好的输出 颜色、行号等   迭代快 不断有新的 linter 被集成到 golangci-lint 中   选项 配置 同时出现 - 命令行选项 &#x2F; 配置文件   bool&#x2F;string&#x2F;int - 命令行选项 slice - 合并  命令行选项 golangci-lint run -h     Flag Desc    –print-issued-lines Print lines of code with issue (default true)   –print-linter-name Print lin...</div></div></div></a><a class="pagination-related" href="/2023/05/05/cloud-native-foundation-go-engineering-makefile/" title="Go Engineering - Makefile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://go-engineering-1253868755.cos.ap-guangzhou.myqcloud.com/go-engineering-makefile.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-05</div><div class="info-item-2">Go Engineering - Makefile</div></div><div class="info-2"><div class="info-item-1">基础语法 https://github.com/seisman/how-to-write-makefile   规则语法 伪目标 变量赋值 特殊变量 自动化变量  功能设计Target   Target Desc    gen Generate all necessary files, such as error code files.   format Gofmt (reformat) package sources (exclude vendor dir if existed).   lint Check syntax and styling of go sources.   test Run unit test.   cover Run unit test and get test coverage.   build Build source code for host platform.   build.multiarch Build source code for multiple platforms. See option PLATFORMS.   image Build docker im...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">639</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%84%E5%88%99"><span class="toc-number">2.</span> <span class="toc-text">规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E8%AF%AD%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">规则语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%AA%E7%9B%AE%E6%A0%87"><span class="toc-number">2.2.</span> <span class="toc-text">伪目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#order-only-%E4%BE%9D%E8%B5%96"><span class="toc-number">2.3.</span> <span class="toc-text">order-only 依赖</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">语法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-number">3.1.</span> <span class="toc-text">命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.</span> <span class="toc-text">变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">变量引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC"><span class="toc-number">3.2.2.</span> <span class="toc-text">变量赋值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">:&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-2"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">?&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-3"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">+&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E8%A1%8C%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">多行变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.3.</span> <span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.4.</span> <span class="toc-text">特殊变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.5.</span> <span class="toc-text">自动化变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ifeq"><span class="toc-number">3.3.1.</span> <span class="toc-text">ifeq</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ifneq"><span class="toc-number">3.3.2.</span> <span class="toc-text">ifneq</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ifdef"><span class="toc-number">3.3.3.</span> <span class="toc-text">ifdef</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ifndef"><span class="toc-number">3.3.4.</span> <span class="toc-text">ifndef</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-number">3.4.1.</span> <span class="toc-text">自定义函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-number">3.4.2.</span> <span class="toc-text">预定义函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%94%A8"><span class="toc-number">3.5.</span> <span class="toc-text">复用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.</span> <span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E8%A7%84%E5%88%92"><span class="toc-number">4.1.</span> <span class="toc-text">功能规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E7%BB%93%E6%9E%84"><span class="toc-number">4.2.</span> <span class="toc-text">设计结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7"><span class="toc-number">4.3.</span> <span class="toc-text">编写技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6-%E8%87%AA%E5%8A%A8%E5%8F%98%E9%87%8F"><span class="toc-number">4.3.1.</span> <span class="toc-text">通配符 + 自动变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">4.3.2.</span> <span class="toc-text">依赖需要用到的工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84-Makefile"><span class="toc-number">4.3.3.</span> <span class="toc-text">编写可扩展的 Makefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-OPTIONS"><span class="toc-number">4.3.4.</span> <span class="toc-text">设置 OPTIONS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8A%80%E5%B7%A7"><span class="toc-number">4.3.5.</span> <span class="toc-text">其他技巧</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/ai-agent.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - Overview"/></a><div class="content"><a class="title" href="/2025/01/18/ai-agent-overview/" title="AI Agent - Overview">AI Agent - Overview</a><time datetime="2025-01-17T16:06:25.000Z" title="Created 2025-01-18 00:06:25">2025-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/17/new-java-feature-foreign-function-api/" title="New Java Feature - Foreign Function API"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-feature-1253868755.cos.ap-guangzhou.myqcloud.com/Java-Foreign-Function-API.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="New Java Feature - Foreign Function API"/></a><div class="content"><a class="title" href="/2025/01/17/new-java-feature-foreign-function-api/" title="New Java Feature - Foreign Function API">New Java Feature - Foreign Function API</a><time datetime="2025-01-16T16:06:25.000Z" title="Created 2025-01-17 00:06:25">2025-01-17</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
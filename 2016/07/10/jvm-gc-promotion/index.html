<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>JVM基础 -- 晋升规则 | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="本文将通过最基本的垃圾收集器（Serial + Serial Old），简单地讲述JVM内存分配和回收过程中的3个基本的晋升规则：大对象直接晋升、对象年龄晋升、动态晋升代码托管在：https:&#x2F;&#x2F;github.com&#x2F;zhongmingmao&#x2F;jvm_demo">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM基础 -- 晋升规则">
<meta property="og:url" content="https://blog.zhongmingmao.top/2016/07/10/jvm-gc-promotion/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="本文将通过最基本的垃圾收集器（Serial + Serial Old），简单地讲述JVM内存分配和回收过程中的3个基本的晋升规则：大对象直接晋升、对象年龄晋升、动态晋升代码托管在：https:&#x2F;&#x2F;github.com&#x2F;zhongmingmao&#x2F;jvm_demo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png">
<meta property="article:published_time" content="2016-07-09T16:06:25.000Z">
<meta property="article:modified_time" content="2023-04-03T10:04:59.587Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="GC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png"><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2016/07/10/jvm-gc-promotion/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":512,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":256},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'JVM基础 -- 晋升规则',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-03 18:04:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">398</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">119</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">61</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ByteCoding"><span class="site-name">ByteCoding</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">JVM基础 -- 晋升规则</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2016-07-09T16:06:25.000Z" title="Created 2016-07-10 00:06:25">2016-07-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">Java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/jvm/">JVM</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/jvm/baisc/">Baisc</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">4.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>20min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>本文将通过最<code>基本</code>的垃圾收集器（<code>Serial</code> + <code>Serial Old</code>），简单地讲述JVM<code>内存分配和回收过程</code>中的<code>3</code>个基本的晋升规则：<code>大对象直接晋升</code>、<code>对象年龄晋升</code>、<code>动态晋升</code><br>代码托管在：<a target="_blank" rel="noopener" href="https://github.com/zhongmingmao/jvm_demo">https://github.com/zhongmingmao/jvm_demo</a></p>
</blockquote>
<span id="more"></span>

<h1 id="XX-UseSerialGC"><a href="#XX-UseSerialGC" class="headerlink" title="-XX:+UseSerialGC"></a>-XX:+UseSerialGC</h1><ol>
<li><code>新生代</code>采用<code>Serial</code>垃圾收集器（<code>Copying</code>算法，<code>单线程</code>，<code>Stop The World</code>）</li>
<li><code>老年代</code>采用<code>Serial Old</code>垃圾收集器（<code>Mark-Compact</code>算法，<code>单线程</code>，<code>Stop The World</code>）</li>
</ol>
<h1 id="Minor-GC-x2F-Major-GC-x2F-Full-GC"><a href="#Minor-GC-x2F-Major-GC-x2F-Full-GC" class="headerlink" title="Minor GC &#x2F; Major GC &#x2F; Full GC"></a>Minor GC &#x2F; Major GC &#x2F; Full GC</h1><h2 id="常规理解"><a href="#常规理解" class="headerlink" title="常规理解"></a>常规理解</h2><ol>
<li><code>Eden</code>空间不够 ➔ <code>Minor GC</code> ➔ 回收<code>Young Generation</code></li>
<li><code>Old Generation</code>空间不够 ➔ <code>Major GC</code> ➔ 回收<code>Old Generation</code></li>
<li><code>Method Area</code>（<code>Java 8</code>开始由<code>MetaSpace</code>实现，之前由<code>Permanent Generation</code>实现）空间不够 ➔ <code>Full GC</code> ➔ 回收<code>Young Generation</code>+<code>Old Generation</code>+<code>Method Area</code></li>
</ol>
<p>最难区分的是<code>Major GC</code>和<code>Full GC</code>，其实并没有明确规定两者的区别，因此不要以<code>Minor GC</code>、<code>Major GC</code>、<code>Full GC</code>的方式来思考问题，而应该关注</p>
<ol>
<li><code>GC</code>是否需要<code>Stop-The-World</code></li>
<li><code>GC</code>能否<code>并发</code>（不是并行，是并发！）</li>
<li>应用的<code>延迟</code>和<code>吞吐量</code></li>
</ol>
<p>本文认为<code>Major GC</code> ≈ <code>Full GC</code>，不作区分</p>
<h2 id="Minor-GC"><a href="#Minor-GC" class="headerlink" title="Minor GC"></a>Minor GC</h2><ol>
<li>发生在<code>新生代</code>，当<code>Eden</code>区域没有足够空间进行分配</li>
<li>Java对象大多具有<code>短命</code>的特性</li>
<li><code>Minor GC</code>非常<code>频繁</code>，速度也比较<code>快</code></li>
<li><code>Minor GC</code>会造成<code>Stop-The-World</code>，但由于<code>新生代</code>的对象为大多为<code>短命</code>对象，因此由<code>Stop-The-World</code>而造成的延迟可以忽略</li>
</ol>
<h2 id="Major-GC-x2F-Full-GC"><a href="#Major-GC-x2F-Full-GC" class="headerlink" title="Major GC &#x2F; Full GC"></a>Major GC &#x2F; Full GC</h2><ol>
<li>发生在<code>老年代</code></li>
<li>出现<code>Major GC</code>，经常伴随<code>至少一次Minor GC</code></li>
<li>速度比较<code>慢</code>，<code>SpeedOf(Minor GC) ≈ 10 * SpeedOf(Major GC)</code></li>
<li><code>Major GC</code>也会造成<code>Stop-The-World</code>，但由于<code>老年代</code>的对象为大多为<code>长命</code>对象，因此由<code>Stop-The-World</code>而造成的延迟可能会比较大，因此才会出现<code>并发收集器</code>：<code>CMS</code>和<code>G1</code>（Java 9默认）</li>
</ol>
<h1 id="大对象直接晋升"><a href="#大对象直接晋升" class="headerlink" title="大对象直接晋升"></a>大对象直接晋升</h1><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JVM Args : -Xms20m -Xmx20m -Xmn10m -XX:SurvivorRatio=8 -XX:+UseSerialGC -XX:+PrintGCDetails</span></span><br><span class="line"><span class="comment">// 堆大小：20M</span></span><br><span class="line"><span class="comment">// 新生代大小：10M</span></span><br><span class="line"><span class="comment">// Eden区大小：8M</span></span><br><span class="line"><span class="comment">// Survivor区大小：1M</span></span><br><span class="line"><span class="comment">// 老年代大小：10M</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinorGCAndFullGC</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_1MB</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.gc();</span><br><span class="line">        <span class="type">byte</span>[] b1 = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">5</span> * _1MB];</span><br><span class="line">        <span class="type">byte</span>[] b2 = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">5</span> * _1MB];<span class="comment">// 1次Minor GC</span></span><br><span class="line">        <span class="type">byte</span>[] b3 = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">5</span> * _1MB];<span class="comment">// 1次Minor GC + 1次Full GC ⇒ OOM</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Full GC (System.gc()) [Tenured: 0K-&gt;467K(10240K), 0.0037172 secs] 2217K-&gt;467K(19456K), [Metaspace: 3177K-&gt;3177K(1056768K)], 0.0037645 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">[GC (Allocation Failure) [DefNew: 5447K-&gt;4K(9216K), 0.0036997 secs] 5915K-&gt;5592K(19456K), 0.0037186 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">[GC (Allocation Failure) [DefNew: 5209K-&gt;5209K(9216K), 0.0000165 secs][Tenured: 5587K-&gt;5587K(10240K), 0.0029173 secs] 10796K-&gt;10713K(19456K), [Metaspace: 3270K-&gt;3270K(1056768K)], 0.0029714 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">[Full GC (Allocation Failure) [Tenured: 5587K-&gt;5527K(10240K), 0.0036178 secs] 10713K-&gt;10653K(19456K), [Metaspace: 3270K-&gt;3270K(1056768K)], 0.0036448 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]</span><br><span class="line">Heap</span><br><span class="line"> def new generation   total 9216K, used 5508K [0x00000007bec00000, 0x00000007bf600000, 0x00000007bf600000)</span><br><span class="line">  eden space 8192K,  67% used [0x00000007bec00000, 0x00000007bf161370, 0x00000007bf400000)</span><br><span class="line">  from space 1024K,   0% used [0x00000007bf500000, 0x00000007bf500000, 0x00000007bf600000)</span><br><span class="line">  to   space 1024K,   0% used [0x00000007bf400000, 0x00000007bf400000, 0x00000007bf500000)</span><br><span class="line"> tenured generation   total 10240K, used 5527K [0x00000007bf600000, 0x00000007c0000000, 0x00000007c0000000)</span><br><span class="line">   the space 10240K,  53% used [0x00000007bf600000, 0x00000007bfb65f68, 0x00000007bfb66000, 0x00000007c0000000)</span><br><span class="line"> Metaspace       used 3330K, capacity 4496K, committed 4864K, reserved 1056768K</span><br><span class="line">  class space    used 370K, capacity 388K, committed 512K, reserved 1048576K</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</span><br></pre></td></tr></table></figure>

<h2 id="运行过程"><a href="#运行过程" class="headerlink" title="运行过程"></a>运行过程</h2><h3 id="System-gc"><a href="#System-gc" class="headerlink" title="System.gc()"></a>System.gc()</h3><p>对应的GC日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Full GC (System.gc()) [Tenured: 0K-&gt;467K(10240K), 0.0037172 secs] 2217K-&gt;467K(19456K), [Metaspace: 3177K-&gt;3177K(1056768K)], 0.0037645 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br></pre></td></tr></table></figure>
<ol>
<li>进行<code>Full GC</code>的原因是代码调用<code>System.gc()</code></li>
<li><code>堆</code>总大小为<code>19456K</code> ≈ <code>20M</code></li>
<li><code>老年代</code>（<code>Tenured Generation</code>）总大小为<code>10240K</code> &#x3D; <code>10M</code>，目前占用<code>467K</code>，可忽略</li>
<li><code>新生代</code>（<code>Def New Generation</code>）目前占用<code>467K-467K=0K</code>，总大小 &#x3D; 堆大小 - 老年代大小 ≈ <code>10M</code>，<code>SurvivorRatio=8</code>，因此<code>Eden</code>区大小为<code>8M</code>，<code>Survivor</code>区大小为<code>1M</code></li>
</ol>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jvm-1253868755.cos.ap-guangzhou.myqcloud.com/gc_1_system_gc.png" width="500">

<h3 id="byte-b1-x3D-new-byte-5-1MB"><a href="#byte-b1-x3D-new-byte-5-1MB" class="headerlink" title="byte[] b1 &#x3D; new byte[5 * _1MB]"></a>byte[] b1 &#x3D; new byte[5 * _1MB]</h3><p><code>Eden区</code>有<code>8M</code>空闲空间，能完全容纳<code>b1</code>，不会进行<code>GC</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jvm-1253868755.cos.ap-guangzhou.myqcloud.com/gc_1_b1.png" width="500"></p>
<h3 id="byte-b2-x3D-new-byte-5-1MB"><a href="#byte-b2-x3D-new-byte-5-1MB" class="headerlink" title="byte[] b2 &#x3D; new byte[5 * _1MB]"></a>byte[] b2 &#x3D; new byte[5 * _1MB]</h3><p>对应的GC日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 5447K-&gt;4K(9216K), 0.0036997 secs] 5915K-&gt;5592K(19456K), 0.0037186 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jvm-1253868755.cos.ap-guangzhou.myqcloud.com/gc_1_b2.png" width="500">
1. `Eden`区只有`8M`，此时已经分配了`b1`，最多只剩下`3M`的可用空间，`Serial`采集器采用`Copying`算法，不足以容纳`b2`，触发`Minor GC`
2. 进行`Minor GC`的原因是`Allocation Failure`，即内存分配失败，与上面分析一致
3. 进行`Minor GC`，首先尝试将`Eden`区和`Survivor 0`区中的`存活对象`一起移到`Survivor 1`区，`b1`是强引用，依旧存活，但由于`Survivor 1`区只有`1M`，无法容纳`b1`，尝试将`b1`直接晋升到`Tenured`区
4. 此时`Tenured`有`10M`的可用空间，能容纳`b1`，可以将`b1`晋升到`Tenured`区，并释放`b1`原本在`Eden`区占用的内存空间
5. `Minor GC`结束后，`b2`便能顺利地在`Eden`区进行分配

<h3 id="byte-b3-x3D-new-byte-5-1MB"><a href="#byte-b3-x3D-new-byte-5-1MB" class="headerlink" title="byte[] b3 &#x3D; new byte[5 * _1MB]"></a>byte[] b3 &#x3D; new byte[5 * _1MB]</h3><p>对应的GC日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 5209K-&gt;5209K(9216K), 0.0000165 secs][Tenured: 5587K-&gt;5587K(10240K), 0.0029173 secs] 10796K-&gt;10713K(19456K), [Metaspace: 3270K-&gt;3270K(1056768K)], 0.0029714 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">[Full GC (Allocation Failure) [Tenured: 5587K-&gt;5527K(10240K), 0.0036178 secs] 10713K-&gt;10653K(19456K), [Metaspace: 3270K-&gt;3270K(1056768K)], 0.0036448 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]</span><br></pre></td></tr></table></figure>
<ol>
<li>由于<code>Eden</code>区此时最多有<code>3M</code>的可用空间，要分配<code>b3</code>，首先触发一次<code>Minor GC</code></li>
<li>由于内存空间（<code>Eden</code>、<code>Survivor 0</code>、<code>Tenured</code>）不足，<code>Minor GC</code>也会失败，进而触发<code>Full GC</code></li>
<li><code>Tenured</code>区采用<code>Serial Old</code>收集器，<code>Full GC</code>时会尝试采用<code>Mark-Compact</code>算法进行GC，但依旧会失败，进而导致抛出<code>OutOfMemoryError</code></li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>尽量避免使用**<code>需要连续内存空间的短命大对象</code>**，例如<code>长字符串</code>和<code>基本类型的大数组</code>，因为这会导致<code>Minor GC</code>的时候，这些短命大对象有可能会<code>直接晋升</code>到老年代，进而<code>加大Full GC的频率</code></p>
<h1 id="对象年龄晋升"><a href="#对象年龄晋升" class="headerlink" title="对象年龄晋升"></a>对象年龄晋升</h1><p>对象每经历一次<code>Minor GC</code>，年龄就会增加<code>1</code>，到了一定的阈值(<code>-XX:MaxTenuringThreshold</code>，默认是<code>15</code>)，就会<code>晋升</code>到老年代</p>
<h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验JVM参数 -XX:MaxTenuringThreshold</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhongmingmao zhongmingmao0625@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenuringThreshold</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_10MB</span> <span class="operator">=</span> <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Pattern</span> <span class="variable">BIN_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\(((\\d&#123;8&#125;\\s?)&#123;4&#125;)\\)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JVM Args : -Xms200m -Xmx200m -Xmn100m -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=3</span></span><br><span class="line">    <span class="comment">// -XX:+UseSerialGC -XX:+PrintGCDetails  -Djol.tryWithSudo=true</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.gc();</span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[_10MB / <span class="number">4</span>];</span><br><span class="line">        System.out.println(String.format(<span class="string">&quot;Init Address : %s\n&quot;</span>, VM.current().addressOf(b)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i) &#123;</span><br><span class="line">            <span class="comment">// 从i=1开始，每分配一次bytes，就会触发一次Minor GC</span></span><br><span class="line">            <span class="comment">// 当对象b的GCAge &lt; MaxTenuringThreshold -&gt; 在两个Survivor区之间来回移动</span></span><br><span class="line">            <span class="comment">// 当对象b的GCAge &gt;= MaxTenuringThreshold -&gt; 晋升到Tenured区</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">5</span> * _10MB];</span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;Address[%s] : %s , GC Age : %s&quot;</span>, i,</span><br><span class="line">                    VM.current().addressOf(b),</span><br><span class="line">                    getObjectGCAge(b)));</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对象的GC年龄&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * Java对象头结构 See http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/oops/markOop.hpp</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getObjectGCAge</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        ClassLayout.parseInstance(object).toPrintable()的完整格式</span></span><br><span class="line"><span class="comment">        [B object internals:</span></span><br><span class="line"><span class="comment">         OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span></span><br><span class="line"><span class="comment">              0     4        (object header)                           19 00 00 00 (00011001 00000000 00000000</span></span><br><span class="line"><span class="comment">              00000000) (25)</span></span><br><span class="line"><span class="comment">              4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000</span></span><br><span class="line"><span class="comment">              00000000) (0)</span></span><br><span class="line"><span class="comment">              8     4        (object header)                           f5 00 00 f8 (11110101 00000000 00000000</span></span><br><span class="line"><span class="comment">              11111000) (-134217483)</span></span><br><span class="line"><span class="comment">             12     4        (object header)                           00 00 28 00 (00000000 00000000 00101000</span></span><br><span class="line"><span class="comment">             00000000) (2621440)</span></span><br><span class="line"><span class="comment">             16 2621440   byte [B.&lt;elements&gt;                             N/A</span></span><br><span class="line"><span class="comment">        Instance size: 2621456 bytes</span></span><br><span class="line"><span class="comment">        Space losses: 0 bytes internal + 0 bytes external = 0 bytes total</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> ClassLayout.parseInstance(object).toPrintable().split(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>];</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> BIN_PATTERN.matcher(line);</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(matcher.group(<span class="number">1</span>).split(<span class="string">&quot;\\s&quot;</span>)[<span class="number">0</span>].substring(<span class="number">1</span>, <span class="number">5</span>), <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[Full GC (System.gc()) [Tenured: 0K-&gt;452K(102400K), 0.0032760 secs] 6555K-&gt;452K(194560K), [Metaspace: 3198K-&gt;3198K(1056768K)], 0.0033038 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">Init Address : 33076281344</span><br><span class="line"></span><br><span class="line">Address[0] : 33076281344 , GC Age : 0</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 70169K-&gt;3565K(92160K), 0.0051274 secs] 70622K-&gt;4017K(194560K), 0.0051485 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class="line">Address[1] : 33170780832 , GC Age : 1</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 57128K-&gt;3417K(92160K), 0.0075981 secs] 57580K-&gt;3869K(194560K), 0.0076253 secs] [Times: user=0.01 sys=0.01, real=0.00 secs]</span><br><span class="line">Address[2] : 33160295048 , GC Age : 2</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 56715K-&gt;3417K(92160K), 0.0020149 secs] 57168K-&gt;3869K(194560K), 0.0020339 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">Address[3] : 33170780808 , GC Age : 3</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 56533K-&gt;0K(92160K), 0.0052362 secs] 56985K-&gt;3870K(194560K), 0.0052590 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</span><br><span class="line">Address[4] : 33181729784 , GC Age : 3</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 52773K-&gt;0K(92160K), 0.0004461 secs] 56643K-&gt;3870K(194560K), 0.0004610 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class="line">Address[5] : 33181729784 , GC Age : 3</span><br><span class="line"></span><br><span class="line">Heap</span><br><span class="line"> def new generation   total 92160K, used 53599K [0x00000007b3800000, 0x00000007b9c00000, 0x00000007b9c00000)</span><br><span class="line">  eden space 81920K,  65% used [0x00000007b3800000, 0x00000007b6c57cd8, 0x00000007b8800000)</span><br><span class="line">  from space 10240K,   0% used [0x00000007b9200000, 0x00000007b92000f0, 0x00000007b9c00000)</span><br><span class="line">  to   space 10240K,   0% used [0x00000007b8800000, 0x00000007b8800000, 0x00000007b9200000)</span><br><span class="line"> tenured generation   total 102400K, used 3869K [0x00000007b9c00000, 0x00000007c0000000, 0x00000007c0000000)</span><br><span class="line">   the space 102400K,   3% used [0x00000007b9c00000, 0x00000007b9fc7710, 0x00000007b9fc7800, 0x00000007c0000000)</span><br><span class="line"> Metaspace       used 6569K, capacity 6832K, committed 7040K, reserved 1056768K</span><br><span class="line">  class space    used 765K, capacity 843K, committed 896K, reserved 1048576K</span><br></pre></td></tr></table></figure>

<h3 id="byte-b-x3D-new-byte-10MB-x2F-4"><a href="#byte-b-x3D-new-byte-10MB-x2F-4" class="headerlink" title="byte[] b &#x3D; new byte[_10MB &#x2F; 4]"></a>byte[] b &#x3D; new byte[_10MB &#x2F; 4]</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Init Address : 33076281344</span><br></pre></td></tr></table></figure>
<p>尝试分配<code>对象b</code>到**<code>Eden</code>**区，内存空间充足，初始内存地址为<code>33076281344</code>，<code>GC年龄</code>为<code>0</code></p>
<h3 id="循环i-0"><a href="#循环i-0" class="headerlink" title="循环i=0"></a>循环<code>i=0</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Address[0] : 33076281344 , GC Age : 0</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区分配<code>5*_10MB</code>的内存空间，内存空间充足，不需要触发<code>Minor GC</code>，<code>对象b</code>的内存地址<code>不变</code>，依旧是<code>33076281344</code>，在**<code>Eden</code>**区，<code>GC年龄</code>为<code>0</code></p>
<h3 id="循环i-1"><a href="#循环i-1" class="headerlink" title="循环i=1"></a>循环<code>i=1</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 70169K-&gt;3565K(92160K), 0.0051274 secs] 70622K-&gt;4017K(194560K), 0.0051485 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class="line">Address[1] : 33170780832 , GC Age : 1</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=0</code>分配的<code>5*_10MB</code>的内存空间被回收，<code>对象b</code>被移动到了**<code>Survivor 0</code>**区，内存地址变成了<code>33170780832</code>，<code>GC年龄</code>为<code>1</code></p>
<h3 id="循环i-2"><a href="#循环i-2" class="headerlink" title="循环i=2"></a>循环<code>i=2</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 57128K-&gt;3417K(92160K), 0.0075981 secs] 57580K-&gt;3869K(194560K), 0.0076253 secs] [Times: user=0.01 sys=0.01, real=0.00 secs]</span><br><span class="line">Address[2] : 33160295048 , GC Age : 2</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=1</code>分配的<code>5*_10MB</code>的内存空间被回收，<code>对象b</code>被移动到了**<code>Survivor 1</code>**区，内存地址变成了<code>33160295048</code>，<code>GC年龄</code>为<code>2</code></p>
<h3 id="循环i-3"><a href="#循环i-3" class="headerlink" title="循环i=3"></a>循环<code>i=3</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 56715K-&gt;3417K(92160K), 0.0020149 secs] 57168K-&gt;3869K(194560K), 0.0020339 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">Address[3] : 33170780808 , GC Age : 3</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=2</code>分配的<code>5*_10MB</code>的内存空间被回收，<code>对象b</code>**<code>再次</code><strong>被移动到了</strong><code>Survivor 0</code>**区，内存地址变成了<code>33170780808</code>，<code>GC年龄</code>为<code>3</code></p>
<h3 id="循环i-4"><a href="#循环i-4" class="headerlink" title="循环i=4"></a>循环<code>i=4</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 56533K-&gt;0K(92160K), 0.0052362 secs] 56985K-&gt;3870K(194560K), 0.0052590 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</span><br><span class="line">Address[4] : 33181729784 , GC Age : 3</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=3</code>分配的<code>5*_10MB</code>的内存空间被回收，<code>对象b</code>的<code>GC年龄</code>已经达到了<code>MaxTenuringThreshold</code>，可以直接晋升到<code>Tenured</code>区，内存地址变成了<code>33181729784</code>，<code>GC年龄</code>依旧为<code>3</code>,不会再增加</p>
<h3 id="循环i-5"><a href="#循环i-5" class="headerlink" title="循环i=5"></a>循环<code>i=5</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 52773K-&gt;0K(92160K), 0.0004461 secs] 56643K-&gt;3870K(194560K), 0.0004610 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class="line">Address[5] : 33181729784 , GC Age : 3</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=4</code>分配的<code>5*_10MB</code>的内存空间被回收，<code>对象b</code>已经在<code>Tenured</code>区，此时并不是<code>Full GC</code>，内存地址不会改变，依旧是<code>33181729784</code>，<code>GC年龄</code>也依旧是<code>3</code></p>
<h1 id="动态晋升"><a href="#动态晋升" class="headerlink" title="动态晋升"></a>动态晋升</h1><p>在<code>Minor GC</code>时，如果在<code>Survivor</code>中**<code>相同年龄的所有对象大小之和</code>** ≧ <code>0.5 * sizeof(Survivor)</code> ⇒ **<code>大于或等于</code><strong>该年龄的对象</strong><code>直接晋升</code>**到老年代，无须考虑<code>MaxTenuringThreshold</code></p>
<h2 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证动态晋升&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhongmingmao zhongmingmao@0625@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicGCAge</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_10MB</span> <span class="operator">=</span> <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Pattern</span> <span class="variable">BIN_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\(((\\d&#123;8&#125;\\s?)&#123;4&#125;)\\)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JVM Args : -Xms200m -Xmx200m -Xmn100m -XX:SurvivorRatio=8 -XX:+UseSerialGC</span></span><br><span class="line">    <span class="comment">// -XX:+PrintGCDetails -Djol.tryWithSudo=true</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.gc();</span><br><span class="line">        <span class="type">byte</span>[] b0 = <span class="keyword">new</span> <span class="title class_">byte</span>[_10MB / <span class="number">8</span>];</span><br><span class="line">        <span class="type">byte</span>[] b1 = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] b2 = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] b3 = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] b4 = <span class="literal">null</span>;</span><br><span class="line">        System.out.println(getObjectInfo(<span class="string">&quot;b0&quot;</span>, b0));</span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;</span><br><span class="line">            <span class="comment">// i=2才实例化b1~b4,b1的GC年龄比b1~b4大，且b1~b4的总大小等于Survivor区的一半，下次Minor GC，能直接晋升</span></span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">                b1 = <span class="keyword">new</span> <span class="title class_">byte</span>[_10MB / <span class="number">8</span>];</span><br><span class="line">                b2 = <span class="keyword">new</span> <span class="title class_">byte</span>[_10MB / <span class="number">8</span>];</span><br><span class="line">                b3 = <span class="keyword">new</span> <span class="title class_">byte</span>[_10MB / <span class="number">8</span>];</span><br><span class="line">                b4 = <span class="keyword">new</span> <span class="title class_">byte</span>[_10MB / <span class="number">8</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">5</span> * _10MB];</span><br><span class="line"></span><br><span class="line">            System.out.println(getObjectInfo(<span class="string">&quot;b0&quot;</span>, b0));</span><br><span class="line">            System.out.println(getObjectInfo(<span class="string">&quot;b1&quot;</span>, b1));</span><br><span class="line">            System.out.println(getObjectInfo(<span class="string">&quot;b2&quot;</span>, b2));</span><br><span class="line">            System.out.println(getObjectInfo(<span class="string">&quot;b3&quot;</span>, b3));</span><br><span class="line">            System.out.println(getObjectInfo(<span class="string">&quot;b4&quot;</span>, b4));</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getObjectGCAge</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == object) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> ClassLayout.parseInstance(object).toPrintable().split(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>];</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> BIN_PATTERN.matcher(line);</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(matcher.group(<span class="number">1</span>).split(<span class="string">&quot;\\s&quot;</span>)[<span class="number">0</span>].substring(<span class="number">1</span>, <span class="number">5</span>), <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getObjectAddress</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span> == object ? -<span class="number">1</span> : VM.current().addressOf(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getObjectInfo</span><span class="params">(String name, Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Obj[%s] , Address:[%s] , GCAge:[%s]&quot;</span>,</span><br><span class="line">                name,</span><br><span class="line">                getObjectAddress(object),</span><br><span class="line">                getObjectGCAge(object));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行结果-2"><a href="#运行结果-2" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[Full GC (System.gc()) [Tenured: 0K-&gt;484K(102400K), 0.0046554 secs] 6555K-&gt;484K(194560K), [Metaspace: 3346K-&gt;3346K(1056768K)], 0.0047017 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</span><br><span class="line">Obj[b0] , Address:[33076281344] , GCAge:[0]</span><br><span class="line"></span><br><span class="line">Obj[b0] , Address:[33076281344] , GCAge:[0]</span><br><span class="line">Obj[b1] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b2] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b3] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b4] , Address:[-1] , GCAge:[-1]</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 67248K-&gt;2254K(92160K), 0.0069139 secs] 67732K-&gt;2738K(194560K), 0.0069444 secs] [Times: user=0.00 sys=0.01, real=0.01 secs]</span><br><span class="line">Obj[b0] , Address:[33170752344] , GCAge:[1]</span><br><span class="line">Obj[b1] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b2] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b3] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b4] , Address:[-1] , GCAge:[-1]</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 59673K-&gt;7226K(92160K), 0.0059408 secs] 60157K-&gt;7710K(194560K), 0.0059641 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</span><br><span class="line">Obj[b0] , Address:[33160266584] , GCAge:[2]</span><br><span class="line">Obj[b1] , Address:[33161577320] , GCAge:[1]</span><br><span class="line">Obj[b2] , Address:[33162888056] , GCAge:[1]</span><br><span class="line">Obj[b3] , Address:[33164198792] , GCAge:[1]</span><br><span class="line">Obj[b4] , Address:[33165509528] , GCAge:[1]</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 60004K-&gt;0K(92160K), 0.0086877 secs] 60488K-&gt;7710K(194560K), 0.0087102 secs] [Times: user=0.00 sys=0.01, real=0.00 secs]</span><br><span class="line">Obj[b0] , Address:[33181733760] , GCAge:[2]</span><br><span class="line">Obj[b1] , Address:[33183044496] , GCAge:[1]</span><br><span class="line">Obj[b2] , Address:[33184355232] , GCAge:[1]</span><br><span class="line">Obj[b3] , Address:[33185665968] , GCAge:[1]</span><br><span class="line">Obj[b4] , Address:[33186976704] , GCAge:[1]</span><br><span class="line"></span><br><span class="line">[GC (Allocation Failure) [DefNew: 53328K-&gt;0K(92160K), 0.0009302 secs] 61039K-&gt;7710K(194560K), 0.0009761 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">Obj[b0] , Address:[33181733760] , GCAge:[2]</span><br><span class="line">Obj[b1] , Address:[33183044496] , GCAge:[1]</span><br><span class="line">Obj[b2] , Address:[33184355232] , GCAge:[1]</span><br><span class="line">Obj[b3] , Address:[33185665968] , GCAge:[1]</span><br><span class="line">Obj[b4] , Address:[33186976704] , GCAge:[1]</span><br><span class="line"></span><br><span class="line">Heap</span><br><span class="line"> def new generation   total 92160K, used 53610K [0x00000007b3800000, 0x00000007b9c00000, 0x00000007b9c00000)</span><br><span class="line">  eden space 81920K,  65% used [0x00000007b3800000, 0x00000007b6c5aa18, 0x00000007b8800000)</span><br><span class="line">  from space 10240K,   0% used [0x00000007b8800000, 0x00000007b8800050, 0x00000007b9200000)</span><br><span class="line">  to   space 10240K,   0% used [0x00000007b9200000, 0x00000007b9200000, 0x00000007b9c00000)</span><br><span class="line"> tenured generation   total 102400K, used 7710K [0x00000007b9c00000, 0x00000007c0000000, 0x00000007c0000000)</span><br><span class="line">   the space 102400K,   7% used [0x00000007b9c00000, 0x00000007ba387ae8, 0x00000007ba387c00, 0x00000007c0000000)</span><br><span class="line"> Metaspace       used 6608K, capacity 6832K, committed 7040K, reserved 1056768K</span><br><span class="line">  class space    used 765K, capacity 843K, committed 896K, reserved 1048576K</span><br></pre></td></tr></table></figure>

<h3 id="byte-b0-x3D-new-byte-10MB-x2F-8"><a href="#byte-b0-x3D-new-byte-10MB-x2F-8" class="headerlink" title="byte[] b0 &#x3D; new byte[_10MB &#x2F; 8]"></a>byte[] b0 &#x3D; new byte[_10MB &#x2F; 8]</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Obj[b0] , Address:[33076281344] , GCAge:[0]</span><br></pre></td></tr></table></figure>
<p>尝试分配<code>对象b0</code>到**<code>Eden</code>**区，内存空间充足，初始内存地址为<code>33076281344</code>，<code>GC年龄</code>为<code>0</code></p>
<h3 id="循环i-0-1"><a href="#循环i-0-1" class="headerlink" title="循环i=0"></a>循环<code>i=0</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Obj[b0] , Address:[33076281344] , GCAge:[0]</span><br><span class="line">Obj[b1] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b2] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b3] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b4] , Address:[-1] , GCAge:[-1]</span><br></pre></td></tr></table></figure>
<ol>
<li>尝试在<code>Eden</code>区分配<code>5*_10MB</code>的内存空间，内存空间充足，不需要触发<code>Minor GC</code>，<code>对象b0</code>的内存地址<code>不变</code>，依旧是<code>33076281344</code>，在**<code>Eden</code>**区，<code>GC年龄</code>为<code>0</code></li>
<li><code>b1~b4</code>尚未实例化</li>
</ol>
<h3 id="循环i-1-1"><a href="#循环i-1-1" class="headerlink" title="循环i=1"></a>循环<code>i=1</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 67248K-&gt;2254K(92160K), 0.0069139 secs] 67732K-&gt;2738K(194560K), 0.0069444 secs] [Times: user=0.00 sys=0.01, real=0.01 secs]</span><br><span class="line">Obj[b0] , Address:[33170752344] , GCAge:[1]</span><br><span class="line">Obj[b1] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b2] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b3] , Address:[-1] , GCAge:[-1]</span><br><span class="line">Obj[b4] , Address:[-1] , GCAge:[-1]</span><br></pre></td></tr></table></figure>
<ol>
<li>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=0</code>分配的<code>5*_10MB</code>的内存空间被回收，<code>对象b0</code>被移动到了**<code>Survivor 0</code>**区，内存地址变成了<code>33170752344</code>，<code>GC年龄</code>为<code>1</code></li>
<li><code>b1~b4</code>尚未实例化</li>
</ol>
<h3 id="循环i-2-1"><a href="#循环i-2-1" class="headerlink" title="循环i=2"></a>循环<code>i=2</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 59673K-&gt;7226K(92160K), 0.0059408 secs] 60157K-&gt;7710K(194560K), 0.0059641 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</span><br><span class="line">Obj[b0] , Address:[33160266584] , GCAge:[2]</span><br><span class="line">Obj[b1] , Address:[33161577320] , GCAge:[1]</span><br><span class="line">Obj[b2] , Address:[33162888056] , GCAge:[1]</span><br><span class="line">Obj[b3] , Address:[33164198792] , GCAge:[1]</span><br><span class="line">Obj[b4] , Address:[33165509528] , GCAge:[1]</span><br></pre></td></tr></table></figure>
<ol>
<li>尝试在<code>Eden</code>区再分配<code>b1~b4</code>的内存空间，内存空间充足，不会触发<code>Minor GC</code></li>
<li>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=1</code>分配的<code>5*_10MB</code>的内存空间被回收，<code>对象b0</code>被移动到了**<code>Survivor 1</code>**区，内存地址变成了<code>33160266584</code>，<code>GC年龄</code>为<code>2</code></li>
<li>另外这次<code>Minor GC</code>也把<code>b1~b4</code>移动到了**<code>Survivor 1</code>**区，具体信息GC日志所示</li>
</ol>
<h3 id="循环i-3-1"><a href="#循环i-3-1" class="headerlink" title="循环i=3"></a>循环<code>i=3</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 60004K-&gt;0K(92160K), 0.0086877 secs] 60488K-&gt;7710K(194560K), 0.0087102 secs] [Times: user=0.00 sys=0.01, real=0.00 secs]</span><br><span class="line">Obj[b0] , Address:[33181733760] , GCAge:[2]</span><br><span class="line">Obj[b1] , Address:[33183044496] , GCAge:[1]</span><br><span class="line">Obj[b2] , Address:[33184355232] , GCAge:[1]</span><br><span class="line">Obj[b3] , Address:[33185665968] , GCAge:[1]</span><br><span class="line">Obj[b4] , Address:[33186976704] , GCAge:[1]</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=2</code>分配的<code>5*_10MB</code>的内存空间被回收，此时**<code>Survivor 1</code><strong>区中<code>b1~b4</code>具有<code>相同的GC年龄</code>，<code>总大小 = 5M = 0.5 * sizeof(Survivor)</code>，可以进行</strong><code>动态晋升</code>**，所有GC年龄大于等于1的对象都可以直接晋升到老年代，因此<code>b0~b4</code>直接晋升，具体信息GC日志所示</p>
<h3 id="循环i-4-1"><a href="#循环i-4-1" class="headerlink" title="循环i=4"></a>循环<code>i=4</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [DefNew: 53328K-&gt;0K(92160K), 0.0009302 secs] 61039K-&gt;7710K(194560K), 0.0009761 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line">Obj[b0] , Address:[33181733760] , GCAge:[2]</span><br><span class="line">Obj[b1] , Address:[33183044496] , GCAge:[1]</span><br><span class="line">Obj[b2] , Address:[33184355232] , GCAge:[1]</span><br><span class="line">Obj[b3] , Address:[33185665968] , GCAge:[1]</span><br><span class="line">Obj[b4] , Address:[33186976704] , GCAge:[1]</span><br></pre></td></tr></table></figure>
<p>尝试在<code>Eden</code>区再分配<code>5*_10MB</code>的内存空间，内存空间不足，触发<code>Minor GC</code>，循环<code>i=3</code>分配的<code>5*_10MB</code>的内存空间被回收，此时<code>b0~b4</code>都已经在老年代中了，此时只是<code>Minor GC</code>，内存地址和GC年龄都不会改变</p>
<!-- indicate-the-source -->
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2016/07/10/jvm-gc-promotion/">https://blog.zhongmingmao.top/2016/07/10/jvm-gc-promotion/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">Java</a><a class="post-meta__tags" href="/tags/jvm/">JVM</a><a class="post-meta__tags" href="/tags/gc/">GC</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2016/07/15/jvm-class-initialization/" title="JVM基础 -- 类初始化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-7.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">JVM基础 -- 类初始化</div></div></a></div><div class="next-post pull-right"><a href="/2016/07/08/jvm-fake-generic/" title="JVM基础 -- 伪泛型"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">JVM基础 -- 伪泛型</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2019/09/11/java-performance-gc/" title="Java性能 -- GC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-24.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-11</div><div class="title">Java性能 -- GC</div></div></a></div><div><a href="/2022/02/22/jvm-bytecode-manipulation-asm-introduction/" title="ASM - Introduction"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-17.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-22</div><div class="title">ASM - Introduction</div></div></a></div><div><a href="/2022/02/11/jvm-bytecode-manipulation-javassist/" title="Bytecode Manipulation - Javassist"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-16.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-11</div><div class="title">Bytecode Manipulation - Javassist</div></div></a></div><div><a href="/2022/02/10/jvm-bytecode-manipulation-java-agent-practice/" title="Bytecode Manipulation - Java Agent Practice"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-8.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-10</div><div class="title">Bytecode Manipulation - Java Agent Practice</div></div></a></div><div><a href="/2019/09/13/java-performance-jvm-heap-allocation/" title="Java性能 -- JVM堆内存分配"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-6.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-13</div><div class="title">Java性能 -- JVM堆内存分配</div></div></a></div><div><a href="/2019/09/09/java-performance-jit/" title="Java性能 -- JIT"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/go-4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-09</div><div class="title">Java性能 -- JIT</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zhongmingmao</div><div class="author-info__description">Focus on Infrastructure.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">398</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">119</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">61</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#XX-UseSerialGC"><span class="toc-number">1.</span> <span class="toc-text">-XX:+UseSerialGC</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Minor-GC-x2F-Major-GC-x2F-Full-GC"><span class="toc-number">2.</span> <span class="toc-text">Minor GC &#x2F; Major GC &#x2F; Full GC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E7%90%86%E8%A7%A3"><span class="toc-number">2.1.</span> <span class="toc-text">常规理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Minor-GC"><span class="toc-number">2.2.</span> <span class="toc-text">Minor GC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Major-GC-x2F-Full-GC"><span class="toc-number">2.3.</span> <span class="toc-text">Major GC &#x2F; Full GC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E5%AF%B9%E8%B1%A1%E7%9B%B4%E6%8E%A5%E6%99%8B%E5%8D%87"><span class="toc-number">3.</span> <span class="toc-text">大对象直接晋升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">3.2.</span> <span class="toc-text">运行结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">运行过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#System-gc"><span class="toc-number">3.3.1.</span> <span class="toc-text">System.gc()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#byte-b1-x3D-new-byte-5-1MB"><span class="toc-number">3.3.2.</span> <span class="toc-text">byte[] b1 &#x3D; new byte[5 * _1MB]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#byte-b2-x3D-new-byte-5-1MB"><span class="toc-number">3.3.3.</span> <span class="toc-text">byte[] b2 &#x3D; new byte[5 * _1MB]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#byte-b3-x3D-new-byte-5-1MB"><span class="toc-number">3.3.4.</span> <span class="toc-text">byte[] b3 &#x3D; new byte[5 * _1MB]</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.4.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%B9%B4%E9%BE%84%E6%99%8B%E5%8D%87"><span class="toc-number">4.</span> <span class="toc-text">对象年龄晋升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-1"><span class="toc-number">4.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-1"><span class="toc-number">4.2.</span> <span class="toc-text">运行结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#byte-b-x3D-new-byte-10MB-x2F-4"><span class="toc-number">4.2.1.</span> <span class="toc-text">byte[] b &#x3D; new byte[_10MB &#x2F; 4]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-0"><span class="toc-number">4.2.2.</span> <span class="toc-text">循环i&#x3D;0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">循环i&#x3D;1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-2"><span class="toc-number">4.2.4.</span> <span class="toc-text">循环i&#x3D;2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-3"><span class="toc-number">4.2.5.</span> <span class="toc-text">循环i&#x3D;3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-4"><span class="toc-number">4.2.6.</span> <span class="toc-text">循环i&#x3D;4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-5"><span class="toc-number">4.2.7.</span> <span class="toc-text">循环i&#x3D;5</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%99%8B%E5%8D%87"><span class="toc-number">5.</span> <span class="toc-text">动态晋升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-2"><span class="toc-number">5.2.</span> <span class="toc-text">运行结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#byte-b0-x3D-new-byte-10MB-x2F-8"><span class="toc-number">5.2.1.</span> <span class="toc-text">byte[] b0 &#x3D; new byte[_10MB &#x2F; 8]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-0-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">循环i&#x3D;0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-1-1"><span class="toc-number">5.2.3.</span> <span class="toc-text">循环i&#x3D;1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-2-1"><span class="toc-number">5.2.4.</span> <span class="toc-text">循环i&#x3D;2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-3-1"><span class="toc-number">5.2.5.</span> <span class="toc-text">循环i&#x3D;3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFi-4-1"><span class="toc-number">5.2.6.</span> <span class="toc-text">循环i&#x3D;4</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/10/cloud-native-foundation-go-gc/" title="Cloud Native Foundation - Go GC"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/v2-7ed5d9802d90c6b65cb02a212bb65068_720w.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cloud Native Foundation - Go GC"/></a><div class="content"><a class="title" href="/2022/10/10/cloud-native-foundation-go-gc/" title="Cloud Native Foundation - Go GC">Cloud Native Foundation - Go GC</a><time datetime="2022-10-09T16:06:25.000Z" title="Created 2022-10-10 00:06:25">2022-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/09/cloud-computing-region-availability-zone/" title="Cloud Computing - Region + Availability zone"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cloud-computing-1253868755.cos.ap-guangzhou.myqcloud.com/featured-image-cloud-computing.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cloud Computing - Region + Availability zone"/></a><div class="content"><a class="title" href="/2022/10/09/cloud-computing-region-availability-zone/" title="Cloud Computing - Region + Availability zone">Cloud Computing - Region + Availability zone</a><time datetime="2022-10-08T16:06:25.000Z" title="Created 2022-10-09 00:06:25">2022-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/08/cloud-native-foundation-go-scheduling/" title="Cloud Native Foundation - Go Scheduling"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cnf-1253868755.cos.ap-guangzhou.myqcloud.com/go/go-dispatching.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cloud Native Foundation - Go Scheduling"/></a><div class="content"><a class="title" href="/2022/10/08/cloud-native-foundation-go-scheduling/" title="Cloud Native Foundation - Go Scheduling">Cloud Native Foundation - Go Scheduling</a><time datetime="2022-10-07T16:06:25.000Z" title="Created 2022-10-08 00:06:25">2022-10-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/web-js-function/" title="JavaScript - Function"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://web-1253868755.cos.ap-guangzhou.myqcloud.com/js/1_M9cY0UHTbmlBfoPMCQwxYA.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JavaScript - Function"/></a><div class="content"><a class="title" href="/2022/10/07/web-js-function/" title="JavaScript - Function">JavaScript - Function</a><time datetime="2022-10-06T16:06:25.000Z" title="Created 2022-10-07 00:06:25">2022-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/06/web-js-asynchronous/" title="JavaScript - Asynchronous"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://web-1253868755.cos.ap-guangzhou.myqcloud.com/js/es-la-diferencia-entre-Java-y-JavaScript-scaled.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JavaScript - Asynchronous"/></a><div class="content"><a class="title" href="/2022/10/06/web-js-asynchronous/" title="JavaScript - Asynchronous">JavaScript - Asynchronous</a><time datetime="2022-10-05T16:06:25.000Z" title="Created 2022-10-06 00:06:25">2022-10-06</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.pixabay.com/photo/2018/08/27/15/17/fishing-3635221_1280.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2023 By zhongmingmao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>
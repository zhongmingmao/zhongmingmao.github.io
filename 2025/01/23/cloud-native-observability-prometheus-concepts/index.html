<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Observability - Prometheus Concepts | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Data model Prometheus fundamentally stores all data as time series streams of timestamped values belonging to the same metric and the same set of labeled dimensions.   Besides stored time series, Prom">
<meta property="og:type" content="article">
<meta property="og:title" content="Observability - Prometheus Concepts">
<meta property="og:url" content="https://blog.zhongmingmao.top/2025/01/23/cloud-native-observability-prometheus-concepts/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="Data model Prometheus fundamentally stores all data as time series streams of timestamped values belonging to the same metric and the same set of labeled dimensions.   Besides stored time series, Prom">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg">
<meta property="article:published_time" content="2025-01-22T16:06:25.000Z">
<meta property="article:modified_time" content="2025-11-08T14:22:17.178Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Observability">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Observability - Prometheus Concepts",
  "url": "https://blog.zhongmingmao.top/2025/01/23/cloud-native-observability-prometheus-concepts/",
  "image": "https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg",
  "datePublished": "2025-01-22T16:06:25.000Z",
  "dateModified": "2025-11-08T14:22:17.178Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2025/01/23/cloud-native-observability-prometheus-concepts/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Observability - Prometheus Concepts',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">641</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Observability - Prometheus Concepts</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Observability - Prometheus Concepts</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/observability/">Observability</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">9.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>41mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-11-08 22:22:17&quot;}" hidden></div><h1 id="Data-model"><a href="#Data-model" class="headerlink" title="Data model"></a>Data model</h1><ol>
<li>Prometheus fundamentally stores <strong>all data</strong> as <strong>time series</strong><ul>
<li><strong>streams</strong> of <strong>timestamped values</strong> belonging to the <strong>same metric</strong> and the <strong>same set of labeled dimensions</strong>.</li>
</ul>
</li>
<li>Besides <strong>stored time series</strong>, Prometheus may generate <strong>temporary derived time series</strong> as the <strong>result</strong> of <strong>queries</strong>.</li>
</ol>
<span id="more"></span>

<h2 id="Metric-names-and-labels"><a href="#Metric-names-and-labels" class="headerlink" title="Metric names and labels"></a>Metric names and labels</h2><p>Every <strong>time series</strong> is <strong>uniquely identified</strong> by its <strong>metric name</strong> and <strong>optional key-value pairs</strong> called <strong>labels</strong>.</p>
<h3 id="Metric-names"><a href="#Metric-names" class="headerlink" title="Metric names"></a>Metric names</h3><ol>
<li>Metric names <strong>SHOULD</strong> specify the <strong>general feature</strong> of a system that is measured<ul>
<li>e.g. <strong>http_requests_total</strong> - the total number of HTTP requests received</li>
</ul>
</li>
<li>Metric names <strong>MAY</strong> use any <strong>UTF-8</strong> characters.</li>
<li>Metric names <strong>SHOULD</strong> match the regex <code>[a-zA-Z_:][a-zA-Z0-9_:]*</code> for the <strong>best experience and compatibility</strong> (see the warning below).<ul>
<li>Metric names <strong>outside of that set</strong> will require <strong>quoting</strong> e.g. when used in <strong>PromQL</strong></li>
</ul>
</li>
</ol>
<blockquote>
<p>Colons (‘<strong>:</strong>‘) are <strong>reserved</strong> for <strong>user-defined recording rules</strong>. They <strong>SHOULD NOT</strong> be used by <strong>exporters</strong> or <strong>direct instrumentation</strong>.</p>
</blockquote>
<h3 id="Metric-labels"><a href="#Metric-labels" class="headerlink" title="Metric labels"></a>Metric labels</h3><ol>
<li>Labels let you capture <strong>different instances</strong> of the <strong>same metric name</strong>.<ul>
<li>For example: all HTTP requests that used the method POST to the <strong>&#x2F;api&#x2F;tracks</strong> handler.</li>
</ul>
</li>
<li>We refer to this as Prometheus’s “<strong>dimensional data model</strong>“.</li>
<li>The <strong>query language</strong> allows <strong>filtering</strong> and <strong>aggregation</strong> based on these <strong>dimensions</strong>.</li>
<li>The <strong>change</strong> of <strong>any label’s value</strong>, including <strong>adding or removing labels</strong>, will <strong>create a new time series</strong>.<ul>
<li>Label names <strong>MAY</strong> use any <strong>UTF-8</strong> characters.</li>
<li>Label names <strong>beginning</strong> with <code>__</code> (two underscores) MUST be <strong>reserved</strong> for <strong>internal Prometheus use</strong>.</li>
<li>Label names <strong>SHOULD</strong> match the regex <code>[a-zA-Z_][a-zA-Z0-9_]*</code> for the <strong>best experience and compatibility</strong> (see the warning below).<ul>
<li>Label names <strong>outside of that regex</strong> will require <strong>quoting</strong> e.g. when used in <strong>PromQL</strong></li>
</ul>
</li>
<li>Label values <strong>MAY</strong> contain any <strong>UTF-8</strong> characters.</li>
<li>Labels with an <strong>empty label value</strong> are considered <strong>equivalent</strong> to labels that <strong>do not exist</strong>.</li>
</ul>
</li>
</ol>
<blockquote>
<p>WARNING</p>
</blockquote>
<ol>
<li>The <strong>UTF-8 support</strong> for <strong>metric and label names</strong> was added relatively recently in <strong>Prometheus v3.0.0</strong>.</li>
<li>It might <strong>take time</strong> for the <strong>wider ecosystem</strong> to adopt <strong>new quoting mechanisms</strong>, <u>relaxed validation</u> etc.<ul>
<li>downstream PromQL compatible projects and vendors, tooling, third-party instrumentation, collectors, etc.</li>
</ul>
</li>
<li>For the <strong>best compatibility</strong> it’s recommended to <strong>stick</strong> to the <strong>recommended</strong> (“<strong>SHOULD</strong>“) character set.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">指标名称 (Metric Names)</span><br><span class="line"></span><br><span class="line">基本规则</span><br><span class="line"></span><br><span class="line">- 目的: 指定系统测量的通用特征（如 http_requests_total - HTTP请求总数）</span><br><span class="line">- 字符: 可使用任何UTF-8字符</span><br><span class="line">- 推荐格式: 应匹配正则表达式 [a-zA-Z_:][a-zA-Z0-9_:]*</span><br><span class="line">- ⚠️ 重要限制:</span><br><span class="line">  - 冒号 (:) 保留给用户定义的记录规则</span><br><span class="line">  - 导出器或直接仪表化不应使用冒号</span><br><span class="line"></span><br><span class="line">标签 (Labels)</span><br><span class="line"></span><br><span class="line">标签名称规则</span><br><span class="line"></span><br><span class="line">- 作用: 捕获同一指标名称的不同实例（如POST方法、/api/tracks处理器的HTTP请求）</span><br><span class="line">- 字符: 可使用任何UTF-8字符</span><br><span class="line">- 内部保留: 以 __ 开头的标签名称保留给Prometheus内部使用</span><br><span class="line">- 推荐格式: 应匹配正则表达式 [a-zA-Z_][a-zA-Z0-9_]*</span><br><span class="line"></span><br><span class="line">标签值规则</span><br><span class="line"></span><br><span class="line">- 字符: 可包含任何UTF-8字符</span><br><span class="line">- 空值处理: 空标签值等同于标签不存在</span><br><span class="line">- 时间序列: 任何标签值的变更（包括添加/删除标签）都会创建新的时间序列</span><br><span class="line"></span><br><span class="line">维度数据模型</span><br><span class="line"></span><br><span class="line">Prometheus的&quot;维度数据模型&quot;允许查询语言基于这些维度进行过滤和聚合。</span><br><span class="line"></span><br><span class="line">兼容性警告</span><br><span class="line"></span><br><span class="line">- UTF-8支持: 在Prometheus v3.0.0中新增</span><br><span class="line">- 生态兼容: 整个生态系统（PromQL兼容项目、工具、第三方仪表化等）采用新引用机制需要时间</span><br><span class="line">- 最佳实践: 为最佳兼容性，建议遵循推荐的字符集</span><br><span class="line"></span><br><span class="line">这些规则确保了Prometheus指标的一致性和可维护性，同时支持复杂的监控需求。</span><br></pre></td></tr></table></figure>

<h2 id="Samples"><a href="#Samples" class="headerlink" title="Samples"></a>Samples</h2><blockquote>
<p>Samples form the <strong>actual time series data</strong>. Each sample consists of:</p>
</blockquote>
<ol>
<li>a <strong>float64</strong> or <strong>native histogram</strong> value</li>
<li>a <strong>millisecond-precision timestamp</strong>]</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">Float64 vs Native Histogram</span><br><span class="line"></span><br><span class="line">Float64 样本</span><br><span class="line"></span><br><span class="line">value: 123.45 (单个数值)</span><br><span class="line">timestamp: 1695912345678 (毫秒时间戳)</span><br><span class="line"></span><br><span class="line">Native Histogram 样本</span><br><span class="line"></span><br><span class="line">value: &#123;</span><br><span class="line">  count: 1000 (观察次数)</span><br><span class="line">  sum: 12345.67 (所有观察值的总和)</span><br><span class="line">  zero_threshold: 0.001 (零值阈值)</span><br><span class="line">  zero_count: 50 (零值或接近零值的数量)</span><br><span class="line">  schema: 1 (增长因子模式)</span><br><span class="line">  positive_buckets: [</span><br><span class="line">    &#123;upper_bound: 0.1, count: 100&#125;,</span><br><span class="line">    &#123;upper_bound: 1.0, count: 200&#125;,</span><br><span class="line">    &#123;upper_bound: 10.0, count: 300&#125;</span><br><span class="line">  ]</span><br><span class="line">  negative_buckets: [...] (负值桶)</span><br><span class="line">&#125;</span><br><span class="line">timestamp: 1695912345678</span><br><span class="line"></span><br><span class="line">为什么引入 Native Histogram？</span><br><span class="line"></span><br><span class="line">1. 存储效率提升</span><br><span class="line"></span><br><span class="line">传统方案 (多个指标):</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125; 100</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125; 200</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125; 350</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;5.0&quot;&#125; 450</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125; 500</span><br><span class="line">http_request_duration_seconds_sum 1234.56</span><br><span class="line">http_request_duration_seconds_count 500</span><br><span class="line"></span><br><span class="line">Native Histogram (单个指标):</span><br><span class="line">http_request_duration_seconds&#123;...&#125; &#123;包含所有桶信息的一个样本&#125;</span><br><span class="line"></span><br><span class="line">2. 性能优势</span><br><span class="line"></span><br><span class="line">| 方面   | 传统 Histogram | Native Histogram |</span><br><span class="line">|------|--------------|------------------|</span><br><span class="line">| 存储空间 | 多个时间序列       | 单个时间序列           |</span><br><span class="line">| 查询性能 | 需要关联多个指标     | 单次查询获取所有信息       |</span><br><span class="line">| 压缩效率 | 较低           | 更高               |</span><br><span class="line">| 网络传输 | 多个样本         | 单个样本             |</span><br><span class="line"></span><br><span class="line">3. 精度和灵活性</span><br><span class="line"></span><br><span class="line">动态桶边界:</span><br><span class="line">- Native histogram 可以动态调整桶的边界</span><br><span class="line">- 基于观察到的数据分布优化桶的设置</span><br><span class="line">- 减少预定义桶边界的猜测工作</span><br><span class="line"></span><br><span class="line">更高精度:</span><br><span class="line">// 示例：观察延迟分布</span><br><span class="line">histogram.Observe(0.123)  // 自动分配到合适的桶</span><br><span class="line">histogram.Observe(45.678) // 根据数据分布动态调整</span><br><span class="line"></span><br><span class="line">使用场景对比</span><br><span class="line"></span><br><span class="line">Float64 适用场景</span><br><span class="line"></span><br><span class="line"># 简单的计数器、仪表盘</span><br><span class="line">cpu_usage_percent 75.5</span><br><span class="line">memory_available_bytes 2147483648</span><br><span class="line">active_connections 150</span><br><span class="line"></span><br><span class="line">Native Histogram 适用场景</span><br><span class="line"></span><br><span class="line"># 延迟分布、请求大小、响应时间等</span><br><span class="line">http_request_duration_seconds&#123;quantile=&quot;0.95&quot;&#125; 2.5</span><br><span class="line">grpc_request_size_bytes&#123;quantile=&quot;0.50&quot;&#125; 1024</span><br><span class="line"></span><br><span class="line">迁移示例</span><br><span class="line"></span><br><span class="line">之前 (传统方式):</span><br><span class="line">// Go 客户端传统 histogram</span><br><span class="line">hist := prometheus.NewHistogram(prometheus.HistogramOpts&#123;</span><br><span class="line">    Name:    &quot;http_request_duration_seconds&quot;,</span><br><span class="line">    Help:    &quot;HTTP request latency.&quot;,</span><br><span class="line">    Buckets: prometheus.DefBuckets, // [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">现在 (Native Histogram):</span><br><span class="line">// Go 客户端 native histogram</span><br><span class="line">hist := prometheus.NewNativeHistogram(prometheus.NativeHistogramOpts&#123;</span><br><span class="line">    Name:    &quot;http_request_duration_seconds&quot;,</span><br><span class="line">    Help:    &quot;HTTP request latency.&quot;,</span><br><span class="line">    // 无需预定义桶，自动优化</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">查询语法变化</span><br><span class="line"></span><br><span class="line">传统查询:</span><br><span class="line"># 计算 95th 百分位</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line"></span><br><span class="line">Native Histogram 查询:</span><br><span class="line"># 直接查询百分位数</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds[5m]))</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">引入 Native Histogram 的主要动机：</span><br><span class="line"></span><br><span class="line">1. 存储效率: 将多个相关的时间序列合并为一个</span><br><span class="line">2. 性能提升: 减少查询时的数据关联操作</span><br><span class="line">3. 精度改进: 动态桶分配提供更精确的数据分布</span><br><span class="line">4. 简化配置: 无需预定义桶边界</span><br><span class="line">5. 网络优化: 减少传输的数据量</span><br><span class="line"></span><br><span class="line">这是 Prometheus 在 v2.40 版本引入的重大改进，为大规模监控提供了更好的性能和效率。</span><br></pre></td></tr></table></figure>

<h2 id="Notation"><a href="#Notation" class="headerlink" title="Notation"></a>Notation</h2><p>Given <strong>a metric name</strong> and <strong>a set of labels</strong>, time series are frequently identified using this notation:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;metric name&gt;&#123;&lt;label name&gt;=&quot;&lt;label value&gt;&quot;, ...&#125;</span><br></pre></td></tr></table></figure>

<p>For example, a time series with the metric name <u>api_http_requests_total</u> and the labels <u>method&#x3D;”POST”</u> and <u>handler&#x3D;”&#x2F;messages”</u> could be written like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api_http_requests_total&#123;method=&quot;POST&quot;, handler=&quot;/messages&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>This is the <strong>same notation</strong> that <strong>OpenTSDB</strong> uses.</p>
<p>Names with <strong>UTF-8</strong> characters <strong>outside the recommended</strong> set must be <strong>quoted</strong>, using this <strong>notation</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;&lt;metric name&gt;&quot;, &lt;label name&gt;=&quot;&lt;label value&gt;&quot;, ...&#125;</span><br></pre></td></tr></table></figure>

<p>Since <strong>metric name</strong> are <strong>internally represented</strong> as a <strong>label pair</strong> with a <strong>special label name</strong> (<code>__name__=&quot;&lt;metric name&gt;&quot;</code>) one could also use the following notation:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;__name__=&quot;&lt;metric name&gt;&quot;, &lt;label name&gt;=&quot;&lt;label value&gt;&quot;, ...&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Metric-types"><a href="#Metric-types" class="headerlink" title="Metric types"></a>Metric types</h1><ol>
<li>The Prometheus <strong>client libraries</strong> offer <strong>four</strong> core metric types.</li>
<li>These are currently <strong>only differentiated in the client libraries</strong> (to enable <strong>APIs tailored</strong> to the <strong>usage</strong> of the <strong>specific types</strong>) and in the <strong>wire protocol</strong>.</li>
<li>The <strong>Prometheus server</strong> does <strong>not yet</strong> make use of the <strong>type information</strong> and <strong>flattens all data</strong> into <strong>untyped time series</strong>. This may change in the future.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">核心含义</span><br><span class="line"></span><br><span class="line">目前，这些指标类型仅在客户端库和传输协议中有区分，而在 Prometheus 服务器内部，所有类型都以相同的方式存储和处理。</span><br><span class="line"></span><br><span class="line">具体分析</span><br><span class="line"></span><br><span class="line">1. 客户端库的差异化处理</span><br><span class="line"></span><br><span class="line">// Go 客户端库示例</span><br><span class="line">// Counter - 计数器</span><br><span class="line">counter := prometheus.NewCounter(prometheus.CounterOpts&#123;</span><br><span class="line">    Name: &quot;http_requests_total&quot;,</span><br><span class="line">    Help: &quot;Total number of HTTP requests&quot;,</span><br><span class="line">&#125;)</span><br><span class="line">counter.Inc()  // 只能增加，不能减少</span><br><span class="line"></span><br><span class="line">// Gauge - 仪表盘</span><br><span class="line">gauge := prometheus.NewGauge(prometheus.GaugeOpts&#123;</span><br><span class="line">    Name: &quot;memory_usage_bytes&quot;,</span><br><span class="line">    Help: &quot;Current memory usage&quot;,</span><br><span class="line">&#125;)</span><br><span class="line">gauge.Set(1024)  // 可以任意设置值</span><br><span class="line">gauge.Dec()      // 可以减少</span><br><span class="line"></span><br><span class="line">// Histogram - 直方图</span><br><span class="line">histogram := prometheus.NewHistogram(prometheus.HistogramOpts&#123;</span><br><span class="line">    Name: &quot;request_duration_seconds&quot;,</span><br><span class="line">    Help: &quot;Request latency&quot;,</span><br><span class="line">&#125;)</span><br><span class="line">histogram.Observe(0.5)  // 观察值</span><br><span class="line"></span><br><span class="line">2. 传输协议中的类型标识</span><br><span class="line"></span><br><span class="line"># Wire Protocol 示例</span><br><span class="line"># Counter 类型</span><br><span class="line">http_requests_total&#123;method=&quot;GET&quot;&#125; 1234 1695912345678</span><br><span class="line"></span><br><span class="line"># Gauge 类型</span><br><span class="line">memory_usage_bytes&#123;instance=&quot;host1&quot;&#125; 1073741824 1695912345678</span><br><span class="line"></span><br><span class="line"># Histogram 类型</span><br><span class="line">request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125; 100 1695912345678</span><br><span class="line">request_duration_seconds_sum 50.5 1695912345678</span><br><span class="line">request_duration_seconds_count 100 1695912345678</span><br><span class="line"></span><br><span class="line">3. 服务器内部统一处理</span><br><span class="line"></span><br><span class="line">在 Prometheus 服务器内部：</span><br><span class="line">// 内部数据结构 - 所有类型都是时间序列</span><br><span class="line">type Sample struct &#123;</span><br><span class="line">    Value     float64    // 存储数值</span><br><span class="line">    Timestamp int64      // 时间戳</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type TimeSeries struct &#123;</span><br><span class="line">    Labels  Labels       // 标签</span><br><span class="line">    Samples []Sample     // 样本序列</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">4. API 层面的类型化接口</span><br><span class="line"></span><br><span class="line"># Python 客户端库</span><br><span class="line">from prometheus_client import Counter, Gauge, Histogram</span><br><span class="line"></span><br><span class="line"># 不同类型有不同的 API</span><br><span class="line">requests_total = Counter(&#x27;http_requests_total&#x27;, &#x27;Total requests&#x27;)</span><br><span class="line">memory_usage = Gauge(&#x27;memory_usage_bytes&#x27;, &#x27;Memory usage&#x27;)</span><br><span class="line">request_duration = Histogram(&#x27;request_duration_seconds&#x27;, &#x27;Request duration&#x27;)</span><br><span class="line"></span><br><span class="line"># 类型特定的方法</span><br><span class="line">requests_total.inc()              # Counter API</span><br><span class="line">memory_usage.set(1000)            # Gauge API</span><br><span class="line">request_duration.observe(0.5)     # Histogram API</span><br><span class="line"></span><br><span class="line">实际影响</span><br><span class="line"></span><br><span class="line">✅ 客户端层面的优势</span><br><span class="line"></span><br><span class="line">- 类型安全: 防止误用（如对 Counter 进行递减操作）</span><br><span class="line">- 语义清晰: API 体现指标语义</span><br><span class="line">- 使用便利: 提供针对性的方法</span><br><span class="line"></span><br><span class="line">⚠️ 服务器层面的限制</span><br><span class="line"></span><br><span class="line">- 统一存储: 服务器不区分类型，都作为时间序列存储</span><br><span class="line">- 查询时依赖约定: 用户需要知道指标的语义来正确查询</span><br><span class="line">- 类型检查缺失: 服务器端不会验证指标使用是否符合类型约定</span><br><span class="line"></span><br><span class="line">设计哲学</span><br><span class="line"></span><br><span class="line">这种设计体现了 Prometheus 的哲学：</span><br><span class="line">1. 简化: 服务器专注于存储和查询</span><br><span class="line">2. 灵活性: 客户端可以自由选择最适合的指标类型</span><br><span class="line">3. 可扩展性: 新的指标类型可以在客户端实现，无需修改服务器</span><br><span class="line"></span><br><span class="line">示例对比</span><br><span class="line"></span><br><span class="line">// 客户端：有类型区分</span><br><span class="line">counter.Add(1)    // 只能增加</span><br><span class="line">gauge.Set(100)    // 可设置任意值</span><br><span class="line">histogram.Observe(0.5) // 观察值并分布</span><br><span class="line"></span><br><span class="line">// 服务器：统一处理</span><br><span class="line">// 所有数据都是: labelSet -&gt; timestamp -&gt; value 的映射</span><br><span class="line">// 类型信息仅在客户端维护</span><br><span class="line"></span><br><span class="line">这种分离设计让 Prometheus 既保持了服务器的简洁性，又为客户端提供了丰富的类型化API。</span><br></pre></td></tr></table></figure>

<h2 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h2><ol>
<li>A counter is a <strong>cumulative metric</strong> that represents a <strong>single monotonically increasing</strong> counter<ul>
<li>whose value can <strong>only increase</strong> or be <strong>reset to zero</strong> on <strong>restart</strong>.</li>
</ul>
</li>
<li>For example, you can use a counter to represent the number of <strong>requests served</strong>, <strong>tasks completed</strong>, or <strong>errors</strong>.</li>
<li>Do not use a counter to expose a value that can <strong>decrease</strong>.<ul>
<li>For example, do not use a counter for the number of currently running processes; instead use a <strong>gauge</strong>.</li>
</ul>
</li>
<li>Client library usage documentation for counters: <u>Go Java Python Ruby .Net Rust</u></li>
</ol>
<h2 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h2><ol>
<li>A gauge is a metric that represents a <strong>single numerical value</strong> that can arbitrarily go <strong>up</strong> and <strong>down</strong>.</li>
<li>Gauges are typically used for measured values like <strong>temperatures</strong> or <strong>current memory usage</strong><ul>
<li>but also “counts” that can go up and down, like the number of concurrent requests.</li>
</ul>
</li>
<li>Client library usage documentation for gauges: <u>Go Java Python Ruby .Net Rust</u></li>
</ol>
<h2 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h2><ol>
<li>A histogram samples <strong>observations</strong> (usually things like <strong>request durations</strong> or <strong>response sizes</strong>) and <strong>counts</strong> them in <strong>configurable buckets</strong>.</li>
<li>It also provides a <strong>sum</strong> of <strong>all observed values</strong>.</li>
<li>A histogram with a <strong>base metric name</strong> of <code>&lt;basename&gt;</code> exposes <strong>multiple time series</strong> during <strong>a scrape</strong>:<ul>
<li><strong>cumulative counters</strong> for the <strong>observation buckets</strong>, exposed as <code>&lt;basename&gt;_bucket&#123;le=&quot;&lt;upper inclusive bound&gt;&quot;&#125;</code></li>
<li>the total <strong>sum</strong> of <strong>all observed values</strong>, exposed as <code>&lt;basename&gt;_sum</code></li>
<li>the <strong>count</strong> of <strong>events</strong> that have been observed, exposed as <code>&lt;basename&gt;_count</code> (identical to <code>&lt;basename&gt;_bucket&#123;le=&quot;+Inf&quot;</code>} above)</li>
</ul>
</li>
<li>Use the <strong>histogram_quantile()</strong> function to <strong>calculate quantiles</strong> from <strong>histograms</strong> or even <strong>aggregations</strong> of <strong>histograms</strong>.<ul>
<li>A histogram is also <strong>suitable</strong> to calculate an <strong>Apdex score</strong></li>
<li>When operating on buckets, remember that the <strong>histogram</strong> is <strong>cumulative</strong></li>
</ul>
</li>
</ol>
<blockquote>
<p>Apdex score</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">Apdex 基础概念</span><br><span class="line"></span><br><span class="line">Apdex 是一个衡量应用性能的标准化指标，范围从 0 到 1，其中：</span><br><span class="line">- 1.0 = 所有用户都满意</span><br><span class="line">- 0.0 = 所有用户都不满意</span><br><span class="line"></span><br><span class="line">三个性能区域</span><br><span class="line"></span><br><span class="line">满意区域 (Satisfied)    [0, T]           用户满意的响应时间</span><br><span class="line">容忍区域 (Tolerated)    (T, 4T]         用户可容忍的响应时间</span><br><span class="line">不满意区域 (Frustrated)  (4T, ∞)         用户不满意的响应时间</span><br><span class="line"></span><br><span class="line">T = 目标响应时间阈值（如 0.5 秒）</span><br><span class="line"></span><br><span class="line">详细计算公式</span><br><span class="line"></span><br><span class="line">基本公式</span><br><span class="line"></span><br><span class="line">Apdex = (Satisfied + Tolerated/2) / Total</span><br><span class="line"></span><br><span class="line">其中：</span><br><span class="line">- Satisfied: 满意请求数量</span><br><span class="line">- Tolerated: 容忍请求数量</span><br><span class="line">- Total: 总请求数量</span><br><span class="line"></span><br><span class="line">使用 Prometheus Histogram 计算</span><br><span class="line"></span><br><span class="line">假设我们设置：</span><br><span class="line">- T = 0.5 秒（满意阈值）</span><br><span class="line">- 4T = 2.0 秒（不满意阈值）</span><br><span class="line"></span><br><span class="line"># 步骤 1: 计算各区域的请求率</span><br><span class="line"># 满意请求 (≤ 0.5s)</span><br><span class="line">satisfied_rate = sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 总请求 (所有桶，包括 +Inf)</span><br><span class="line">total_rate = sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 容忍请求 (&gt; 0.5s 且 ≤ 2.0s)</span><br><span class="line">tolerated_rate = sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) - satisfied_rate</span><br><span class="line"></span><br><span class="line"># 步骤 2: 计算 Apdex 分数</span><br><span class="line">apdex_score = (satisfied_rate + tolerated_rate/2) / total_rate</span><br><span class="line"></span><br><span class="line">完整的 Apdex 查询</span><br><span class="line"></span><br><span class="line"># 方法 1: 直接计算</span><br><span class="line">(</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) +</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))) / 2</span><br><span class="line">) /</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 方法 2: 使用子查询更清晰</span><br><span class="line">(</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line">  + (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">     sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) * 0.5</span><br><span class="line">)</span><br><span class="line">/</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 方法 3: 多维度 Apdex（按服务分组）</span><br><span class="line">(</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) by (service) +</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) by (service) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) by (service)) * 0.5</span><br><span class="line">) /</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m])) by (service)</span><br><span class="line"></span><br><span class="line">实际数值示例</span><br><span class="line"></span><br><span class="line">假设某服务 5 分钟内的请求分布：</span><br><span class="line">- ≤0.5s: 800 个请求</span><br><span class="line">- ≤2.0s: 150 个请求（新增）</span><br><span class="line">2.0s: 50 个请求</span><br><span class="line"></span><br><span class="line">计算过程：</span><br><span class="line"></span><br><span class="line"># 查询结果示例</span><br><span class="line"># 满意请求率</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line"># 结果: 800/300 = 2.67 requests/second</span><br><span class="line"></span><br><span class="line"># 容忍请求率</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) - sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line"># 结果: 150/300 = 0.5 requests/second</span><br><span class="line"></span><br><span class="line"># 总请求率</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"># 结果: 1000/300 = 3.33 requests/second</span><br><span class="line"></span><br><span class="line"># Apdex 分数</span><br><span class="line">apdex_score = (800 + 150/2) / 1000 = (800 + 75) / 1000 = 0.875</span><br><span class="line"></span><br><span class="line">Apdex 等级标准</span><br><span class="line"></span><br><span class="line">| Apdex 分数  | 性能等级 | 描述     |</span><br><span class="line">|-----------|------|--------|</span><br><span class="line">| 0.94-1.00 | 优秀   | 用户非常满意 |</span><br><span class="line">| 0.85-0.93 | 良好   | 用户满意   |</span><br><span class="line">| 0.70-0.84 | 一般   | 基本可接受  |</span><br><span class="line">| 0.50-0.69 | 较差   | 用户开始不满 |</span><br><span class="line">| 0.00-0.49 | 很差   | 用户体验差  |</span><br><span class="line"></span><br><span class="line">不同应用场景的阈值建议</span><br><span class="line"></span><br><span class="line"># Web 应用 - T = 0.5s</span><br><span class="line">web_apdex = (</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) +</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) * 0.5</span><br><span class="line">) / sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># API 服务 - T = 0.2s</span><br><span class="line">api_apdex = (</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.2&quot;&#125;[5m])) +</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.8&quot;&#125;[5m])) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.2&quot;&#125;[5m])) * 0.5</span><br><span class="line">) / sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 数据库查询 - T = 0.1s</span><br><span class="line">db_apdex = (</span><br><span class="line">  sum(rate(db_query_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125;[5m])) +</span><br><span class="line">  (sum(rate(db_query_duration_seconds_bucket&#123;le=&quot;0.4&quot;&#125;[5m])) -</span><br><span class="line">   sum(rate(db_query_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125;[5m])) * 0.5</span><br><span class="line">) / sum(rate(db_query_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">仪表盘展示</span><br><span class="line"></span><br><span class="line"># 单个服务 Apdex 趋势</span><br><span class="line">label_replace(</span><br><span class="line">  (</span><br><span class="line">    sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) +</span><br><span class="line">    (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">     sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) * 0.5</span><br><span class="line">  ) / sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m])),</span><br><span class="line">  &quot;service&quot;, &quot;web-api&quot;, &quot;job&quot;, &quot;.*&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 多服务 Apdex 对比</span><br><span class="line">(</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) by (service) +</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) by (service) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) by (service)) * 0.5</span><br><span class="line">) / sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m])) by (service)</span><br><span class="line"></span><br><span class="line">SLO 基于Apdex</span><br><span class="line"></span><br><span class="line"># SLO: 95% 的时间内 Apdex ≥ 0.85</span><br><span class="line">avg_over_time(</span><br><span class="line">  (</span><br><span class="line">    sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) +</span><br><span class="line">    (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">     sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) * 0.5</span><br><span class="line">  ) / sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line">  [30d:1d]</span><br><span class="line">) &gt;= 0.85</span><br><span class="line"></span><br><span class="line">通过这种方式，Apdex 将复杂的性能数据简化为单一、直观的分数，便于业务团队理解和决策。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">1. histogram_quantile() 函数使用</span><br><span class="line"></span><br><span class="line">基本用法</span><br><span class="line"></span><br><span class="line"># 计算 95% 请求的分位数</span><br><span class="line">histogram_quantile(0.95, http_request_duration_seconds_bucket)</span><br><span class="line"></span><br><span class="line"># 计算 50% (中位数)</span><br><span class="line">histogram_quantile(0.50, http_request_duration_seconds_bucket)</span><br><span class="line"></span><br><span class="line"># 计算 99%</span><br><span class="line">histogram_quantile(0.99, http_request_duration_seconds_bucket)</span><br><span class="line"></span><br><span class="line">聚合分位数计算</span><br><span class="line"></span><br><span class="line"># 跨多个实例聚合后计算分位数</span><br><span class="line">histogram_quantile(0.95,</span><br><span class="line">    sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 多服务统一的分位数计算</span><br><span class="line">histogram_quantile(0.99,</span><br><span class="line">    sum(rate(http_request_duration_seconds_bucket[5m])) by (le)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">2. Apdex 分数计算</span><br><span class="line"></span><br><span class="line">Apdex (Application Performance Index) 是应用性能指标，基于用户满意度。</span><br><span class="line"></span><br><span class="line">Apdex 计算示例</span><br><span class="line"></span><br><span class="line"># 设定阈值：T=0.5s (满意), 4T=2.0s (不满意边界)</span><br><span class="line"></span><br><span class="line"># 计算 Apdex 分数</span><br><span class="line">(</span><br><span class="line">  # 满意请求 (≤0.5s)</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) +</span><br><span class="line">  # 容忍请求 (&gt;0.5s 但 ≤2.0s) 的一半权重</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) * 0.5</span><br><span class="line">) /</span><br><span class="line"># 总请求数</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">Apdex 分数含义</span><br><span class="line"></span><br><span class="line">- 1.0 = 所有用户都满意</span><br><span class="line">- 0.875 = 87.5% 的用户满意，其余部分满意</span><br><span class="line">- 0.0 = 所有用户都不满意</span><br><span class="line"></span><br><span class="line">3. 累积性 (Cumulative) 特性</span><br><span class="line"></span><br><span class="line">这是 Histogram 最重要的特性！</span><br><span class="line"></span><br><span class="line">累积性解释</span><br><span class="line"></span><br><span class="line">示例：响应时间分布</span><br><span class="line">le=&quot;0.1&quot;  : 10 个请求   (≤ 0.1s 的请求)</span><br><span class="line">le=&quot;0.5&quot;  : 30 个请求   (≤ 0.5s 的请求，包含前面的10个)</span><br><span class="line">le=&quot;1.0&quot;  : 80 个请求   (≤ 1.0s 的请求，包含前面的30个)</span><br><span class="line">le=&quot;2.0&quot;  : 95 个请求   (≤ 2.0s 的请求，包含前面的80个)</span><br><span class="line">le=&quot;+Inf&quot; : 100 个请求 (所有请求)</span><br><span class="line"></span><br><span class="line">实际数据结构</span><br><span class="line"></span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125; 10</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125; 30  # 累积值，不是增量</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125; 80</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125; 95</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125; 100</span><br><span class="line"></span><br><span class="line">4. 累积性的重要性</span><br><span class="line"></span><br><span class="line">正确的理解方式</span><br><span class="line"></span><br><span class="line"># 计算在 0.1s-0.5s 范围内的请求数</span><br><span class="line">range_0_1_to_0_5 = sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) -</span><br><span class="line">                   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125;[5m]))</span><br><span class="line"># 结果: 30 - 10 = 20 个请求</span><br><span class="line"></span><br><span class="line">常见错误理解</span><br><span class="line"></span><br><span class="line"># ❌ 错误：认为 le=&quot;0.5&quot; 只包含 0.5s 的请求</span><br><span class="line"># ✅ 正确：le=&quot;0.5&quot; 包含所有 ≤0.5s 的请求</span><br><span class="line"></span><br><span class="line">5. 实际应用示例</span><br><span class="line"></span><br><span class="line">性能监控仪表盘</span><br><span class="line"></span><br><span class="line"># 1. 分位数监控</span><br><span class="line">P50 = histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line">P95 = histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line">P99 = histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line"></span><br><span class="line"># 2. Apdex 分数监控</span><br><span class="line">Apdex = (</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) +</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) * 0.5</span><br><span class="line">) / sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 3. 平均响应时间</span><br><span class="line">avg_duration = rate(http_request_duration_seconds_sum[5m]) /</span><br><span class="line">               rate(http_request_duration_seconds_count[5m])</span><br><span class="line"></span><br><span class="line">6. Histogram vs Summary 的对比</span><br><span class="line"></span><br><span class="line">| 特性    | Histogram                 | Summary  |</span><br><span class="line">|-------|---------------------------|----------|</span><br><span class="line">| 分位数计算 | 服务器端 histogram_quantile() | 客户端预计算   |</span><br><span class="line">| 聚合能力  | ✅ 可跨实例聚合                  | ❌ 无法聚合   |</span><br><span class="line">| 灵活性   | 查询时计算任意分位数                | 预定义固定分位数 |</span><br><span class="line">| 存储开销  | 多个桶 + count + sum         | 较少时间序列   |</span><br><span class="line">| 使用场景  | 大规模分布式系统                  | 简单体应用    |</span><br><span class="line"></span><br><span class="line">7. 最佳实践</span><br><span class="line"></span><br><span class="line"># 1. 总是使用 rate() 处理直方图数据</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line"></span><br><span class="line"># 2. 聚合时保留桶标签</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service, instance)</span><br><span class="line"></span><br><span class="line"># 3. 结合 count 和 sum 计算其他指标</span><br><span class="line">request_rate = rate(http_request_duration_seconds_count[5m])</span><br><span class="line">avg_response = rate(http_request_duration_seconds_sum[5m]) / request_rate</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">这段话的核心要点：</span><br><span class="line"></span><br><span class="line">1. histogram_quantile() 是计算分位数的主要方法</span><br><span class="line">2. Apdex 可以基于 Histogram 计算用户满意度</span><br><span class="line">3. 累积性 是 Histogram 的关键特性，理解这一点对于正确计算至关重要</span><br><span class="line">4. 聚合优势 使得 Histogram 适合分布式系统的性能监控</span><br><span class="line"></span><br><span class="line">理解这些概念对于有效使用 Prometheus 进行性能监控和 SLO 跟踪至关重要。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总是使用 <strong>rate()</strong> 处理直方图数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">核心原因</span><br><span class="line"></span><br><span class="line">1. Counter 类型的本质</span><br><span class="line"></span><br><span class="line">Histogram 的桶数据本质上是 Counter 类型，它们只会递增，不会减少。</span><br><span class="line"></span><br><span class="line">时间戳1: http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125;  100</span><br><span class="line">时间戳2: http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125;  150  (增加了50)</span><br><span class="line">时间戳3: http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125;  200  (增加了50)</span><br><span class="line"></span><br><span class="line">2. 避免累积值误用</span><br><span class="line"></span><br><span class="line">如果直接使用累积值，会产生误导性的结果：</span><br><span class="line"></span><br><span class="line"># ❌ 错误：直接使用累积值</span><br><span class="line">sum(http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125;)</span><br><span class="line"># 结果：200 (这是从开始到现在的总累积值)</span><br><span class="line"></span><br><span class="line"># ✅ 正确：使用 rate() 计算变化率</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125;[5m]))</span><br><span class="line"># 结果：约0.167 requests/second (每秒新增的请求数)</span><br><span class="line"></span><br><span class="line">详细分析</span><br><span class="line"></span><br><span class="line">3. 时间窗口的重要性</span><br><span class="line"></span><br><span class="line">rate() 函数计算的是指定时间窗口内的平均变化率：</span><br><span class="line"></span><br><span class="line">rate(metric[5m])  # 计算过去5分钟内的平均每秒增长率</span><br><span class="line"></span><br><span class="line">4. 实际数值对比</span><br><span class="line"></span><br><span class="line">假设一个 Web 服务的响应时间分布：</span><br><span class="line"></span><br><span class="line">时间点1 (10:00): http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;  1000</span><br><span class="line">时间点2 (10:01): http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;  1200  (新增200)</span><br><span class="line">时间点3 (10:02): http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;  1400  (新增200)</span><br><span class="line">时间点4 (10:03): http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;  1600  (新增200)</span><br><span class="line"></span><br><span class="line">不使用 rate() 的问题：</span><br><span class="line"></span><br><span class="line"># ❌ 直接查询累积值</span><br><span class="line">sum(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;)</span><br><span class="line"># 结果：1600 (这个数字本身没有实际意义)</span><br><span class="line"></span><br><span class="line"># 计算分位数会得到错误结果</span><br><span class="line">histogram_quantile(0.95, http_request_duration_seconds_bucket)</span><br><span class="line"># 基于累积值计算，无法反映当前性能状况</span><br><span class="line"></span><br><span class="line">使用 rate() 的正确方式：</span><br><span class="line"></span><br><span class="line"># ✅ 计算过去5分钟内的请求率</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line"># 结果：约3.33 requests/second (200/60秒)</span><br><span class="line"></span><br><span class="line"># 正确计算分位数</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line"># 基于变化率计算，反映当前真实的性能分布</span><br><span class="line"></span><br><span class="line">具体示例</span><br><span class="line"></span><br><span class="line">5. 分位数计算的差异</span><br><span class="line"></span><br><span class="line"># 数据：响应时间桶的累积值</span><br><span class="line">le=&quot;0.1&quot;: 1000</span><br><span class="line">le=&quot;0.5&quot;: 1500</span><br><span class="line">le=&quot;1.0&quot;: 1800</span><br><span class="line">le=&quot;2.0&quot;: 1950</span><br><span class="line">le=&quot;+Inf&quot;: 2000</span><br><span class="line"></span><br><span class="line"># ❌ 不使用 rate() - 错误的分位数计算</span><br><span class="line">histogram_quantile(0.95, http_request_duration_seconds_bucket)</span><br><span class="line"># 结果：基于累积值计算，可能得到 1.8s 的错误分位数</span><br><span class="line"></span><br><span class="line"># ✅ 使用 rate() - 正确的分位数计算</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line"># 结果：基于实际请求分布计算，得到真实的 95% 分位数</span><br><span class="line"></span><br><span class="line">6. 仪表盘对比</span><br><span class="line"></span><br><span class="line"># 错误的仪表盘配置（显示累积值）</span><br><span class="line">- title: &quot;满意请求数&quot;</span><br><span class="line">  expr: sum(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;)</span><br><span class="line">  # 显示：从开始累积的总数，数值只会增长</span><br><span class="line"></span><br><span class="line"># 正确的仪表盘配置（显示实时性能）</span><br><span class="line">- title: &quot;满意请求率&quot;</span><br><span class="line">  expr: sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line">  # 显示：每秒满意的请求数，反映当前性能状况</span><br><span class="line"></span><br><span class="line">- title: &quot;95% 响应时间&quot;</span><br><span class="line">  expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line">  # 显示：当前95%请求的响应时间</span><br><span class="line"></span><br><span class="line">特殊情况</span><br><span class="line"></span><br><span class="line">7. 什么时候不使用 rate()？</span><br><span class="line"></span><br><span class="line"># 1. 查询当前累积总数（如总请求数）</span><br><span class="line">sum(http_request_duration_seconds_count)</span><br><span class="line"></span><br><span class="line"># 2. 计算平均值时，rate() 可以抵消</span><br><span class="line"># avg = sum / count</span><br><span class="line">rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])</span><br><span class="line"># 两个 rate() 可以抵消，简化为：</span><br><span class="line">http_request_duration_seconds_sum / http_request_duration_seconds_count</span><br><span class="line"></span><br><span class="line"># 3. 实时状态监控（非趋势分析）</span><br><span class="line"># 但这种情况较少，通常还是用 rate() 更有意义</span><br><span class="line"></span><br><span class="line">8. increase() 替代方案</span><br><span class="line"></span><br><span class="line"># 也可以使用 increase() 计算时间窗口内的总增量</span><br><span class="line">increase(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])</span><br><span class="line"># 结果：过去5分钟内的总增量</span><br><span class="line"></span><br><span class="line"># 等价于：</span><br><span class="line">rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]) * 300 (5分钟*60秒)</span><br><span class="line"></span><br><span class="line">最佳实践总结</span><br><span class="line"></span><br><span class="line"># ✅ 推荐的查询模式</span><br><span class="line"></span><br><span class="line"># 1. 分位数监控</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line"></span><br><span class="line"># 2. Apdex 分数</span><br><span class="line">(</span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) +</span><br><span class="line">  (sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;2.0&quot;&#125;[5m])) -</span><br><span class="line">   sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m])) * 0.5</span><br><span class="line">) / sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 3. 请求速率监控</span><br><span class="line">sum(rate(http_request_duration_seconds_count[5m]))</span><br><span class="line"></span><br><span class="line"># 4. 平均响应时间</span><br><span class="line">rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">使用 rate() 的核心原因：</span><br><span class="line"></span><br><span class="line">1. 避免累积值误导 - Counter 类型的数据是累积的，直接使用没有意义</span><br><span class="line">2. 反映实时性能 - rate() 显示当前的性能趋势，而不是历史累积</span><br><span class="line">3. 正确的分位数计算 - histogram_quantile() 需要基于实际请求分布，不是累积值</span><br><span class="line">4. 有意义的监控 - 只有变化率才能反映系统的实时运行状况</span><br><span class="line"></span><br><span class="line">这是 Prometheus 监控最佳实践的核心原则之一！</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NOTE</p>
</blockquote>
<ol>
<li>Beginning with <strong>Prometheus v2.40</strong>, there is <strong>experimental support</strong> for <strong>native histograms</strong>.</li>
<li>A <strong>native histogram</strong> requires <strong>only one time series</strong>, which includes a <strong>dynamic number of buckets</strong> in addition to the <strong>sum</strong> and <strong>count</strong> of observations.</li>
<li>Native histograms allow <strong>much higher resolution</strong> at a <strong>fraction</strong> of the <strong>cost</strong>.</li>
<li><strong>Detailed documentation</strong> will follow once native histograms are <strong>closer</strong> to becoming a <strong>stable feature</strong>.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Native Histograms 的稳定状态</span><br><span class="line"></span><br><span class="line">🎯 正式稳定版本</span><br><span class="line"></span><br><span class="line">- Prometheus v3.8.0 及以上版本中，Native Histograms 已成为 stable feature</span><br><span class="line">- 不再需要启用 --enable-feature=native-histograms 标志</span><br><span class="line"></span><br><span class="line">📅 发展时间线</span><br><span class="line"></span><br><span class="line">- v2.40.0 (2022年): 首次引入实验性支持，需要启用特性标志</span><br><span class="line">- v3.0.0 (2024年): 改进实验性支持，但仍需标志</span><br><span class="line">- v3.8.0 (2025年): 正式成为稳定功能</span><br><span class="line"></span><br><span class="line">🔍 关键信息来源</span><br><span class="line"></span><br><span class="line">根据 Prometheus 官方文档：</span><br><span class="line">&quot;Starting with v3.8.0, native histograms are supported as a stable feature.&quot;</span><br><span class="line"></span><br><span class="line">Grafana Labs 博客也确认：</span><br><span class="line">&quot;Last week, during PromCon EU 2025, the Prometheus developers announced that native histograms are now stable, after three years of intense testing and improvements.&quot;</span><br><span class="line"></span><br><span class="line">生态系统的支持情况</span><br><span class="line"></span><br><span class="line">✅ 已支持 Native Histograms 的组件</span><br><span class="line"></span><br><span class="line">1. Prometheus Server - v3.8.0+ 稳定支持</span><br><span class="line">2. Grafana Mimir - 已支持（作为 Prometheus 下游项目）</span><br><span class="line">3. Grafana Cloud - 已集成，提供专门的可视化支持</span><br><span class="line">4. OpenTelemetry - 兼容性支持</span><br><span class="line">5. 客户端库 - Go、Java 等官方客户端已支持</span><br><span class="line"></span><br><span class="line">🔄 向后兼容性</span><br><span class="line"></span><br><span class="line">- 现有的经典直方图继续工作</span><br><span class="line">- 两种格式可以并存</span><br><span class="line">- 渐进式迁移路径</span><br><span class="line"></span><br><span class="line">使用建议</span><br><span class="line"></span><br><span class="line">🚀 现在可以安全使用</span><br><span class="line"></span><br><span class="line"># 在 Prometheus v3.8.0+ 中，可以直接使用</span><br><span class="line"># 无需特殊配置或特性标志</span><br><span class="line"></span><br><span class="line"># 查询示例</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds[5m]))</span><br><span class="line"></span><br><span class="line">📊 迁移考虑</span><br><span class="line"></span><br><span class="line">- 新项目可以直接使用 Native Histograms</span><br><span class="line">- 现有项目可以逐步迁移</span><br><span class="line">- 考虑客户端库的兼容性</span><br><span class="line"></span><br><span class="line">💡 优势确认</span><br><span class="line"></span><br><span class="line">经过3年测试，Native Histograms 的优势得到验证：</span><br><span class="line">- 存储效率: 单一时间序列替代多个桶</span><br><span class="line">- 精度提升: 动态桶边界</span><br><span class="line">- 性能优化: 减少网络传输和存储开销</span><br><span class="line">- 简化配置: 无需预定义桶边界</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">是的，Native Histograms 现在是 Prometheus 的稳定功能，可以在生产环境中安全使用。这是一个重大的里程碑，标志着 Prometheus 监控技术的重大进步。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NOTE</p>
</blockquote>
<p>Beginning with <strong>Prometheus v3.0</strong>, the <strong>values</strong> of the <strong>le label</strong> of <strong>classic histograms</strong> are <strong>normalized</strong> during <strong>ingestion</strong> to follow the <strong>format</strong> of <strong>OpenMetrics Canonical Numbers</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">什么是 OpenMetrics Canonical Numbers？</span><br><span class="line"></span><br><span class="line">Canonical Numbers 格式</span><br><span class="line"></span><br><span class="line">OpenMetrics 规范要求数值标签遵循特定的规范格式：</span><br><span class="line">- 整数: 直接使用，如 le=&quot;1&quot;</span><br><span class="line">- 小数: 使用最精确的表示，如 le=&quot;0.1&quot; 而不是 le=&quot;0.10&quot;</span><br><span class="line">- 科学计数法: 对于极大或极小的数，如 le=&quot;1e-6&quot;</span><br><span class="line"></span><br><span class="line">Prometheus v3.0 的变更</span><br><span class="line"></span><br><span class="line">🔄 规范化处理 (Normalization)</span><br><span class="line"></span><br><span class="line">当 Prometheus 采集经典直方图时，会对 le 标签的值进行规范化：</span><br><span class="line"></span><br><span class="line"># 采集前的原始值</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.100&quot;&#125; 100</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.500&quot;&#125; 200</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;1.000&quot;&#125; 350</span><br><span class="line"></span><br><span class="line"># 规范化后的存储值</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125; 100</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125; 200</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;1&quot;&#125; 350</span><br><span class="line"></span><br><span class="line">📝 具体规范化规则</span><br><span class="line"></span><br><span class="line">// 规范化示例</span><br><span class="line">&quot;0.100&quot;   → &quot;0.1&quot;     // 移除尾随零</span><br><span class="line">&quot;1.0&quot;     → &quot;1&quot;       // 整数形式</span><br><span class="line">&quot;0.010&quot;   → &quot;0.01&quot;    // 移除不必要的零</span><br><span class="line">&quot;1000.0&quot;  → &quot;1000&quot;    // 整数形式</span><br><span class="line">&quot;1e-3&quot;    → &quot;0.001&quot;   // 转换为小数形式（在某些情况下）</span><br><span class="line"></span><br><span class="line">为什么要进行规范化？</span><br><span class="line"></span><br><span class="line">1. 标准化兼容性</span><br><span class="line"></span><br><span class="line"># 不同客户端可能发送相同值的不同表示</span><br><span class="line">客户端A: le=&quot;0.500&quot;</span><br><span class="line">客户端B: le=&quot;0.5&quot;</span><br><span class="line">客户端C: le=&quot;5e-1&quot;</span><br><span class="line"></span><br><span class="line"># 规范化后统一为</span><br><span class="line">le=&quot;0.5&quot;</span><br><span class="line"></span><br><span class="line">2. 查询一致性</span><br><span class="line"></span><br><span class="line"># 规范化前，可能需要查询多个变体</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=~&quot;0.5|0.500|0.50&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 规范化后，查询更简单</span><br><span class="line">sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">3. OpenMetrics 合规性</span><br><span class="line"></span><br><span class="line"># 符合 OpenMetrics 1.0 规范</span><br><span class="line"># 确保与其他监控系统的互操作性</span><br><span class="line"></span><br><span class="line">实际影响示例</span><br><span class="line"></span><br><span class="line">📊 监控配置影响</span><br><span class="line"></span><br><span class="line">之前 (v2.x):</span><br><span class="line"># 可能需要处理多种格式</span><br><span class="line">- record: http_request_duration_95th</span><br><span class="line">  expr: histogram_quantile(0.95,</span><br><span class="line">    rate(http_request_duration_seconds_bucket&#123;le=~&quot;0\\.5|0\\.500&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">现在 (v3.0+):</span><br><span class="line"># 格式标准化，查询更简单</span><br><span class="line">- record: http_request_duration_95th</span><br><span class="line">  expr: histogram_quantile(0.95,</span><br><span class="line">    rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">🔧 客户端库影响</span><br><span class="line"></span><br><span class="line">// Go 客户端示例</span><br><span class="line">hist := prometheus.NewHistogram(prometheus.HistogramOpts&#123;</span><br><span class="line">    Name:    &quot;http_request_duration_seconds&quot;,</span><br><span class="line">    Help:    &quot;HTTP request latency&quot;,</span><br><span class="line">    Buckets: []float64&#123;0.1, 0.5, 1.0, 5.0&#125;,  // 这些值在存储时会被规范化</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 查询兼容性: 现有的查询可能需要更新</span><br><span class="line">2. 仪表盘: Grafana 仪表盘中的查询可能需要调整</span><br><span class="line">3. 告警规则: 基于 le 标签的告警规则可能需要修改</span><br><span class="line"></span><br><span class="line">迁移指南</span><br><span class="line"></span><br><span class="line">🔄 查询更新示例</span><br><span class="line"></span><br><span class="line"># 旧查询（可能不兼容）</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket&#123;le=&quot;0.500&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line"># 新查询（推荐）</span><br><span class="line">histogram_quantile(0.95, rate(http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">📈 向后兼容性</span><br><span class="line"></span><br><span class="line">Prometheus v3.0 在处理时会自动规范化，但建议：</span><br><span class="line">1. 检查现有的查询和告警规则</span><br><span class="line">2. 更新硬编码的 le 值</span><br><span class="line">3. 测试仪表盘的兼容性</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">这个变更的主要目的是：</span><br><span class="line"></span><br><span class="line">1. 标准化: 统一数值表示格式</span><br><span class="line">2. 兼容性: 与 OpenMetrics 标准对齐</span><br><span class="line">3. 简化: 让查询和配置更加一致</span><br><span class="line">4. 互操作性: 提升与其他监控系统的集成能力</span><br><span class="line"></span><br><span class="line">这是 Prometheus 向 OpenMetrics 标准靠拢的重要一步，为整个监控生态的标准化做出了贡献。</span><br></pre></td></tr></table></figure>

<p>Client library usage documentation for histograms: <u>Go Java Python Ruby .Net Rust</u></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ol>
<li>Similar to a histogram, a summary <strong>samples observations</strong> (usually things like <strong>request durations</strong> and <strong>response sizes</strong>).</li>
<li>While it also provides a total <strong>count</strong> of <strong>observations</strong> and a <strong>sum</strong> of all <strong>observed values</strong>, it calculates <strong>configurable quantiles</strong> over a <strong>sliding</strong> time window.</li>
<li>A summary with a <strong>base metric name</strong> of <code>&lt;basename&gt;</code> exposes <strong>multiple time series</strong> during a <strong>scrape</strong>:<ul>
<li>streaming <strong>φ-quantiles</strong> (0 ≤ φ ≤ 1) of observed events, exposed as <code>&lt;basename&gt;&#123;quantile=&quot;&lt;φ&gt;&quot;&#125;</code></li>
<li>the <strong>total sum</strong> of all observed values, exposed as <code>&lt;basename&gt;_sum</code></li>
<li>the <strong>count</strong> of events that have been observed, exposed as <code>&lt;basename&gt;_count</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>NOTE</p>
</blockquote>
<p>Beginning with <strong>Prometheus v3.0</strong>, the <strong>values</strong> of the <strong>quantile label</strong> are <strong>normalized</strong> during <strong>ingestion</strong> to follow the format of <strong>OpenMetrics Canonical Numbers</strong></p>
<p>Client library usage documentation for summaries: <u>Go Java Python Ruby .Net</u></p>
<h1 id="Jobs-and-instances"><a href="#Jobs-and-instances" class="headerlink" title="Jobs and instances"></a>Jobs and instances</h1><ol>
<li>In Prometheus terms, an <strong>endpoint</strong> you can <strong>scrape</strong> is called an <strong>instance</strong>, usually corresponding to <strong>a single process</strong>.</li>
<li>A <strong>collection</strong> of <strong>instances</strong> with the <strong>same purpose</strong>, a process <strong>replicated</strong> for <strong>scalability</strong> or <strong>reliability</strong> for example, is called a <strong>job</strong>.</li>
<li>For example, an API server job with four replicated instances:<ul>
<li>job: <code>api-server</code><ul>
<li>instance 1: <code>1.2.3.4:5670</code></li>
<li>instance 2: <code>1.2.3.4:5671</code></li>
<li>instance 3: <code>5.6.7.8:5670</code></li>
<li>instance 4: <code>5.6.7.8:5671</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="Automatically-generated-labels-and-time-series"><a href="#Automatically-generated-labels-and-time-series" class="headerlink" title="Automatically generated labels and time series"></a>Automatically generated labels and time series</h2><ol>
<li>When Prometheus <strong>scrapes</strong> a <strong>target</strong>, it <strong>attaches some labels automatically</strong> to the <strong>scraped time series</strong> which serve to <strong>identify</strong> the scraped <strong>target</strong>:<ul>
<li><strong>job</strong>: The <strong>configured job name</strong> that the target belongs to.</li>
<li><strong>instance</strong>: The <code>&lt;host&gt;:&lt;port&gt;</code> part of the <strong>target’s URL</strong> that was <strong>scraped</strong>.</li>
</ul>
</li>
<li>If either of these labels are already present in the scraped data, the behavior depends on the <strong>honor_labels</strong> configuration option.</li>
</ol>
<blockquote>
<p>  honor_labels 配置解决了 Prometheus 采集过程中的<strong>标签冲突</strong>问题：</p>
<ul>
<li>false (默认): <strong>Prometheus 标签优先</strong>，适合标准化环境</li>
<li>true: 目标标签优先，适合自定义标签体系</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">正确的行为模式</span><br><span class="line"></span><br><span class="line">1. honor_labels: false (默认值)</span><br><span class="line"></span><br><span class="line">行为: Prometheus 的标签优先，目标数据中的冲突标签会被重命名，而不是忽略</span><br><span class="line"></span><br><span class="line"># Prometheus 配置</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;myapp&#x27;  # 这个 job 名称是 Prometheus 使用的</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:8080&#x27;]</span><br><span class="line">    honor_labels: false</span><br><span class="line"></span><br><span class="line">正确的处理过程:</span><br><span class="line"></span><br><span class="line"># 目标数据返回</span><br><span class="line">http_requests_total&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;&#125; 1000</span><br><span class="line"></span><br><span class="line"># Prometheus 存储结果</span><br><span class="line"># Prometheus 的标签优先，目标数据的冲突标签被重命名</span><br><span class="line">http_requests_total&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;, exported_job=&quot;myapp&quot;, exported_instance=&quot;localhost:8080&quot;&#125; 1000</span><br><span class="line"></span><br><span class="line">2. honor_labels: true</span><br><span class="line"></span><br><span class="line">行为: 目标数据的标签优先，Prometheus 的冲突标签会被丢弃</span><br><span class="line"></span><br><span class="line"># 目标数据返回</span><br><span class="line">http_requests_total&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;&#125; 1000</span><br><span class="line"></span><br><span class="line"># Prometheus 存储结果</span><br><span class="line"># 目标标签优先，保持原样</span><br><span class="line">http_requests_total&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;&#125; 1000</span><br><span class="line"></span><br><span class="line">更详细的正确示例</span><br><span class="line"></span><br><span class="line">honor_labels: false 的详细行为</span><br><span class="line"></span><br><span class="line"># Prometheus 配置</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;prometheus-job&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;target.example.com:8080&#x27;]</span><br><span class="line">    honor_labels: false</span><br><span class="line"></span><br><span class="line">处理过程:</span><br><span class="line"># 1. Prometheus 会自动添加标签</span><br><span class="line"># job=&quot;prometheus-job&quot; (来自配置)</span><br><span class="line"># instance=&quot;target.example.com:8080&quot; (来自目标地址)</span><br><span class="line"></span><br><span class="line"># 2. 目标返回数据</span><br><span class="line">http_requests_total&#123;job=&quot;target-job&quot;, instance=&quot;target-instance&quot;&#125; 1000</span><br><span class="line"></span><br><span class="line"># 3. 存储结果（冲突标签被重命名）</span><br><span class="line">http_requests_total&#123;</span><br><span class="line">  job=&quot;prometheus-job&quot;,           # Prometheus 的标签</span><br><span class="line">  instance=&quot;target.example.com:8080&quot;,  # Prometheus 的标签</span><br><span class="line">  exported_job=&quot;target-job&quot;,      # 重命名后的目标标签</span><br><span class="line">  exported_instance=&quot;target-instance&quot;   # 重命名后的目标标签</span><br><span class="line">&#125; 1000</span><br><span class="line"></span><br><span class="line">honor_labels: true 的详细行为</span><br><span class="line"></span><br><span class="line"># Prometheus 配置</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;prometheus-job&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;target.example.com:8080&#x27;]</span><br><span class="line">    honor_labels: true</span><br><span class="line"></span><br><span class="line">处理过程:</span><br><span class="line"># 1. 目标返回数据</span><br><span class="line">http_requests_total&#123;job=&quot;target-job&quot;, instance=&quot;target-instance&quot;&#125; 1000</span><br><span class="line"></span><br><span class="line"># 2. 存储结果（保持目标标签，丢弃 Prometheus 的自动标签）</span><br><span class="line">http_requests_total&#123;</span><br><span class="line">  job=&quot;target-job&quot;,        # 目标的标签</span><br><span class="line">  instance=&quot;target-instance&quot;  # 目标的标签</span><br><span class="line">&#125; 1000</span><br><span class="line"></span><br><span class="line">实际验证</span><br><span class="line"></span><br><span class="line">查询验证</span><br><span class="line"></span><br><span class="line"># 当 honor_labels: false 时，可以看到重命名的标签</span><br><span class="line">http_requests_total&#123;exported_job=&quot;target-job&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 当 honor_labels: true 时，直接查询原始标签</span><br><span class="line">http_requests_total&#123;job=&quot;target-job&quot;&#125;</span><br><span class="line"></span><br><span class="line">总结修正</span><br><span class="line"></span><br><span class="line">感谢指出错误！正确的行为是：</span><br><span class="line"></span><br><span class="line">- honor_labels: false: Prometheus 标签优先，冲突的目标标签会被重命名（添加 exported_ 前缀）</span><br><span class="line">- honor_labels: true: 目标标签优先，Prometheus 的冲突标签会被丢弃</span><br><span class="line"></span><br><span class="line">关键是要理解两个标签体系会同时存在，而不是简单地&quot;忽略&quot;某一方的标签。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>For each <strong>instance</strong> scrape, Prometheus stores a <strong>sample</strong> in the following time series:</p>
</blockquote>
<ol>
<li><code>up&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li><strong>1</strong> if the instance is <strong>healthy</strong>, i.e. <strong>reachable</strong> or <strong>0</strong> if the <strong>scrape failed</strong>.</li>
</ul>
</li>
<li><code>scrape_duration_seconds&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li><strong>duration</strong> of the scrape.</li>
</ul>
</li>
<li><code>scrape_samples_post_metric_relabeling&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li>the number of <strong>samples remaining</strong> after <strong>metric relabeling</strong> was applied.</li>
</ul>
</li>
<li><code>scrape_samples_scraped&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li>the number of <strong>samples</strong> the target <strong>exposed</strong>.</li>
</ul>
</li>
<li><code>scrape_series_added&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li>the <strong>approximate</strong> number of <strong>new series</strong> in this scrape. New in <strong>v2.10</strong></li>
</ul>
</li>
</ol>
<blockquote>
<p>scrape_samples_post_metric_relabeling</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">指标含义</span><br><span class="line"></span><br><span class="line">📊 scrape_samples_post_metric_relabeling 指标</span><br><span class="line"></span><br><span class="line">scrape_samples_post_metric_relabeling&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;&#125; 1500</span><br><span class="line"></span><br><span class="line">含义: 在对 &quot;myapp&quot; 任务的 &quot;localhost:8080&quot; 实例进行抓取后，经过 metric relabeling 处理，最终保留了 1500 个样本。</span><br><span class="line"></span><br><span class="line">Metric Relabeling 流程</span><br><span class="line"></span><br><span class="line">🔄 完整的抓取流程</span><br><span class="line"></span><br><span class="line">1. [目标端点] → 原始指标数据</span><br><span class="line">   ↓</span><br><span class="line">2. [抓取] → 获取所有原始样本</span><br><span class="line">   ↓</span><br><span class="line">3. [Metric Relabeling] → 过滤、修改、添加标签</span><br><span class="line">   ↓</span><br><span class="line">4. [存储] → 最终存储的样本</span><br><span class="line"></span><br><span class="line">scrape_samples_post_metric_relabeling 测量的是第3步之后剩余的样本数</span><br><span class="line"></span><br><span class="line">配置示例</span><br><span class="line"></span><br><span class="line">📝 Metric Relabeling 配置</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;myapp&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:8080&#x27;]</span><br><span class="line">    metric_relabel_configs:</span><br><span class="line">      # 1. 过滤掉不需要的指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &#x27;go_.*&#x27;</span><br><span class="line">        action: drop</span><br><span class="line"></span><br><span class="line">      # 2. 只保留特定的指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &#x27;http_.*|process_.*&#x27;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">      # 3. 修改标签</span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: application</span><br><span class="line">        regex: &#x27;(.*)&#x27;</span><br><span class="line">        replacement: &#x27;myapp-$&#123;1&#125;&#x27;</span><br><span class="line"></span><br><span class="line">      # 4. 添加新标签</span><br><span class="line">      - target_label: environment</span><br><span class="line">        replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">      # 5. 删除标签</span><br><span class="line">      - regex: &#x27;temp_.*&#x27;</span><br><span class="line">        action: labeldrop</span><br><span class="line"></span><br><span class="line">实际应用示例</span><br><span class="line"></span><br><span class="line">🎯 场景1: 过滤高基数指标</span><br><span class="line"></span><br><span class="line"># 配置：过滤掉 go_* 指标以减少存储</span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    regex: &#x27;go_.*&#x27;</span><br><span class="line">    action: drop</span><br><span class="line"></span><br><span class="line"># 结果：</span><br><span class="line"># 原始抓取: 5000 个样本</span><br><span class="line"># 过滤后: 3000 个样本</span><br><span class="line"># 指标显示: scrape_samples_post_metric_relabeling&#123;job=&quot;myapp&quot;&#125; 3000</span><br><span class="line"></span><br><span class="line">🎯 场景2: 环境标签标准化</span><br><span class="line"></span><br><span class="line"># 配置：为所有指标添加环境标签</span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  - target_label: env</span><br><span class="line">    replacement: &#x27;prod&#x27;</span><br><span class="line"></span><br><span class="line"># 结果：</span><br><span class="line"># 所有样本都获得了 env=&quot;prod&quot; 标签</span><br><span class="line"># 样本数量不变，但标签结构改变</span><br><span class="line">scrape_samples_post_metric_relabeling&#123;job=&quot;myapp&quot;&#125; 3000</span><br><span class="line"></span><br><span class="line">🎯 场景3: 高级过滤逻辑</span><br><span class="line"></span><br><span class="line"># 配置：复杂的过滤和转换逻辑</span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  # 只保留 HTTP 相关指标</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    regex: &#x27;http_.*&#x27;</span><br><span class="line">    action: keep</span><br><span class="line"></span><br><span class="line">  # 添加服务标签</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_app]</span><br><span class="line">    target_label: service</span><br><span class="line">    regex: &#x27;(.*)&#x27;</span><br><span class="line">    replacement: &#x27;$&#123;1&#125;&#x27;</span><br><span class="line"></span><br><span class="line">  # 删除临时标签</span><br><span class="line">  - regex: &#x27;__meta_kubernetes_.*&#x27;</span><br><span class="line">    action: labeldrop</span><br><span class="line"></span><br><span class="line">相关指标对比</span><br><span class="line"></span><br><span class="line">📈 完整的抓取指标体系</span><br><span class="line"></span><br><span class="line"># 1. 抓取的原始样本数</span><br><span class="line">scrape_samples_scraped&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 2. Metric relabeling 后的样本数</span><br><span class="line">scrape_samples_post_metric_relabeling&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 3. 实际存储的样本数（可能因其他原因被丢弃）</span><br><span class="line">prometheus_tsdb_head_samples_appended&#123;job=&quot;myapp&quot;, instance=&quot;localhost:8080&quot;&#125;</span><br><span class="line"></span><br><span class="line">📊 过滤效率计算</span><br><span class="line"></span><br><span class="line"># 计算 metric relabeling 的过滤效率</span><br><span class="line">(</span><br><span class="line">  scrape_samples_scraped - scrape_samples_post_metric_relabeling</span><br><span class="line">) / scrape_samples_scraped * 100</span><br><span class="line"></span><br><span class="line"># 示例：计算过滤掉的样本百分比</span><br><span class="line">(5000 - 3000) / 5000 * 100 = 40%  # 过滤掉了 40% 的样本</span><br><span class="line"></span><br><span class="line">监控和告警</span><br><span class="line"></span><br><span class="line">🚨 基于此指标的告警</span><br><span class="line"></span><br><span class="line"># 告警：metric relabeling 后样本数为 0</span><br><span class="line">- alert: ScrapeNoSamplesAfterRelabeling</span><br><span class="line">  expr: scrape_samples_post_metric_relabeling == 0</span><br><span class="line">  for: 5m</span><br><span class="line">  labels:</span><br><span class="line">    severity: critical</span><br><span class="line">  annotations:</span><br><span class="line">    summary: &quot;No samples after metric relabeling for &#123;&#123; $labels.job &#125;&#125;/&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">    description: &quot;Target &#123;&#123; $labels.instance &#125;&#125; in job &#123;&#123; $labels.job &#125;&#125; has no samples after metric relabeling.&quot;</span><br><span class="line"></span><br><span class="line"># 告警：样本数异常低</span><br><span class="line">- alert: ScrapeLowSamplesAfterRelabeling</span><br><span class="line">  expr: scrape_samples_post_metric_relabeling &lt; 10</span><br><span class="line">  for: 10m</span><br><span class="line">  labels:</span><br><span class="line">    severity: warning</span><br><span class="line">  annotations:</span><br><span class="line">    summary: &quot;Low sample count after metric relabeling&quot;</span><br><span class="line">    description: &quot;Only &#123;&#123; $value &#125;&#125; samples remaining after relabeling for &#123;&#123; $labels.job &#125;&#125;/&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">📈 仪表盘查询</span><br><span class="line"></span><br><span class="line"># 1. 各任务的样本数趋势</span><br><span class="line">sum(scrape_samples_post_metric_relabeling) by (job)</span><br><span class="line"></span><br><span class="line"># 2. 各实例的样本数分布</span><br><span class="line">sum(scrape_samples_post_metric_relabeling) by (instance, job)</span><br><span class="line"></span><br><span class="line"># 3. 过滤效率分析</span><br><span class="line">(sum(scrape_samples_scraped) - sum(scrape_samples_post_metric_relabeling)) / sum(scrape_samples_scraped) * 100</span><br><span class="line"></span><br><span class="line"># 4. 样本数变化率</span><br><span class="line">rate(scrape_samples_post_metric_relabeling[5m])</span><br><span class="line"></span><br><span class="line">故障排查</span><br><span class="line"></span><br><span class="line">🔍 问题诊断流程</span><br><span class="line"></span><br><span class="line"># 1. 检查原始抓取数据</span><br><span class="line">curl http://localhost:8080/metrics | wc -l</span><br><span class="line"></span><br><span class="line"># 2. 检查 Prometheus 中的指标</span><br><span class="line">curl &quot;http://prometheus:9090/api/v1/query?query=scrape_samples_post_metric_relabeling&quot;</span><br><span class="line"></span><br><span class="line"># 3. 检查 relabeling 配置</span><br><span class="line">curl &quot;http://prometheus:9090/api/v1/targets&quot; | jq &#x27;.data.activeTargets[] | &#123;job, instance, scrapeUrl, lastError&#125;&#x27;</span><br><span class="line"></span><br><span class="line">🛠️ 常见问题解决</span><br><span class="line"></span><br><span class="line"># 问题：过滤规则过于严格，导致样本数为 0</span><br><span class="line"># 解决：检查 relabeling 规则</span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    regex: &#x27;too_strict_pattern&#x27;  # 可能过于严格</span><br><span class="line">    action: drop  # 考虑放宽规则</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">scrape_samples_post_metric_relabeling 指标是 Prometheus 监控体系中的重要组成部分，它：</span><br><span class="line"></span><br><span class="line">1. 跟踪过滤效果: 监控 metric relabeling 规则的实际效果</span><br><span class="line">2. 优化存储使用: 帮助优化指标存储和查询性能</span><br><span class="line">3. 故障排查: 用于诊断数据丢失和配置问题</span><br><span class="line">4. 容量规划: 评估存储需求和性能影响</span><br><span class="line"></span><br><span class="line">理解这个指标对于有效管理 Prometheus 的指标收集和存储策略至关重要。</span><br></pre></td></tr></table></figure>

<p>The <strong>up</strong> time series is useful for <strong>instance availability monitoring</strong>.</p>
<p>With the <strong>extra-scrape-metrics</strong> feature flag several <strong>additional metrics</strong> are available:</p>
<ol>
<li><code>scrape_timeout_seconds&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li>The <strong>configured scrape_timeout</strong> for a target. <strong>10</strong></li>
</ul>
</li>
<li><code>scrape_sample_limit&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li>The <strong>configured sample_limit</strong> for a target. Returns <strong>zero</strong> if there is <strong>no limit configured</strong>. <strong>0</strong></li>
</ul>
</li>
<li><code>scrape_body_size_bytes&#123;job=&quot;&lt;job-name&gt;&quot;, instance=&quot;&lt;instance-id&gt;&quot;&#125;</code><ul>
<li>The <strong>uncompressed size</strong> of the <strong>most recent scrape response</strong>, if successful.</li>
<li><strong>Scrapes failing</strong> because <strong>body_size_limit</strong> is <strong>exceeded</strong> report <strong>-1</strong>, <u>other scrape failures</u> report <strong>0</strong>.</li>
</ul>
</li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2025/01/23/cloud-native-observability-prometheus-concepts/">https://blog.zhongmingmao.top/2025/01/23/cloud-native-observability-prometheus-concepts/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/observability/">Observability</a></div><div class="post-share"><div class="social-share" data-image="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Observability - Prometheus Introduction</div></div><div class="info-2"><div class="info-item-1">Summary Open source metrics and monitoring for your systems and services. Monitor your applications, systems, and services with the leading open source monitoring solution. Instrument, collect, store, and query your metrics for alerting, dashboarding, and other use cases.       Feature Desc    Dimensional data model Prometheus models time series in a flexible dimensional data model.Time series are identified by a metric name and a set of key-value pairs.   Powerful queries The PromQL query language allow...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-22</div><div class="info-item-2">Observability - Prometheus Introduction</div></div><div class="info-2"><div class="info-item-1">Summary Open source metrics and monitoring for your systems and services. Monitor your applications, systems, and services with the leading open source monitoring solution. Instrument, collect, store, and query your metrics for alerting, dashboarding, and other use cases.       Feature Desc    Dimensional data model Prometheus models time series in a flexible dimensional data model.Time series are identified by a metric name and a set of key-value pairs.   Powerful queries The PromQL query language allow...</div></div></div></a><a class="pagination-related" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-21</div><div class="info-item-2">Observability - OpenTelemetry Java Zero Code</div></div><div class="info-2"><div class="info-item-1">Java Agent Zero-code instrumentation with Java uses a Java agent JAR attached to any Java 8+ application. It dynamically injects bytecode to capture telemetry from many popular libraries and frameworks. It can be used to capture telemetry data at the “edges” of an app or service such as inbound requests, outbound HTTP calls, database calls, and so on.      Getting startedSetup Download opentelemetry-javaagent.jar from Releases of the opentelemetry-java-instrumentation repository place the JAR in your pre...</div></div></div></a><a class="pagination-related" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-20</div><div class="info-item-2">Observability - OpenTelemetry Java</div></div><div class="info-2"><div class="info-item-1">Intro to OpenTelemetry Java OpenTelemetry Java is the set of OpenTelemetry observability tools for the Java ecosystem. At a high level, it consists of the API, the SDK, and instrumentation.    Overview The API is a set of classes and interfaces for recording telemetry across key observability signals.  It supports multiple implementations, with a low-overhead minimalist Noop and SDK reference implementation provided out of the box.  It is designed to be taken as a direct dependency by libraries, framewor...</div></div></div></a><a class="pagination-related" href="/2025/01/05/cloud-native-observability-opentelemetry-python/" title="Observability - OpenTelemetry Python"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-python-instrumentation.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-05</div><div class="info-item-2">Observability - OpenTelemetry Python</div></div><div class="info-2"><div class="info-item-1">OverviewStatus and Releases   Traces Metrics Logs    Stable Stable Development   Version supportOpenTelemetry-Python supports Python 3.9 and higher.   Installation The API and SDK packages are available on PyPI, and can be installed via pip:  12pip install opentelemetry-apipip install opentelemetry-sdk   In addition, there are several extension packages which can be installed separately as:  12pip install opentelemetry-exporter-&#123;exporter&#125;pip install opentelemetry-instrumentation-&#123;instrumen...</div></div></div></a><a class="pagination-related" href="/2025/01/04/cloud-native-observability-opentelemetry-go/" title="Observability - OpenTelemetry Go"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/o11y-otel-go.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-04</div><div class="info-item-2">Observability - OpenTelemetry Go</div></div><div class="info-2"><div class="info-item-1">OverviewStatus and Releases The logs signal is still experimental. Breaking changes may be introduced in future versions.     Traces Metrics Logs    Stable Stable Beta     Getting StartedExample applicationSetup To begin, set up a go.mod in a new directory:  12345$ go mod init dicego: creating new go.mod: module dice$ lsgo.mod  Create and launch an HTTP server In that same folder, create a file called main.go and add the following code to the file:  123456789101112package mainimport (    &quot;log&quot; ...</div></div></div></a><a class="pagination-related" href="/2025/01/03/cloud-native-observability-opentelemetry-js/" title="Observability - OpenTelemetry Node.js"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/Nodejs-Instrumentation-OpenTelemetry.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="info-item-2">Observability - OpenTelemetry Node.js</div></div><div class="info-2"><div class="info-item-1">OverviewStatus and Releases   Traces Metrics Logs    Stable Stable Development    Client instrumentation for the browser is experimental and mostly unspecified.    Version Support OpenTelemetry JavaScript supports all active or maintenance LTS versions of Node.js. Previous versions of Node.js may work, but are not tested by OpenTelemetry.   OpenTelemetry JavaScript has no official supported list of browsers. It is aimed to work on currently supported versions of major browsers. OpenTelemetry JavaScript f...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">641</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Data-model"><span class="toc-number">1.</span> <span class="toc-text">Data model</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Metric-names-and-labels"><span class="toc-number">1.1.</span> <span class="toc-text">Metric names and labels</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Metric-names"><span class="toc-number">1.1.1.</span> <span class="toc-text">Metric names</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metric-labels"><span class="toc-number">1.1.2.</span> <span class="toc-text">Metric labels</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Samples"><span class="toc-number">1.2.</span> <span class="toc-text">Samples</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Notation"><span class="toc-number">1.3.</span> <span class="toc-text">Notation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Metric-types"><span class="toc-number">2.</span> <span class="toc-text">Metric types</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Counter"><span class="toc-number">2.1.</span> <span class="toc-text">Counter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gauge"><span class="toc-number">2.2.</span> <span class="toc-text">Gauge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Histogram"><span class="toc-number">2.3.</span> <span class="toc-text">Histogram</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">2.4.</span> <span class="toc-text">Summary</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jobs-and-instances"><span class="toc-number">3.</span> <span class="toc-text">Jobs and instances</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Automatically-generated-labels-and-time-series"><span class="toc-number">3.1.</span> <span class="toc-text">Automatically generated labels and time series</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ai-agent-1253868755.cos.ap-guangzhou.myqcloud.com/mcp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI Agent - MCP Overview"/></a><div class="content"><a class="title" href="/2025/01/19/ai-agent-overview-mcp/" title="AI Agent - MCP Overview">AI Agent - MCP Overview</a><time datetime="2025-01-18T16:06:25.000Z" title="Created 2025-01-19 00:06:25">2025-01-19</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>
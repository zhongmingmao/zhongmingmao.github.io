<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Observability - Prometheus Server V1 | ByteCoding</title><meta name="author" content="zhongmingmao"><meta name="copyright" content="zhongmingmao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="OpenTelemetry vs Prometheus12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091">
<meta property="og:type" content="article">
<meta property="og:title" content="Observability - Prometheus Server V1">
<meta property="og:url" content="https://blog.zhongmingmao.top/2025/01/24/cloud-native-observability-prometheus-server-v1/index.html">
<meta property="og:site_name" content="ByteCoding">
<meta property="og:description" content="OpenTelemetry vs Prometheus12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp">
<meta property="article:published_time" content="2025-01-23T16:06:25.000Z">
<meta property="article:modified_time" content="2025-11-10T08:41:01.532Z">
<meta property="article:author" content="zhongmingmao">
<meta property="article:tag" content="Cloud Native">
<meta property="article:tag" content="Observability">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Observability - Prometheus Server V1",
  "url": "https://blog.zhongmingmao.top/2025/01/24/cloud-native-observability-prometheus-server-v1/",
  "image": "https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp",
  "datePublished": "2025-01-23T16:06:25.000Z",
  "dateModified": "2025-11-10T08:41:01.532Z",
  "author": [
    {
      "@type": "Person",
      "name": "zhongmingmao",
      "url": "https://blog.zhongmingmao.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png"><link rel="canonical" href="https://blog.zhongmingmao.top/2025/01/24/cloud-native-observability-prometheus-server-v1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":32,"languages":{"author":"Author: zhongmingmao","link":"Link: ","source":"Source: ByteCoding","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Observability - Prometheus Server V1',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ByteCoding" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/url(https:/cdn.pixabay.com/photo/2021/07/20/03/39/fisherman-6479663_1280.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ByteCoding</span></a><a class="nav-page-title" href="/"><span class="site-name">Observability - Prometheus Server V1</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Observability - Prometheus Server V1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2025-01-23T16:06:25.000Z" title="Created 2025-01-24 00:06:25">2025-01-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/">Cloud Native</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cloud-native/observability/">Observability</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">53.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>238mins</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:512,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-11-10 16:41:01&quot;}" hidden></div><h1 id="OpenTelemetry-vs-Prometheus"><a href="#OpenTelemetry-vs-Prometheus" class="headerlink" title="OpenTelemetry vs Prometheus"></a>OpenTelemetry vs Prometheus</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">关系概述：互补为主，渐趋融合</span><br><span class="line"></span><br><span class="line">OpenTelemetry 和 Prometheus 在指标领域主要是互补关系，而非冲突。两个项目都在积极合作以实现更好的互操作性。</span><br><span class="line"></span><br><span class="line">1. 定位差异</span><br><span class="line"></span><br><span class="line">Prometheus:</span><br><span class="line">- 完整的监控系统（采集、存储、查询、告警）</span><br><span class="line">- 专注于指标监控</span><br><span class="line">- 拉模型（Pull-based）为主</span><br><span class="line">- 拥有成熟的时序数据库和查询语言 PromQL</span><br><span class="line"></span><br><span class="line">OpenTelemetry:</span><br><span class="line">- 标准化的遥测数据收集框架</span><br><span class="line">- 支持三大信号：指标、追踪、日志</span><br><span class="line">- 推模型（Push-based）为主</span><br><span class="line">- 不提供存储和查询后端</span><br><span class="line"></span><br><span class="line">2. 技术模型对比</span><br><span class="line"></span><br><span class="line">| 特性   | Prometheus                      | OpenTelemetry                                 |</span><br><span class="line">|------|---------------------------------|-----------------------------------------------|</span><br><span class="line">| 数据模型 | 简单的时序数据模型                       | 复杂的三层数据模型                                     |</span><br><span class="line">| 传输协议 | HTTP/文本格式                       | OTLP（二进制协议）                                   |</span><br><span class="line">| 指标类型 | Counter、Gauge、Histogram、Summary | Counter、Gauge、Histogram、Exponential Histogram |</span><br><span class="line">| 命名规范 | 下划线分隔（如 http_requests_total）    | 点号分隔（如 http.requests.total）                   |</span><br><span class="line">| 数据收集 | Pull（拉取）                        | Push（推送）                                      |</span><br><span class="line"></span><br><span class="line">3. 兼容性发展历程</span><br><span class="line"></span><br><span class="line">过去的挑战（Prometheus 2.0时代）</span><br><span class="line"></span><br><span class="line">- 命名规范不兼容</span><br><span class="line">- 指标类型映射复杂</span><br><span class="line">- 数据模型转换困难</span><br><span class="line"></span><br><span class="line">现状的改善（Prometheus 3.0时代）</span><br><span class="line"></span><br><span class="line">- Prometheus 3.0 原生支持 OTLP 指标摄入</span><br><span class="line">- UTF-8 标准化：支持点号命名，避免自动转换为下划线</span><br><span class="line">- 双向转换：支持 Prometheus ↔ OpenTelemetry 数据转换</span><br><span class="line">- 标准化规范：官方的互操作性规范</span><br><span class="line"></span><br><span class="line">4. 集成模式</span><br><span class="line"></span><br><span class="line">模式1：OpenTelemetry → Prometheus</span><br><span class="line"></span><br><span class="line">应用程序 → OTel SDK → OTel Collector → Prometheus</span><br><span class="line">- 使用 OpenTelemetry Collector 作为桥梁</span><br><span class="line">- 支持多种导出器：Prometheus Remote Write、Prometheus Exporter</span><br><span class="line"></span><br><span class="line">模式2：Prometheus → OpenTelemetry</span><br><span class="line"></span><br><span class="line">应用程序 → Prometheus Exporter → OTel Collector → 后端存储</span><br><span class="line">- OTel Collector 充当 Prometheus Server 角色</span><br><span class="line">- 抓取 Prometheus 格式指标并转换为 OTLP</span><br><span class="line"></span><br><span class="line">模式3：混合部署</span><br><span class="line"></span><br><span class="line">              ┌─────────────────┐</span><br><span class="line">              │   OTel Collector │</span><br><span class="line">              └─────────┬───────┘</span><br><span class="line">                       │</span><br><span class="line">        ┌──────────────┼──────────────┐</span><br><span class="line">        │              │              │</span><br><span class="line">   ┌────▼────┐   ┌─────▼─────┐   ┌───▼───┐</span><br><span class="line">   │Prometheus│   │其他OTLP后端│   │Grafana │</span><br><span class="line">   └─────────┘   └───────────┘   └───────┘</span><br><span class="line"></span><br><span class="line">5. 实际使用建议</span><br><span class="line"></span><br><span class="line">选择 OpenTelemetry 的情况：</span><br><span class="line"></span><br><span class="line">- 需要统一的三信号观测（指标+追踪+日志）</span><br><span class="line">- 希望供应商中立的解决方案</span><br><span class="line">- 需要更丰富的上下文关联</span><br><span class="line">- 计划多云或混合云部署</span><br><span class="line"></span><br><span class="line">选择 Prometheus 的情况：</span><br><span class="line"></span><br><span class="line">- 主要关注基础设施监控</span><br><span class="line">- 已有成熟的 Prometheus 生态</span><br><span class="line">- 需要 PromQL 的强大查询能力</span><br><span class="line">- 团队对 Prometheus 更熟悉</span><br><span class="line"></span><br><span class="line">混合使用的情况：</span><br><span class="line"></span><br><span class="line">- 利用 OpenTelemetry 进行应用观测</span><br><span class="line">- 使用 Prometheus 进行基础设施监控</span><br><span class="line">- 通过 OTel Collector 统一数据流</span><br><span class="line"></span><br><span class="line">6. 未来发展趋势</span><br><span class="line"></span><br><span class="line">1. 深度融合：Prometheus 3.0+ 将深度集成 OpenTelemetry</span><br><span class="line">2. 标准统一：CNCF 推动统一的可观测性标准</span><br><span class="line">3. 生态互补：两个项目继续发挥各自优势</span><br><span class="line">4. 无缝迁移：提供平滑的迁移路径</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line"></span><br><span class="line">OpenTelemetry 和 Prometheus 的关系已经从早期的&quot;冲突&quot;转向&quot;互补和融合&quot;。它们不是竞争关系，而是：</span><br><span class="line">- 互补关系：OpenTelemetry 提供标准化的数据收集，Prometheus 提供强大的存储和查询</span><br><span class="line">- 融合趋势：Prometheus 3.0+ 原生支持 OpenTelemetry，两个生态系统正在深度整合</span><br><span class="line">- 最佳实践：根据具体需求选择合适的组合方案</span><br><span class="line"></span><br><span class="line">对于新项目，建议采用 OpenTelemetry 进行标准化观测，同时可以选择 Prometheus 作为后端存储之一，实现灵活性和兼容性的平衡。</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h1><ol>
<li>This guide is a “<strong>Hello World</strong>“-style tutorial which shows how to <strong>install</strong>, <strong>configure</strong>, and use <strong>a simple Prometheus instance</strong>.</li>
<li>You will download and run Prometheus <strong>locally</strong><ul>
<li>configure it to <strong>scrape itself</strong> and <strong>an example application</strong>, then work with <strong>queries</strong>, <strong>rules</strong>, and <strong>graphs</strong> to use <strong>collected time series data</strong>.</li>
</ul>
</li>
</ol>
<h2 id="Downloading-and-running-Prometheus"><a href="#Downloading-and-running-Prometheus" class="headerlink" title="Downloading and running Prometheus"></a>Downloading and running Prometheus</h2><p>Download the <strong>latest release</strong> of Prometheus for your platform, then extract and run it:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xvfz prometheus-*.tar.gz</span><br><span class="line">cd prometheus-*</span><br></pre></td></tr></table></figure>

<p>Before starting Prometheus, let’s configure it.</p>
<h2 id="Configuring-Prometheus-to-monitor-itself"><a href="#Configuring-Prometheus-to-monitor-itself" class="headerlink" title="Configuring Prometheus to monitor itself"></a>Configuring Prometheus to monitor itself</h2><ol>
<li>Prometheus collects <strong>metrics</strong> from <strong>targets</strong> by <strong>scraping metrics HTTP endpoints</strong>.</li>
<li>Since Prometheus <strong>exposes data</strong> in the <strong>same manner</strong> about itself, it can also <strong>scrape</strong> and <strong>monitor</strong> its <strong>own health</strong>.</li>
<li>While a Prometheus server that collects only data about itself is not very useful, it is a good starting example.</li>
<li>Save the following basic Prometheus <strong>configuration</strong> as a file named <code>prometheus.yml</code>:</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> <span class="comment"># By default, scrape targets every 15 seconds.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Attach these labels to any time series or alerts when communicating with</span></span><br><span class="line">  <span class="comment"># external systems (federation, remote storage, Alertmanager).</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">&#x27;codelab-monitor&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it&#x27;s Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="Starting-Prometheus"><a href="#Starting-Prometheus" class="headerlink" title="Starting Prometheus"></a>Starting Prometheus</h2><p>To start Prometheus with your newly created configuration file, change to the directory containing the Prometheus binary and run:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Start Prometheus.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">By default, Prometheus stores its database <span class="keyword">in</span> ./data (flag --storage.tsdb.path).</span></span><br><span class="line">./prometheus --config.file=prometheus.yml</span><br></pre></td></tr></table></figure>

<ol>
<li>Prometheus should <strong>start up</strong>. You should also be able to <strong>browse</strong> to a <strong>status</strong> page about itself at <a target="_blank" rel="noopener" href="http://localhost:9090/">localhost:9090</a>. </li>
<li>Give it a couple of seconds to <strong>collect data</strong> about <strong>itself</strong> from its <strong>own HTTP metrics endpoint</strong>.</li>
<li>You can also <strong>verify</strong> that Prometheus is <strong>serving metrics about itself</strong> by navigating to its metrics endpoint: <strong>localhost:9090&#x2F;metrics</strong></li>
</ol>
<h2 id="Using-the-expression-browser"><a href="#Using-the-expression-browser" class="headerlink" title="Using the expression browser"></a>Using the expression browser</h2><ol>
<li>Let us <strong>explore</strong> data that Prometheus has collected about itself.</li>
<li>To use Prometheus’s <strong>built-in expression browser</strong>, navigate to <a target="_blank" rel="noopener" href="http://localhost:9090/query">http://localhost:9090/query</a> and choose the “<strong>Graph</strong>“ tab.</li>
<li>As you can gather from <strong>localhost:9090&#x2F;metrics</strong><ul>
<li>one metric that Prometheus exports about itself is named <strong>prometheus_target_interval_length_seconds</strong></li>
<li>the <strong>actual amount of time</strong> between <strong>target scrapes</strong></li>
</ul>
</li>
<li>Enter the below into the expression console and then click “<strong>Execute</strong>“:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prometheus_target_interval_length_seconds</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/image-20251108230839243.png" alt="image-20251108230839243"></p>
<ol>
<li>This should return a number of <strong>different time series</strong> (along with the <strong>latest value recorded</strong> for each)<ul>
<li>each with the metric name <strong>prometheus_target_interval_length_seconds</strong>, but with <strong>different labels</strong>.</li>
</ul>
</li>
<li>These labels designate <strong>different latency percentiles</strong> and <strong>target group intervals</strong>.</li>
<li>If we are interested only in <strong>99th percentile latencies</strong>, we could use this query:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prometheus_target_interval_length_seconds&#123;quantile=&quot;0.99&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/image-20251108231215901.png" alt="image-20251108231215901"></p>
<blockquote>
<p>To <strong>count</strong> the number of <strong>returned time series</strong>, you could write:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count(prometheus_target_interval_length_seconds)</span><br></pre></td></tr></table></figure>

<h2 id="Using-the-graphing-interface"><a href="#Using-the-graphing-interface" class="headerlink" title="Using the graphing interface"></a>Using the graphing interface</h2><ol>
<li>To graph expressions, navigate to <a target="_blank" rel="noopener" href="http://localhost:9090/query">http://localhost:9090/query</a> and use the “<strong>Graph</strong>“ tab.</li>
<li>For example, enter the following expression to graph the <strong>per-second rate</strong> of <strong>chunks being created</strong> in the self-scraped Prometheus:</li>
</ol>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/image-20251108231517942.png" alt="image-20251108231517942"></p>
<h2 id="Starting-up-some-sample-targets"><a href="#Starting-up-some-sample-targets" class="headerlink" title="Starting up some sample targets"></a>Starting up some sample targets</h2><ol>
<li>Let’s add additional targets for Prometheus to scrape.</li>
<li>The <strong>Node Exporter</strong> is used as an example target</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf node_exporter-*.*.tar.gz</span><br><span class="line">cd node_exporter-*.*</span><br><span class="line"></span><br><span class="line"># Start 3 example targets in separate terminals:</span><br><span class="line">./node_exporter --web.listen-address 127.0.0.1:8080</span><br><span class="line">./node_exporter --web.listen-address 127.0.0.1:8081</span><br><span class="line">./node_exporter --web.listen-address 127.0.0.1:8082</span><br></pre></td></tr></table></figure>

<p>You should now have example targets listening on <a target="_blank" rel="noopener" href="http://localhost:8080/metrics">http://localhost:8080/metrics</a>, <a target="_blank" rel="noopener" href="http://localhost:8081/metrics">http://localhost:8081/metrics</a>, and <a target="_blank" rel="noopener" href="http://localhost:8082/metrics">http://localhost:8082/metrics</a>.</p>
<h2 id="Configure-Prometheus-to-monitor-the-sample-targets"><a href="#Configure-Prometheus-to-monitor-the-sample-targets" class="headerlink" title="Configure Prometheus to monitor the sample targets"></a>Configure Prometheus to monitor the sample targets</h2><ol>
<li>Now we will configure Prometheus to scrape these new targets.</li>
<li>Let’s <strong>group</strong> all three endpoints into one job called <strong>node</strong>.</li>
<li>We will imagine that the first two endpoints are <strong>production</strong> targets, while the third one represents a <strong>canary</strong> instance.</li>
<li>To model this in Prometheus, we can add <strong>several groups</strong> of endpoints to <strong>a single job</strong>, adding <strong>extra labels</strong> to <strong>each group</strong> of targets.</li>
<li>In this example, we will add the <strong>group&#x3D;”production”</strong> label to the first group of targets, while adding <strong>group&#x3D;”canary”</strong> to the second.</li>
</ol>
<p>To achieve this, add the following job definition to the <strong>scrape_configs</strong> section in your <strong>prometheus.yml</strong> and <strong>restart</strong> your Prometheus instance:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span>       <span class="string">&#x27;node&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>, <span class="string">&#x27;localhost:8081&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">&#x27;production&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8082&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">&#x27;canary&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Go to the <strong>expression browser</strong> and verify that Prometheus now has information about <strong>time series</strong> that these example endpoints expose, such as <strong>node_cpu_seconds_total</strong>.</p>
<h2 id="Configure-rules-for-aggregating-scraped-data-into-new-time-series"><a href="#Configure-rules-for-aggregating-scraped-data-into-new-time-series" class="headerlink" title="Configure rules for aggregating scraped data into new time series"></a>Configure rules for aggregating scraped data into new time series</h2><ol>
<li>Though not a problem in our example, <strong>queries</strong> that <strong>aggregate</strong> over <strong>thousands of time series</strong> can <strong>get slow</strong> when <strong>computed ad-hoc</strong>.</li>
<li>To make this <strong>more efficient</strong>, Prometheus can <strong>prerecord expressions</strong> into <strong>new persisted time series</strong> via <strong>configured recording rules</strong>.</li>
<li>Let’s say we are interested in recording the <strong>per-second rate of cpu time</strong> (node_cpu_seconds_total) <strong>averaged over all cpus per instance</strong> (but preserving the <strong>job</strong>, <strong>instance</strong> and <strong>mode</strong> dimensions) as measured over a <strong>window</strong> of 5 minutes. We could write this as:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/image-20251108233546711.png" alt="image-20251108233546711"></p>
<ol>
<li>To <strong>record</strong> the time series <strong>resulting from</strong> this <strong>expression</strong> into a <strong>new metric</strong> called <code>job_instance_mode:node_cpu_seconds:avg_rate5m</code></li>
<li>create a file with the following <strong>recording rule</strong> and save it as <code>prometheus.rules.yml</code>:</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu-node</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">job_instance_mode:node_cpu_seconds:avg_rate5m</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">avg</span> <span class="string">by</span> <span class="string">(job,</span> <span class="string">instance,</span> <span class="string">mode)</span> <span class="string">(rate(node_cpu_seconds_total[5m]))</span></span><br></pre></td></tr></table></figure>

<p>To make Prometheus <strong>pick up</strong> this new <strong>rule</strong>, add a <code>rule_files</code> statement in your <code>prometheus.yml</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span> <span class="comment"># By default, scrape targets every 15 seconds.</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># Evaluate rules every 15 seconds.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Attach these extra labels to all timeseries collected by this Prometheus instance.</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">&quot;codelab-monitor&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;prometheus.rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;node&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:8080&quot;</span>, <span class="string">&quot;localhost:8081&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:8082&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">&quot;canary&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Restart</strong> Prometheus with the new configuration and verify that <strong>a new time series</strong> with the <strong>metric name</strong> <code>job_instance_mode:node_cpu_seconds:avg_rate5m</code> is now available by querying it through the <strong>expression browser</strong> or <strong>graphing</strong> it.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/image-20251108234323934.png" alt="image-20251108234323934"></p>
<h2 id="Reloading-configuration"><a href="#Reloading-configuration" class="headerlink" title="Reloading configuration"></a>Reloading configuration</h2><ol>
<li>As mentioned in the <strong>configuration</strong> documentation<ul>
<li>a Prometheus instance can have its <strong>configuration reloaded without restarting</strong> the process by using the <strong>SIGHUP</strong> signal.</li>
</ul>
</li>
<li>If you’re running on <strong>Linux</strong> this can be performed by using <code>kill -s SIGHUP &lt;PID&gt;</code>, replacing <code>&lt;PID&gt;</code> with your Prometheus process ID.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time=2025-11-08T23:45:43.274+08:00 level=INFO source=main.go:1502 msg=&quot;Loading configuration file&quot; filename=prometheus.yml</span><br><span class="line">time=2025-11-08T23:45:44.438+08:00 level=INFO source=main.go:1542 msg=&quot;Completed loading of configuration file&quot; db_storage=2.959µs remote_storage=2.083µs web_handler=1.5µs query_engine=2.041µs scrape=1.163449209s scrape_sd=52.666µs notify=1.375µs notify_sd=792ns rules=340.792µs tracing=3.833µs filename=prometheus.yml totalDuration=1.164344791s</span><br></pre></td></tr></table></figure>

<h2 id="Shutting-down-your-instance-gracefully"><a href="#Shutting-down-your-instance-gracefully" class="headerlink" title="Shutting down your instance gracefully."></a>Shutting down your instance gracefully.</h2><ol>
<li>While Prometheus does have <strong>recovery mechanisms</strong> in the case that there is an <strong>abrupt process failure</strong><ul>
<li>it is <strong>recommended</strong> to use <strong>signals</strong> or <strong>interrupts</strong> for a <strong>clean shutdown</strong> of a <strong>Prometheus instance</strong>.</li>
</ul>
</li>
<li>On <strong>Linux</strong>, this can be done by sending the <strong>SIGTERM</strong> or <strong>SIGINT</strong> signals to the <strong>Prometheus process</strong>.</li>
<li>For example, you can use <code>kill -s &lt;SIGNAL&gt; &lt;PID&gt;</code>, replacing <code>&lt;SIGNAL&gt;</code> with the signal name and <code>&lt;PID&gt;</code> with the <strong>Prometheus process ID</strong>.</li>
<li>Alternatively, you can press the <strong>interrupt character</strong> at the <strong>controlling terminal</strong>, which by default is <strong>^C</strong> (Control-C).</li>
</ol>
<blockquote>
<p>SIGTERM</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">time=2025-11-08T23:49:48.337+08:00 level=WARN source=main.go:1080 msg=&quot;Received an OS signal, exiting gracefully...&quot; signal=terminated</span><br><span class="line">time=2025-11-08T23:49:48.337+08:00 level=INFO source=main.go:1105 msg=&quot;Stopping scrape discovery manager...&quot;</span><br><span class="line">time=2025-11-08T23:49:48.337+08:00 level=INFO source=main.go:1119 msg=&quot;Stopping notify discovery manager...&quot;</span><br><span class="line">time=2025-11-08T23:49:48.337+08:00 level=INFO source=manager.go:204 msg=&quot;Stopping rule manager...&quot; component=&quot;rule manager&quot;</span><br><span class="line">time=2025-11-08T23:49:48.338+08:00 level=INFO source=manager.go:220 msg=&quot;Rule manager stopped&quot; component=&quot;rule manager&quot;</span><br><span class="line">time=2025-11-08T23:49:48.338+08:00 level=INFO source=main.go:1156 msg=&quot;Stopping scrape manager...&quot;</span><br><span class="line">time=2025-11-08T23:49:48.338+08:00 level=INFO source=main.go:1101 msg=&quot;Scrape discovery manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:49:48.338+08:00 level=INFO source=main.go:1148 msg=&quot;Scrape manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:49:48.338+08:00 level=INFO source=main.go:1115 msg=&quot;Notify discovery manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:49:48.348+08:00 level=INFO source=manager.go:559 msg=&quot;Stopping notification manager...&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:49:48.348+08:00 level=INFO source=manager.go:301 msg=&quot;Draining any remaining notifications...&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:49:48.348+08:00 level=INFO source=manager.go:307 msg=&quot;Remaining notifications drained&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:49:48.348+08:00 level=INFO source=manager.go:234 msg=&quot;Notification manager stopped&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:49:48.348+08:00 level=INFO source=main.go:1426 msg=&quot;Notifier manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:49:48.349+08:00 level=INFO source=main.go:1440 msg=&quot;See you next time!&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SIGINT</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">time=2025-11-08T23:50:52.014+08:00 level=WARN source=main.go:1080 msg=&quot;Received an OS signal, exiting gracefully...&quot; signal=interrupt</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=main.go:1105 msg=&quot;Stopping scrape discovery manager...&quot;</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=main.go:1119 msg=&quot;Stopping notify discovery manager...&quot;</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=manager.go:204 msg=&quot;Stopping rule manager...&quot; component=&quot;rule manager&quot;</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=manager.go:220 msg=&quot;Rule manager stopped&quot; component=&quot;rule manager&quot;</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=main.go:1156 msg=&quot;Stopping scrape manager...&quot;</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=main.go:1115 msg=&quot;Notify discovery manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=main.go:1148 msg=&quot;Scrape manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:50:52.014+08:00 level=INFO source=main.go:1101 msg=&quot;Scrape discovery manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:50:52.028+08:00 level=INFO source=manager.go:559 msg=&quot;Stopping notification manager...&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:50:52.028+08:00 level=INFO source=manager.go:301 msg=&quot;Draining any remaining notifications...&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:50:52.028+08:00 level=INFO source=manager.go:307 msg=&quot;Remaining notifications drained&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:50:52.028+08:00 level=INFO source=manager.go:234 msg=&quot;Notification manager stopped&quot; component=notifier</span><br><span class="line">time=2025-11-08T23:50:52.028+08:00 level=INFO source=main.go:1426 msg=&quot;Notifier manager stopped&quot;</span><br><span class="line">time=2025-11-08T23:50:52.028+08:00 level=INFO source=main.go:1440 msg=&quot;See you next time!&quot;</span><br></pre></td></tr></table></figure>

<h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><h2 id="Using-Docker"><a href="#Using-Docker" class="headerlink" title="Using Docker"></a>Using Docker</h2><ol>
<li>All Prometheus services are available as Docker images on <strong>Quay.io</strong> or <strong>Docker Hub</strong></li>
<li>Running Prometheus on Docker is as simple as <strong>docker run -p 9090:9090 prom&#x2F;prometheus</strong>.<ul>
<li>This starts Prometheus with a <strong>sample configuration</strong> and <strong>exposes</strong> it on port <strong>9090</strong>.</li>
</ul>
</li>
<li>The Prometheus image uses a <strong>volume</strong> to <strong>store</strong> the <strong>actual metrics</strong>.</li>
<li>For <strong>production deployments</strong> it is <strong>highly recommended</strong> to use a <strong>named volume</strong> to <strong>ease managing the data</strong> on <strong>Prometheus upgrades</strong>.</li>
</ol>
<h3 id="Setting-command-line-parameters"><a href="#Setting-command-line-parameters" class="headerlink" title="Setting command line parameters"></a>Setting command line parameters</h3><ol>
<li>The <strong>Docker image</strong> is started with a number of <strong>default command line parameters</strong>, which can be found in the <strong>Dockerfile</strong>.</li>
<li>If you want to add <strong>extra command line parameters</strong> to the <strong>docker run command</strong>, you will need to <strong>re-add</strong> these yourself as they will be <strong>overwritten</strong>.</li>
</ol>
<h3 id="Volumes-bind-mount"><a href="#Volumes-bind-mount" class="headerlink" title="Volumes &amp; bind-mount"></a>Volumes &amp; bind-mount</h3><ol>
<li>To provide your own configuration, there are several options. Here are two examples.</li>
<li><strong>Bind-mount</strong> your <strong>prometheus.yml</strong> from the host by running:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    -p 9090:9090 \</span><br><span class="line">    -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \</span><br><span class="line">    prom/prometheus</span><br></pre></td></tr></table></figure>

<p>Or <strong>bind-mount</strong> the <strong>directory</strong> containing <code>prometheus.yml</code> onto <code>/etc/prometheus</code> by running:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    -p 9090:9090 \</span><br><span class="line">    -v /path/to/config:/etc/prometheus \</span><br><span class="line">    prom/prometheus</span><br></pre></td></tr></table></figure>

<h3 id="Save-your-Prometheus-data"><a href="#Save-your-Prometheus-data" class="headerlink" title="Save your Prometheus data"></a>Save your Prometheus data</h3><ol>
<li><strong>Prometheus data</strong> is stored in <strong>&#x2F;prometheus</strong> dir <strong>inside the container</strong>, so the data is <strong>cleared every time</strong> the <strong>container</strong> gets <strong>restarted</strong>.</li>
<li>To save your data, you need to set up <strong>persistent storage</strong> (or <strong>bind mounts</strong>) for your <strong>container</strong>.</li>
</ol>
<p>Run Prometheus container with <strong>persistent storage</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Create persistent volume for your data</span><br><span class="line">docker volume create prometheus-data</span><br><span class="line"># Start Prometheus container</span><br><span class="line">docker run \</span><br><span class="line">    -p 9090:9090 \</span><br><span class="line">    -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \</span><br><span class="line">    -v prometheus-data:/prometheus \</span><br><span class="line">    prom/prometheus</span><br></pre></td></tr></table></figure>

<h1 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h1><h2 id="Configuration-1"><a href="#Configuration-1" class="headerlink" title="Configuration"></a>Configuration</h2><ol>
<li>Prometheus is configured via <strong>command-line flags</strong> and <strong>a configuration file</strong>.</li>
<li>While the <strong>command-line flags</strong> configure <strong>immutable system parameters</strong><ul>
<li>such as <u>storage locations</u>, amount of data to keep on disk and in memory, etc.</li>
</ul>
</li>
<li>the <strong>configuration file</strong> defines everything related to <strong>scraping jobs and their instances</strong>, as well as which <strong>rule files to load</strong>.</li>
<li>To view all <strong>available command-line flags</strong>, run <strong>.&#x2F;prometheus -h</strong>.</li>
<li>Prometheus can <strong>reload</strong> its <strong>configuration</strong> at <strong>runtime</strong>.<ul>
<li>If the <strong>new configuration</strong> is <strong>not well-formed</strong>, the <strong>changes</strong> will <strong>not be applied</strong>.</li>
</ul>
</li>
<li>A configuration <strong>reload</strong> is <strong>triggered</strong> by sending a <strong>SIGHUP</strong> to the <strong>Prometheus process</strong><ul>
<li>or sending a <strong>HTTP POST request</strong> to the <strong>&#x2F;-&#x2F;reload</strong> endpoint (when the <strong>–web.enable-lifecycle</strong> flag is enabled).</li>
<li>This will also <strong>reload</strong> any <strong>configured rule files</strong>.</li>
</ul>
</li>
</ol>
<h3 id="Configuration-file"><a href="#Configuration-file" class="headerlink" title="Configuration file"></a>Configuration file</h3><ol>
<li>To specify which configuration file to load, use the <strong>–config.file</strong> flag.</li>
<li>The file is written in <strong>YAML</strong> format, defined by the <strong>scheme</strong> described below.<ul>
<li><strong>Brackets</strong> indicate that a parameter is <strong>optional</strong>.</li>
<li>For <strong>non-list parameters</strong> the <strong>value</strong> is set to the <strong>specified default</strong>.</li>
</ul>
</li>
</ol>
<p>Generic <strong>placeholders</strong> are defined as follows:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;boolean&gt;</code></td>
<td>a boolean that can take the values <code>true</code> or <code>false</code></td>
</tr>
<tr>
<td><code>&lt;duration&gt;</code></td>
<td>a duration matching the regular expression &#96;((([0-9]+)y)?(([0-9]+)w)?(([0-9]+)d)?(([0-9]+)h)?(([0-9]+)m)?(([0-9]+)s)?(([0-9]+)ms)?</td>
</tr>
<tr>
<td><code>&lt;filename&gt;</code></td>
<td>a valid path in the current working directory</td>
</tr>
<tr>
<td><code>&lt;float&gt;</code></td>
<td>a floating-point number</td>
</tr>
<tr>
<td><code>&lt;host&gt;</code></td>
<td>a valid string consisting of a <strong>hostname</strong> or <strong>IP</strong> followed by an optional port number</td>
</tr>
<tr>
<td><code>&lt;int&gt;</code></td>
<td>an integer value</td>
</tr>
<tr>
<td><code>&lt;labelname&gt;</code></td>
<td>a string matching the regular expression <code>[a-zA-Z_][a-zA-Z0-9_]*</code>.<br />Any other <strong>unsupported character</strong> in the <strong>source label</strong> should be converted to an <strong>underscore</strong>.<br />For example, the label <code>app.kubernetes.io/name</code> should be written as <code>app_kubernetes_io_name</code>.</td>
</tr>
<tr>
<td><code>&lt;labelvalue&gt;</code></td>
<td>a string of unicode characters</td>
</tr>
<tr>
<td><code>&lt;path&gt;</code></td>
<td>a valid URL path</td>
</tr>
<tr>
<td><code>&lt;scheme&gt;</code></td>
<td>a string that can take the values <code>http</code> or <code>https</code></td>
</tr>
<tr>
<td><code>&lt;secret&gt;</code></td>
<td>a regular string that is a secret, such as a password</td>
</tr>
<tr>
<td><code>&lt;string&gt;</code></td>
<td>a regular string</td>
</tr>
<tr>
<td><code>&lt;size&gt;</code></td>
<td>a size in bytes, e.g. <code>512MB</code>. A unit is required. Supported units: B, KB, MB, GB, TB, PB, EB.</td>
</tr>
<tr>
<td><code>&lt;tmpl_string&gt;</code></td>
<td>a string which is template-expanded before usage</td>
</tr>
</tbody></table>
<p>The other placeholders are <strong>specified separately</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">🔍 占位符含义</span><br><span class="line"></span><br><span class="line">基础数据类型</span><br><span class="line"></span><br><span class="line">- &lt;boolean&gt;: 布尔值 - true 或 false</span><br><span class="line">- &lt;string&gt;: 普通字符串</span><br><span class="line">- &lt;int&gt;: 整数值</span><br><span class="line">- &lt;float&gt;: 浮点数</span><br><span class="line">- &lt;secret&gt;: 敏感信息（如密码）</span><br><span class="line"></span><br><span class="line">时间相关</span><br><span class="line"></span><br><span class="line">- &lt;duration&gt;: 持续时间格式</span><br><span class="line">  - 支持: 1d, 1h30m, 5m, 10s</span><br><span class="line">  - 正则: (([0-9]+)y)?(([0-9]+)w)?(([0-9]+)d)?(([0-9]+)h)?(([0-9]+)m)?(([0-9]+)s)?(([0-9]+)ms)?</span><br><span class="line">  - 示例: 1d30m, 2h, 0</span><br><span class="line"></span><br><span class="line">网络相关</span><br><span class="line"></span><br><span class="line">- &lt;host&gt;: 主机名或IP + 可选端口</span><br><span class="line">  - 示例: localhost:9090, 192.168.1.1, example.com:8080</span><br><span class="line">- &lt;scheme&gt;: 协议 - http 或 https</span><br><span class="line">- &lt;path&gt;: URL路径</span><br><span class="line"></span><br><span class="line">标签相关</span><br><span class="line"></span><br><span class="line">- &lt;labelname&gt;: 标签名称</span><br><span class="line">  - 规则: [a-zA-Z_][a-zA-Z0-9_]*</span><br><span class="line">  - 特殊字符转换: app.kubernetes.io/name → app_kubernetes_io_name</span><br><span class="line">- &lt;labelvalue&gt;: 标签值（Unicode字符串）</span><br><span class="line"></span><br><span class="line">文件相关</span><br><span class="line"></span><br><span class="line">- &lt;filename&gt;: 当前工作目录下的有效路径</span><br><span class="line">- &lt;size&gt;: 大小（字节）</span><br><span class="line">  - 示例: 512MB, 1GB, 2TB</span><br><span class="line">  - 单位: B, KB, MB, GB, TB, PB, EB</span><br><span class="line"></span><br><span class="line">特殊类型</span><br><span class="line"></span><br><span class="line">- &lt;tmpl_string&gt;: 模板字符串（使用前会展开）</span><br><span class="line"></span><br><span class="line">📖 为什么需要这些定义？</span><br><span class="line"></span><br><span class="line">1. 统一语法规范</span><br><span class="line"># 这些都符合 &lt;duration&gt; 格式</span><br><span class="line">scrape_interval: 1m</span><br><span class="line">evaluation_interval: 30s</span><br><span class="line">scrape_timeout: 10s</span><br><span class="line"></span><br><span class="line">2. 避免歧义</span><br><span class="line"># 明确哪些字段需要哪种格式</span><br><span class="line">port: 9090              # &lt;int&gt;</span><br><span class="line">body_size_limit: 100MB  # &lt;size&gt;</span><br><span class="line">timeout: 30s            # &lt;duration&gt;</span><br><span class="line"></span><br><span class="line">3. 标签标准化</span><br><span class="line"># Kubernetes 标签转换规则</span><br><span class="line">labels:</span><br><span class="line">  app_kubernetes_io_name: &quot;my-app&quot;    # 正确</span><br><span class="line">  app.kubernetes.io/name: &quot;my-app&quot;   # 错误，需要转换</span><br><span class="line"></span><br><span class="line">🎯 &quot;The other placeholders are specified separately&quot;</span><br><span class="line"></span><br><span class="line">这句话的意思是：</span><br><span class="line">- 上面列出的是通用占位符</span><br><span class="line">- 特定功能模块的占位符在各自的章节中定义</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line"># 在 &lt;relabel_config&gt; 章节会定义</span><br><span class="line">&lt;relabel_action&gt;: replace | keep | drop | ...</span><br><span class="line"></span><br><span class="line"># 在 &lt;kubernetes_sd_config&gt; 章节会定义</span><br><span class="line">&lt;kubernetes_role&gt;: node | service | pod | endpoints | ...</span><br><span class="line"></span><br><span class="line">💡 实际应用</span><br><span class="line"></span><br><span class="line">理解这些占位符能帮助你：</span><br><span class="line">1. 正确编写配置文件</span><br><span class="line">2. 快速理解配置文档</span><br><span class="line">3. 避免常见的配置错误</span><br><span class="line"></span><br><span class="line">比如看到配置文档中的：</span><br><span class="line">[ scrape_interval: &lt;duration&gt; | default = 1m ]</span><br><span class="line"></span><br><span class="line">你就知道这里可以填入：30s, 5m, 1h 等时间格式。</span><br></pre></td></tr></table></figure>

<p>The <strong>global configuration</strong> specifies parameters that are <strong>valid</strong> in <strong>all other configuration contexts</strong>.<br>They also serve as <strong>defaults</strong> for other configuration sections.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># How frequently to scrape targets by default.</span></span><br><span class="line">  [ <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># How long until a scrape request times out.</span></span><br><span class="line">  <span class="comment"># It cannot be greater than the scrape interval.</span></span><br><span class="line">  [ <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">10s</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The protocols to negotiate during a scrape with the client.</span></span><br><span class="line">  <span class="comment"># Supported values (case sensitive): PrometheusProto, OpenMetricsText0.0.1,</span></span><br><span class="line">  <span class="comment"># OpenMetricsText1.0.0, PrometheusText0.0.4.</span></span><br><span class="line">  <span class="comment"># The default value changes to [ PrometheusProto, OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span></span><br><span class="line">  <span class="comment"># when native_histogram feature flag is set.</span></span><br><span class="line">  [ <span class="attr">scrape_protocols:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> [ <span class="string">OpenMetricsText1.0.0</span>, <span class="string">OpenMetricsText0.0.1</span>, <span class="string">PrometheusText0.0.4</span> ] ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># How frequently to evaluate rules.</span></span><br><span class="line">  [ <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Offset the rule evaluation timestamp of this particular group by the</span></span><br><span class="line">  <span class="comment"># specified duration into the past to ensure the underlying metrics have</span></span><br><span class="line">  <span class="comment"># been received. Metric availability delays are more likely to occur when</span></span><br><span class="line">  <span class="comment"># Prometheus is running as a remote write target, but can also occur when</span></span><br><span class="line">  <span class="comment"># there&#x27;s anomalies with scraping.</span></span><br><span class="line">  [ <span class="attr">rule_query_offset:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">0s</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The labels to add to any time series or alerts when communicating with</span></span><br><span class="line">  <span class="comment"># external systems (federation, remote storage, Alertmanager).</span></span><br><span class="line">  <span class="comment"># Environment variable references `$&#123;var&#125;` or `$var` are replaced according</span></span><br><span class="line">  <span class="comment"># to the values of the current environment variables.</span></span><br><span class="line">  <span class="comment"># References to undefined variables are replaced by the empty string.</span></span><br><span class="line">  <span class="comment"># The `$` character can be escaped by using `$$`.</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    [ <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># File to which PromQL queries are logged.</span></span><br><span class="line">  <span class="comment"># Reloading the configuration will reopen the file.</span></span><br><span class="line">  [ <span class="attr">query_log_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># File to which scrape failures are logged.</span></span><br><span class="line">  <span class="comment"># Reloading the configuration will reopen the file.</span></span><br><span class="line">  [ <span class="attr">scrape_failure_log_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># An uncompressed response body larger than this many bytes will cause the</span></span><br><span class="line">  <span class="comment"># scrape to fail. 0 means no limit. Example: 100MB.</span></span><br><span class="line">  <span class="comment"># This is an experimental feature, this behaviour could</span></span><br><span class="line">  <span class="comment"># change or be removed in the future.</span></span><br><span class="line">  [ <span class="attr">body_size_limit:</span> <span class="string">&lt;size&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Per-scrape limit on the number of scraped samples that will be accepted.</span></span><br><span class="line">  <span class="comment"># If more than this number of samples are present after metric relabeling</span></span><br><span class="line">  <span class="comment"># the entire scrape will be treated as failed. 0 means no limit.</span></span><br><span class="line">  [ <span class="attr">sample_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Limit on the number of labels that will be accepted per sample. If more</span></span><br><span class="line">  <span class="comment"># than this number of labels are present on any sample post metric-relabeling,</span></span><br><span class="line">  <span class="comment"># the entire scrape will be treated as failed. 0 means no limit.</span></span><br><span class="line">  [ <span class="attr">label_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Limit on the length (in bytes) of each individual label name. If any label</span></span><br><span class="line">  <span class="comment"># name in a scrape is longer than this number post metric-relabeling, the</span></span><br><span class="line">  <span class="comment"># entire scrape will be treated as failed. Note that label names are UTF-8</span></span><br><span class="line">  <span class="comment"># encoded, and characters can take up to 4 bytes. 0 means no limit.</span></span><br><span class="line">  [ <span class="attr">label_name_length_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Limit on the length (in bytes) of each individual label value. If any label</span></span><br><span class="line">  <span class="comment"># value in a scrape is longer than this number post metric-relabeling, the</span></span><br><span class="line">  <span class="comment"># entire scrape will be treated as failed. Note that label values are UTF-8</span></span><br><span class="line">  <span class="comment"># encoded, and characters can take up to 4 bytes. 0 means no limit.</span></span><br><span class="line">  [ <span class="attr">label_value_length_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Limit per scrape config on number of unique targets that will be</span></span><br><span class="line">  <span class="comment"># accepted. If more than this number of targets are present after target</span></span><br><span class="line">  <span class="comment"># relabeling, Prometheus will mark the targets as failed without scraping them.</span></span><br><span class="line">  <span class="comment"># 0 means no limit. This is an experimental feature, this behaviour could</span></span><br><span class="line">  <span class="comment"># change in the future.</span></span><br><span class="line">  [ <span class="attr">target_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Limit per scrape config on the number of targets dropped by relabeling</span></span><br><span class="line">  <span class="comment"># that will be kept in memory. 0 means no limit.</span></span><br><span class="line">  [ <span class="attr">keep_dropped_targets:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Specifies the validation scheme for metric and label names. Either blank or</span></span><br><span class="line">  <span class="comment"># &quot;utf8&quot; for full UTF-8 support, or &quot;legacy&quot; for letters, numbers, colons,</span></span><br><span class="line">  <span class="comment"># and underscores.</span></span><br><span class="line">  [ <span class="attr">metric_name_validation_scheme:</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;utf8&quot;</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Specifies whether to convert all scraped classic histograms into native</span></span><br><span class="line">  <span class="comment"># histograms with custom buckets.</span></span><br><span class="line">  [ <span class="attr">convert_classic_histograms_to_nhcb:</span> <span class="string">&lt;bool&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Specifies whether to scrape a classic histogram, even if it is also exposed as a native</span></span><br><span class="line">  <span class="comment"># histogram (has no effect without --enable-feature=native-histograms).</span></span><br><span class="line">  [ <span class="attr">always_scrape_classic_histograms:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">runtime:</span></span><br><span class="line">  <span class="comment"># Configure the Go garbage collector GOGC parameter</span></span><br><span class="line">  <span class="comment"># See: https://tip.golang.org/doc/gc-guide#GOGC</span></span><br><span class="line">  <span class="comment"># Lowering this number increases CPU usage.</span></span><br><span class="line">  [ <span class="attr">gogc:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">75</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Rule files specifies a list of globs. Rules and alerts are read from</span></span><br><span class="line"><span class="comment"># all matching files.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Scrape config files specifies a list of globs. Scrape configs are read from</span></span><br><span class="line"><span class="comment"># all matching files and appended to the list of scrape configs.</span></span><br><span class="line"><span class="attr">scrape_config_files:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># A list of scrape configurations.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;scrape_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alerting specifies settings related to the Alertmanager.</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;alertmanager_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the remote write feature.</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_write&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the OTLP receiver feature.</span></span><br><span class="line"><span class="comment"># See https://prometheus.io/docs/guides/opentelemetry/ for best practices.</span></span><br><span class="line"><span class="attr">otlp:</span></span><br><span class="line">  <span class="comment"># Promote specific list of resource attributes to labels.</span></span><br><span class="line">  <span class="comment"># It cannot be configured simultaneously with &#x27;promote_all_resource_attributes: true&#x27;.</span></span><br><span class="line">  [ <span class="attr">promote_resource_attributes:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> [ ] ]</span><br><span class="line">  <span class="comment"># Promoting all resource attributes to labels, except for the ones configured with &#x27;ignore_resource_attributes&#x27;.</span></span><br><span class="line">  <span class="comment"># Be aware that changes in attributes received by the OTLP endpoint may result in time series churn and lead to high memory usage by the Prometheus server.</span></span><br><span class="line">  <span class="comment"># It cannot be set to &#x27;true&#x27; simultaneously with &#x27;promote_resource_attributes&#x27;.</span></span><br><span class="line">  [ <span class="attr">promote_all_resource_attributes:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line">  <span class="comment"># Which resource attributes to ignore, can only be set when &#x27;promote_all_resource_attributes&#x27; is true.</span></span><br><span class="line">  [ <span class="attr">ignore_resource_attributes:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> [] ]</span><br><span class="line">  <span class="comment"># Configures translation of OTLP metrics when received through the OTLP metrics</span></span><br><span class="line">  <span class="comment"># endpoint. Available values:</span></span><br><span class="line">  <span class="comment"># - &quot;UnderscoreEscapingWithSuffixes&quot; refers to commonly agreed normalization used</span></span><br><span class="line">  <span class="comment">#   by OpenTelemetry in https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/pkg/translator/prometheus</span></span><br><span class="line">  <span class="comment"># - &quot;NoUTF8EscapingWithSuffixes&quot; is a mode that relies on UTF-8 support in Prometheus.</span></span><br><span class="line">  <span class="comment">#   It preserves all special characters like dots, but still adds required metric name suffixes</span></span><br><span class="line">  <span class="comment">#   for units and _total, as UnderscoreEscapingWithSuffixes does.</span></span><br><span class="line">  <span class="comment"># - &quot;UnderscoreEscapingWithoutSuffixes&quot; translates metric name characters that</span></span><br><span class="line">  <span class="comment">#   are not alphanumerics/underscores/colons to underscores, and label name</span></span><br><span class="line">  <span class="comment">#   characters that are not alphanumerics/underscores to underscores, but</span></span><br><span class="line">  <span class="comment">#   unlike UnderscoreEscapingWithSuffixes it does not append any suffixes to</span></span><br><span class="line">  <span class="comment">#   the names.</span></span><br><span class="line">  <span class="comment"># - (EXPERIMENTAL) &quot;NoTranslation&quot; is a mode that relies on UTF-8 support in Prometheus.</span></span><br><span class="line">  <span class="comment">#   It preserves all special character like dots and won&#x27;t append special suffixes for metric</span></span><br><span class="line">  <span class="comment">#   unit and type.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#   WARNING: The &quot;NoTranslation&quot; setting has significant known risks and limitations (see https://prometheus.io/docs/practices/naming/</span></span><br><span class="line">  <span class="comment">#   for details):</span></span><br><span class="line">  <span class="comment">#       * Impaired UX when using PromQL in plain YAML (e.g. alerts, rules, dashboard, autoscaling configuration).</span></span><br><span class="line">  <span class="comment">#       * Series collisions which in the best case may result in OOO errors, in the worst case a silently malformed</span></span><br><span class="line">  <span class="comment">#         time series. For instance, you may end up in situation of ingesting `foo.bar` series with unit</span></span><br><span class="line">  <span class="comment">#         `seconds` and a separate series `foo.bar` with unit `milliseconds`.</span></span><br><span class="line">  [ <span class="attr">translation_strategy:</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&quot;UnderscoreEscapingWithSuffixes&quot;</span> ]</span><br><span class="line">  <span class="comment"># Enables adding &quot;service.name&quot;, &quot;service.namespace&quot; and &quot;service.instance.id&quot;</span></span><br><span class="line">  <span class="comment"># resource attributes to the &quot;target_info&quot; metric, on top of converting</span></span><br><span class="line">  <span class="comment"># them into the &quot;instance&quot; and &quot;job&quot; labels.</span></span><br><span class="line">  [ <span class="attr">keep_identifying_resource_attributes:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line">  <span class="comment"># Configures optional translation of OTLP explicit bucket histograms into native histograms with custom buckets.</span></span><br><span class="line">  [ <span class="attr">convert_histograms_to_nhcb:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line">  <span class="comment"># Enables promotion of OTel scope metadata (i.e. name, version, schema URL, and attributes) to metric labels.</span></span><br><span class="line">  <span class="comment"># This is disabled by default for backwards compatibility, but according to OTel spec, scope metadata _should_ be identifying, i.e. translated to metric labels.</span></span><br><span class="line">  [ <span class="attr">promote_scope_metadata:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the remote read feature.</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_read&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Storage related settings that are runtime reloadable.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  [ <span class="attr">tsdb:</span> <span class="string">&lt;tsdb&gt;</span> ]</span><br><span class="line">  [ <span class="attr">exemplars:</span> <span class="string">&lt;exemplars&gt;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configures exporting traces.</span></span><br><span class="line"><span class="attr">tracing:</span></span><br><span class="line">  [ <span class="string">&lt;tracing_config&gt;</span> ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>scrape_protocols</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">📖 参数含义</span><br><span class="line"></span><br><span class="line">scrape_protocols - 抓取协议协商</span><br><span class="line"></span><br><span class="line">- 作用: 定义 Prometheus 与目标服务通信时支持的协议格式</span><br><span class="line">- 类型: [&lt;string&gt;, ...] (字符串列表)</span><br><span class="line">- 大小写敏感: 必须严格按照示例的大小写</span><br><span class="line"></span><br><span class="line">🔄 支持的协议</span><br><span class="line"></span><br><span class="line">1. PrometheusProto</span><br><span class="line"></span><br><span class="line">- 格式: Protocol Buffers 二进制格式</span><br><span class="line">- 特点: 高效、紧凑、性能最好</span><br><span class="line">- 适用: 现代化的指标导出器</span><br><span class="line"></span><br><span class="line">2. OpenMetricsText1.0.0</span><br><span class="line"></span><br><span class="line">- 格式: OpenMetrics 1.0.0 标准文本格式</span><br><span class="line">- 特点: 标准化、兼容性好</span><br><span class="line">- 适用: 遵循 OpenMetrics 标准的服务</span><br><span class="line"></span><br><span class="line">3. OpenMetricsText0.0.1</span><br><span class="line"></span><br><span class="line">- 格式: OpenMetrics 0.0.1 旧版文本格式</span><br><span class="line">- 特点: 向后兼容</span><br><span class="line">- 适用: 较老的 OpenMetrics 实现</span><br><span class="line"></span><br><span class="line">4. PrometheusText0.0.4</span><br><span class="line"></span><br><span class="line">- 格式: Prometheus 经典文本格式</span><br><span class="line">- 特点: 最常用、兼容性最强</span><br><span class="line">- 适用: 大部分现有的 Prometheus exporters</span><br><span class="line"></span><br><span class="line">🎯 协议协商机制</span><br><span class="line"></span><br><span class="line">Prometheus 会按照列表顺序与目标协商使用哪种协议：</span><br><span class="line"></span><br><span class="line">scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line"># 协商过程：</span><br><span class="line"># 1. Prometheus: &quot;支持 PrometheusProto 吗？&quot;</span><br><span class="line"># 2. 如果目标支持 → 使用 PrometheusProto</span><br><span class="line"># 3. 如果不支持 → &quot;支持 OpenMetricsText1.0.0 吗？&quot;</span><br><span class="line"># 4. 如果目标支持 → 使用 OpenMetricsText1.0.0</span><br><span class="line"># 5. 如果不支持 → 继续尝试下一个...</span><br><span class="line"></span><br><span class="line">🔄 默认值变化</span><br><span class="line"></span><br><span class="line">默认情况:</span><br><span class="line"></span><br><span class="line"># 默认协议顺序</span><br><span class="line">[ OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">启用原生直方图时:</span><br><span class="line"></span><br><span class="line"># 当 --enable-feature=native-histogram 时</span><br><span class="line">[ PrometheusProto, OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">注意: 启用原生直方图时，PrometheusProto 会排在第一位，因为它对原生直方图支持最好。</span><br><span class="line"></span><br><span class="line">🔧 实际配置示例</span><br><span class="line"></span><br><span class="line">1. 默认配置 (你的情况)</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  # 没有设置 scrape_protocols，使用默认值</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line"></span><br><span class="line"># 实际效果：</span><br><span class="line"># scrape_protocols: [ OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">2. 优化性能配置</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0 ]</span><br><span class="line">  # 优先使用二进制协议，性能更好</span><br><span class="line"></span><br><span class="line">3. 兼容性优先配置</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  scrape_protocols: [ PrometheusText0.0.4, OpenMetricsText0.0.1 ]</span><br><span class="line">  # 确保与老版本 exporters 兼容</span><br><span class="line"></span><br><span class="line">4. 启用原生直方图配置</span><br><span class="line"></span><br><span class="line"># 命令行启动时</span><br><span class="line">./prometheus --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line"># 配置文件</span><br><span class="line">global:</span><br><span class="line">  # 会自动使用：</span><br><span class="line">  # [ PrometheusProto, OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">📊 协议选择建议</span><br><span class="line"></span><br><span class="line">推荐配置 (生产环境):</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">优势:</span><br><span class="line">- 优先使用高效的二进制协议</span><br><span class="line">- 保持向后兼容性</span><br><span class="line">- 覆盖大部分使用场景</span><br><span class="line"></span><br><span class="line">保守配置 (兼容性优先):</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  scrape_protocols: [ PrometheusText0.0.4, OpenMetricsText0.0.1 ]</span><br><span class="line"></span><br><span class="line">适用: 需要与老版本或非标准实现兼容的环境</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 大小写敏感</span><br><span class="line"></span><br><span class="line"># ✅ 正确</span><br><span class="line">scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0 ]</span><br><span class="line"></span><br><span class="line"># ❌ 错误</span><br><span class="line">scrape_protocols: [ prometheusproto, OpenMetricstext1.0.0 ]</span><br><span class="line"></span><br><span class="line">2. 协议顺序重要</span><br><span class="line"></span><br><span class="line"># 不同的顺序会有不同的协商结果</span><br><span class="line">[ PrometheusProto, OpenMetricsText1.0.0 ]  # 优先二进制</span><br><span class="line">[ OpenMetricsText1.0.0, PrometheusProto ]  # 优先文本</span><br><span class="line"></span><br><span class="line">3. 与目标服务匹配</span><br><span class="line"></span><br><span class="line">确保你的监控目标支持配置的协议，否则协商可能失败。</span><br><span class="line"></span><br><span class="line">你的配置使用默认值是一个安全的选择，适合大多数使用场景。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PrometheusProto, OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">🎯 概览对比表</span><br><span class="line"></span><br><span class="line">| 协议                   | 类型  | 标准化        | 性能  | 兼容性 | 主要用途  |</span><br><span class="line">|----------------------|-----|------------|-----|-----|-------|</span><br><span class="line">| PrometheusProto      | 二进制 | Prometheus | 最高  | 中等  | 高性能场景 |</span><br><span class="line">| OpenMetricsText1.0.0 | 文本  | CNCF 标准    | 中等  | 高   | 标准化监控 |</span><br><span class="line">| OpenMetricsText0.0.1 | 文本  | 旧版标准       | 中等  | 高   | 向后兼容  |</span><br><span class="line">| PrometheusText0.0.4  | 文本  | Prometheus | 中等  | 最高  | 最广泛兼容 |</span><br><span class="line"></span><br><span class="line">🔧 PrometheusProto (Protocol Buffers)</span><br><span class="line"></span><br><span class="line">格式特征:</span><br><span class="line"></span><br><span class="line">// 二进制格式示例（简化）</span><br><span class="line">message WriteRequest &#123;</span><br><span class="line">  repeated TimeSeries timeseries = 1;</span><br><span class="line">  repeated MetricMetadata metadata = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message TimeSeries &#123;</span><br><span class="line">  repeated Label labels = 1;</span><br><span class="line">  repeated Sample samples = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">优势:</span><br><span class="line"></span><br><span class="line">- ⚡ 性能最佳: 二进制压缩，解析速度快</span><br><span class="line">- 📦 传输高效: 网络传输量更小</span><br><span class="line">- 🔒 类型安全: 强类型定义，减少解析错误</span><br><span class="line">- 🎯 原生直方图: 对原生直方图支持最好</span><br><span class="line"></span><br><span class="line">劣势:</span><br><span class="line"></span><br><span class="line">- 🔍 调试困难: 二进制格式不易人工查看</span><br><span class="line">- 🔧 工具限制: 需要专门工具解析</span><br><span class="line">- 📊 生态支持: 并非所有工具都支持</span><br><span class="line"></span><br><span class="line">适用场景:</span><br><span class="line"></span><br><span class="line"># 高性能环境</span><br><span class="line">scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0 ]</span><br><span class="line"></span><br><span class="line">📝 OpenMetricsText1.0.0 (CNCF 标准)</span><br><span class="line"></span><br><span class="line">格式特征:</span><br><span class="line"></span><br><span class="line"># 标准化的 OpenMetrics 格式</span><br><span class="line"># HELP http_requests_total The total number of HTTP requests.</span><br><span class="line"># TYPE http_requests_total counter</span><br><span class="line"># UNIT http_requests_total requests</span><br><span class="line">http_requests_total&#123;method=&quot;GET&quot;,code=&quot;200&quot;&#125; 1027</span><br><span class="line"></span><br><span class="line"># 明确的直方图格式</span><br><span class="line"># TYPE latency_seconds histogram</span><br><span class="line"># UNIT latency_seconds seconds</span><br><span class="line">latency_seconds_bucket&#123;le=&quot;0.1&quot;&#125; 24054</span><br><span class="line">latency_seconds_bucket&#123;le=&quot;0.5&quot;&#125; 33444</span><br><span class="line">latency_seconds_bucket&#123;le=&quot;+Inf&quot;&#125; 10000</span><br><span class="line">latency_seconds_sum 1.7560473e+07</span><br><span class="line">latency_seconds_count 2633</span><br><span class="line"></span><br><span class="line"># EOF 必须存在</span><br><span class="line"></span><br><span class="line">优势:</span><br><span class="line"></span><br><span class="line">- 🎯 官方标准: CNCF 认证标准</span><br><span class="line">- 🔗 跨工具兼容: 多个监控工具支持</span><br><span class="line">- 📋 元数据丰富: 明确的单位、类型定义</span><br><span class="line">- 📊 结构清晰: 人类可读，机器易解析</span><br><span class="line"></span><br><span class="line">新增特性:</span><br><span class="line"></span><br><span class="line"># 单位信息 (UNIT)</span><br><span class="line"># UNIT cpu_usage_percent percent</span><br><span class="line"># UNIT memory_bytes bytes</span><br><span class="line"></span><br><span class="line"># 信息指标 (Info)</span><br><span class="line"># TYPE node_info info</span><br><span class="line">node_info&#123;version=&quot;1.0&quot;,os=&quot;linux&quot;&#125; 1</span><br><span class="line"></span><br><span class="line"># 状态集合 (StateSet)</span><br><span class="line"># TYPE feature_flags stateset</span><br><span class="line">feature_flags&#123;feature=&quot;beta&quot;&#125; 1</span><br><span class="line">feature_flags&#123;feature=&quot;alpha&quot;&#125; 0</span><br><span class="line"></span><br><span class="line">📚 OpenMetricsText0.0.1 (旧版标准)</span><br><span class="line"></span><br><span class="line">格式特征:</span><br><span class="line"></span><br><span class="line"># 与 1.0.0 基本相同，但缺少一些新特性</span><br><span class="line"># HELP http_requests_total The total number of HTTP requests.</span><br><span class="line"># TYPE http_requests_total counter</span><br><span class="line">http_requests_total&#123;method=&quot;GET&quot;,code=&quot;200&quot;&#125; 1027</span><br><span class="line"></span><br><span class="line"># 没有 EOF 标记要求</span><br><span class="line"></span><br><span class="line">主要差异:</span><br><span class="line"></span><br><span class="line">- 📝 元数据较少: 缺少 UNIT 等新字段</span><br><span class="line">- 🔄 向后兼容: 与 Prometheus 格式更接近</span><br><span class="line">- 📊 功能有限: 不支持最新特性</span><br><span class="line"></span><br><span class="line">🏛️ PrometheusText0.0.4 (经典格式)</span><br><span class="line"></span><br><span class="line">格式特征:</span><br><span class="line"></span><br><span class="line"># Prometheus 原始格式</span><br><span class="line"># HELP http_requests_total The total number of HTTP requests.</span><br><span class="line"># TYPE http_requests_total counter</span><br><span class="line">http_requests_total&#123;method=&quot;GET&quot;,code=&quot;200&quot;&#125; 1027</span><br><span class="line"></span><br><span class="line"># 直方图格式略有不同</span><br><span class="line"># HELP http_request_duration_seconds A histogram of the request duration.</span><br><span class="line"># TYPE http_request_duration_seconds histogram</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.05&quot;&#125; 24054</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125; 10000</span><br><span class="line">http_request_duration_seconds_sum 1.7560473e+07</span><br><span class="line">http_request_duration_seconds_count 2633</span><br><span class="line"></span><br><span class="line">特点:</span><br><span class="line"></span><br><span class="line">- 🔧 最成熟: 经过长期验证的格式</span><br><span class="line">- 🌐 最广泛支持: 几乎所有 Prometheus 兼容工具都支持</span><br><span class="line">- 📊 简单直接: 易于理解和实现</span><br><span class="line">- 🎯 生态标准: Prometheus 生态系统的事实标准</span><br><span class="line"></span><br><span class="line">🔄 协议协商过程</span><br><span class="line"></span><br><span class="line">scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">协商流程:</span><br><span class="line"></span><br><span class="line">Prometheus → Target: &quot;支持 PrometheusProto 吗？&quot;</span><br><span class="line">├─ ✅ 支持 → 使用 PrometheusProto (最快)</span><br><span class="line">└─ ❌ 不支持 → &quot;支持 OpenMetricsText1.0.0 吗？&quot;</span><br><span class="line">   ├─ ✅ 支持 → 使用 OpenMetricsText1.0.0 (标准化)</span><br><span class="line">   └─ ❌ 不支持 → &quot;支持 OpenMetricsText0.0.1 吗？&quot;</span><br><span class="line">      ├─ ✅ 支持 → 使用 OpenMetricsText0.0.1 (兼容)</span><br><span class="line">      └─ ❌ 不支持 → 使用 PrometheusText0.0.4 (最兼容)</span><br><span class="line"></span><br><span class="line">📈 性能对比</span><br><span class="line"></span><br><span class="line">| 操作     | PrometheusProto | OpenMetricsText1.0.0 | PrometheusText0.0.4 |</span><br><span class="line">|--------|-----------------|----------------------|---------------------|</span><br><span class="line">| 序列化    | 快               | 中等                   | 中等                  |</span><br><span class="line">| 反序列化   | 快               | 中等                   | 中等                  |</span><br><span class="line">| 网络传输   | 小               | 大                    | 大                   |</span><br><span class="line">| 内存占用   | 低               | 高                    | 高                   |</span><br><span class="line">| CPU 使用 | 低               | 中等                   | 中等                  |</span><br><span class="line"></span><br><span class="line">🎯 选择建议</span><br><span class="line"></span><br><span class="line">生产环境推荐配置:</span><br><span class="line"></span><br><span class="line"># 平衡性能和兼容性</span><br><span class="line">scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">兼容性优先配置:</span><br><span class="line"></span><br><span class="line"># 确保最大兼容性</span><br><span class="line">scrape_protocols: [ OpenMetricsText1.0.0, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">性能优先配置:</span><br><span class="line"></span><br><span class="line"># 追求最高性能</span><br><span class="line">scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0 ]</span><br><span class="line"></span><br><span class="line">💡 你的配置分析</span><br><span class="line"></span><br><span class="line">你的配置使用默认协议顺序：</span><br><span class="line"># 默认情况下</span><br><span class="line">scrape_protocols: [ OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">这是一个很好的选择：</span><br><span class="line">- 🎯 优先使用标准化格式</span><br><span class="line">- 🔄 自动回退到兼容格式</span><br><span class="line">- 🛡️ 确保与各种目标都能通信</span><br><span class="line">- 📊 平衡了标准性和兼容性</span><br><span class="line"></span><br><span class="line">如果启用原生直方图功能，会自动调整为：</span><br><span class="line"># --enable-feature=native-histograms 时</span><br><span class="line">scrape_protocols: [ PrometheusProto, OpenMetricsText1.0.0, OpenMetricsText0.0.1, PrometheusText0.0.4 ]</span><br><span class="line"></span><br><span class="line">这样会优先使用性能更好的二进制协议来处理原生直方图。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>evaluation_interval</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">🔍 独立运行的任务</span><br><span class="line"></span><br><span class="line">抓取数据 和 评估规则 是两个独立的调度任务，它们各自按照自己的间隔运行，不会互相阻塞。</span><br><span class="line"></span><br><span class="line">✅ 正确的时间线</span><br><span class="line"></span><br><span class="line">你的配置:</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s     # 抓取调度器</span><br><span class="line">  evaluation_interval: 1m   # 规则评估调度器</span><br><span class="line"></span><br><span class="line">实际运行情况:</span><br><span class="line"></span><br><span class="line">时间线:</span><br><span class="line">00:00 - 规则评估 (使用当前已有数据)</span><br><span class="line">00:15 - 抓取数据</span><br><span class="line">00:30 - 抓取数据</span><br><span class="line">00:45 - 抓取数据</span><br><span class="line">01:00 - 规则评估 (使用最新抓取的数据) + 同时可能也在抓取数据</span><br><span class="line">01:15 - 抓取数据</span><br><span class="line">01:30 - 抓取数据</span><br><span class="line">01:45 - 抓取数据</span><br><span class="line">02:00 - 规则评估 + 同时可能也在抓取数据</span><br><span class="line"></span><br><span class="line">⚙️ 并发执行机制</span><br><span class="line"></span><br><span class="line">两个独立的调度器:</span><br><span class="line"></span><br><span class="line">// 伪代码展示并发执行</span><br><span class="line">func main() &#123;</span><br><span class="line">    // 抓取调度器 - 每15秒运行</span><br><span class="line">    go func() &#123;</span><br><span class="line">        for &#123;</span><br><span class="line">            scrapeTargets()    // 抓取数据</span><br><span class="line">            time.Sleep(15s)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    // 规则评估调度器 - 每1分钟运行</span><br><span class="line">    go func() &#123;</span><br><span class="line">        for &#123;</span><br><span class="line">            evaluateRules()    // 评估规则</span><br><span class="line">            time.Sleep(1m)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">01:00 时刻的情况:</span><br><span class="line"></span><br><span class="line">在 01:00 这一时刻：</span><br><span class="line">├─ 规则评估调度器触发</span><br><span class="line">│   └─ 评估所有告警规则</span><br><span class="line">│   └─ 使用 TSDB 中最新的数据</span><br><span class="line">│</span><br><span class="line">└─ 抓取调度器可能也同时触发</span><br><span class="line">    └─ 抓取目标的指标数据</span><br><span class="line">    └─ 将新数据写入 TSDB</span><br><span class="line"></span><br><span class="line">🎯 关键点</span><br><span class="line"></span><br><span class="line">1. 不会互相等待:</span><br><span class="line"></span><br><span class="line">- 规则评估不会等待数据抓取完成</span><br><span class="line">- 数据抓取也不会等待规则评估完成</span><br><span class="line">- 两者完全独立运行</span><br><span class="line"></span><br><span class="line">2. 数据一致性:</span><br><span class="line"></span><br><span class="line"># 规则评估时使用的是 TSDB 中已有的数据</span><br><span class="line"># 不一定是最新抓取的数据</span><br><span class="line">expr: cpu_usage &gt; 80</span><br><span class="line"></span><br><span class="line"># 在 01:00 评估时，可能使用的是 00:45 抓取的数据</span><br><span class="line"># 01:00 抓取的新数据要等到 02:00 评估时才会用到</span><br><span class="line"></span><br><span class="line">3. 时间重叠处理:</span><br><span class="line"></span><br><span class="line">01:00 时刻：</span><br><span class="line">├─ 规则评估开始 (使用 00:45 的数据)</span><br><span class="line">├─ 数据抓取开始 (获取新数据)</span><br><span class="line">├─ 规则评估完成 (生成告警状态)</span><br><span class="line">└─ 数据抓取完成 (新数据写入TSDB，下次评估使用)</span><br><span class="line"></span><br><span class="line">📊 实际影响</span><br><span class="line"></span><br><span class="line">最大数据延迟:</span><br><span class="line"></span><br><span class="line"># 最坏情况下的数据延迟</span><br><span class="line">问题发生时刻: 00:46</span><br><span class="line">下次抓取: 01:00 (但可能稍晚几毫秒)</span><br><span class="line">下次评估: 01:00 (使用00:45的数据，还没看到问题)</span><br><span class="line">再次评估: 02:00 (使用01:00的数据，此时才看到问题)</span><br><span class="line"></span><br><span class="line"># 实际最大延迟 ≈ 15s (抓取间隔) + 60s (评估间隔) = 75秒</span><br><span class="line"></span><br><span class="line">为什么这样设计:</span><br><span class="line"></span><br><span class="line">- ✅ 性能优化: 避免评估等待抓取</span><br><span class="line">- ✅ 资源隔离: 两个任务互不干扰</span><br><span class="line">- ✅ 简化调度: 各自独立，逻辑清晰</span><br><span class="line">- ✅ 容错性: 一个任务失败不影响另一个</span><br></pre></td></tr></table></figure>

<blockquote>
<p>rule_query_offset</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">⏺ 📖 参数含义</span><br><span class="line"></span><br><span class="line">  rule_query_offset - 规则查询时间偏移</span><br><span class="line"></span><br><span class="line">  - 作用: 将规则评估的时间点向后偏移指定时间，确保底层数据已经到达</span><br><span class="line">  - 类型: &lt;duration&gt; (持续时间)</span><br><span class="line">  - 默认值: 0s (无偏移)</span><br><span class="line">  - 用途: 解决数据延迟问题</span><br><span class="line"></span><br><span class="line">  🎯 解决的问题</span><br><span class="line"></span><br><span class="line">  数据延迟场景:</span><br><span class="line"></span><br><span class="line">  正常情况:</span><br><span class="line">  时间:     09:00:00</span><br><span class="line">  指标时间: 09:00:00 (实时数据)</span><br><span class="line">  评估:     立即使用 ✅</span><br><span class="line"></span><br><span class="line">  延迟情况:</span><br><span class="line">  时间:     09:00:00</span><br><span class="line">  指标时间: 08:59:30 (延迟30秒)</span><br><span class="line">  评估:     使用了不完整的数据 ❌</span><br><span class="line"></span><br><span class="line">  具体延迟场景:</span><br><span class="line"></span><br><span class="line">  1. 远程写入场景:</span><br><span class="line"></span><br><span class="line">  # 架构: Exporter → Prometheus → Remote Storage → Prometheus</span><br><span class="line">  # 数据流向:</span><br><span class="line">  #   09:00:00 - Exporter 暴露指标</span><br><span class="line">  #   09:00:05 - Prometheus 抓取并写入远程存储</span><br><span class="line">  #   09:00:15 - 远程存储持久化完成</span><br><span class="line">  #   09:00:30 - Prometheus 从远程存储读取</span><br><span class="line">  #   09:01:00 - 规则评估 (此时数据已完整)</span><br><span class="line"></span><br><span class="line">  2. 网络延迟:</span><br><span class="line"></span><br><span class="line">  # 跨数据中心或云环境</span><br><span class="line">  # Exporter 在 A 地区</span><br><span class="line">  # Prometheus 在 B 地区</span><br><span class="line">  # 网络延迟可能导致数据传输慢</span><br><span class="line"></span><br><span class="line">  3. 抓取异常:</span><br><span class="line"></span><br><span class="line">  # 目标服务偶尔响应慢</span><br><span class="line">  # 或网络抖动导致抓取失败重试</span><br><span class="line">  # 数据到达时间不规律</span><br><span class="line"></span><br><span class="line">  ⏰ 工作原理</span><br><span class="line"></span><br><span class="line">  无偏移 (默认):</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    evaluation_interval: 1m</span><br><span class="line">    rule_query_offset: 0s  # 默认值</span><br><span class="line"></span><br><span class="line">  # 评估时间点:</span><br><span class="line">  # 09:00:00 - 评估 09:00:00 的数据</span><br><span class="line">  # 09:01:00 - 评估 09:01:00 的数据</span><br><span class="line">  # 09:02:00 - 评估 09:02:00 的数据</span><br><span class="line"></span><br><span class="line">  有偏移:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    evaluation_interval: 1m</span><br><span class="line">    rule_query_offset: 30s  # 偏移30秒</span><br><span class="line"></span><br><span class="line">  # 评估时间点:</span><br><span class="line">  # 09:00:00 - 评估 08:59:30 的数据 (向前推30秒)</span><br><span class="line">  # 09:01:00 - 评估 09:00:30 的数据 (向前推30秒)</span><br><span class="line">  # 09:02:00 - 评估 09:01:30 的数据 (向前推30秒)</span><br><span class="line"></span><br><span class="line">  🔧 配置示例</span><br><span class="line"></span><br><span class="line">  1. 远程写入环境:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    evaluation_interval: 1m</span><br><span class="line">    rule_query_offset: 2m   # 给远程写入2分钟缓冲时间</span><br><span class="line"></span><br><span class="line">  # 确保从远程存储读取时数据已完整</span><br><span class="line"></span><br><span class="line">  2. 网络不稳定环境:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    evaluation_interval: 30s</span><br><span class="line">    rule_query_offset: 45s   # 45秒偏移应对网络延迟</span><br><span class="line"></span><br><span class="line">  # 适合跨云或跨地域部署</span><br><span class="line"></span><br><span class="line">  3. 大规模抓取:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    scrape_interval: 15s</span><br><span class="line">    evaluation_interval: 1m</span><br><span class="line">    rule_query_offset: 1m    # 1分钟偏移确保所有数据到达</span><br><span class="line"></span><br><span class="line">  # 当抓取目标很多时，完成一轮需要时间</span><br><span class="line"></span><br><span class="line">  📊 实际影响分析</span><br><span class="line"></span><br><span class="line">  延迟计算:</span><br><span class="line"></span><br><span class="line">  # 你的配置 (假设添加了偏移)</span><br><span class="line">  global:</span><br><span class="line">    scrape_interval: 15s</span><br><span class="line">    evaluation_interval: 1m</span><br><span class="line">    rule_query_offset: 30s</span><br><span class="line"></span><br><span class="line">  # 告警响应时间:</span><br><span class="line">  # 问题发生 → 最多15秒被抓取 → 最多30秒偏移缓冲 → 1分钟评估 → 5分钟for时间</span><br><span class="line">  # 总延迟 ≈ 15s + 30s + 1m + 5m = 6分45秒</span><br><span class="line"></span><br><span class="line">  数据新鲜度:</span><br><span class="line"></span><br><span class="line">  # 无偏移: 使用最新数据，但可能不完整</span><br><span class="line">  rule_query_offset: 0s</span><br><span class="line">  # 查询时间: 09:00:00 → 数据范围: 09:00:00 ± 5m</span><br><span class="line"></span><br><span class="line">  # 有偏移: 使用稍旧数据，但更可靠</span><br><span class="line">  rule_query_offset: 30s</span><br><span class="line">  # 查询时间: 09:00:00 → 数据范围: 08:59:30 ± 5m</span><br><span class="line"></span><br><span class="line">  🎯 使用建议</span><br><span class="line"></span><br><span class="line">  何时需要设置:</span><br><span class="line"></span><br><span class="line">  - ✅ 远程写入架构: Prometheus 作为远程写入目标</span><br><span class="line">  - ✅ 跨地域部署: 网络延迟较高</span><br><span class="line">  - ✅ 大规模抓取: 大量目标导致抓取时间长</span><br><span class="line">  - ✅ 数据延迟敏感: 需要确保数据完整性</span><br><span class="line"></span><br><span class="line">  何时不需要设置:</span><br><span class="line"></span><br><span class="line">  - ❌ 本地部署: 数据路径短，延迟低</span><br><span class="line">  - ❌ 简单架构: 单一 Prometheus 实例</span><br><span class="line">  - ❌ 实时要求高: 需要立即响应变化</span><br><span class="line">  - ❌ 资源充足: 可以接受偶发的数据不完整</span><br><span class="line"></span><br><span class="line">  推荐设置:</span><br><span class="line"></span><br><span class="line">  # 根据架构复杂度调整</span><br><span class="line">  rule_query_offset: 30s   # 轻微延迟</span><br><span class="line">  rule_query_offset: 1m    # 中等延迟</span><br><span class="line">  rule_query_offset: 2m    # 较重延迟</span><br><span class="line"></span><br><span class="line">  💡 与你的配置关系</span><br><span class="line"></span><br><span class="line">  你的当前配置：</span><br><span class="line">  global:</span><br><span class="line">    scrape_interval: 15s</span><br><span class="line">    evaluation_interval: 1m</span><br><span class="line">    # rule_query_offset: 0s (默认，无偏移)</span><br><span class="line"></span><br><span class="line">  这是合理的：</span><br><span class="line">  - ✅ 本地部署: 假设是本地或同网络环境</span><br><span class="line">  - ✅ 数据及时: 无额外延迟，告警响应快</span><br><span class="line">  - ✅ 简单架构: 适合大多数标准部署</span><br><span class="line"></span><br><span class="line">  如果遇到以下情况，可以考虑添加偏移：</span><br><span class="line">  - 发现告警总是延迟触发</span><br><span class="line">  - 确认存在数据传输延迟</span><br><span class="line">  - 使用了远程存储或远程写入架构</span><br><span class="line"></span><br><span class="line">  总的来说，这个参数是一个保险机制，在数据延迟不可控时提供可靠性保障。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>external_labels</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">⏺ 📖 参数含义</span><br><span class="line"></span><br><span class="line">  external_labels - 外部标签</span><br><span class="line"></span><br><span class="line">  - 作用: 为所有时间序列和告警添加全局标签，用于与外部系统通信</span><br><span class="line">  - 用途: 联邦、远程存储、Alertmanager 通信</span><br><span class="line">  - 环境变量: 支持环境变量引用 $&#123;var&#125; 或 $var</span><br><span class="line"></span><br><span class="line">  🏷️ 标签添加范围</span><br><span class="line"></span><br><span class="line">  影响的外部系统:</span><br><span class="line"></span><br><span class="line">  1. Federation (联邦): 其他 Prometheus 实例抓取时</span><br><span class="line">  2. Remote Storage (远程存储): 发送到远程存储系统时</span><br><span class="line">  3. Alertmanager: 发送告警到 Alertmanager 时</span><br><span class="line"></span><br><span class="line">  不影响的范围:</span><br><span class="line"></span><br><span class="line">  - ❌ 本地查询和规则评估</span><br><span class="line">  - ❌ 本地 API 响应</span><br><span class="line">  - ❌ 直接查看的指标</span><br><span class="line"></span><br><span class="line">  🔧 基础配置示例</span><br><span class="line"></span><br><span class="line">  你的配置:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      monitor: &quot;codelab-monitor&quot;</span><br><span class="line"></span><br><span class="line">  实际效果:</span><br><span class="line"></span><br><span class="line">  # 原始指标</span><br><span class="line">  http_requests_total&#123;instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;&#125; 100</span><br><span class="line"></span><br><span class="line">  # 添加外部标签后 (发送到外部系统时)</span><br><span class="line">  http_requests_total&#123;instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;, monitor=&quot;codelab-monitor&quot;&#125; 100</span><br><span class="line"></span><br><span class="line">  🌍 环境变量支持</span><br><span class="line"></span><br><span class="line">  基本语法:</span><br><span class="line"></span><br><span class="line">  external_labels:</span><br><span class="line">    # 两种环境变量语法</span><br><span class="line">    cluster: &quot;$&#123;CLUSTER_NAME&#125;&quot;      # 推荐语法</span><br><span class="line">    region: &quot;$REGION&quot;               # 简化语法</span><br><span class="line">    datacenter: &quot;$&#123;DATACENTER:-default&#125;&quot;  # 默认值语法</span><br><span class="line">    version: &quot;v1.2.3-$&#123;BUILD_ID&#125;&quot;  # 与静态值组合</span><br><span class="line"></span><br><span class="line">  转义处理:</span><br><span class="line"></span><br><span class="line">  external_labels:</span><br><span class="line">    # 转义 $ 字符</span><br><span class="line">    literal_dollar: &quot;$$escaped_value&quot;  # 结果: $escaped_value</span><br><span class="line">    money_sign: &quot;$$&#123;CURRENCY&#125;&quot;        # 如果CURRENCY=USD，结果: $USD</span><br><span class="line"></span><br><span class="line">  环境变量处理规则:</span><br><span class="line"></span><br><span class="line">  - ✅ 存在变量: 替换为实际值</span><br><span class="line">  - ❌ 不存在变量: 替换为空字符串 &quot;&quot;</span><br><span class="line">  - 💡 转义: $$ 转义为单个 $</span><br><span class="line"></span><br><span class="line">  🎯 实际应用场景</span><br><span class="line"></span><br><span class="line">  1. 联邦场景 (Federation):</span><br><span class="line"></span><br><span class="line">  # 主 Prometheus 配置</span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      prometheus: &quot;main&quot;</span><br><span class="line">      region: &quot;us-west&quot;</span><br><span class="line">      cluster: &quot;production&quot;</span><br><span class="line"></span><br><span class="line">  # 子 Prometheus 抓取</span><br><span class="line">  # /federate?prometheus=main&amp;region=us-west&amp;cluster=production</span><br><span class="line"></span><br><span class="line">  2. 远程存储场景:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      source: &quot;prometheus-main&quot;</span><br><span class="line">      env: &quot;$&#123;ENVIRONMENT&#125;&quot;</span><br><span class="line">      datacenter: &quot;$&#123;DATACENTER&#125;&quot;</span><br><span class="line"></span><br><span class="line">  # 所有发送到远程存储的指标都包含这些标签</span><br><span class="line">  # 用于区分不同 Prometheus 实例的数据</span><br><span class="line"></span><br><span class="line">  3. Alertmanager 场景:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      cluster: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span><br><span class="line">      region: &quot;$&#123;AWS_REGION&#125;&quot;</span><br><span class="line">      team: &quot;platform&quot;</span><br><span class="line"></span><br><span class="line">  # 告警发送时会自动添加这些标签</span><br><span class="line">  # Alertmanager 路由规则可以使用这些标签</span><br><span class="line"></span><br><span class="line">  🏢 复杂配置示例</span><br><span class="line"></span><br><span class="line">  生产环境配置:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      # 环境信息</span><br><span class="line">      environment: &quot;$&#123;ENV:-production&#125;&quot;</span><br><span class="line">      region: &quot;$&#123;AWS_REGION:-us-west-2&#125;&quot;</span><br><span class="line">      availability_zone: &quot;$&#123;AZ:-us-west-2a&#125;&quot;</span><br><span class="line"></span><br><span class="line">      # 实例标识</span><br><span class="line">      cluster: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span><br><span class="line">      prometheus_instance: &quot;$&#123;HOSTNAME&#125;&quot;</span><br><span class="line">      team: &quot;$&#123;TEAM:-platform&#125;&quot;</span><br><span class="line"></span><br><span class="line">      # 版本信息</span><br><span class="line">      prometheus_version: &quot;v3.7.3&quot;</span><br><span class="line">      config_version: &quot;2024.11.09&quot;</span><br><span class="line"></span><br><span class="line">      # 业务标识</span><br><span class="line">      business_unit: &quot;infrastructure&quot;</span><br><span class="line">      cost_center: &quot;IT-OPS&quot;</span><br><span class="line"></span><br><span class="line">  动态环境变量:</span><br><span class="line"></span><br><span class="line">  # 设置环境变量</span><br><span class="line">  export CLUSTER_NAME=&quot;prod-k8s-cluster&quot;</span><br><span class="line">  export AWS_REGION=&quot;us-west-2&quot;</span><br><span class="line">  export TEAM=&quot;observability&quot;</span><br><span class="line">  export DATACENTER=&quot;datacenter-1&quot;</span><br><span class="line"></span><br><span class="line">  # Prometheus 启动时会读取这些环境变量</span><br><span class="line">  ./prometheus --config.file=prometheus.yml</span><br><span class="line"></span><br><span class="line">  📊 标签传播机制</span><br><span class="line"></span><br><span class="line">  告警标签传播:</span><br><span class="line"></span><br><span class="line">  # 规则文件中的告警</span><br><span class="line">  - alert: HighCPUUsage</span><br><span class="line">    expr: cpu_usage &gt; 80</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;High CPU usage detected&quot;</span><br><span class="line"></span><br><span class="line">  # 发送到 Alertmanager 时自动添加外部标签:</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;alertname&quot;: &quot;HighCPUUsage&quot;,</span><br><span class="line">      &quot;severity&quot;: &quot;critical&quot;,</span><br><span class="line">      &quot;monitor&quot;: &quot;codelab-monitor&quot;  # ← external_labels 添加</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  联邦查询标签:</span><br><span class="line"></span><br><span class="line">  # 源 Prometheus</span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      source: &quot;main-prometheus&quot;</span><br><span class="line">      region: &quot;us-west&quot;</span><br><span class="line"></span><br><span class="line">  # 目标 Prometheus 联邦查询</span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;federate&#x27;</span><br><span class="line">      honor_labels: true</span><br><span class="line">      metrics_path: /federate</span><br><span class="line">      params:</span><br><span class="line">        &#x27;match[]&#x27;:</span><br><span class="line">          - &#x27;&#123;__name__=~&quot;.+&quot;&#125;&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;source-prometheus:9090&#x27;]</span><br><span class="line"></span><br><span class="line">  # 获取到的指标包含源的外部标签</span><br><span class="line">  up&#123;job=&quot;federate&quot;, instance=&quot;source-prometheus:9090&quot;, source=&quot;main-prometheus&quot;, region=&quot;us-west&quot;&#125;</span><br><span class="line"></span><br><span class="line">  ⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">  1. 标签名称规范:</span><br><span class="line"></span><br><span class="line">  # ✅ 正确的标签名</span><br><span class="line">  external_labels:</span><br><span class="line">    cluster: &quot;production&quot;           # 符合规范</span><br><span class="line">    region: &quot;us-west-2&quot;             # 符合规范</span><br><span class="line"></span><br><span class="line">  # ❌ 错误的标签名</span><br><span class="line">  external_labels:</span><br><span class="line">    app.kubernetes.io/name: &quot;app&quot;   # 需要转换为: app_kubernetes_io_name</span><br><span class="line">    invalid-name: &quot;value&quot;           # 包含连字符，需要转换</span><br><span class="line"></span><br><span class="line">  2. 环境变量处理:</span><br><span class="line"></span><br><span class="line">  # 安全的环境变量引用</span><br><span class="line">  external_labels:</span><br><span class="line">    # 使用默认值避免空值</span><br><span class="line">    cluster: &quot;$&#123;CLUSTER_NAME:-unknown&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 确保变量存在或提供默认值</span><br><span class="line">    environment: &quot;$&#123;ENVIRONMENT:-production&#125;&quot;</span><br><span class="line"></span><br><span class="line">  3. 标签数量控制:</span><br><span class="line"></span><br><span class="line">  # 避免添加过多标签</span><br><span class="line">  external_labels:</span><br><span class="line">    # ✅ 必要标签</span><br><span class="line">    cluster: &quot;prod-cluster&quot;</span><br><span class="line">    region: &quot;us-west-2&quot;</span><br><span class="line"></span><br><span class="line">    # ❌ 避免添加过多详细信息</span><br><span class="line">    # pod_name: &quot;$&#123;POD_NAME&#125;&quot;        # 变化太频繁</span><br><span class="line">    # container_id: &quot;$&#123;CONTAINER_ID&#125;&quot; # 无关信息</span><br><span class="line"></span><br><span class="line">  💡 你的配置分析</span><br><span class="line"></span><br><span class="line">  你的配置：</span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      monitor: &quot;codelab-monitor&quot;</span><br><span class="line"></span><br><span class="line">  这是一个很好的实践：</span><br><span class="line">  - ✅ 标识明确: 清楚标识数据来源</span><br><span class="line">  - ✅ 简洁有效: 只添加必要的标识信息</span><br><span class="line">  - ✅ 便于管理: 在多 Prometheus 环境中容易区分</span><br><span class="line">  - ✅ 告警有用: Alertmanager 可以基于此标签路由</span><br><span class="line"></span><br><span class="line">  建议可以根据需要逐步扩展，添加更多环境或业务相关的标签。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>query_log_file + scrape_failure_log_file</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">⏺ 📖 日志配置参数解释</span><br><span class="line"></span><br><span class="line">  1. query_log_file - PromQL 查询日志</span><br><span class="line"></span><br><span class="line">  含义:</span><br><span class="line">  - 记录所有执行的 PromQL 查询</span><br><span class="line">  - 包括来自 API、Web UI、规则评估的查询</span><br><span class="line">  - 配置重载时会重新打开文件</span><br><span class="line"></span><br><span class="line">  用途:</span><br><span class="line">  - 🔍 审计查询活动</span><br><span class="line">  - 🐛 调试性能问题</span><br><span class="line">  - 📊 分析查询模式</span><br><span class="line">  - 🛡️ 安全审计</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  global:</span><br><span class="line">    query_log_file: &quot;/var/log/prometheus/queries.log&quot;</span><br><span class="line"></span><br><span class="line">  日志格式:</span><br><span class="line">  2024-11-09T10:15:30.123Z http://localhost:9090/api/v1/query?query=up&amp;time=1731135330.123</span><br><span class="line">  2024-11-09T10:15:35.456Z http://localhost:9090/api/v1/query_range?query=rate(http_requests_total[5m])&amp;start=1731</span><br><span class="line">  135300&amp;end=1731135330&amp;step=15</span><br><span class="line">  2024-11-09T10:16:00.789Z rule=HighCPUUsage query=cpu_usage &gt; 80</span><br><span class="line"></span><br><span class="line">  2. scrape_failure_log_file - 抓取失败日志</span><br><span class="line"></span><br><span class="line">  含义:</span><br><span class="line">  - 记录所有抓取失败的详细信息</span><br><span class="line">  - 包括超时、连接错误、HTTP错误等</span><br><span class="line">  - 配置重载时会重新打开文件</span><br><span class="line"></span><br><span class="line">  用途:</span><br><span class="line">  - 🔧 监控抓取问题</span><br><span class="line">  - 🐛 排查目标服务问题</span><br><span class="line">  - 📊 统计失败率</span><br><span class="line">  - 🚨 及时发现服务异常</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  global:</span><br><span class="line">    scrape_failure_log_file: &quot;/var/log/prometheus/scrape_failures.log&quot;</span><br><span class="line"></span><br><span class="line">  日志格式:</span><br><span class="line">  2024-11-09T10:15:30.123Z scrape_failed job=&quot;node&quot; instance=&quot;localhost:9100&quot; error=&quot;context deadline exceeded&quot;</span><br><span class="line">  2024-11-09T10:15:45.456Z scrape_failed job=&quot;api&quot; instance=&quot;api.example.com:8080&quot; error=&quot;connection refused&quot;</span><br><span class="line">  2024-11-09T10:16:00.789Z scrape_failed job=&quot;web&quot; instance=&quot;web.example.com:80&quot; error=&quot;HTTP 500 Internal Server</span><br><span class="line">  Error&quot;</span><br><span class="line"></span><br><span class="line">  🎯 实际应用场景</span><br><span class="line"></span><br><span class="line">  查询日志 (query_log_file)</span><br><span class="line"></span><br><span class="line">  1. 性能调试:</span><br><span class="line">  # 发现慢查询</span><br><span class="line">  grep &quot;rate(http_requests_total[1h])&quot; /var/log/prometheus/queries.log</span><br><span class="line"></span><br><span class="line">  # 分析查询频率</span><br><span class="line">  cat /var/log/prometheus/queries.log | awk &#x27;&#123;print $1&#125;&#x27; | sort | uniq -c</span><br><span class="line"></span><br><span class="line">  2. 安全审计:</span><br><span class="line">  # 查看谁在查询敏感指标</span><br><span class="line">  grep &quot;secrets&quot; /var/log/prometheus/queries.log</span><br><span class="line"></span><br><span class="line">  # 分析查询模式</span><br><span class="line">  grep &quot;http://.*:3000&quot; /var/log/prometheus/queries.log  # Grafana 查询</span><br><span class="line"></span><br><span class="line">  3. 调试规则:</span><br><span class="line">  # 查看规则评估查询</span><br><span class="line">  grep &quot;rule=&quot; /var/log/prometheus/queries.log</span><br><span class="line"></span><br><span class="line">  抓取失败日志 (scrape_failure_log_file)</span><br><span class="line"></span><br><span class="line">  1. 监控目标健康:</span><br><span class="line">  # 统计失败目标</span><br><span class="line">  cat /var/log/prometheus/scrape_failures.log | grep -o &#x27;instance=&quot;[^&quot;]*&quot;&#x27; | sort | uniq -c</span><br><span class="line"></span><br><span class="line">  # 分析失败类型</span><br><span class="line">  cat /var/log/prometheus/scrape_failures.log | grep -o &#x27;error=&quot;[^&quot;]*&quot;&#x27; | sort | uniq -c</span><br><span class="line"></span><br><span class="line">  2. 网络问题排查:</span><br><span class="line">  # 查看网络相关错误</span><br><span class="line">  grep -E &quot;(timeout|refused|connection)&quot; /var/log/prometheus/scrape_failures.log</span><br><span class="line"></span><br><span class="line">  3. 配置验证:</span><br><span class="line">  # 检查哪些 job 经常失败</span><br><span class="line">  grep -o &#x27;job=&quot;[^&quot;]*&quot;&#x27; /var/log/prometheus/scrape_failures.log | sort | uniq -c | sort -nr</span><br><span class="line"></span><br><span class="line">  ⚙️ 配置建议</span><br><span class="line"></span><br><span class="line">  生产环境配置:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    # 启用查询日志用于审计</span><br><span class="line">    query_log_file: &quot;/var/log/prometheus/queries.log&quot;</span><br><span class="line"></span><br><span class="line">    # 启用抓取失败日志用于监控</span><br><span class="line">    scrape_failure_log_file: &quot;/var/log/prometheus/scrape_failures.log&quot;</span><br><span class="line"></span><br><span class="line">  开发环境配置:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    # 开发环境可以启用详细日志</span><br><span class="line">    query_log_file: &quot;/tmp/prometheus-queries.log&quot;</span><br><span class="line">    scrape_failure_log_file: &quot;/tmp/prometheus-scrape-failures.log&quot;</span><br><span class="line"></span><br><span class="line">  调试时临时启用:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    # 临时开启用于调试</span><br><span class="line">    query_log_file: &quot;/var/log/prometheus/debug-queries.log&quot;</span><br><span class="line"></span><br><span class="line">  🔧 文件管理</span><br><span class="line"></span><br><span class="line">  日志轮转 (logrotate 配置):</span><br><span class="line"></span><br><span class="line">  # /etc/logrotate.d/prometheus-logs</span><br><span class="line">  /var/log/prometheus/*.log &#123;</span><br><span class="line">      daily</span><br><span class="line">      rotate 7</span><br><span class="line">      compress</span><br><span class="line">      delaycompress</span><br><span class="line">      missingok</span><br><span class="line">      notifempty</span><br><span class="line">      create 644 prometheus prometheus</span><br><span class="line">      postrotate</span><br><span class="line">          kill -USR1 $(cat /var/run/prometheus.pid)</span><br><span class="line">      endscript</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  监控日志大小:</span><br><span class="line"></span><br><span class="line">  # 监控日志文件大小</span><br><span class="line">  du -sh /var/log/prometheus/*.log</span><br><span class="line"></span><br><span class="line">  # 实时监控日志</span><br><span class="line">  tail -f /var/log/prometheus/scrape_failures.log</span><br><span class="line"></span><br><span class="line">  ⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">  性能影响:</span><br><span class="line"></span><br><span class="line">  - ✅ 查询日志: 轻微性能开销</span><br><span class="line">  - ⚠️ 抓取失败日志: 失败较多时可能影响性能</span><br><span class="line">  - 💾 磁盘空间: 需要监控日志文件大小</span><br><span class="line"></span><br><span class="line">  敏感信息:</span><br><span class="line"></span><br><span class="line">  - 🔒 查询日志: 可能包含敏感的查询信息</span><br><span class="line">  - 🛡️ 访问控制: 限制日志文件的访问权限</span><br><span class="line"></span><br><span class="line">  文件权限:</span><br><span class="line"></span><br><span class="line">  # 设置合适的文件权限</span><br><span class="line">  chown prometheus:prometheus /var/log/prometheus/*.log</span><br><span class="line">  chmod 640 /var/log/prometheus/*.log</span><br><span class="line"></span><br><span class="line">  💡 最佳实践</span><br><span class="line"></span><br><span class="line">  1. 渐进式启用:</span><br><span class="line"></span><br><span class="line">  # 先启用抓取失败日志</span><br><span class="line">  scrape_failure_log_file: &quot;/var/log/prometheus/scrape_failures.log&quot;</span><br><span class="line"></span><br><span class="line">  # 后续根据需要启用查询日志</span><br><span class="line">  query_log_file: &quot;/var/log/prometheus/queries.log&quot;</span><br><span class="line"></span><br><span class="line">  2. 定期分析:</span><br><span class="line"></span><br><span class="line">  # 设置定期分析脚本</span><br><span class="line">  # 每天分析失败率，每周分析查询模式</span><br><span class="line"></span><br><span class="line">  3. 与监控集成:</span><br><span class="line"></span><br><span class="line">  # 在日志中提取指标用于监控</span><br><span class="line">  # 例如: prometheus_scrape_failures_total&#123;job=&quot;node&quot;&#125;</span><br><span class="line"></span><br><span class="line">  这两个日志功能是 Prometheus 运维的重要工具，建议在生产环境中启用抓取失败日志，根据需要启用查询日志。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>body_size_limit + sample_limit + label_limit + label_name_length_limit + label_value_length_limit + target_limit</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">这些参数用于控制 Prometheus 抓取过程中的资源使用和稳定性保护。</span><br><span class="line"></span><br><span class="line">🎯 1. body_size_limit - 响应体大小限制</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 限制目标服务返回的未压缩响应体大小</span><br><span class="line">- 超过限制时整个抓取失败</span><br><span class="line">- 0 表示无限制</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line">global:</span><br><span class="line">  body_size_limit: 100MB    # 限制100MB</span><br><span class="line"></span><br><span class="line"># 或者</span><br><span class="line">  body_size_limit: 50MB     # 限制50MB</span><br><span class="line">  body_size_limit: 0        # 无限制 (默认)</span><br><span class="line"></span><br><span class="line">适用场景:</span><br><span class="line">- ✅ 防止目标服务返回过多数据</span><br><span class="line">- ✅ 避免内存溢出</span><br><span class="line">- ✅ 保护 Prometheus 稳定性</span><br><span class="line">- ⚠️ 实验性功能，可能变化</span><br><span class="line"></span><br><span class="line">🔢 2. sample_limit - 样本数量限制</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 限制每次抓取接受的样本数量</span><br><span class="line">- 在指标重标签后计算</span><br><span class="line">- 超过限制时整个抓取失败</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line">global:</span><br><span class="line">  sample_limit: 1000000     # 限制100万个样本</span><br><span class="line"></span><br><span class="line"># 或者针对特定job</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;heavy_metrics&quot;</span><br><span class="line">    sample_limit: 500000     # 该job限制50万样本</span><br><span class="line"></span><br><span class="line">实际影响:</span><br><span class="line"># 正常情况: 10,000 个样本 ✅</span><br><span class="line"># 超过限制: 1,500,000 个样本 ❌ (如果 limit=1,000,000)</span><br><span class="line"></span><br><span class="line">🏷️ 3. label_limit - 标签数量限制</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 限制每个样本的标签数量</span><br><span class="line">- 在指标重标签后检查</span><br><span class="line">- 任何样本超过限制都导致整个抓取失败</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line">global:</span><br><span class="line">  label_limit: 50          # 每个样本最多50个标签</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;labeled_metrics&quot;</span><br><span class="line">    label_limit: 30        # 该job每个样本最多30个标签</span><br><span class="line"></span><br><span class="line">标签示例:</span><br><span class="line"># 正常样本: ~10-20个标签 ✅</span><br><span class="line">metric&#123;job=&quot;api&quot;,instance=&quot;1.2.3.4&quot;,method=&quot;GET&quot;,status=&quot;200&quot;,...&#125; 100</span><br><span class="line"></span><br><span class="line"># 标签过多: 可能100+个标签 ❌</span><br><span class="line">metric&#123;label1=&quot;value1&quot;,label2=&quot;value2&quot;,...,label100=&quot;value100&quot;&#125; 100</span><br><span class="line"></span><br><span class="line">📏 4. label_name_length_limit - 标签名长度限制</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 限制每个标签名的字节长度</span><br><span class="line">- UTF-8编码，字符可能占1-4字节</span><br><span class="line">- 任何标签名超长都导致抓取失败</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line">global:</span><br><span class="line">  label_name_length_limit: 512    # 标签名最多512字节</span><br><span class="line"></span><br><span class="line"># 或者更严格</span><br><span class="line">  label_name_length_limit: 256    # 标签名最多256字节</span><br><span class="line"></span><br><span class="line">UTF-8 字符计算:</span><br><span class="line"># ASCII字符: 1字节</span><br><span class="line">&quot;job&quot; = 3字节 ✅</span><br><span class="line"></span><br><span class="line"># 中文字符: 3字节</span><br><span class="line">&quot;中文标签&quot; = 12字节 ✅</span><br><span class="line"></span><br><span class="line"># Emoji: 4字节</span><br><span class="line">&quot;🏷️label&quot; = 8字节 ✅</span><br><span class="line"></span><br><span class="line">📝 5. label_value_length_limit - 标签值长度限制</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 限制每个标签值的字节长度</span><br><span class="line">- UTF-8编码，字符可能占1-4字节</span><br><span class="line">- 任何标签值超长都导致抓取失败</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line">global:</span><br><span class="line">  label_value_length_limit: 2048   # 标签值最多2048字节</span><br><span class="line"></span><br><span class="line"># 或者针对不同job</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;api_metrics&quot;</span><br><span class="line">    label_value_length_limit: 1024</span><br><span class="line"></span><br><span class="line">实际示例:</span><br><span class="line"># 正常值</span><br><span class="line">version: &quot;1.2.3&quot;               # 7字节 ✅</span><br><span class="line">build_id: &quot;abc123&quot;             # 6字节 ✅</span><br><span class="line"></span><br><span class="line"># 可能过长的值</span><br><span class="line">trace_id: &quot;550e8400-e29b-41d4-a716-446655440000&quot;  # 36字节 ✅</span><br><span class="line">long_description: &quot;这是一个很长的描述文本...&quot;        # 可能超长 ❌</span><br><span class="line"></span><br><span class="line">🎯 6. target_limit - 目标数量限制</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 限制每个抓取配置的唯一目标数量</span><br><span class="line">- 在目标重标签后计算</span><br><span class="line">- 超过限制时目标被标记为失败，不进行抓取</span><br><span class="line">- 实验性功能</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line">global:</span><br><span class="line">  target_limit: 10000        # 全局限制1万个目标</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;kubernetes_pods&quot;</span><br><span class="line">    target_limit: 5000       # 该job限制5000个目标</span><br><span class="line"></span><br><span class="line">实际效果:</span><br><span class="line"># Kubernetes服务发现可能返回数千个pod</span><br><span class="line"># 限制后只抓取前5000个，其余标记为失败</span><br><span class="line"></span><br><span class="line">🔧 综合配置示例</span><br><span class="line"></span><br><span class="line">生产环境配置:</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  # 响应体大小限制</span><br><span class="line">  body_size_limit: 100MB</span><br><span class="line"></span><br><span class="line">  # 样本数量限制</span><br><span class="line">  sample_limit: 5000000</span><br><span class="line"></span><br><span class="line">  # 标签相关限制</span><br><span class="line">  label_limit: 100</span><br><span class="line">  label_name_length_limit: 512</span><br><span class="line">  label_value_length_limit: 4096</span><br><span class="line"></span><br><span class="line">  # 目标数量限制</span><br><span class="line">  target_limit: 10000</span><br><span class="line"></span><br><span class="line">资源受限环境:</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  # 更严格的限制</span><br><span class="line">  body_size_limit: 50MB</span><br><span class="line">  sample_limit: 1000000</span><br><span class="line">  label_limit: 50</span><br><span class="line">  label_name_length_limit: 256</span><br><span class="line">  label_value_length_limit: 1024</span><br><span class="line">  target_limit: 5000</span><br><span class="line"></span><br><span class="line">Job级别配置:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;light_metrics&quot;</span><br><span class="line">    # 轻量级服务，较少限制</span><br><span class="line">    sample_limit: 10000</span><br><span class="line">    label_limit: 20</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;heavy_metrics&quot;</span><br><span class="line">    # 重型服务，严格限制</span><br><span class="line">    body_size_limit: 200MB</span><br><span class="line">    sample_limit: 100000</span><br><span class="line">    label_limit: 30</span><br><span class="line"></span><br><span class="line">📊 监控这些限制</span><br><span class="line"></span><br><span class="line">Prometheus 指标:</span><br><span class="line"></span><br><span class="line"># 检查抓取失败</span><br><span class="line">prometheus_scrape_samples_scraped_total</span><br><span class="line">prometheus_scrape_samples_failed_total</span><br><span class="line"></span><br><span class="line"># 检查目标状态</span><br><span class="line">up&#123;job=&quot;heavy_metrics&quot;&#125;  # 0表示抓取失败</span><br><span class="line"></span><br><span class="line">日志监控:</span><br><span class="line"></span><br><span class="line"># 查看抓取失败日志</span><br><span class="line">grep &quot;scrape_failed&quot; /var/log/prometheus/scrape_failures.log | grep &quot;limit&quot;</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 实验性功能:</span><br><span class="line"></span><br><span class="line">- ⚠️ body_size_limit 和 target_limit 是实验性的</span><br><span class="line">- 🔄 未来版本可能变化</span><br><span class="line">- 📋 生产环境谨慎使用</span><br><span class="line"></span><br><span class="line">2. 性能权衡:</span><br><span class="line"></span><br><span class="line">- ✅ 限制严格: 保护资源，稳定运行</span><br><span class="line">- ❌ 限制过严: 可能丢失重要数据</span><br><span class="line">- ⚖️ 需要根据实际情况调整</span><br><span class="line"></span><br><span class="line">3. 配置优先级:</span><br><span class="line"></span><br><span class="line"># Job级别配置覆盖全局配置</span><br><span class="line">global:</span><br><span class="line">  sample_limit: 1000000</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;special_job&quot;</span><br><span class="line">    sample_limit: 500000   # 覆盖全局设置</span><br><span class="line"></span><br><span class="line">4. 渐进式调整:</span><br><span class="line"></span><br><span class="line"># 建议从宽松限制开始，根据实际使用情况逐步收紧</span><br><span class="line">sample_limit: 0          # 先无限制运行</span><br><span class="line">sample_limit: 10000000   # 然后设置较宽松限制</span><br><span class="line">sample_limit: 5000000    # 最后调整到合适值</span><br><span class="line"></span><br><span class="line">这些限制是保护 Prometheus 稳定运行的重要机制，建议根据实际环境和监控需求合理配置。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">📊 Prometheus Global 限制参数表</span><br><span class="line"></span><br><span class="line">| 参数                       | 默认值 | 限制对象      | 计算时机               | 超限后果  | 实验性 | 配置格式   |</span><br><span class="line">|--------------------------|-----|-----------|--------------------|-------|-----|--------|</span><br><span class="line">| body_size_limit          | 0   | HTTP响应体大小 | 接收响应时              | 抓取失败  | ✅   | 100MB  |</span><br><span class="line">| target_limit             | 0   | 抓取目标数量    | target_relabeling后 | 目标不抓取 | ✅   | 10000  |</span><br><span class="line">| sample_limit             | 0   | 样本数量      | metric_relabeling后 | 抓取失败  | ❌   | 500000 |</span><br><span class="line">| label_limit              | 0   | 每个样本的标签数  | metric_relabeling后 | 抓取失败  | ❌   | 100    |</span><br><span class="line">| label_name_length_limit  | 0   | 标签名长度     | metric_relabeling后 | 抓取失败  | ❌   | 512    |</span><br><span class="line">| label_value_length_limit | 0   | 标签值长度     | metric_relabeling后 | 抓取失败  | ❌   | 2048   |</span><br><span class="line"></span><br><span class="line">🎯 快速配置参考</span><br><span class="line"></span><br><span class="line">生产环境推荐:</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  body_size_limit: 100MB</span><br><span class="line">  target_limit: 10000</span><br><span class="line">  sample_limit: 5000000</span><br><span class="line">  label_limit: 100</span><br><span class="line">  label_name_length_limit: 512</span><br><span class="line">  label_value_length_limit: 2048</span><br><span class="line"></span><br><span class="line">资源受限环境:</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  body_size_limit: 50MB</span><br><span class="line">  target_limit: 5000</span><br><span class="line">  sample_limit: 1000000</span><br><span class="line">  label_limit: 50</span><br><span class="line">  label_name_length_limit: 256</span><br><span class="line">  label_value_length_limit: 1024</span><br><span class="line"></span><br><span class="line">💡 关键要点</span><br><span class="line"></span><br><span class="line">- 0 = 无限制 - 所有参数默认无限制</span><br><span class="line">- 字节计算 - UTF-8编码，中文字符占3字节</span><br><span class="line">- 实验性 - body_size_limit 和 target_limit 可能变化</span><br><span class="line">- 渐进调整 - 建议从宽松到严格逐步收紧</span><br></pre></td></tr></table></figure>

<blockquote>
<p>keep_dropped_targets</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line">keep_dropped_targets - 保留丢弃目标的内存限制</span><br><span class="line"></span><br><span class="line">- 作用: 限制被 relabeling 丢弃但仍在内存中保留的目标数量</span><br><span class="line">- 类型: &lt;int&gt; (整数)</span><br><span class="line">- 默认值: 0 (无限制)</span><br><span class="line">- 适用: 每个 scrape 配置</span><br><span class="line"></span><br><span class="line">🎯 工作原理</span><br><span class="line"></span><br><span class="line">Relabeling 过程:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;kubernetes-pods&quot;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 丢弃某些目标</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        regex: &quot;true&quot;</span><br><span class="line">        action: keep  # 只保留有该注解的pod</span><br><span class="line"></span><br><span class="line">内存保留机制:</span><br><span class="line"></span><br><span class="line">原始发现: 1000个pod targets</span><br><span class="line">Relabeling后: 200个有效targets (保留)</span><br><span class="line">丢弃的: 800个targets</span><br><span class="line"></span><br><span class="line">keep_dropped_targets 控制这800个丢弃目标在内存中的保留数量</span><br><span class="line"></span><br><span class="line">💾 内存管理</span><br><span class="line"></span><br><span class="line">无限制 (默认):</span><br><span class="line"></span><br><span class="line">global:</span><br><span class="line">  keep_dropped_targets: 0  # 默认值，无限制</span><br><span class="line"></span><br><span class="line"># 所有被丢弃的目标都保留在内存中</span><br><span class="line"># 优点: relabeling规则变更时目标能快速恢复</span><br><span class="line"># 缺点: 内存占用可能很高</span><br><span class="line"></span><br><span class="line">有限制:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;kubernetes-pods&quot;</span><br><span class="line">    keep_dropped_targets: 1000  # 最多保留1000个丢弃目标</span><br><span class="line"></span><br><span class="line"># 超过限制的丢弃目标会从内存中清理</span><br><span class="line"># 优点: 节省内存</span><br><span class="line"># 缺点: 目标恢复需要重新发现</span><br><span class="line"></span><br><span class="line">🔧 实际应用场景</span><br><span class="line"></span><br><span class="line">1. Kubernetes 环境:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;kubernetes-pods&quot;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 只监控带有特定注解的pod</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        regex: &quot;true&quot;</span><br><span class="line">        action: keep</span><br><span class="line">    keep_dropped_targets: 5000  # 保留5000个被丢弃的pod信息</span><br><span class="line"></span><br><span class="line"># 场景: 集群中有大量pod，只有少数需要监控</span><br><span class="line"># 保留被丢弃的pod信息，当注解变更时能快速恢复监控</span><br><span class="line"></span><br><span class="line">2. 大规模服务发现:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;consul-services&quot;</span><br><span class="line">    consul_sd_configs:</span><br><span class="line">      - server: consul:8500</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 过滤不需要监控的服务</span><br><span class="line">      - source_labels: [__meta_consul_tags]</span><br><span class="line">        regex: &quot;.*,monitoring,.*&quot;</span><br><span class="line">        action: keep</span><br><span class="line">    keep_dropped_targets: 2000</span><br><span class="line"></span><br><span class="line"># 场景: Consul中有几千个服务，只有带monitoring标签的才监控</span><br><span class="line"></span><br><span class="line">3. 动态环境:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;dynamic-targets&quot;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&quot;/etc/prometheus/targets/*.yml&quot;]</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 根据环境变量过滤</span><br><span class="line">      - source_labels: [__meta_filesd_env]</span><br><span class="line">        regex: &quot;$&#123;ENVIRONMENT&#125;&quot;</span><br><span class="line">        action: keep</span><br><span class="line">    keep_dropped_targets: 1000</span><br><span class="line"></span><br><span class="line"># 场景: 目标经常变更，需要保留历史信息</span><br><span class="line"></span><br><span class="line">📊 内存使用对比</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line"></span><br><span class="line"># 场景: 发现10000个目标，relabeling后保留1000个</span><br><span class="line"># 被丢弃: 9000个目标</span><br><span class="line"></span><br><span class="line"># 配置1: 无限制 (默认)</span><br><span class="line">keep_dropped_targets: 0</span><br><span class="line"># 内存占用: ~9000个目标的元数据</span><br><span class="line"></span><br><span class="line"># 配置2: 有限制</span><br><span class="line">keep_dropped_targets: 1000</span><br><span class="line"># 内存占用: ~1000个目标的元数据 (节省90%内存)</span><br><span class="line"></span><br><span class="line">内存估算:</span><br><span class="line"></span><br><span class="line"># 每个丢弃目标的内存开销</span><br><span class="line"># 标签信息: ~200-500字节</span><br><span class="line"># 元数据: ~100-300字节</span><br><span class="line"># 总计: ~300-800字节/目标</span><br><span class="line"></span><br><span class="line"># 10000个丢弃目标 ≈ 3-8MB 内存</span><br><span class="line"># 1000个丢弃目标 ≈ 0.3-0.8MB 内存</span><br><span class="line"></span><br><span class="line">⚙️ 配置建议</span><br><span class="line"></span><br><span class="line">根据环境选择:</span><br><span class="line"></span><br><span class="line">🏭 生产环境:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;production-pods&quot;</span><br><span class="line">    keep_dropped_targets: 5000  # 平衡内存和恢复速度</span><br><span class="line"></span><br><span class="line">💾 资源受限环境:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;edge-devices&quot;</span><br><span class="line">    keep_dropped_targets: 500   # 严格限制内存使用</span><br><span class="line"></span><br><span class="line">🔬 开发环境:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;dev-services&quot;</span><br><span class="line">    keep_dropped_targets: 0     # 开发环境无限制</span><br><span class="line"></span><br><span class="line">根据目标类型选择:</span><br><span class="line"></span><br><span class="line">稳定目标:</span><br><span class="line"></span><br><span class="line"># 目标很少变更，可以设置较低限制</span><br><span class="line">keep_dropped_targets: 100</span><br><span class="line"></span><br><span class="line">动态目标:</span><br><span class="line"></span><br><span class="line"># 目标频繁变更，设置较高限制便于快速恢复</span><br><span class="line">keep_dropped_targets: 5000</span><br><span class="line"></span><br><span class="line">🔍 监控和调试</span><br><span class="line"></span><br><span class="line">监控内存使用:</span><br><span class="line"></span><br><span class="line"># 查看 Prometheus 内存使用</span><br><span class="line">curl http://localhost:9090/api/v1/series?match[]=process_resident_memory_bytes</span><br><span class="line"></span><br><span class="line"># 查看目标数量</span><br><span class="line">curl http://localhost:9090/api/v1/series?match[]=prometheus_sd_discovered_targets</span><br><span class="line"></span><br><span class="line">调整建议:</span><br><span class="line"></span><br><span class="line"># 1. 先运行观察内存使用</span><br><span class="line">keep_dropped_targets: 0</span><br><span class="line"></span><br><span class="line"># 2. 根据实际使用情况设置限制</span><br><span class="line">keep_dropped_targets: 2000</span><br><span class="line"></span><br><span class="line"># 3. 监控内存变化，继续调整</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 性能影响:</span><br><span class="line"></span><br><span class="line">- ✅ 限制较多: 节省内存，但目标恢复慢</span><br><span class="line">- ❌ 无限制: 内存占用高，但目标恢复快</span><br><span class="line">- ⚖️ 需要根据实际情况权衡</span><br><span class="line"></span><br><span class="line">2. 配置层级:</span><br><span class="line"></span><br><span class="line"># 这个参数通常在 scrape_config 级别设置</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;example&quot;</span><br><span class="line">    keep_dropped_targets: 1000  # 在这里设置</span><br><span class="line"></span><br><span class="line"># 而不是在 global 级别</span><br><span class="line">global:</span><br><span class="line">  # keep_dropped_targets: 1000  # ❌ 这样设置无效</span><br><span class="line"></span><br><span class="line">3. 与其他限制配合:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;kubernetes-pods&quot;</span><br><span class="line">    # 综合配置</span><br><span class="line">    target_limit: 5000              # 限制总目标数</span><br><span class="line">    sample_limit: 1000000           # 限制样本数</span><br><span class="line">    keep_dropped_targets: 2000      # 限制丢弃目标内存</span><br><span class="line"></span><br><span class="line">💡 最佳实践</span><br><span class="line"></span><br><span class="line">1. 渐进式调整:</span><br><span class="line"></span><br><span class="line"># 步骤1: 无限制运行观察</span><br><span class="line">keep_dropped_targets: 0</span><br><span class="line"></span><br><span class="line"># 步骤2: 根据内存使用设置限制</span><br><span class="line">keep_dropped_targets: 5000</span><br><span class="line"></span><br><span class="line"># 步骤3: 继续优化到合适值</span><br><span class="line">keep_dropped_targets: 2000</span><br><span class="line"></span><br><span class="line">2. 分级配置:</span><br><span class="line"></span><br><span class="line"># 根据job重要性分级</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;critical-services&quot;</span><br><span class="line">    keep_dropped_targets: 5000      # 重要服务，保留更多</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;debug-metrics&quot;</span><br><span class="line">    keep_dropped_targets: 100       # 调试指标，严格限制</span><br><span class="line"></span><br><span class="line">这个参数主要用于大规模服务发现环境中控制内存使用，特别是在 Kubernetes 或 Consul</span><br><span class="line">等环境中，当发现的目标数量远大于实际监控的目标数量时非常有用。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>metric_name_validation_scheme</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">⏺ 📖 参数含义</span><br><span class="line"></span><br><span class="line">  metric_name_validation_scheme - 指标名称验证方案</span><br><span class="line"></span><br><span class="line">  - 作用: 定义指标和标签名称的字符验证规则</span><br><span class="line">  - 默认值: &quot;utf8&quot;</span><br><span class="line">  - 选项: &quot;&quot; (空白)、&quot;utf8&quot;、&quot;legacy&quot;</span><br><span class="line"></span><br><span class="line">  🎯 三种验证方案对比</span><br><span class="line"></span><br><span class="line">  | 验证方案     | 默认值 | 支持字符         | Unicode支持 | 向后兼容   | 适用场景  |</span><br><span class="line">  |----------|-----|--------------|-----------|--------|-------|</span><br><span class="line">  | &quot;utf8&quot;   | ✅   | 所有UTF-8字符    | ✅ 完全支持    | ❌ 新标准  | 现代化环境 |</span><br><span class="line">  | &quot;legacy&quot; | ❌   | 字母、数字、冒号、下划线 | ❌ 仅ASCII  | ✅ 兼容旧版 | 保守环境  |</span><br><span class="line">  | &quot;&quot; (空白)  | ❌   | 同&quot;utf8&quot;      | ✅ 完全支持    | ❌ 新标准  | 同utf8 |</span><br><span class="line"></span><br><span class="line">  🔤 字符支持详解</span><br><span class="line"></span><br><span class="line">  UTF-8 方案 (&quot;utf8&quot;):</span><br><span class="line"></span><br><span class="line">  # ✅ 支持所有这些指标名</span><br><span class="line">  cpu_usage_核心      # 中文 + 下划线</span><br><span class="line">  métrique_française  # 法语字符</span><br><span class="line">  метрика_русская     # 俄语字符</span><br><span class="line">  メトリックス日本語    # 日语字符</span><br><span class="line">  📊_system_metrics    # Emoji字符</span><br><span class="line">  namespace/service:metric  # 斜杠、冒号组合</span><br><span class="line"></span><br><span class="line">  Legacy 方案 (&quot;legacy&quot;):</span><br><span class="line"></span><br><span class="line">  # ✅ 只支持这些</span><br><span class="line">  cpu_usage_total           # 字母 + 下划线</span><br><span class="line">  http_requests_total       # 字母 + 下划线</span><br><span class="line">  node_memory_available     # 字母 + 下划线</span><br><span class="line">  prometheus_sd_discovered   # 字母 + 下划线</span><br><span class="line">  duration:seconds_bucket   # 字母 + 冒号 + 下划线</span><br><span class="line"></span><br><span class="line">  # ❌ 不支持</span><br><span class="line">  cpu_usage_核心            # 中文字符</span><br><span class="line">  métrique_française         # 非ASCII字符</span><br><span class="line">  namespace/metric          # 斜杠</span><br><span class="line">  📊_system_metrics          # Emoji</span><br><span class="line"></span><br><span class="line">  🔧 配置示例</span><br><span class="line"></span><br><span class="line">  现代环境 (推荐):</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">  # 允许丰富的指标命名</span><br><span class="line">  # 支持国际化、特殊符号等</span><br><span class="line"></span><br><span class="line">  兼容环境:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line"></span><br><span class="line">  # 严格的字符限制</span><br><span class="line">  # 确保与旧版本兼容</span><br><span class="line"></span><br><span class="line">  默认行为:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    # 不设置，使用默认值</span><br><span class="line">    # 等同于:</span><br><span class="line">    metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">  🌍 国际化支持示例</span><br><span class="line"></span><br><span class="line">  中文指标名:</span><br><span class="line"></span><br><span class="line">  # UTF-8 模式下</span><br><span class="line">  # 指标导出</span><br><span class="line">  服务器_cpu使用率&#123;instance=&quot;host1&quot;&#125; 75.5</span><br><span class="line">  数据库连接池大小&#123;instance=&quot;db1&quot;&#125; 10</span><br><span class="line"></span><br><span class="line">  # 查询</span><br><span class="line">  rate(服务器_cpu使用率[5m])</span><br><span class="line"></span><br><span class="line">  多语言混合:</span><br><span class="line"></span><br><span class="line">  # 混合语言的指标</span><br><span class="line">  api_request_total           # 英文</span><br><span class="line">  métrique_latence_ms        # 法语</span><br><span class="line">  応答時間ミリ秒              # 日语</span><br><span class="line">  продолжительность_запроса   # 俄语</span><br><span class="line"></span><br><span class="line">  特殊字符:</span><br><span class="line"></span><br><span class="line">  # 支持各种特殊字符</span><br><span class="line">  http://server:8080/metrics_rate   # URL风格</span><br><span class="line">  service:instance:cpu_usage        # 层次结构</span><br><span class="line">  🚀_system_startup_time_seconds    # Emoji</span><br><span class="line"></span><br><span class="line">  ⚠️ 兼容性考虑</span><br><span class="line"></span><br><span class="line">  PromQL 查询兼容性:</span><br><span class="line"></span><br><span class="line">  # UTF-8 指标在 PromQL 中的使用</span><br><span class="line">  # ✅ 正确</span><br><span class="line">  rate(服务器_cpu使用率[5m])</span><br><span class="line"></span><br><span class="line">  # 可能需要转义的特殊字符</span><br><span class="line">  rate(http://server:8080/metrics_rate[5m])</span><br><span class="line">  # 或者使用标签过滤</span><br><span class="line">  rate(metrics_rate&#123;url=&quot;http://server:8080&quot;&#125;[5m])</span><br><span class="line"></span><br><span class="line">  系统集成影响:</span><br><span class="line"></span><br><span class="line">  # 影响的组件：</span><br><span class="line">  # 1. Prometheus Server (存储和查询)</span><br><span class="line">  # 2. Alertmanager (告警规则)</span><br><span class="line">  # 3. Grafana (可视化)</span><br><span class="line">  # 4. Remote Storage (远程存储)</span><br><span class="line">  # 5. Federated Prometheus (联邦)</span><br><span class="line"></span><br><span class="line">  🔄 迁移指南</span><br><span class="line"></span><br><span class="line">  从 Legacy 迁移到 UTF-8:</span><br><span class="line"></span><br><span class="line">  # 步骤1: 检查现有指标</span><br><span class="line">  # 运行 Prometheus 查看是否有不合规的指标</span><br><span class="line"></span><br><span class="line">  # 步骤2: 评估影响</span><br><span class="line">  # 检查下游系统是否支持 UTF-8 指标名</span><br><span class="line"></span><br><span class="line">  # 步骤3: 逐步迁移</span><br><span class="line">  global:</span><br><span class="line">    metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">  # 步骤4: 更新查询和仪表板</span><br><span class="line">  # 使用新的 UTF-8 指标名</span><br><span class="line"></span><br><span class="line">  从 UTF-8 回退到 Legacy:</span><br><span class="line"></span><br><span class="line">  # 如果遇到兼容性问题</span><br><span class="line">  global:</span><br><span class="line">    metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line"></span><br><span class="line">  # 需要修改指标导出器</span><br><span class="line">  # 使用 ASCII 字符重命名指标</span><br><span class="line"></span><br><span class="line">  📊 实际应用场景</span><br><span class="line"></span><br><span class="line">  1. 国际化团队:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">  # 团队可以使用母语命名指标</span><br><span class="line">  # 便于理解和维护</span><br><span class="line"></span><br><span class="line">  2. 微服务架构:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">  # 使用层次化的指标命名</span><br><span class="line">  service:user:api:request_total</span><br><span class="line">  service:payment:db:connection_pool</span><br><span class="line">  service:notification:email:queue_size</span><br><span class="line"></span><br><span class="line">  3. 云原生环境:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">  # 支持 Kubernetes 风格的标签</span><br><span class="line">  app.kubernetes.io/name: &quot;myapp&quot;</span><br><span class="line">  app.kubernetes.io/version: &quot;v1.2.3&quot;</span><br><span class="line"></span><br><span class="line">  🎯 选择建议</span><br><span class="line"></span><br><span class="line">  选择 UTF-8 当:</span><br><span class="line"></span><br><span class="line">  - ✅ 团队国际化，需要多语言支持</span><br><span class="line">  - ✅ 现代化监控系统</span><br><span class="line">  - ✅ 需要丰富的指标命名</span><br><span class="line">  - ✅ 下游系统支持 UTF-8</span><br><span class="line"></span><br><span class="line">  选择 Legacy 当:</span><br><span class="line"></span><br><span class="line">  - ✅ 需要与旧版本 Prometheus 兼容</span><br><span class="line">  - ✅ 下游系统不支持 UTF-8</span><br><span class="line">  - ✅ 保守的生产环境</span><br><span class="line">  - ✅ 只需要基础的 ASCII 字符</span><br><span class="line"></span><br><span class="line">  💡 你的配置分析</span><br><span class="line"></span><br><span class="line">  你的配置使用默认值：</span><br><span class="line">  global:</span><br><span class="line">    # metric_name_validation_scheme: &quot;utf8&quot; (默认)</span><br><span class="line"></span><br><span class="line">  这是很好的选择：</span><br><span class="line">  - ✅ 现代化: 支持完整的 UTF-8 字符集</span><br><span class="line">  - ✅ 国际化: 支持多语言指标命名</span><br><span class="line">  - ✅ 灵活性: 允许丰富的命名约定</span><br><span class="line">  - ✅ 未来兼容: 符合云原生监控的发展趋势</span><br><span class="line"></span><br><span class="line">  如果将来遇到兼容性问题，可以随时切换到 legacy 模式。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>convert_classic_histograms_to_nhcb + always_scrape_classic_histograms</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">⏺ 📊 Prometheus 直方图配置参数详解</span><br><span class="line"></span><br><span class="line">  这两个参数都与 Prometheus 的原生直方图功能相关。</span><br><span class="line"></span><br><span class="line">  🎯 1. convert_classic_histograms_to_nhcb - 经典直方图转换</span><br><span class="line"></span><br><span class="line">  含义:</span><br><span class="line">  - 将所有抓取的经典直方图转换为原生直方图</span><br><span class="line">  - NHCB = Native Histograms with Custom Buckets</span><br><span class="line">  - 需要启用原生直方图功能: --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: true   # 启用转换</span><br><span class="line">    # convert_classic_histograms_to_nhcb: false  # 默认值，不转换</span><br><span class="line"></span><br><span class="line">  转换效果:</span><br><span class="line"></span><br><span class="line">  # 经典直方图 (抓取前)</span><br><span class="line">  http_request_duration_seconds_bucket&#123;le=&quot;0.1&quot;&#125; 100</span><br><span class="line">  http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125; 300</span><br><span class="line">  http_request_duration_seconds_bucket&#123;le=&quot;1.0&quot;&#125; 450</span><br><span class="line">  http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125; 500</span><br><span class="line">  http_request_duration_seconds_sum 123.45</span><br><span class="line">  http_request_duration_seconds_count 500</span><br><span class="line"></span><br><span class="line">  # 转换为原生直方图 (存储后)</span><br><span class="line">  http_request_duration_seconds&#123;n=&quot;500&quot;,s=&quot;123.45&quot;,b=&quot;0.1,0.5,1.0&quot;&#125; 500</span><br><span class="line">  # 其中 b 是自定义桶边界</span><br><span class="line"></span><br><span class="line">  🔄 2. always_scrape_classic_histograms - 经典直方图抓取控制</span><br><span class="line"></span><br><span class="line">  含义:</span><br><span class="line">  - 控制是否同时抓取经典直方图和原生直方图</span><br><span class="line">  - 只有启用原生直方图功能时才有效</span><br><span class="line">  - 默认情况下，如果原生直方图可用，就不会抓取经典版本</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  global:</span><br><span class="line">    always_scrape_classic_histograms: true    # 同时抓取两种格式</span><br><span class="line">    # always_scrape_classic_histograms: false  # 默认值</span><br><span class="line"></span><br><span class="line">  🔧 配置组合效果</span><br><span class="line"></span><br><span class="line">  场景1: 默认配置</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    # 默认值</span><br><span class="line">    convert_classic_histograms_to_nhcb: false</span><br><span class="line">    always_scrape_classic_histograms: false</span><br><span class="line"></span><br><span class="line">  # 启动命令</span><br><span class="line">  ./prometheus --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line">  # 行为:</span><br><span class="line">  # - 优先抓取原生直方图</span><br><span class="line">  # - 如果没有原生直方图，抓取经典直方图</span><br><span class="line">  # - 不进行转换</span><br><span class="line"></span><br><span class="line">  场景2: 启用转换</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    always_scrape_classic_histograms: false</span><br><span class="line"></span><br><span class="line">  # 启动命令</span><br><span class="line">  ./prometheus --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line">  # 行为:</span><br><span class="line">  # - 抓取经典直方图</span><br><span class="line">  # - 自动转换为原生直方图存储</span><br><span class="line">  # - 不保留原始经典格式</span><br><span class="line"></span><br><span class="line">  场景3: 同时抓取两种格式</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: false</span><br><span class="line">    always_scrape_classic_histograms: true</span><br><span class="line"></span><br><span class="line">  # 启动命令</span><br><span class="line">  ./prometheus --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line">  # 行为:</span><br><span class="line">  # - 同时抓取原生直方图和经典直方图</span><br><span class="line">  # - 两种格式都存储</span><br><span class="line">  # - 占用更多存储空间</span><br><span class="line"></span><br><span class="line">  场景4: 完整兼容模式</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    always_scrape_classic_histograms: true</span><br><span class="line"></span><br><span class="line">  # 启动命令</span><br><span class="line">  ./prometheus --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line">  # 行为:</span><br><span class="line">  # - 同时抓取两种格式</span><br><span class="line">  # - 经典格式转换为原生格式存储</span><br><span class="line">  # - 最大兼容性，但存储开销最大</span><br><span class="line"></span><br><span class="line">  📊 直方图格式对比</span><br><span class="line"></span><br><span class="line">  | 特性   | 经典直方图  | 原生直方图  |</span><br><span class="line">  |------|--------|--------|</span><br><span class="line">  | 存储格式 | 多个时间序列 | 单一时间序列 |</span><br><span class="line">  | 桶边界  | 预定义    | 动态自适应  |</span><br><span class="line">  | 精度   | 受限于桶数量 | 更高精度   |</span><br><span class="line">  | 存储效率 | 较低     | 更高     |</span><br><span class="line">  | 查询性能 | 一般     | 更好     |</span><br><span class="line">  | 兼容性  | 广泛支持   | 较新功能   |</span><br><span class="line"></span><br><span class="line">  🎯 实际应用场景</span><br><span class="line"></span><br><span class="line">  1. 渐进式迁移:</span><br><span class="line"></span><br><span class="line">  # 步骤1: 启用原生直方图，保持经典兼容</span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    always_scrape_classic_histograms: false</span><br><span class="line"></span><br><span class="line">  # 步骤2: 逐步迁移到原生直方图</span><br><span class="line">  # 更新 exporters 支持原生直方图</span><br><span class="line"></span><br><span class="line">  # 步骤3: 完全使用原生直方图</span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: false</span><br><span class="line">    always_scrape_classic_histograms: false</span><br><span class="line"></span><br><span class="line">  2. 高精度监控:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line"></span><br><span class="line">  # 将现有的经典直方图转换为高精度的原生直方图</span><br><span class="line">  # 适用于需要精确延迟分析的场景</span><br><span class="line"></span><br><span class="line">  3. 兼容性优先:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    always_scrape_classic_histograms: true</span><br><span class="line"></span><br><span class="line">  # 确保下游工具能继续使用经典格式</span><br><span class="line">  # 适用于 Grafana 仪表板和告警规则依赖经典格式的情况</span><br><span class="line"></span><br><span class="line">  ⚠️ 重要注意事项</span><br><span class="line"></span><br><span class="line">  功能启用:</span><br><span class="line"></span><br><span class="line">  # 必须启用原生直方图功能</span><br><span class="line">  ./prometheus --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line">  # 否则这些配置无效</span><br><span class="line"></span><br><span class="line">  存储影响:</span><br><span class="line"></span><br><span class="line">  # 存储空间需求</span><br><span class="line">  # 经典直方图: 基准</span><br><span class="line">  # 原生直方图: 通常更节省空间</span><br><span class="line">  # 两种格式: 约双倍空间</span><br><span class="line"></span><br><span class="line">  查询兼容性:</span><br><span class="line"></span><br><span class="line">  # 查询语句可能需要调整</span><br><span class="line">  # 经典: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))</span><br><span class="line">  # 原生: histogram_quantile(0.95, rate(http_request_duration_seconds[5m]))</span><br><span class="line"></span><br><span class="line">  💡 配置建议</span><br><span class="line"></span><br><span class="line">  对于你的环境:</span><br><span class="line"></span><br><span class="line">  如果刚开始使用原生直方图:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    always_scrape_classic_histograms: false</span><br><span class="line"></span><br><span class="line">  # 启用转换，享受原生直方图的好处</span><br><span class="line"></span><br><span class="line">  如果需要最大兼容性:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: false</span><br><span class="line">    always_scrape_classic_histograms: true</span><br><span class="line"></span><br><span class="line">  # 同时支持两种格式，确保兼容性</span><br><span class="line"></span><br><span class="line">  如果追求最佳性能:</span><br><span class="line"></span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: false</span><br><span class="line">    always_scrape_classic_histograms: false</span><br><span class="line"></span><br><span class="line">  # 完全使用原生直方图，获得最佳性能</span><br><span class="line"></span><br><span class="line">  🚀 启用示例</span><br><span class="line"></span><br><span class="line">  # 1. 启动 Prometheus 时启用原生直方图</span><br><span class="line">  ./prometheus \</span><br><span class="line">    --config.file=prometheus.yml \</span><br><span class="line">    --enable-feature=native-histograms \</span><br><span class="line">    --storage.tsdb.path=data/</span><br><span class="line"></span><br><span class="line">  # 2. 配置文件中设置转换策略</span><br><span class="line">  global:</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    always_scrape_classic_histograms: false</span><br><span class="line"></span><br><span class="line">  这些参数主要用于从经典直方图向原生直方图迁移的过渡期，帮助用户平滑升级到新的直方图格式。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>gogc</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">gogc - Go 垃圾回收器参数</span><br><span class="line"></span><br><span class="line">- 作用: 配置 Go 运行时的垃圾回收器 GOGC 参数</span><br><span class="line">- 默认值: 75</span><br><span class="line">- 类型: &lt;int&gt; (整数)</span><br><span class="line">- 影响: 内存使用与 CPU 使用的平衡</span><br><span class="line"></span><br><span class="line">🎯 工作原理</span><br><span class="line"></span><br><span class="line">GOGC 参数含义:</span><br><span class="line"></span><br><span class="line">GOGC=75 表示：当新分配的内存达到上次回收后存活内存的 75% 时触发垃圾回收</span><br><span class="line"></span><br><span class="line">计算公式:</span><br><span class="line"></span><br><span class="line">// 触发条件</span><br><span class="line">新分配内存 &gt;= (上次GC后存活内存 * GOGC / 100)</span><br><span class="line"></span><br><span class="line">// 示例计算</span><br><span class="line">上次GC后存活内存 = 100MB</span><br><span class="line">GOGC = 75</span><br><span class="line">触发阈值 = 100MB * 75 / 100 = 75MB</span><br><span class="line">// 当新分配75MB内存时，触发下一次GC</span><br><span class="line"></span><br><span class="line">📊 不同设置的影响</span><br><span class="line"></span><br><span class="line">默认值 (75):</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 75  # 默认值</span><br><span class="line"></span><br><span class="line"># 特点:</span><br><span class="line"># - 平衡的内存和CPU使用</span><br><span class="line"># - 适合大多数工作负载</span><br><span class="line"># - Go 语言的推荐默认值</span><br><span class="line"></span><br><span class="line">较低值 (更频繁GC):</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 50  # 更频繁回收</span><br><span class="line"></span><br><span class="line"># 影响:</span><br><span class="line"># ✅ 内存占用更低</span><br><span class="line"># ✅ 内存压力更小</span><br><span class="line"># ❌ CPU 使用更高</span><br><span class="line"># ❌ GC 暂停更频繁</span><br><span class="line"></span><br><span class="line">较高值 (较少GC):</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 100  # 较少回收</span><br><span class="line"></span><br><span class="line"># 影响:</span><br><span class="line"># ✅ CPU 使用更低</span><br><span class="line"># ✅ GC 暂停更少</span><br><span class="line"># ❌ 内存占用更高</span><br><span class="line"># ❌ 可能出现内存峰值</span><br><span class="line"></span><br><span class="line">🔧 实际配置示例</span><br><span class="line"></span><br><span class="line">1. 内存敏感环境:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 50  # 更积极的GC，减少内存使用</span><br><span class="line"></span><br><span class="line"># 适用场景:</span><br><span class="line"># - 容器环境内存限制严格</span><br><span class="line"># - 内存成本较高的环境</span><br><span class="line"># - 需要稳定内存占用的应用</span><br><span class="line"></span><br><span class="line">2. CPU敏感环境:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 100  # 减少GC频率，节省CPU</span><br><span class="line"></span><br><span class="line"># 适用场景:</span><br><span class="line"># - CPU资源受限</span><br><span class="line"># - 需要低延迟的处理</span><br><span class="line"># - 内存充足的环境</span><br><span class="line"></span><br><span class="line">3. 高负载监控:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 25  # 非常积极的GC</span><br><span class="line"></span><br><span class="line"># 适用场景:</span><br><span class="line"># - 大量指标处理</span><br><span class="line"># - 需要严格控制内存</span><br><span class="line"># - 可以接受更高CPU使用</span><br><span class="line"></span><br><span class="line">4. 稳定性优先:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 200  # 非常保守的GC</span><br><span class="line"></span><br><span class="line"># 适用场景:</span><br><span class="line"># - 追求最低延迟</span><br><span class="line"># - 内存资源充足</span><br><span class="line"># - 对GC暂停敏感</span><br><span class="line"></span><br><span class="line">📈 性能对比表</span><br><span class="line"></span><br><span class="line">| GOGC 值 | 内存使用 | CPU 使用 | GC 频率 | 延迟  | 适用场景   |</span><br><span class="line">|--------|------|--------|-------|-----|--------|</span><br><span class="line">| 25     | 很低   | 很高     | 很高    | 较低  | 内存受限   |</span><br><span class="line">| 50     | 低    | 高      | 高     | 低   | 平衡偏内存  |</span><br><span class="line">| 75     | 中等   | 中等     | 中等    | 中等  | 默认推荐   |</span><br><span class="line">| 100    | 高    | 低      | 低     | 高   | 平衡偏CPU |</span><br><span class="line">| 200    | 很高   | 很低     | 很低    | 很高  | CPU受限  |</span><br><span class="line"></span><br><span class="line">🎯 Prometheus 特定考虑</span><br><span class="line"></span><br><span class="line">工作负载特征:</span><br><span class="line"></span><br><span class="line"># Prometheus 的内存使用模式:</span><br><span class="line"># 1. 大量时间序列数据</span><br><span class="line"># 2. 频繁的数据写入</span><br><span class="line"># 3. 查询时的临时内存分配</span><br><span class="line"># 4. 规则评估的内存需求</span><br><span class="line"></span><br><span class="line">推荐配置:</span><br><span class="line"></span><br><span class="line"># 根据部署规模调整</span><br><span class="line"></span><br><span class="line"># 小规模 ( &lt; 100万时间序列)</span><br><span class="line">runtime:</span><br><span class="line">  gogc: 75  # 默认值即可</span><br><span class="line"></span><br><span class="line"># 中规模 (100万-1000万时间序列)</span><br><span class="line">runtime:</span><br><span class="line">  gogc: 50  # 稍微积极一些</span><br><span class="line"></span><br><span class="line"># 大规模 ( &gt; 1000万时间序列)</span><br><span class="line">runtime:</span><br><span class="line">  gogc: 25  # 更积极的GC控制</span><br><span class="line"></span><br><span class="line">🔍 监控和调优</span><br><span class="line"></span><br><span class="line">监控 GC 指标:</span><br><span class="line"></span><br><span class="line"># 查看 Prometheus 自身的 GC 指标</span><br><span class="line">curl http://localhost:9090/metrics | grep gc</span><br><span class="line"></span><br><span class="line"># 相关指标:</span><br><span class="line"># go_gc_duration_seconds - GC 耗时</span><br><span class="line"># go_memstats_heap_alloc_bytes - 堆内存分配</span><br><span class="line"># go_memstats_next_gc_bytes - 下次GC触发阈值</span><br><span class="line"></span><br><span class="line">调优流程:</span><br><span class="line"></span><br><span class="line"># 步骤1: 监控当前GC行为</span><br><span class="line"># 观察 go_gc_duration_seconds 和内存使用模式</span><br><span class="line"></span><br><span class="line"># 步骤2: 设置初始值</span><br><span class="line">runtime:</span><br><span class="line">  gogc: 50</span><br><span class="line"></span><br><span class="line"># 步骤3: 监控效果</span><br><span class="line"># 观察CPU和内存使用变化</span><br><span class="line"></span><br><span class="line"># 步骤4: 根据结果调整</span><br><span class="line"># 根据实际需求微调 gogc 值</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 平衡权衡:</span><br><span class="line"></span><br><span class="line"># 没有完美的值，需要权衡:</span><br><span class="line"># - 内存使用 vs CPU 使用</span><br><span class="line"># - GC频率 vs 暂停时间</span><br><span class="line"># - 稳定性 vs 性能</span><br><span class="line"></span><br><span class="line">2. 环境差异:</span><br><span class="line"></span><br><span class="line"># 不同环境可能需要不同设置</span><br><span class="line"># - 物理机 vs 容器</span><br><span class="line"># - 内存充足 vs 内存受限</span><br><span class="line"># - 高负载 vs 低负载</span><br><span class="line"></span><br><span class="line">3. 监控影响:</span><br><span class="line"></span><br><span class="line"># 调整后需要监控:</span><br><span class="line"># - 内存使用模式</span><br><span class="line"># - CPU 使用率</span><br><span class="line"># - GC 暂停时间</span><br><span class="line"># - 查询性能</span><br><span class="line"></span><br><span class="line">💡 配置建议</span><br><span class="line"></span><br><span class="line">生产环境:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 50  # 稍微保守一些，控制内存使用</span><br><span class="line"></span><br><span class="line">开发环境:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 100  # 可以更宽松，减少GC干扰</span><br><span class="line"></span><br><span class="line">容器环境:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 25  # 容器内存限制通常较严格</span><br><span class="line"></span><br><span class="line">资源充足环境:</span><br><span class="line"></span><br><span class="line">runtime:</span><br><span class="line">  gogc: 100  # 内存充足时优先考虑性能</span><br><span class="line"></span><br><span class="line">🎯 实际应用</span><br><span class="line"></span><br><span class="line">你的配置使用默认值：</span><br><span class="line"># runtime 部分通常不显式配置</span><br><span class="line"># 使用默认的 gogc: 75</span><br><span class="line"></span><br><span class="line">这是一个合理的默认设置：</span><br><span class="line">- ✅ 平衡性好: 适合大多数场景</span><br><span class="line">- ✅ 稳定可靠: Go 官方推荐的默认值</span><br><span class="line">- ✅ 易于维护: 不需要特殊调优</span><br><span class="line"></span><br><span class="line">如果遇到内存压力或性能问题，可以考虑调整这个参数。通常建议先从 50 开始尝试，然后根据实际效果进一步调整。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>rule_files</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line">rule_files - 规则文件配置</span><br><span class="line"></span><br><span class="line">- 作用: 指定包含告警规则和录制规则的文件路径</span><br><span class="line">- 格式: 文件路径列表，支持 glob 模式匹配</span><br><span class="line">- 内容: 从所有匹配的文件中读取规则和告警</span><br><span class="line"></span><br><span class="line">🔧 基础配置</span><br><span class="line"></span><br><span class="line">简单配置:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;prometheus.rules.yml&quot;</span><br><span class="line">  - &quot;alerts.yml&quot;</span><br><span class="line"></span><br><span class="line">你的配置:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;prometheus.rules.yml&quot;</span><br><span class="line"></span><br><span class="line">Glob 模式匹配:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/*.yml&quot;           # rules目录下所有.yml文件</span><br><span class="line">  - &quot;alerts/**/*.yaml&quot;       # alerts目录及子目录下所有.yaml文件</span><br><span class="line">  - &quot;/etc/prometheus/rules.d/*.rules&quot;  # 系统配置目录</span><br><span class="line"></span><br><span class="line">📋 规则文件内容</span><br><span class="line"></span><br><span class="line">录制规则 (Recording Rules):</span><br><span class="line"></span><br><span class="line"># prometheus.rules.yml</span><br><span class="line">groups:</span><br><span class="line">  - name: recording_rules</span><br><span class="line">    interval: 30s  # 评估间隔，可选</span><br><span class="line">    rules:</span><br><span class="line">      - record: job:http_requests:rate5m</span><br><span class="line">        expr: rate(http_requests_total[5m])</span><br><span class="line"></span><br><span class="line">      - record: job:http_requests:rate5m:sum</span><br><span class="line">        expr: sum(rate(http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line">告警规则 (Alerting Rules):</span><br><span class="line"></span><br><span class="line"># prometheus.rules.yml</span><br><span class="line">groups:</span><br><span class="line">  - name: alert_rules</span><br><span class="line">    rules:</span><br><span class="line">      - alert: HighCPUUsage</span><br><span class="line">        expr: cpu_usage &gt; 80</span><br><span class="line">        for: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;CPU usage is above 80%&quot;</span><br><span class="line">          description: &quot;CPU usage has been above 80% for more than 5 minutes&quot;</span><br><span class="line"></span><br><span class="line">🎯 完整规则文件示例</span><br><span class="line"></span><br><span class="line">综合规则文件:</span><br><span class="line"></span><br><span class="line"># prometheus.rules.yml</span><br><span class="line">groups:</span><br><span class="line">  # 录制规则组</span><br><span class="line">  - name: performance_metrics</span><br><span class="line">    interval: 15s</span><br><span class="line">    rules:</span><br><span class="line">      - record: instance:cpu_usage:rate5m</span><br><span class="line">        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) * 100)</span><br><span class="line"></span><br><span class="line">      - record: instance:memory_usage:rate5m</span><br><span class="line">        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100</span><br><span class="line"></span><br><span class="line">  # 告警规则组</span><br><span class="line">  - name: system_alerts</span><br><span class="line">    rules:</span><br><span class="line">      - alert: InstanceDown</span><br><span class="line">        expr: up == 0</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; is down&quot;</span><br><span class="line">          description: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; has been down for more than 1 minute&quot;</span><br><span class="line"></span><br><span class="line">      - alert: HighCPUUsage</span><br><span class="line">        expr: instance:cpu_usage:rate5m &gt; 80</span><br><span class="line">        for: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;High CPU usage on &#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">          description: &quot;CPU usage is &#123;&#123; $value &#125;&#125;% on instance &#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">📁 文件组织策略</span><br><span class="line"></span><br><span class="line">按功能分类:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/system.yml&quot;       # 系统监控规则</span><br><span class="line">  - &quot;rules/application.yml&quot;  # 应用监控规则</span><br><span class="line">  - &quot;rules/network.yml&quot;      # 网络监控规则</span><br><span class="line">  - &quot;alerts/critical.yml&quot;    # 严重告警</span><br><span class="line">  - &quot;alerts/warning.yml&quot;     # 警告告警</span><br><span class="line"></span><br><span class="line">按环境分类:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/common.yml&quot;       # 通用规则</span><br><span class="line">  - &quot;rules/production.yml&quot;  # 生产环境规则</span><br><span class="line">  - &quot;rules/staging.yml&quot;      # 测试环境规则</span><br><span class="line">  - &quot;rules/development.yml&quot; # 开发环境规则</span><br><span class="line"></span><br><span class="line">按团队分类:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/platform.yml&quot;     # 平台团队</span><br><span class="line">  - &quot;rules/application.yml&quot;  # 应用团队</span><br><span class="line">  - &quot;rules/security.yml&quot;     # 安全团队</span><br><span class="line">  - &quot;rules/network.yml&quot;      # 网络团队</span><br><span class="line"></span><br><span class="line">🔍 Glob 模式详解</span><br><span class="line"></span><br><span class="line">常用模式:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  # 基础模式</span><br><span class="line">  - &quot;rules.yml&quot;                    # 单个文件</span><br><span class="line">  - &quot;rules/*.yml&quot;                  # rules目录下所有.yml文件</span><br><span class="line">  - &quot;rules/**/*.yml&quot;               # rules目录及子目录下所有.yml文件</span><br><span class="line"></span><br><span class="line">  # 高级模式</span><br><span class="line">  - &quot;/etc/prometheus/rules/*.yml&quot;   # 绝对路径</span><br><span class="line">  - &quot;rules/*-rules.yml&quot;            # 匹配特定命名模式</span><br><span class="line">  - &quot;rules/[a-z]*.yml&quot;             # 正则表达式模式</span><br><span class="line"></span><br><span class="line">多文件合并:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/base.yml&quot;       # 基础规则</span><br><span class="line">  - &quot;rules/custom/*.yml&quot;   # 自定义规则</span><br><span class="line">  - &quot;rules/overrides/*.yml&quot; # 覆盖规则</span><br><span class="line"></span><br><span class="line"># Prometheus 会按顺序加载所有文件</span><br><span class="line"># 后加载的规则会覆盖同名的录制规则</span><br><span class="line"></span><br><span class="line">⚙️ 实际配置示例</span><br><span class="line"></span><br><span class="line">小型环境:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;prometheus.rules.yml&quot;</span><br><span class="line"></span><br><span class="line">中型环境:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/system.yml&quot;</span><br><span class="line">  - &quot;rules/application.yml&quot;</span><br><span class="line">  - &quot;alerts/common.yml&quot;</span><br><span class="line"></span><br><span class="line">大型环境:</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/infrastructure/*.yml&quot;</span><br><span class="line">  - &quot;rules/applications/*.yml&quot;</span><br><span class="line">  - &quot;rules/security/*.yml&quot;</span><br><span class="line">  - &quot;alerts/critical/*.yml&quot;</span><br><span class="line">  - &quot;alerts/warning/*.yml&quot;</span><br><span class="line">  - &quot;overrides/production/*.yml&quot;</span><br><span class="line"></span><br><span class="line">🔧 文件热重载</span><br><span class="line"></span><br><span class="line">重载触发:</span><br><span class="line"></span><br><span class="line"># 发送 SIGHUP 信号重载配置</span><br><span class="line">kill -HUP $(pidof prometheus)</span><br><span class="line"></span><br><span class="line"># 或者使用 HTTP API</span><br><span class="line">curl -X POST http://localhost:9090/-/reload</span><br><span class="line"></span><br><span class="line">重载行为:</span><br><span class="line"></span><br><span class="line"># 重载时会:</span><br><span class="line"># 1. 重新解析所有规则文件</span><br><span class="line"># 2. 验证规则语法</span><br><span class="line"># 3. 更新内存中的规则</span><br><span class="line"># 4. 不影响正在运行的抓取</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 文件路径:</span><br><span class="line"></span><br><span class="line"># ✅ 相对路径 (相对于配置文件目录)</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/*.yml&quot;</span><br><span class="line"></span><br><span class="line"># ✅ 绝对路径</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;/etc/prometheus/rules/*.yml&quot;</span><br><span class="line"></span><br><span class="line"># ❌ 不存在的文件会导致启动失败</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;nonexistent.yml&quot;</span><br><span class="line"></span><br><span class="line">2. 文件格式:</span><br><span class="line"></span><br><span class="line"># 支持 YAML 和 YAML 格式</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules.yml&quot;    # ✅</span><br><span class="line">  - &quot;rules.yaml&quot;   # ✅</span><br><span class="line">  - &quot;rules.json&quot;   # ❌ 不支持</span><br><span class="line"></span><br><span class="line">3. 规则验证:</span><br><span class="line"></span><br><span class="line"># 使用 promtool 验证规则文件</span><br><span class="line">promtool check rules prometheus.rules.yml</span><br><span class="line"></span><br><span class="line"># 验证多个文件</span><br><span class="line">promtool check rules rules/*.yml</span><br><span class="line"></span><br><span class="line">4. 性能考虑:</span><br><span class="line"></span><br><span class="line"># 避免过多的小文件</span><br><span class="line"># ❌ 不推荐</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/001.yml&quot;</span><br><span class="line">  - &quot;rules/002.yml&quot;</span><br><span class="line">  - ...</span><br><span class="line">  - &quot;rules/100.yml&quot;</span><br><span class="line"></span><br><span class="line"># ✅ 推荐</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/system.yml&quot;</span><br><span class="line">  - &quot;rules/application.yml&quot;</span><br><span class="line"></span><br><span class="line">💡 最佳实践</span><br><span class="line"></span><br><span class="line">1. 文件命名规范:</span><br><span class="line"></span><br><span class="line"># 推荐的命名方式</span><br><span class="line">rules-system.yml</span><br><span class="line">rules-application.yml</span><br><span class="line">alerts-critical.yml</span><br><span class="line">overrides-production.yml</span><br><span class="line"></span><br><span class="line">2. 规则组织:</span><br><span class="line"></span><br><span class="line"># 按逻辑分组，不要把所有规则放在一个文件中</span><br><span class="line"># 每个文件专注一个领域</span><br><span class="line"># 定期清理不使用的规则</span><br><span class="line"></span><br><span class="line">3. 版本控制:</span><br><span class="line"></span><br><span class="line"># 将规则文件纳入版本控制</span><br><span class="line">git add rules/</span><br><span class="line">git commit -m &quot;Add new alert rules&quot;</span><br><span class="line"></span><br><span class="line">4. 测试验证:</span><br><span class="line"></span><br><span class="line"># 在部署前测试规则</span><br><span class="line">promtool check rules rules/*.yml</span><br><span class="line"></span><br><span class="line"># 测试告警表达式</span><br><span class="line">promtool query instant &#x27;up == 0&#x27;</span><br><span class="line"></span><br><span class="line">🎯 你的配置分析</span><br><span class="line"></span><br><span class="line">你的配置：</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;prometheus.rules.yml&quot;</span><br><span class="line"></span><br><span class="line">这是一个简洁的配置：</span><br><span class="line">- ✅ 简单明了: 单个文件包含所有规则</span><br><span class="line">- ✅ 易于管理: 规则集中在一个文件中</span><br><span class="line">- ✅ 适合小规模: 对于中小型部署很合适</span><br><span class="line"></span><br><span class="line">如果将来规则增多，可以考虑拆分为多个文件按功能分类管理。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>scrape_config_files + scrape_configs</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line">1. scrape_config_files - 抓取配置文件</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 指定包含抓取配置的外部文件路径</span><br><span class="line">- 支持 glob 模式匹配</span><br><span class="line">- 从匹配文件中读取抓取配置并追加到主配置中</span><br><span class="line"></span><br><span class="line">用途:</span><br><span class="line">- 🔧 模块化配置管理</span><br><span class="line">- 🔄 动态配置更新</span><br><span class="line">- 🏗️ 配置文件分离</span><br><span class="line"></span><br><span class="line">2. scrape_configs - 抓取配置列表</span><br><span class="line"></span><br><span class="line">含义:</span><br><span class="line">- 直接在主配置文件中定义抓取配置</span><br><span class="line">- 包含所有监控目标的抓取设置</span><br><span class="line">- 主要的监控配置部分</span><br><span class="line"></span><br><span class="line">🔧 配置方式对比</span><br><span class="line"></span><br><span class="line">直接配置 (scrape_configs):</span><br><span class="line"></span><br><span class="line"># prometheus.yml - 传统方式</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;node&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9100&quot;]</span><br><span class="line"></span><br><span class="line">外部文件配置 (scrape_config_files):</span><br><span class="line"></span><br><span class="line"># prometheus.yml - 主配置文件</span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/*.yml&quot;</span><br><span class="line">  - &quot;/etc/prometheus/scrape-configs.d/*.yaml&quot;</span><br><span class="line"></span><br><span class="line"># configs/prometheus.yml - 外部文件</span><br><span class="line">- job_name: &quot;prometheus&quot;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line"># configs/node.yml - 外部文件</span><br><span class="line">- job_name: &quot;node&quot;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&quot;localhost:9100&quot;]</span><br><span class="line"></span><br><span class="line">🎯 混合使用示例</span><br><span class="line"></span><br><span class="line">主配置 + 外部文件:</span><br><span class="line"></span><br><span class="line"># prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  evaluation_interval: 1m</span><br><span class="line"></span><br><span class="line"># 核心配置在主文件中</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line"># 其他配置从外部文件加载</span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/services/*.yml&quot;</span><br><span class="line">  - &quot;configs/infrastructure/*.yml&quot;</span><br><span class="line"></span><br><span class="line">📁 文件组织策略</span><br><span class="line"></span><br><span class="line">按环境分类:</span><br><span class="line"></span><br><span class="line"># prometheus.yml</span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/common/*.yml&quot;       # 通用配置</span><br><span class="line">  - &quot;configs/production/*.yml&quot;  # 生产环境</span><br><span class="line">  - &quot;configs/staging/*.yml&quot;      # 测试环境</span><br><span class="line"></span><br><span class="line">按业务分类:</span><br><span class="line"></span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/infrastructure/*.yml&quot;   # 基础设施</span><br><span class="line">  - &quot;configs/applications/*.yml&quot;     # 应用服务</span><br><span class="line">  - &quot;configs/monitoring/*.yml&quot;       # 监控系统</span><br><span class="line">  - &quot;configs/security/*.yml&quot;         # 安全监控</span><br><span class="line"></span><br><span class="line">按团队分类:</span><br><span class="line"></span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/platform/*.yml&quot;        # 平台团队</span><br><span class="line">  - &quot;configs/backend/*.yml&quot;         # 后端团队</span><br><span class="line">  - &quot;configs/frontend/*.yml&quot;        # 前端团队</span><br><span class="line">  - &quot;configs/data/*.yml&quot;            # 数据团队</span><br><span class="line"></span><br><span class="line">🔧 实际配置示例</span><br><span class="line"></span><br><span class="line">1. 基础示例:</span><br><span class="line"></span><br><span class="line"># prometheus.yml</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;prometheus&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;node-exporter.yml&quot;</span><br><span class="line">  - &quot;app-metrics.yml&quot;</span><br><span class="line"></span><br><span class="line">2. Kubernetes 环境:</span><br><span class="line"></span><br><span class="line"># prometheus.yml</span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/kubernetes/*.yml&quot;</span><br><span class="line">  - &quot;configs/services/*.yml&quot;</span><br><span class="line">  - &quot;configs/infrastructure/*.yml&quot;</span><br><span class="line"></span><br><span class="line"># configs/kubernetes/pods.yml</span><br><span class="line">- job_name: &quot;kubernetes-pods&quot;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: true</span><br><span class="line"></span><br><span class="line">3. 动态配置管理:</span><br><span class="line"></span><br><span class="line"># prometheus.yml</span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/active/*.yml&quot;      # 当前激活的配置</span><br><span class="line">  - &quot;configs/templates/*.yml&quot;   # 配置模板</span><br><span class="line"></span><br><span class="line"># 可以通过脚本动态更新配置文件</span><br><span class="line"># 然后重载 Prometheus</span><br><span class="line"></span><br><span class="line">🔄 配置更新机制</span><br><span class="line"></span><br><span class="line">文件内容合并:</span><br><span class="line"></span><br><span class="line"># prometheus.yml</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;core&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line"></span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/services/*.yml&quot;</span><br><span class="line"></span><br><span class="line"># configs/services/web.yml</span><br><span class="line">- job_name: &quot;web&quot;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&quot;web1:8080&quot;, &quot;web2:8080&quot;]</span><br><span class="line"></span><br><span class="line"># 最终效果等同于：</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;core&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9090&quot;]</span><br><span class="line">  - job_name: &quot;web&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;web1:8080&quot;, &quot;web2:8080&quot;]</span><br><span class="line"></span><br><span class="line">热重载支持:</span><br><span class="line"></span><br><span class="line"># 重载配置 (包括外部文件)</span><br><span class="line">curl -X POST http://localhost:9090/-/reload</span><br><span class="line"></span><br><span class="line"># 或者发送信号</span><br><span class="line">kill -HUP $(pidof prometheus)</span><br><span class="line"></span><br><span class="line">🎯 使用场景</span><br><span class="line"></span><br><span class="line">1. 配置分离:</span><br><span class="line"></span><br><span class="line"># 将配置按模块分离，便于管理</span><br><span class="line"># 不同团队负责各自的配置文件</span><br><span class="line"># 减少主配置文件的复杂度</span><br><span class="line"></span><br><span class="line">2. 动态配置:</span><br><span class="line"></span><br><span class="line"># 通过自动化脚本动态生成配置</span><br><span class="line"># 支持基于服务发现的配置生成</span><br><span class="line"># 便于 CI/CD 集成</span><br><span class="line"></span><br><span class="line">3. 环境隔离:</span><br><span class="line"></span><br><span class="line"># 不同环境使用不同的配置文件</span><br><span class="line"># 主配置保持一致，只替换特定部分</span><br><span class="line"># 支持配置模板化</span><br><span class="line"></span><br><span class="line">📊 文件结构示例</span><br><span class="line"></span><br><span class="line">/etc/prometheus/</span><br><span class="line">├── prometheus.yml              # 主配置文件</span><br><span class="line">├── configs/</span><br><span class="line">│   ├── infrastructure/</span><br><span class="line">│   │   ├── node-exporter.yml</span><br><span class="line">│   │   ├── cadvisor.yml</span><br><span class="line">│   │   └── blackbox-exporter.yml</span><br><span class="line">│   ├── applications/</span><br><span class="line">│   │   ├── web-servers.yml</span><br><span class="line">│   │   ├── api-servers.yml</span><br><span class="line">│   │   └── databases.yml</span><br><span class="line">│   └── monitoring/</span><br><span class="line">│       ├── alertmanager.yml</span><br><span class="line">│       └── prometheus.yml</span><br><span class="line">└── templates/</span><br><span class="line">    ├── job-template.yml</span><br><span class="line">    └── service-template.yml</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 文件格式:</span><br><span class="line"></span><br><span class="line"># 外部文件只包含抓取配置，不是完整的 Prometheus 配置</span><br><span class="line"># ✅ 正确格式</span><br><span class="line">- job_name: &quot;example&quot;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&quot;host:port&quot;]</span><br><span class="line"></span><br><span class="line"># ❌ 错误格式</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &quot;example&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;host:port&quot;]</span><br><span class="line"></span><br><span class="line">2. 文件路径:</span><br><span class="line"></span><br><span class="line"># 支持相对路径和绝对路径</span><br><span class="line">scrape_config_files:</span><br><span class="line">  - &quot;configs/*.yml&quot;                    # 相对路径</span><br><span class="line">  - &quot;/etc/prometheus/configs/*.yml&quot;    # 绝对路径</span><br><span class="line"></span><br><span class="line">3. 重复配置:</span><br><span class="line"></span><br><span class="line"># 如果出现重复的 job_name，后加载的会覆盖先加载的</span><br><span class="line"># 建议确保 job_name 的唯一性</span><br><span class="line"></span><br><span class="line">💡 最佳实践</span><br><span class="line"></span><br><span class="line">1. 配置管理:</span><br><span class="line"></span><br><span class="line"># 使用版本控制管理所有配置文件</span><br><span class="line"># 建立配置文件的命名规范</span><br><span class="line"># 定期清理不使用的配置</span><br><span class="line"></span><br><span class="line">2. 文件验证:</span><br><span class="line"></span><br><span class="line"># 验证配置文件语法</span><br><span class="line">promtool check config prometheus.yml</span><br><span class="line"></span><br><span class="line"># 测试配置文件</span><br><span class="line">promtool config check prometheus.yml</span><br><span class="line"></span><br><span class="line">3. 自动化:</span><br><span class="line"></span><br><span class="line"># 使用脚本自动生成配置</span><br><span class="line"># 结合服务发现动态更新</span><br><span class="line"># 集成到 CI/CD 流程</span><br><span class="line"></span><br><span class="line">🎯 选择建议</span><br><span class="line"></span><br><span class="line">使用 scrape_configs 当:</span><br><span class="line"></span><br><span class="line">- ✅ 配置简单且固定</span><br><span class="line">- ✅ 小规模部署</span><br><span class="line">- ✅ 不需要频繁变更</span><br><span class="line"></span><br><span class="line">使用 scrape_config_files 当:</span><br><span class="line"></span><br><span class="line">- ✅ 配置需要模块化管理</span><br><span class="line">- ✅ 大规模部署</span><br><span class="line">- ✅ 需要动态更新配置</span><br><span class="line">- ✅ 多团队协作</span><br><span class="line"></span><br><span class="line">这种配置方式让 Prometheus 的配置管理更加灵活和可扩展，特别适合复杂的生产环境。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>alerting</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line">alerting - 告警配置</span><br><span class="line"></span><br><span class="line">用于配置 Prometheus 如何与 Alertmanager 通信，包括告警重标签和 Alertmanager 实例设置。</span><br><span class="line"></span><br><span class="line">🎯 配置结构解析</span><br><span class="line"></span><br><span class="line">完整配置示例:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  # 告警重标签配置</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    - source_labels: [alertname]</span><br><span class="line">      regex: &quot;HighMemoryUsage&quot;</span><br><span class="line">      target_label: severity</span><br><span class="line">      replacement: &quot;warning&quot;</span><br><span class="line"></span><br><span class="line">  # Alertmanager 实例配置</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;localhost:9093&quot;]</span><br><span class="line"></span><br><span class="line">🏷️ alert_relabel_configs - 告警重标签</span><br><span class="line"></span><br><span class="line">作用: 在发送告警到 Alertmanager 之前，对告警标签进行重写</span><br><span class="line"></span><br><span class="line">常用重标签操作:</span><br><span class="line"></span><br><span class="line">1. 添加/修改标签:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 添加环境标签</span><br><span class="line">    - target_label: environment</span><br><span class="line">      replacement: &quot;production&quot;</span><br><span class="line"></span><br><span class="line">    # 修改严重级别</span><br><span class="line">    - source_labels: [alertname]</span><br><span class="line">      regex: &quot;High.*&quot;</span><br><span class="line">      target_label: severity</span><br><span class="line">      replacement: &quot;warning&quot;</span><br><span class="line"></span><br><span class="line">2. 过滤告警:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 只发送特定告警</span><br><span class="line">    - source_labels: [alertname]</span><br><span class="line">      regex: &quot;CriticalError|ServiceDown&quot;</span><br><span class="line">      action: keep</span><br><span class="line"></span><br><span class="line">    # 丢弃某些告警</span><br><span class="line">    - source_labels: [alertname]</span><br><span class="line">      regex: &quot;Debug.*&quot;</span><br><span class="line">      action: drop</span><br><span class="line"></span><br><span class="line">3. 标签标准化:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 标准化集群名称</span><br><span class="line">    - source_labels: [cluster]</span><br><span class="line">      regex: &quot;prod-(.*)&quot;</span><br><span class="line">      target_label: cluster</span><br><span class="line">      replacement: &quot;$1&quot;</span><br><span class="line"></span><br><span class="line">    # 添加统一标签</span><br><span class="line">    - source_labels: [job]</span><br><span class="line">      target_label: service</span><br><span class="line">      replacement: &quot;$1&quot;</span><br><span class="line"></span><br><span class="line">📡 alertmanagers - Alertmanager 配置</span><br><span class="line"></span><br><span class="line">静态配置:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          - &quot;alertmanager1:9093&quot;</span><br><span class="line">          - &quot;alertmanager2:9093&quot;</span><br><span class="line">      labels:</span><br><span class="line">        dc: &quot;us-west&quot;</span><br><span class="line"></span><br><span class="line">服务发现配置:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    # Kubernetes 服务发现</span><br><span class="line">    - kubernetes_sd_configs:</span><br><span class="line">        - role: endpoints</span><br><span class="line">          namespaces:</span><br><span class="line">            names:</span><br><span class="line">              - monitoring</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">          regex: &quot;alertmanager&quot;</span><br><span class="line">          action: keep</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpoint_port_name]</span><br><span class="line">          regex: &quot;web&quot;</span><br><span class="line">          action: keep</span><br><span class="line"></span><br><span class="line">    # Consul 服务发现</span><br><span class="line">    - consul_sd_configs:</span><br><span class="line">        - server: consul:8500</span><br><span class="line">          services: [&quot;alertmanager&quot;]</span><br><span class="line"></span><br><span class="line">🔧 完整配置示例</span><br><span class="line"></span><br><span class="line">1. 基础配置:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;localhost:9093&quot;]</span><br><span class="line"></span><br><span class="line">2. 高可用配置:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          - &quot;alertmanager-1:9093&quot;</span><br><span class="line">          - &quot;alertmanager-2:9093&quot;</span><br><span class="line">          - &quot;alertmanager-3:9093&quot;</span><br><span class="line">      labels:</span><br><span class="line">        cluster: &quot;production&quot;</span><br><span class="line"></span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 添加集群信息</span><br><span class="line">    - target_label: cluster</span><br><span class="line">      replacement: &quot;prod-cluster&quot;</span><br><span class="line"></span><br><span class="line">    # 标准化告警名称</span><br><span class="line">    - source_labels: [alertname]</span><br><span class="line">      regex: &quot;(.*)Alert&quot;</span><br><span class="line">      target_label: alertname</span><br><span class="line">      replacement: &quot;$1&quot;</span><br><span class="line"></span><br><span class="line">3. 环境分离配置:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 添加环境标签</span><br><span class="line">    - target_label: environment</span><br><span class="line">      replacement: &quot;$&#123;ENVIRONMENT&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 添加源标签</span><br><span class="line">    - target_label: prometheus_source</span><br><span class="line">      replacement: &quot;$&#123;HOSTNAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 过滤调试告警</span><br><span class="line">    - source_labels: [alertname]</span><br><span class="line">      regex: &quot;Debug.*&quot;</span><br><span class="line">      action: drop</span><br><span class="line"></span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;alertmanager-$&#123;ENVIRONMENT&#125;:9093&quot;]</span><br><span class="line"></span><br><span class="line">4. Kubernetes 集群配置:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 添加命名空间标签</span><br><span class="line">    - source_labels: [namespace]</span><br><span class="line">      target_label: k8s_namespace</span><br><span class="line"></span><br><span class="line">    # 添加集群标签</span><br><span class="line">    - target_label: k8s_cluster</span><br><span class="line">      replacement: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 标准化服务标签</span><br><span class="line">    - source_labels: [pod]</span><br><span class="line">      regex: &quot;(.*)-[0-9a-z]+-[0-9a-z]+&quot;</span><br><span class="line">      target_label: service</span><br><span class="line">      replacement: &quot;$1&quot;</span><br><span class="line"></span><br><span class="line">  alertmanagers:</span><br><span class="line">    - kubernetes_sd_configs:</span><br><span class="line">        - role: endpoints</span><br><span class="line">          namespaces:</span><br><span class="line">            names:</span><br><span class="line">              - monitoring</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">          regex: &quot;alertmanager&quot;</span><br><span class="line">          action: keep</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpoint_port_name]</span><br><span class="line">          regex: &quot;web&quot;</span><br><span class="line">          action: keep</span><br><span class="line">        - source_labels: [__address__]</span><br><span class="line">          target_label: __address__</span><br><span class="line">          replacement: &quot;alertmanager.monitoring.svc:9093&quot;</span><br><span class="line"></span><br><span class="line">🎯 实际应用场景</span><br><span class="line"></span><br><span class="line">1. 多集群告警聚合:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 添加集群标识</span><br><span class="line">    - target_label: cluster</span><br><span class="line">      replacement: &quot;$&#123;CLUSTER_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 统一告警名称</span><br><span class="line">    - source_labels: [alertname]</span><br><span class="line">      regex: &quot;(.*)_.*&quot;</span><br><span class="line">      target_label: unified_alert</span><br><span class="line">      replacement: &quot;$1&quot;</span><br><span class="line"></span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;central-alertmanager:9093&quot;]</span><br><span class="line"></span><br><span class="line">2. 环境隔离:</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    # 环境标签</span><br><span class="line">    - target_label: environment</span><br><span class="line">      replacement: &quot;production&quot;</span><br><span class="line"></span><br><span class="line">    # 修改告警路由</span><br><span class="line">    - source_labels: [severity]</span><br><span class="line">      regex: &quot;critical&quot;</span><br><span class="line">      target_label: route</span><br><span class="line">      replacement: &quot;oncall&quot;</span><br><span class="line"></span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;prod-alertmanager:9093&quot;]</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;oncall-alertmanager:9093&quot;]</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [route]</span><br><span class="line">          regex: &quot;oncall&quot;</span><br><span class="line">          action: keep</span><br><span class="line"></span><br><span class="line">🔄 重标签操作详解</span><br><span class="line"></span><br><span class="line">常用 action 类型:</span><br><span class="line"></span><br><span class="line">alert_relabel_configs:</span><br><span class="line">  # replace: 替换标签值 (默认)</span><br><span class="line">  - source_labels: [severity]</span><br><span class="line">    regex: &quot;warning&quot;</span><br><span class="line">    target_label: level</span><br><span class="line">    replacement: &quot;warning&quot;</span><br><span class="line"></span><br><span class="line">  # keep: 保留匹配的告警</span><br><span class="line">  - source_labels: [team]</span><br><span class="line">    regex: &quot;backend&quot;</span><br><span class="line">    action: keep</span><br><span class="line"></span><br><span class="line">  # drop: 丢弃匹配的告警</span><br><span class="line">  - source_labels: [environment]</span><br><span class="line">    regex: &quot;test&quot;</span><br><span class="line">    action: drop</span><br><span class="line"></span><br><span class="line">  # hashmod: 哈希分片</span><br><span class="line">  - source_labels: [alertname]</span><br><span class="line">    target_label: shard</span><br><span class="line">    modulus: 3</span><br><span class="line">    action: hashmod</span><br><span class="line"></span><br><span class="line">高级操作:</span><br><span class="line"></span><br><span class="line">alert_relabel_configs:</span><br><span class="line">  # 标签映射</span><br><span class="line">  - labelmap:</span><br><span class="line">      regex: &quot;__meta_(.+)&quot;</span><br><span class="line">      replacement: &quot;$1&quot;</span><br><span class="line"></span><br><span class="line">  # 多标签组合</span><br><span class="line">  - source_labels: [service, instance]</span><br><span class="line">    separator: &quot;-&quot;</span><br><span class="line">    target_label: endpoint</span><br><span class="line">    replacement: &quot;$1-$2&quot;</span><br><span class="line"></span><br><span class="line">  # 条件标签添加</span><br><span class="line">  - source_labels: [environment]</span><br><span class="line">    regex: &quot;production&quot;</span><br><span class="line">    target_label: urgency</span><br><span class="line">    replacement: &quot;high&quot;</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 顺序重要:</span><br><span class="line"></span><br><span class="line"># 重标签按顺序执行</span><br><span class="line"># 后续操作可以基于前面的结果</span><br><span class="line">alert_relabel_configs:</span><br><span class="line">  - step_1_operation</span><br><span class="line">  - step_2_operation</span><br><span class="line">  - step_3_operation</span><br><span class="line"></span><br><span class="line">2. 告警丢失风险:</span><br><span class="line"></span><br><span class="line"># 谨慎使用 drop 操作</span><br><span class="line"># 确保不会意外丢弃重要告警</span><br><span class="line">- source_labels: [alertname]</span><br><span class="line">  regex: &quot;Important.*&quot;</span><br><span class="line">  action: drop  # 危险操作！</span><br><span class="line"></span><br><span class="line">3. 性能影响:</span><br><span class="line"></span><br><span class="line"># 复杂的重标签规则可能影响性能</span><br><span class="line"># 保持规则简单高效</span><br><span class="line"></span><br><span class="line">💡 最佳实践</span><br><span class="line"></span><br><span class="line">1. 标签规范化:</span><br><span class="line"></span><br><span class="line"># 统一标签命名规范</span><br><span class="line"># 添加必要的上下文信息</span><br><span class="line"># 避免标签值过于复杂</span><br><span class="line"></span><br><span class="line">2. 高可用配置:</span><br><span class="line"></span><br><span class="line"># 配置多个 Alertmanager 实例</span><br><span class="line"># 使用负载均衡和故障转移</span><br><span class="line"># 监控 Alertmanager 健康状态</span><br><span class="line"></span><br><span class="line">3. 环境一致性:</span><br><span class="line"></span><br><span class="line"># 使用环境变量统一配置</span><br><span class="line"># 保持不同环境的一致性</span><br><span class="line"># 建立配置模板</span><br><span class="line"></span><br><span class="line">这个配置是 Prometheus 告警系统的核心部分，负责将告警正确路由到 Alertmanager 并进行必要的标签处理。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>remote_write</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">remote_write - 远程写入配置</span><br><span class="line"></span><br><span class="line">- 作用: 将 Prometheus 抓取的指标数据发送到远程存储系统</span><br><span class="line">- 用途: 长期存储、数据分析、多集群数据聚合</span><br><span class="line">- 支持: 多个远程写入端点</span><br><span class="line"></span><br><span class="line">🎯 基本配置结构</span><br><span class="line"></span><br><span class="line">简单配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;http://remote-storage:9201/api/v1/write&quot;</span><br><span class="line"></span><br><span class="line">完整配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;</span><br><span class="line">    name: &quot;primary-storage&quot;</span><br><span class="line">    remote_timeout: 30s</span><br><span class="line">    headers:</span><br><span class="line">      X-Custom-Header: &quot;value&quot;</span><br><span class="line">    write_relabel_configs:</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;go_.*&quot;</span><br><span class="line">        action: drop</span><br><span class="line">    queue_config:</span><br><span class="line">      max_samples_per_send: 1000</span><br><span class="line">      capacity: 2500</span><br><span class="line"></span><br><span class="line">🔧 详细配置参数</span><br><span class="line"></span><br><span class="line">1. 基础连接配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;  # 必需，远程存储URL</span><br><span class="line">    name: &quot;main-storage&quot;                                    # 可选，配置名称</span><br><span class="line">    remote_timeout: 30s                                     # 可选，写入超时时间</span><br><span class="line">    headers:                                                # 可选，自定义HTTP头</span><br><span class="line">      Authorization: &quot;Bearer token123&quot;</span><br><span class="line">      X-Tenant-ID: &quot;my-tenant&quot;</span><br><span class="line"></span><br><span class="line">2. 认证配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;</span><br><span class="line">    # Basic Auth</span><br><span class="line">    basic_auth:</span><br><span class="line">      username: &quot;admin&quot;</span><br><span class="line">      password: &quot;secret&quot;</span><br><span class="line"></span><br><span class="line">    # Bearer Token</span><br><span class="line">    authorization:</span><br><span class="line">      type: &quot;Bearer&quot;</span><br><span class="line">      credentials: &quot;your-token&quot;</span><br><span class="line"></span><br><span class="line">    # OAuth 2.0</span><br><span class="line">    oauth2:</span><br><span class="line">      client_id: &quot;client123&quot;</span><br><span class="line">      client_secret: &quot;secret123&quot;</span><br><span class="line">      token_url: &quot;https://auth.example.com/token&quot;</span><br><span class="line"></span><br><span class="line">    # TLS 配置</span><br><span class="line">    tls_config:</span><br><span class="line">      insecure_skip_verify: false</span><br><span class="line">      ca_file: &quot;/etc/ssl/certs/ca.crt&quot;</span><br><span class="line">      cert_file: &quot;/etc/ssl/certs/client.crt&quot;</span><br><span class="line">      key_file: &quot;/etc/ssl/certs/client.key&quot;</span><br><span class="line"></span><br><span class="line">3. 数据过滤配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;</span><br><span class="line">    # 写入前重标签 (过滤/修改数据)</span><br><span class="line">    write_relabel_configs:</span><br><span class="line">      # 只发送特定指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;http_requests_total|cpu_usage&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">      # 排除不需要的指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;go_.*|prometheus_.*&quot;</span><br><span class="line">        action: drop</span><br><span class="line"></span><br><span class="line">      # 添加额外标签</span><br><span class="line">      - target_label: source_prometheus</span><br><span class="line">        replacement: &quot;$&#123;HOSTNAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">      # 修改标签值</span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        regex: &quot;prod&quot;</span><br><span class="line">        target_label: env</span><br><span class="line">        replacement: &quot;production&quot;</span><br><span class="line"></span><br><span class="line">4. 队列配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;</span><br><span class="line">    queue_config:</span><br><span class="line">      max_samples_per_send: 1000    # 每次发送最大样本数</span><br><span class="line">      max_shards: 50                # 最大分片数</span><br><span class="line">      capacity: 2500                # 队列容量</span><br><span class="line">      min_shards: 1                 # 最小分片数</span><br><span class="line">      max_retries: 3                # 最大重试次数</span><br><span class="line">      min_backoff: 30ms             # 最小退避时间</span><br><span class="line">      max_backoff: 100ms            # 最大退避时间</span><br><span class="line">      batch_send_deadline: 5s       # 批次发送超时</span><br><span class="line"></span><br><span class="line">🎯 实际配置示例</span><br><span class="line"></span><br><span class="line">1. 基础远程存储:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;http://influxdb:8086/api/v1/prom/write?db=prometheus&quot;</span><br><span class="line">    write_relabel_configs:</span><br><span class="line">      # 排除 Prometheus 自身指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;prometheus_.*|go_.*&quot;</span><br><span class="line">        action: drop</span><br><span class="line"></span><br><span class="line">2. Thanos 配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;http://thanos-receive:19291/api/v1/receive&quot;</span><br><span class="line">    headers:</span><br><span class="line">      THANOSE-TENANT-ID: &quot;tenant-1&quot;</span><br><span class="line">    send_exemplars: true</span><br><span class="line">    send_native_histograms: true</span><br><span class="line">    queue_config:</span><br><span class="line">      max_samples_per_send: 2000</span><br><span class="line">      capacity: 10000</span><br><span class="line"></span><br><span class="line">3. Cortex 配置:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;http://cortex:9009/api/v1/push&quot;</span><br><span class="line">    headers:</span><br><span class="line">      X-Scope-OrgID: &quot;my-org&quot;</span><br><span class="line">    basic_auth:</span><br><span class="line">      username: &quot;cortex-user&quot;</span><br><span class="line">      password: &quot;cortex-password&quot;</span><br><span class="line">    write_relabel_configs:</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;.*&quot;</span><br><span class="line">        target_label: __tmp_write</span><br><span class="line">        replacement: &quot;yes&quot;</span><br><span class="line">      - source_labels: [__tmp_write]</span><br><span class="line">        regex: &quot;yes&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">4. 多目标写入:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  # 主存储</span><br><span class="line">  - url: &quot;https://primary-storage.example.com/api/v1/write&quot;</span><br><span class="line">    name: &quot;primary&quot;</span><br><span class="line">    write_relabel_configs:</span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        regex: &quot;production&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">  # 备份存储</span><br><span class="line">  - url: &quot;https://backup-storage.example.com/api/v1/write&quot;</span><br><span class="line">    name: &quot;backup&quot;</span><br><span class="line">    write_relabel_configs:</span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        regex: &quot;production&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">🔄 数据流程</span><br><span class="line"></span><br><span class="line">抓取数据 → 重标签过滤 → 队列缓冲 → 批次发送 → 远程存储</span><br><span class="line">    ↓           ↓           ↓           ↓           ↓</span><br><span class="line">原始指标    write_relabel   queue_config   HTTP请求    持久化</span><br><span class="line"></span><br><span class="line">队列机制:</span><br><span class="line"></span><br><span class="line"># 数据流向</span><br><span class="line">1. 指标进入队列</span><br><span class="line">2. 按分片分组</span><br><span class="line">3. 批次发送</span><br><span class="line">4. 失败重试</span><br><span class="line">5. 成功确认</span><br><span class="line"></span><br><span class="line">📊 性能调优</span><br><span class="line"></span><br><span class="line">1. 队列优化:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;</span><br><span class="line">    queue_config:</span><br><span class="line">      # 高吞吐量配置</span><br><span class="line">      max_samples_per_send: 5000   # 增大批次大小</span><br><span class="line">      capacity: 25000              # 增大队列容量</span><br><span class="line">      max_shards: 200              # 增加并发</span><br><span class="line"></span><br><span class="line">      # 网络优化</span><br><span class="line">      batch_send_deadline: 10s     # 延长批次超时</span><br><span class="line">      max_backoff: 1s              # 增加重试间隔</span><br><span class="line"></span><br><span class="line">2. 数据过滤优化:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;</span><br><span class="line">    write_relabel_configs:</span><br><span class="line">      # 只发送必要的指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;(http_requests_total|error_rate|latency).*&quot;</span><br><span class="line">        action: keep</span><br><span class="line"></span><br><span class="line">      # 移除高基数标签</span><br><span class="line">      - source_labels: [request_id]</span><br><span class="line">        action: drop</span><br><span class="line"></span><br><span class="line">3. 网络优化:</span><br><span class="line"></span><br><span class="line">remote_write:</span><br><span class="line">  - url: &quot;https://remote-storage.example.com/api/v1/write&quot;</span><br><span class="line">    remote_timeout: 10s          # 设置合理超时</span><br><span class="line">    headers:</span><br><span class="line">      Connection: &quot;keep-alive&quot;   # 保持连接</span><br><span class="line"></span><br><span class="line">    queue_config:</span><br><span class="line">      min_backoff: 10ms          # 快速重试</span><br><span class="line">      max_retries: 5             # 增加重试次数</span><br><span class="line"></span><br><span class="line">⚠️ 注意事项</span><br><span class="line"></span><br><span class="line">1. 资源消耗:</span><br><span class="line"></span><br><span class="line"># 远程写入会增加：</span><br><span class="line"># - CPU 使用 (数据序列化)</span><br><span class="line"># - 内存使用 (队列缓冲)</span><br><span class="line"># - 网络带宽</span><br><span class="line"># - 磁盘I/O (WAL写入)</span><br><span class="line"></span><br><span class="line">2. 数据一致性:</span><br><span class="line"></span><br><span class="line"># 网络问题可能导致：</span><br><span class="line"># - 数据延迟</span><br><span class="line"># - 数据丢失</span><br><span class="line"># - 乱序写入</span><br><span class="line"></span><br><span class="line">3. 存储成本:</span><br><span class="line"></span><br><span class="line"># 远程存储通常按量计费</span><br><span class="line"># 需要控制数据量</span><br><span class="line"># 定期清理过期数据</span><br><span class="line"></span><br><span class="line">💡 最佳实践</span><br><span class="line"></span><br><span class="line">1. 数据过滤:</span><br><span class="line"></span><br><span class="line"># 只发送必要的业务指标</span><br><span class="line"># 排除高基数的调试指标</span><br><span class="line"># 定期审查发送的指标列表</span><br><span class="line"></span><br><span class="line">2. 监控远程写入:</span><br><span class="line"></span><br><span class="line"># 监控关键指标</span><br><span class="line"># - prometheus_remote_storage_samples_total</span><br><span class="line"># - prometheus_remote_storage_samples_failed_total</span><br><span class="line"># - prometheus_remote_storage_queue_highest_sent_timestamp_seconds</span><br><span class="line"></span><br><span class="line">3. 容错设计:</span><br><span class="line"></span><br><span class="line"># 配置多个远程写入端点</span><br><span class="line"># 设置合理的重试策略</span><br><span class="line"># 监控写入健康状态</span><br><span class="line"></span><br><span class="line">4. 安全考虑:</span><br><span class="line"></span><br><span class="line"># 使用HTTPS加密传输</span><br><span class="line"># 配置适当的认证</span><br><span class="line"># 定期轮换密钥和令牌</span><br><span class="line"></span><br><span class="line">远程写入是 Prometheus 实现长期存储和水平扩展的重要功能，但需要仔细配置和监控以确保性能和可靠性。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>otlp</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这是一个 Prometheus OTLP (OpenTelemetry Protocol) 接收器的配置说明。让我解释各个配置项的作用：</span><br><span class="line"></span><br><span class="line">  核心功能配置</span><br><span class="line"></span><br><span class="line">  资源属性处理</span><br><span class="line"></span><br><span class="line">  - promote_resource_attributes: 将指定的资源属性提升为标签，不能与 promote_all_resource_attributes 同时使用</span><br><span class="line">  - promote_all_resource_attributes: 将所有资源属性提升为标签（除了 ignore_resource_attributes 指定的）</span><br><span class="line">  - ignore_resource_attributes: 当启用 promote_all_resource_attributes 时，忽略指定的资源属性</span><br><span class="line"></span><br><span class="line">  ⚠️ 注意: 启用 promote_all_resource_attributes 可能导致时间序列抖动和高内存使用</span><br><span class="line"></span><br><span class="line">  指标名称转换策略</span><br><span class="line"></span><br><span class="line">  translation_strategy 决定如何处理 OTLP 指标名称：</span><br><span class="line"></span><br><span class="line">  1. UnderscoreEscapingWithSuffixes (默认): 使用下划线转义特殊字符，添加后缀</span><br><span class="line">  2. NoUTF8EscapingWithSuffixes: 保留特殊字符，添加后缀</span><br><span class="line">  3. UnderscoreEscapingWithoutSuffixes: 下划线转义但不添加后缀</span><br><span class="line">  4. NoTranslation (实验性): 不转换，保留原始名称</span><br><span class="line"></span><br><span class="line">  ⚠️ 警告: NoTranslation 有显著风险，包括系列冲突和用户体验问题</span><br><span class="line"></span><br><span class="line">  其他功能</span><br><span class="line"></span><br><span class="line">  - keep_identifying_resource_attributes: 将服务相关属性添加到 target_info 指标</span><br><span class="line">  - convert_histograms_to_nhcb: 将 OTLP 直方图转换为带自定义桶的原生直方图</span><br><span class="line">  - promote_scope_metadata: 将 OTel 作用域元数据提升为指标标签</span><br><span class="line"></span><br><span class="line">  使用建议</span><br><span class="line"></span><br><span class="line">  根据 OpenTelemetry 最佳实践，推荐使用默认配置以平衡功能性和性能。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>remote_read</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">配置结构</span><br><span class="line"></span><br><span class="line">remote_read:</span><br><span class="line">  [ - &lt;remote_read&gt; ... ]  # 远程读取配置列表，可以配置多个远程读取端点</span><br><span class="line"></span><br><span class="line">主要用途</span><br><span class="line"></span><br><span class="line">远程读取允许 Prometheus 从其他 Prometheus 服务器或兼容的存储系统（如</span><br><span class="line">Thanos、Cortex、Mimir）查询数据，而无需本地存储这些数据。</span><br><span class="line"></span><br><span class="line">常见配置参数</span><br><span class="line"></span><br><span class="line">每个 &lt;remote_read&gt; 配置通常包含：</span><br><span class="line"></span><br><span class="line">基本连接</span><br><span class="line"></span><br><span class="line">- url: &lt;string&gt;           # 远程端点的 URL</span><br><span class="line">  read_recent: &lt;boolean&gt;  # 是否只读取近期数据（默认 false）</span><br><span class="line"></span><br><span class="line">认证配置</span><br><span class="line"></span><br><span class="line">  basic_auth:</span><br><span class="line">    username: &lt;string&gt;</span><br><span class="line">    password: &lt;string&gt;</span><br><span class="line">  bearer_token: &lt;string&gt;</span><br><span class="line">  bearer_token_file: &lt;string&gt;</span><br><span class="line"></span><br><span class="line">TLS 配置</span><br><span class="line"></span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &lt;string&gt;</span><br><span class="line">    cert_file: &lt;string&gt;</span><br><span class="line">    key_file: &lt;string&gt;</span><br><span class="line">    insecure_skip_verify: &lt;boolean&gt;</span><br><span class="line"></span><br><span class="line">高级选项</span><br><span class="line"></span><br><span class="line">  timeout: &lt;duration&gt;     # 请求超时时间</span><br><span class="line">  proxy_url: &lt;string&gt;     # HTTP 代理 URL</span><br><span class="line">  headers:                # 自定义请求头</span><br><span class="line">    [ &lt;string&gt;: &lt;string&gt; ... ]</span><br><span class="line">  required_matchers:      # 必须匹配的标签选择器</span><br><span class="line">    [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]</span><br><span class="line"></span><br><span class="line">使用场景</span><br><span class="line"></span><br><span class="line">1. 数据联邦: 从多个 Prometheus 实例查询数据</span><br><span class="line">2. 长期存储: 查询存储在 Thanos 等系统的历史数据</span><br><span class="line">3. 数据聚合: 跨多个 Prometheus 实例进行数据聚合</span><br><span class="line">4. 灾难恢复: 从备份系统读取数据</span><br><span class="line"></span><br><span class="line">注意事项</span><br><span class="line"></span><br><span class="line">- 远程读取会增加查询延迟</span><br><span class="line">- 网络问题可能影响查询性能</span><br><span class="line">- 需要确保远程端点的数据格式兼容性</span><br></pre></td></tr></table></figure>

<blockquote>
<p>storage</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">配置结构</span><br><span class="line"></span><br><span class="line">storage:</span><br><span class="line">  [ tsdb: &lt;tsdb&gt; ]         # TSDB 时序数据库配置</span><br><span class="line">  [ exemplars: &lt;exemplars&gt; ] # 示例数据配置</span><br><span class="line"></span><br><span class="line">TSDB 配置 (tsdb)</span><br><span class="line"></span><br><span class="line">时间序列数据库的核心配置：</span><br><span class="line"></span><br><span class="line">基本存储设置</span><br><span class="line"></span><br><span class="line">tsdb:</span><br><span class="line">  path: /prometheus        # 数据存储路径</span><br><span class="line">  retention.time: 15d      # 数据保留时间</span><br><span class="line">  retention.size: 500GB    # 基于大小的保留策略</span><br><span class="line"></span><br><span class="line">  # WAL (Write-Ahead Log) 配置</span><br><span class="line">  wal:</span><br><span class="line">    dir: /prometheus/wal   # WAL 目录</span><br><span class="line">    segment_size: 100MB    # WAL 段大小</span><br><span class="line"></span><br><span class="line">性能优化</span><br><span class="line"></span><br><span class="line">  # 压缩配置</span><br><span class="line">  compression: zstd        # 压缩算法 (snappy, zstd)</span><br><span class="line"></span><br><span class="line">  # 内存映射</span><br><span class="line">  m-lock: false           # 是否锁定内存防止交换</span><br><span class="line"></span><br><span class="line">  # 索引配置</span><br><span class="line">  index:</span><br><span class="line">    max-series-per-metric: 1000000  # 每个指标最大系列数</span><br><span class="line"></span><br><span class="line">  # 块配置</span><br><span class="line">  blocks:</span><br><span class="line">    max-duration: 2h      # 最大块持续时间</span><br><span class="line">    min-duration: 2h      # 最小块持续时间</span><br><span class="line"></span><br><span class="line">运行时可重载参数</span><br><span class="line"></span><br><span class="line">- retention.time - 数据保留时间</span><br><span class="line">- retention.size - 基于大小的保留</span><br><span class="line">- compression - 压缩算法</span><br><span class="line">- 部分性能调优参数</span><br><span class="line"></span><br><span class="line">Exemplars 配置 (exemplars)</span><br><span class="line"></span><br><span class="line">示例数据存储配置，用于存储具体的指标样本：</span><br><span class="line"></span><br><span class="line">exemplars:</span><br><span class="line">  path: /prometheus/exemplars     # 示例数据存储路径</span><br><span class="line">  max_exemplars: 100000          # 最大示例数据数量</span><br><span class="line"></span><br><span class="line">  # 示例数据保留策略</span><br><span class="line">  retention:</span><br><span class="line">    time: 7d                     # 保留时间</span><br><span class="line"></span><br><span class="line">  # 存储后端</span><br><span class="line">  storage: tsdb                  # 存储后端类型</span><br><span class="line"></span><br><span class="line">运行时重载特性</span><br><span class="line"></span><br><span class="line">✅ 支持热重载: 可以通过 --web.enable-lifecycle API 或 SIGHUP 信号重新加载配置，无需重启 Prometheus</span><br><span class="line"></span><br><span class="line">使用建议</span><br><span class="line"></span><br><span class="line">1. 存储路径: 使用高性能存储设备（SSD）</span><br><span class="line">2. 保留策略: 根据磁盘空间和查询需求调整</span><br><span class="line">3. 内存设置: 适当调整 WAL 和缓存大小</span><br><span class="line">4. 监控: 监控存储使用率和性能指标</span><br><span class="line"></span><br><span class="line">示例配置</span><br><span class="line"></span><br><span class="line">storage:</span><br><span class="line">  tsdb:</span><br><span class="line">    path: /data/prometheus</span><br><span class="line">    retention.time: 30d</span><br><span class="line">    retention.size: 1TB</span><br><span class="line">    compression: zstd</span><br><span class="line">  exemplars:</span><br><span class="line">    path: /data/prometheus/exemplars</span><br><span class="line">    max_exemplars: 50000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>tracing</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">配置结构</span><br><span class="line"></span><br><span class="line">tracing:</span><br><span class="line">  [ &lt;tracing_config&gt; ]  # 链路追踪配置</span><br><span class="line"></span><br><span class="line">主要配置选项</span><br><span class="line"></span><br><span class="line">追踪类型配置</span><br><span class="line"></span><br><span class="line">tracing:</span><br><span class="line">  # 追踪后端类型</span><br><span class="line">  type: jaeger          # 或 &quot;otlp&quot;, &quot;zipkin&quot;, &quot;datadog&quot;</span><br><span class="line"></span><br><span class="line">  # 采样率配置</span><br><span class="line">  sampling_fraction: 0.1  # 10% 采样率</span><br><span class="line"></span><br><span class="line">Jaeger 配置</span><br><span class="line"></span><br><span class="line">tracing:</span><br><span class="line">  type: jaeger</span><br><span class="line">  jaeger:</span><br><span class="line">    # gRPC 端点配置</span><br><span class="line">    endpoint: &quot;jaeger:14250&quot;</span><br><span class="line">    tls:</span><br><span class="line">      enabled: true</span><br><span class="line">      cert_file: /path/to/cert</span><br><span class="line">      key_file: /path/to/key</span><br><span class="line">      ca_file: /path/to/ca</span><br><span class="line"></span><br><span class="line">    # HTTP 端点配置</span><br><span class="line">    collector_endpoint: &quot;http://jaeger:14268/api/traces&quot;</span><br><span class="line"></span><br><span class="line">OTLP (OpenTelemetry Protocol) 配置</span><br><span class="line"></span><br><span class="line">tracing:</span><br><span class="line">  type: otlp</span><br><span class="line">  otlp:</span><br><span class="line">    # gRPC 端点</span><br><span class="line">    endpoint: &quot;otel-collector:4317&quot;</span><br><span class="line">    headers:</span><br><span class="line">      authorization: &quot;Bearer &lt;token&gt;&quot;</span><br><span class="line"></span><br><span class="line">    # 协议选择</span><br><span class="line">    protocol: grpc          # 或 &quot;http/protobuf&quot;</span><br><span class="line"></span><br><span class="line">    # TLS 配置</span><br><span class="line">    tls:</span><br><span class="line">      enabled: false</span><br><span class="line"></span><br><span class="line">Zipkin 配置</span><br><span class="line"></span><br><span class="line">tracing:</span><br><span class="line">  type: zipkin</span><br><span class="line">  zipkin:</span><br><span class="line">    endpoint: &quot;http://zipkin:9411/api/v2/spans&quot;</span><br><span class="line">    # TLS 配置</span><br><span class="line">    tls:</span><br><span class="line">      enabled: true</span><br><span class="line">      cert_file: /path/to/cert</span><br><span class="line"></span><br><span class="line">使用场景</span><br><span class="line"></span><br><span class="line">1. 性能监控</span><br><span class="line"></span><br><span class="line">- 监控 Prometheus 内部操作性能</span><br><span class="line">- 识别查询和存储瓶颈</span><br><span class="line">- 优化配置和架构</span><br><span class="line"></span><br><span class="line">2. 故障排查</span><br><span class="line"></span><br><span class="line">- 追踪请求链路</span><br><span class="line">- 定位性能问题根源</span><br><span class="line">- 分析系统行为</span><br><span class="line"></span><br><span class="line">3. 可观测性集成</span><br><span class="line"></span><br><span class="line">- 与现有 APM 系统集成</span><br><span class="line">- 统一监控视图</span><br><span class="line">- 分布式追踪</span><br><span class="line"></span><br><span class="line">追踪内容</span><br><span class="line"></span><br><span class="line">Prometheus 会追踪以下操作：</span><br><span class="line">- HTTP 请求处理</span><br><span class="line">- 查询执行</span><br><span class="line">- 规则评估</span><br><span class="line">- 远程读写操作</span><br><span class="line">- 存储操作</span><br><span class="line"></span><br><span class="line">完整示例</span><br><span class="line"></span><br><span class="line">tracing:</span><br><span class="line">  type: otlp</span><br><span class="line">  sampling_fraction: 0.05</span><br><span class="line">  otlp:</span><br><span class="line">    endpoint: &quot;otel-collector:4317&quot;</span><br><span class="line">    protocol: grpc</span><br><span class="line">    headers:</span><br><span class="line">      x-api-key: &quot;your-api-key&quot;</span><br><span class="line">    tls:</span><br><span class="line">      enabled: true</span><br><span class="line">      ca_file: /path/to/ca.pem</span><br><span class="line"></span><br><span class="line">注意事项</span><br><span class="line"></span><br><span class="line">- 追踪会带来一定性能开销</span><br><span class="line">- 采样率建议设置为 1-10%</span><br><span class="line">- 确保追踪后端容量充足</span><br><span class="line">- 监控追踪数据量避免存储爆炸</span><br></pre></td></tr></table></figure>

<h4 id="scrape-config"><a href="#scrape-config" class="headerlink" title="scrape_config"></a>scrape_config</h4><ol>
<li>A scrape_config section specifies a set of <strong>targets</strong> and <strong>parameters</strong> describing <strong>how to scrape them</strong>.</li>
<li>In the <strong>general</strong> case, <strong>one scrape configuration</strong> specifies <strong>a single job</strong>. In advanced configurations, this may change.</li>
<li><strong>Targets</strong> may be <strong>statically configured</strong> via the <strong>static_configs</strong> parameter<ul>
<li>or <strong>dynamically discovered</strong> using one of the <strong>supported service-discovery mechanisms</strong>.</li>
</ul>
</li>
<li>Additionally, <strong>relabel_configs</strong> allow <strong>advanced modifications</strong> to any <strong>target and its labels</strong> before <strong>scraping</strong>.</li>
</ol>
<blockquote>
<p>scrape_protocols + fallback_scrape_protocol</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这两个配置项控制 Prometheus 抓取指标时使用的协议协商和降级策略：</span><br><span class="line"></span><br><span class="line">  scrape_protocols</span><br><span class="line"></span><br><span class="line">  定义与目标服务协商支持的协议列表，按优先级排序：</span><br><span class="line"></span><br><span class="line">  支持的协议：</span><br><span class="line">  - PrometheusProto - Protocol Buffers 二进制格式，最高效</span><br><span class="line">  - OpenMetricsText0.0.1 - OpenMetrics 文本格式 0.0.1 版本</span><br><span class="line">  - OpenMetricsText1.0.0 - OpenMetrics 文本格式 1.0.0 版本</span><br><span class="line">  - PrometheusText0.0.4 - Prometheus 文本格式 0.0.4 版本</span><br><span class="line">  - PrometheusText1.0.0 - Prometheus 文本格式 1.0.0 版本</span><br><span class="line"></span><br><span class="line">  使用示例：</span><br><span class="line">  scrape_protocols: [&quot;PrometheusProto&quot;, &quot;OpenMetricsText1.0.0&quot;, &quot;PrometheusText1.0.0&quot;]</span><br><span class="line"></span><br><span class="line">  fallback_scrape_protocol</span><br><span class="line"></span><br><span class="line">  当主要协议失败时的降级协议：</span><br><span class="line"></span><br><span class="line">  失败场景：</span><br><span class="line">  - 返回空白响应</span><br><span class="line">  - 无法解析的内容</span><br><span class="line">  - 无效的 Content-Type</span><br><span class="line">  - 协商失败</span><br><span class="line"></span><br><span class="line">  使用示例：</span><br><span class="line">  # 优先使用二进制协议，失败时降级到文本格式</span><br><span class="line">  scrape_protocols: [&quot;PrometheusProto&quot;, &quot;OpenMetricsText1.0.0&quot;]</span><br><span class="line">  fallback_scrape_protocol: &quot;PrometheusText1.0.0&quot;</span><br><span class="line"></span><br><span class="line">  协议选择策略</span><br><span class="line"></span><br><span class="line">  1. 效率优先：PrometheusProto &gt; OpenMetricsText &gt; PrometheusText</span><br><span class="line">  2. 版本优先：1.0.0 &gt; 0.0.4 &gt; 0.0.1</span><br><span class="line">  3. 兼容性考虑：老旧服务可能只支持文本格式</span><br><span class="line"></span><br><span class="line">  这种设计确保了与不同版本和格式的 Prometheus 兼容性，同时提供了最优的性能体验。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>honor_labels + honor_timestamps</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这两个配置项控制 Prometheus 如何处理抓取数据中的标签和时间戳：</span><br><span class="line"></span><br><span class="line">  honor_labels (默认: false)</span><br><span class="line"></span><br><span class="line">  处理标签冲突的策略，当抓取的数据中已包含 Prometheus 服务器端会自动添加的标签时：</span><br><span class="line"></span><br><span class="line">  冲突的标签包括：</span><br><span class="line">  - job - 任务名称</span><br><span class="line">  - instance - 实例标识</span><br><span class="line">  - 手动配置的目标标签</span><br><span class="line">  - 服务发现生成的标签</span><br><span class="line"></span><br><span class="line">  设置为 false (默认)：</span><br><span class="line"></span><br><span class="line">  抓取数据: job=&quot;my-app&quot;, instance=&quot;host1:8080&quot;</span><br><span class="line">  服务器端: job=&quot;scrape-job&quot;, instance=&quot;192.168.1.100:8080&quot;</span><br><span class="line">  结果:</span><br><span class="line">    job=&quot;scrape-job&quot; (服务器端)</span><br><span class="line">    instance=&quot;192.168.1.100:8080&quot; (服务器端)</span><br><span class="line">    exported_job=&quot;my-app&quot; (重命名后的抓取标签)</span><br><span class="line">    exported_instance=&quot;host1:8080&quot; (重命名后的抓取标签)</span><br><span class="line"></span><br><span class="line">  设置为 true：</span><br><span class="line"></span><br><span class="line">  抓取数据: job=&quot;my-app&quot;, instance=&quot;host1:8080&quot;</span><br><span class="line">  服务器端: job=&quot;scrape-job&quot;, instance=&quot;192.168.1.100:8080&quot;</span><br><span class="line">  结果:</span><br><span class="line">    job=&quot;my-app&quot; (保留抓取数据中的标签)</span><br><span class="line">    instance=&quot;host1:8080&quot; (保留抓取数据中的标签)</span><br><span class="line"></span><br><span class="line">  使用场景：</span><br><span class="line"></span><br><span class="line">  - Federation：保留原始标签链路</span><br><span class="line">  - Pushgateway：保留推送时的所有标签</span><br><span class="line">  - 多级聚合：保持标签语义完整性</span><br><span class="line"></span><br><span class="line">  honor_timestamps (默认: true)</span><br><span class="line"></span><br><span class="line">  控制是否使用抓取数据中的时间戳：</span><br><span class="line"></span><br><span class="line">  设置为 true (默认)：</span><br><span class="line"></span><br><span class="line">  - 使用目标服务提供的原始时间戳</span><br><span class="line">  - 适用于目标服务有精确时间戳的场景</span><br><span class="line">  - 保持时间线的准确性</span><br><span class="line"></span><br><span class="line">  设置为 false：</span><br><span class="line"></span><br><span class="line">  - 忽略目标时间戳，使用抓取时间作为时间戳</span><br><span class="line">  - 适用于目标服务时间不可靠的场景</span><br><span class="line">  - 确保数据的时间一致性</span><br><span class="line"></span><br><span class="line">  典型配置组合：</span><br><span class="line"></span><br><span class="line">  # 联邦场景：保留原始标签和时间戳</span><br><span class="line">  honor_labels: true</span><br><span class="line">  honor_timestamps: true</span><br><span class="line"></span><br><span class="line">  # 普通监控：使用服务器标签，忽略目标时间戳</span><br><span class="line">  honor_labels: false</span><br><span class="line">  honor_timestamps: false</span><br><span class="line"></span><br><span class="line">  # Pushgateway：保留标签，使用抓取时间</span><br><span class="line">  honor_labels: true</span><br><span class="line">  honor_timestamps: false</span><br><span class="line"></span><br><span class="line">  这些设置确保了在不同监控架构下的数据一致性和标签语义的准确性。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>track_timestamps_staleness</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">⏺ track_timestamps_staleness 控制 Prometheus 是否跟踪带有明确时间戳的指标的陈旧性。</span><br><span class="line"></span><br><span class="line">  默认行为 (false)</span><br><span class="line"></span><br><span class="line">  当设置为 false 时：</span><br><span class="line">  - Prometheus 不会明确标记指标变为陈旧</span><br><span class="line">  - 指标在目标不可见时会自然过期</span><br><span class="line">  - 依赖默认的抓取间隔和超时机制来判断指标健康状态</span><br><span class="line"></span><br><span class="line">  启用陈旧性跟踪 (true)</span><br><span class="line"></span><br><span class="line">  当设置为 true 时：</span><br><span class="line"></span><br><span class="line">  触发条件：</span><br><span class="line"></span><br><span class="line">  1. 目标下线：目标服务不可访问</span><br><span class="line">  2. 指标消失：之前存在的指标在最新抓取中不再出现</span><br><span class="line">  3. 抓取失败：连续抓取失败超过阈值</span><br><span class="line"></span><br><span class="line">  处理方式：</span><br><span class="line"></span><br><span class="line">  时间线:</span><br><span class="line">  T1: metric_cpu_usage&#123;instance=&quot;host1&quot;&#125; 50.0  (正常)</span><br><span class="line">  T2: metric_cpu_usage&#123;instance=&quot;host1&quot;&#125; 55.0  (正常)</span><br><span class="line">  T3: 目标下线</span><br><span class="line">  T4: 插入陈旧标记 metric_cpu_usage&#123;instance=&quot;host1&quot;&#125;  (stale marker)</span><br><span class="line">  T5: 目标恢复，metric_cpu_usage&#123;instance=&quot;host1&quot;&#125; 48.0  (恢复)</span><br><span class="line"></span><br><span class="line">  在 TSDB 中的表现：</span><br><span class="line"></span><br><span class="line">  - 插入特殊的数据点标记指标为陈旧</span><br><span class="line">  - 查询时该指标会被过滤掉</span><br><span class="line">  - 图表显示中断而非延长到零值</span><br><span class="line"></span><br><span class="line">  使用场景</span><br><span class="line"></span><br><span class="line">  启用的优势：</span><br><span class="line"></span><br><span class="line">  # 适用于需要精确状态跟踪的场景</span><br><span class="line">  track_timestamps_staleness: true</span><br><span class="line"></span><br><span class="line">  1. 服务发现环境：快速识别服务上下线</span><br><span class="line">  2. 告警准确性：避免基于陈旧数据的误报</span><br><span class="line">  3. 数据质量：确保查询结果的时效性</span><br><span class="line">  4. 容量规划：准确掌握资源使用状态</span><br><span class="line"></span><br><span class="line">  性能考虑：</span><br><span class="line"></span><br><span class="line">  - 增加存储开销（陈旧标记）</span><br><span class="line">  - 增加计算开销（跟踪状态变化）</span><br><span class="line">  - 对于大规模部署需要评估影响</span><br><span class="line"></span><br><span class="line">  典型配置：</span><br><span class="line"></span><br><span class="line">  # 核心服务监控 - 启用陈旧性跟踪</span><br><span class="line">  - job_name: &#x27;critical-services&#x27;</span><br><span class="line">    track_timestamps_staleness: true</span><br><span class="line">    scrape_interval: 30s</span><br><span class="line"></span><br><span class="line">  # 批量任务监控 - 可以关闭</span><br><span class="line">  - job_name: &#x27;batch-jobs&#x27;</span><br><span class="line">    track_timestamps_staleness: false</span><br><span class="line">    scrape_interval: 5m</span><br><span class="line"></span><br><span class="line">  这个功能特别适用于微服务环境和动态基础设施，能够更准确地反映系统的实时状态。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>kubernetes_sd_configs</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">⏺ kubernetes_sd_configs 是 Prometheus 用于 Kubernetes 服务发现的核心配置，允许 Prometheus 自动发现和监控</span><br><span class="line">  Kubernetes 集群中的各种资源。</span><br><span class="line"></span><br><span class="line">  基本结构</span><br><span class="line"></span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: &lt;role&gt;</span><br><span class="line">      api_server: &lt;string&gt;</span><br><span class="line">      namespaces:</span><br><span class="line">        names: [&lt;string&gt;, ...]</span><br><span class="line">      selectors:</span><br><span class="line">        - role: &lt;role&gt;</span><br><span class="line">          label: &lt;string&gt;</span><br><span class="line">          field: &lt;string&gt;</span><br><span class="line">      attach_metadata:</span><br><span class="line">        node: &lt;boolean&gt;</span><br><span class="line"></span><br><span class="line">  支持的角色 (role)</span><br><span class="line"></span><br><span class="line">  1. node</span><br><span class="line"></span><br><span class="line">  发现 Kubernetes 节点</span><br><span class="line">  - role: node</span><br><span class="line">    selectors:</span><br><span class="line">      - role: node</span><br><span class="line">        field: metadata.name=node-1  # 选择特定节点</span><br><span class="line"></span><br><span class="line">  2. pod</span><br><span class="line"></span><br><span class="line">  发现运行中的 Pod</span><br><span class="line">  - role: pod</span><br><span class="line">    namespaces:</span><br><span class="line">      names:</span><br><span class="line">        - default</span><br><span class="line">        - monitoring</span><br><span class="line">    selectors:</span><br><span class="line">      - role: pod</span><br><span class="line">        label: app=nginx  # 选择带特定标签的 pod</span><br><span class="line"></span><br><span class="line">  3. service</span><br><span class="line"></span><br><span class="line">  发现 Kubernetes 服务</span><br><span class="line">  - role: service</span><br><span class="line">    namespaces:</span><br><span class="line">      names:</span><br><span class="line">        - default</span><br><span class="line">    selectors:</span><br><span class="line">      - role: service</span><br><span class="line">        label: monitor=true</span><br><span class="line"></span><br><span class="line">  4. endpoint</span><br><span class="line"></span><br><span class="line">  发现服务端点（最常用）</span><br><span class="line">  - role: endpoints</span><br><span class="line">    namespaces:</span><br><span class="line">      names: [&quot;default&quot;, &quot;kube-system&quot;]</span><br><span class="line"></span><br><span class="line">  5. endpointslice</span><br><span class="line"></span><br><span class="line">  发现 EndpointSlice（大集群优化）</span><br><span class="line">  - role: endpointslice</span><br><span class="line">    selectors:</span><br><span class="line">      - role: endpointslice</span><br><span class="line">        label: kubernetes.io/service-name=my-service</span><br><span class="line"></span><br><span class="line">  6. ingress</span><br><span class="line"></span><br><span class="line">  发现 Ingress 资源</span><br><span class="line">  - role: ingress</span><br><span class="line">    namespaces:</span><br><span class="line">      names: [&quot;default&quot;]</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  1. 基础 Pod 监控</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">        namespaces:</span><br><span class="line">          names:</span><br><span class="line">            - default</span><br><span class="line">            - monitoring</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 只监控带有指定注解的 Pod</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      # 设置 metrics 路径</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      # 设置抓取端口</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">        target_label: __address__</span><br><span class="line"></span><br><span class="line">  2. Service 监控</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;kubernetes-services&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">        namespaces:</span><br><span class="line">          names: [&quot;default&quot;]</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 只监控带特定标签的服务</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_label_monitor]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: enabled</span><br><span class="line">      # 添加服务元数据</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        target_label: service_name</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_namespace]</span><br><span class="line">        target_label: service_namespace</span><br><span class="line"></span><br><span class="line">  3. 节点监控</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;kubernetes-nodes&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: node</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 添加节点标签</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        target_label: node_name</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_label_kubernetes_io_arch]</span><br><span class="line">        target_label: arch</span><br><span class="line"></span><br><span class="line">  高级配置选项</span><br><span class="line"></span><br><span class="line">  API Server 配置</span><br><span class="line"></span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      api_server: https://kubernetes.default.svc:443</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">  选择器配置</span><br><span class="line"></span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      selectors:</span><br><span class="line">        - role: pod</span><br><span class="line">          label:</span><br><span class="line">            app: nginx</span><br><span class="line">            tier: frontend</span><br><span class="line">        - role: pod</span><br><span class="line">          field:</span><br><span class="line">            status.phase: Running</span><br><span class="line">            spec.restartPolicy: Always</span><br><span class="line"></span><br><span class="line">  元数据附加</span><br><span class="line"></span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">    attach_metadata:</span><br><span class="line">      node: true  # 附加节点元数据</span><br><span class="line"></span><br><span class="line">  常用标签</span><br><span class="line"></span><br><span class="line">  自动生成的标签包括：</span><br><span class="line">  - __meta_kubernetes_namespace</span><br><span class="line">  - __meta_kubernetes_pod_name</span><br><span class="line">  - __meta_kubernetes_pod_ip</span><br><span class="line">  - __meta_kubernetes_service_name</span><br><span class="line">  - __meta_kubernetes_node_name</span><br><span class="line">  - __meta_kubernetes_pod_label_*</span><br><span class="line">  - __meta_kubernetes_pod_annotation_*</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 使用注解控制抓取：</span><br><span class="line">  # Pod 注解示例</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">      prometheus.io/port: &quot;8080&quot;</span><br><span class="line">      prometheus.io/path: &quot;/metrics&quot;</span><br><span class="line"></span><br><span class="line">  2. 合理命名空间过滤：</span><br><span class="line">  namespaces:</span><br><span class="line">    names: [&quot;monitoring&quot;, &quot;kube-system&quot;]  # 只监控特定命名空间</span><br><span class="line"></span><br><span class="line">  3. 使用 relabel_configs 优化：</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: true</span><br><span class="line"></span><br><span class="line">  Kubernetes 服务发现为 Prometheus 提供了强大的动态监控能力，能够自动适应集群中的资源变化。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>relabel_configs + metric_relabel_configs</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">relabel_configs - 目标重标记</span><br><span class="line"></span><br><span class="line">在抓取前对目标进行重标记，影响是否抓取以及如何抓取。</span><br><span class="line"></span><br><span class="line">基本语法</span><br><span class="line"></span><br><span class="line">relabel_configs:</span><br><span class="line">  - source_labels: [&lt;label&gt;, ...]    # 源标签列表</span><br><span class="line">    separator: ;                    # 标签分隔符 (默认;)</span><br><span class="line">    target_label: &lt;label&gt;           # 目标标签</span><br><span class="line">    regex: &lt;regex&gt;                  # 正则表达式</span><br><span class="line">    replacement: &lt;string&gt;           # 替换字符串</span><br><span class="line">    action: &lt;action&gt;                # 动作类型</span><br><span class="line"></span><br><span class="line">常用动作 (action)</span><br><span class="line"></span><br><span class="line">1. replace (默认) - 替换标签值</span><br><span class="line"></span><br><span class="line">relabel_configs:</span><br><span class="line">  # 从实例名提取服务名</span><br><span class="line">  - source_labels: [__address__]</span><br><span class="line">    regex: &#x27;([^:]+)(:.*)?&#x27;</span><br><span class="line">    replacement: &#x27;$1&#x27;</span><br><span class="line">    target_label: instance_name</span><br><span class="line"></span><br><span class="line">  # 添加环境标签</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    target_label: environment</span><br><span class="line">    replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">2. keep - 保留匹配的目标</span><br><span class="line"></span><br><span class="line">relabel_configs:</span><br><span class="line">  # 只抓取带有特定注解的 Pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">  # 只监控特定命名空间</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: &quot;(default|monitoring|kube-system)&quot;</span><br><span class="line"></span><br><span class="line">3. drop - 丢弃匹配的目标</span><br><span class="line"></span><br><span class="line">relabel_configs:</span><br><span class="line">  # 排除测试环境</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_environment]</span><br><span class="line">    action: drop</span><br><span class="line">    regex: &quot;test&quot;</span><br><span class="line"></span><br><span class="line">  # 排除特定的实例</span><br><span class="line">  - source_labels: [__address__]</span><br><span class="line">    action: drop</span><br><span class="line">    regex: &quot;.*:9091&quot;  # 排除 9091 端口</span><br><span class="line"></span><br><span class="line">4. hashmod - 哈希分片</span><br><span class="line"></span><br><span class="line">relabel_configs:</span><br><span class="line">  # 将目标分片到不同 Prometheus 实例</span><br><span class="line">  - source_labels: [__address__]</span><br><span class="line">    target_label: __tmp_hash</span><br><span class="line">    modulus: 3</span><br><span class="line">    action: hashmod</span><br><span class="line"></span><br><span class="line">  - source_labels: [__tmp_hash]</span><br><span class="line">    regex: &quot;^0$&quot;  # 只处理第一个分片</span><br><span class="line">    action: keep</span><br><span class="line"></span><br><span class="line">5. labelmap - 标签映射</span><br><span class="line"></span><br><span class="line">relabel_configs:</span><br><span class="line">  # 将所有 Kubernetes 标签添加为监控标签</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">    replacement: k8s_pod_label_$1</span><br><span class="line"></span><br><span class="line">6. labeldrop / labelkeep - 标签过滤</span><br><span class="line"></span><br><span class="line">relabel_configs:</span><br><span class="line">  # 删除特定标签</span><br><span class="line">  - action: labeldrop</span><br><span class="line">    regex: &quot;__meta_.*&quot;</span><br><span class="line"></span><br><span class="line">  # 只保留特定标签</span><br><span class="line">  - action: labelkeep</span><br><span class="line">    regex: &quot;(instance|job|__address__)&quot;</span><br><span class="line"></span><br><span class="line">metric_relabel_configs - 指标重标记</span><br><span class="line"></span><br><span class="line">在抓取后对指标进行重标记，影响存储哪些指标以及指标格式。</span><br><span class="line"></span><br><span class="line">主要用途</span><br><span class="line"></span><br><span class="line">1. 删除不需要的指标</span><br><span class="line"></span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  # 删除高基数指标</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    action: drop</span><br><span class="line">    regex: &quot;(go_.*|process_.*|prometheus_.*|http_.*|grpc_.*|container_.*|machine_.*|cadvisor_*)&quot;</span><br><span class="line"></span><br><span class="line">  # 删除特定前缀的指标</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    action: drop</span><br><span class="line">    regex: &quot;debug_.*&quot;</span><br><span class="line"></span><br><span class="line">2. 重命名指标</span><br><span class="line"></span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  # 统一指标名称</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    regex: &quot;custom_metric_(.+)&quot;</span><br><span class="line">    replacement: &quot;standardized_metric_$1&quot;</span><br><span class="line">    action: replace</span><br><span class="line"></span><br><span class="line">  # 删除指标前缀</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    regex: &quot;application_(.+)&quot;</span><br><span class="line">    replacement: &quot;$1&quot;</span><br><span class="line">    action: replace</span><br><span class="line"></span><br><span class="line">3. 添加或修改标签</span><br><span class="line"></span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  # 添加环境标签</span><br><span class="line">  - source_labels: [instance]</span><br><span class="line">    target_label: environment</span><br><span class="line">    replacement: &quot;production&quot;</span><br><span class="line">    action: replace</span><br><span class="line"></span><br><span class="line">  # 提取服务名</span><br><span class="line">  - source_labels: [job]</span><br><span class="line">    regex: &quot;kubernetes-(.+)-endpoints&quot;</span><br><span class="line">    replacement: &quot;$1&quot;</span><br><span class="line">    target_label: service</span><br><span class="line">    action: replace</span><br><span class="line"></span><br><span class="line">4. 指标聚合和降采样</span><br><span class="line"></span><br><span class="line">metric_relabel_configs:</span><br><span class="line">  # 降采样：只保留特定标签组合</span><br><span class="line">  - source_labels: [__name__, method, status_code]</span><br><span class="line">    regex: &quot;http_requests_total;(GET|POST);(200|400|500)&quot;</span><br><span class="line">    action: keep</span><br><span class="line"></span><br><span class="line">  # 聚合：移除细粒度标签</span><br><span class="line">  - source_labels: [pod, container]</span><br><span class="line">    action: labeldrop</span><br><span class="line"></span><br><span class="line">完整示例</span><br><span class="line"></span><br><span class="line">复杂的 Kubernetes 监控配置</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 1. 只抓取带特定注解的 Pod</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">      # 2. 设置抓取端口</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: &#x27;([^:]+)(?::\d+)?;(\d+)&#x27;</span><br><span class="line">        replacement: &#x27;$1:$2&#x27;</span><br><span class="line">        target_label: __address__</span><br><span class="line"></span><br><span class="line">      # 3. 设置 metrics 路径</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line"></span><br><span class="line">      # 4. 添加 Kubernetes 元数据标签</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">        replacement: k8s_label_$1</span><br><span class="line"></span><br><span class="line">      # 5. 清理不需要的元数据</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: __meta_kubernetes_pod_annotation_.+</span><br><span class="line"></span><br><span class="line">    metric_relabel_configs:</span><br><span class="line">      # 1. 删除不需要的指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        action: drop</span><br><span class="line">        regex: &quot;go_.*|process_.*|prometheus_.*&quot;</span><br><span class="line"></span><br><span class="line">      # 2. 重命名指标</span><br><span class="line">      - source_labels: [__name__]</span><br><span class="line">        regex: &quot;custom_(.+)&quot;</span><br><span class="line">        replacement: &quot;app_$1&quot;</span><br><span class="line">        action: replace</span><br><span class="line"></span><br><span class="line">      # 3. 添加通用标签</span><br><span class="line">      - target_label: cluster</span><br><span class="line">        replacement: &quot;production&quot;</span><br><span class="line">        action: replace</span><br><span class="line"></span><br><span class="line">性能考虑</span><br><span class="line"></span><br><span class="line">1. relabing 在抓取前：减少不必要的网络请求</span><br><span class="line">2. metric relabeling 在抓取后：减少存储和计算开销</span><br><span class="line">3. 正则表达式性能：复杂正则会影响抓取延迟</span><br><span class="line">4. 标签数量控制：过多标签会增加内存使用</span><br><span class="line"></span><br><span class="line">这些配置为 Prometheus 提供了强大的灵活性，能够适应各种复杂的监控需求和环境。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>body_size_limit + sample_limit + label_limit + label_name_length_limit + label_value_length_limit + target_limit</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">body_size_limit - 响应体大小限制</span><br><span class="line"></span><br><span class="line">控制目标服务返回的未压缩响应体的最大字节数。</span><br><span class="line"></span><br><span class="line">配置示例</span><br><span class="line"></span><br><span class="line"># 限制响应体为 10MB</span><br><span class="line">body_size_limit: 10MB</span><br><span class="line"></span><br><span class="line"># 限制响应体为 100MB</span><br><span class="line">body_size_limit: 100MB</span><br><span class="line"></span><br><span class="line"># 无限制</span><br><span class="line">body_size_limit: 0</span><br><span class="line"></span><br><span class="line">使用场景</span><br><span class="line"></span><br><span class="line"># 大型应用可能返回大量指标，需要限制</span><br><span class="line">- job_name: &#x27;large-app&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;big-app:8080&#x27;]</span><br><span class="line">  body_size_limit: 50MB</span><br><span class="line"></span><br><span class="line"># 小型服务可以使用默认值</span><br><span class="line">- job_name: &#x27;small-app&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;small-app:8080&#x27;]</span><br><span class="line">  body_size_limit: 0  # 无限制</span><br><span class="line"></span><br><span class="line">sample_limit - 样本数量限制</span><br><span class="line"></span><br><span class="line">限制每次抓取接受的样本数量，超过后整个抓取失败。</span><br><span class="line"></span><br><span class="line">配置示例</span><br><span class="line"></span><br><span class="line"># 限制每个目标最多 10,000 个样本</span><br><span class="line">- job_name: &#x27;high-metrics&#x27;</span><br><span class="line">  sample_limit: 10000</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;metrics-heavy:8080&#x27;]</span><br><span class="line"></span><br><span class="line"># 无限制</span><br><span class="line">- job_name: &#x27;normal-app&#x27;</span><br><span class="line">  sample_limit: 0</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;normal-app:8080&#x27;]</span><br><span class="line"></span><br><span class="line">实际应用</span><br><span class="line"></span><br><span class="line"># 对于已知高基数的服务</span><br><span class="line">- job_name: &#x27;cassandra&#x27;</span><br><span class="line">  sample_limit: 50000</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;cassandra:8080&#x27;]</span><br><span class="line"></span><br><span class="line"># 对于 Web 应用</span><br><span class="line">- job_name: &#x27;web-app&#x27;</span><br><span class="line">  sample_limit: 10000</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;web-app:8080&#x27;]</span><br><span class="line"></span><br><span class="line">label_limit - 标签数量限制</span><br><span class="line"></span><br><span class="line">限制每个样本的标签数量。</span><br><span class="line"></span><br><span class="line">配置示例</span><br><span class="line"></span><br><span class="line"># 每个样本最多 30 个标签</span><br><span class="line">- job_name: &#x27;tag-heavy-app&#x27;</span><br><span class="line">  label_limit: 30</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;app:8080&#x27;]</span><br><span class="line"></span><br><span class="line"># 严格限制</span><br><span class="line">- job_name: &#x27;simple-app&#x27;</span><br><span class="line">  label_limit: 10</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;simple:8080&#x27;]</span><br><span class="line"></span><br><span class="line">高基数警告</span><br><span class="line"></span><br><span class="line"># 防止标签爆炸</span><br><span class="line">- job_name: &#x27;user-metrics&#x27;</span><br><span class="line">  label_limit: 20</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 删除可能导致高基数的标签</span><br><span class="line">    - source_labels: [user_id, session_id]</span><br><span class="line">      action: labeldrop</span><br><span class="line"></span><br><span class="line">label_name_length_limit - 标签名长度限制</span><br><span class="line"></span><br><span class="line">限制标签名的字节长度（UTF-8 编码）。</span><br><span class="line"></span><br><span class="line">配置示例</span><br><span class="line"></span><br><span class="line"># 限制标签名最多 100 字节</span><br><span class="line">- job_name: &#x27;custom-app&#x27;</span><br><span class="line">  label_name_length_limit: 100</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;app:8080&#x27;]</span><br><span class="line"></span><br><span class="line"># 严格限制（约 25 个字符）</span><br><span class="line">- job_name: &#x27;strict-app&#x27;</span><br><span class="line">  label_name_length_limit: 100</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;strict:8080&#x27;]</span><br><span class="line"></span><br><span class="line">label_value_length_limit - 标签值长度限制</span><br><span class="line"></span><br><span class="line">限制标签值的字节长度（UTF-8 编码）。</span><br><span class="line"></span><br><span class="line">配置示例</span><br><span class="line"></span><br><span class="line"># 限制标签值最多 200 字节</span><br><span class="line">- job_name: &#x27;app-with-long-values&#x27;</span><br><span class="line">  label_value_length_limit: 200</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;app:8080&#x27;]</span><br><span class="line"></span><br><span class="line"># 防止过长的请求ID等</span><br><span class="line">- job_name: &#x27;api-gateway&#x27;</span><br><span class="line">  label_value_length_limit: 500</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;gateway:8080&#x27;]</span><br><span class="line"></span><br><span class="line">target_limit - 目标数量限制</span><br><span class="line"></span><br><span class="line">限制每个抓取配置接受的唯一目标数量。</span><br><span class="line"></span><br><span class="line">配置示例</span><br><span class="line"></span><br><span class="line"># 最多 1000 个目标</span><br><span class="line">- job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">  target_limit: 1000</span><br><span class="line"></span><br><span class="line"># 大集群的严格限制</span><br><span class="line">- job_name: &#x27;large-cluster&#x27;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: endpoints</span><br><span class="line">  target_limit: 5000</span><br><span class="line"></span><br><span class="line">综合配置示例</span><br><span class="line"></span><br><span class="line">生产环境配置</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  # 核心 Web 应用 - 严格限制</span><br><span class="line">  - job_name: &#x27;web-production&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;web1:8080&#x27;, &#x27;web2:8080&#x27;, &#x27;web3:8080&#x27;]</span><br><span class="line">    body_size_limit: 20MB</span><br><span class="line">    sample_limit: 5000</span><br><span class="line">    label_limit: 15</span><br><span class="line">    label_name_length_limit: 100</span><br><span class="line">    label_value_length_limit: 200</span><br><span class="line">    target_limit: 100</span><br><span class="line"></span><br><span class="line">  # 数据库服务 - 宽松限制</span><br><span class="line">  - job_name: &#x27;database-metrics&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;postgres:9187&#x27;, &#x27;redis:9121&#x27;]</span><br><span class="line">    body_size_limit: 50MB</span><br><span class="line">    sample_limit: 10000</span><br><span class="line">    label_limit: 25</span><br><span class="line">    label_name_length_limit: 150</span><br><span class="line">    label_value_length_limit: 500</span><br><span class="line"></span><br><span class="line">  # 大规模微服务 - 中等限制</span><br><span class="line">  - job_name: &#x27;microservices&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">        namespaces:</span><br><span class="line">          names: [&#x27;microservices&#x27;]</span><br><span class="line">    target_limit: 500</span><br><span class="line">    sample_limit: 8000</span><br><span class="line">    label_limit: 20</span><br><span class="line">    body_size_limit: 30MB</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 只监控带注解的服务</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">开发环境配置</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;dev-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;dev-app:8080&#x27;]</span><br><span class="line">    # 开发环境使用宽松的限制</span><br><span class="line">    body_size_limit: 100MB</span><br><span class="line">    sample_limit: 0  # 无限制</span><br><span class="line">    label_limit: 0   # 无限制</span><br><span class="line">    label_name_length_limit: 0</span><br><span class="line">    label_value_length_limit: 0</span><br><span class="line"></span><br><span class="line">监控和告警</span><br><span class="line"></span><br><span class="line">建议为这些限制设置告警：</span><br><span class="line"></span><br><span class="line"># 监控接近限制的目标</span><br><span class="line">- alert: ScrapeNearLimits</span><br><span class="line">  expr: prometheus_target_interval_length_seconds_count / prometheus_target_interval_length_seconds_sum &gt; 0.9</span><br><span class="line">  labels:</span><br><span class="line">    severity: warning</span><br><span class="line">  annotations:</span><br><span class="line">    summary: &quot;Target &#123;&#123; $labels.instance &#125;&#125; near scraping limits&quot;</span><br><span class="line"></span><br><span class="line">这些限制机制帮助保护 Prometheus 免受异常大的数据影响，确保系统的稳定性和性能。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>keep_dropped_targets</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">⏺ keep_dropped_targets 控制在内存中保留多少个被 relabeling 丢弃的目标，用于调试和监控目的。</span><br><span class="line"></span><br><span class="line">  默认行为</span><br><span class="line"></span><br><span class="line">  # 默认不保留丢弃的目标</span><br><span class="line">  keep_dropped_targets: 0</span><br><span class="line"></span><br><span class="line">  功能说明</span><br><span class="line"></span><br><span class="line">  为什么需要保留丢弃的目标？</span><br><span class="line"></span><br><span class="line">  1. 调试 relabeling 规则：查看哪些目标被意外丢弃</span><br><span class="line">  2. 配置验证：确认 relabeling 规则按预期工作</span><br><span class="line">  3. 服务发现问题排查：了解目标发现过程中的问题</span><br><span class="line">  4. 性能监控：跟踪 relabeling 的效果</span><br><span class="line"></span><br><span class="line">  内存中的信息</span><br><span class="line"></span><br><span class="line">  保留的目标包含以下信息：</span><br><span class="line">  - 原始目标地址</span><br><span class="line">  - 丢弃原因</span><br><span class="line">  - 相关的元数据标签</span><br><span class="line">  - 丢弃时间</span><br><span class="line"></span><br><span class="line">  配置示例</span><br><span class="line"></span><br><span class="line">  调试配置</span><br><span class="line"></span><br><span class="line">  # 保留最近 1000 个被丢弃的目标，用于调试</span><br><span class="line">  - job_name: &#x27;kubernetes-pods-debug&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">    keep_dropped_targets: 1000</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 只抓取特定注解的 Pod</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: &quot;true&quot;</span><br><span class="line">      # 排除测试环境的 Pod</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_label_environment]</span><br><span class="line">        action: drop</span><br><span class="line">        regex: &quot;test&quot;</span><br><span class="line"></span><br><span class="line">  生产环境配置</span><br><span class="line"></span><br><span class="line">  # 生产环境保留少量用于监控</span><br><span class="line">  - job_name: &#x27;production-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;prod1:8080&#x27;, &#x27;prod2:8080&#x27;]</span><br><span class="line">    keep_dropped_targets: 100  # 保留最近 100 个</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">  大规模环境配置</span><br><span class="line"></span><br><span class="line">  # 大规模集群限制内存使用</span><br><span class="line">  - job_name: &#x27;large-cluster&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">    keep_dropped_targets: 500  # 适中的限制</span><br><span class="line">    target_limit: 5000</span><br><span class="line"></span><br><span class="line">  实际应用场景</span><br><span class="line"></span><br><span class="line">  1. 调试 relabeling 规则</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;debug-relabeling&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">    keep_dropped_targets: 1000  # 保留足够多用于调试</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # 复杂的过滤逻辑</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_label_app, __meta_kubernetes_pod_label_version]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: &quot;(nginx|apache);(v1\.2|v1\.3)&quot;</span><br><span class="line"></span><br><span class="line">  2. 监控目标发现健康度</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;monitor-discovery&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">    keep_dropped_targets: 200</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_label_monitor]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: &quot;enabled&quot;</span><br><span class="line"></span><br><span class="line">  3. 多环境管理</span><br><span class="line"></span><br><span class="line">  # 开发环境 - 保留更多用于调试</span><br><span class="line">  - job_name: &#x27;dev-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;dev-app:8080&#x27;]</span><br><span class="line">    keep_dropped_targets: 500</span><br><span class="line"></span><br><span class="line">  # 生产环境 - 只保留关键信息</span><br><span class="line">  - job_name: &#x27;prod-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;prod-app:8080&#x27;]</span><br><span class="line">    keep_dropped_targets: 50</span><br><span class="line"></span><br><span class="line">  内存影响分析</span><br><span class="line"></span><br><span class="line">  内存使用估算</span><br><span class="line"></span><br><span class="line">  # 每个丢弃的目标大约占用 1-2KB 内存</span><br><span class="line">  # 1000 个目标 ≈ 1-2MB</span><br><span class="line">  keep_dropped_targets: 1000</span><br><span class="line"></span><br><span class="line">  # 对于大规模部署要谨慎</span><br><span class="line">  # 10000 个目标 ≈ 10-20MB</span><br><span class="line">  keep_dropped_targets: 10000</span><br><span class="line"></span><br><span class="line">  性能考虑</span><br><span class="line"></span><br><span class="line">  # 小规模集群 (&lt; 100 targets)</span><br><span class="line">  keep_dropped_targets: 500</span><br><span class="line"></span><br><span class="line">  # 中等规模集群 (100-1000 targets)</span><br><span class="line">  keep_dropped_targets: 1000</span><br><span class="line"></span><br><span class="line">  # 大规模集群 (&gt; 1000 targets)</span><br><span class="line">  keep_dropped_targets: 2000</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 分阶段配置</span><br><span class="line"></span><br><span class="line">  # 开发/测试阶段</span><br><span class="line">  - job_name: &#x27;debug-mode&#x27;</span><br><span class="line">    keep_dropped_targets: 2000</span><br><span class="line">    # 详细日志</span><br><span class="line">    # 宽松限制</span><br><span class="line"></span><br><span class="line">  # 生产阶段</span><br><span class="line">  - job_name: &#x27;production-mode&#x27;</span><br><span class="line">    keep_dropped_targets: 100</span><br><span class="line">    # 最小内存占用</span><br><span class="line">    # 严格限制</span><br><span class="line"></span><br><span class="line">  2. 环境差异化</span><br><span class="line"></span><br><span class="line">  # 开发环境</span><br><span class="line">  - job_name: &#x27;dev&#x27;</span><br><span class="line">    keep_dropped_targets: 1000</span><br><span class="line"></span><br><span class="line">  # 测试环境</span><br><span class="line">  - job_name: &#x27;staging&#x27;</span><br><span class="line">    keep_dropped_targets: 500</span><br><span class="line"></span><br><span class="line">  # 生产环境</span><br><span class="line">  - job_name: &#x27;prod&#x27;</span><br><span class="line">    keep_dropped_targets: 50</span><br><span class="line"></span><br><span class="line">  3. 监控丢弃率</span><br><span class="line"></span><br><span class="line">  # 通过其他指标监控丢弃情况</span><br><span class="line">  - job_name: &#x27;monitor-drops&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;prometheus:9090&#x27;]</span><br><span class="line">    keep_dropped_targets: 200</span><br><span class="line">    # 定期检查 drop 情况</span><br><span class="line"></span><br><span class="line">  注意事项</span><br><span class="line"></span><br><span class="line">  1. 内存消耗：每个丢弃的目标都会占用内存</span><br><span class="line">  2. 数据保留：只保留最近的 N 个，旧的会被丢弃</span><br><span class="line">  3. 调试用途：主要用于开发和调试阶段</span><br><span class="line">  4. 生产环境：建议使用较小的值</span><br><span class="line"></span><br><span class="line">  调试工作流</span><br><span class="line"></span><br><span class="line">  1. 开发阶段：设置较高的值（如 1000-2000）</span><br><span class="line">  2. 测试阶段：调整到适中值（如 500）</span><br><span class="line">  3. 生产阶段：设置较低值（如 50-100）</span><br><span class="line">  4. 问题排查时：临时增加数值进行调试</span><br><span class="line"></span><br><span class="line">  这个功能为 Prometheus 提供了强大的调试能力，帮助理解和优化复杂的 relabeling 配置。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>metric_name_validation_scheme + metric_name_escaping_scheme</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">metric_name_validation_scheme - 指标名验证方案</span><br><span class="line"></span><br><span class="line">&quot;utf8&quot; (默认) - 完整 UTF-8 支持</span><br><span class="line"></span><br><span class="line"># 支持所有 Unicode 字符</span><br><span class="line">metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">支持的字符：</span><br><span class="line">- 所有 UTF-8 字符</span><br><span class="line">- 中文、日文、韩文等非拉丁字符</span><br><span class="line">- Emoji 和特殊符号</span><br><span class="line">- 数学符号</span><br><span class="line"></span><br><span class="line">示例指标名：</span><br><span class="line">cpu_使用率</span><br><span class="line">memory_mb</span><br><span class="line">response_time_ms</span><br><span class="line">🚀_requests_total</span><br><span class="line">αβγ_metric</span><br><span class="line"></span><br><span class="line">&quot;legacy&quot; - 传统字符集</span><br><span class="line"></span><br><span class="line"># 只支持传统 Prometheus 字符集</span><br><span class="line">metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line"></span><br><span class="line">支持的字符：</span><br><span class="line">- 字母 a-z, A-Z</span><br><span class="line">- 数字 0-9</span><br><span class="line">- 冒号 :</span><br><span class="line">- 下划线 _</span><br><span class="line"></span><br><span class="line">示例指标名：</span><br><span class="line">cpu_usage</span><br><span class="line">memory_mb</span><br><span class="line">http_requests_total</span><br><span class="line">node_cpu_seconds_total</span><br><span class="line"></span><br><span class="line">metric_name_escaping_scheme - 转义方案</span><br><span class="line"></span><br><span class="line">&quot;allow-utf-8&quot; (默认) - 允许 UTF-8</span><br><span class="line"></span><br><span class="line"># UTF-8 模式下的默认转义方案</span><br><span class="line">metric_name_escaping_scheme: &quot;allow-utf-8&quot;</span><br><span class="line">metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line"></span><br><span class="line">特点：</span><br><span class="line">- 不需要转义</span><br><span class="line">- 完整保留原始字符</span><br><span class="line">- 推荐用于新系统</span><br><span class="line"></span><br><span class="line">&quot;underscores&quot; - 下划线转义</span><br><span class="line"></span><br><span class="line"># 将所有非法字符转为下划线</span><br><span class="line">metric_name_escaping_scheme: &quot;underscores&quot;</span><br><span class="line"></span><br><span class="line">转换示例：</span><br><span class="line">原始: &quot;app.requests-per-second&quot;</span><br><span class="line">转义: &quot;app_requests_per_second&quot;</span><br><span class="line"></span><br><span class="line">原始: &quot;cpu@usage&quot;</span><br><span class="line">转义: &quot;cpu_usage&quot;</span><br><span class="line"></span><br><span class="line">原始: &quot;metric:with:dots&quot;</span><br><span class="line">转义: &quot;metric_with_dots&quot;</span><br><span class="line"></span><br><span class="line">&quot;dots&quot; - 点号转义方案</span><br><span class="line"></span><br><span class="line"># 特殊的点号和下划线转义</span><br><span class="line">metric_name_escaping_scheme: &quot;dots&quot;</span><br><span class="line"></span><br><span class="line">转换示例：</span><br><span class="line">原始: &quot;app.requests.per.second&quot;</span><br><span class="line">转义: &quot;app_dot_requests_dot_per_dot_second&quot;</span><br><span class="line"></span><br><span class="line">原始: &quot;app_requests&quot;</span><br><span class="line">转义: &quot;app__requests&quot;</span><br><span class="line"></span><br><span class="line">原始: &quot;app@metrics&quot;</span><br><span class="line">转义: &quot;app_metrics&quot;</span><br><span class="line"></span><br><span class="line">&quot;values&quot; - Unicode 值转义</span><br><span class="line"></span><br><span class="line"># 使用 Unicode 值进行转义</span><br><span class="line">metric_name_escaping_scheme: &quot;values&quot;</span><br><span class="line"></span><br><span class="line">转换示例：</span><br><span class="line">原始: &quot;my.dotted.name&quot;</span><br><span class="line">转义: &quot;U__my_2e_dotted_2e_name&quot;</span><br><span class="line"></span><br><span class="line">原始: &quot;metric@with:special&quot;</span><br><span class="line">转义: &quot;U__metric_40_with_3a_special&quot;</span><br><span class="line"></span><br><span class="line">原始: &quot;app_requests&quot;</span><br><span class="line">转义: &quot;U__app__requests&quot;</span><br><span class="line"></span><br><span class="line">Unicode 码点对应：</span><br><span class="line">- . → _2e_ (ASCII 46)</span><br><span class="line">- @ → _40_ (ASCII 64)</span><br><span class="line">- : → _3a_ (ASCII 58)</span><br><span class="line">- _ → __ (双下划线)</span><br><span class="line"></span><br><span class="line">配置组合示例</span><br><span class="line"></span><br><span class="line">现代应用配置</span><br><span class="line"></span><br><span class="line"># 支持 UTF-8，不转义</span><br><span class="line">- job_name: &#x27;modern-app&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;app:8080&#x27;]</span><br><span class="line">  metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;allow-utf-8&quot;</span><br><span class="line"></span><br><span class="line">兼容旧系统配置</span><br><span class="line"></span><br><span class="line"># 传统字符集，下划线转义</span><br><span class="line">- job_name: &#x27;legacy-app&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;legacy:8080&#x27;]</span><br><span class="line">  metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;underscores&quot;</span><br><span class="line"></span><br><span class="line">混合环境配置</span><br><span class="line"></span><br><span class="line"># 国际化应用</span><br><span class="line">- job_name: &#x27;i18n-app&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;i18n:8080&#x27;]</span><br><span class="line">  metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;allow-utf-8&quot;</span><br><span class="line"></span><br><span class="line"># 传统监控系统</span><br><span class="line">- job_name: &#x27;monitoring&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;monitor:9090&#x27;]</span><br><span class="line">  metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;dots&quot;</span><br><span class="line"></span><br><span class="line">实际应用场景</span><br><span class="line"></span><br><span class="line">1. 国际化指标</span><br><span class="line"></span><br><span class="line"># 中文指标名</span><br><span class="line">- job_name: &#x27;chinese-app&#x27;</span><br><span class="line">  metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;allow-utf-8&quot;</span><br><span class="line">  # 支持指标名如: cpu使用率, 内存占用率</span><br><span class="line"></span><br><span class="line">2. 微服务架构</span><br><span class="line"></span><br><span class="line"># 使用点号分隔的服务指标</span><br><span class="line">- job_name: &#x27;microservices&#x27;</span><br><span class="line">  metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;dots&quot;</span><br><span class="line">  # app.requests.per.second → app_dot_requests_dot_per_dot_second</span><br><span class="line"></span><br><span class="line">3. 第三方集成</span><br><span class="line"></span><br><span class="line"># 处理各种特殊字符的指标</span><br><span class="line">- job_name: &#x27;external-system&#x27;</span><br><span class="line">  metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;values&quot;</span><br><span class="line">  # 将所有特殊字符转为 Unicode 值</span><br><span class="line"></span><br><span class="line">迁移策略</span><br><span class="line"></span><br><span class="line">从 Legacy 到 UTF-8</span><br><span class="line"></span><br><span class="line"># 阶段 1: Legacy 验证，dots 转义</span><br><span class="line">metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line">metric_name_escaping_scheme: &quot;dots&quot;</span><br><span class="line"></span><br><span class="line"># 阶段 2: Legacy 验证，underscores 转义</span><br><span class="line">metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line">metric_name_escaping_scheme: &quot;underscores&quot;</span><br><span class="line"></span><br><span class="line"># 阶段 3: UTF-8 验证，allow-utf-8 转义</span><br><span class="line">metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">metric_name_escaping_scheme: &quot;allow-utf-8&quot;</span><br><span class="line"></span><br><span class="line">兼容性配置</span><br><span class="line"></span><br><span class="line"># 确保与旧客户端兼容</span><br><span class="line">- job_name: &#x27;compatible&#x27;</span><br><span class="line">  metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">  metric_name_escaping_scheme: &quot;underscores&quot;</span><br><span class="line">  # 新字符支持下划线转义</span><br><span class="line"></span><br><span class="line">最佳实践</span><br><span class="line"></span><br><span class="line">1. 新项目</span><br><span class="line"></span><br><span class="line"># 推荐配置：完全 UTF-8 支持</span><br><span class="line">metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">metric_name_escaping_scheme: &quot;allow-utf-8&quot;</span><br><span class="line"></span><br><span class="line">2. 多语言环境</span><br><span class="line"></span><br><span class="line"># 国际化应用</span><br><span class="line">metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">metric_name_escaping_scheme: &quot;allow-utf-8&quot;</span><br><span class="line"></span><br><span class="line">3. 现有系统升级</span><br><span class="line"></span><br><span class="line"># 渐进式迁移</span><br><span class="line">metric_name_validation_scheme: &quot;utf8&quot;</span><br><span class="line">metric_name_escaping_scheme: &quot;underscores&quot;</span><br><span class="line"># 便于向后兼容</span><br><span class="line"></span><br><span class="line">4. 严格环境</span><br><span class="line"></span><br><span class="line"># 企业级标准化</span><br><span class="line">metric_name_validation_scheme: &quot;legacy&quot;</span><br><span class="line">metric_name_escaping_scheme: &quot;dots&quot;</span><br><span class="line"># 确保指标名标准化</span><br><span class="line"></span><br><span class="line">性能影响</span><br><span class="line"></span><br><span class="line">- UTF-8 验证：性能影响最小</span><br><span class="line">- 转义处理：少量性能开销</span><br><span class="line">- 兼容性：建议统一使用相同方案</span><br><span class="line"></span><br><span class="line">这些配置项为 Prometheus 提供了灵活的指标命名策略，支持国际化需求，同时保持向后兼容性。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>native_histogram_bucket_limit + native_histogram_min_bucket_factor + convert_classic_histograms_to_nhcb</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这三个配置项控制 Prometheus 3.0+ 中的原生直方图（Native Histograms）功能，这是对传统直方图的重大改进。</span><br><span class="line"></span><br><span class="line">  native_histogram_bucket_limit - 桶数量限制</span><br><span class="line"></span><br><span class="line">  控制单个原生直方图允许的最大桶数（包括正数和负数桶）。</span><br><span class="line"></span><br><span class="line">  默认行为</span><br><span class="line"></span><br><span class="line">  # 无限制（默认）</span><br><span class="line">  native_histogram_bucket_limit: 0</span><br><span class="line"></span><br><span class="line">  配置示例</span><br><span class="line"></span><br><span class="line">  # 限制最多 1000 个桶</span><br><span class="line">  - job_name: &#x27;high-resolution-histograms&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;app:8080&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 1000</span><br><span class="line"></span><br><span class="line">  # 严格限制</span><br><span class="line">  - job_name: &#x27;controlled-metrics&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;app:8080&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 500</span><br><span class="line"></span><br><span class="line">  行为说明</span><br><span class="line"></span><br><span class="line">  - 超出限制：Prometheus 会降低直方图分辨率以符合限制</span><br><span class="line">  - 无法降低：如果仍然超出限制，抓取会失败</span><br><span class="line">  - 内存考虑：更多桶 = 更多内存使用</span><br><span class="line"></span><br><span class="line">  native_histogram_min_bucket_factor - 最小桶增长因子</span><br><span class="line"></span><br><span class="line">  控制直方图桶的密度，即相邻桶之间的最小增长比例。</span><br><span class="line"></span><br><span class="line">  Schema 对应表</span><br><span class="line"></span><br><span class="line">  # 不同 schema 的配置示例</span><br><span class="line">  - job_name: &#x27;coarse-histogram&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 16      # Schema -2</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;medium-histogram&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 2       # Schema 0</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;fine-histogram&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 1.1     # Schema 2</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;ultra-fine-histogram&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 1.01    # Schema 6</span><br><span class="line"></span><br><span class="line">  常用配置</span><br><span class="line"></span><br><span class="line">  高精度场景</span><br><span class="line"></span><br><span class="line">  # 需要高精度的延迟测量</span><br><span class="line">  - job_name: &#x27;latency-critical&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 1.02    # Schema 5</span><br><span class="line">    native_histogram_bucket_limit: 2000</span><br><span class="line"></span><br><span class="line">  一般监控</span><br><span class="line"></span><br><span class="line">  # 标准业务指标</span><br><span class="line">  - job_name: &#x27;business-metrics&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 2       # Schema 0</span><br><span class="line">    native_histogram_bucket_limit: 1000</span><br><span class="line"></span><br><span class="line">  低精度场景</span><br><span class="line"></span><br><span class="line">  # 粗粒度资源监控</span><br><span class="line">  - job_name: &#x27;resource-usage&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 16      # Schema -2</span><br><span class="line">    native_histogram_bucket_limit: 100</span><br><span class="line"></span><br><span class="line">  convert_classic_histograms_to_nhcb - 经典直方图转换</span><br><span class="line"></span><br><span class="line">  控制是否将传统直方图转换为原生直方图的自定义桶格式。</span><br><span class="line"></span><br><span class="line">  启用条件</span><br><span class="line"></span><br><span class="line">  # 需要在启动时启用 native-histograms 功能</span><br><span class="line">  # ./prometheus --enable-feature=native-histograms</span><br><span class="line"></span><br><span class="line">  配置示例</span><br><span class="line"></span><br><span class="line">  启用转换</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;legacy-histograms&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;legacy-app:8080&#x27;]</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    # 将传统直方图转换为本机格式</span><br><span class="line"></span><br><span class="line">  禁用转换</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;keep-classic&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;classic-app:8080&#x27;]</span><br><span class="line">    convert_classic_histograms_to_nhcb: false</span><br><span class="line">    # 保持传统直方图格式</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  高精度延迟监控</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;latency-monitoring&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;api-gateway:8080&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 5000</span><br><span class="line">    native_histogram_min_bucket_factor: 1.01    # Schema 6 - 超高精度</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    scrape_interval: 15s</span><br><span class="line">    scrape_timeout: 10s</span><br><span class="line"></span><br><span class="line">  通用业务监控</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;business-metrics&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;app:8080&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 1000</span><br><span class="line">    native_histogram_min_bucket_factor: 2       # Schema 0 - 标准精度</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line">    scrape_interval: 30s</span><br><span class="line"></span><br><span class="line">  资源使用监控</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;resource-monitoring&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;node-exporter:9100&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 500</span><br><span class="line">    native_histogram_min_bucket_factor: 4       # Schema -1 - 低精度</span><br><span class="line">    convert_classic_histograms_to_nhcb: false  # 保持传统格式</span><br><span class="line">    scrape_interval: 60s</span><br><span class="line"></span><br><span class="line">  混合环境配置</span><br><span class="line"></span><br><span class="line">  # 高精度服务</span><br><span class="line">  - job_name: &#x27;critical-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;payment-api:8080&#x27;, &#x27;auth-service:8080&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 2000</span><br><span class="line">    native_histogram_min_bucket_factor: 1.04    # Schema 4</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line"></span><br><span class="line">  # 标准服务</span><br><span class="line">  - job_name: &#x27;standard-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;user-service:8080&#x27;, &#x27;order-service:8080&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 1000</span><br><span class="line">    native_histogram_min_bucket_factor: 2       # Schema 0</span><br><span class="line">    convert_classic_histograms_to_nhcb: true</span><br><span class="line"></span><br><span class="line">  # 传统服务</span><br><span class="line">  - job_name: &#x27;legacy-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;legacy-app:8080&#x27;]</span><br><span class="line">    native_histogram_bucket_limit: 0            # 无限制</span><br><span class="line">    native_histogram_min_bucket_factor: 0       # 使用默认</span><br><span class="line">    convert_classic_histograms_to_nhcb: false  # 不转换</span><br><span class="line"></span><br><span class="line">  性能考虑</span><br><span class="line"></span><br><span class="line">  内存使用</span><br><span class="line"></span><br><span class="line">  # 高精度 = 更多内存</span><br><span class="line">  native_histogram_bucket_limit: 5000</span><br><span class="line">  native_histogram_min_bucket_factor: 1.01</span><br><span class="line">  # 可能需要几 MB 内存 per 指标</span><br><span class="line"></span><br><span class="line">  # 低精度 = 更少内存</span><br><span class="line">  native_histogram_bucket_limit: 100</span><br><span class="line">  native_histogram_min_bucket_factor: 16</span><br><span class="line">  # 只需要几百 KB 内存 per 指标</span><br><span class="line"></span><br><span class="line">  网络传输</span><br><span class="line"></span><br><span class="line">  # 更高精度 = 更大的网络负载</span><br><span class="line">  - job_name: &#x27;network-sensitive&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 4       # 适中的精度</span><br><span class="line">    native_histogram_bucket_limit: 500          # 合理的桶数</span><br><span class="line"></span><br><span class="line">  存储成本</span><br><span class="line"></span><br><span class="line">  # 根据存储预算调整</span><br><span class="line">  - job_name: &#x27;cost-optimized&#x27;</span><br><span class="line">    native_histogram_bucket_limit: 200          # 限制存储</span><br><span class="line">    native_histogram_min_bucket_factor: 8       # 较低的精度</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 分层配置</span><br><span class="line"></span><br><span class="line">  # 关键业务指标 - 高精度</span><br><span class="line">  - job_name: &#x27;critical-metrics&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 1.04</span><br><span class="line">    native_histogram_bucket_limit: 2000</span><br><span class="line"></span><br><span class="line">  # 一般业务指标 - 标准精度</span><br><span class="line">  - job_name: &#x27;standard-metrics&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 2</span><br><span class="line">    native_histogram_bucket_limit: 1000</span><br><span class="line"></span><br><span class="line">  # 基础设施指标 - 低精度</span><br><span class="line">  - job_name: &#x27;infra-metrics&#x27;</span><br><span class="line">    native_histogram_min_bucket_factor: 16</span><br><span class="line">    native_histogram_bucket_limit: 500</span><br><span class="line"></span><br><span class="line">  2. 渐进式迁移</span><br><span class="line"></span><br><span class="line">  # 阶段 1: 禁用转换</span><br><span class="line">  convert_classic_histograms_to_nhcb: false</span><br><span class="line"></span><br><span class="line">  # 阶段 2: 启用转换，保守限制</span><br><span class="line">  convert_classic_histograms_to_nhcb: true</span><br><span class="line">  native_histogram_bucket_limit: 500</span><br><span class="line">  native_histogram_min_bucket_factor: 4</span><br><span class="line"></span><br><span class="line">  # 阶段 3: 优化配置</span><br><span class="line">  native_histogram_bucket_limit: 1000</span><br><span class="line">  native_histogram_min_bucket_factor: 2</span><br><span class="line"></span><br><span class="line">  3. 监控和调优</span><br><span class="line"></span><br><span class="line">  # 定期检查直方图性能</span><br><span class="line">  - job_name: &#x27;histogram-monitoring&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;prometheus:9090&#x27;]</span><br><span class="line">    # 监控 native_histogram 相关指标</span><br><span class="line"></span><br><span class="line">  原生直方图是 Prometheus 的重大改进，提供了更好的精度、性能和存储效率，但需要合理配置以平衡精度和资源使用。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>growth factor + resulting schema AKA scale</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">正确的换算公式</span><br><span class="line"></span><br><span class="line">根据 OpenTelemetry 的指数直方图规范：</span><br><span class="line"></span><br><span class="line">growth_factor = 2^(1/2^scale)</span><br><span class="line"></span><br><span class="line">让我们验证：</span><br><span class="line"></span><br><span class="line">Schema 0</span><br><span class="line"></span><br><span class="line">growth_factor = 2^(1/2^0) = 2^(1/1) = 2^1 = 2 ✓</span><br><span class="line"></span><br><span class="line">Schema 1</span><br><span class="line"></span><br><span class="line">growth_factor = 2^(1/2^1) = 2^(1/2) = 2^0.5 ≈ 1.414 ≈ 1.4 ✓</span><br><span class="line"></span><br><span class="line">Schema 2</span><br><span class="line"></span><br><span class="line">growth_factor = 2^(1/2^2) = 2^(1/4) = 2^0.25 ≈ 1.189 ≈ 1.1 ✓</span><br><span class="line"></span><br><span class="line">Schema -1</span><br><span class="line"></span><br><span class="line">growth_factor = 2^(1/2^-1) = 2^(2/1) = 2^2 = 4 ✓</span><br><span class="line"></span><br><span class="line">Schema -2</span><br><span class="line"></span><br><span class="line">growth_factor = 2^(1/2^-2) = 2^(4/1) = 2^4 = 16 ✓</span><br><span class="line"></span><br><span class="line">负数 Schema 的计算</span><br><span class="line"></span><br><span class="line">对于负数 schema：</span><br><span class="line"></span><br><span class="line">Schema -1</span><br><span class="line"></span><br><span class="line">scale = -1</span><br><span class="line">growth_factor = 2^(1/2^-1) = 2^(2) = 4</span><br><span class="line"></span><br><span class="line">Schema -2</span><br><span class="line"></span><br><span class="line">scale = -2</span><br><span class="line">growth_factor = 2^(1/2^-2) = 2^(4) = 16</span><br><span class="line"></span><br><span class="line">Schema -3</span><br><span class="line"></span><br><span class="line">scale = -3</span><br><span class="line">growth_factor = 2^(1/2^-3) = 2^(8) = 256</span><br><span class="line"></span><br><span class="line">Schema -4</span><br><span class="line"></span><br><span class="line">scale = -4</span><br><span class="line">growth_factor = 2^(1/2^-4) = 2^(16) = 65536</span><br><span class="line"></span><br><span class="line">逆向计算</span><br><span class="line"></span><br><span class="line">从 growth_factor 计算 scale</span><br><span class="line"></span><br><span class="line">scale = log₂(1) / log₂(log₂(growth_factor))</span><br><span class="line"></span><br><span class="line">更准确的公式：</span><br><span class="line">scale = -log₂(log₂(growth_factor))</span><br><span class="line"></span><br><span class="line">示例计算</span><br><span class="line"></span><br><span class="line">growth_factor = 2</span><br><span class="line"></span><br><span class="line">scale = -log₂(log₂(2)) = -log₂(1) = -0 = 0 ✓</span><br><span class="line"></span><br><span class="line">growth_factor = 4</span><br><span class="line"></span><br><span class="line">scale = -log₂(log₂(4)) = -log₂(2) = -1 ✓</span><br><span class="line"></span><br><span class="line">growth_factor = 1.4</span><br><span class="line"></span><br><span class="line">scale = -log₂(log₂(1.4)) = -log₂(0.485) ≈ -(-1.04) ≈ 1 ✓</span><br><span class="line"></span><br><span class="line">桶边界计算</span><br><span class="line"></span><br><span class="line">桶边界公式</span><br><span class="line"></span><br><span class="line">base = 2^scale</span><br><span class="line">bucket_boundary = base * growth_factor^bucket_index</span><br><span class="line"></span><br><span class="line">示例：Schema 0, growth_factor = 2</span><br><span class="line"></span><br><span class="line">base = 2^0 = 1</span><br><span class="line">桶边界序列: 1, 2, 4, 8, 16, 32, ...</span><br><span class="line"></span><br><span class="line">示例：Schema 1, growth_factor = 1.4</span><br><span class="line"></span><br><span class="line">base = 2^1 = 2</span><br><span class="line">桶边界序列: 2, 2.8, 3.92, 5.49, 7.69, ...</span><br><span class="line"></span><br><span class="line">实际配置示例</span><br><span class="line"></span><br><span class="line">计算特定精度需求</span><br><span class="line"></span><br><span class="line">如果需要 growth_factor = 1.5：</span><br><span class="line">import math</span><br><span class="line"></span><br><span class="line">def calculate_scale_from_growth_factor(gf):</span><br><span class="line">    return -math.log2(math.log2(gf))</span><br><span class="line"></span><br><span class="line">scale = calculate_scale_from_growth_factor(1.5)</span><br><span class="line">print(f&quot;Scale: &#123;scale&#125;&quot;)</span><br><span class="line"># Scale: 0.737 (约等于 0.7)</span><br><span class="line"></span><br><span class="line">由于 schema 必须是整数，所以会选择最接近的 schema = 0 或 schema = 1</span><br><span class="line"></span><br><span class="line">自定义配置</span><br><span class="line"></span><br><span class="line"># 如果想要约 1.3 的 growth factor</span><br><span class="line"># 需要在 schema 1 (1.4) 和 schema 2 (1.1) 之间选择</span><br><span class="line">- job_name: &#x27;custom-precision&#x27;</span><br><span class="line">  # 选择 schema 1: growth_factor = 1.4 (较高精度)</span><br><span class="line">  native_histogram_min_bucket_factor: 1.4</span><br><span class="line"></span><br><span class="line">精度对比</span><br><span class="line"></span><br><span class="line">Schema 精度递减</span><br><span class="line"></span><br><span class="line">Schema -4: growth_factor = 65536 (极粗糙)</span><br><span class="line">Schema -3: growth_factor = 256   (很粗糙)</span><br><span class="line">Schema -2: growth_factor = 16    (粗糙)</span><br><span class="line">Schema -1: growth_factor = 4     (较粗糙)</span><br><span class="line">Schema  0: growth_factor = 2     (标准)</span><br><span class="line">Schema  1: growth_factor = 1.4   (较精细)</span><br><span class="line">Schema  2: growth_factor = 1.1   (精细)</span><br><span class="line">Schema  3: growth_factor = 1.09  (很精细)</span><br><span class="line">Schema  4: growth_factor = 1.04  (非常精细)</span><br><span class="line">Schema  5: growth_factor = 1.02  (极精细)</span><br><span class="line">Schema  6: growth_factor = 1.01  (超精细)</span><br><span class="line">Schema  7: growth_factor = 1.005 (极致精细)</span><br><span class="line">Schema  8: growth_factor = 1.002 (最精细)</span><br><span class="line"></span><br><span class="line">选择建议</span><br><span class="line"></span><br><span class="line">基于用例选择</span><br><span class="line"></span><br><span class="line"># 延迟监控 - 需要高精度</span><br><span class="line">native_histogram_min_bucket_factor: 1.04  # Schema 4</span><br><span class="line"></span><br><span class="line"># 计数器 - 中等精度即可</span><br><span class="line">native_histogram_min_bucket_factor: 2     # Schema 0</span><br><span class="line"></span><br><span class="line"># 流量监控 - 低精度够用</span><br><span class="line">native_histogram_min_bucket_factor: 16    # Schema -2</span><br><span class="line"></span><br><span class="line">理解这个换算关系有助于根据具体的监控需求选择最合适的精度级别。</span><br></pre></td></tr></table></figure>

<h4 id="http-config"><a href="#http-config" class="headerlink" title="http_config"></a>http_config</h4><p>A http_config allows configuring HTTP requests.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这些配置项构成了 Prometheus 的 HTTP 客户端认证和安全设置，提供了多种方式来访问受保护的监控端点。</span><br><span class="line"></span><br><span class="line">  basic_auth - 基础认证</span><br><span class="line"></span><br><span class="line">  使用 HTTP Basic Authentication 进行身份验证。</span><br><span class="line"></span><br><span class="line">  配置方式</span><br><span class="line"></span><br><span class="line">  # 直接配置用户名密码</span><br><span class="line">  basic_auth:</span><br><span class="line">    username: &quot;prometheus&quot;</span><br><span class="line">    password: &quot;secure_password&quot;</span><br><span class="line"></span><br><span class="line">  # 从文件读取（推荐，更安全）</span><br><span class="line">  basic_auth:</span><br><span class="line">    username_file: &quot;/etc/prometheus/username.txt&quot;</span><br><span class="line">    password_file: &quot;/etc/prometheus/password.txt&quot;</span><br><span class="line"></span><br><span class="line">  安全最佳实践</span><br><span class="line"></span><br><span class="line">  # 生产环境推荐配置</span><br><span class="line">  basic_auth:</span><br><span class="line">    username_file: &quot;/etc/prometheus/secrets/username&quot;</span><br><span class="line">    password_file: &quot;/etc/prometheus/secrets/password&quot;</span><br><span class="line"></span><br><span class="line">  文件权限</span><br><span class="line"></span><br><span class="line">  # 设置安全的文件权限</span><br><span class="line">  chmod 600 /etc/prometheus/secrets/username</span><br><span class="line">  chmod 600 /etc/prometheus/secrets/password</span><br><span class="line">  chown prometheus:prometheus /etc/prometheus/secrets/*</span><br><span class="line"></span><br><span class="line">  authorization - 令牌认证</span><br><span class="line"></span><br><span class="line">  使用自定义的 Authorization 头进行身份验证。</span><br><span class="line"></span><br><span class="line">  Bearer Token 配置</span><br><span class="line"></span><br><span class="line">  # 直接配置令牌</span><br><span class="line">  authorization:</span><br><span class="line">    type: &quot;Bearer&quot;</span><br><span class="line">    credentials: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><br><span class="line"></span><br><span class="line">  # 从文件读取令牌（推荐）</span><br><span class="line">  authorization:</span><br><span class="line">    type: &quot;Bearer&quot;</span><br><span class="line">    credentials_file: &quot;/etc/prometheus/secrets/bearer_token.txt&quot;</span><br><span class="line"></span><br><span class="line">  自定义认证类型</span><br><span class="line"></span><br><span class="line">  # API Key 认证</span><br><span class="line">  authorization:</span><br><span class="line">    type: &quot;ApiKey&quot;</span><br><span class="line">    credentials: &quot;your-api-key-here&quot;</span><br><span class="line"></span><br><span class="line">  # 自定义认证头</span><br><span class="line">  authorization:</span><br><span class="line">    type: &quot;CustomAuth&quot;</span><br><span class="line">    credentials: &quot;custom_auth_token&quot;</span><br><span class="line"></span><br><span class="line">  多种认证方案示例</span><br><span class="line"></span><br><span class="line">  # JWT Token</span><br><span class="line">  authorization:</span><br><span class="line">    type: &quot;JWT&quot;</span><br><span class="line">    credentials_file: &quot;/etc/prometheus/secrets/jwt_token&quot;</span><br><span class="line"></span><br><span class="line">  # AWS Signature (简化示例)</span><br><span class="line">  authorization:</span><br><span class="line">    type: &quot;AWS4-HMAC-SHA256&quot;</span><br><span class="line">    credentials_file: &quot;/etc/prometheus/secrets/aws_creds&quot;</span><br><span class="line"></span><br><span class="line">  oauth2 - OAuth 2.0 认证</span><br><span class="line"></span><br><span class="line">  使用 OAuth 2.0 流程进行身份验证。</span><br><span class="line"></span><br><span class="line">  完整 OAuth 2.0 配置</span><br><span class="line"></span><br><span class="line">  oauth2:</span><br><span class="line">    client_id: &quot;prometheus-client&quot;</span><br><span class="line">    client_secret_file: &quot;/etc/prometheus/secrets/oauth_client_secret&quot;</span><br><span class="line">    token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">    scopes: [&quot;metrics:read&quot;]</span><br><span class="line">    endpoint_params:</span><br><span class="line">      audience: &quot;prometheus&quot;</span><br><span class="line"></span><br><span class="line">  OAuth 2.0 参数详解</span><br><span class="line"></span><br><span class="line">  oauth2:</span><br><span class="line">    # 客户端 ID</span><br><span class="line">    client_id: &quot;your-client-id&quot;</span><br><span class="line"></span><br><span class="line">    # 客户端密钥（可以从文件读取）</span><br><span class="line">    client_secret: &quot;your-client-secret&quot;</span><br><span class="line">    # 或者</span><br><span class="line">    client_secret_file: &quot;/path/to/client_secret&quot;</span><br><span class="line"></span><br><span class="line">    # 获取令牌的端点</span><br><span class="line">    token_url: &quot;https://oauth.example.com/token&quot;</span><br><span class="line"></span><br><span class="line">    # 请求的权限范围</span><br><span class="line">    scopes: [&quot;read&quot;, &quot;metrics&quot;]</span><br><span class="line"></span><br><span class="line">    # 额外的端点参数</span><br><span class="line">    endpoint_params:</span><br><span class="line">      grant_type: &quot;client_credentials&quot;</span><br><span class="line">      audience: &quot;api.example.com&quot;</span><br><span class="line"></span><br><span class="line">    # TLS 配置</span><br><span class="line">    tls_config:</span><br><span class="line">      insecure_skip_verify: false</span><br><span class="line">      ca_file: &quot;/etc/ssl/certs/ca.crt&quot;</span><br><span class="line"></span><br><span class="line">  follow_redirects - 跟随重定向</span><br><span class="line"></span><br><span class="line">  控制是否跟随 HTTP 3xx 重定向。</span><br><span class="line"></span><br><span class="line">  配置示例</span><br><span class="line"></span><br><span class="line">  # 跟随重定向（默认）</span><br><span class="line">  follow_redirects: true</span><br><span class="line"></span><br><span class="line">  # 不跟随重定向</span><br><span class="line">  follow_redirects: false</span><br><span class="line"></span><br><span class="line">  使用场景</span><br><span class="line"></span><br><span class="line">  # 严格的安全策略 - 不跟随重定向</span><br><span class="line">  - job_name: &#x27;secure-endpoints&#x27;</span><br><span class="line">    follow_redirects: false</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;secure-api.example.com&#x27;]</span><br><span class="line"></span><br><span class="line">  # 灵活的监控 - 跟随重定向</span><br><span class="line">  - job_name: &#x27;web-monitoring&#x27;</span><br><span class="line">    follow_redirects: true</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;web.example.com&#x27;]</span><br><span class="line"></span><br><span class="line">  enable_http2 - HTTP/2 支持</span><br><span class="line"></span><br><span class="line">  控制是否启用 HTTP/2 协议。</span><br><span class="line"></span><br><span class="line">  配置示例</span><br><span class="line"></span><br><span class="line">  # 启用 HTTP/2（默认）</span><br><span class="line">  enable_http2: true</span><br><span class="line"></span><br><span class="line">  # 禁用 HTTP/2</span><br><span class="line">  enable_http2: false</span><br><span class="line"></span><br><span class="line">  兼容性考虑</span><br><span class="line"></span><br><span class="line">  # 旧服务兼容性</span><br><span class="line">  - job_name: &#x27;legacy-services&#x27;</span><br><span class="line">    enable_http2: false</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;legacy-app:8080&#x27;]</span><br><span class="line"></span><br><span class="line">  # 现代服务</span><br><span class="line">  - job_name: &#x27;modern-services&#x27;</span><br><span class="line">    enable_http2: true</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;modern-app:8080&#x27;]</span><br><span class="line"></span><br><span class="line">  tls_config - TLS 配置</span><br><span class="line"></span><br><span class="line">  配置 HTTPS 连接的安全设置。</span><br><span class="line"></span><br><span class="line">  基础 TLS 配置</span><br><span class="line"></span><br><span class="line">  tls_config:</span><br><span class="line">    # 跳过证书验证（仅测试环境）</span><br><span class="line">    insecure_skip_verify: true</span><br><span class="line"></span><br><span class="line">    # CA 证书</span><br><span class="line">    ca_file: &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br><span class="line"></span><br><span class="line">    # 客户端证书（双向认证）</span><br><span class="line">    cert_file: &quot;/etc/prometheus/certs/client.crt&quot;</span><br><span class="line">    key_file: &quot;/etc/prometheus/certs/client.key&quot;</span><br><span class="line"></span><br><span class="line">    # 服务器名称验证</span><br><span class="line">    server_name: &quot;secure.example.com&quot;</span><br><span class="line"></span><br><span class="line">  完整 TLS 配置示例</span><br><span class="line"></span><br><span class="line">  tls_config:</span><br><span class="line">    # CA 证书配置</span><br><span class="line">    ca_file: &quot;/etc/prometheus/certs/ca.crt&quot;</span><br><span class="line">    # 或者</span><br><span class="line">    ca: |</span><br><span class="line">      -----BEGIN CERTIFICATE-----</span><br><span class="line">      MIIC...</span><br><span class="line">      -----END CERTIFICATE-----</span><br><span class="line"></span><br><span class="line">    # 客户端证书</span><br><span class="line">    cert_file: &quot;/etc/prometheus/certs/client.crt&quot;</span><br><span class="line">    key_file: &quot;/etc/prometheus/certs/client.key&quot;</span><br><span class="line"></span><br><span class="line">    # 服务器名称验证</span><br><span class="line">    server_name: &quot;metrics.example.com&quot;</span><br><span class="line"></span><br><span class="line">    # 禁用不安全的协议</span><br><span class="line">    min_version: &quot;TLS12&quot;</span><br><span class="line">    max_version: &quot;TLS13&quot;</span><br><span class="line"></span><br><span class="line">    # 密码套件</span><br><span class="line">    cipher_suites:</span><br><span class="line">      - &quot;TLS_RSA_WITH_AES_128_CBC_SHA&quot;</span><br><span class="line">      - &quot;TLS_RSA_WITH_AES_256_CBC_SHA&quot;</span><br><span class="line"></span><br><span class="line">    # 跳过验证（仅开发环境）</span><br><span class="line">    insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  代理配置</span><br><span class="line"></span><br><span class="line">  proxy_url - 代理服务器</span><br><span class="line"></span><br><span class="line">  # HTTP 代理</span><br><span class="line">  proxy_url: &quot;http://proxy.example.com:8080&quot;</span><br><span class="line"></span><br><span class="line">  # HTTPS 代理</span><br><span class="line">  proxy_url: &quot;https://secure-proxy.example.com:8080&quot;</span><br><span class="line"></span><br><span class="line">  # 带认证的代理</span><br><span class="line">  proxy_url: &quot;http://user:pass@proxy.example.com:8080&quot;</span><br><span class="line"></span><br><span class="line">  no_proxy - 代理排除</span><br><span class="line"></span><br><span class="line">  proxy_url: &quot;http://proxy.example.com:8080&quot;</span><br><span class="line">  no_proxy: &quot;localhost,127.0.0.1,.internal,*.local&quot;</span><br><span class="line"></span><br><span class="line">  proxy_from_environment - 环境变量代理</span><br><span class="line"></span><br><span class="line">  proxy_from_environment: true</span><br><span class="line">  # 将使用 HTTP_PROXY, HTTPS_PROXY, NO_PROXY 环境变量</span><br><span class="line"></span><br><span class="line">  proxy_connect_header - 代理连接头</span><br><span class="line"></span><br><span class="line">  proxy_connect_header:</span><br><span class="line">    Proxy-Authorization: [&quot;Basic dXNlcjpwYXNz&quot;]</span><br><span class="line">    User-Agent: [&quot;Prometheus/2.0&quot;]</span><br><span class="line"></span><br><span class="line">  http_headers - 自定义 HTTP 头</span><br><span class="line"></span><br><span class="line">  为每个请求添加自定义 HTTP 头。</span><br><span class="line"></span><br><span class="line">  基本配置</span><br><span class="line"></span><br><span class="line">  http_headers:</span><br><span class="line">    # 添加请求头</span><br><span class="line">    User-Agent:</span><br><span class="line">      values: [&quot;Prometheus/2.45.0&quot;]</span><br><span class="line"></span><br><span class="line">    # 添加认证头</span><br><span class="line">    X-API-Key:</span><br><span class="line">      values: [&quot;your-api-key-here&quot;]</span><br><span class="line"></span><br><span class="line">    # 添加追踪头</span><br><span class="line">    X-Request-ID:</span><br><span class="line">      values: [&quot;prometheus-request&quot;]</span><br><span class="line"></span><br><span class="line">  敏感信息配置</span><br><span class="line"></span><br><span class="line">  http_headers:</span><br><span class="line">    # 使用 secrets 隐藏敏感信息</span><br><span class="line">    Authorization:</span><br><span class="line">      secrets: [&quot;bearer_token_here&quot;]</span><br><span class="line"></span><br><span class="line">    # 从文件读取</span><br><span class="line">    X-Custom-Auth:</span><br><span class="line">      files: [&quot;/etc/prometheus/secrets/custom_auth.txt&quot;]</span><br><span class="line"></span><br><span class="line">    # 组合使用</span><br><span class="line">    X-Multiple-Values:</span><br><span class="line">      values: [&quot;public_value&quot;]</span><br><span class="line">      secrets: [&quot;secret_value&quot;]</span><br><span class="line"></span><br><span class="line">  动态配置</span><br><span class="line"></span><br><span class="line">  http_headers:</span><br><span class="line">    # 追踪头</span><br><span class="line">    X-Trace-ID:</span><br><span class="line">      values: [&quot;$&#123;env:TRACE_ID&#125;&quot;]</span><br><span class="line"></span><br><span class="line">    # 环境标识</span><br><span class="line">    X-Environment:</span><br><span class="line">      values: [&quot;production&quot;]</span><br><span class="line"></span><br><span class="line">    # 版本信息</span><br><span class="line">    X-Client-Version:</span><br><span class="line">      values: [&quot;prometheus-2.45.0&quot;]</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  企业级安全配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;secure-api&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;api.example.com:443&#x27;]</span><br><span class="line"></span><br><span class="line">      # OAuth 2.0 认证</span><br><span class="line">      oauth2:</span><br><span class="line">        client_id: &quot;prometheus-client&quot;</span><br><span class="line">        client_secret_file: &quot;/etc/prometheus/secrets/oauth_secret&quot;</span><br><span class="line">        token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">        scopes: [&quot;metrics:read&quot;]</span><br><span class="line"></span><br><span class="line">      # TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/prometheus/certs/ca.crt&quot;</span><br><span class="line">        cert_file: &quot;/etc/prometheus/certs/client.crt&quot;</span><br><span class="line">        key_file: &quot;/etc/prometheus/certs/client.key&quot;</span><br><span class="line">        server_name: &quot;api.example.com&quot;</span><br><span class="line">        min_version: &quot;TLS12&quot;</span><br><span class="line"></span><br><span class="line">      # 自定义头</span><br><span class="line">      http_headers:</span><br><span class="line">        X-Client-Name:</span><br><span class="line">          values: [&quot;prometheus&quot;]</span><br><span class="line">        X-Environment:</span><br><span class="line">          values: [&quot;production&quot;]</span><br><span class="line"></span><br><span class="line">      # 代理配置</span><br><span class="line">      proxy_url: &quot;http://corporate-proxy:8080&quot;</span><br><span class="line">      no_proxy: &quot;localhost,.internal&quot;</span><br><span class="line"></span><br><span class="line">      # HTTP 配置</span><br><span class="line">      follow_redirects: true</span><br><span class="line">      enable_http2: true</span><br><span class="line"></span><br><span class="line">  简单内部服务配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;internal-service&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;service:8080&#x27;]</span><br><span class="line"></span><br><span class="line">      # 基础认证</span><br><span class="line">      basic_auth:</span><br><span class="line">        username_file: &quot;/etc/prometheus/secrets/username&quot;</span><br><span class="line">        password_file: &quot;/etc/prometheus/secrets/password&quot;</span><br><span class="line"></span><br><span class="line">      # 自定义头</span><br><span class="line">      http_headers:</span><br><span class="line">        X-Monitoring:</span><br><span class="line">          values: [&quot;prometheus&quot;]</span><br><span class="line"></span><br><span class="line">  这些配置为 Prometheus 提供了全面的安全认证能力，能够适应各种企业级安全需求。</span><br></pre></td></tr></table></figure>

<h4 id="tls-config"><a href="#tls-config" class="headerlink" title="tls_config"></a>tls_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line">⏺ tls_config 是 Prometheus 中配置 TLS (Transport Layer Security) 连接的核心组件，用于保护 HTTPS 连接的安全性。</span><br><span class="line"></span><br><span class="line">  CA 证书配置</span><br><span class="line"></span><br><span class="line">  验证服务器证书</span><br><span class="line"></span><br><span class="line">  # 直接配置 CA 证书内容</span><br><span class="line">  tls_config:</span><br><span class="line">    ca: |</span><br><span class="line">      -----BEGIN CERTIFICATE-----</span><br><span class="line">      MIICljCCAX4CCQCKLyqR1MOqTzANBgkqhkiG9w0BAQsFADCBjDELMAkGA1UEBhMC</span><br><span class="line">      VVMxCzAJBgNVBAgMAkNBMRYwFAYDVQQHDA1TYW4gRnJhbmNpc2NvMRMwEQYDVQQK</span><br><span class="line">      DApFeGFtcGxlIE9yZzEUMBIGA1UECwwLRXhhbXBsZSBVbml0MRcwFQYDVQQDDA5l</span><br><span class="line">      eGFtcGxlLmNvbS90bHMwHhcNMjQwMTAxMDAwMDAwWhcNMjUwMTAxMDAwMDAwWjCB</span><br><span class="line">      jDELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkNBMRYwFAYDVQQHDA1TYW4gRnJhbmNp</span><br><span class="line">      c2NvMRMwEQYDVQQKDApFeGFtcGxlIE9yZzEUMBIGA1UECwwLRXhhbXBsZSBVbml0</span><br><span class="line">      MRcwFQYDVQQDDA5leGFtcGxlLmNvbS90bHMwggEiMA0GCSqGSIb3DQEBAQUAA4IB</span><br><span class="line">      DwAwggEKAoIBAQC...</span><br><span class="line">      -----END CERTIFICATE-----</span><br><span class="line"></span><br><span class="line">  # 从文件读取 CA 证书（推荐）</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &quot;/etc/prometheus/certs/ca.crt&quot;</span><br><span class="line"></span><br><span class="line">  文件组织结构</span><br><span class="line"></span><br><span class="line">  /etc/prometheus/certs/</span><br><span class="line">  ├── ca.crt              # CA 根证书</span><br><span class="line">  ├── client.crt          # 客户端证书</span><br><span class="line">  ├── client.key          # 客户端私钥</span><br><span class="line">  └── internal-ca.crt     # 内部 CA 证书</span><br><span class="line"></span><br><span class="line">  客户端证书认证</span><br><span class="line"></span><br><span class="line">  双向 TLS (mTLS) 配置</span><br><span class="line"></span><br><span class="line">  tls_config:</span><br><span class="line">    # CA 证书</span><br><span class="line">    ca_file: &quot;/etc/prometheus/certs/ca.crt&quot;</span><br><span class="line"></span><br><span class="line">    # 客户端证书</span><br><span class="line">    cert_file: &quot;/etc/prometheus/certs/client.crt&quot;</span><br><span class="line">    key_file: &quot;/etc/prometheus/certs/client.key&quot;</span><br><span class="line"></span><br><span class="line">    # 或者直接配置</span><br><span class="line">    cert: |</span><br><span class="line">      -----BEGIN CERTIFICATE-----</span><br><span class="line">      MIICkDCCAfagAwIBAgIU...</span><br><span class="line">      -----END CERTIFICATE-----</span><br><span class="line">    key: |</span><br><span class="line">      -----BEGIN PRIVATE KEY-----</span><br><span class="line">      MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC...</span><br><span class="line">      -----END PRIVATE KEY-----</span><br><span class="line"></span><br><span class="line">  多环境客户端证书</span><br><span class="line"></span><br><span class="line">  # 开发环境</span><br><span class="line">  - job_name: &#x27;dev-services&#x27;</span><br><span class="line">    tls_config:</span><br><span class="line">      ca_file: &quot;/etc/prometheus/certs/dev-ca.crt&quot;</span><br><span class="line">      cert_file: &quot;/etc/prometheus/certs/dev-client.crt&quot;</span><br><span class="line">      key_file: &quot;/etc/prometheus/certs/dev-client.key&quot;</span><br><span class="line"></span><br><span class="line">  # 生产环境</span><br><span class="line">  - job_name: &#x27;prod-services&#x27;</span><br><span class="line">    tls_config:</span><br><span class="line">      ca_file: &quot;/etc/prometheus/certs/prod-ca.crt&quot;</span><br><span class="line">      cert_file: &quot;/etc/prometheus/certs/prod-client.crt&quot;</span><br><span class="line">      key_file: &quot;/etc/prometheus/certs/prod-client.key&quot;</span><br><span class="line"></span><br><span class="line">  服务器名称验证</span><br><span class="line"></span><br><span class="line">  防止中间人攻击</span><br><span class="line"></span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &quot;/etc/prometheus/certs/ca.crt&quot;</span><br><span class="line">    server_name: &quot;secure-api.example.com&quot;</span><br><span class="line"></span><br><span class="line">    # 或者使用 IP 地址</span><br><span class="line">    server_name: &quot;192.168.1.100&quot;</span><br><span class="line"></span><br><span class="line">  证书名称匹配</span><br><span class="line"></span><br><span class="line">  # 证书中的 CN 或 SAN 必须匹配</span><br><span class="line">  tls_config:</span><br><span class="line">    server_name: &quot;metrics.internal.company.com&quot;</span><br><span class="line">    # 证书应包含：</span><br><span class="line">    # CN: metrics.internal.company.com</span><br><span class="line">    # 或 SAN: DNS:metrics.internal.company.com</span><br><span class="line"></span><br><span class="line">  跳过证书验证</span><br><span class="line"></span><br><span class="line">  仅用于测试环境</span><br><span class="line"></span><br><span class="line">  # 危险：仅用于开发和测试</span><br><span class="line">  tls_config:</span><br><span class="line">    insecure_skip_verify: true</span><br><span class="line"></span><br><span class="line">  # 测试环境示例</span><br><span class="line">  - job_name: &#x27;test-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;test-app:8080&#x27;]</span><br><span class="line">    tls_config:</span><br><span class="line">      ca_file: &quot;/etc/prometheus/certs/test-ca.crt&quot;</span><br><span class="line">      insecure_skip_verify: true  # 测试证书可能无效</span><br><span class="line"></span><br><span class="line">  生产环境警告</span><br><span class="line"></span><br><span class="line">  # ❌ 生产环境不要这样做</span><br><span class="line">  - job_name: &#x27;production&#x27;</span><br><span class="line">    tls_config:</span><br><span class="line">      insecure_skip_verify: true  # 安全风险！</span><br><span class="line"></span><br><span class="line">  # ✅ 生产环境正确配置</span><br><span class="line">  - job_name: &#x27;production&#x27;</span><br><span class="line">    tls_config:</span><br><span class="line">      ca_file: &quot;/etc/prometheus/certs/prod-ca.crt&quot;</span><br><span class="line">      server_name: &quot;prod-api.example.com&quot;</span><br><span class="line">      insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  TLS 版本控制</span><br><span class="line"></span><br><span class="line">  版本配置</span><br><span class="line"></span><br><span class="line">  # 现代 TLS 配置</span><br><span class="line">  tls_config:</span><br><span class="line">    min_version: &quot;TLS12&quot;    # 最低 TLS 1.2</span><br><span class="line">    max_version: &quot;TLS13&quot;    # 最高 TLS 1.3</span><br><span class="line"></span><br><span class="line">  # 高安全性配置</span><br><span class="line">  tls_config:</span><br><span class="line">    min_version: &quot;TLS13&quot;    # 仅允许 TLS 1.3</span><br><span class="line">    max_version: &quot;TLS13&quot;</span><br><span class="line"></span><br><span class="line">  # 兼容旧系统配置</span><br><span class="line">  tls_config:</span><br><span class="line">    min_version: &quot;TLS11&quot;    # 允许 TLS 1.1+</span><br><span class="line">    max_version: &quot;TLS12&quot;    # 最高 TLS 1.2</span><br><span class="line"></span><br><span class="line">  版本兼容性矩阵</span><br><span class="line"></span><br><span class="line">  # 现代系统 (推荐)</span><br><span class="line">  tls_config:</span><br><span class="line">    min_version: &quot;TLS12&quot;</span><br><span class="line">    max_version: &quot;TLS13&quot;</span><br><span class="line"></span><br><span class="line">  # 企业内部系统</span><br><span class="line">  tls_config:</span><br><span class="line">    min_version: &quot;TLS12&quot;</span><br><span class="line">    max_version: &quot;TLS12&quot;</span><br><span class="line"></span><br><span class="line">  # 兼容遗留系统</span><br><span class="line">  tls_config:</span><br><span class="line">    min_version: &quot;TLS10&quot;</span><br><span class="line">    max_version: &quot;TLS12&quot;</span><br><span class="line"></span><br><span class="line">  # 最高安全</span><br><span class="line">  tls_config:</span><br><span class="line">    min_version: &quot;TLS13&quot;</span><br><span class="line">    max_version: &quot;TLS13&quot;</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  企业级安全配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;secure-corporate-api&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;api.company.com:443&#x27;]</span><br><span class="line"></span><br><span class="line">      # OAuth 2.0 认证</span><br><span class="line">      oauth2:</span><br><span class="line">        client_id: &quot;prometheus-corporate&quot;</span><br><span class="line">        client_secret_file: &quot;/etc/prometheus/secrets/oauth_secret&quot;</span><br><span class="line">        token_url: &quot;https://auth.company.com/oauth2/token&quot;</span><br><span class="line">        scopes: [&quot;metrics:read&quot;]</span><br><span class="line"></span><br><span class="line">        # OAuth 令牌端点的 TLS 配置</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &quot;/etc/prometheus/certs/corporate-ca.crt&quot;</span><br><span class="line">          server_name: &quot;auth.company.com&quot;</span><br><span class="line">          min_version: &quot;TLS12&quot;</span><br><span class="line">          max_version: &quot;TLS13&quot;</span><br><span class="line"></span><br><span class="line">      # 目标服务的 TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/prometheus/certs/corporate-ca.crt&quot;</span><br><span class="line">        cert_file: &quot;/etc/prometheus/certs/prometheus-client.crt&quot;</span><br><span class="line">        key_file: &quot;/etc/prometheus/certs/prometheus-client.key&quot;</span><br><span class="line">        server_name: &quot;api.company.com&quot;</span><br><span class="line">        min_version: &quot;TLS12&quot;</span><br><span class="line">        max_version: &quot;TLS13&quot;</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">      # 自定义头</span><br><span class="line">      http_headers:</span><br><span class="line">        X-Client-Name:</span><br><span class="line">          values: [&quot;prometheus&quot;]</span><br><span class="line">        X-Department:</span><br><span class="line">          values: [&quot;observability&quot;]</span><br><span class="line"></span><br><span class="line">  云服务配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;cloud-provider-metrics&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;metrics.cloud-provider.com&#x27;]</span><br><span class="line"></span><br><span class="line">      tls_config:</span><br><span class="line">        # 使用系统 CA 证书</span><br><span class="line">        ca_file: &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br><span class="line">        server_name: &quot;metrics.cloud-provider.com&quot;</span><br><span class="line">        min_version: &quot;TLS12&quot;</span><br><span class="line">        max_version: &quot;TLS13&quot;</span><br><span class="line"></span><br><span class="line">        # 客户端证书认证</span><br><span class="line">        cert_file: &quot;/etc/prometheus/certs/cloud-client.crt&quot;</span><br><span class="line">        key_file: &quot;/etc/prometheus/certs/cloud-client.key&quot;</span><br><span class="line"></span><br><span class="line">  开发环境配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;dev-services&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;dev-app:8080&#x27;]</span><br><span class="line"></span><br><span class="line">      # 开发环境 TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/prometheus/certs/dev-ca.crt&quot;</span><br><span class="line">        server_name: &quot;dev-app.local&quot;</span><br><span class="line">        min_version: &quot;TLS12&quot;</span><br><span class="line">        insecure_skip_verify: false  # 使用自签名证书</span><br><span class="line"></span><br><span class="line">      # 简单认证</span><br><span class="line">      basic_auth:</span><br><span class="line">        username_file: &quot;/etc/prometheus/secrets/dev_user&quot;</span><br><span class="line">        password_file: &quot;/etc/prometheus/secrets/dev_pass&quot;</span><br><span class="line"></span><br><span class="line">  微服务网格配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;service-mesh&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpoints</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&quot;mesh&quot;]</span><br><span class="line"></span><br><span class="line">      # 服务网格 TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/prometheus/certs/mesh-ca.crt&quot;</span><br><span class="line">        cert_file: &quot;/etc/prometheus/certs/mesh-client.crt&quot;</span><br><span class="line">        key_file: &quot;/etc/prometheus/certs/mesh-client.key&quot;</span><br><span class="line">        server_name: &quot;mesh-gateway.local&quot;</span><br><span class="line">        min_version: &quot;TLS12&quot;</span><br><span class="line">        max_version: &quot;TLS13&quot;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpoint_ready]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: true</span><br><span class="line"></span><br><span class="line">  安全最佳实践</span><br><span class="line"></span><br><span class="line">  1. 文件权限管理</span><br><span class="line"></span><br><span class="line">  # 设置安全的文件权限</span><br><span class="line">  sudo mkdir -p /etc/prometheus/certs</span><br><span class="line">  sudo mkdir -p /etc/prometheus/secrets</span><br><span class="line"></span><br><span class="line">  # 证书文件权限</span><br><span class="line">  sudo chmod 644 /etc/prometheus/certs/*.crt</span><br><span class="line">  sudo chmod 600 /etc/prometheus/certs/*.key</span><br><span class="line">  sudo chmod 600 /etc/prometheus/secrets/*</span><br><span class="line"></span><br><span class="line">  # 所有者设置</span><br><span class="line">  sudo chown -R prometheus:prometheus /etc/prometheus/certs</span><br><span class="line">  sudo chown -R prometheus:prometheus /etc/prometheus/secrets</span><br><span class="line"></span><br><span class="line">  2. 证书轮换策略</span><br><span class="line"></span><br><span class="line">  # 使用符号链接便于证书轮换</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &quot;/etc/prometheus/certs/current/ca.crt&quot;</span><br><span class="line">    cert_file: &quot;/etc/prometheus/certs/current/client.crt&quot;</span><br><span class="line">    key_file: &quot;/etc/prometheus/certs/current/client.key&quot;</span><br><span class="line"></span><br><span class="line">  3. 监控 TLS 连接</span><br><span class="line"></span><br><span class="line">  # 监控 TLS 相关指标</span><br><span class="line">  - job_name: &#x27;prometheus-self&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">    # 可以监控 prometheus_http_server_tls_errors_total 等指标</span><br><span class="line"></span><br><span class="line">  4. 环境分离</span><br><span class="line"></span><br><span class="line">  /etc/prometheus/</span><br><span class="line">  ├── certs/</span><br><span class="line">  │   ├── dev/</span><br><span class="line">  │   │   ├── ca.crt</span><br><span class="line">  │   │   ├── client.crt</span><br><span class="line">  │   │   └── client.key</span><br><span class="line">  │   ├── staging/</span><br><span class="line">  │   │   ├── ca.crt</span><br><span class="line">  │   │   ├── client.crt</span><br><span class="line">  │   │   └── client.key</span><br><span class="line">  │   └── prod/</span><br><span class="line">  │       ├── ca.crt</span><br><span class="line">  │       ├── client.crt</span><br><span class="line">  │       └── client.key</span><br><span class="line"></span><br><span class="line">  这些 TLS 配置为 Prometheus 提供了全面的安全传输能力，确保监控数据在传输过程中的机密性和完整性。</span><br></pre></td></tr></table></figure>

<h4 id="oauth2"><a href="#oauth2" class="headerlink" title="oauth2"></a>oauth2</h4><ol>
<li>OAuth 2.0 authentication using the <strong>client credentials</strong> or <strong>password grant type</strong>.</li>
<li>Prometheus fetches an <strong>access token</strong> from the <strong>specified endpoint</strong><ul>
<li>with the given client access and secret keys.</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这部分详细说明了 Prometheus 中的 OAuth 2.0 认证配置，支持 Client Credentials 和 Password Grant 两种授权模式。</span><br><span class="line"></span><br><span class="line">  OAuth 2.0 授权模式</span><br><span class="line"></span><br><span class="line">  1. Client Credentials Grant (客户端凭证模式)</span><br><span class="line"></span><br><span class="line">  适用于服务到服务的认证，无需用户交互。</span><br><span class="line"></span><br><span class="line">  2. Resource Owner Password Credentials Grant (密码模式)</span><br><span class="line"></span><br><span class="line">  适用于可信的第一方应用，直接使用用户名密码获取令牌。</span><br><span class="line"></span><br><span class="line">  配置参数详解</span><br><span class="line"></span><br><span class="line">  基本认证信息</span><br><span class="line"></span><br><span class="line">  # 客户端 ID - 在 OAuth 提供商处注册的应用标识</span><br><span class="line">  client_id: &quot;prometheus-monitoring&quot;</span><br><span class="line"></span><br><span class="line">  # 客户端密钥 - 可以直接配置或从文件读取</span><br><span class="line">  client_secret: &quot;your_client_secret_here&quot;</span><br><span class="line">  # 或者（推荐）</span><br><span class="line">  client_secret_file: &quot;/etc/prometheus/secrets/oauth_client_secret&quot;</span><br><span class="line"></span><br><span class="line">  权限范围 (Scopes)</span><br><span class="line"></span><br><span class="line">  # 定义请求的权限范围</span><br><span class="line">  scopes:</span><br><span class="line">    - &quot;metrics:read&quot;</span><br><span class="line">    - &quot;monitoring:access&quot;</span><br><span class="line">    - &quot;read:services&quot;</span><br><span class="line"></span><br><span class="line">  令牌端点</span><br><span class="line"></span><br><span class="line">  # OAuth 令牌服务的 URL</span><br><span class="line">  token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  Client Credentials 模式</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;api-service-oauth&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;api.example.com&#x27;]</span><br><span class="line"></span><br><span class="line">    oauth2:</span><br><span class="line">      client_id: &quot;prometheus-client&quot;</span><br><span class="line">      client_secret_file: &quot;/etc/prometheus/secrets/oauth_client_secret&quot;</span><br><span class="line">      token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">      scopes:</span><br><span class="line">        - &quot;metrics:read&quot;</span><br><span class="line">        - &quot;monitoring:access&quot;</span><br><span class="line"></span><br><span class="line">      # TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  Password Grant 模式</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;legacy-system-oauth&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;legacy-api.example.com&#x27;]</span><br><span class="line"></span><br><span class="line">    oauth2:</span><br><span class="line">      client_id: &quot;prometheus-legacy&quot;</span><br><span class="line">      client_secret_file: &quot;/etc/prometheus/secrets/legacy_client_secret&quot;</span><br><span class="line">      token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">      scopes:</span><br><span class="line">        - &quot;read&quot;</span><br><span class="line">        - &quot;access&quot;</span><br><span class="line"></span><br><span class="line">      # 密码模式的额外参数</span><br><span class="line">      endpoint_params:</span><br><span class="line">        grant_type: &quot;password&quot;</span><br><span class="line">        username: &quot;prometheus_service@example.com&quot;</span><br><span class="line">        password: &quot;strong_service_password&quot;</span><br><span class="line"></span><br><span class="line">  高级配置选项</span><br><span class="line"></span><br><span class="line">  端点参数配置</span><br><span class="line"></span><br><span class="line">  oauth2:</span><br><span class="line">    client_id: &quot;prometheus-client&quot;</span><br><span class="line">    client_secret_file: &quot;/etc/prometheus/secrets/client_secret&quot;</span><br><span class="line">    token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">    scopes: [&quot;metrics:read&quot;]</span><br><span class="line"></span><br><span class="line">    # 自定义端点参数</span><br><span class="line">    endpoint_params:</span><br><span class="line">      grant_type: &quot;client_credentials&quot;</span><br><span class="line">      audience: &quot;prometheus-monitoring&quot;</span><br><span class="line">      resource: &quot;https://api.example.com&quot;</span><br><span class="line">      custom_param: &quot;custom_value&quot;</span><br><span class="line"></span><br><span class="line">  TLS 安全配置</span><br><span class="line"></span><br><span class="line">  oauth2:</span><br><span class="line">    client_id: &quot;secure-prometheus&quot;</span><br><span class="line">    client_secret_file: &quot;/etc/prometheus/secrets/client_secret&quot;</span><br><span class="line">    token_url: &quot;https://secure-auth.example.com/oauth2/token&quot;</span><br><span class="line">    scopes: [&quot;metrics:read&quot;]</span><br><span class="line"></span><br><span class="line">    # TLS 安全设置</span><br><span class="line">    tls_config:</span><br><span class="line">      ca_file: &quot;/etc/prometheus/certs/auth_ca.crt&quot;</span><br><span class="line">      cert_file: &quot;/etc/prometheus/certs/client.crt&quot;</span><br><span class="line">      key_file: &quot;/etc/prometheus/certs/client.key&quot;</span><br><span class="line">      server_name: &quot;secure-auth.example.com&quot;</span><br><span class="line">      min_version: &quot;TLS12&quot;</span><br><span class="line">      insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  代理配置</span><br><span class="line"></span><br><span class="line">  oauth2:</span><br><span class="line">    client_id: &quot;prometheus-client&quot;</span><br><span class="line">    client_secret_file: &quot;/etc/prometheus/secrets/client_secret&quot;</span><br><span class="line">    token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">    scopes: [&quot;metrics:read&quot;]</span><br><span class="line"></span><br><span class="line">    # 代理设置</span><br><span class="line">    proxy_url: &quot;http://corporate-proxy:8080&quot;</span><br><span class="line">    no_proxy: &quot;localhost,.internal,auth.example.com&quot;</span><br><span class="line"></span><br><span class="line">    # 代理连接头</span><br><span class="line">    proxy_connect_header:</span><br><span class="line">      Proxy-Authorization: [&quot;Basic dXNlcjpwYXNz&quot;]</span><br><span class="line"></span><br><span class="line">  自定义 HTTP 头</span><br><span class="line"></span><br><span class="line">  oauth2:</span><br><span class="line">    client_id: &quot;prometheus-client&quot;</span><br><span class="line">    client_secret_file: &quot;/etc/prometheus/secrets/client_secret&quot;</span><br><span class="line">    token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">    scopes: [&quot;metrics:read&quot;]</span><br><span class="line"></span><br><span class="line">    # 自定义请求头</span><br><span class="line">    http_headers:</span><br><span class="line">      User-Agent:</span><br><span class="line">        values: [&quot;Prometheus/2.45.0&quot;]</span><br><span class="line">      X-Client-Name:</span><br><span class="line">        values: [&quot;prometheus-monitoring&quot;]</span><br><span class="line">      X-Environment:</span><br><span class="line">        values: [&quot;production&quot;]</span><br><span class="line"></span><br><span class="line">      # 敏感头信息</span><br><span class="line">      X-Internal-Token:</span><br><span class="line">        secrets: [&quot;internal_token_value&quot;]</span><br><span class="line"></span><br><span class="line">      # 从文件读取</span><br><span class="line">      X-Custom-Auth:</span><br><span class="line">        files: [&quot;/etc/prometheus/secrets/custom_auth_header.txt&quot;]</span><br><span class="line"></span><br><span class="line">  实际应用场景</span><br><span class="line"></span><br><span class="line">  企业环境 OAuth 2.0</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;enterprise-api&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;api.company.com:443&#x27;]</span><br><span class="line"></span><br><span class="line">      oauth2:</span><br><span class="line">        client_id: &quot;prometheus-monitoring-prod&quot;</span><br><span class="line">        client_secret_file: &quot;/etc/prometheus/secrets/prod_oauth_secret&quot;</span><br><span class="line">        token_url: &quot;https://sso.company.com/oauth2/token&quot;</span><br><span class="line">        scopes:</span><br><span class="line">          - &quot;metrics:read&quot;</span><br><span class="line">          - &quot;monitoring:full_access&quot;</span><br><span class="line"></span><br><span class="line">        endpoint_params:</span><br><span class="line">          grant_type: &quot;client_credentials&quot;</span><br><span class="line">          audience: &quot;api.company.com&quot;</span><br><span class="line"></span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &quot;/etc/prometheus/certs/corporate_ca.crt&quot;</span><br><span class="line">          server_name: &quot;sso.company.com&quot;</span><br><span class="line"></span><br><span class="line">        http_headers:</span><br><span class="line">          X-Service:</span><br><span class="line">            values: [&quot;prometheus&quot;]</span><br><span class="line">          X-Department:</span><br><span class="line">            values: [&quot;observability&quot;]</span><br><span class="line"></span><br><span class="line">  云服务集成</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;cloud-provider-api&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;api.cloud-provider.com&#x27;]</span><br><span class="line"></span><br><span class="line">      oauth2:</span><br><span class="line">        client_id: &quot;prometheus-integration&quot;</span><br><span class="line">        client_secret_file: &quot;/etc/prometheus/secrets/cloud_oauth_secret&quot;</span><br><span class="line">        token_url: &quot;https://auth.cloud-provider.com/oauth2/token&quot;</span><br><span class="line">        scopes:</span><br><span class="line">          - &quot;monitoring.read&quot;</span><br><span class="line">          - &quot;metrics.access&quot;</span><br><span class="line"></span><br><span class="line">        endpoint_params:</span><br><span class="line">          grant_type: &quot;client_credentials&quot;</span><br><span class="line">          project_id: &quot;my-project-123&quot;</span><br><span class="line"></span><br><span class="line">        proxy_from_environment: true</span><br><span class="line"></span><br><span class="line">  多环境配置</span><br><span class="line"></span><br><span class="line">  # 开发环境</span><br><span class="line">  - job_name: &#x27;dev-api&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;dev-api.example.com&#x27;]</span><br><span class="line">    oauth2:</span><br><span class="line">      client_id: &quot;prometheus-dev&quot;</span><br><span class="line">      client_secret: &quot;dev_secret&quot;</span><br><span class="line">      token_url: &quot;https://dev-auth.example.com/oauth2/token&quot;</span><br><span class="line">      scopes: [&quot;read&quot;]</span><br><span class="line"></span><br><span class="line">  # 测试环境</span><br><span class="line">  - job_name: &#x27;staging-api&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;staging-api.example.com&#x27;]</span><br><span class="line">    oauth2:</span><br><span class="line">      client_id: &quot;prometheus-staging&quot;</span><br><span class="line">      client_secret_file: &quot;/etc/prometheus/secrets/staging_oauth_secret&quot;</span><br><span class="line">      token_url: &quot;https://staging-auth.example.com/oauth2/token&quot;</span><br><span class="line">      scopes: [&quot;metrics:read&quot;]</span><br><span class="line"></span><br><span class="line">  # 生产环境</span><br><span class="line">  - job_name: &#x27;prod-api&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;prod-api.example.com&#x27;]</span><br><span class="line">    oauth2:</span><br><span class="line">      client_id: &quot;prometheus-prod&quot;</span><br><span class="line">      client_secret_file: &quot;/etc/prometheus/secrets/prod_oauth_secret&quot;</span><br><span class="line">      token_url: &quot;https://auth.example.com/oauth2/token&quot;</span><br><span class="line">      scopes: [&quot;metrics:read&quot;, &quot;monitoring:full&quot;]</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/prometheus/certs/prod_ca.crt&quot;</span><br><span class="line"></span><br><span class="line">  令牌管理</span><br><span class="line"></span><br><span class="line">  自动刷新机制</span><br><span class="line"></span><br><span class="line">  - Prometheus 会在令牌过期前自动刷新</span><br><span class="line">  - 令牌会缓存在内存中</span><br><span class="line">  - 失败时会自动重试</span><br><span class="line"></span><br><span class="line">  监控 OAuth 2.0 状态</span><br><span class="line"></span><br><span class="line">  可以通过 Prometheus 自身指标监控 OAuth 2.0 状态：</span><br><span class="line">  prometheus_scrape_oauth_token_failures_total</span><br><span class="line">  prometheus_scrape_oauth_token_cache_hits_total</span><br><span class="line"></span><br><span class="line">  安全最佳实践</span><br><span class="line"></span><br><span class="line">  1. 使用文件存储密钥：避免在配置文件中明文存储</span><br><span class="line">  2. 设置适当的文件权限：chmod 600 和 chown prometheus:prometheus</span><br><span class="line">  3. 限制权限范围：只申请必要的权限</span><br><span class="line">  4. 使用 TLS：确保令牌请求的安全性</span><br><span class="line">  5. 定期轮换密钥：定期更新客户端密钥</span><br><span class="line"></span><br><span class="line">  这种 OAuth 2.0 配置为 Prometheus 提供了现代化的认证方式，特别适合微服务和云原生环境。</span><br></pre></td></tr></table></figure>

<h4 id="docker-sd-config"><a href="#docker-sd-config" class="headerlink" title="docker_sd_config"></a>docker_sd_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br></pre></td><td class="code"><pre><span class="line">⏺ Docker 服务发现 (Docker SD) 是 Prometheus 用于自动发现和监控 Docker 容器的功能，通过 Docker Engine API</span><br><span class="line">  获取容器信息并创建监控目标。</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  Docker SD 通过以下方式工作：</span><br><span class="line">  1. 连接到 Docker Engine API</span><br><span class="line">  2. 获取所有容器信息</span><br><span class="line">  3. 为每个容器的暴露端口创建监控目标</span><br><span class="line">  4. 提供丰富的元数据标签用于过滤和配置</span><br><span class="line"></span><br><span class="line">  配置选项详解</span><br><span class="line"></span><br><span class="line">  host - Docker 守护进程地址</span><br><span class="line"></span><br><span class="line">  # 本地 Docker socket</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line"></span><br><span class="line">  # 远程 Docker API</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;tcp://docker.example.com:2376&quot;</span><br><span class="line"></span><br><span class="line">  # TLS 加密的远程连接</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;tcp://secure-docker.example.com:2376&quot;</span><br><span class="line"></span><br><span class="line">  port - 默认抓取端口</span><br><span class="line"></span><br><span class="line">  # 默认端口 80</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      port: 80</span><br><span class="line"></span><br><span class="line">  # 自定义默认端口</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      port: 9090</span><br><span class="line"></span><br><span class="line">  host_networking_host - 主机网络模式的主机地址</span><br><span class="line"></span><br><span class="line">  # 容器使用 host 网络模式时的默认主机</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      host_networking_host: &quot;localhost&quot;</span><br><span class="line"></span><br><span class="line">  # 自定义主机地址</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      host_networking_host: &quot;host.docker.internal&quot;</span><br><span class="line"></span><br><span class="line">  match_first_network - 多网络处理</span><br><span class="line"></span><br><span class="line">  # 只使用第一个网络（默认）</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      match_first_network: true</span><br><span class="line"></span><br><span class="line">  # 监控所有网络</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      match_first_network: false</span><br><span class="line"></span><br><span class="line">  过滤器配置</span><br><span class="line"></span><br><span class="line">  基本过滤器</span><br><span class="line"></span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      filters:</span><br><span class="line">        # 只监控运行中的容器</span><br><span class="line">        - name: &quot;status&quot;</span><br><span class="line">          values: [&quot;running&quot;]</span><br><span class="line"></span><br><span class="line">        # 只监控特定镜像</span><br><span class="line">        - name: &quot;ancestor&quot;</span><br><span class="line">          values: [&quot;nginx:latest&quot;, &quot;redis:alpine&quot;]</span><br><span class="line"></span><br><span class="line">        # 排除特定容器</span><br><span class="line">        - name: &quot;name&quot;</span><br><span class="line">          values: [&quot;!test-container&quot;]</span><br><span class="line"></span><br><span class="line">  高级过滤器</span><br><span class="line"></span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      filters:</span><br><span class="line">        # 只监控带特定标签的容器</span><br><span class="line">        - name: &quot;label&quot;</span><br><span class="line">          values: [&quot;monitoring.enabled=true&quot;]</span><br><span class="line"></span><br><span class="line">        # 只监控特定网络中的容器</span><br><span class="line">        - name: &quot;network&quot;</span><br><span class="line">          values: [&quot;monitoring&quot;]</span><br><span class="line"></span><br><span class="line">        # 只监控暴露特定端口的容器</span><br><span class="line">        - name: &quot;expose&quot;</span><br><span class="line">          values: [&quot;8080&quot;, &quot;9090&quot;]</span><br><span class="line"></span><br><span class="line">  复合过滤示例</span><br><span class="line"></span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      filters:</span><br><span class="line">        # 运行中的 Web 服务容器</span><br><span class="line">        - name: &quot;status&quot;</span><br><span class="line">          values: [&quot;running&quot;]</span><br><span class="line">        - name: &quot;label&quot;</span><br><span class="line">          values: [&quot;app.type=web&quot;]</span><br><span class="line">        - name: &quot;label&quot;</span><br><span class="line">          values: [&quot;monitoring.scrape=true&quot;]</span><br><span class="line"></span><br><span class="line">        # 排除测试和开发容器</span><br><span class="line">        - name: &quot;label&quot;</span><br><span class="line">          values: [&quot;!env=test&quot;, &quot;!env=dev&quot;]</span><br><span class="line"></span><br><span class="line">  刷新间隔配置</span><br><span class="line"></span><br><span class="line">  # 快速刷新（开发环境）</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      refresh_interval: 30s</span><br><span class="line"></span><br><span class="line">  # 标准刷新（生产环境）</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">  # 慢速刷新（稳定环境）</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      refresh_interval: 5m</span><br><span class="line"></span><br><span class="line">  HTTP 客户端配置</span><br><span class="line"></span><br><span class="line">  TLS 安全连接</span><br><span class="line"></span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;tcp://secure-docker.example.com:2376&quot;</span><br><span class="line">      refresh_interval: 30s</span><br><span class="line"></span><br><span class="line">      # TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/prometheus/certs/docker-ca.crt&quot;</span><br><span class="line">        cert_file: &quot;/etc/prometheus/certs/docker-client.crt&quot;</span><br><span class="line">        key_file: &quot;/etc/prometheus/certs/docker-client.key&quot;</span><br><span class="line">        server_name: &quot;secure-docker.example.com&quot;</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">      # 认证</span><br><span class="line">      basic_auth:</span><br><span class="line">        username_file: &quot;/etc/prometheus/secrets/docker_user&quot;</span><br><span class="line">        password_file: &quot;/etc/prometheus/secrets/docker_pass&quot;</span><br><span class="line"></span><br><span class="line">  代理配置</span><br><span class="line"></span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;tcp://remote-docker.example.com:2376&quot;</span><br><span class="line"></span><br><span class="line">      # 代理设置</span><br><span class="line">      proxy_url: &quot;http://corporate-proxy:8080&quot;</span><br><span class="line">      no_proxy: &quot;localhost,.internal&quot;</span><br><span class="line"></span><br><span class="line">      # 自定义头</span><br><span class="line">      http_headers:</span><br><span class="line">        User-Agent:</span><br><span class="line">          values: [&quot;Prometheus-Docker-SD/2.0&quot;]</span><br><span class="line">        X-Client:</span><br><span class="line">          values: [&quot;prometheus&quot;]</span><br><span class="line"></span><br><span class="line">  元数据标签使用</span><br><span class="line"></span><br><span class="line">  容器信息标签</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;docker-containers&#x27;</span><br><span class="line">      docker_sd_configs:</span><br><span class="line">        - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">          filters:</span><br><span class="line">            - name: &quot;status&quot;</span><br><span class="line">              values: [&quot;running&quot;]</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 只监控带注解的容器</span><br><span class="line">        - source_labels: [__meta_docker_container_label_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        # 设置抓取端口</span><br><span class="line">        - source_labels: [__meta_docker_container_label_prometheus_io_port]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __address__</span><br><span class="line">          regex: (.+)</span><br><span class="line">          replacement: $&#123;1&#125;</span><br><span class="line"></span><br><span class="line">        # 添加容器名称标签</span><br><span class="line">        - source_labels: [__meta_docker_container_name]</span><br><span class="line">          target_label: container_name</span><br><span class="line"></span><br><span class="line">        # 添加容器 ID 标签</span><br><span class="line">        - source_labels: [__meta_docker_container_id]</span><br><span class="line">          target_label: container_id</span><br><span class="line"></span><br><span class="line">        # 添加镜像信息</span><br><span class="line">        - source_labels: [__meta_docker_container_label_com_docker_compose_service]</span><br><span class="line">          target_label: service</span><br><span class="line"></span><br><span class="line">  网络信息标签</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 添加网络名称</span><br><span class="line">    - source_labels: [__meta_docker_network_name]</span><br><span class="line">      target_label: network_name</span><br><span class="line"></span><br><span class="line">    # 添加网络 IP</span><br><span class="line">    - source_labels: [__meta_docker_network_ip]</span><br><span class="line">      target_label: container_ip</span><br><span class="line"></span><br><span class="line">    # 区分内外网</span><br><span class="line">    - source_labels: [__meta_docker_network_internal]</span><br><span class="line">      target_label: network_type</span><br><span class="line">      replacement: &quot;internal&quot;</span><br><span class="line">      regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">    # 端口映射信息</span><br><span class="line">    - source_labels: [__meta_docker_port_private, __meta_docker_port_public]</span><br><span class="line">      target_label: port_mapping</span><br><span class="line">      replacement: &quot;$&#123;1&#125;:$&#123;2&#125;&quot;</span><br><span class="line">      regex: (.+);(.+)</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  基础 Docker 监控</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;docker-containers&#x27;</span><br><span class="line">      docker_sd_configs:</span><br><span class="line">        - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">          port: 9090</span><br><span class="line">          refresh_interval: 30s</span><br><span class="line">          filters:</span><br><span class="line">            - name: &quot;status&quot;</span><br><span class="line">              values: [&quot;running&quot;]</span><br><span class="line">            - name: &quot;label&quot;</span><br><span class="line">              values: [&quot;prometheus.scrape=true&quot;]</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 只监控启用的容器</span><br><span class="line">        - source_labels: [__meta_docker_container_label_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        # 设置抓取路径</span><br><span class="line">        - source_labels: [__meta_docker_container_label_prometheus_io_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __metrics_path__</span><br><span class="line">          regex: (.+)</span><br><span class="line">          replacement: $&#123;1&#125;</span><br><span class="line"></span><br><span class="line">        # 设置抓取端口</span><br><span class="line">        - source_labels: [__address__, __meta_docker_container_label_prometheus_io_port]</span><br><span class="line">          action: replace</span><br><span class="line">          regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">          replacement: $1:$2</span><br><span class="line">          target_label: __address__</span><br><span class="line"></span><br><span class="line">        # 添加容器元数据</span><br><span class="line">        - source_labels: [__meta_docker_container_name]</span><br><span class="line">          target_label: container_name</span><br><span class="line">        - source_labels: [__meta_docker_container_label_com_docker_compose_service]</span><br><span class="line">          target_label: compose_service</span><br><span class="line">        - source_labels: [__meta_docker_network_name]</span><br><span class="line">          target_label: network</span><br><span class="line"></span><br><span class="line">  企业级 Docker 监控</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;production-docker&#x27;</span><br><span class="line">      docker_sd_configs:</span><br><span class="line">        - host: &quot;tcp://docker-swarm.example.com:2376&quot;</span><br><span class="line">          port: 9090</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line">          match_first_network: true</span><br><span class="line">          filters:</span><br><span class="line">            - name: &quot;status&quot;</span><br><span class="line">              values: [&quot;running&quot;]</span><br><span class="line">            - name: &quot;label&quot;</span><br><span class="line">              values: [&quot;env=production&quot;]</span><br><span class="line">            - name: &quot;label&quot;</span><br><span class="line">              values: [&quot;monitoring.enabled=true&quot;]</span><br><span class="line"></span><br><span class="line">          # TLS 配置</span><br><span class="line">          tls_config:</span><br><span class="line">            ca_file: &quot;/etc/prometheus/certs/docker-ca.crt&quot;</span><br><span class="line">            cert_file: &quot;/etc/prometheus/certs/docker-client.crt&quot;</span><br><span class="line">            key_file: &quot;/etc/prometheus/certs/docker-client.key&quot;</span><br><span class="line">            server_name: &quot;docker-swarm.example.com&quot;</span><br><span class="line"></span><br><span class="line">          # 认证</span><br><span class="line">          basic_auth:</span><br><span class="line">            username_file: &quot;/etc/prometheus/secrets/docker_user&quot;</span><br><span class="line">            password_file: &quot;/etc/prometheus/secrets/docker_pass&quot;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 环境和业务标签</span><br><span class="line">        - source_labels: [__meta_docker_container_label_env]</span><br><span class="line">          target_label: environment</span><br><span class="line">        - source_labels: [__meta_docker_container_label_app]</span><br><span class="line">          target_label: application</span><br><span class="line">        - source_labels: [__meta_docker_container_label_version]</span><br><span class="line">          target_label: version</span><br><span class="line"></span><br><span class="line">        # 服务发现标签</span><br><span class="line">        - source_labels: [__meta_docker_container_name]</span><br><span class="line">          target_label: container_name</span><br><span class="line">        - source_labels: [__meta_docker_network_name]</span><br><span class="line">          target_label: network</span><br><span class="line"></span><br><span class="line">        # 端口配置</span><br><span class="line">        - source_labels: [__address__, __meta_docker_port_private]</span><br><span class="line">          target_label: __address__</span><br><span class="line">          regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">          replacement: $1:$2</span><br><span class="line"></span><br><span class="line">        # 监控配置</span><br><span class="line">        - source_labels: [__meta_docker_container_label_prometheus_io_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __metrics_path__</span><br><span class="line">          regex: (.+)</span><br><span class="line">          replacement: $&#123;1&#125;</span><br><span class="line"></span><br><span class="line">  多环境配置</span><br><span class="line"></span><br><span class="line">  # 开发环境</span><br><span class="line">  - job_name: &#x27;dev-docker&#x27;</span><br><span class="line">    docker_sd_configs:</span><br><span class="line">      - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">        refresh_interval: 30s</span><br><span class="line">        filters:</span><br><span class="line">          - name: &quot;label&quot;</span><br><span class="line">            values: [&quot;env=dev&quot;]</span><br><span class="line">          - name: &quot;label&quot;</span><br><span class="line">            values: [&quot;monitoring.scrape=true&quot;]</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__meta_docker_container_name]</span><br><span class="line">        target_label: container_name</span><br><span class="line"></span><br><span class="line">  # 测试环境</span><br><span class="line">  - job_name: &#x27;staging-docker&#x27;</span><br><span class="line">    docker_sd_configs:</span><br><span class="line">      - host: &quot;tcp://staging-docker.example.com:2376&quot;</span><br><span class="line">        refresh_interval: 60s</span><br><span class="line">        filters:</span><br><span class="line">          - name: &quot;label&quot;</span><br><span class="line">            values: [&quot;env=staging&quot;]</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &quot;/etc/prometheus/certs/staging-ca.crt&quot;</span><br><span class="line"></span><br><span class="line">  # 生产环境</span><br><span class="line">  - job_name: &#x27;prod-docker&#x27;</span><br><span class="line">    docker_sd_configs:</span><br><span class="line">      - host: &quot;tcp://prod-docker.example.com:2376&quot;</span><br><span class="line">        refresh_interval: 60s</span><br><span class="line">        filters:</span><br><span class="line">          - name: &quot;label&quot;</span><br><span class="line">            values: [&quot;env=production&quot;]</span><br><span class="line">          - name: &quot;label&quot;</span><br><span class="line">            values: [&quot;monitoring.enabled=true&quot;]</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &quot;/etc/prometheus/certs/prod-ca.crt&quot;</span><br><span class="line">          cert_file: &quot;/etc/prometheus/certs/prod-client.crt&quot;</span><br><span class="line">          key_file: &quot;/etc/prometheus/certs/prod-client.key&quot;</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 标签规范化</span><br><span class="line"></span><br><span class="line">  # Docker Compose 文件示例</span><br><span class="line">  version: &#x27;3.8&#x27;</span><br><span class="line">  services:</span><br><span class="line">    web-app:</span><br><span class="line">      image: nginx:latest</span><br><span class="line">      labels:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9090&quot;</span><br><span class="line">        prometheus.io/path: &quot;/metrics&quot;</span><br><span class="line">        app.type: &quot;web&quot;</span><br><span class="line">        env: &quot;production&quot;</span><br><span class="line">        monitoring.enabled: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">  2. 性能优化</span><br><span class="line"></span><br><span class="line">  # 大规模部署的优化配置</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;unix:///var/run/docker.sock&quot;</span><br><span class="line">      refresh_interval: 2m  # 降低刷新频率</span><br><span class="line">      match_first_network: true  # 避免重复目标</span><br><span class="line">      filters:</span><br><span class="line">        - name: &quot;status&quot;</span><br><span class="line">          values: [&quot;running&quot;]</span><br><span class="line">        - name: &quot;label&quot;</span><br><span class="line">          values: [&quot;monitoring.scrape=true&quot;]  # API 层面过滤</span><br><span class="line"></span><br><span class="line">  3. 安全考虑</span><br><span class="line"></span><br><span class="line">  # 生产环境安全配置</span><br><span class="line">  docker_sd_configs:</span><br><span class="line">    - host: &quot;tcp://secure-docker.example.com:2376&quot;</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &quot;/etc/prometheus/certs/docker-ca.crt&quot;</span><br><span class="line">        cert_file: &quot;/etc/prometheus/certs/docker-client.crt&quot;</span><br><span class="line">        key_file: &quot;/etc/prometheus/certs/docker-client.key&quot;</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">      basic_auth:</span><br><span class="line">        username_file: &quot;/etc/prometheus/secrets/docker_user&quot;</span><br><span class="line">        password_file: &quot;/etc/prometheus/secrets/docker_pass&quot;</span><br><span class="line"></span><br><span class="line">  Docker SD 为 Prometheus 提供了强大的容器自动发现能力，特别适合动态和容器化的环境。</span><br></pre></td></tr></table></figure>

<h4 id="file-sd-config"><a href="#file-sd-config" class="headerlink" title="file_sd_config"></a>file_sd_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br></pre></td><td class="code"><pre><span class="line">⏺ 基于文件的服务发现 (File SD) 是 Prometheus</span><br><span class="line">  最灵活的服务发现机制，通过读取文件中的目标配置来实现动态监控目标管理。</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  File SD 的工作原理：</span><br><span class="line">  1. 监控指定模式的文件变化</span><br><span class="line">  2. 解析 JSON 或 YAML 格式的目标配置</span><br><span class="line">  3. 通过文件系统 watch 机制实时检测变化</span><br><span class="line">  4. 立即应用格式正确的配置更改</span><br><span class="line"></span><br><span class="line">  文件格式</span><br><span class="line"></span><br><span class="line">  JSON 格式</span><br><span class="line"></span><br><span class="line">  [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;targets&quot;: [&quot;localhost:9090&quot;, &quot;localhost:9091&quot;],</span><br><span class="line">      &quot;labels&quot;: &#123;</span><br><span class="line">        &quot;job&quot;: &quot;prometheus&quot;,</span><br><span class="line">        &quot;env&quot;: &quot;production&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;targets&quot;: [&quot;api.example.com:8080&quot;],</span><br><span class="line">      &quot;labels&quot;: &#123;</span><br><span class="line">        &quot;job&quot;: &quot;api&quot;,</span><br><span class="line">        &quot;service&quot;: &quot;user-service&quot;,</span><br><span class="line">        &quot;version&quot;: &quot;v1.2.0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  YAML 格式</span><br><span class="line"></span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;localhost:9090&quot;</span><br><span class="line">      - &quot;localhost:9091&quot;</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;prometheus&quot;</span><br><span class="line">      env: &quot;production&quot;</span><br><span class="line"></span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;api.example.com:8080&quot;</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;api&quot;</span><br><span class="line">      service: &quot;user-service&quot;</span><br><span class="line">      version: &quot;v1.2.0&quot;</span><br><span class="line"></span><br><span class="line">  配置选项</span><br><span class="line"></span><br><span class="line">  files - 文件模式配置</span><br><span class="line"></span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">        # 单个文件</span><br><span class="line">        - &quot;/etc/prometheus/targets.yml&quot;</span><br><span class="line"></span><br><span class="line">        # 通配符匹配</span><br><span class="line">        - &quot;/etc/prometheus/targets/*.yml&quot;</span><br><span class="line">        - &quot;/etc/prometheus/targets/*.json&quot;</span><br><span class="line"></span><br><span class="line">        # 复杂路径模式</span><br><span class="line">        - &quot;/etc/prometheus/discovery/*_targets.json&quot;</span><br><span class="line">        - &quot;/var/lib/prometheus/sd/configs/tg_*.yml&quot;</span><br><span class="line"></span><br><span class="line">  refresh_interval - 刷新间隔</span><br><span class="line"></span><br><span class="line">  # 默认 5 分钟</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">        - &quot;/etc/prometheus/targets/*.yml&quot;</span><br><span class="line">      refresh_interval: 5m</span><br><span class="line"></span><br><span class="line">  # 快速刷新（开发环境）</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">        - &quot;/etc/prometheus/targets/*.yml&quot;</span><br><span class="line">      refresh_interval: 30s</span><br><span class="line"></span><br><span class="line">  # 慢速刷新（稳定环境）</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">        - &quot;/etc/prometheus/targets/*.yml&quot;</span><br><span class="line">      refresh_interval: 10m</span><br><span class="line"></span><br><span class="line">  实际应用示例</span><br><span class="line"></span><br><span class="line">  基础配置</span><br><span class="line"></span><br><span class="line">  # prometheus.yml</span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;file-discovery&#x27;</span><br><span class="line">      file_sd_configs:</span><br><span class="line">        - files:</span><br><span class="line">            - &quot;/etc/prometheus/targets/*.yml&quot;</span><br><span class="line">          refresh_interval: 1m</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/web-services.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;web1.example.com:8080&quot;</span><br><span class="line">      - &quot;web2.example.com:8080&quot;</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;web-services&quot;</span><br><span class="line">      env: &quot;production&quot;</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/databases.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;db1.example.com:5432&quot;</span><br><span class="line">      - &quot;db2.example.com:5432&quot;</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;databases&quot;</span><br><span class="line">      env: &quot;production&quot;</span><br><span class="line">      type: &quot;postgresql&quot;</span><br><span class="line"></span><br><span class="line">  动态环境配置</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/dev.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;dev-web1:8080&quot;</span><br><span class="line">      - &quot;dev-api1:9090&quot;</span><br><span class="line">    labels:</span><br><span class="line">      env: &quot;development&quot;</span><br><span class="line">      team: &quot;backend&quot;</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/staging.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;staging-web1:8080&quot;</span><br><span class="line">      - &quot;staging-api1:9090&quot;</span><br><span class="line">    labels:</span><br><span class="line">      env: &quot;staging&quot;</span><br><span class="line">      team: &quot;backend&quot;</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/production.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;prod-web1:8080&quot;</span><br><span class="line">      - &quot;prod-web2:8080&quot;</span><br><span class="line">      - &quot;prod-api1:9090&quot;</span><br><span class="line">      - &quot;prod-api2:9090&quot;</span><br><span class="line">    labels:</span><br><span class="line">      env: &quot;production&quot;</span><br><span class="line">      team: &quot;backend&quot;</span><br><span class="line"></span><br><span class="line">  复杂业务配置</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/microservices.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;user-service:8080&quot;</span><br><span class="line">      - &quot;order-service:8080&quot;</span><br><span class="line">      - &quot;payment-service:8080&quot;</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;microservices&quot;</span><br><span class="line">      architecture: &quot;microservices&quot;</span><br><span class="line">      team: &quot;platform&quot;</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/infrastructure.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;node-exporter:9100&quot;</span><br><span class="line">      - &quot;cadvisor:8080&quot;</span><br><span class="line">      - &quot;blackbox-exporter:9115&quot;</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;infrastructure&quot;</span><br><span class="line">      category: &quot;system&quot;</span><br><span class="line"></span><br><span class="line">  元数据标签使用</span><br><span class="line"></span><br><span class="line">  __meta_filepath 标签</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;file-discovery&#x27;</span><br><span class="line">      file_sd_configs:</span><br><span class="line">        - files:</span><br><span class="line">            - &quot;/etc/prometheus/targets/*.yml&quot;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 使用文件路径作为环境标识</span><br><span class="line">        - source_labels: [__meta_filepath]</span><br><span class="line">          target_label: config_file</span><br><span class="line">          regex: &#x27;.*/([^/]+)\.yml&#x27;</span><br><span class="line">          replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">        # 从文件名提取环境信息</span><br><span class="line">        - source_labels: [__meta_filepath]</span><br><span class="line">          target_label: environment</span><br><span class="line">          regex: &#x27;.*/(dev|staging|prod)_.*\.yml&#x27;</span><br><span class="line">          replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">  动态标签生成</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 从文件路径获取业务域</span><br><span class="line">    - source_labels: [__meta_filepath]</span><br><span class="line">      target_label: domain</span><br><span class="line">      regex: &#x27;.*/([^/]+)/targets\.yml&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">    # 添加文件更新时间标签</span><br><span class="line">    - source_labels: [__meta_filepath]</span><br><span class="line">      target_label: config_source</span><br><span class="line">      replacement: &quot;file_discovery&quot;</span><br><span class="line"></span><br><span class="line">  高级用法</span><br><span class="line"></span><br><span class="line">  1. 多文件组织结构</span><br><span class="line"></span><br><span class="line">  /etc/prometheus/</span><br><span class="line">  ├── prometheus.yml</span><br><span class="line">  └── targets/</span><br><span class="line">      ├── environments/</span><br><span class="line">      │   ├── dev.yml</span><br><span class="line">      │   ├── staging.yml</span><br><span class="line">      │   └── production.yml</span><br><span class="line">      ├── services/</span><br><span class="line">      │   ├── web-services.yml</span><br><span class="line">      │   ├── databases.yml</span><br><span class="line">      │   └── cache.yml</span><br><span class="line">      └── infrastructure/</span><br><span class="line">          ├── nodes.yml</span><br><span class="line">          └── exporters.yml</span><br><span class="line"></span><br><span class="line">  # Prometheus 配置</span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;environments&#x27;</span><br><span class="line">      file_sd_configs:</span><br><span class="line">        - files:</span><br><span class="line">            - &quot;/etc/prometheus/targets/environments/*.yml&quot;</span><br><span class="line">          refresh_interval: 2m</span><br><span class="line"></span><br><span class="line">    - job_name: &#x27;services&#x27;</span><br><span class="line">      file_sd_configs:</span><br><span class="line">        - files:</span><br><span class="line">            - &quot;/etc/prometheus/targets/services/*.yml&quot;</span><br><span class="line">          refresh_interval: 1m</span><br><span class="line"></span><br><span class="line">    - job_name: &#x27;infrastructure&#x27;</span><br><span class="line">      file_sd_configs:</span><br><span class="line">        - files:</span><br><span class="line">            - &quot;/etc/prometheus/targets/infrastructure/*.yml&quot;</span><br><span class="line">          refresh_interval: 5m</span><br><span class="line"></span><br><span class="line">  2. 自动化脚本集成</span><br><span class="line"></span><br><span class="line">  #!/bin/bash</span><br><span class="line">  # generate_targets.sh - 自动生成目标配置</span><br><span class="line"></span><br><span class="line">  # 生成数据库服务配置</span><br><span class="line">  cat &gt; /etc/prometheus/targets/databases.yml &lt;&lt; EOF</span><br><span class="line">  - targets:</span><br><span class="line">  $(kubectl get pods -n database -l app=postgres -o jsonpath=&#x27;&#123;range .items[*]&#125;&#123;.status.podIP&#125;:5432&#123;&quot;,&quot;&#125;&#123;end&#125;&#x27; |</span><br><span class="line">  sed &#x27;s/,$/\n/&#x27;)</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;postgresql&quot;</span><br><span class="line">      team: &quot;data&quot;</span><br><span class="line">      env: &quot;$ENVIRONMENT&quot;</span><br><span class="line">  EOF</span><br><span class="line"></span><br><span class="line">  # 生成 Web 服务配置</span><br><span class="line">  cat &gt; /etc/prometheus/targets/web-services.yml &lt;&lt; EOF</span><br><span class="line">  - targets:</span><br><span class="line">  $(kubectl get pods -n web -l app=web -o jsonpath=&#x27;&#123;range .items[*]&#125;&#123;.status.podIP&#125;:8080&#123;&quot;,&quot;&#125;&#123;end&#125;&#x27; | sed</span><br><span class="line">  &#x27;s/,$/\n/&#x27;)</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;web-services&quot;</span><br><span class="line">      team: &quot;frontend&quot;</span><br><span class="line">      env: &quot;$ENVIRONMENT&quot;</span><br><span class="line">  EOF</span><br><span class="line"></span><br><span class="line">  3. 外部系统集成</span><br><span class="line"></span><br><span class="line">  #!/usr/bin/env python3</span><br><span class="line">  # cmdb_sync.py - 从 CMDB 同步目标配置</span><br><span class="line"></span><br><span class="line">  import json</span><br><span class="line">  import requests</span><br><span class="line">  import yaml</span><br><span class="line"></span><br><span class="line">  def fetch_targets_from_cmdb():</span><br><span class="line">      &quot;&quot;&quot;从 CMDB 获取监控目标&quot;&quot;&quot;</span><br><span class="line">      response = requests.get(&quot;https://cmdb.example.com/api/prometheus/targets&quot;)</span><br><span class="line">      return response.json()</span><br><span class="line"></span><br><span class="line">  def generate_prometheus_targets(targets):</span><br><span class="line">      &quot;&quot;&quot;生成 Prometheus 目标配置&quot;&quot;&quot;</span><br><span class="line">      prometheus_targets = []</span><br><span class="line"></span><br><span class="line">      for target in targets:</span><br><span class="line">          prometheus_targets.append(&#123;</span><br><span class="line">              &quot;targets&quot;: [target[&#x27;address&#x27;]],</span><br><span class="line">              &quot;labels&quot;: &#123;</span><br><span class="line">                  &quot;job&quot;: target[&#x27;service&#x27;],</span><br><span class="line">                  &quot;env&quot;: target[&#x27;environment&#x27;],</span><br><span class="line">                  &quot;team&quot;: target[&#x27;team&#x27;],</span><br><span class="line">                  &quot;version&quot;: target.get(&#x27;version&#x27;, &#x27;unknown&#x27;)</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">      return prometheus_targets</span><br><span class="line"></span><br><span class="line">  def update_target_files():</span><br><span class="line">      &quot;&quot;&quot;更新目标文件&quot;&quot;&quot;</span><br><span class="line">      targets = fetch_targets_from_cmdb()</span><br><span class="line">      prometheus_targets = generate_prometheus_targets(targets)</span><br><span class="line"></span><br><span class="line">      # 按环境分组写入不同文件</span><br><span class="line">      for env in [&#x27;dev&#x27;, &#x27;staging&#x27;, &#x27;production&#x27;]:</span><br><span class="line">          env_targets = [t for t in prometheus_targets if t[&#x27;labels&#x27;][&#x27;env&#x27;] == env]</span><br><span class="line"></span><br><span class="line">          with open(f&quot;/etc/prometheus/targets/&#123;env&#125;.yml&quot;, &#x27;w&#x27;) as f:</span><br><span class="line">              yaml.dump(env_targets, f, default_flow_style=False)</span><br><span class="line"></span><br><span class="line">  if __name__ == &quot;__main__&quot;:</span><br><span class="line">      update_target_files()</span><br><span class="line"></span><br><span class="line">  4. 监控配置变更</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;file-discovery&#x27;</span><br><span class="line">      file_sd_configs:</span><br><span class="line">        - files:</span><br><span class="line">            - &quot;/etc/prometheus/targets/*.yml&quot;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 添加配置文件路径标签</span><br><span class="line">        - source_labels: [__meta_filepath]</span><br><span class="line">          target_label: config_file</span><br><span class="line"></span><br><span class="line">        # 添加最后更新时间（通过外部脚本）</span><br><span class="line">        - source_labels: [config_file]</span><br><span class="line">          target_label: last_updated</span><br><span class="line">          replacement: &quot;unknown&quot;</span><br><span class="line"></span><br><span class="line">  # 额外监控文件变更的 job</span><br><span class="line">  - job_name: &#x27;config-monitoring&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">      scrape_interval: 1m</span><br><span class="line"></span><br><span class="line">  性能和安全考虑</span><br><span class="line"></span><br><span class="line">  1. 文件数量优化</span><br><span class="line"></span><br><span class="line">  # ❌ 避免过多小文件</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">        - &quot;/etc/prometheus/targets/*_*.yml&quot;  # 可能匹配数千文件</span><br><span class="line"></span><br><span class="line">  # ✅ 使用合理的文件组织</span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">        - &quot;/etc/prometheus/targets/environments.yml&quot;</span><br><span class="line">        - &quot;/etc/prometheus/targets/services.yml&quot;</span><br><span class="line">        - &quot;/etc/prometheus/targets/infrastructure.yml&quot;</span><br><span class="line"></span><br><span class="line">  2. 文件权限管理</span><br><span class="line"></span><br><span class="line">  # 设置安全的文件权限</span><br><span class="line">  sudo mkdir -p /etc/prometheus/targets</span><br><span class="line">  sudo chown prometheus:prometheus /etc/prometheus/targets</span><br><span class="line">  sudo chmod 755 /etc/prometheus/targets</span><br><span class="line"></span><br><span class="line">  # 目标文件权限</span><br><span class="line">  sudo chmod 644 /etc/prometheus/targets/*.yml</span><br><span class="line">  sudo chown prometheus:prometheus /etc/prometheus/targets/*.yml</span><br><span class="line"></span><br><span class="line">  3. 原子更新</span><br><span class="line"></span><br><span class="line">  #!/bin/bash</span><br><span class="line">  # 原子更新脚本</span><br><span class="line"></span><br><span class="line">  # 生成临时文件</span><br><span class="line">  cat &gt; /etc/prometheus/targets/new_targets.yml &lt;&lt; EOF</span><br><span class="line">  - targets:</span><br><span class="line">      - &quot;new-service:8080&quot;</span><br><span class="line">    labels:</span><br><span class="line">      job: &quot;new-service&quot;</span><br><span class="line">  EOF</span><br><span class="line"></span><br><span class="line">  # 原子替换</span><br><span class="line">  mv /etc/prometheus/targets/new_targets.yml /etc/prometheus/targets/production.yml</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 文件命名规范</span><br><span class="line"></span><br><span class="line">  # 推荐的命名模式</span><br><span class="line">  /environments/prod.yml</span><br><span class="line">  /environments/staging.yml</span><br><span class="line">  /environments/dev.yml</span><br><span class="line">  /services/web-servers.yml</span><br><span class="line">  /services/databases.yml</span><br><span class="line">  /infrastructure/nodes.yml</span><br><span class="line"></span><br><span class="line">  2. 配置验证</span><br><span class="line"></span><br><span class="line">  #!/bin/bash</span><br><span class="line">  # validate_targets.sh - 验证目标配置</span><br><span class="line"></span><br><span class="line">  for file in /etc/prometheus/targets/*.yml; do</span><br><span class="line">      if command -v yamllint &gt;/dev/null 2&gt;&amp;1; then</span><br><span class="line">          yamllint &quot;$file&quot; || echo &quot;YAML validation failed for $file&quot;</span><br><span class="line">      fi</span><br><span class="line"></span><br><span class="line">      if command -v jq &gt;/dev/null 2&gt;&amp;1; then</span><br><span class="line">          python3 -c &quot;import yaml, json; json.dumps(yaml.safe_load(open(&#x27;$file&#x27;)))&quot; \</span><br><span class="line">              || echo &quot;Content validation failed for $file&quot;</span><br><span class="line">      fi</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">  File SD 提供了极大的灵活性，适合各种自定义服务发现需求，特别是在没有标准服务发现机制的环境中。</span><br></pre></td></tr></table></figure>

<h4 id="http-sd-config"><a href="#http-sd-config" class="headerlink" title="http_sd_config"></a>http_sd_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br></pre></td><td class="code"><pre><span class="line">⏺ 基于 HTTP 的服务发现 (HTTP SD) 是 Prometheus 通过 HTTP</span><br><span class="line">  端点动态获取监控目标的机制，提供了灵活的远程服务发现能力。</span><br><span class="line"></span><br><span class="line">  基本工作原理</span><br><span class="line"></span><br><span class="line">  HTTP SD 的工作流程：</span><br><span class="line">  1. 定期向配置的 HTTP 端点发送请求</span><br><span class="line">  2. 期望返回 JSON 格式的目标配置列表</span><br><span class="line">  3. 验证响应状态码和 Content-Type</span><br><span class="line">  4. 解析 JSON 并更新监控目标</span><br><span class="line">  5. 记录失败次数到指标 prometheus_sd_http_failures_total</span><br><span class="line"></span><br><span class="line">  响应格式</span><br><span class="line"></span><br><span class="line">  标准 JSON 响应</span><br><span class="line"></span><br><span class="line">  [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;targets&quot;: [&quot;localhost:9090&quot;, &quot;localhost:9091&quot;],</span><br><span class="line">      &quot;labels&quot;: &#123;</span><br><span class="line">        &quot;job&quot;: &quot;prometheus&quot;,</span><br><span class="line">        &quot;env&quot;: &quot;production&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;targets&quot;: [&quot;api.example.com:8080&quot;, &quot;api.example.com:8081&quot;],</span><br><span class="line">      &quot;labels&quot;: &#123;</span><br><span class="line">        &quot;job&quot;: &quot;api&quot;,</span><br><span class="line">        &quot;service&quot;: &quot;user-service&quot;,</span><br><span class="line">        &quot;version&quot;: &quot;v1.2.0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  复杂响应示例</span><br><span class="line"></span><br><span class="line">  [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;targets&quot;: [&quot;web1.prod.example.com:8080&quot;, &quot;web2.prod.example.com:8080&quot;],</span><br><span class="line">      &quot;labels&quot;: &#123;</span><br><span class="line">        &quot;job&quot;: &quot;web-services&quot;,</span><br><span class="line">        &quot;environment&quot;: &quot;production&quot;,</span><br><span class="line">        &quot;datacenter&quot;: &quot;us-west-2&quot;,</span><br><span class="line">        &quot;service&quot;: &quot;frontend&quot;,</span><br><span class="line">        &quot;version&quot;: &quot;v2.1.0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;targets&quot;: [&quot;db1.prod.example.com:5432&quot;],</span><br><span class="line">      &quot;labels&quot;: &#123;</span><br><span class="line">        &quot;job&quot;: &quot;databases&quot;,</span><br><span class="line">        &quot;environment&quot;: &quot;production&quot;,</span><br><span class="line">        &quot;datacenter&quot;: &quot;us-west-2&quot;,</span><br><span class="line">        &quot;service&quot;: &quot;postgresql&quot;,</span><br><span class="line">        &quot;role&quot;: &quot;master&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;targets&quot;: [&quot;cache1.prod.example.com:6379&quot;, &quot;cache2.prod.example.com:6379&quot;],</span><br><span class="line">      &quot;labels&quot;: &#123;</span><br><span class="line">        &quot;job&quot;: &quot;cache&quot;,</span><br><span class="line">        &quot;environment&quot;: &quot;production&quot;,</span><br><span class="line">        &quot;datacenter&quot;: &quot;us-west-2&quot;,</span><br><span class="line">        &quot;service&quot;: &quot;redis&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  基本配置</span><br><span class="line"></span><br><span class="line">  简单 HTTP SD 配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;http-discovery&#x27;</span><br><span class="line">      http_sd_configs:</span><br><span class="line">        - url: &#x27;http://service-discovery.example.com/targets&#x27;</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">  多端点配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;services-discovery&#x27;</span><br><span class="line">      http_sd_configs:</span><br><span class="line">        - url: &#x27;http://discovery.internal/api/services&#x27;</span><br><span class="line">          refresh_interval: 30s</span><br><span class="line">        - url: &#x27;http://discovery.internal/api/databases&#x27;</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">    - job_name: &#x27;infrastructure-discovery&#x27;</span><br><span class="line">      http_sd_configs:</span><br><span class="line">        - url: &#x27;http://config-manager.example.com/prometheus/targets&#x27;</span><br><span class="line">          refresh_interval: 2m</span><br><span class="line"></span><br><span class="line">  HTTP 客户端配置</span><br><span class="line"></span><br><span class="line">  基础认证</span><br><span class="line"></span><br><span class="line">  http_sd_configs:</span><br><span class="line">    - url: &#x27;http://secure-discovery.example.com/targets&#x27;</span><br><span class="line">      refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">      # 基础认证</span><br><span class="line">      basic_auth:</span><br><span class="line">        username: &#x27;prometheus&#x27;</span><br><span class="line">        password_file: &#x27;/etc/prometheus/secrets/discovery_password&#x27;</span><br><span class="line"></span><br><span class="line">      # 或者使用令牌认证</span><br><span class="line">      authorization:</span><br><span class="line">        type: &#x27;Bearer&#x27;</span><br><span class="line">        credentials_file: &#x27;/etc/prometheus/secrets/bearer_token&#x27;</span><br><span class="line"></span><br><span class="line">  TLS 安全配置</span><br><span class="line"></span><br><span class="line">  http_sd_configs:</span><br><span class="line">    - url: &#x27;https://secure-discovery.example.com/targets&#x27;</span><br><span class="line">      refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">      # TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &#x27;/etc/prometheus/certs/discovery_ca.crt&#x27;</span><br><span class="line">        cert_file: &#x27;/etc/prometheus/certs/client.crt&#x27;</span><br><span class="line">        key_file: &#x27;/etc/prometheus/certs/client.key&#x27;</span><br><span class="line">        server_name: &#x27;secure-discovery.example.com&#x27;</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">      # 认证</span><br><span class="line">      basic_auth:</span><br><span class="line">        username_file: &#x27;/etc/prometheus/secrets/discovery_user&#x27;</span><br><span class="line">        password_file: &#x27;/etc/prometheus/secrets/discovery_pass&#x27;</span><br><span class="line"></span><br><span class="line">  代理配置</span><br><span class="line"></span><br><span class="line">  http_sd_configs:</span><br><span class="line">    - url: &#x27;http://external-discovery.example.com/targets&#x27;</span><br><span class="line">      refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">      # 代理设置</span><br><span class="line">      proxy_url: &#x27;http://corporate-proxy:8080&#x27;</span><br><span class="line">      no_proxy: &#x27;localhost,.internal&#x27;</span><br><span class="line"></span><br><span class="line">      # 自定义头</span><br><span class="line">      http_headers:</span><br><span class="line">        User-Agent:</span><br><span class="line">          values: [&#x27;Prometheus-HTTP-SD/2.0&#x27;]</span><br><span class="line">        X-Client-ID:</span><br><span class="line">          values: [&#x27;prometheus-cluster-1&#x27;]</span><br><span class="line">        X-Environment:</span><br><span class="line">          values: [&#x27;production&#x27;]</span><br><span class="line"></span><br><span class="line">  OAuth 2.0 认证</span><br><span class="line"></span><br><span class="line">  http_sd_configs:</span><br><span class="line">    - url: &#x27;https://api.example.com/prometheus/targets&#x27;</span><br><span class="line">      refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">      # OAuth 2.0 配置</span><br><span class="line">      oauth2:</span><br><span class="line">        client_id: &#x27;prometheus-discovery&#x27;</span><br><span class="line">        client_secret_file: &#x27;/etc/prometheus/secrets/oauth_secret&#x27;</span><br><span class="line">        token_url: &#x27;https://auth.example.com/oauth2/token&#x27;</span><br><span class="line">        scopes: [&#x27;discovery:read&#x27;]</span><br><span class="line"></span><br><span class="line">        # TLS 配置</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &#x27;/etc/prometheus/certs/auth_ca.crt&#x27;</span><br><span class="line">          server_name: &#x27;auth.example.com&#x27;</span><br><span class="line"></span><br><span class="line">      # 目标端点 TLS</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &#x27;/etc/prometheus/certs/api_ca.crt&#x27;</span><br><span class="line">        server_name: &#x27;api.example.com&#x27;</span><br><span class="line"></span><br><span class="line">  元数据标签使用</span><br><span class="line"></span><br><span class="line">  __meta_url 标签</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;http-discovery&#x27;</span><br><span class="line">      http_sd_configs:</span><br><span class="line">        - url: &#x27;http://discovery.example.com/api/services&#x27;</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 添加源 URL 标签</span><br><span class="line">        - source_labels: [__meta_url]</span><br><span class="line">          target_label: discovery_url</span><br><span class="line"></span><br><span class="line">        # 从 URL 提取服务类型</span><br><span class="line">        - source_labels: [__meta_url]</span><br><span class="line">          target_label: service_type</span><br><span class="line">          regex: &#x27;.*/api/([^/]+).*&#x27;</span><br><span class="line">          replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">        # 从 URL 提取环境信息</span><br><span class="line">        - source_labels: [__meta_url]</span><br><span class="line">          target_label: environment</span><br><span class="line">          regex: &#x27;.*/(dev|staging|prod)/.*&#x27;</span><br><span class="line">          replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">  动态标签配置</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 组合发现源标签</span><br><span class="line">    - source_labels: [__meta_url, job]</span><br><span class="line">      target_label: full_job_name</span><br><span class="line">      regex: &#x27;(.*)/api/(.+);(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$1-$2-$3&#x27;</span><br><span class="line"></span><br><span class="line">    # 添加发现时间戳</span><br><span class="line">    - source_labels: [__meta_url]</span><br><span class="line">      target_label: discovery_method</span><br><span class="line">      replacement: &#x27;http_sd&#x27;</span><br><span class="line"></span><br><span class="line">  实际应用场景</span><br><span class="line"></span><br><span class="line">  1. 微服务注册中心集成</span><br><span class="line"></span><br><span class="line">  # Prometheus 配置</span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;microservices&#x27;</span><br><span class="line">      http_sd_configs:</span><br><span class="line">        - url: &#x27;http://service-registry.example.com/prometheus/targets&#x27;</span><br><span class="line">          refresh_interval: 30s</span><br><span class="line"></span><br><span class="line">          # 认证配置</span><br><span class="line">          basic_auth:</span><br><span class="line">            username_file: &#x27;/etc/prometheus/secrets/registry_user&#x27;</span><br><span class="line">            password_file: &#x27;/etc/prometheus/secrets/registry_pass&#x27;</span><br><span class="line"></span><br><span class="line">          # 自定义头</span><br><span class="line">          http_headers:</span><br><span class="line">            Accept:</span><br><span class="line">              values: [&#x27;application/json&#x27;]</span><br><span class="line">            X-Client-Name:</span><br><span class="line">              values: [&#x27;prometheus&#x27;]</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_url]</span><br><span class="line">          target_label: registry_url</span><br><span class="line"></span><br><span class="line">        # 服务标签处理</span><br><span class="line">        - source_labels: [service_name]</span><br><span class="line">          target_label: service</span><br><span class="line">        - source_labels: [environment]</span><br><span class="line">          target_label: env</span><br><span class="line"></span><br><span class="line">  2. 配置管理平台集成</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;config-managed-targets&#x27;</span><br><span class="line">      http_sd_configs:</span><br><span class="line">        - url: &#x27;https://config-manager.example.com/api/v1/prometheus/targets&#x27;</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">          # TLS 配置</span><br><span class="line">          tls_config:</span><br><span class="line">            ca_file: &#x27;/etc/prometheus/certs/config_manager_ca.crt&#x27;</span><br><span class="line">            server_name: &#x27;config-manager.example.com&#x27;</span><br><span class="line"></span><br><span class="line">          # API 认证</span><br><span class="line">          authorization:</span><br><span class="line">            type: &#x27;APIKey&#x27;</span><br><span class="line">            credentials_file: &#x27;/etc/prometheus/secrets/config_api_key&#x27;</span><br><span class="line"></span><br><span class="line">          # 自定义头</span><br><span class="line">          http_headers:</span><br><span class="line">            X-API-Version:</span><br><span class="line">              values: [&#x27;v1&#x27;]</span><br><span class="line">            X-Cluster:</span><br><span class="line">              values: [&#x27;production&#x27;]</span><br><span class="line"></span><br><span class="line">  3. 多环境配置管理</span><br><span class="line"></span><br><span class="line">  # 开发环境</span><br><span class="line">  - job_name: &#x27;dev-services&#x27;</span><br><span class="line">    http_sd_configs:</span><br><span class="line">      - url: &#x27;http://discovery.dev.example.com/targets&#x27;</span><br><span class="line">        refresh_interval: 30s</span><br><span class="line">        basic_auth:</span><br><span class="line">          username_file: &#x27;/etc/prometheus/secrets/dev_user&#x27;</span><br><span class="line">          password_file: &#x27;/etc/prometheus/secrets/dev_pass&#x27;</span><br><span class="line"></span><br><span class="line">  # 测试环境</span><br><span class="line">  - job_name: &#x27;staging-services&#x27;</span><br><span class="line">    http_sd_configs:</span><br><span class="line">      - url: &#x27;http://discovery.staging.example.com/targets&#x27;</span><br><span class="line">        refresh_interval: 60s</span><br><span class="line">        basic_auth:</span><br><span class="line">          username_file: &#x27;/etc/prometheus/secrets/staging_user&#x27;</span><br><span class="line">          password_file: &#x27;/etc/prometheus/secrets/staging_pass&#x27;</span><br><span class="line"></span><br><span class="line">  # 生产环境</span><br><span class="line">  - job_name: &#x27;prod-services&#x27;</span><br><span class="line">    http_sd_configs:</span><br><span class="line">      - url: &#x27;https://discovery.prod.example.com/targets&#x27;</span><br><span class="line">        refresh_interval: 60s</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &#x27;/etc/prometheus/certs/prod_ca.crt&#x27;</span><br><span class="line">        oauth2:</span><br><span class="line">          client_id: &#x27;prometheus-prod&#x27;</span><br><span class="line">          client_secret_file: &#x27;/etc/prometheus/secrets/prod_oauth&#x27;</span><br><span class="line">          token_url: &#x27;https://auth.prod.example.com/oauth2/token&#x27;</span><br><span class="line"></span><br><span class="line">  服务发现端点实现</span><br><span class="line"></span><br><span class="line">  Go 示例</span><br><span class="line"></span><br><span class="line">  package main</span><br><span class="line"></span><br><span class="line">  import (</span><br><span class="line">      &quot;encoding/json&quot;</span><br><span class="line">      &quot;log&quot;</span><br><span class="line">      &quot;net/http&quot;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  type Target struct &#123;</span><br><span class="line">      Targets []string          `json:&quot;targets&quot;`</span><br><span class="line">      Labels  map[string]string `json:&quot;labels&quot;`</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  func main() &#123;</span><br><span class="line">      http.HandleFunc(&quot;/targets&quot;, func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">          targets := []Target&#123;</span><br><span class="line">              &#123;</span><br><span class="line">                  Targets: []string&#123;&quot;web1:8080&quot;, &quot;web2:8080&quot;&#125;,</span><br><span class="line">                  Labels: map[string]string&#123;</span><br><span class="line">                      &quot;job&quot;:        &quot;web-services&quot;,</span><br><span class="line">                      &quot;env&quot;:        &quot;production&quot;,</span><br><span class="line">                      &quot;datacenter&quot;: &quot;us-west-2&quot;,</span><br><span class="line">                  &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                  Targets: []string&#123;&quot;db1:5432&quot;&#125;,</span><br><span class="line">                  Labels: map[string]string&#123;</span><br><span class="line">                      &quot;job&quot;:        &quot;databases&quot;,</span><br><span class="line">                      &quot;env&quot;:        &quot;production&quot;,</span><br><span class="line">                      &quot;datacenter&quot;: &quot;us-west-2&quot;,</span><br><span class="line">                  &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)</span><br><span class="line">          json.NewEncoder(w).Encode(targets)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      log.Println(&quot;Service discovery server listening on :8080&quot;)</span><br><span class="line">      http.ListenAndServe(&quot;:8080&quot;, nil)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Python 示例</span><br><span class="line"></span><br><span class="line">  from flask import Flask, jsonify</span><br><span class="line">  import redis</span><br><span class="line">  import json</span><br><span class="line"></span><br><span class="line">  app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">  @app.route(&#x27;/targets&#x27;)</span><br><span class="line">  def get_targets():</span><br><span class="line">      # 从 Redis 或数据库获取目标</span><br><span class="line">      r = redis.Redis(host=&#x27;redis&#x27;, port=6379, db=0)</span><br><span class="line"></span><br><span class="line">      targets = []</span><br><span class="line"></span><br><span class="line">      # 获取服务注册信息</span><br><span class="line">      services = r.smembers(&#x27;services&#x27;)</span><br><span class="line">      for service in services:</span><br><span class="line">          instances = r.smembers(f&#x27;service:&#123;service&#125;:instances&#x27;)</span><br><span class="line">          for instance in instances:</span><br><span class="line">              targets.append(&#123;</span><br><span class="line">                  &quot;targets&quot;: [instance],</span><br><span class="line">                  &quot;labels&quot;: &#123;</span><br><span class="line">                      &quot;job&quot;: service,</span><br><span class="line">                      &quot;env&quot;: r.hget(f&#x27;service:&#123;service&#125;&#x27;, &#x27;env&#x27;) or &#x27;unknown&#x27;,</span><br><span class="line">                      &quot;version&quot;: r.hget(f&#x27;service:&#123;service&#125;&#x27;, &#x27;version&#x27;) or &#x27;unknown&#x27;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;)</span><br><span class="line"></span><br><span class="line">      return jsonify(targets)</span><br><span class="line"></span><br><span class="line">  if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">      app.run(host=&#x27;0.0.0.0&#x27;, port=8080)</span><br><span class="line"></span><br><span class="line">  高级配置</span><br><span class="line"></span><br><span class="line">  1. 带重试和超时的配置</span><br><span class="line"></span><br><span class="line">  http_sd_configs:</span><br><span class="line">    - url: &#x27;https://unreliable-discovery.example.com/targets&#x27;</span><br><span class="line">      refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">      # HTTP 客户端配置</span><br><span class="line">      scrape_timeout: 10s</span><br><span class="line">      scrape_interval: 60s</span><br><span class="line"></span><br><span class="line">      # TLS 配置</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &#x27;/etc/prometheus/certs/ca.crt&#x27;</span><br><span class="line"></span><br><span class="line">      # 代理配置</span><br><span class="line">      proxy_url: &#x27;http://proxy:8080&#x27;</span><br><span class="line"></span><br><span class="line">      # 自定义头</span><br><span class="line">      http_headers:</span><br><span class="line">        Timeout:</span><br><span class="line">          values: [&#x27;10&#x27;]</span><br><span class="line">        Retry-Count:</span><br><span class="line">          values: [&#x27;3&#x27;]</span><br><span class="line"></span><br><span class="line">  2. 多源聚合配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;aggregated-services&#x27;</span><br><span class="line">      http_sd_configs:</span><br><span class="line">        # 主要服务发现</span><br><span class="line">        - url: &#x27;http://primary-discovery.example.com/targets&#x27;</span><br><span class="line">          refresh_interval: 30s</span><br><span class="line">          http_headers:</span><br><span class="line">            X-Priority:</span><br><span class="line">              values: [&#x27;primary&#x27;]</span><br><span class="line"></span><br><span class="line">        # 备用服务发现</span><br><span class="line">        - url: &#x27;http://backup-discovery.example.com/targets&#x27;</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line">          http_headers:</span><br><span class="line">            X-Priority:</span><br><span class="line">              values: [&#x27;backup&#x27;]</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 添加优先级标签</span><br><span class="line">        - source_labels: [__meta_url]</span><br><span class="line">          target_label: discovery_priority</span><br><span class="line">          regex: &#x27;.*primary.*&#x27;</span><br><span class="line">          replacement: &#x27;high&#x27;</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_url]</span><br><span class="line">          target_label: discovery_priority</span><br><span class="line">          regex: &#x27;.*backup.*&#x27;</span><br><span class="line">          replacement: &#x27;low&#x27;</span><br><span class="line"></span><br><span class="line">  监控和调试</span><br><span class="line"></span><br><span class="line">  监控 HTTP SD 状态</span><br><span class="line"></span><br><span class="line">  # Prometheus 自身监控</span><br><span class="line">  - job_name: &#x27;prometheus-self&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line"></span><br><span class="line">  # 可以监控以下指标：</span><br><span class="line">  # prometheus_sd_http_failures_total&#123;url=&quot;http://discovery.example.com/targets&quot;&#125;</span><br><span class="line">  # prometheus_target_interval_length_seconds_count&#123;scrape_job=&quot;http-discovery&quot;&#125;</span><br><span class="line"></span><br><span class="line">  故障排查</span><br><span class="line"></span><br><span class="line">  # 手动测试服务发现端点</span><br><span class="line">  curl -H &quot;Accept: application/json&quot; \</span><br><span class="line">       -H &quot;User-Agent: Prometheus/2.0&quot; \</span><br><span class="line">       http://discovery.example.com/targets</span><br><span class="line"></span><br><span class="line">  # 检查响应格式</span><br><span class="line">  curl -s http://discovery.example.com/targets | jq .</span><br><span class="line"></span><br><span class="line">  # 验证 Content-Type</span><br><span class="line">  curl -I http://discovery.example.com/targets</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 端点设计</span><br><span class="line"></span><br><span class="line">  - 始终返回 HTTP 200 状态码</span><br><span class="line">  - 设置正确的 Content-Type: application/json</span><br><span class="line">  - 响应时间控制在秒级</span><br><span class="line">  - 实现缓存机制减少后端压力</span><br><span class="line"></span><br><span class="line">  2. 错误处理</span><br><span class="line"></span><br><span class="line">  - 实现健康检查端点</span><br><span class="line">  - 记录请求日志</span><br><span class="line">  - 提供故障转移机制</span><br><span class="line">  - 设置合理的超时时间</span><br><span class="line"></span><br><span class="line">  3. 安全考虑</span><br><span class="line"></span><br><span class="line">  - 使用 HTTPS 传输</span><br><span class="line">  - 实现适当的认证和授权</span><br><span class="line">  - 限制访问频率</span><br><span class="line">  - 验证输入参数</span><br><span class="line"></span><br><span class="line">  HTTP SD 为 Prometheus 提供了强大的远程服务发现能力，特别适合云原生和微服务架构环境。</span><br></pre></td></tr></table></figure>

<h4 id="kubernetes-sd-config"><a href="#kubernetes-sd-config" class="headerlink" title="kubernetes_sd_config"></a>kubernetes_sd_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br></pre></td><td class="code"><pre><span class="line">⏺ Kubernetes 服务发现详细解释</span><br><span class="line"></span><br><span class="line">  Kubernetes 服务发现是 Prometheus 最强大的功能之一，通过与 Kubernetes API 集成自动发现和监控集群中的资源。</span><br><span class="line"></span><br><span class="line">  六种角色类型详解</span><br><span class="line"></span><br><span class="line">  1. Node Role (节点角色)</span><br><span class="line"></span><br><span class="line">  用途: 监控 Kubernetes 集群的节点</span><br><span class="line"></span><br><span class="line">  工作机制:</span><br><span class="line">  - 为每个集群节点创建一个监控目标</span><br><span class="line">  - 默认地址为 Kubelet HTTP 端口 (通常为 10250)</span><br><span class="line">  - 地址优先级: NodeInternalIP &gt; NodeExternalIP &gt; NodeLegacyHostIP &gt; NodeHostName</span><br><span class="line"></span><br><span class="line">  元数据标签:</span><br><span class="line">  __meta_kubernetes_node_name              # 节点名称</span><br><span class="line">  __meta_kubernetes_node_provider_id       # 云提供商的节点 ID</span><br><span class="line">  __meta_kubernetes_node_label_&lt;label&gt;     # 节点标签</span><br><span class="line">  __meta_kubernetes_node_labelpresent_&lt;label&gt;  # 标签存在标记</span><br><span class="line">  __meta_kubernetes_node_annotation_&lt;annotation&gt;   # 节点注解</span><br><span class="line">  __meta_kubernetes_node_address_&lt;type&gt;    # 节点地址 (InternalIP, ExternalIP, etc.)</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  - job_name: &#x27;kubernetes-nodes&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: node</span><br><span class="line">          attach_metadata:</span><br><span class="line">            node: true  # 附加节点元数据</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">          target_label: node_name</span><br><span class="line">        - source_labels: [__meta_kubernetes_node_label_kubernetes_io_arch]</span><br><span class="line">          target_label: architecture</span><br><span class="line"></span><br><span class="line">  2. Service Role (服务角色)</span><br><span class="line"></span><br><span class="line">  用途: 监控 Kubernetes 服务，适合黑盒监控</span><br><span class="line"></span><br><span class="line">  工作机制:</span><br><span class="line">  - 为每个服务的每个端口创建监控目标</span><br><span class="line">  - 地址设置为 Kubernetes DNS 名称</span><br><span class="line">  - 适合监控服务可用性和响应时间</span><br><span class="line"></span><br><span class="line">  元数据标签:</span><br><span class="line">  __meta_kubernetes_namespace                    # 命名空间</span><br><span class="line">  __meta_kubernetes_service_annotation_&lt;anno&gt;     # 服务注解</span><br><span class="line">  __meta_kubernetes_service_cluster_ip            # 集群 IP</span><br><span class="line">  __meta_kubernetes_service_loadbalancer_ip       # 负载均衡器 IP</span><br><span class="line">  __meta_kubernetes_service_external_name         # 外部名称</span><br><span class="line">  __meta_kubernetes_service_label_&lt;label&gt;         # 服务标签</span><br><span class="line">  __meta_kubernetes_service_name                  # 服务名称</span><br><span class="line">  __meta_kubernetes_service_port_name             # 端口名称</span><br><span class="line">  __meta_kubernetes_service_port_number           # 端口号</span><br><span class="line">  __meta_kubernetes_service_port_protocol         # 端口协议</span><br><span class="line">  __meta_kubernetes_service_type                  # 服务类型 (ClusterIP, NodePort, LoadBalancer)</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  - job_name: &#x27;kubernetes-services&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: service</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&#x27;default&#x27;, &#x27;monitoring&#x27;]</span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 只监控带特定注解的服务</span><br><span class="line">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        # 设置服务类型标签</span><br><span class="line">        - source_labels: [__meta_kubernetes_service_type]</span><br><span class="line">          target_label: service_type</span><br><span class="line"></span><br><span class="line">  3. Pod Role (Pod 角色)</span><br><span class="line"></span><br><span class="line">  用途: 直接监控 Pod 容器，最常用和灵活的角色</span><br><span class="line"></span><br><span class="line">  工作机制:</span><br><span class="line">  - 发现所有 Pod 并将其容器作为目标</span><br><span class="line">  - 为每个容器声明的端口创建目标</span><br><span class="line">  - 如果容器没有指定端口，创建无端口目标供手动配置</span><br><span class="line"></span><br><span class="line">  元数据标签:</span><br><span class="line">  __meta_kubernetes_namespace                      # 命名空间</span><br><span class="line">  __meta_kubernetes_pod_name                       # Pod 名称</span><br><span class="line">  __meta_kubernetes_pod_ip                         # Pod IP</span><br><span class="line">  __meta_kubernetes_pod_label_&lt;label&gt;              # Pod 标签</span><br><span class="line">  __meta_kubernetes_pod_annotation_&lt;annotation&gt;     # Pod 注解</span><br><span class="line">  __meta_kubernetes_pod_container_init             # 是否为 InitContainer</span><br><span class="line">  __meta_kubernetes_pod_container_name             # 容器名称</span><br><span class="line">  __meta_kubernetes_pod_container_id               # 容器 ID</span><br><span class="line">  __meta_kubernetes_pod_container_image            # 容器镜像</span><br><span class="line">  __meta_kubernetes_pod_container_port_name        # 容器端口名称</span><br><span class="line">  __meta_kubernetes_pod_container_port_number      # 容器端口号</span><br><span class="line">  __meta_kubernetes_pod_container_port_protocol    # 容器端口协议</span><br><span class="line">  __meta_kubernetes_pod_ready                      # Pod 就绪状态</span><br><span class="line">  __meta_kubernetes_pod_phase                      # Pod 阶段 (Pending, Running, etc.)</span><br><span class="line">  __meta_kubernetes_pod_node_name                  # Pod 所在节点</span><br><span class="line">  __meta_kubernetes_pod_host_ip                    # Pod 主机 IP</span><br><span class="line">  __meta_kubernetes_pod_uid                        # Pod UID</span><br><span class="line">  __meta_kubernetes_pod_controller_kind            # 控制器类型 (Deployment, StatefulSet, etc.)</span><br><span class="line">  __meta_kubernetes_pod_controller_name            # 控制器名称</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  - job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: pod</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&#x27;default&#x27;, &#x27;production&#x27;]</span><br><span class="line">          attach_metadata:</span><br><span class="line">            node: true</span><br><span class="line">            namespace: true</span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 只监控带特定注解的 Pod</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        # 设置抓取端口</span><br><span class="line">        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">          action: replace</span><br><span class="line">          regex: &#x27;([^:]+)(?::\d+)?;(\d+)&#x27;</span><br><span class="line">          replacement: &#x27;$1:$2&#x27;</span><br><span class="line">          target_label: __address__</span><br><span class="line"></span><br><span class="line">        # 设置抓取路径</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __metrics_path__</span><br><span class="line">          regex: (.+)</span><br><span class="line"></span><br><span class="line">        # 添加控制器信息</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_controller_kind]</span><br><span class="line">          target_label: controller_kind</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_controller_name]</span><br><span class="line">          target_label: controller_name</span><br><span class="line"></span><br><span class="line">⏺ 4. Endpoints Role (端点角色) ⚠️ 已弃用</span><br><span class="line"></span><br><span class="line">  重要提示: Endpoints API 在 Kubernetes v1.33+ 中已弃用，推荐使用 EndpointSlice 角色。</span><br><span class="line"></span><br><span class="line">  用途: 监控服务的端点，即实际运行的服务实例</span><br><span class="line"></span><br><span class="line">  工作机制:</span><br><span class="line">  - 从服务的端点列表中发现目标</span><br><span class="line">  - 为每个端点地址的每个端口创建目标</span><br><span class="line">  - 如果端点由 Pod 支持，还会发现 Pod 的其他容器端口</span><br><span class="line"></span><br><span class="line">  5. EndpointSlice Role (端点切片角色) ✅ 推荐</span><br><span class="line"></span><br><span class="line">  用途: 现代化的端点发现，替代 Endpoints 角色</span><br><span class="line"></span><br><span class="line">  优势:</span><br><span class="line">  - 适用于大规模集群，性能更好</span><br><span class="line">  - 减少 Kubernetes API 负载</span><br><span class="line">  - 需要 discovery.k8s.io/v1 API (Kubernetes v1.21+)</span><br><span class="line"></span><br><span class="line">  特有元数据标签:</span><br><span class="line">  __meta_kubernetes_endpointslice_name                           # EndpointSlice 名称</span><br><span class="line">  __meta_kubernetes_endpointslice_label_&lt;label&gt;                  # EndpointSlice 标签</span><br><span class="line">  __meta_kubernetes_endpointslice_annotation_&lt;annotation&gt;         # EndpointSlice 注解</span><br><span class="line">  __meta_kubernetes_endpointslice_address_target_kind            # 目标对象类型</span><br><span class="line">  __meta_kubernetes_endpointslice_address_target_name            # 目标对象名称</span><br><span class="line">  __meta_kubernetes_endpointslice_address_type                   # 地址类型 (IPv4, IPv6, FQDN)</span><br><span class="line">  __meta_kubernetes_endpointslice_endpoint_conditions_ready     # 端点就绪状态</span><br><span class="line">  __meta_kubernetes_endpointslice_endpoint_conditions_serving    # 端点服务状态</span><br><span class="line">  __meta_kubernetes_endpointslice_endpoint_conditions_terminating # 端点终止状态</span><br><span class="line">  __meta_kubernetes_endpointslice_endpoint_topology_kubernetes_io_hostname # 节点主机名</span><br><span class="line">  __meta_kubernetes_endpointslice_endpoint_node_name             # 节点名称</span><br><span class="line">  __meta_kubernetes_endpointslice_endpoint_zone                  # 可用区</span><br><span class="line">  __meta_kubernetes_endpointslice_port                           # 端口号</span><br><span class="line">  __meta_kubernetes_endpointslice_port_name                      # 端口名称</span><br><span class="line">  __meta_kubernetes_endpointslice_port_protocol                  # 端口协议</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  - job_name: &#x27;kubernetes-endpointslices&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpointslice</span><br><span class="line">          namespaces:</span><br><span class="line">            own_namespace: false</span><br><span class="line">            names: [&#x27;default&#x27;, &#x27;production&#x27;]</span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 只监控就绪的端点</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpointslice_endpoint_conditions_ready]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        # 添加拓扑信息</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpointslice_endpoint_zone]</span><br><span class="line">          target_label: availability_zone</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpointslice_endpoint_node_name]</span><br><span class="line">          target_label: node_name</span><br><span class="line"></span><br><span class="line">  6. Ingress Role (入口角色)</span><br><span class="line"></span><br><span class="line">  用途: 监控 Ingress 资源，适合黑盒监控</span><br><span class="line"></span><br><span class="line">  工作机制:</span><br><span class="line">  - 为每个 Ingress 的每个路径创建目标</span><br><span class="line">  - 地址设置为 Ingress 规范中的主机名</span><br><span class="line">  - 需要 networking.k8s.io/v1 API (Kubernetes v1.19+)</span><br><span class="line"></span><br><span class="line">  元数据标签:</span><br><span class="line">  __meta_kubernetes_namespace                      # 命名空间</span><br><span class="line">  __meta_kubernetes_ingress_name                   # Ingress 名称</span><br><span class="line">  __meta_kubernetes_ingress_label_&lt;label&gt;          # Ingress 标签</span><br><span class="line">  __meta_kubernetes_ingress_annotation_&lt;annotation&gt; # Ingress 注解</span><br><span class="line">  __meta_kubernetes_ingress_class_name             # Ingress 类名</span><br><span class="line">  __meta_kubernetes_ingress_scheme                 # 协议方案 (http/https)</span><br><span class="line">  __meta_kubernetes_ingress_path                   # 路径</span><br><span class="line"></span><br><span class="line">  配置示例:</span><br><span class="line">  - job_name: &#x27;kubernetes-ingress&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: ingress</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&#x27;ingress-nginx&#x27;, &#x27;default&#x27;]</span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 设置地址为 Ingress 主机名</span><br><span class="line">        - source_labels: [__meta_kubernetes_ingress_scheme, __meta_kubernetes_ingress_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __address__</span><br><span class="line">          regex: (.+);(.+)</span><br><span class="line">          replacement: $1</span><br><span class="line">          separator: &#x27;;&#x27;</span><br><span class="line"></span><br><span class="line">        # 添加路径标签</span><br><span class="line">        - source_labels: [__meta_kubernetes_ingress_path]</span><br><span class="line">          target_label: ingress_path</span><br><span class="line"></span><br><span class="line">        # 添加 Ingress 类标签</span><br><span class="line">        - source_labels: [__meta_kubernetes_ingress_class_name]</span><br><span class="line">          target_label: ingress_class</span><br><span class="line"></span><br><span class="line">⏺ 配置选项详解</span><br><span class="line"></span><br><span class="line">  基础连接配置</span><br><span class="line"></span><br><span class="line">  api_server - API 服务器地址</span><br><span class="line"></span><br><span class="line">  # 空值表示在集群内运行，自动发现</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      # api_server: 留空使用集群内配置</span><br><span class="line"></span><br><span class="line">  # 外部集群配置</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      api_server: &#x27;https://kubernetes.example.com:6443&#x27;</span><br><span class="line"></span><br><span class="line">  kubeconfig_file - Kubeconfig 文件</span><br><span class="line"></span><br><span class="line">  # 使用外部 kubeconfig</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      kubeconfig_file: &#x27;/etc/prometheus/kubeconfig&#x27;</span><br><span class="line">      # 注意：api_server 和 kubeconfig_file 互斥</span><br><span class="line"></span><br><span class="line">  命名空间配置</span><br><span class="line"></span><br><span class="line">  namespaces - 命名空间发现</span><br><span class="line"></span><br><span class="line">  # 监控所有命名空间</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      namespaces:</span><br><span class="line">        own_namespace: false  # 不限制当前命名空间</span><br><span class="line"></span><br><span class="line">  # 只监控指定命名空间</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      namespaces:</span><br><span class="line">        own_namespace: false</span><br><span class="line">        names:</span><br><span class="line">          - &#x27;default&#x27;</span><br><span class="line">          - &#x27;monitoring&#x27;</span><br><span class="line">          - &#x27;production&#x27;</span><br><span class="line">          - &#x27;staging&#x27;</span><br><span class="line"></span><br><span class="line">  # 只监控当前命名空间</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      namespaces:</span><br><span class="line">        own_namespace: true</span><br><span class="line"></span><br><span class="line">  选择器配置</span><br><span class="line"></span><br><span class="line">  selectors - 标签和字段选择器</span><br><span class="line"></span><br><span class="line">  # Pod 角色选择器</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      selectors:</span><br><span class="line">        - role: pod</span><br><span class="line">          label: &#x27;app=nginx&#x27;                    # 标签选择器</span><br><span class="line">          field: &#x27;status.phase=Running&#x27;        # 字段选择器</span><br><span class="line"></span><br><span class="line">  # Service 角色选择器</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: service</span><br><span class="line">      selectors:</span><br><span class="line">        - role: service</span><br><span class="line">          label: &#x27;monitoring.enabled=true&#x27;     # 只监控启用监控的服务</span><br><span class="line"></span><br><span class="line">  # Node 角色选择器</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: node</span><br><span class="line">      selectors:</span><br><span class="line">        - role: node</span><br><span class="line">          label: &#x27;node-type=worker&#x27;            # 只监控工作节点</span><br><span class="line"></span><br><span class="line">  # Endpoints 角色支持多类型选择器</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: endpoints</span><br><span class="line">      selectors:</span><br><span class="line">        - role: service</span><br><span class="line">          label: &#x27;service-type=monitoring&#x27;</span><br><span class="line">        - role: pod</span><br><span class="line">          label: &#x27;monitor=true&#x27;</span><br><span class="line"></span><br><span class="line">  元数据附加配置</span><br><span class="line"></span><br><span class="line">  attach_metadata - 附加元数据</span><br><span class="line"></span><br><span class="line">  # 附加节点和命名空间元数据</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      attach_metadata:</span><br><span class="line">        node: true        # 附加节点元数据（需要节点访问权限）</span><br><span class="line">        namespace: true   # 附加命名空间元数据（需要命名空间访问权限）</span><br><span class="line"></span><br><span class="line">  # 只附加命名空间元数据</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: service</span><br><span class="line">      attach_metadata:</span><br><span class="line">        namespace: true</span><br><span class="line">        node: false</span><br><span class="line"></span><br><span class="line">  HTTP 客户端配置</span><br><span class="line"></span><br><span class="line">  认证配置</span><br><span class="line"></span><br><span class="line">  # 基础认证</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      basic_auth:</span><br><span class="line">        username_file: &#x27;/etc/prometheus/secrets/k8s_user&#x27;</span><br><span class="line">        password_file: &#x27;/etc/prometheus/secrets/k8s_pass&#x27;</span><br><span class="line"></span><br><span class="line">  # 令牌认证</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      authorization:</span><br><span class="line">        type: &#x27;Bearer&#x27;</span><br><span class="line">        credentials_file: &#x27;/etc/prometheus/secrets/k8s_token&#x27;</span><br><span class="line"></span><br><span class="line">  # TLS 配置</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &#x27;/etc/prometheus/certs/k8s_ca.crt&#x27;</span><br><span class="line">        cert_file: &#x27;/etc/prometheus/certs/client.crt&#x27;</span><br><span class="line">        key_file: &#x27;/etc/prometheus/certs/client.key&#x27;</span><br><span class="line">        server_name: &#x27;kubernetes.example.com&#x27;</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  代理配置</span><br><span class="line"></span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      proxy_url: &#x27;http://corporate-proxy:8080&#x27;</span><br><span class="line">      no_proxy: &#x27;localhost,.cluster.local,.svc&#x27;</span><br><span class="line">      proxy_from_environment: true</span><br><span class="line"></span><br><span class="line">⏺ 完整配置示例</span><br><span class="line"></span><br><span class="line">  1. 生产环境 Pod 监控</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;kubernetes-pods-production&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: pod</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&#x27;production&#x27;, &#x27;monitoring&#x27;]</span><br><span class="line">          attach_metadata:</span><br><span class="line">            node: true</span><br><span class="line">            namespace: true</span><br><span class="line">          # 性能优化：使用选择器减少不必要的资源</span><br><span class="line">          selectors:</span><br><span class="line">            - role: pod</span><br><span class="line">              label: &#x27;prometheus.io/scrape=true&#x27;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 只监控带特定注解的 Pod</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        # 设置抓取端口</span><br><span class="line">        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">          action: replace</span><br><span class="line">          regex: &#x27;([^:]+)(?::\d+)?;(\d+)&#x27;</span><br><span class="line">          replacement: &#x27;$1:$2&#x27;</span><br><span class="line">          target_label: __address__</span><br><span class="line"></span><br><span class="line">        # 设置抓取路径</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __metrics_path__</span><br><span class="line">          regex: (.+)</span><br><span class="line"></span><br><span class="line">        # 添加环境和服务标签</span><br><span class="line">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">          target_label: environment</span><br><span class="line">          replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_label_app]</span><br><span class="line">          target_label: service</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_label_version]</span><br><span class="line">          target_label: version</span><br><span class="line"></span><br><span class="line">        # 添加控制器信息</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_controller_kind]</span><br><span class="line">          target_label: controller_kind</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_controller_name]</span><br><span class="line">          target_label: controller_name</span><br><span class="line"></span><br><span class="line">        # 添加节点信息</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_node_name]</span><br><span class="line">          target_label: node_name</span><br><span class="line"></span><br><span class="line">        # 删除不需要的标签</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: __meta_kubernetes_pod_annotation_.+</span><br><span class="line"></span><br><span class="line">  2. 多环境服务发现配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 开发环境 - 使用 Endpoints（小规模）</span><br><span class="line">    - job_name: &#x27;kubernetes-dev-services&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpoints</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&#x27;development&#x27;]</span><br><span class="line">          selectors:</span><br><span class="line">            - role: service</span><br><span class="line">              label: &#x27;env=dev&#x27;</span><br><span class="line">              label: &#x27;monitoring.enabled=true&#x27;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpoint_ready]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">          target_label: environment</span><br><span class="line">          replacement: &#x27;development&#x27;</span><br><span class="line"></span><br><span class="line">    # 生产环境 - 使用 EndpointSlice（大规模）</span><br><span class="line">    - job_name: &#x27;kubernetes-prod-services&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpointslice</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&#x27;production&#x27;]</span><br><span class="line">          selectors:</span><br><span class="line">            - role: endpointslice</span><br><span class="line">              label: &#x27;env=prod&#x27;</span><br><span class="line">              label: &#x27;monitoring.enabled=true&#x27;</span><br><span class="line">          attach_metadata:</span><br><span class="line">            node: true</span><br><span class="line">            namespace: true</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_endpointslice_endpoint_conditions_ready]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_endpointslice_endpoint_zone]</span><br><span class="line">          target_label: availability_zone</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">          target_label: environment</span><br><span class="line">          replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">  3. Ingress 黑盒监控配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;kubernetes-ingress-blackbox&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: ingress</span><br><span class="line">          namespaces:</span><br><span class="line">            names: [&#x27;ingress-nginx&#x27;, &#x27;default&#x27;, &#x27;production&#x27;]</span><br><span class="line">          selectors:</span><br><span class="line">            - role: ingress</span><br><span class="line">              label: &#x27;monitoring.blackbox=true&#x27;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 设置监控地址</span><br><span class="line">        - source_labels: [__meta_kubernetes_ingress_scheme]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __param_target</span><br><span class="line">          regex: (https?)</span><br><span class="line">          replacement: $&#123;1&#125;://__address__</span><br><span class="line"></span><br><span class="line">        # 设置 Ingress 路径</span><br><span class="line">        - source_labels: [__meta_kubernetes_ingress_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __param_module</span><br><span class="line">          regex: (.+)</span><br><span class="line">          replacement: http_2xx</span><br><span class="line"></span><br><span class="line">        # 添加主机名标签</span><br><span class="line">        - source_labels: [__address__]</span><br><span class="line">          target_label: instance</span><br><span class="line"></span><br><span class="line">        # 添加路径标签</span><br><span class="line">        - source_labels: [__meta_kubernetes_ingress_path]</span><br><span class="line">          target_label: ingress_path</span><br><span class="line"></span><br><span class="line">        # 添加命名空间标签</span><br><span class="line">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">          target_label: namespace</span><br><span class="line"></span><br><span class="line">        # 设置抓取地址为 Blackbox Exporter</span><br><span class="line">        - source_labels: []</span><br><span class="line">          target_label: __address__</span><br><span class="line">          replacement: &#x27;blackbox-exporter:9115&#x27;</span><br><span class="line"></span><br><span class="line">  4. 节点和基础设施监控</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 节点监控</span><br><span class="line">    - job_name: &#x27;kubernetes-nodes&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: node</span><br><span class="line">          attach_metadata:</span><br><span class="line">            node: true</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">          target_label: node_name</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_node_label_kubernetes_io_instance_type]</span><br><span class="line">          target_label: instance_type</span><br><span class="line"></span><br><span class="line">        - source_labels: [__meta_kubernetes_node_label_topology_kubernetes_io_zone]</span><br><span class="line">          target_label: availability_zone</span><br><span class="line"></span><br><span class="line">        # 设置抓取端口</span><br><span class="line">        - source_labels: [__address__]</span><br><span class="line">          target_label: __address__</span><br><span class="line">          regex: &#x27;(.+):10250&#x27;</span><br><span class="line">          replacement: &#x27;$1:9100&#x27;  # 假设运行 node-exporter</span><br><span class="line"></span><br><span class="line">    # 节点网络监控</span><br><span class="line">    - job_name: &#x27;kubernetes-nodes-network&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: node</span><br><span class="line">          selectors:</span><br><span class="line">            - role: node</span><br><span class="line">              label: &#x27;network-monitoring=true&#x27;</span><br><span class="line"></span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__address__]</span><br><span class="line">          target_label: __address__</span><br><span class="line">          regex: &#x27;(.+):10250&#x27;</span><br><span class="line">          replacement: &#x27;$1:9101&#x27;  # 假设网络监控端口</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 性能优化</span><br><span class="line"></span><br><span class="line">  选择器优化</span><br><span class="line"></span><br><span class="line">  # ❌ 避免无选择器的大规模发现</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      # 这会监控所有 Pod，性能开销大</span><br><span class="line"></span><br><span class="line">  # ✅ 使用精确的选择器</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      selectors:</span><br><span class="line">        - role: pod</span><br><span class="line">          label: &#x27;prometheus.io/scrape=true&#x27;</span><br><span class="line">          field: &#x27;status.phase=Running&#x27;</span><br><span class="line"></span><br><span class="line">  使用 EndpointSlice</span><br><span class="line"></span><br><span class="line">  # ✅ 大规模集群使用 EndpointSlice</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: endpointslice  # 而不是 endpoints</span><br><span class="line"></span><br><span class="line">  # ✅ 小规模集群可以使用 Endpoints</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: endpoints     # 节点 &lt; 100</span><br><span class="line"></span><br><span class="line">  2. 标签管理</span><br><span class="line"></span><br><span class="line">  标准化注解</span><br><span class="line"></span><br><span class="line">  # Pod 注解标准</span><br><span class="line">  apiVersion: v1</span><br><span class="line">  kind: Pod</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">      prometheus.io/port: &quot;8080&quot;</span><br><span class="line">      prometheus.io/path: &quot;/metrics&quot;</span><br><span class="line">      prometheus.io/scheme: &quot;http&quot;</span><br><span class="line">    labels:</span><br><span class="line">      app: &quot;my-app&quot;</span><br><span class="line">      version: &quot;v1.2.0&quot;</span><br><span class="line">      env: &quot;production&quot;</span><br><span class="line">      team: &quot;backend&quot;</span><br><span class="line"></span><br><span class="line">  标签清理</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 保留有用的标签</span><br><span class="line">    - action: labelkeep</span><br><span class="line">      regex: &#x27;(job|instance|namespace|service|version|team|env)&#x27;</span><br><span class="line"></span><br><span class="line">    # 删除敏感或冗余标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;__meta_kubernetes_pod_annotation_.+&#x27;</span><br><span class="line"></span><br><span class="line">  3. 安全配置</span><br><span class="line"></span><br><span class="line">  RBAC 权限最小化</span><br><span class="line"></span><br><span class="line">  # ServiceAccount 配置</span><br><span class="line">  apiVersion: v1</span><br><span class="line">  kind: ServiceAccount</span><br><span class="line">  metadata:</span><br><span class="line">    name: prometheus</span><br><span class="line">    namespace: monitoring</span><br><span class="line"></span><br><span class="line">  ---</span><br><span class="line">  # 最小权限的 RBAC</span><br><span class="line">  apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  metadata:</span><br><span class="line">    name: prometheus</span><br><span class="line">  rules:</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;nodes&quot;, &quot;services&quot;, &quot;endpoints&quot;, &quot;pods&quot;, &quot;namespaces&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">  - apiGroups: [&quot;discovery.k8s.io&quot;]</span><br><span class="line">    resources: [&quot;endpointslices&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line"></span><br><span class="line">  TLS 配置</span><br><span class="line"></span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: &#x27;/etc/prometheus/secrets/ca.crt&#x27;</span><br><span class="line">        cert_file: &#x27;/etc/prometheus/secrets/client.crt&#x27;</span><br><span class="line">        key_file: &#x27;/etc/prometheus/secrets/client.key&#x27;</span><br><span class="line">        server_name: &#x27;kubernetes.default.svc&#x27;</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  4. 监控配置健康状态</span><br><span class="line"></span><br><span class="line">  # 监控 Kubernetes SD 自身状态</span><br><span class="line">  - job_name: &#x27;prometheus-self&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">      scrape_interval: 30s</span><br><span class="line"></span><br><span class="line">  # 关键指标监控</span><br><span class="line">  # prometheus_sd_kubernetes_events_total</span><br><span class="line">  # prometheus_target_interval_length_seconds_count</span><br><span class="line">  # prometheus_sd_discovered_targets</span><br><span class="line"></span><br><span class="line">⏺ 性能考虑和优化建议</span><br><span class="line"></span><br><span class="line">  1. 规模化建议</span><br><span class="line"></span><br><span class="line">  集群规模对应的策略</span><br><span class="line"></span><br><span class="line">  # 小型集群 (&lt; 100 节点, &lt; 1000 Pod)</span><br><span class="line">  - 使用 Endpoints 角色</span><br><span class="line">  - 可以使用较少的选择器</span><br><span class="line">  - 刷新间隔可以较短 (30s)</span><br><span class="line"></span><br><span class="line">  # 中型集群 (100-500 节点, 1000-5000 Pod)</span><br><span class="line">  - 使用 EndpointSlice 角色</span><br><span class="line">  - 使用精确的选择器</span><br><span class="line">  - 适中的刷新间隔 (60s)</span><br><span class="line"></span><br><span class="line">  # 大型集群 (&gt; 500 节点, &gt; 5000 Pod)</span><br><span class="line">  - 必须使用 EndpointSlice 角色</span><br><span class="line">  - 严格的选择器过滤</span><br><span class="line">  - 较长的刷新间隔 (2-5m)</span><br><span class="line">  - 考虑分命名空间监控</span><br><span class="line"></span><br><span class="line">  选择器性能影响</span><br><span class="line"></span><br><span class="line">  # ⚠️ 每个选择器组合会创建独立的 LIST/WATCH</span><br><span class="line">  # ❌ 性能差：过多选择器组合</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      selectors:</span><br><span class="line">        - role: pod</span><br><span class="line">          label: &#x27;env=prod&#x27;</span><br><span class="line">          field: &#x27;status.phase=Running&#x27;</span><br><span class="line">        - role: pod</span><br><span class="line">          label: &#x27;env=staging&#x27;</span><br><span class="line">          field: &#x27;status.phase=Running&#x27;</span><br><span class="line">        # ... 更多的选择器组合</span><br><span class="line"></span><br><span class="line">  # ✅ 性能好：使用单个配置配合 relabeling</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      selectors:</span><br><span class="line">        - role: pod</span><br><span class="line">          field: &#x27;status.phase=Running&#x27;</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_env]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;(prod|staging)&#x27;</span><br><span class="line"></span><br><span class="line">  2. 内存和 CPU 优化</span><br><span class="line"></span><br><span class="line">  减少发现的资源数量</span><br><span class="line"></span><br><span class="line">  # ✅ 使用注解过滤</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      prometheus.io/scrape: &quot;true&quot;  # 只监控需要监控的</span><br><span class="line"></span><br><span class="line">  # ✅ 使用标签过滤</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      selectors:</span><br><span class="line">        - role: pod</span><br><span class="line">          label: &#x27;monitoring.enabled=true&#x27;</span><br><span class="line"></span><br><span class="line">  # ✅ 限制命名空间</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      namespaces:</span><br><span class="line">        names: [&#x27;production&#x27;, &#x27;monitoring&#x27;]  # 不监控所有命名空间</span><br><span class="line"></span><br><span class="line">  标签数量优化</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # ✅ 删除不需要的元数据标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;__meta_kubernetes_pod_annotation_.+&#x27;</span><br><span class="line"></span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;__meta_kubernetes_pod_labelpresent_.+&#x27;</span><br><span class="line"></span><br><span class="line">    # ✅ 只保留必要的标签</span><br><span class="line">    - action: labelkeep</span><br><span class="line">      regex: &#x27;(job|instance|service|namespace|version|env|team)&#x27;</span><br><span class="line"></span><br><span class="line">  3. 网络和 API 负载优化</span><br><span class="line"></span><br><span class="line">  刷新间隔配置</span><br><span class="line"></span><br><span class="line">  # ✅ 根据集群规模调整刷新间隔</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: endpointslice</span><br><span class="line">      # 小型集群</span><br><span class="line">      refresh_interval: 30s</span><br><span class="line"></span><br><span class="line">    - role: pod</span><br><span class="line">      # 大型集群</span><br><span class="line">      refresh_interval: 5m</span><br><span class="line"></span><br><span class="line">    - role: service</span><br><span class="line">      # 服务变化较少</span><br><span class="line">      refresh_interval: 10m</span><br><span class="line"></span><br><span class="line">  分层监控策略</span><br><span class="line"></span><br><span class="line">  # ✅ 不同频率的监控配置</span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 高频：关键服务</span><br><span class="line">    - job_name: &#x27;critical-services&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpointslice</span><br><span class="line">          selectors:</span><br><span class="line">            - role: endpointslice</span><br><span class="line">              label: &#x27;priority=critical&#x27;</span><br><span class="line">      scrape_interval: 15s</span><br><span class="line">      refresh_interval: 30s</span><br><span class="line"></span><br><span class="line">    # 中频：业务服务</span><br><span class="line">    - job_name: &#x27;business-services&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpointslice</span><br><span class="line">          selectors:</span><br><span class="line">            - role: endpointslice</span><br><span class="line">              label: &#x27;priority=normal&#x27;</span><br><span class="line">      scrape_interval: 30s</span><br><span class="line">      refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">    # 低频：基础设施</span><br><span class="line">    - job_name: &#x27;infrastructure&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: node</span><br><span class="line">      scrape_interval: 60s</span><br><span class="line">      refresh_interval: 5m</span><br><span class="line"></span><br><span class="line">  4. 故障排查和监控</span><br><span class="line"></span><br><span class="line">  关键监控指标</span><br><span class="line"></span><br><span class="line">  # 监控 Prometheus 自身的 Kubernetes SD 状态</span><br><span class="line">  # prometheus_sd_kubernetes_events_total - Kubernetes 事件总数</span><br><span class="line">  # prometheus_sd_discovered_targets - 发现的目标数量</span><br><span class="line">  # prometheus_target_interval_length_seconds - 抓取间隔</span><br><span class="line">  # prometheus_config_last_reload_successful - 配置重载是否成功</span><br><span class="line"></span><br><span class="line">  常见问题和解决方案</span><br><span class="line"></span><br><span class="line">  # 问题 1: 发现的目标过多</span><br><span class="line">  # 解决方案：使用更精确的选择器</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: pod</span><br><span class="line">      selectors:</span><br><span class="line">        - role: pod</span><br><span class="line">          label: &#x27;prometheus.io/scrape=true&#x27;</span><br><span class="line">          field: &#x27;status.phase=Running&#x27;</span><br><span class="line"></span><br><span class="line">  # 问题 2: API 服务器负载过高</span><br><span class="line">  # 解决方案：减少刷新频率，使用 EndpointSlice</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">    - role: endpointslice  # 而不是 pod</span><br><span class="line">      refresh_interval: 5m  # 增加刷新间隔</span><br><span class="line"></span><br><span class="line">  # 问题 3: 内存使用过高</span><br><span class="line">  # 解决方案：清理不必要的标签</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;__meta_.*&#x27;</span><br><span class="line">    - action: labelkeep</span><br><span class="line">      regex: &#x27;(job|instance|service|namespace)&#x27;</span><br><span class="line"></span><br><span class="line">  5. 高级优化技巧</span><br><span class="line"></span><br><span class="line">  并行发现配置</span><br><span class="line"></span><br><span class="line">  # ✅ 分离不同角色的配置以实现并行处理</span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 节点监控（变化频率低）</span><br><span class="line">    - job_name: &#x27;kubernetes-nodes&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: node</span><br><span class="line">      refresh_interval: 10m</span><br><span class="line"></span><br><span class="line">    # 服务监控（变化频率中等）</span><br><span class="line">    - job_name: &#x27;kubernetes-services&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: service</span><br><span class="line">      refresh_interval: 2m</span><br><span class="line"></span><br><span class="line">    # Pod 监控（变化频率高）</span><br><span class="line">    - job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: pod</span><br><span class="line">          selectors:</span><br><span class="line">            - role: pod</span><br><span class="line">              label: &#x27;monitoring.enabled=true&#x27;</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line"></span><br><span class="line">  智能重试机制</span><br><span class="line"></span><br><span class="line">  # ✅ 配置适当的超时和重试</span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: pod</span><br><span class="line">          refresh_interval: 1m</span><br><span class="line">      scrape_timeout: 10s</span><br><span class="line">      scrape_interval: 30s</span><br><span class="line"></span><br><span class="line">      # 对失败的抓取进行重试</span><br><span class="line">      metric_relabel_configs:</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;up&#x27;</span><br><span class="line"></span><br><span class="line">⏺ 总结</span><br><span class="line"></span><br><span class="line">  Kubernetes 服务发现是 Prometheus 的核心功能，提供了六种不同的角色来适应各种监控需求：</span><br><span class="line"></span><br><span class="line">  角色选择指南</span><br><span class="line"></span><br><span class="line">  1. Pod Role - 最灵活，直接监控容器</span><br><span class="line">  2. EndpointSlice Role - 现代化端点监控，适合大规模集群</span><br><span class="line">  3. Service Role - 服务级别监控，适合黑盒测试</span><br><span class="line">  4. Node Role - 节点基础设施监控</span><br><span class="line">  5. Ingress Role - 入口流量监控</span><br><span class="line">  6. Endpoints Role - 已弃用，使用 EndpointSlice 替代</span><br><span class="line"></span><br><span class="line">  关键优化原则</span><br><span class="line"></span><br><span class="line">  1. 使用精确选择器 - 减少不必要的资源发现</span><br><span class="line">  2. EndpointSlice 优先 - 大规模集群必须使用</span><br><span class="line">  3. 合理刷新间隔 - 平衡实时性和性能</span><br><span class="line">  4. 标签管理 - 清理不需要的元数据标签</span><br><span class="line">  5. 分离监控配置 - 不同角色使用不同的刷新频率</span><br><span class="line"></span><br><span class="line">  生产环境建议</span><br><span class="line"></span><br><span class="line">  1. RBAC 最小权限 - 只授予必要的 API 访问权限</span><br><span class="line">  2. TLS 安全通信 - 保护与 Kubernetes API 的连接</span><br><span class="line">  3. 故障转移机制 - 监控服务发现健康状态</span><br><span class="line">  4. 分层监控策略 - 根据服务重要性设置不同监控频率</span><br><span class="line"></span><br><span class="line">  通过合理配置和优化，Kubernetes 服务发现可以为大规模云原生环境提供高效、可靠的监控目标自动发现能力。</span><br></pre></td></tr></table></figure>

<h4 id="static-config"><a href="#static-config" class="headerlink" title="static_config"></a>static_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line">⏺ static_config 是 Prometheus 中最基础的静态目标配置方式，用于明确指定要监控的目标列表和通用标签。</span><br><span class="line"></span><br><span class="line">  基本结构</span><br><span class="line"></span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;host1:9090&#x27;, &#x27;host2:9090&#x27;]</span><br><span class="line">      labels:</span><br><span class="line">        job: &#x27;my-job&#x27;</span><br><span class="line">        env: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">  详细配置</span><br><span class="line"></span><br><span class="line">  targets - 目标列表</span><br><span class="line"></span><br><span class="line">  指定要监控的服务端点列表：</span><br><span class="line"></span><br><span class="line">  # 单个目标</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line"></span><br><span class="line">  # 多个目标</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">        - &#x27;localhost:9090&#x27;</span><br><span class="line">        - &#x27;localhost:8080&#x27;</span><br><span class="line">        - &#x27;localhost:9091&#x27;</span><br><span class="line"></span><br><span class="line">  # 带协议的目标</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">        - &#x27;http://prometheus.example.com:9090&#x27;</span><br><span class="line">        - &#x27;https://secure-metrics.example.com:443&#x27;</span><br><span class="line"></span><br><span class="line">  # 不同端口的服务</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">        - &#x27;web-server1:8080&#x27;</span><br><span class="line">        - &#x27;web-server2:8080&#x27;</span><br><span class="line">        - &#x27;api-server:9090&#x27;</span><br><span class="line">        - &#x27;database-exporter:9100&#x27;</span><br><span class="line"></span><br><span class="line">  labels - 通用标签</span><br><span class="line"></span><br><span class="line">  为所有目标添加相同的标签：</span><br><span class="line"></span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&#x27;web1:8080&#x27;, &#x27;web2:8080&#x27;, &#x27;web3:8080&#x27;]</span><br><span class="line">      labels:</span><br><span class="line">        job: &#x27;web-servers&#x27;</span><br><span class="line">        environment: &#x27;production&#x27;</span><br><span class="line">        team: &#x27;frontend&#x27;</span><br><span class="line">        service_type: &#x27;http&#x27;</span><br><span class="line"></span><br><span class="line">  实际应用示例</span><br><span class="line"></span><br><span class="line">  1. 基础服务监控</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # Prometheus 自身监控</span><br><span class="line">    - job_name: &#x27;prometheus&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;prometheus&#x27;</span><br><span class="line">            component: &#x27;server&#x27;</span><br><span class="line"></span><br><span class="line">    # Node Exporter 监控</span><br><span class="line">    - job_name: &#x27;node-exporter&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;server1:9100&#x27;</span><br><span class="line">            - &#x27;server2:9100&#x27;</span><br><span class="line">            - &#x27;server3:9100&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;node-exporter&#x27;</span><br><span class="line">            environment: &#x27;production&#x27;</span><br><span class="line">            team: &#x27;infrastructure&#x27;</span><br><span class="line"></span><br><span class="line">  2. 多环境配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 开发环境</span><br><span class="line">    - job_name: &#x27;dev-services&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;dev-web1:8080&#x27;</span><br><span class="line">            - &#x27;dev-api1:9090&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;dev-services&#x27;</span><br><span class="line">            environment: &#x27;development&#x27;</span><br><span class="line">            team: &#x27;backend&#x27;</span><br><span class="line"></span><br><span class="line">    # 测试环境</span><br><span class="line">    - job_name: &#x27;staging-services&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;staging-web1:8080&#x27;</span><br><span class="line">            - &#x27;staging-api1:9090&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;staging-services&#x27;</span><br><span class="line">            environment: &#x27;staging&#x27;</span><br><span class="line">            team: &#x27;backend&#x27;</span><br><span class="line"></span><br><span class="line">    # 生产环境</span><br><span class="line">    - job_name: &#x27;prod-services&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;prod-web1:8080&#x27;</span><br><span class="line">            - &#x27;prod-web2:8080&#x27;</span><br><span class="line">            - &#x27;prod-api1:9090&#x27;</span><br><span class="line">            - &#x27;prod-api2:9090&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;prod-services&#x27;</span><br><span class="line">            environment: &#x27;production&#x27;</span><br><span class="line">            team: &#x27;backend&#x27;</span><br><span class="line"></span><br><span class="line">  3. 不同服务类型</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # Web 服务监控</span><br><span class="line">    - job_name: &#x27;web-services&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;nginx1:9113&#x27;      # Nginx Exporter</span><br><span class="line">            - &#x27;nginx2:9113&#x27;</span><br><span class="line">            - &#x27;apache1:9117&#x27;     # Apache Exporter</span><br><span class="line">            - &#x27;apache2:9117&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;web-services&#x27;</span><br><span class="line">            service_type: &#x27;web-server&#x27;</span><br><span class="line"></span><br><span class="line">    # 数据库监控</span><br><span class="line">    - job_name: &#x27;databases&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;postgres1:9187&#x27;   # PostgreSQL Exporter</span><br><span class="line">            - &#x27;postgres2:9187&#x27;</span><br><span class="line">            - &#x27;mysql1:9104&#x27;      # MySQL Exporter</span><br><span class="line">            - &#x27;redis1:9121&#x27;      # Redis Exporter</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;databases&#x27;</span><br><span class="line">            service_type: &#x27;database&#x27;</span><br><span class="line"></span><br><span class="line">    # 中间件监控</span><br><span class="line">    - job_name: &#x27;middleware&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;kafka1:9308&#x27;      # Kafka Exporter</span><br><span class="line">            - &#x27;rabbitmq1:9419&#x27;   # RabbitMQ Exporter</span><br><span class="line">            - &#x27;elasticsearch1:9114&#x27;  # Elasticsearch Exporter</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;middleware&#x27;</span><br><span class="line">            service_type: &#x27;message-queue&#x27;</span><br><span class="line"></span><br><span class="line">  4. 外部服务监控</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 外部 API 监控</span><br><span class="line">    - job_name: &#x27;external-apis&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;api.github.com:443&#x27;</span><br><span class="line">            - &#x27;api.stripe.com:443&#x27;</span><br><span class="line">            - &#x27;api.twilio.com:443&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;external-apis&#x27;</span><br><span class="line">            monitoring_type: &#x27;blackbox&#x27;</span><br><span class="line">            environment: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">    # CDN 监控</span><br><span class="line">    - job_name: &#x27;cdn-monitoring&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;cdn.jsdelivr.net:443&#x27;</span><br><span class="line">            - &#x27;cdnjs.cloudflare.com:443&#x27;</span><br><span class="line">            - &#x27;unpkg.com:443&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;cdn-monitoring&#x27;</span><br><span class="line">            monitoring_type: &#x27;availability&#x27;</span><br><span class="line"></span><br><span class="line">  5. 本地开发环境</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 本地开发服务</span><br><span class="line">    - job_name: &#x27;local-dev&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;localhost:8080&#x27;  # 本地 Web 应用</span><br><span class="line">            - &#x27;localhost:9090&#x27;  # 本地 Prometheus</span><br><span class="line">            - &#x27;localhost:3000&#x27;  # 本地前端应用</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;local-development&#x27;</span><br><span class="line">            environment: &#x27;local&#x27;</span><br><span class="line">            developer: &#x27;john.doe&#x27;</span><br><span class="line"></span><br><span class="line">    # Docker 容器监控</span><br><span class="line">    - job_name: &#x27;docker-containers&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;host.docker.internal:9323&#x27;  # Docker Exporter</span><br><span class="line">            - &#x27;cadvisor:8080&#x27;              # cAdvisor</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;docker-infrastructure&#x27;</span><br><span class="line">            environment: &#x27;local&#x27;</span><br><span class="line"></span><br><span class="line">  高级用法</span><br><span class="line"></span><br><span class="line">  1. 组合多个静态配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    # 主要应用服务</span><br><span class="line">    - job_name: &#x27;primary-apps&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;app1:8080&#x27;, &#x27;app2:8080&#x27;]</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;primary-apps&#x27;</span><br><span class="line">            priority: &#x27;high&#x27;</span><br><span class="line">        - targets: [&#x27;app3:8080&#x27;, &#x27;app4:8080&#x27;]</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;primary-apps&#x27;</span><br><span class="line">            priority: &#x27;medium&#x27;</span><br><span class="line"></span><br><span class="line">    # 辅助服务</span><br><span class="line">    - job_name: &#x27;auxiliary-services&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;cache1:6379&#x27;, &#x27;cache2:6379&#x27;]</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;auxiliary-services&#x27;</span><br><span class="line">            service_type: &#x27;cache&#x27;</span><br><span class="line">        - targets: [&#x27;queue1:5672&#x27;, &#x27;queue2:5672&#x27;]</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;auxiliary-services&#x27;</span><br><span class="line">            service_type: &#x27;queue&#x27;</span><br><span class="line"></span><br><span class="line">  2. 使用文件包含模式</span><br><span class="line"></span><br><span class="line">  # 主配置文件</span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;core-services&#x27;</span><br><span class="line">      file: &#x27;/etc/prometheus/targets/core-services.yml&#x27;</span><br><span class="line"></span><br><span class="line">    - job_name: &#x27;external-services&#x27;</span><br><span class="line">      file: &#x27;/etc/prometheus/targets/external-services.yml&#x27;</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/targets/core-services.yml</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">        - &#x27;api-server:9090&#x27;</span><br><span class="line">        - &#x27;web-server:8080&#x27;</span><br><span class="line">      labels:</span><br><span class="line">        job: &#x27;core-services&#x27;</span><br><span class="line">        environment: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">  3. 配置模板化</span><br><span class="line"></span><br><span class="line">  # 使用不同环境的模板</span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;app-services&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">            - &#x27;app-&#123;&#123; .Environment &#125;&#125;-1:8080&#x27;</span><br><span class="line">            - &#x27;app-&#123;&#123; .Environment &#125;&#125;-2:8080&#x27;</span><br><span class="line">          labels:</span><br><span class="line">            job: &#x27;app-services&#x27;</span><br><span class="line">            environment: &#x27;&#123;&#123; .Environment &#125;&#125;&#x27;</span><br><span class="line">            team: &#x27;&#123;&#123; .Team &#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 命名规范</span><br><span class="line"></span><br><span class="line">  # ✅ 清晰的 job 名称</span><br><span class="line">  - job_name: &#x27;nginx-exporter&#x27;</span><br><span class="line">  - job_name: &#x27;postgresql-metrics&#x27;</span><br><span class="line">  - job_name: &#x27;application-services&#x27;</span><br><span class="line"></span><br><span class="line">  # ✅ 有意义的标签</span><br><span class="line">  labels:</span><br><span class="line">    job: &#x27;web-servers&#x27;</span><br><span class="line">    environment: &#x27;production&#x27;</span><br><span class="line">    datacenter: &#x27;us-west-2&#x27;</span><br><span class="line">    team: &#x27;frontend&#x27;</span><br><span class="line">    version: &#x27;v1.2.0&#x27;</span><br><span class="line"></span><br><span class="line">  2. 环境分离</span><br><span class="line"></span><br><span class="line">  # ✅ 按环境分组</span><br><span class="line">  - job_name: &#x27;production-web&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;prod-web1:8080&#x27;, &#x27;prod-web2:8080&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          environment: &#x27;production&#x27;</span><br><span class="line">          tier: &#x27;frontend&#x27;</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;staging-web&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;staging-web1:8080&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          environment: &#x27;staging&#x27;</span><br><span class="line">          tier: &#x27;frontend&#x27;</span><br><span class="line"></span><br><span class="line">  3. 服务分类</span><br><span class="line"></span><br><span class="line">  # ✅ 按服务类型分类</span><br><span class="line">  - job_name: &#x27;infrastructure&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;node1:9100&#x27;, &#x27;node2:9100&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          category: &#x27;infrastructure&#x27;</span><br><span class="line">          service: &#x27;node-exporter&#x27;</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;application&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;app1:8080&#x27;, &#x27;app2:8080&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          category: &#x27;application&#x27;</span><br><span class="line">          service: &#x27;web-api&#x27;</span><br><span class="line"></span><br><span class="line">  与其他服务发现的对比</span><br><span class="line"></span><br><span class="line">  | 特性    | static_config | file_sd | kubernetes_sd |</span><br><span class="line">  |-------|---------------|---------|---------------|</span><br><span class="line">  | 配置复杂度 | 简单            | 中等      | 复杂            |</span><br><span class="line">  | 动态性   | 静态            | 半动态     | 完全动态          |</span><br><span class="line">  | 维护成本  | 低             | 中等      | 高             |</span><br><span class="line">  | 适用场景  | 固定目标          | 变化较少    | 容器化环境         |</span><br><span class="line">  | 性能开销  | 最低            | 低       | 较高            |</span><br><span class="line"></span><br><span class="line">  static_config 是最简单直接的目标配置方式，适合固定的、变化较少的监控目标，特别适合传统的服务器环境和小规模部署。</span><br></pre></td></tr></table></figure>

<h4 id="relabel-config"><a href="#relabel-config" class="headerlink" title="relabel_config"></a>relabel_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br></pre></td><td class="code"><pre><span class="line">⏺ relabel_config 是 Prometheus</span><br><span class="line">  中最强大的功能之一，允许在抓取目标前动态重写目标的标签集。它是实现灵活监控配置的核心工具。</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  Relabeling 的工作原理：</span><br><span class="line">  1. 按配置顺序应用多个 relabeling 步骤</span><br><span class="line">  2. 每个步骤处理目标的标签集</span><br><span class="line">  3. 基于匹配规则执行相应动作</span><br><span class="line">  4. 最终决定目标是否被抓取以及如何被抓取</span><br><span class="line"></span><br><span class="line">  初始标签集</span><br><span class="line"></span><br><span class="line">  系统默认标签</span><br><span class="line"></span><br><span class="line">  # 初始可用的标签</span><br><span class="line">  __address__         # 目标地址 host:port</span><br><span class="line">  __scheme__          # HTTP/HTTPS 协议</span><br><span class="line">  __metrics_path__    # 指标路径</span><br><span class="line">  __param_&lt;name&gt;      # URL 参数</span><br><span class="line">  __scrape_interval__ # 抓取间隔</span><br><span class="line">  __scrape_timeout__  # 抓取超时</span><br><span class="line">  job                # job 名称</span><br><span class="line">  __meta_*            # 服务发现元数据（根据机制不同）</span><br><span class="line"></span><br><span class="line">  标签处理流程</span><br><span class="line"></span><br><span class="line">  初始标签 → Relabeling 步骤 1 → Relabeling 步骤 2 → ... → 最终标签</span><br><span class="line">      ↓              ↓                ↓                        ↓</span><br><span class="line">    目标发现        标签重写        标签过滤                决定抓取</span><br><span class="line"></span><br><span class="line">  配置参数详解</span><br><span class="line"></span><br><span class="line">  source_labels - 源标签列表</span><br><span class="line"></span><br><span class="line">  # 单个标签</span><br><span class="line">  source_labels: [__address__]</span><br><span class="line"></span><br><span class="line">  # 多个标签</span><br><span class="line">  source_labels: [__meta_kubernetes_pod_name, __meta_kubernetes_pod_namespace]</span><br><span class="line"></span><br><span class="line">  # 使用默认（所有标签）</span><br><span class="line">  # source_labels 不指定时使用所有标签</span><br><span class="line"></span><br><span class="line">  separator - 标签分隔符</span><br><span class="line"></span><br><span class="line">  # 默认分号分隔</span><br><span class="line">  separator: &#x27;;&#x27;  # label1;label2;label3</span><br><span class="line"></span><br><span class="line">  # 自定义分隔符</span><br><span class="line">  separator: &#x27;,&#x27;    # label1,label2,label3</span><br><span class="line">  separator: &#x27;|&#x27;    # label1|label2|label3</span><br><span class="line">  separator: &#x27;_&#x27;    # label1_label2_label3</span><br><span class="line"></span><br><span class="line">  target_label - 目标标签</span><br><span class="line"></span><br><span class="line">  # 设置新标签</span><br><span class="line">  target_label: instance</span><br><span class="line">  target_label: service_name</span><br><span class="line">  target_label: environment</span><br><span class="line"></span><br><span class="line">  # 临时标签（用于后续处理）</span><br><span class="line">  target_label: __tmp_port</span><br><span class="line">  target_label: __tmp_service</span><br><span class="line"></span><br><span class="line">  regex - 正则表达式</span><br><span class="line"></span><br><span class="line">  # 匹配任意内容（默认）</span><br><span class="line">  regex: &#x27;(.*)&#x27;</span><br><span class="line"></span><br><span class="line">  # 匹配特定端口</span><br><span class="line">  regex: &#x27;:(\d+)$&#x27;</span><br><span class="line"></span><br><span class="line">  # 匹配命名空间</span><br><span class="line">  regex: &#x27;^([a-z]+)-(.+)$&#x27;</span><br><span class="line"></span><br><span class="line">  # 复杂匹配</span><br><span class="line">  regex: &#x27;([^:]+)(?::(\d+))?.*;prometheus.io/port=(\d+)&#x27;</span><br><span class="line"></span><br><span class="line">  replacement - 替换字符串</span><br><span class="line"></span><br><span class="line">  # 使用捕获组</span><br><span class="line">  replacement: &#x27;$1&#x27;              # 第一个捕获组</span><br><span class="line">  replacement: &#x27;$1:$2&#x27;           # 多个捕获组组合</span><br><span class="line">  replacement: &#x27;service-$1&#x27;      # 添加前缀</span><br><span class="line">  replacement: &#x27;$1-metrics&#x27;      # 添加后缀</span><br><span class="line"></span><br><span class="line">  # 默认值</span><br><span class="line">  replacement: &#x27;$1&#x27;              # 默认使用第一个捕获组</span><br><span class="line"></span><br><span class="line">  modulus - 模数运算</span><br><span class="line"></span><br><span class="line">  # 哈希分片</span><br><span class="line">  modulus: 3      # 分成 3 组</span><br><span class="line">  modulus: 10     # 分成 10 组</span><br><span class="line">  modulus: 100    # 分成 100 组</span><br><span class="line"></span><br><span class="line">  Relabel Actions 详解</span><br><span class="line"></span><br><span class="line">  1. replace - 替换（默认）</span><br><span class="line"></span><br><span class="line">  # 基础替换</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__address__]</span><br><span class="line">      target_label: instance</span><br><span class="line">      regex: &#x27;([^:]+):.*&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">  # 端口替换</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">      regex: &#x27;([^:]+)(?::\d+)?;(\d+)&#x27;</span><br><span class="line">      replacement: &#x27;$1:$2&#x27;</span><br><span class="line">      target_label: __address__</span><br><span class="line"></span><br><span class="line">  # 路径替换</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">      target_label: __metrics_path__</span><br><span class="line">      regex: &#x27;(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">  2. lowercase / uppercase - 大小写转换</span><br><span class="line"></span><br><span class="line">  # 转小写</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">      target_label: service_name</span><br><span class="line">      action: lowercase</span><br><span class="line"></span><br><span class="line">  # 转大写</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [environment]</span><br><span class="line">      target_label: ENVIRONMENT</span><br><span class="line">      action: uppercase</span><br><span class="line"></span><br><span class="line">  3. keep - 保留匹配的目标</span><br><span class="line"></span><br><span class="line">  # 只保留特定注解的 Pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;true&#x27;</span><br><span class="line"></span><br><span class="line">  # 只保留特定命名空间</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;(production|staging)&#x27;</span><br><span class="line"></span><br><span class="line">  # 只保留运行中的 Pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_phase]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;Running&#x27;</span><br><span class="line"></span><br><span class="line">  4. drop - 丢弃匹配的目标</span><br><span class="line"></span><br><span class="line">  # 排除测试环境</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_environment]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;test&#x27;</span><br><span class="line"></span><br><span class="line">  # 排除特定端口</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__address__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;.*:9091&#x27;  # 排除 9091 端口</span><br><span class="line"></span><br><span class="line">  # 排除失败的 Pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_ready]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;false&#x27;</span><br><span class="line"></span><br><span class="line">  5. hashmod - 哈希分片</span><br><span class="line"></span><br><span class="line">  # 分片到不同 Prometheus 实例</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__address__]</span><br><span class="line">      target_label: __tmp_hash</span><br><span class="line">      modulus: 3</span><br><span class="line">      action: hashmod</span><br><span class="line"></span><br><span class="line">    - source_labels: [__tmp_hash]</span><br><span class="line">      regex: &#x27;^0$&#x27;</span><br><span class="line">      action: keep</span><br><span class="line"></span><br><span class="line">  # 负载均衡分片</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">      target_label: shard</span><br><span class="line">      modulus: 5</span><br><span class="line">      action: hashmod</span><br><span class="line"></span><br><span class="line">  6. labelmap - 标签映射</span><br><span class="line"></span><br><span class="line">  # 复制所有 Kubernetes 标签</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labelmap</span><br><span class="line">      regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      replacement: k8s_label_$1</span><br><span class="line"></span><br><span class="line">  # 复制所有注解</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labelmap</span><br><span class="line">      regex: __meta_kubernetes_pod_annotation_(.+)</span><br><span class="line">      replacement: k8s_annotation_$1</span><br><span class="line"></span><br><span class="line">  # 服务标签映射</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labelmap</span><br><span class="line">      regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      replacement: service_label_$1</span><br><span class="line"></span><br><span class="line">  7. labeldrop / labelkeep - 标签过滤</span><br><span class="line"></span><br><span class="line">  # 删除元数据标签</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: __meta_kubernetes_.*</span><br><span class="line"></span><br><span class="line">  # 只保留必要标签</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labelkeep</span><br><span class="line">      regex: &#x27;(job|instance|service|namespace|version)&#x27;</span><br><span class="line"></span><br><span class="line">  # 删除临时标签</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: __tmp_.*</span><br><span class="line"></span><br><span class="line">  实际应用示例</span><br><span class="line"></span><br><span class="line">  1. Kubernetes Pod 监控</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 只监控带特定注解的 Pod</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;true&#x27;</span><br><span class="line"></span><br><span class="line">    # 设置抓取端口</span><br><span class="line">    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">      action: replace</span><br><span class="line">      regex: &#x27;([^:]+)(?::\d+)?;(\d+)&#x27;</span><br><span class="line">      replacement: &#x27;$1:$2&#x27;</span><br><span class="line">      target_label: __address__</span><br><span class="line"></span><br><span class="line">    # 设置抓取路径</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">      action: replace</span><br><span class="line">      target_label: __metrics_path__</span><br><span class="line">      regex: (.+)</span><br><span class="line"></span><br><span class="line">    # 添加服务标签</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_app]</span><br><span class="line">      target_label: service</span><br><span class="line"></span><br><span class="line">    # 添加版本标签</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_version]</span><br><span class="line">      target_label: version</span><br><span class="line"></span><br><span class="line">    # 添加环境标签</span><br><span class="line">    - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">      target_label: environment</span><br><span class="line"></span><br><span class="line">    # 添加控制器信息</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_controller_name]</span><br><span class="line">      target_label: controller</span><br><span class="line"></span><br><span class="line">    # 清理元数据标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: __meta_kubernetes_pod_annotation_.+</span><br><span class="line"></span><br><span class="line">  2. 多环境服务发现</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 从命名空间提取环境</span><br><span class="line">    - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">      target_label: environment</span><br><span class="line">      regex: &#x27;(.+)-(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">    # 从服务名提取应用名</span><br><span class="line">    - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">      target_label: application</span><br><span class="line">      regex: &#x27;(.+)-(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">    # 只监控生产环境</span><br><span class="line">    - source_labels: [environment]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">    # 设置实例名</span><br><span class="line">    - source_labels: [__meta_kubernetes_endpoint_address_target_name]</span><br><span class="line">      target_label: instance</span><br><span class="line"></span><br><span class="line">  3. 高级过滤和转换</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 组合多个标签进行过滤</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_environment, __meta_kubernetes_pod_label_team]</span><br><span class="line">      separator: &#x27;-&#x27;</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;production-backend&#x27;</span><br><span class="line"></span><br><span class="line">    # 动态设置抓取间隔</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_priority]</span><br><span class="line">      target_label: __scrape_interval__</span><br><span class="line">      regex: &#x27;high&#x27;</span><br><span class="line">      replacement: &#x27;15s&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_priority]</span><br><span class="line">      target_label: __scrape_interval__</span><br><span class="line">      regex: &#x27;low&#x27;</span><br><span class="line">      replacement: &#x27;2m&#x27;</span><br><span class="line"></span><br><span class="line">    # 设置自定义超时</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_timeout]</span><br><span class="line">      target_label: __scrape_timeout__</span><br><span class="line">      regex: &#x27;(\d+)s&#x27;</span><br><span class="line">      replacement: &#x27;$&#123;1&#125;s&#x27;</span><br><span class="line"></span><br><span class="line">  4. 复杂标签操作</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 步骤 1: 提取服务类型</span><br><span class="line">    - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">      target_label: __tmp_service_type</span><br><span class="line">      regex: &#x27;(.+)-(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">    # 步骤 2: 提取服务名</span><br><span class="line">    - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">      target_label: service_name</span><br><span class="line">      regex: &#x27;(.+)-(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$2&#x27;</span><br><span class="line"></span><br><span class="line">    # 步骤 3: 根据服务类型设置不同配置</span><br><span class="line">    - source_labels: [__tmp_service_type]</span><br><span class="line">      target_label: job_type</span><br><span class="line">      regex: &#x27;web&#x27;</span><br><span class="line">      replacement: &#x27;web-service&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [__tmp_service_type]</span><br><span class="line">      target_label: job_type</span><br><span class="line">      regex: &#x27;api&#x27;</span><br><span class="line">      replacement: &#x27;api-service&#x27;</span><br><span class="line"></span><br><span class="line">    # 步骤 4: 清理临时标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: __tmp_.*</span><br><span class="line"></span><br><span class="line">  性能优化建议</span><br><span class="line"></span><br><span class="line">  1. 过滤顺序优化</span><br><span class="line"></span><br><span class="line">  # ✅ 先过滤减少处理量</span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 先过滤</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;true&#x27;</span><br><span class="line"></span><br><span class="line">    # 再处理</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_app]</span><br><span class="line">      target_label: service</span><br><span class="line"></span><br><span class="line">  # ❌ 先处理再过滤（性能差）</span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 先处理所有</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_app]</span><br><span class="line">      target_label: service</span><br><span class="line"></span><br><span class="line">    # 最后过滤</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">      action: keep</span><br><span class="line">      regex: &#x27;true&#x27;</span><br><span class="line"></span><br><span class="line">  2. 标签数量控制</span><br><span class="line"></span><br><span class="line">  # ✅ 主动清理不需要的标签</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: __meta_kubernetes_pod_annotation_.+</span><br><span class="line"></span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: __meta_kubernetes_pod_labelpresent_.+</span><br><span class="line"></span><br><span class="line">  # ✅ 只保留必要的标签</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - action: labelkeep</span><br><span class="line">      regex: &#x27;(job|instance|service|namespace|version|team)&#x27;</span><br><span class="line"></span><br><span class="line">  3. 正则表达式优化</span><br><span class="line"></span><br><span class="line">  # ✅ 使用精确的正则表达式</span><br><span class="line">  regex: &#x27;true&#x27;</span><br><span class="line">  regex: &#x27;^production$&#x27;</span><br><span class="line">  regex: &#x27;:(\d+)$&#x27;</span><br><span class="line"></span><br><span class="line">  # ❌ 避免过于宽泛的正则表达式</span><br><span class="line">  regex: &#x27;.*&#x27;</span><br><span class="line">  regex: &#x27;.+&#x27;</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 临时标签使用</span><br><span class="line"></span><br><span class="line">  # 使用 __tmp 前缀进行中间处理</span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 步骤 1: 提取端口到临时标签</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">      target_label: __tmp_port</span><br><span class="line">      regex: &#x27;(\d+)&#x27;</span><br><span class="line"></span><br><span class="line">    # 步骤 2: 组合地址和端口</span><br><span class="line">    - source_labels: [__address__, __tmp_port]</span><br><span class="line">      target_label: __address__</span><br><span class="line">      regex: &#x27;([^:]+).*;(\d+)&#x27;</span><br><span class="line">      replacement: &#x27;$1:$2&#x27;</span><br><span class="line"></span><br><span class="line">    # 步骤 3: 清理临时标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: __tmp_.*</span><br><span class="line"></span><br><span class="line">  2. 错误处理</span><br><span class="line"></span><br><span class="line">  # 处理缺失标签的情况</span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_version]</span><br><span class="line">      target_label: version</span><br><span class="line">      regex: &#x27;(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$&#123;1&#125;&#x27;</span><br><span class="line">      # 如果标签不存在，使用默认值</span><br><span class="line">      replacement: &#x27;unknown&#x27;</span><br><span class="line"></span><br><span class="line">    # 或者使用多个步骤</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_label_version]</span><br><span class="line">      target_label: version</span><br><span class="line">      regex: &#x27;(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [version]</span><br><span class="line">      target_label: version</span><br><span class="line">      regex: &#x27;^$&#x27;</span><br><span class="line">      replacement: &#x27;unknown&#x27;</span><br><span class="line"></span><br><span class="line">  Relabeling 是 Prometheus 监控配置的核心技能，掌握它能让你构建出强大而灵活的监控系统。</span><br></pre></td></tr></table></figure>

<h4 id="metric-relabel-configs"><a href="#metric-relabel-configs" class="headerlink" title="metric_relabel_configs"></a>metric_relabel_configs</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br></pre></td><td class="code"><pre><span class="line">⏺ Metric Relabeling 是 Prometheus 在指标数据摄入前的最后一步处理机制，它与 Target Relabeling</span><br><span class="line">  使用相同的配置格式，但作用于不同的对象。</span><br><span class="line"></span><br><span class="line">  基本概念对比</span><br><span class="line"></span><br><span class="line">  Target Relabeling vs Metric Relabeling</span><br><span class="line"></span><br><span class="line">  | 方面        | Target Relabeling | Metric Relabeling      |</span><br><span class="line">  |-----------|-------------------|------------------------|</span><br><span class="line">  | 作用对象      | 监控目标 (targets)    | 指标样本 (samples)         |</span><br><span class="line">  | 执行时机      | 抓取前               | 摄入前                    |</span><br><span class="line">  | 影响        | 决定是否抓取            | 决定是否存储                 |</span><br><span class="line">  | 配置位置      | relabel_configs   | metric_relabel_configs |</span><br><span class="line">  | 适用指标      | N/A               | 所有抓取的指标                |</span><br><span class="line">  | 对 up 指标影响 | ✅                 | ❌                      |</span><br><span class="line"></span><br><span class="line">  处理流程</span><br><span class="line"></span><br><span class="line">  目标发现 → Target Relabeling → 指标抓取 → Metric Relabeling → 数据摄入 → 存储</span><br><span class="line">      ↓           ↓              ↓              ↓              ↓        ↓</span><br><span class="line">    所有目标   过滤目标      抓取指标      过滤指标      存储到   时序数据库</span><br><span class="line">                和重写标签                    和重写标签</span><br><span class="line"></span><br><span class="line">  主要用途</span><br><span class="line"></span><br><span class="line">  1. 删除高成本指标</span><br><span class="line"></span><br><span class="line">  # 删除不需要的指标以节省存储</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 删除 Go 运行时指标</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;go_.*&#x27;</span><br><span class="line"></span><br><span class="line">    # 删除进程指标</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;process_.*&#x27;</span><br><span class="line"></span><br><span class="line">    # 删除 Prometheus 自身指标</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;prometheus_.*&#x27;</span><br><span class="line"></span><br><span class="line">    # 删除 HTTP 请求指标</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;http_.*&#x27;</span><br><span class="line"></span><br><span class="line">    # 删除高基数的标签组合</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;.*_bucket.*|.*_count.*|.*_sum.*&#x27;</span><br><span class="line"></span><br><span class="line">  2. 指标重命名和标准化</span><br><span class="line"></span><br><span class="line">  # 重命名指标以符合命名规范</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 统一前缀</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      regex: &#x27;custom_(.+)&#x27;</span><br><span class="line">      replacement: &#x27;app_$1&#x27;</span><br><span class="line">      target_label: __name__</span><br><span class="line"></span><br><span class="line">    # 删除前缀</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      regex: &#x27;application_(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line">      target_label: __name__</span><br><span class="line"></span><br><span class="line">    # 标准化命名</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      regex: &#x27;(.*)_metrics_(.+)&#x27;</span><br><span class="line">      replacement: &#x27;$&#123;1&#125;_$&#123;2&#125;&#x27;</span><br><span class="line">      target_label: __name__</span><br><span class="line"></span><br><span class="line">  3. 标签过滤和清理</span><br><span class="line"></span><br><span class="line">  # 删除特定标签组合</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 删除高基数标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;user_id|session_id|request_id&#x27;</span><br><span class="line"></span><br><span class="line">    # 删除调试标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;debug_.*|trace_.*&#x27;</span><br><span class="line"></span><br><span class="line">    # 只保留核心标签</span><br><span class="line">    - action: labelkeep</span><br><span class="line">      regex: &#x27;(job|instance|service|method|status|environment)&#x27;</span><br><span class="line"></span><br><span class="line">    # 删除空值标签</span><br><span class="line">    - source_labels: [environment]</span><br><span class="line">      regex: &#x27;^$&#x27;</span><br><span class="line">      target_label: environment</span><br><span class="line">      replacement: &#x27;unknown&#x27;</span><br><span class="line"></span><br><span class="line">  4. 数据聚合和降采样</span><br><span class="line"></span><br><span class="line">  # 聚合指标减少存储</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 只保留特定标签组合</span><br><span class="line">    - source_labels: [__name__, method, status_code]</span><br><span class="line">      regex: &#x27;http_requests_total;(GET|POST);(200|400|500)&#x27;</span><br><span class="line">      action: keep</span><br><span class="line"></span><br><span class="line">    # 移除细粒度标签</span><br><span class="line">    - source_labels: [pod, container]</span><br><span class="line">      action: labeldrop</span><br><span class="line"></span><br><span class="line">    # 降采样直方图</span><br><span class="line">    - source_labels: [__name__, le]</span><br><span class="line">      regex: &#x27;request_duration_seconds_bucket;.*&#x27;</span><br><span class="line">      action: replace</span><br><span class="line">      target_label: le</span><br><span class="line">      replacement: &#x27;+Inf&#x27;  # 只保留总数</span><br><span class="line"></span><br><span class="line">    # 删除详细 bucket</span><br><span class="line">    - source_labels: [le]</span><br><span class="line">      regex: &#x27;^[0-9.]+$&#x27;  # 匹配数字 bucket</span><br><span class="line">      action: drop</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  1. Web 应用监控优化</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;web-application&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;app:8080&#x27;]</span><br><span class="line">      metric_relabel_configs:</span><br><span class="line">        # 删除 Go 运行时指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: drop</span><br><span class="line">          regex: &#x27;go_.*|process_.*&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除调试指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: drop</span><br><span class="line">          regex: &#x27;debug_.*|trace_.*&#x27;</span><br><span class="line"></span><br><span class="line">        # 重命名自定义指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          regex: &#x27;app_(.+)&#x27;</span><br><span class="line">          replacement: &#x27;webapp_$1&#x27;</span><br><span class="line">          target_label: __name__</span><br><span class="line"></span><br><span class="line">        # 标准化 HTTP 指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          regex: &#x27;http_server_requests_(.+)&#x27;</span><br><span class="line">          replacement: &#x27;http_requests_$1&#x27;</span><br><span class="line">          target_label: __name__</span><br><span class="line"></span><br><span class="line">        # 删除高基数标签</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;user_id|session_id|request_id&#x27;</span><br><span class="line"></span><br><span class="line">        # 添加环境标签</span><br><span class="line">        - target_label: environment</span><br><span class="line">          replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">        # 只保留核心标签</span><br><span class="line">        - action: labelkeep</span><br><span class="line">          regex: &#x27;(job|instance|__name__|service|method|status|environment)&#x27;</span><br><span class="line"></span><br><span class="line">  2. 数据库监控优化</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;postgresql-exporter&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;postgres-exporter:9187&#x27;]</span><br><span class="line">      metric_relabel_configs:</span><br><span class="line">        # 只保留重要的数据库指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(pg_stat_database_.*|pg_stat_bgwriter_.*|pg_settings_.*|up)&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除连接详情（高基数）</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: drop</span><br><span class="line">          regex: &#x27;pg_stat_activity_.*&#x27;</span><br><span class="line"></span><br><span class="line">        # 简化数据库标签</span><br><span class="line">        - source_labels: [datname]</span><br><span class="line">          target_label: database</span><br><span class="line">          regex: &#x27;(.+)&#x27;</span><br><span class="line">          replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除用户信息</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;usename|application_name&#x27;</span><br><span class="line"></span><br><span class="line">        # 标准化指标名称</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          regex: &#x27;pg_stat_database_(.+)&#x27;</span><br><span class="line">          replacement: &#x27;postgres_db_$1&#x27;</span><br><span class="line">          target_label: __name__</span><br><span class="line"></span><br><span class="line">  3. 微服务环境优化</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;microservices&#x27;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: pod</span><br><span class="line">      relabel_configs:</span><br><span class="line">        # 只监控带注解的 Pod</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;true&#x27;</span><br><span class="line">      metric_relabel_configs:</span><br><span class="line">        # 根据服务类型过滤指标</span><br><span class="line">        - source_labels: [service]</span><br><span class="line">          regex: &#x27;web&#x27;</span><br><span class="line">          action: keep</span><br><span class="line">          target_label: __name__</span><br><span class="line">          regex: &#x27;(http_.*|request_.*|response_.*)&#x27;</span><br><span class="line"></span><br><span class="line">        - source_labels: [service]</span><br><span class="line">          regex: &#x27;api&#x27;</span><br><span class="line">          action: keep</span><br><span class="line">          target_label: __name__</span><br><span class="line">          regex: &#x27;(api_.*|business_.*|database_.*)&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除中间件指标（单独监控）</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: drop</span><br><span class="line">          regex: &#x27;(redis_|mysql_|kafka_)&#x27;</span><br><span class="line"></span><br><span class="line">        # 统一服务标签命名</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_label_app]</span><br><span class="line">          target_label: service</span><br><span class="line">          regex: &#x27;(.+)&#x27;</span><br><span class="line">          replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">        # 添加基础设施标签</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_node_name]</span><br><span class="line">          target_label: node</span><br><span class="line"></span><br><span class="line">        # 删除 Kubernetes 元数据</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;__meta_kubernetes_.*&#x27;</span><br><span class="line"></span><br><span class="line">        # 限制直方图桶数量</span><br><span class="line">        - source_labels: [le]</span><br><span class="line">          regex: &#x27;(0.1|0.5|1|2.5|5|10|\+Inf)&#x27;</span><br><span class="line">          action: keep</span><br><span class="line"></span><br><span class="line">  4. 成本控制配置</span><br><span class="line"></span><br><span class="line">  scrape_configs:</span><br><span class="line">    - job_name: &#x27;cost-optimized&#x27;</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&#x27;app:8080&#x27;]</span><br><span class="line">      metric_relabel_configs:</span><br><span class="line">        # 严格限制指标数量</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(up|http_requests_total|http_request_duration_seconds|cpu_usage|memory_usage)&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除所有直方图桶，只保留摘要</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: drop</span><br><span class="line">          regex: &#x27;.*_bucket$&#x27;</span><br><span class="line"></span><br><span class="line">        # 限制标签数量</span><br><span class="line">        - action: labelkeep</span><br><span class="line">          regex: &#x27;(job|instance|__name__|method|status)&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除高基数标签值</span><br><span class="line">        - source_labels: [endpoint]</span><br><span class="line">          regex: &#x27;/api/v[0-9]+/users/[0-9]+.*&#x27;</span><br><span class="line">          target_label: endpoint</span><br><span class="line">          replacement: &#x27;/api/v&#123;version&#125;/users/&#123;id&#125;&#x27;</span><br><span class="line"></span><br><span class="line">        # 聚合相似指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          regex: &#x27;(.*)_duration_seconds_(count|sum|bucket)&#x27;</span><br><span class="line">          target_label: __name__</span><br><span class="line">          replacement: &#x27;request_duration_seconds_$1&#x27;</span><br><span class="line"></span><br><span class="line">  高级用法</span><br><span class="line"></span><br><span class="line">  1. 条件性标签处理</span><br><span class="line"></span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 根据环境决定保留哪些指标</span><br><span class="line">    - source_labels: [environment]</span><br><span class="line">      regex: &#x27;production&#x27;</span><br><span class="line">      action: keep</span><br><span class="line">      target_label: __name__</span><br><span class="line">      regex: &#x27;(business_.*|security_.*|performance_.*)&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [environment]</span><br><span class="line">      regex: &#x27;development&#x27;</span><br><span class="line">      action: keep</span><br><span class="line">      target_label: __name__</span><br><span class="line">      regex: &#x27;.*&#x27;  # 开发环境保留所有指标</span><br><span class="line"></span><br><span class="line">  2. 动态标签替换</span><br><span class="line"></span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 根据标签值动态设置新标签</span><br><span class="line">    - source_labels: [status_code]</span><br><span class="line">      regex: &#x27;([1-5][0-9][0-9])&#x27;</span><br><span class="line">      target_label: status_class</span><br><span class="line">      replacement: &#x27;$1xx&#x27;</span><br><span class="line">      replacement: &#x27;$&#123;1&#125;xx&#x27;</span><br><span class="line"></span><br><span class="line">    # 根据服务类型设置监控级别</span><br><span class="line">    - source_labels: [service_type]</span><br><span class="line">      regex: &#x27;critical&#x27;</span><br><span class="line">      target_label: monitoring_level</span><br><span class="line">      replacement: &#x27;high&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [service_type]</span><br><span class="line">      regex: &#x27;normal&#x27;</span><br><span class="line">      target_label: monitoring_level</span><br><span class="line">      replacement: &#x27;medium&#x27;</span><br><span class="line"></span><br><span class="line">  3. 标签值规范化</span><br><span class="line"></span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 统一环境标签值</span><br><span class="line">    - source_labels: [environment]</span><br><span class="line">      regex: &#x27;(prod|production)&#x27;</span><br><span class="line">      target_label: environment</span><br><span class="line">      replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [environment]</span><br><span class="line">      regex: &#x27;(dev|development)&#x27;</span><br><span class="line">      target_label: environment</span><br><span class="line">      replacement: &#x27;development&#x27;</span><br><span class="line"></span><br><span class="line">    # 统一版本标签格式</span><br><span class="line">    - source_labels: [version]</span><br><span class="line">      regex: &#x27;v?([0-9]+\.[0-9]+\.[0-9]+).*&#x27;</span><br><span class="line">      target_label: version</span><br><span class="line">      replacement: &#x27;$1&#x27;</span><br><span class="line"></span><br><span class="line">  性能优化建议</span><br><span class="line"></span><br><span class="line">  1. 处理顺序优化</span><br><span class="line"></span><br><span class="line">  # ✅ 先删除不需要的指标，再处理标签</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    # 步骤 1: 删除不需要的指标</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;debug_.*|trace_.*&#x27;</span><br><span class="line"></span><br><span class="line">    # 步骤 2: 处理标签</span><br><span class="line">    - source_labels: [service]</span><br><span class="line">      target_label: service_name</span><br><span class="line"></span><br><span class="line">    # 步骤 3: 标签清理</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;temp_.*&#x27;</span><br><span class="line"></span><br><span class="line">  2. 正则表达式优化</span><br><span class="line"></span><br><span class="line">  # ✅ 使用精确的正则表达式</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    action: drop</span><br><span class="line">    regex: &#x27;^go_.*&#x27;  # 只匹配以 go_ 开头的指标</span><br><span class="line"></span><br><span class="line">  # ✅ 使用锚点</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    regex: &#x27;http_requests_total$&#x27;  # 精确匹配</span><br><span class="line"></span><br><span class="line">  # ❌ 避免过于宽泛的匹配</span><br><span class="line">  - source_labels: [__name__]</span><br><span class="line">    regex: &#x27;.*&#x27;  # 匹配所有指标</span><br><span class="line"></span><br><span class="line">  监控和调试</span><br><span class="line"></span><br><span class="line">  1. 监控 Metric Relabeling 效果</span><br><span class="line"></span><br><span class="line">  # 监控指标摄入情况</span><br><span class="line">  # prometheus_tsdb_head_samples_appended_total</span><br><span class="line">  # prometheus_tsdb_head_series_created_total</span><br><span class="line">  # prometheus_config_last_reload_successful</span><br><span class="line"></span><br><span class="line">  2. 调试配置</span><br><span class="line"></span><br><span class="line">  # 临时保留原始指标名用于调试</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      target_label: original_metric_name</span><br><span class="line">      regex: &#x27;(.+)&#x27;</span><br><span class="line"></span><br><span class="line">    # 执行过滤...</span><br><span class="line">    - source_labels: [__name__]</span><br><span class="line">      action: drop</span><br><span class="line">      regex: &#x27;debug_.*&#x27;</span><br><span class="line"></span><br><span class="line">    # 生产环境删除调试标签</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: &#x27;original_metric_name&#x27;</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 成本控制</span><br><span class="line"></span><br><span class="line">  - 在大规模部署中积极使用 metric relabeling 控制存储成本</span><br><span class="line">  - 定期审查和优化指标保留策略</span><br><span class="line">  - 根据业务价值调整指标保留优先级</span><br><span class="line"></span><br><span class="line">  2. 标签管理</span><br><span class="line"></span><br><span class="line">  - 限制标签数量和基数</span><br><span class="line">  - 标准化标签命名规范</span><br><span class="line">  - 定期清理不再需要的标签</span><br><span class="line"></span><br><span class="line">  3. 性能考虑</span><br><span class="line"></span><br><span class="line">  - 将最有效的过滤规则放在前面</span><br><span class="line">  - 使用精确的正则表达式</span><br><span class="line">  - 避免复杂的标签操作链</span><br><span class="line"></span><br><span class="line">  Metric Relabeling 是控制 Prometheus 存储成本和优化性能的重要工具，合理使用可以显著提高监控系统的效率。</span><br></pre></td></tr></table></figure>

<h4 id="alert-relabel-configs"><a href="#alert-relabel-configs" class="headerlink" title="alert_relabel_configs"></a>alert_relabel_configs</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br></pre></td><td class="code"><pre><span class="line">⏺ Alert Relabeling 是 Prometheus 在告警发送到 Alertmanager 之前对告警进行处理的机制，它与 Target Relabeling 和</span><br><span class="line">  Metric Relabeling 使用相同的配置格式，但作用于告警对象。</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  处理流程</span><br><span class="line"></span><br><span class="line">  告警规则触发 → 告警生成 → 外部标签添加 → Alert Relabeling → 发送到 Alertmanager</span><br><span class="line">        ↓              ↓            ↓              ↓                    ↓</span><br><span class="line">    规则评估      创建告警对象   添加集群标签   重写告警标签        路由和通知</span><br><span class="line"></span><br><span class="line">  作用对象</span><br><span class="line"></span><br><span class="line">  - 告警对象 (alerts)，而不是目标或指标</span><br><span class="line">  - 在告警发送到 Alertmanager 之前执行</span><br><span class="line">  - 在外部标签添加之后执行</span><br><span class="line"></span><br><span class="line">  主要用途</span><br><span class="line"></span><br><span class="line">  1. HA Prometheus 标签标准化</span><br><span class="line"></span><br><span class="line">  确保高可用的 Prometheus 服务器发送相同的告警：</span><br><span class="line"></span><br><span class="line">  # Prometheus A 配置</span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      cluster: &#x27;production&#x27;</span><br><span class="line">      region: &#x27;us-west-2&#x27;</span><br><span class="line">      prometheus_replica: &#x27;A&#x27;</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 移除副本标签，确保告警一致</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;prometheus_replica&#x27;</span><br><span class="line"></span><br><span class="line">  # Prometheus B 配置</span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      cluster: &#x27;production&#x27;</span><br><span class="line">      region: &#x27;us-west-2&#x27;</span><br><span class="line">      prometheus_replica: &#x27;B&#x27;</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 移除副本标签，确保告警一致</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;prometheus_replica&#x27;</span><br><span class="line"></span><br><span class="line">  2. 告警标签增强</span><br><span class="line"></span><br><span class="line">  为告警添加额外的上下文信息：</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 添加集群信息</span><br><span class="line">      - source_labels: [cluster]</span><br><span class="line">        target_label: datacenter</span><br><span class="line">        regex: &#x27;prod-(.+)&#x27;</span><br><span class="line">        replacement: &#x27;dc-$1&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加服务团队信息</span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: team</span><br><span class="line">        regex: &#x27;(web|api|database)&#x27;</span><br><span class="line">        replacement: &#x27;$&#123;1&#125;-team&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加优先级</span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: priority</span><br><span class="line">        regex: &#x27;critical&#x27;</span><br><span class="line">        replacement: &#x27;P1&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: priority</span><br><span class="line">        regex: &#x27;warning&#x27;</span><br><span class="line">        replacement: &#x27;P2&#x27;</span><br><span class="line"></span><br><span class="line">  3. 告警过滤和清理</span><br><span class="line"></span><br><span class="line">  删除不需要的告警或标签：</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 删除测试环境的告警</span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        action: drop</span><br><span class="line">        regex: &#x27;test&#x27;</span><br><span class="line"></span><br><span class="line">      # 删除调试告警</span><br><span class="line">      - source_labels: [alertname]</span><br><span class="line">        action: drop</span><br><span class="line">        regex: &#x27;Debug.*|Test.*&#x27;</span><br><span class="line"></span><br><span class="line">      # 清理临时标签</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;temp_.*|debug_.*&#x27;</span><br><span class="line"></span><br><span class="line">      # 只保留核心标签</span><br><span class="line">      - action: labelkeep</span><br><span class="line">        regex: &#x27;(alertname|instance|job|severity|service|team)&#x27;</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  1. 企业级 HA 配置</span><br><span class="line"></span><br><span class="line">  # Prometheus 配置</span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      cluster: &#x27;production&#x27;</span><br><span class="line">      datacenter: &#x27;us-west-2&#x27;</span><br><span class="line">      prometheus_id: &#x27;prometheus-01&#x27;</span><br><span class="line">      role: &#x27;primary&#x27;</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 标准化告警标签，移除实例标识</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;prometheus_id|role&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加路由信息</span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: alert_routing_key</span><br><span class="line">        regex: &#x27;payment-.*&#x27;</span><br><span class="line">        replacement: &#x27;finance-team&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: alert_routing_key</span><br><span class="line">        regex: &#x27;user-.*&#x27;</span><br><span class="line">        replacement: &#x27;user-team&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加环境信息</span><br><span class="line">      - source_labels: [cluster]</span><br><span class="line">        target_label: environment</span><br><span class="line">        regex: &#x27;production&#x27;</span><br><span class="line">        replacement: &#x27;prod&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加 SLA 信息</span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: sla_impact</span><br><span class="line">        regex: &#x27;critical&#x27;</span><br><span class="line">        replacement: &#x27;sla_breach&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: sla_impact</span><br><span class="line">        regex: &#x27;warning&#x27;</span><br><span class="line">        replacement: &#x27;sla_warning&#x27;</span><br><span class="line"></span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets:</span><br><span class="line">            - &#x27;alertmanager-01:9093&#x27;</span><br><span class="line">            - &#x27;alertmanager-02:9093&#x27;</span><br><span class="line"></span><br><span class="line">  2. 多环境告警标准化</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 统一环境标签</span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        target_label: env</span><br><span class="line">        regex: &#x27;(prod|production)&#x27;</span><br><span class="line">        replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        target_label: env</span><br><span class="line">        regex: &#x27;(staging|stage)&#x27;</span><br><span class="line">        replacement: &#x27;staging&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        target_label: env</span><br><span class="line">        regex: &#x27;(dev|development)&#x27;</span><br><span class="line">        replacement: &#x27;development&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加通知渠道</span><br><span class="line">      - source_labels: [env, severity]</span><br><span class="line">        target_label: channel</span><br><span class="line">        regex: &#x27;production;critical&#x27;</span><br><span class="line">        replacement: &#x27;urgent&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [env, severity]</span><br><span class="line">        target_label: channel</span><br><span class="line">        regex: &#x27;production;warning&#x27;</span><br><span class="line">        replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [env, severity]</span><br><span class="line">        target_label: channel</span><br><span class="line">        regex: &#x27;staging;critical&#x27;</span><br><span class="line">        replacement: &#x27;staging-alerts&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加服务分类</span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: service_category</span><br><span class="line">        regex: &#x27;(web|api)-.*&#x27;</span><br><span class="line">        replacement: &#x27;frontend&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: service_category</span><br><span class="line">        regex: &#x27;(database|cache|queue)-.*&#x27;</span><br><span class="line">        replacement: &#x27;backend&#x27;</span><br><span class="line"></span><br><span class="line">      # 清理冗余标签</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;temporary_.*|debug_.*&#x27;</span><br><span class="line"></span><br><span class="line">  3. 动态告警路由</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 基于服务类型的动态路由</span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: routing_group</span><br><span class="line">        regex: &#x27;payment-.*&#x27;</span><br><span class="line">        replacement: &#x27;financial-services&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: routing_group</span><br><span class="line">        regex: &#x27;user-.*|auth-.*&#x27;</span><br><span class="line">        replacement: &#x27;user-services&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: routing_group</span><br><span class="line">        regex: &#x27;inventory-.*|order-.*&#x27;</span><br><span class="line">        replacement: &#x27;ecommerce&#x27;</span><br><span class="line"></span><br><span class="line">      # 基于严重性的优先级设置</span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: notification_priority</span><br><span class="line">        regex: &#x27;critical&#x27;</span><br><span class="line">        replacement: &#x27;high&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: notification_priority</span><br><span class="line">        regex: &#x27;warning&#x27;</span><br><span class="line">        replacement: &#x27;medium&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: notification_priority</span><br><span class="line">        regex: &#x27;info&#x27;</span><br><span class="line">        replacement: &#x27;low&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加时间窗口标签</span><br><span class="line">      - source_labels: []</span><br><span class="line">        target_label: business_hours</span><br><span class="line">        replacement: &#x27;false&#x27;</span><br><span class="line">        # 可以通过其他方式动态设置</span><br><span class="line"></span><br><span class="line">      # 清理系统标签</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;__tmp_.*&#x27;</span><br><span class="line"></span><br><span class="line">  4. 合规性标签处理</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 添加合规性标签</span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: compliance_category</span><br><span class="line">        regex: &#x27;.*(payment|billing|financial).*&#x27;</span><br><span class="line">        replacement: &#x27;pci-dss&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: compliance_category</span><br><span class="line">        regex: &#x27;.*(user|profile|personal).*&#x27;</span><br><span class="line">        replacement: &#x27;gdpr&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: compliance_category</span><br><span class="line">        regex: &#x27;.*(health|medical).*&#x27;</span><br><span class="line">        replacement: &#x27;hipaa&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加数据分类</span><br><span class="line">      - source_labels: [compliance_category]</span><br><span class="line">        target_label: data_classification</span><br><span class="line">        regex: &#x27;pci-dss&#x27;</span><br><span class="line">        replacement: &#x27;confidential&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [compliance_category]</span><br><span class="line">        target_label: data_classification</span><br><span class="line">        regex: &#x27;gdpr&#x27;</span><br><span class="line">        replacement: &#x27;personal&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加保留期要求</span><br><span class="line">      - source_labels: [data_classification]</span><br><span class="line">        target_label: retention_days</span><br><span class="line">        regex: &#x27;confidential&#x27;</span><br><span class="line">        replacement: &#x27;2555&#x27;  # 7 years</span><br><span class="line"></span><br><span class="line">      - source_labels: [data_classification]</span><br><span class="line">        target_label: retention_days</span><br><span class="line">        regex: &#x27;personal&#x27;</span><br><span class="line">        replacement: &#x27;1825&#x27;  # 5 years</span><br><span class="line"></span><br><span class="line">      # 删除敏感信息标签</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;.*password.*|.*secret.*|.*token.*&#x27;</span><br><span class="line"></span><br><span class="line">  高级配置示例</span><br><span class="line"></span><br><span class="line">  1. 基于时间的告警处理</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 工作时间 vs 非工作时间处理</span><br><span class="line">      - source_labels: []</span><br><span class="line">        target_label: business_hours</span><br><span class="line">        replacement: &#x27;true&#x27;</span><br><span class="line">        # 实际实现需要配合时间模板或外部标签</span><br><span class="line"></span><br><span class="line">      # 根据工作时间调整通知</span><br><span class="line">      - source_labels: [business_hours, severity]</span><br><span class="line">        target_label: notification_method</span><br><span class="line">        regex: &#x27;true;critical&#x27;</span><br><span class="line">        replacement: &#x27;immediate&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [business_hours, severity]</span><br><span class="line">        target_label: notification_method</span><br><span class="line">        regex: &#x27;false;critical&#x27;</span><br><span class="line">        replacement: &#x27;urgent&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加时区信息</span><br><span class="line">      - source_labels: [datacenter]</span><br><span class="line">        target_label: timezone</span><br><span class="line">        regex: &#x27;us-west-2&#x27;</span><br><span class="line">        replacement: &#x27;PST&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [datacenter]</span><br><span class="line">        target_label: timezone</span><br><span class="line">        regex: &#x27;us-east-1&#x27;</span><br><span class="line">        replacement: &#x27;EST&#x27;</span><br><span class="line"></span><br><span class="line">  2. 条件性告警增强</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 基于服务类型的条件处理</span><br><span class="line">      - source_labels: [service, severity]</span><br><span class="line">        regex: &#x27;database-.*;critical&#x27;</span><br><span class="line">        target_label: escalation_team</span><br><span class="line">        replacement: &#x27;database-oncall&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [service, severity]</span><br><span class="line">        regex: &#x27;web-.*;critical&#x27;</span><br><span class="line">        target_label: escalation_team</span><br><span class="line">        replacement: &#x27;frontend-oncall&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加自动修复标签</span><br><span class="line">      - source_labels: [alertname]</span><br><span class="line">        target_label: auto_recovery</span><br><span class="line">        regex: &#x27;HighCPUUsage|HighMemoryUsage&#x27;</span><br><span class="line">        replacement: &#x27;enabled&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [alertname]</span><br><span class="line">        target_label: auto_recovery</span><br><span class="line">        regex: &#x27;DiskSpaceLow&#x27;</span><br><span class="line">        replacement: &#x27;manual&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加影响范围标签</span><br><span class="line">      - source_labels: [instance, service]</span><br><span class="line">        target_label: impact_scope</span><br><span class="line">        regex: &#x27;.*-master.*;.*&#x27;</span><br><span class="line">        replacement: &#x27;cluster-wide&#x27;</span><br><span class="line"></span><br><span class="line">      - source_labels: [instance, service]</span><br><span class="line">        target_label: impact_scope</span><br><span class="line">        regex: &#x27;.*-worker.*;.*&#x27;</span><br><span class="line">        replacement: &#x27;service-specific&#x27;</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. HA 环境配置</span><br><span class="line"></span><br><span class="line">  # ✅ 确保 HA 配置的一致性</span><br><span class="line">  global:</span><br><span class="line">    external_labels:</span><br><span class="line">      cluster: &#x27;production&#x27;</span><br><span class="line">      region: &#x27;us-west-2&#x27;</span><br><span class="line">      # 不要添加实例唯一的标签</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 移除任何可能造成差异的标签</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;prometheus_replica|instance_id&#x27;</span><br><span class="line"></span><br><span class="line">      # 添加统一的集群标识</span><br><span class="line">      - target_label: alert_source</span><br><span class="line">        replacement: &#x27;prometheus-ha-cluster&#x27;</span><br><span class="line"></span><br><span class="line">  2. 标签命名规范</span><br><span class="line"></span><br><span class="line">  # ✅ 使用一致的标签命名</span><br><span class="line">  alert_relabel_configs:</span><br><span class="line">    - source_labels: [severity]</span><br><span class="line">      target_label: alert_severity</span><br><span class="line">      regex: &#x27;(.+)&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [service]</span><br><span class="line">      target_label: affected_service</span><br><span class="line">      regex: &#x27;(.+)&#x27;</span><br><span class="line"></span><br><span class="line">    - source_labels: [team]</span><br><span class="line">      target_label: responsible_team</span><br><span class="line">      regex: &#x27;(.+)&#x27;</span><br><span class="line"></span><br><span class="line">  3. 渐进式配置</span><br><span class="line"></span><br><span class="line">  # ✅ 分阶段应用 relabeling</span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 阶段 1: 过滤不需要的告警</span><br><span class="line">      - source_labels: [environment]</span><br><span class="line">        action: drop</span><br><span class="line">        regex: &#x27;test|debug&#x27;</span><br><span class="line"></span><br><span class="line">      # 阶段 2: 标准化核心标签</span><br><span class="line">      - source_labels: [severity]</span><br><span class="line">        target_label: urgency</span><br><span class="line">        regex: &#x27;(.+)&#x27;</span><br><span class="line"></span><br><span class="line">      # 阶段 3: 添加增强信息</span><br><span class="line">      - source_labels: [service]</span><br><span class="line">        target_label: service_owner</span><br><span class="line">        regex: &#x27;(.+)&#x27;</span><br><span class="line">        replacement: &#x27;$1-team&#x27;</span><br><span class="line"></span><br><span class="line">      # 阶段 4: 清理不需要的标签</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;temp_.*|debug_.*&#x27;</span><br><span class="line"></span><br><span class="line">  调试和监控</span><br><span class="line"></span><br><span class="line">  1. 监控告警处理</span><br><span class="line"></span><br><span class="line">  # 监控 Alert Relabeling 的效果</span><br><span class="line">  # prometheus_notifications_total</span><br><span class="line">  # prometheus_notifications_queue_capacity</span><br><span class="line">  # prometheus_notifications_dropped_total</span><br><span class="line"></span><br><span class="line">  2. 调试配置</span><br><span class="line"></span><br><span class="line">  # 临时保留原始标签用于调试</span><br><span class="line">  alerting:</span><br><span class="line">    alert_relabel_configs:</span><br><span class="line">      # 保留原始告警名</span><br><span class="line">      - source_labels: [alertname]</span><br><span class="line">        target_label: original_alertname</span><br><span class="line">        regex: &#x27;(.+)&#x27;</span><br><span class="line"></span><br><span class="line">      # 执行标签处理...</span><br><span class="line"></span><br><span class="line">      # 生产环境移除调试标签</span><br><span class="line">      - action: labeldrop</span><br><span class="line">        regex: &#x27;original_alertname&#x27;</span><br><span class="line"></span><br><span class="line">  与其他 Relabeling 的区别</span><br><span class="line"></span><br><span class="line">  | 特性      | Target Relabeling | Metric Relabeling      | Alert Relabeling      |</span><br><span class="line">  |---------|-------------------|------------------------|-----------------------|</span><br><span class="line">  | 作用对象    | 监控目标              | 指标样本                   | 告警对象                  |</span><br><span class="line">  | 执行时机    | 抓取前               | 摄入前                    | 发送前                   |</span><br><span class="line">  | 影响      | 是否抓取              | 是否存储                   | 如何路由                  |</span><br><span class="line">  | 配置位置    | relabel_configs   | metric_relabel_configs | alert_relabel_configs |</span><br><span class="line">  | 对 up 指标 | ✅ 影响              | ❌ 不影响                  | ❌ 不影响                 |</span><br><span class="line"></span><br><span class="line">  Alert Relabeling 是确保告警一致性和正确路由的重要工具，特别是在 HA 环境和多集群部署中至关重要。</span><br></pre></td></tr></table></figure>

<h4 id="alertmanager-config"><a href="#alertmanager-config" class="headerlink" title="alertmanager_config"></a>alertmanager_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br></pre></td><td class="code"><pre><span class="line">⏺ alertmanager_config 是 Prometheus 配置中用于指定 Alertmanager</span><br><span class="line">  实例和通信参数的部分。它支持静态配置和动态服务发现，提供了丰富的配置选项来适应不同的部署架构。</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  Alertmanager 配置的主要功能：</span><br><span class="line">  - 指定要发送告警的 Alertmanager 实例</span><br><span class="line">  - 配置通信协议和认证方式</span><br><span class="line">  - 支持多种服务发现机制</span><br><span class="line">  - 提供 relabeling 功能进行目标选择和路径修改</span><br><span class="line"></span><br><span class="line">  基础配置参数</span><br><span class="line"></span><br><span class="line">  连接参数</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      # 基础配置</span><br><span class="line">      - timeout: 10s              # 连接超时时间</span><br><span class="line">        api_version: v2           # Alertmanager API 版本</span><br><span class="line">        path_prefix: /            # HTTP 路径前缀</span><br><span class="line">        scheme: http              # 协议方案 (http/https)</span><br><span class="line"></span><br><span class="line">  静态配置示例</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets:</span><br><span class="line">              - &#x27;alertmanager-01:9093&#x27;</span><br><span class="line">              - &#x27;alertmanager-02:9093&#x27;</span><br><span class="line">        timeout: 15s</span><br><span class="line">        api_version: v2</span><br><span class="line">        scheme: http</span><br><span class="line"></span><br><span class="line">      # 带路径前缀的配置</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets:</span><br><span class="line">              - &#x27;alertmanager.internal:9093&#x27;</span><br><span class="line">        path_prefix: &#x27;/alertmanager&#x27;</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">  认证配置</span><br><span class="line"></span><br><span class="line">  1. 基础认证</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line">        basic_auth:</span><br><span class="line">          username: &#x27;prometheus&#x27;</span><br><span class="line">          password_file: &#x27;/etc/prometheus/secrets/alertmanager_password&#x27;</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">  2. 令牌认证</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line">        authorization:</span><br><span class="line">          type: &#x27;Bearer&#x27;</span><br><span class="line">          credentials_file: &#x27;/etc/prometheus/secrets/bearer_token&#x27;</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">  3. AWS SigV4 认证</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager.amazonaws.com&#x27;]</span><br><span class="line">        sigv4:</span><br><span class="line">          region: &#x27;us-west-2&#x27;</span><br><span class="line">          access_key: &#x27;AKIA...&#x27;</span><br><span class="line">          secret_key_file: &#x27;/etc/prometheus/secrets/aws_secret&#x27;</span><br><span class="line">          # 或者使用角色</span><br><span class="line">          role_arn: &#x27;arn:aws:iam::123456789012:role/PrometheusAlertManager&#x27;</span><br><span class="line">          profile: &#x27;default&#x27;</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">  4. OAuth 2.0 认证</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager.example.com&#x27;]</span><br><span class="line">        oauth2:</span><br><span class="line">          client_id: &#x27;prometheus&#x27;</span><br><span class="line">          client_secret_file: &#x27;/etc/prometheus/secrets/oauth_secret&#x27;</span><br><span class="line">          token_url: &#x27;https://auth.example.com/oauth2/token&#x27;</span><br><span class="line">          scopes: [&#x27;alertmanager:write&#x27;]</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">  TLS 配置</span><br><span class="line"></span><br><span class="line">  HTTPS 连接配置</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;secure-alertmanager:9093&#x27;]</span><br><span class="line">        scheme: https</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &#x27;/etc/prometheus/certs/ca.crt&#x27;</span><br><span class="line">          cert_file: &#x27;/etc/prometheus/certs/client.crt&#x27;</span><br><span class="line">          key_file: &#x27;/etc/prometheus/certs/client.key&#x27;</span><br><span class="line">          server_name: &#x27;secure-alertmanager&#x27;</span><br><span class="line">          insecure_skip_verify: false</span><br><span class="line">          min_version: &#x27;TLS12&#x27;</span><br><span class="line"></span><br><span class="line">  服务发现配置</span><br><span class="line"></span><br><span class="line">  1. Kubernetes 服务发现</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: service</span><br><span class="line">            namespaces:</span><br><span class="line">              names: [&#x27;monitoring&#x27;]</span><br><span class="line">            selectors:</span><br><span class="line">              - role: service</span><br><span class="line">                label: &#x27;app=alertmanager&#x27;</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">            target_label: __alerts_path__</span><br><span class="line">            regex: &#x27;alertmanager-(.+)&#x27;</span><br><span class="line">            replacement: &#x27;/api/v1/alerts&#x27;</span><br><span class="line"></span><br><span class="line">          - source_labels: [__meta_kubernetes_endpoint_ready]</span><br><span class="line">            action: keep</span><br><span class="line">            regex: &#x27;true&#x27;</span><br><span class="line"></span><br><span class="line">  2. DNS 服务发现</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - dns_sd_configs:</span><br><span class="line">          - names:</span><br><span class="line">              - &#x27;alertmanager.service.consul&#x27;</span><br><span class="line">              - &#x27;alertmanager-internal.service.consul&#x27;</span><br><span class="line">            type: &#x27;SRV&#x27;</span><br><span class="line">            port: 9093</span><br><span class="line">        refresh_interval: 30s</span><br><span class="line"></span><br><span class="line">  3. 文件服务发现</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - file_sd_configs:</span><br><span class="line">          - files:</span><br><span class="line">              - &#x27;/etc/prometheus/alertmanager_targets/*.yml&#x27;</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line"></span><br><span class="line">  # /etc/prometheus/alertmanager_targets/production.yml</span><br><span class="line">  - targets:</span><br><span class="line">      - &#x27;alertmanager-prod-01:9093&#x27;</span><br><span class="line">      - &#x27;alertmanager-prod-02:9093&#x27;</span><br><span class="line">    labels:</span><br><span class="line">      environment: &#x27;production&#x27;</span><br><span class="line">      cluster: &#x27;us-west-2&#x27;</span><br><span class="line"></span><br><span class="line">  4. HTTP 服务发现</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - http_sd_configs:</span><br><span class="line">          - url: &#x27;http://config-manager.example.com/alertmanager/targets&#x27;</span><br><span class="line">          refresh_interval: 60s</span><br><span class="line">          basic_auth:</span><br><span class="line">            username_file: &#x27;/etc/prometheus/secrets/config_user&#x27;</span><br><span class="line">            password_file: &#x27;/etc/prometheus/secrets/config_pass&#x27;</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  1. 生产环境 HA 配置</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      # 主要 Alertmanager 集群</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: endpoints</span><br><span class="line">            namespaces:</span><br><span class="line">              names: [&#x27;monitoring&#x27;]</span><br><span class="line">            selectors:</span><br><span class="line">              - role: endpoints</span><br><span class="line">                label: &#x27;app=alertmanager&#x27;</span><br><span class="line">                label: &#x27;role=primary&#x27;</span><br><span class="line">        relabel_configs:</span><br><span class="line">          # 选择就绪的端点</span><br><span class="line">          - source_labels: [__meta_kubernetes_endpoint_ready]</span><br><span class="line">            action: keep</span><br><span class="line">            regex: &#x27;true&#x27;</span><br><span class="line"></span><br><span class="line">          # 设置正确的告警路径</span><br><span class="line">          - source_labels: [__meta_kubernetes_endpoint_port_name]</span><br><span class="line">            target_label: __alerts_path__</span><br><span class="line">            regex: &#x27;web&#x27;</span><br><span class="line">            replacement: &#x27;/api/v1/alerts&#x27;</span><br><span class="line"></span><br><span class="line">          - source_labels: [__meta_kubernetes_endpoint_port_name]</span><br><span class="line">            target_label: __alerts_path__</span><br><span class="line">            regex: &#x27;api&#x27;</span><br><span class="line">            replacement: &#x27;/api/v1/alerts&#x27;</span><br><span class="line"></span><br><span class="line">          # 添加集群标识</span><br><span class="line">          - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">            target_label: cluster</span><br><span class="line">            regex: &#x27;monitoring&#x27;</span><br><span class="line">            replacement: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">        timeout: 15s</span><br><span class="line">        api_version: v2</span><br><span class="line">        scheme: http</span><br><span class="line"></span><br><span class="line">      # 备用 Alertmanager</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets:</span><br><span class="line">              - &#x27;backup-alertmanager-01:9093&#x27;</span><br><span class="line">              - &#x27;backup-alertmanager-02:9093&#x27;</span><br><span class="line">        labels:</span><br><span class="line">          role: &#x27;backup&#x27;</span><br><span class="line">          environment: &#x27;production&#x27;</span><br><span class="line">        timeout: 10s</span><br><span class="line">        api_version: v2</span><br><span class="line">        scheme: https</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &#x27;/etc/prometheus/certs/backup_ca.crt&#x27;</span><br><span class="line"></span><br><span class="line">  2. 多环境配置</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      # 开发环境</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager-dev:9093&#x27;]</span><br><span class="line">        timeout: 5s</span><br><span class="line">        api_version: v2</span><br><span class="line">        labels:</span><br><span class="line">          environment: &#x27;development&#x27;</span><br><span class="line">          priority: &#x27;low&#x27;</span><br><span class="line"></span><br><span class="line">      # 测试环境</span><br><span class="line">      - file_sd_configs:</span><br><span class="line">          - files:</span><br><span class="line">              - &#x27;/etc/prometheus/alertmanagers/staging.yml&#x27;</span><br><span class="line">          refresh_interval: 30s</span><br><span class="line">        timeout: 10s</span><br><span class="line">        api_version: v2</span><br><span class="line">        labels:</span><br><span class="line">          environment: &#x27;staging&#x27;</span><br><span class="line">          priority: &#x27;medium&#x27;</span><br><span class="line"></span><br><span class="line">      # 生产环境</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: service</span><br><span class="line">            namespaces:</span><br><span class="line">              names: [&#x27;monitoring&#x27;, &#x27;production&#x27;]</span><br><span class="line">            selectors:</span><br><span class="line">              - role: service</span><br><span class="line">                label: &#x27;monitoring=alertmanager&#x27;</span><br><span class="line">                label: &#x27;environment=production&#x27;</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">            target_label: alertmanager_cluster</span><br><span class="line">            regex: &#x27;alertmanager-(.+)&#x27;</span><br><span class="line">            replacement: &#x27;$1&#x27;</span><br><span class="line">        timeout: 15s</span><br><span class="line">        api_version: v2</span><br><span class="line">        labels:</span><br><span class="line">          environment: &#x27;production&#x27;</span><br><span class="line">          priority: &#x27;high&#x27;</span><br><span class="line"></span><br><span class="line">  3. 混合云配置</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      # 本地集群</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: endpoints</span><br><span class="line">            namespaces:</span><br><span class="line">              names: [&#x27;monitoring&#x27;]</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - source_labels: [__meta_kubernetes_service_label_cloud]</span><br><span class="line">            action: keep</span><br><span class="line">            regex: &#x27;local&#x27;</span><br><span class="line">        timeout: 10s</span><br><span class="line">        scheme: http</span><br><span class="line"></span><br><span class="line">      # AWS 集群</span><br><span class="line">      - ec2_sd_configs:</span><br><span class="line">          - region: &#x27;us-west-2&#x27;</span><br><span class="line">            port: 9093</span><br><span class="line">            filters:</span><br><span class="line">              - name: &#x27;tag:Monitoring&#x27;</span><br><span class="line">                values: [&#x27;alertmanager&#x27;]</span><br><span class="line">              - name: &#x27;instance-state-name&#x27;</span><br><span class="line">                values: [&#x27;running&#x27;]</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - source_labels: [__meta_ec2_tag_Environment]</span><br><span class="line">            target_label: environment</span><br><span class="line">          - source_labels: [__meta_ec2_private_ip]</span><br><span class="line">            target_label: __address__</span><br><span class="line">            regex: &#x27;(.+)&#x27;</span><br><span class="line">            replacement: &#x27;$1:9093&#x27;</span><br><span class="line">        timeout: 15s</span><br><span class="line">        sigv4:</span><br><span class="line">          region: &#x27;us-west-2&#x27;</span><br><span class="line">          profile: &#x27;prometheus&#x27;</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">      # Azure 集群</span><br><span class="line">      - azure_sd_configs:</span><br><span class="line">          - port: 9093</span><br><span class="line">            subscription_id: &#x27;12345678-90ab-cdef-1234-567890abcdef&#x27;</span><br><span class="line">            resource_group: &#x27;monitoring-rg&#x27;</span><br><span class="line">            filters:</span><br><span class="line">              - name: &#x27;tag:monitoring&#x27;</span><br><span class="line">                values: [&#x27;alertmanager&#x27;]</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - source_labels: [__meta_azure_location]</span><br><span class="line">            target_label: region</span><br><span class="line">        timeout: 15s</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">  Relabel 配置</span><br><span class="line"></span><br><span class="line">  1. 选择特定 Alertmanager</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: endpoints</span><br><span class="line">            namespaces:</span><br><span class="line">              names: [&#x27;monitoring&#x27;]</span><br><span class="line">        relabel_configs:</span><br><span class="line">          # 只选择 Alertmanager 服务</span><br><span class="line">          - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">            action: keep</span><br><span class="line">            regex: &#x27;alertmanager.*&#x27;</span><br><span class="line"></span><br><span class="line">          # 排除测试实例</span><br><span class="line">          - source_labels: [__meta_kubernetes_pod_label_environment]</span><br><span class="line">            action: drop</span><br><span class="line">            regex: &#x27;test&#x27;</span><br><span class="line"></span><br><span class="line">          # 设置告警路径</span><br><span class="line">          - target_label: __alerts_path__</span><br><span class="line">            replacement: &#x27;/api/v1/alerts&#x27;</span><br><span class="line"></span><br><span class="line">  2. 动态路径配置</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: endpoints</span><br><span class="line">        relabel_configs:</span><br><span class="line">          # 根据服务名设置不同的 API 路径</span><br><span class="line">          - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">            target_label: __alerts_path__</span><br><span class="line">            regex: &#x27;alertmanager-v1&#x27;</span><br><span class="line">            replacement: &#x27;/api/v1/alerts&#x27;</span><br><span class="line"></span><br><span class="line">          - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">            target_label: __alerts_path__</span><br><span class="line">            regex: &#x27;alertmanager-v2&#x27;</span><br><span class="line">            replacement: &#x27;/api/v2/alerts&#x27;</span><br><span class="line"></span><br><span class="line">          # 默认路径</span><br><span class="line">          - source_labels: []</span><br><span class="line">            target_label: __alerts_path__</span><br><span class="line">            regex: &#x27;.*&#x27;</span><br><span class="line">            replacement: &#x27;/api/v2/alerts&#x27;</span><br><span class="line"></span><br><span class="line">  3. 负载均衡配置</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: endpoints</span><br><span class="line">        relabel_configs:</span><br><span class="line">          # 添加权重标签</span><br><span class="line">          - source_labels: [__meta_kubernetes_endpoint_address_target_name]</span><br><span class="line">            target_label: weight</span><br><span class="line">            regex: &#x27;alertmanager-01&#x27;</span><br><span class="line">            replacement: &#x27;2&#x27;</span><br><span class="line"></span><br><span class="line">          - source_labels: [__meta_kubernetes_endpoint_address_target_name]</span><br><span class="line">            target_label: weight</span><br><span class="line">            regex: &#x27;alertmanager-02&#x27;</span><br><span class="line">            replacement: &#x27;1&#x27;</span><br><span class="line"></span><br><span class="line">          # 添加区域标签</span><br><span class="line">          - source_labels: [__meta_kubernetes_endpoint_topology_kubernetes_io_zone]</span><br><span class="line">            target_label: zone</span><br><span class="line"></span><br><span class="line">  高级配置</span><br><span class="line"></span><br><span class="line">  1. 代理配置</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager.external.com:9093&#x27;]</span><br><span class="line">        proxy_url: &#x27;http://corporate-proxy:8080&#x27;</span><br><span class="line">        no_proxy: &#x27;localhost,.internal&#x27;</span><br><span class="line">        proxy_from_environment: true</span><br><span class="line">        scheme: https</span><br><span class="line"></span><br><span class="line">  2. 自定义 HTTP 头</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line">        http_headers:</span><br><span class="line">          User-Agent:</span><br><span class="line">            values: [&#x27;Prometheus/2.0&#x27;]</span><br><span class="line">          X-Cluster-ID:</span><br><span class="line">            values: [&#x27;prod-cluster-01&#x27;]</span><br><span class="line">          X-Environment:</span><br><span class="line">            values: [&#x27;production&#x27;]</span><br><span class="line"></span><br><span class="line">  3. 多版本 API 支持</span><br><span class="line"></span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      # Alertmanager v1</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager-v1:9093&#x27;]</span><br><span class="line">        api_version: v1</span><br><span class="line">        path_prefix: &#x27;/api/v1&#x27;</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - target_label: __alerts_path__</span><br><span class="line">            replacement: &#x27;/alerts&#x27;</span><br><span class="line"></span><br><span class="line">      # Alertmanager v2</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager-v2:9093&#x27;]</span><br><span class="line">        api_version: v2</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - target_label: __alerts_path__</span><br><span class="line">            replacement: &#x27;/api/v2/alerts&#x27;</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. HA 配置</span><br><span class="line"></span><br><span class="line">  # ✅ 配置多个 Alertmanager 实例</span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - kubernetes_sd_configs:</span><br><span class="line">          - role: endpoints</span><br><span class="line">            namespaces:</span><br><span class="line">              names: [&#x27;monitoring&#x27;]</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">            action: keep</span><br><span class="line">            regex: &#x27;alertmanager&#x27;</span><br><span class="line">      # 至少配置 2-3 个实例</span><br><span class="line"></span><br><span class="line">  2. 超时配置</span><br><span class="line"></span><br><span class="line">  # ✅ 根据网络环境调整超时</span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line">        timeout: 15s          # 生产环境使用较长超时</span><br><span class="line">        api_version: v2</span><br><span class="line"></span><br><span class="line">  3. 安全配置</span><br><span class="line"></span><br><span class="line">  # ✅ 生产环境使用 HTTPS 和认证</span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line">        scheme: https</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &#x27;/etc/prometheus/certs/ca.crt&#x27;</span><br><span class="line">          insecure_skip_verify: false</span><br><span class="line">        basic_auth:</span><br><span class="line">          username_file: &#x27;/etc/prometheus/secrets/username&#x27;</span><br><span class="line">          password_file: &#x27;/etc/prometheus/secrets/password&#x27;</span><br><span class="line"></span><br><span class="line">  监控和调试</span><br><span class="line"></span><br><span class="line">  1. 监控连接状态</span><br><span class="line"></span><br><span class="line">  # 监控指标</span><br><span class="line">  # prometheus_notifications_alertmanagers_discovered</span><br><span class="line">  # prometheus_notifications_queue_length</span><br><span class="line">  # prometheus_notifications_dropped_total</span><br><span class="line">  # prometheus_notifications_errors_total</span><br><span class="line"></span><br><span class="line">  2. 调试配置</span><br><span class="line"></span><br><span class="line">  # 添加调试标签</span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">          - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line">        relabel_configs:</span><br><span class="line">          - target_label: debug_prometheus_instance</span><br><span class="line">            replacement: &#x27;$&#123;POD_NAME&#125;&#x27;</span><br><span class="line"></span><br><span class="line">  Alertmanager 配置提供了灵活的告警路由能力，支持各种部署架构和认证方式，确保告警能够可靠地传递到正确的处理系统。</span><br></pre></td></tr></table></figure>

<h4 id="remote-write"><a href="#remote-write" class="headerlink" title="remote_write"></a>remote_write</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br></pre></td><td class="code"><pre><span class="line">⏺ remote_write 是 Prometheus 的一个强大功能，允许将采集的指标数据实时发送到远程存储系统。这是实现长期数据存储、数</span><br><span class="line">  据聚合和多集群监控的核心组件。</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  Remote Write 的工作流程：</span><br><span class="line">  指标采集 → External Labels → Write Relabeling → 队列处理 → 发送到远程存储</span><br><span class="line">      ↓              ↓                ↓              ↓              ↓</span><br><span class="line">    抓取指标      添加集群标签      过滤和重写     缓冲和批处理    持久化存储</span><br><span class="line"></span><br><span class="line">  核心配置参数</span><br><span class="line"></span><br><span class="line">  1. 基础连接配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://remote-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      name: &#x27;production-storage&#x27;</span><br><span class="line">      remote_timeout: 30s</span><br><span class="line">      protobuf_message: &#x27;io.prometheus.write.v2.Request&#x27;</span><br><span class="line"></span><br><span class="line">  2. 协议版本选择</span><br><span class="line"></span><br><span class="line">  # Remote Write 1.0 (传统)</span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://legacy-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      protobuf_message: &#x27;prometheus.WriteRequest&#x27;</span><br><span class="line">      send_native_histograms: false</span><br><span class="line"></span><br><span class="line">  # Remote Write 2.0 (推荐)</span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://modern-storage.example.com/api/v2/write&#x27;</span><br><span class="line">      protobuf_message: &#x27;io.prometheus.write.v2.Request&#x27;</span><br><span class="line">      send_native_histograms: true  # 总是启用</span><br><span class="line"></span><br><span class="line">  Write Relabeling 配置</span><br><span class="line"></span><br><span class="line">  1. 基础过滤</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        # 只发送特定指标的样本</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(cpu_.*|memory_.*|disk_.*|network_.*)&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除调试指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: drop</span><br><span class="line">          regex: &#x27;debug_.*|test_.*&#x27;</span><br><span class="line"></span><br><span class="line">        # 只发送生产环境的指标</span><br><span class="line">        - source_labels: [environment]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;production&#x27;</span><br><span class="line"></span><br><span class="line">  2. 高级过滤和转换</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        # 根据服务类型过滤</span><br><span class="line">        - source_labels: [service]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(web|api|database|cache)&#x27;</span><br><span class="line"></span><br><span class="line">        # 重命名指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          regex: &#x27;custom_(.+)&#x27;</span><br><span class="line">          replacement: &#x27;app_$1&#x27;</span><br><span class="line">          target_label: __name__</span><br><span class="line"></span><br><span class="line">        # 添加存储标签</span><br><span class="line">        - target_label: storage_backend</span><br><span class="line">          replacement: &#x27;s3-hot&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除高基数标签</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;user_id|session_id|request_id&#x27;</span><br><span class="line"></span><br><span class="line">        # 聚合数据减少存储量</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: drop</span><br><span class="line">          regex: &#x27;.*_bucket$&#x27;  # 删除直方图桶</span><br><span class="line"></span><br><span class="line">  认证配置</span><br><span class="line"></span><br><span class="line">  1. 基础认证</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      basic_auth:</span><br><span class="line">        username: &#x27;prometheus&#x27;</span><br><span class="line">        password_file: &#x27;/etc/prometheus/secrets/storage_password&#x27;</span><br><span class="line">      http_config:</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &#x27;/etc/prometheus/certs/storage_ca.crt&#x27;</span><br><span class="line">          insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  2. 令牌认证</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      authorization:</span><br><span class="line">        type: &#x27;Bearer&#x27;</span><br><span class="line">        credentials_file: &#x27;/etc/prometheus/secrets/storage_token&#x27;</span><br><span class="line">      headers:</span><br><span class="line">        X-Prometheus-Cluster: &#x27;production-cluster-01&#x27;</span><br><span class="line"></span><br><span class="line">  3. AWS SigV4 认证</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://aps-workspaces.us-west-2.amazonaws.com/workspaces/ws-1234567890/api/v1/remote_write&#x27;</span><br><span class="line">      sigv4:</span><br><span class="line">        region: &#x27;us-west-2&#x27;</span><br><span class="line">        role_arn: &#x27;arn:aws:iam::123456789012:role/PrometheusRemoteWrite&#x27;</span><br><span class="line">      queue_config:</span><br><span class="line">        max_shards: 10</span><br><span class="line">        capacity: 5000</span><br><span class="line"></span><br><span class="line">  4. Azure AD 认证</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://azure-monitor.azure.com/api/v1/write&#x27;</span><br><span class="line">      azuread:</span><br><span class="line">        managed_identity:</span><br><span class="line">          client_id: &#x27;your-client-id&#x27;</span><br><span class="line">        cloud: &#x27;AzurePublic&#x27;</span><br><span class="line">      headers:</span><br><span class="line">        X-Azure-Monitoring-Resource:</span><br><span class="line">  &#x27;/subscriptions/subscription-id/resourceGroups/rg-name/providers/microsoft.monitor/accounts/account-name&#x27;</span><br><span class="line"></span><br><span class="line">  队列配置优化</span><br><span class="line"></span><br><span class="line">  1. 基础队列配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 10000           # 每个分片的缓冲区大小</span><br><span class="line">        max_shards: 20            # 最大并发数</span><br><span class="line">        min_shards: 1             # 最小并发数</span><br><span class="line">        max_samples_per_send: 2000 # 每批发送的最大样本数</span><br><span class="line">        batch_send_deadline: 5s   # 批发送截止时间</span><br><span class="line">        min_backoff: 30ms         # 初始重试延迟</span><br><span class="line">        max_backoff: 5s           # 最大重试延迟</span><br><span class="line"></span><br><span class="line">  2. 高性能配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://high-throughput-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 50000           # 大缓冲区</span><br><span class="line">        max_shards: 50            # 高并发</span><br><span class="line">        min_shards: 5             # 保持最小并发</span><br><span class="line">        max_samples_per_send: 5000 # 大批发送</span><br><span class="line">        batch_send_deadline: 10s  # 较长批处理时间</span><br><span class="line">        min_backoff: 10ms         # 快速重试</span><br><span class="line">        max_backoff: 2s           # 较短最大延迟</span><br><span class="line">        retry_on_http_429: true   # 启用 429 重试</span><br><span class="line"></span><br><span class="line">  3. 低延迟配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://low-latency-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 2000            # 小缓冲区</span><br><span class="line">        max_shards: 5             # 低并发</span><br><span class="line">        min_shards: 1</span><br><span class="line">        max_samples_per_send: 500 # 小批次</span><br><span class="line">        batch_send_deadline: 1s   # 快速发送</span><br><span class="line">        min_backoff: 10ms</span><br><span class="line">        max_backoff: 1s</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  1. 生产环境多存储配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    # 主存储 - 高可用长期存储</span><br><span class="line">    - name: &#x27;primary-storage&#x27;</span><br><span class="line">      url: &#x27;https://primary-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      protobuf_message: &#x27;io.prometheus.write.v2.Request&#x27;</span><br><span class="line">      send_native_histograms: true</span><br><span class="line">      send_exemplars: true</span><br><span class="line">      remote_timeout: 30s</span><br><span class="line"></span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        # 发送所有业务指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(business_.*|app_.*|service_.*)&#x27;</span><br><span class="line"></span><br><span class="line">        # 添加存储层标识</span><br><span class="line">        - target_label: storage_tier</span><br><span class="line">          replacement: &#x27;primary&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除调试数据</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;debug_.*&#x27;</span><br><span class="line"></span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 25000</span><br><span class="line">        max_shards: 30</span><br><span class="line">        max_samples_per_send: 3000</span><br><span class="line">        batch_send_deadline: 5s</span><br><span class="line"></span><br><span class="line">      http_config:</span><br><span class="line">        tls_config:</span><br><span class="line">          ca_file: &#x27;/etc/prometheus/certs/primary_ca.crt&#x27;</span><br><span class="line">        basic_auth:</span><br><span class="line">          username_file: &#x27;/etc/prometheus/secrets/primary_user&#x27;</span><br><span class="line">          password_file: &#x27;/etc/prometheus/secrets/primary_pass&#x27;</span><br><span class="line"></span><br><span class="line">    # 备用存储 - 成本优化</span><br><span class="line">    - name: &#x27;backup-storage&#x27;</span><br><span class="line">      url: &#x27;https://backup-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      protobuf_message: &#x27;prometheus.WriteRequest&#x27;</span><br><span class="line">      send_native_histograms: false</span><br><span class="line">      send_exemplars: false</span><br><span class="line">      remote_timeout: 60s</span><br><span class="line"></span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        # 只发送核心基础设施指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(node_.*|process_.*|up)&#x27;</span><br><span class="line"></span><br><span class="line">        # 添加存储层标识</span><br><span class="line">        - target_label: storage_tier</span><br><span class="line">          replacement: &#x27;backup&#x27;</span><br><span class="line"></span><br><span class="line">        # 聚合数据减少量</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;.*_bucket&#x27;</span><br><span class="line"></span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 10000</span><br><span class="line">        max_shards: 10</span><br><span class="line">        max_samples_per_send: 1000</span><br><span class="line">        batch_send_deadline: 10s</span><br><span class="line">        min_backoff: 100ms</span><br><span class="line">        max_backoff: 10s</span><br><span class="line"></span><br><span class="line">    # 实时分析存储 - 低延迟</span><br><span class="line">    - name: &#x27;realtime-analytics&#x27;</span><br><span class="line">      url: &#x27;https://analytics.example.com/api/v2/write&#x27;</span><br><span class="line">      protobuf_message: &#x27;io.prometheus.write.v2.Request&#x27;</span><br><span class="line">      send_native_histograms: true</span><br><span class="line">      send_exemplars: true</span><br><span class="line">      remote_timeout: 10s</span><br><span class="line"></span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        # 只发送实时分析需要的指标</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(request_.*|response_.*|throughput_.*)&#x27;</span><br><span class="line"></span><br><span class="line">        # 添加分析标签</span><br><span class="line">        - target_label: analytics_type</span><br><span class="line">          replacement: &#x27;realtime&#x27;</span><br><span class="line"></span><br><span class="line">        # 确保时间精度</span><br><span class="line">        - source_labels: []</span><br><span class="line">          target_label: precision</span><br><span class="line">          replacement: &#x27;millisecond&#x27;</span><br><span class="line"></span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 5000</span><br><span class="line">        max_shards: 5</span><br><span class="line">        max_samples_per_send: 500</span><br><span class="line">        batch_send_deadline: 1s</span><br><span class="line">        min_backoff: 5ms</span><br><span class="line">        max_backoff: 500ms</span><br><span class="line"></span><br><span class="line">  2. 云原生配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    # AWS Prometheus 服务</span><br><span class="line">    - name: &#x27;aws-aps&#x27;</span><br><span class="line">      url: &#x27;https://aps-workspaces.us-west-2.amazonaws.com/workspaces/ws-1234567890/api/v1/remote_write&#x27;</span><br><span class="line">      sigv4:</span><br><span class="line">        region: &#x27;us-west-2&#x27;</span><br><span class="line">      protobuf_message: &#x27;io.prometheus.write.v2.Request&#x27;</span><br><span class="line"></span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        # 添加 AWS 特定标签</span><br><span class="line">        - target_label: cloud_provider</span><br><span class="line">          replacement: &#x27;aws&#x27;</span><br><span class="line">        - target_label: region</span><br><span class="line">          replacement: &#x27;us-west-2&#x27;</span><br><span class="line"></span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 15000</span><br><span class="line">        max_shards: 20</span><br><span class="line">        retry_on_http_429: true</span><br><span class="line"></span><br><span class="line">    # Azure Monitor</span><br><span class="line">    - name: &#x27;azure-monitor&#x27;</span><br><span class="line">      url: &#x27;https://eastus.monitoring.azure.com/subscriptions/sub-id/resourceGroups/rg-name/providers/Microsoft.Mo</span><br><span class="line">  nitor/accounts/account-name/api/v1/write&#x27;</span><br><span class="line">      azuread:</span><br><span class="line">        managed_identity:</span><br><span class="line">          client_id: &#x27;managed-identity-client-id&#x27;</span><br><span class="line"></span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        - target_label: cloud_provider</span><br><span class="line">          replacement: &#x27;azure&#x27;</span><br><span class="line">        - target_label: region</span><br><span class="line">          replacement: &#x27;eastus&#x27;</span><br><span class="line"></span><br><span class="line">      headers:</span><br><span class="line">        X-Azure-Monitoring-Resource:</span><br><span class="line">  &#x27;/subscriptions/sub-id/resourceGroups/rg-name/providers/microsoft.monitor/accounts/account-name&#x27;</span><br><span class="line"></span><br><span class="line">  3. 成本优化配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - name: &#x27;cost-optimized-storage&#x27;</span><br><span class="line">      url: &#x27;https://cheap-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      protobuf_message: &#x27;prometheus.WriteRequest&#x27;  # 使用旧协议节省成本</span><br><span class="line">      send_native_histograms: false  # 禁用原生直方图</span><br><span class="line">      send_exemplars: false         # 禁用 exemplar</span><br><span class="line"></span><br><span class="line">      write_relabel_configs:</span><br><span class="line">        # 严格限制指标数量</span><br><span class="line">        - source_labels: [__name__]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: &#x27;(up|cpu_usage|memory_usage|disk_usage|network_bytes)&#x27;</span><br><span class="line"></span><br><span class="line">        # 删除高基数标签</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;pod|container|endpoint&#x27;</span><br><span class="line"></span><br><span class="line">        # 聚合数据</span><br><span class="line">        - action: labeldrop</span><br><span class="line">          regex: &#x27;.*_bucket|.*_quantile&#x27;</span><br><span class="line"></span><br><span class="line">        # 添加成本标签</span><br><span class="line">        - target_label: storage_class</span><br><span class="line">          replacement: &#x27;economy&#x27;</span><br><span class="line"></span><br><span class="line">      queue_config:</span><br><span class="line">        capacity: 5000            # 较小缓冲区</span><br><span class="line">        max_shards: 5              # 低并发</span><br><span class="line">        max_samples_per_send: 1000 # 中等批次</span><br><span class="line">        batch_send_deadline: 10s   # 较长等待时间</span><br><span class="line">        sample_age_limit: 5m       # 丢弃旧样本</span><br><span class="line"></span><br><span class="line">  元数据配置</span><br><span class="line"></span><br><span class="line">  1. 基础元数据配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      protobuf_message: &#x27;prometheus.WriteRequest&#x27;</span><br><span class="line">      metadata_config:</span><br><span class="line">        send: true</span><br><span class="line">        send_interval: 1m</span><br><span class="line">        max_samples_per_send: 500</span><br><span class="line"></span><br><span class="line">  2. 高频元数据更新</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      metadata_config:</span><br><span class="line">        send: true</span><br><span class="line">        send_interval: 30s        # 高频更新</span><br><span class="line">        max_samples_per_send: 200</span><br><span class="line"></span><br><span class="line">  高级功能</span><br><span class="line"></span><br><span class="line">  1. DNS 轮询</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage-cluster.example.com/api/v1/write&#x27;</span><br><span class="line">      round_robin_dns: true</span><br><span class="line">      queue_config:</span><br><span class="line">        max_shards: 10</span><br><span class="line"></span><br><span class="line">  2. 自定义 HTTP 头</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://storage.example.com/api/v1/write&#x27;</span><br><span class="line">      headers:</span><br><span class="line">        X-Prometheus-Cluster: &#x27;production&#x27;</span><br><span class="line">        X-Prometheus-Version: &#x27;2.45.0&#x27;</span><br><span class="line">        X-Data-Retention: &#x27;90d&#x27;</span><br><span class="line">        X-Cost-Center: &#x27;engineering&#x27;</span><br><span class="line"></span><br><span class="line">  3. 代理配置</span><br><span class="line"></span><br><span class="line">  remote_write:</span><br><span class="line">    - url: &#x27;https://external-storage.example.com/api/v1/write&#x27;</span><br><span class="line">      http_config:</span><br><span class="line">        proxy_url: &#x27;http://corporate-proxy:8080&#x27;</span><br><span class="line">        no_proxy: &#x27;localhost,.internal&#x27;</span><br><span class="line">        proxy_connect_header:</span><br><span class="line">          Proxy-Authorization: [&#x27;Basic dXNlcjpwYXNz&#x27;]</span><br><span class="line"></span><br><span class="line">  性能监控</span><br><span class="line"></span><br><span class="line">  关键指标</span><br><span class="line"></span><br><span class="line">  # 监控 Remote Write 性能的指标</span><br><span class="line">  # prometheus_remote_storage_samples_total</span><br><span class="line">  # prometheus_remote_storage_samples_failed_total</span><br><span class="line">  # prometheus_remote_storage_samples_pending</span><br><span class="line">  # prometheus_remote_storage_samples_retry_failed_total</span><br><span class="line">  # prometheus_remote_storage_highest_timestamp_in_seconds</span><br><span class="line">  # prometheus_remote_storage_queue_highest_sent_timestamp_seconds</span><br><span class="line"></span><br><span class="line">  告警规则示例</span><br><span class="line"></span><br><span class="line">  # Remote Write 告警规则</span><br><span class="line">  groups:</span><br><span class="line">    - name: remote-write</span><br><span class="line">      rules:</span><br><span class="line">        # 样本积压告警</span><br><span class="line">        - alert: RemoteWriteBacklog</span><br><span class="line">          expr: prometheus_remote_storage_samples_pending &gt; 10000</span><br><span class="line">          for: 5m</span><br><span class="line">          labels:</span><br><span class="line">            severity: warning</span><br><span class="line">          annotations:</span><br><span class="line">            summary: &quot;Remote write backlog is high&quot;</span><br><span class="line">            description: &quot;&#123;&#123; $value &#125;&#125; samples are pending to be sent to remote storage&quot;</span><br><span class="line"></span><br><span class="line">        # 发送失败率告警</span><br><span class="line">        - alert: RemoteWriteHighFailureRate</span><br><span class="line">          expr: rate(prometheus_remote_storage_samples_failed_total[5m]) /</span><br><span class="line">  rate(prometheus_remote_storage_samples_total[5m]) &gt; 0.05</span><br><span class="line">          for: 2m</span><br><span class="line">          labels:</span><br><span class="line">            severity: critical</span><br><span class="line">          annotations:</span><br><span class="line">            summary: &quot;Remote write failure rate is high&quot;</span><br><span class="line">            description: &quot;Remote write failure rate is &#123;&#123; $value | humanizePercentage &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # 队列延迟告警</span><br><span class="line">        - alert: RemoteWriteQueueDelay</span><br><span class="line">          expr: time() - prometheus_remote_storage_queue_highest_sent_timestamp_seconds &gt; 60</span><br><span class="line">          for: 3m</span><br><span class="line">          labels:</span><br><span class="line">            severity: warning</span><br><span class="line">          annotations:</span><br><span class="line">            summary: &quot;Remote write queue delay is high&quot;</span><br><span class="line">            description: &quot;Samples are waiting &#123;&#123; $value &#125;&#125; seconds to be sent&quot;</span><br><span class="line"></span><br><span class="line">  最佳实践</span><br><span class="line"></span><br><span class="line">  1. 配置优化</span><br><span class="line"></span><br><span class="line">  - 使用 io.prometheus.write.v2.Request 协议提高效率</span><br><span class="line">  - 根据存储能力调整队列配置</span><br><span class="line">  - 使用 write_relabelings 控制发送的数据量</span><br><span class="line"></span><br><span class="line">  2. 成本控制</span><br><span class="line"></span><br><span class="line">  - 过滤不必要的指标</span><br><span class="line">  - 聚合高基数数据</span><br><span class="line">  - 选择合适的存储层级</span><br><span class="line"></span><br><span class="line">  3. 可靠性</span><br><span class="line"></span><br><span class="line">  - 配置多个远程存储端点</span><br><span class="line">  - 设置适当的重试策略</span><br><span class="line">  - 监控发送状态和失败率</span><br><span class="line"></span><br><span class="line">  Remote Write 是构建现代监控系统的关键组件，合理配置可以实现高可用、可扩展的长期数据存储解决方案。</span><br></pre></td></tr></table></figure>

<h4 id="remote-read"><a href="#remote-read" class="headerlink" title="remote_read"></a>remote_read</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这是一个 Prometheus 的 remote_read 配置段，用于设置从远程存储系统读取监控数据的配置。让我详细解释每个部分：</span><br><span class="line"></span><br><span class="line">  基本配置</span><br><span class="line"></span><br><span class="line">  url: 远程读取 API 的端点 URL（必需参数）</span><br><span class="line"></span><br><span class="line">  name: 远程读取配置的名称（可选）</span><br><span class="line">  - 必须在所有远程读取配置中唯一</span><br><span class="line">  - 用于指标和日志记录，帮助用户区分不同的远程读取配置</span><br><span class="line"></span><br><span class="line">  选择器配置</span><br><span class="line"></span><br><span class="line">  required_matchers: 必需的标签匹配器（可选）</span><br><span class="line">  - 查询远程端点时，选择器中必须包含这些标签匹配条件</span><br><span class="line">  - 示例：</span><br><span class="line">  required_matchers:</span><br><span class="line">    cluster: production</span><br><span class="line">    region: us-west</span><br><span class="line"></span><br><span class="line">  连接配置</span><br><span class="line"></span><br><span class="line">  remote_timeout: 请求超时时间（可选）</span><br><span class="line">  - 默认值为 1 分钟</span><br><span class="line">  - 控制向远程端点发送请求的等待时间</span><br><span class="line"></span><br><span class="line">  headers: 自定义 HTTP 头（可选）</span><br><span class="line">  - 随每个远程读取请求一起发送</span><br><span class="line">  - 注意：Prometheus 自身设置的头信息不能被覆盖</span><br><span class="line">  - 示例：</span><br><span class="line">  headers:</span><br><span class="line">    Authorization: &quot;Bearer token123&quot;</span><br><span class="line">    X-Custom-Header: &quot;value&quot;</span><br><span class="line"></span><br><span class="line">  数据读取策略</span><br><span class="line"></span><br><span class="line">  read_recent: 是否读取近期数据（可选）</span><br><span class="line">  - 默认值为 false</span><br><span class="line">  - 设置为 true 时，即使本地存储有完整的时间范围数据，也会查询远程端点</span><br><span class="line"></span><br><span class="line">  filter_external_labels: 是否使用外部标签作为选择器（可选）</span><br><span class="line">  - 默认值为 true</span><br><span class="line">  - 使用 Prometheus 的外部标签来过滤远程读取请求</span><br><span class="line"></span><br><span class="line">  HTTP 客户端配置</span><br><span class="line"></span><br><span class="line">  &lt;http_config&gt;: HTTP 客户端配置</span><br><span class="line">  - 包括身份验证方法（如基本认证、授权）</span><br><span class="line">  - 代理配置</span><br><span class="line">  - TLS 选项</span><br><span class="line">  - 自定义 HTTP 头等</span><br><span class="line"></span><br><span class="line">  典型使用场景</span><br><span class="line"></span><br><span class="line">  1. 长期存储: 将历史数据存储在远程系统，Prometheus 只保留近期数据</span><br><span class="line">  2. 数据联合: 从多个 Prometheus 实例或存储系统聚合数据</span><br><span class="line">  3. 高可用性: 当本地存储不可用时，从远程备份读取数据</span><br><span class="line"></span><br><span class="line">  这个配置是 Prometheus 联邦查询和长期存储解决方案的重要组成部分。</span><br></pre></td></tr></table></figure>

<h4 id="tsdb"><a href="#tsdb" class="headerlink" title="tsdb"></a>tsdb</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这是 Prometheus TSDB（时序数据库）的配置部分，专门用于配置乱序样本处理的时间窗口设置。让我详细解释：</span><br><span class="line"></span><br><span class="line">  核心配置</span><br><span class="line"></span><br><span class="line">  out_of_order_time_window: 乱序时间窗口（可选参数）</span><br><span class="line">  - 默认值：0s（不接受乱序样本）</span><br><span class="line">  - 类型：时间间隔（duration）</span><br><span class="line"></span><br><span class="line">  乱序样本处理机制</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  - 正常顺序: 样本按时间戳递增顺序到达</span><br><span class="line">  - 乱序样本: 时间戳比当前 TSDB 最大时间更早的样本</span><br><span class="line">  - 越界样本: 时间戳超出合理范围的样本</span><br><span class="line"></span><br><span class="line">  处理逻辑</span><br><span class="line"></span><br><span class="line">  当设置时间窗口 &gt; 0 时：</span><br><span class="line"></span><br><span class="line">  1. 可接受的条件：</span><br><span class="line">  样本时间戳 &gt;= TSDB.MaxTime - out_of_order_time_window</span><br><span class="line">  2. 样本分类：</span><br><span class="line">    - (a) 可摄取样本：</span><br><span class="line">        - 正常顺序的样本</span><br><span class="line">      - 在乱序时间窗口内的乱序/越界样本</span><br><span class="line">    - (b) 过旧样本：</span><br><span class="line">        - 不在顺序内且在乱序时间窗口之外的样本</span><br><span class="line"></span><br><span class="line">  错误处理变化</span><br><span class="line"></span><br><span class="line">  - 窗口 = 0 时：错误分为 &quot;out-of-order&quot; 和 &quot;out-of-bounds&quot;</span><br><span class="line">  - 窗口 &gt; 0 时：错误合并为单一的 &quot;too-old&quot; 错误</span><br><span class="line"></span><br><span class="line">  对实验性 Agent 的影响</span><br><span class="line"></span><br><span class="line">  当 out_of_order_time_window &gt; 0 时：</span><br><span class="line"></span><br><span class="line">  - Agent WAL 允许接受乱序样本</span><br><span class="line">  - 判断条件：相对于同一序列最后追加样本的时间戳</span><br><span class="line">  - 时间窗口：指定的配置时间窗口内</span><br><span class="line"></span><br><span class="line">  实际使用场景</span><br><span class="line"></span><br><span class="line">  1. 网络延迟和重排序</span><br><span class="line"></span><br><span class="line">  # 允许 5 分钟内的乱序样本</span><br><span class="line">  out_of_order_time_window: 5m</span><br><span class="line"></span><br><span class="line">  2. 多源数据聚合</span><br><span class="line"></span><br><span class="line">  # 当从多个时间不同步的源收集数据时</span><br><span class="line">  out_of_order_time_window: 10m</span><br><span class="line"></span><br><span class="line">  3. 批量传输延迟</span><br><span class="line"></span><br><span class="line">  # 处理批量传输可能导致的数据延迟</span><br><span class="line">  out_of_order_time_window: 30m</span><br><span class="line"></span><br><span class="line">  性能考虑</span><br><span class="line"></span><br><span class="line">  优点：</span><br><span class="line">  - 提高数据完整性，减少因网络延迟导致的数据丢失</span><br><span class="line">  - 增强系统对时钟不同步的容忍度</span><br><span class="line"></span><br><span class="line">  缺点：</span><br><span class="line">  - 增加内存使用，需要维护更大的时间窗口</span><br><span class="line">  - 可能影响查询性能，因为需要处理更多的数据状态</span><br><span class="line">  - 延迟数据可见性，因为数据可能需要等待才能被处理</span><br><span class="line"></span><br><span class="line">  这个配置主要用于处理分布式环境中因网络延迟、时钟不同步等因素导致的监控数据乱序到达问题。</span><br></pre></td></tr></table></figure>

<h4 id="exemplars"><a href="#exemplars" class="headerlink" title="exemplars"></a>exemplars</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这是 Prometheus 中关于 Exemplar 存储 的配置，Exemplar 是一种用于存储具体样本数据的实验性功能。让我详细解释：</span><br><span class="line"></span><br><span class="line">  功能概述</span><br><span class="line"></span><br><span class="line">  Exemplar：存储具体的、有代表性的监控样本数据，通常用于性能分析和问题诊断</span><br><span class="line"></span><br><span class="line">  - 实验性功能：仍处于实验阶段</span><br><span class="line">  - 启用方式：需要通过 --enable-feature=exemplar-storage 启动参数开启</span><br><span class="line"></span><br><span class="line">  核心配置</span><br><span class="line"></span><br><span class="line">  max_exemplars: Exemplar 循环缓冲区的最大大小</span><br><span class="line">  - 类型：整数</span><br><span class="line">  - 默认值：100,000</span><br><span class="line">  - 运行时可调整：可在运行时重新配置大小</span><br><span class="line"></span><br><span class="line">  工作机制</span><br><span class="line"></span><br><span class="line">  循环缓冲区</span><br><span class="line"></span><br><span class="line">  - 存储方式：使用循环缓冲区存储所有序列的 Exemplar</span><br><span class="line">  - 内存管理：当缓冲区满时，最旧的 Exemplar 会被新数据覆盖</span><br><span class="line">  - 全局限制：适用于所有时序序列的总和</span><br><span class="line"></span><br><span class="line">  实际用途</span><br><span class="line"></span><br><span class="line">  1. 错误追踪：</span><br><span class="line">  # 存储导致错误的 HTTP 请求详情</span><br><span class="line">  exemplar:</span><br><span class="line">    trace_id: &quot;abc123&quot;</span><br><span class="line">    timestamp: &quot;2024-01-01T12:00:00Z&quot;</span><br><span class="line">    value: 500</span><br><span class="line">    labels:</span><br><span class="line">      error: &quot;database_timeout&quot;</span><br><span class="line"></span><br><span class="line">  2. 性能分析：</span><br><span class="line">  # 存储慢查询的具体信息</span><br><span class="line">  exemplar:</span><br><span class="line">    query: &quot;SELECT * FROM users WHERE id = 12345&quot;</span><br><span class="line">    timestamp: &quot;2024-01-01T12:00:00Z&quot;</span><br><span class="line">    value: 2.5  # 秒</span><br><span class="line"></span><br><span class="line">  配置示例</span><br><span class="line"></span><br><span class="line">  # prometheus.yml</span><br><span class="line">  tsdb:</span><br><span class="line">    max_exemplars: 50000  # 减少内存使用</span><br><span class="line"></span><br><span class="line">  # 启动命令</span><br><span class="line">  ./prometheus --enable-feature=exemplar-storage</span><br><span class="line"></span><br><span class="line">  内存考虑</span><br><span class="line"></span><br><span class="line">  计算方式：</span><br><span class="line">  - 每个 Exemplar 大约占用 100-200 字节</span><br><span class="line">  - 100,000 个 Exemplar ≈ 10-20 MB 内存</span><br><span class="line"></span><br><span class="line">  配置建议：</span><br><span class="line">  - 高负载环境：200,000-500,000</span><br><span class="line">  - 一般环境：50,000-100,000</span><br><span class="line">  - 资源受限：10,000-50,000</span><br><span class="line"></span><br><span class="line">  查询方式</span><br><span class="line"></span><br><span class="line">  PromQL 中使用：</span><br><span class="line">  # 获取 Exemplar</span><br><span class="line">  http_request_duration_seconds&#123;exemplar=&quot;true&quot;&#125;</span><br><span class="line"></span><br><span class="line">  注意：Exemplar 主要与像 Grafana 这样的可视化工具配合使用，提供深入的数据分析能力。</span><br><span class="line"></span><br><span class="line">  这个功能特别适合需要从宏观监控指标深入到具体样本场景的性能优化和故障排查。</span><br></pre></td></tr></table></figure>

<h4 id="tracing-config"><a href="#tracing-config" class="headerlink" title="tracing_config"></a>tracing_config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">⏺ 这是 Prometheus 的分布式追踪导出配置，用于将追踪数据发送到支持 OTLP (OpenTelemetry Protocol) 协议的后端服务。</span><br><span class="line"></span><br><span class="line">  基本概念</span><br><span class="line"></span><br><span class="line">  实验性功能：当前仍为实验性，未来可能发生变化</span><br><span class="line">  协议支持：使用 OTLP 协议导出追踪数据</span><br><span class="line"></span><br><span class="line">  核心配置选项</span><br><span class="line"></span><br><span class="line">  1. 客户端类型</span><br><span class="line"></span><br><span class="line">  client_type: 导出追踪的客户端类型</span><br><span class="line">  - 可选值：&#x27;http&#x27; 或 &#x27;grpc&#x27;</span><br><span class="line">  - 默认值：&#x27;grpc&#x27;</span><br><span class="line">  - 选择考虑：</span><br><span class="line">    - http：更好的兼容性和调试</span><br><span class="line">    - grpc：更好的性能和流式处理</span><br><span class="line"></span><br><span class="line">  2. 服务端点</span><br><span class="line"></span><br><span class="line">  endpoint: 追踪接收端点的地址</span><br><span class="line">  - 格式：&lt;host&gt;:&lt;port&gt;</span><br><span class="line">  - 示例：</span><br><span class="line">  endpoint: &quot;jaeger-collector:4317&quot;  # gRPC</span><br><span class="line">  endpoint: &quot;jaeger-collector:4318&quot;  # HTTP</span><br><span class="line"></span><br><span class="line">  3. 采样策略</span><br><span class="line"></span><br><span class="line">  sampling_fraction: 追踪采样概率</span><br><span class="line">  - 类型：浮点数，范围 0 到 1</span><br><span class="line">  - 默认值：0（不采样）</span><br><span class="line">  - 配置示例：</span><br><span class="line">  sampling_fraction: 0.1    # 10% 采样率</span><br><span class="line">  sampling_fraction: 0.5    # 50% 采样率</span><br><span class="line">  sampling_fraction: 1.0    # 100% 采样率（所有请求）</span><br><span class="line"></span><br><span class="line">  4. 安全配置</span><br><span class="line"></span><br><span class="line">  insecure: 是否使用不安全连接</span><br><span class="line">  - 默认值：false（使用安全连接）</span><br><span class="line">  - 用途：在开发或测试环境可能设为 true</span><br><span class="line"></span><br><span class="line">  5. 自定义头信息</span><br><span class="line"></span><br><span class="line">  headers: HTTP/gRPC 请求的自定义头信息</span><br><span class="line">  headers:</span><br><span class="line">    Authorization: &quot;Bearer eyJhbGciOiJIUzI1NiIs...&quot;</span><br><span class="line">    X-Environment: &quot;production&quot;</span><br><span class="line">    X-Service-Name: &quot;prometheus&quot;</span><br><span class="line"></span><br><span class="line">  6. 数据压缩</span><br><span class="line"></span><br><span class="line">  compression: 数据压缩类型</span><br><span class="line">  - 支持类型：gzip</span><br><span class="line">  - 用途：减少网络传输开销</span><br><span class="line">  compression: &quot;gzip&quot;</span><br><span class="line"></span><br><span class="line">  7. 超时设置</span><br><span class="line"></span><br><span class="line">  timeout: 每批导出的最大等待时间</span><br><span class="line">  - 默认值：10s</span><br><span class="line">  - 场景：网络慢或后端处理慢时可适当增加</span><br><span class="line"></span><br><span class="line">  8. TLS 配置</span><br><span class="line"></span><br><span class="line">  tls_config: TLS 安全连接配置</span><br><span class="line">  tls_config:</span><br><span class="line">    cert_file: &quot;/path/to/cert.pem&quot;</span><br><span class="line">    key_file: &quot;/path/to/key.pem&quot;</span><br><span class="line">    ca_file: &quot;/path/to/ca.pem&quot;</span><br><span class="line">    insecure_skip_verify: false</span><br><span class="line"></span><br><span class="line">  完整配置示例</span><br><span class="line"></span><br><span class="line">  Jaeger 集成</span><br><span class="line"></span><br><span class="line">  tracing_config:</span><br><span class="line">    client_type: &quot;grpc&quot;</span><br><span class="line">    endpoint: &quot;jaeger-collector:4317&quot;</span><br><span class="line">    sampling_fraction: 0.1</span><br><span class="line">    insecure: false</span><br><span class="line">    compression: &quot;gzip&quot;</span><br><span class="line">    timeout: &quot;30s&quot;</span><br><span class="line">    headers:</span><br><span class="line">      X-Service: &quot;prometheus-server&quot;</span><br><span class="line"></span><br><span class="line">  Tempo 集成</span><br><span class="line"></span><br><span class="line">  tracing_config:</span><br><span class="line">    client_type: &quot;http&quot;</span><br><span class="line">    endpoint: &quot;grafana-tempo:4318&quot;</span><br><span class="line">    sampling_fraction: 0.05</span><br><span class="line">    insecure: false</span><br><span class="line">    timeout: &quot;15s&quot;</span><br><span class="line">    tls_config:</span><br><span class="line">      ca_file: &quot;/etc/ssl/certs/ca.pem&quot;</span><br><span class="line"></span><br><span class="line">  典型使用场景</span><br><span class="line"></span><br><span class="line">  1. 性能监控</span><br><span class="line"></span><br><span class="line">  - 监控 Prometheus 查询的执行时间</span><br><span class="line">  - 识别慢查询和性能瓶颈</span><br><span class="line"></span><br><span class="line">  2. 故障诊断</span><br><span class="line"></span><br><span class="line">  - 追踪请求的完整执行路径</span><br><span class="line">  - 识别分布式系统中的问题根因</span><br><span class="line"></span><br><span class="line">  3. 运维优化</span><br><span class="line"></span><br><span class="line">  - 了解系统间的调用关系</span><br><span class="line">  - 优化资源使用和请求路由</span><br><span class="line"></span><br><span class="line">  启用功能</span><br><span class="line"></span><br><span class="line">  需要在启动参数中启用：</span><br><span class="line">  prometheus --enable-feature=tracing</span><br><span class="line"></span><br><span class="line">  这个配置为 Prometheus 提供了现代分布式系统中的可观测性能力，使其能够融入现有的微服务追踪体系。</span><br></pre></td></tr></table></figure>

<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top">zhongmingmao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.zhongmingmao.top/2025/01/24/cloud-native-observability-prometheus-server-v1/">https://blog.zhongmingmao.top/2025/01/24/cloud-native-observability-prometheus-server-v1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">Cloud Native</a><a class="post-meta__tags" href="/tags/observability/">Observability</a></div><div class="post-share"><div class="social-share" data-image="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Observability - Prometheus Concepts</div></div><div class="info-2"><div class="info-item-1">Data model Prometheus fundamentally stores all data as time series streams of timestamped values belonging to the same metric and the same set of labeled dimensions.   Besides stored time series, Prometheus may generate temporary derived time series as the result of queries.    Metric names and labelsEvery time series is uniquely identified by its metric name and optional key-value pairs called labels. Metric names Metric names SHOULD specify the general feature of a system that is measured e.g. http_req...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-23</div><div class="info-item-2">Observability - Prometheus Concepts</div></div><div class="info-2"><div class="info-item-1">Data model Prometheus fundamentally stores all data as time series streams of timestamped values belonging to the same metric and the same set of labeled dimensions.   Besides stored time series, Prometheus may generate temporary derived time series as the result of queries.    Metric names and labelsEvery time series is uniquely identified by its metric name and optional key-value pairs called labels. Metric names Metric names SHOULD specify the general feature of a system that is measured e.g. http_req...</div></div></div></a><a class="pagination-related" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-22</div><div class="info-item-2">Observability - Prometheus Introduction</div></div><div class="info-2"><div class="info-item-1">Summary Open source metrics and monitoring for your systems and services. Monitor your applications, systems, and services with the leading open source monitoring solution. Instrument, collect, store, and query your metrics for alerting, dashboarding, and other use cases.       Feature Desc    Dimensional data model Prometheus models time series in a flexible dimensional data model.Time series are identified by a metric name and a set of key-value pairs.   Powerful queries The PromQL query language allow...</div></div></div></a><a class="pagination-related" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-21</div><div class="info-item-2">Observability - OpenTelemetry Java Zero Code</div></div><div class="info-2"><div class="info-item-1">Java Agent Zero-code instrumentation with Java uses a Java agent JAR attached to any Java 8+ application. It dynamically injects bytecode to capture telemetry from many popular libraries and frameworks. It can be used to capture telemetry data at the “edges” of an app or service such as inbound requests, outbound HTTP calls, database calls, and so on.      Getting startedSetup Download opentelemetry-javaagent.jar from Releases of the opentelemetry-java-instrumentation repository place the JAR in your pre...</div></div></div></a><a class="pagination-related" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-20</div><div class="info-item-2">Observability - OpenTelemetry Java</div></div><div class="info-2"><div class="info-item-1">Intro to OpenTelemetry Java OpenTelemetry Java is the set of OpenTelemetry observability tools for the Java ecosystem. At a high level, it consists of the API, the SDK, and instrumentation.    Overview The API is a set of classes and interfaces for recording telemetry across key observability signals.  It supports multiple implementations, with a low-overhead minimalist Noop and SDK reference implementation provided out of the box.  It is designed to be taken as a direct dependency by libraries, framewor...</div></div></div></a><a class="pagination-related" href="/2025/01/05/cloud-native-observability-opentelemetry-python/" title="Observability - OpenTelemetry Python"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-python-instrumentation.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-05</div><div class="info-item-2">Observability - OpenTelemetry Python</div></div><div class="info-2"><div class="info-item-1">OverviewStatus and Releases   Traces Metrics Logs    Stable Stable Development   Version supportOpenTelemetry-Python supports Python 3.9 and higher.   Installation The API and SDK packages are available on PyPI, and can be installed via pip:  12pip install opentelemetry-apipip install opentelemetry-sdk   In addition, there are several extension packages which can be installed separately as:  12pip install opentelemetry-exporter-&#123;exporter&#125;pip install opentelemetry-instrumentation-&#123;instrumen...</div></div></div></a><a class="pagination-related" href="/2025/01/04/cloud-native-observability-opentelemetry-go/" title="Observability - OpenTelemetry Go"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/o11y-otel-go.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-04</div><div class="info-item-2">Observability - OpenTelemetry Go</div></div><div class="info-2"><div class="info-item-1">OverviewStatus and Releases The logs signal is still experimental. Breaking changes may be introduced in future versions.     Traces Metrics Logs    Stable Stable Beta     Getting StartedExample applicationSetup To begin, set up a go.mod in a new directory:  12345$ go mod init dicego: creating new go.mod: module dice$ lsgo.mod  Create and launch an HTTP server In that same folder, create a file called main.go and add the following code to the file:  123456789101112package mainimport (    &quot;log&quot; ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://zhongmingmao-1253868755.cos.ap-guangzhou.myqcloud.com/z.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zhongmingmao</div><div class="author-info-description">Focus on Infrastructure.</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">642</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">191</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">83</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="mailto:zhongmingmao0625@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Things are always unexpected!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenTelemetry-vs-Prometheus"><span class="toc-number">1.</span> <span class="toc-text">OpenTelemetry vs Prometheus</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Getting-started"><span class="toc-number">2.</span> <span class="toc-text">Getting started</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Downloading-and-running-Prometheus"><span class="toc-number">2.1.</span> <span class="toc-text">Downloading and running Prometheus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuring-Prometheus-to-monitor-itself"><span class="toc-number">2.2.</span> <span class="toc-text">Configuring Prometheus to monitor itself</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Starting-Prometheus"><span class="toc-number">2.3.</span> <span class="toc-text">Starting Prometheus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-the-expression-browser"><span class="toc-number">2.4.</span> <span class="toc-text">Using the expression browser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-the-graphing-interface"><span class="toc-number">2.5.</span> <span class="toc-text">Using the graphing interface</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Starting-up-some-sample-targets"><span class="toc-number">2.6.</span> <span class="toc-text">Starting up some sample targets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configure-Prometheus-to-monitor-the-sample-targets"><span class="toc-number">2.7.</span> <span class="toc-text">Configure Prometheus to monitor the sample targets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configure-rules-for-aggregating-scraped-data-into-new-time-series"><span class="toc-number">2.8.</span> <span class="toc-text">Configure rules for aggregating scraped data into new time series</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reloading-configuration"><span class="toc-number">2.9.</span> <span class="toc-text">Reloading configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shutting-down-your-instance-gracefully"><span class="toc-number">2.10.</span> <span class="toc-text">Shutting down your instance gracefully.</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Installation"><span class="toc-number">3.</span> <span class="toc-text">Installation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-Docker"><span class="toc-number">3.1.</span> <span class="toc-text">Using Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-command-line-parameters"><span class="toc-number">3.1.1.</span> <span class="toc-text">Setting command line parameters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Volumes-bind-mount"><span class="toc-number">3.1.2.</span> <span class="toc-text">Volumes &amp; bind-mount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Save-your-Prometheus-data"><span class="toc-number">3.1.3.</span> <span class="toc-text">Save your Prometheus data</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Configuration"><span class="toc-number">4.</span> <span class="toc-text">Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuration-1"><span class="toc-number">4.1.</span> <span class="toc-text">Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Configuration-file"><span class="toc-number">4.1.1.</span> <span class="toc-text">Configuration file</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#scrape-config"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">scrape_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http-config"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">http_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tls-config"><span class="toc-number">4.1.1.3.</span> <span class="toc-text">tls_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#oauth2"><span class="toc-number">4.1.1.4.</span> <span class="toc-text">oauth2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-sd-config"><span class="toc-number">4.1.1.5.</span> <span class="toc-text">docker_sd_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file-sd-config"><span class="toc-number">4.1.1.6.</span> <span class="toc-text">file_sd_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http-sd-config"><span class="toc-number">4.1.1.7.</span> <span class="toc-text">http_sd_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes-sd-config"><span class="toc-number">4.1.1.8.</span> <span class="toc-text">kubernetes_sd_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#static-config"><span class="toc-number">4.1.1.9.</span> <span class="toc-text">static_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relabel-config"><span class="toc-number">4.1.1.10.</span> <span class="toc-text">relabel_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#metric-relabel-configs"><span class="toc-number">4.1.1.11.</span> <span class="toc-text">metric_relabel_configs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alert-relabel-configs"><span class="toc-number">4.1.1.12.</span> <span class="toc-text">alert_relabel_configs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alertmanager-config"><span class="toc-number">4.1.1.13.</span> <span class="toc-text">alertmanager_config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#remote-write"><span class="toc-number">4.1.1.14.</span> <span class="toc-text">remote_write</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#remote-read"><span class="toc-number">4.1.1.15.</span> <span class="toc-text">remote_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tsdb"><span class="toc-number">4.1.1.16.</span> <span class="toc-text">tsdb</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exemplars"><span class="toc-number">4.1.1.17.</span> <span class="toc-text">exemplars</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tracing-config"><span class="toc-number">4.1.1.18.</span> <span class="toc-text">tracing_config</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-server.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Server V1"/></a><div class="content"><a class="title" href="/2025/01/24/cloud-native-observability-prometheus-server-v1/" title="Observability - Prometheus Server V1">Observability - Prometheus Server V1</a><time datetime="2025-01-23T16:06:25.000Z" title="Created 2025-01-24 00:06:25">2025-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus-concepts.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Concepts"/></a><div class="content"><a class="title" href="/2025/01/23/cloud-native-observability-prometheus-concepts/" title="Observability - Prometheus Concepts">Observability - Prometheus Concepts</a><time datetime="2025-01-22T16:06:25.000Z" title="Created 2025-01-23 00:06:25">2025-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - Prometheus Introduction"/></a><div class="content"><a class="title" href="/2025/01/22/cloud-native-observability-prometheus-introduction/" title="Observability - Prometheus Introduction">Observability - Prometheus Introduction</a><time datetime="2025-01-21T16:06:25.000Z" title="Created 2025-01-22 00:06:25">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java-agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java Zero Code"/></a><div class="content"><a class="title" href="/2025/01/21/cloud-native-observability-opentelemetry-java-zero-code/" title="Observability - OpenTelemetry Java Zero Code">Observability - OpenTelemetry Java Zero Code</a><time datetime="2025-01-20T16:06:25.000Z" title="Created 2025-01-21 00:06:25">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://observability-1253868755.cos.ap-guangzhou.myqcloud.com/otel-java.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Observability - OpenTelemetry Java"/></a><div class="content"><a class="title" href="/2025/01/20/cloud-native-observability-opentelemetry-java/" title="Observability - OpenTelemetry Java">Observability - OpenTelemetry Java</a><time datetime="2025-01-19T16:06:25.000Z" title="Created 2025-01-20 00:06:25">2025-01-20</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2015 - 2025 By zhongmingmao</span></div><div class="footer_custom_text">Life is like a box of chocolates. You can't know what you'll eat until you open it.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>